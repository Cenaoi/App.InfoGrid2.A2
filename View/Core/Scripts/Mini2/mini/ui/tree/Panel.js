Mini2.define("Mini2.ui.tree.Panel",{extend:"Mini2.ui.Component",treeCls:Mini2.baseCSSPrefix+"tree-panel",store:false,rowLines:false,lines:true,rootVisible:true,displayField:"text",checkbox:false,el:null,data:false,valueField:"value",textField:"text",parField:"par_id",typeField:"type",iconField:"icon",autoExpand:true,focusNode:null,event_selected:false,nodeSelected:function(a){this.bind("nodeSelected",a)},nodeExpand:function(a){this.bind("nodeExpand",a)},nodeRename:function(a){this.bind("nodeRename",a)},root:null,isTree:true,initComponent:function(){var a=this;if(a.id&&undefined==a.clientId){a.clientId=a.id}if(a.selected){a.nodeSelected(a.selected);delete a.selected}if(a.expand){a.nodeExpand(a.expand);delete a.expand}if(a.rename){a.nodeRename(a.rename);delete a.rename}a.initStore()},setSize:function(d,b){var c=this,a=c.el;if(undefined!=d){a.css("width",d)}if(undefined!=b){a.css("height",b)}},css:function(c,d){var b=this,a=b.el;return a.css(c,d)},isVisible:function(){var b=this,a=b.el;return a.is(":visible")},getStore:function(){var a=this;if(!a.store){var b=Mini2.create("Mini2.data.Store",{storeId:"MiniStore_"+Mini2.getIdentity()});a.bindStore(b)}return a.store},initStore:function(){var a=this,b;if(a.store){b=Mini2.data.StoreManager.lookup(a.store);delete a.store;a.store=b;a.bindStore(b)}},bindStore:function(b){var a=this;$(b).muBind("update",a,a.store_update).muBind("add",a,a.store_add).muBind("load",a,a.store_load).muBind("clear",a,a.store_clear)},store_update:function(a,d,c,b){},store_clear:function(a){var b=a.data;b.clear()},proLineData:function(l){var e=this,b,k,c=l.length,g=e.parField,j,f;var d=l;var a=e.toGroup(l);var h=e.rootId+"";var d=a[h]||[];if(d&&d.length){for(b=0;b<d.length;b++){k=d[b];f=e.record_2_node.call(e,k);e.add(f);e.proGroupsToTree.call(e,a,k,f)}}},store_add:function(a,c,h){var f=a.data,b,l,m=h,d=m.length,j=f.parField,k,g;var e=m;if(e&&e.length){for(b=0;b<e.length;b++){l=e[b];k=l[j];g=f.record_2_node.call(f,l);if(k+""==f.rootId+""){f.add(g)}else{f.add(g.parent,g)}}}},store_load:function(a,m){var f=a.data,c,k,l=m.data,d=l.length,h=f.parField,g,b,j,e;f.clear();b=f.toGroup.call(f,l);j=f.rootId+"";e=b[j]||[];if(e&&e.length){for(c=0;c<e.length;c++){k=e[c];g=f.record_2_node.call(f,k);f.add(g);f.proGroupsToTree.call(f,b,k,g)}}},proGroupsToTree:function(a,f,e){var d=this,b,h,j=d.valueField,g,c;g=f[j]+"";c=a[g];if(c&&c.length){for(b=0;b<c.length;b++){h=c[b];node=d.record_2_node.call(d,h);d.add(node.parent,node);d.proGroupsToTree(a,h,node)}}},toGroup:function(j){var e=this,b,h,c=j.length,f=e.parField,g,a={},d;for(b=0;b<c;b++){if(j.get){h=j.get(b)}else{h=j[b]}g=h[f]+"";d=a[g];if(undefined==d){d=[];a[g]=d}d.push(h)}return a},record_2_node:function(i){var d=this,o=d.valueField,k=d.textField,h=d.parField,m=d.typeField,n,j,f,l,b,a,g,c,e;n=i[o];j=i[k];f=i[h];a=i.expand;l=i[m];b=i[d.iconField];g=d.id+"_NODE_"+f;c=d.id+"_NODE_"+n;e={id:c,text:j,a_attr:{nodeId:n,parNodeId:f},parent:g,li_attr:{child_loaded:!!i.child_loaded},state:{opened:false}};if(b){e.icon=b}if(a){e.state.opened=true}return e},setNodeLoaded:function(c,g){var b=this,a=b.el,e=$(a).jstree(true);var f=e.get_node(c);f.li_attr.child_loaded=g;var d=$("#"+c);d.attr("child_loaded",g)},getContainer:function(){var b=this,a=b.el;return a.children(".jstree-container-ul:first")},open_node:function(c){var b=this,a=b.el;a.jstree("open_node",c)},clear:function(){var d=this,c=d.el;var b=d.getContainer();var a=$(b).children("li");$(a).each(function(){$(c).jstree(true).delete_node(this)})},cancelRename:false,setNodeText:function(d,e,a){var c=this,b=c.el,f=$(f).jstree(true);c.cancelRename=!!a;b.jstree("rename_node",d,e);c.cancelRename=!c.cancelRename},add_ForRecord:function(d){var b=this,a=b.el,f=$(a).jstree(true),e;var c=b.record_2_node(d);e=f.create_node(c.parent,c)},add:function(d,c){var b=this,a=b.el,f=$(a).jstree(true),e;if(arguments.length==1){c=arguments[0];e=f.create_node(b.focusNode,c)}else{e=f.create_node(d,c)}},"delete":function(c){var b=this,a=b.el,d=$(a).jstree(true);d.delete_node(c)},edit:function(c){var b=this,a=b.el,e=$(a).jstree(true),d;e.edit(c)},setCheckedNode:function(b){var c=this,a=c.el,e=[],d;if(b){d=b.split(",");$(d).each(function(f,g){e.push("#"+g)});a.jstree("check_node",e.join(","))}},getJson:function(){var f=this,c=f.el;var g=f.focusNode.node;var a=g.a_attr;var e=g.li_attr;var h={select:{value:a.nodeId,par_id:a.parNodeId,text:g.text,child_loaded:e.child_loaded,children:g.children}};if(f.renameParam){var i=f.renameParam;var b=false;if(i.li_attr){b=!!(i.li_attr.child_loaded)}h.rename={text:i.text,old:i.old,value:i.node.a_attr.nodeId,par_id:i.node.a_attr.parNodeId,child_loaded:b,children:g.children}}if(f.moveNodeJson){h.move=f.moveNodeJson}var d=Mini2.Json.toJson(h);return d},getMenu:function(){var b=this,a;a={ccp:false,create:{label:"创建目录",action:function(c){var d=window.widget1;if(d){d.subMethod($("form:first"),{subName:b.id,subMethod:"OnCreating"})}},_disabled:function(c){}},edit:{label:"重命名",action:function(c){b.edit(b.focusNode.node)},_disabled:function(c){}},remove:{label:"删除目录",action:function(c){var d=window.widget1;if(d){Mini2.Msg.prompt("询问","确定删除目录?",function(){d.subMethod($("form:first"),{subName:b.id,subMethod:"OnRemoveing"})})}},_disabled:function(c){}}};return a},baseRender:function(){var c=this,b,a;a={core:{check_callback:true,strings:true},plugins:["html_data","themes","ui","crrm","contextmenu"],contextmenu:{items:c.getMenu()}};if(c.allowDragDrop){a.plugins.push("dnd")}c.bind("nodeRename",function(d){if(d.text==d.old){return}c.renameParam=d;var f=window.widget1;if(f){f.subMethod($("form:first"),{subName:c.id,subMethod:"OnRenaming"})}});if(c.checkbox){a.checkbox={keep_selected_style:false};a.plugins.push("checkbox")}if(c.data){if(Mini2.isArray(c.data)){}else{a.core.data=c.data;delete c.data}}if(c.types){a.types=c.types;a.plugins.push("types");delete c.types}if(c.applyTo){c.el=b=$(c.applyTo).jstree(a)}else{c.el=b=$(c.renderTo).jstree(a)}b.css("background-color","#FFFFFF");c.setSize(c.width,c.height);b.bind("select_node.jstree",function(e,d){if(c.autoExpand&&$(b).jstree("is_closed",d.node)){$(b).jstree("toggle_node",d.node)}c.trigger_selected(e,d)});b.bind("open_node.jstree",function(e,d){c.trigger("nodeOpened",d)});b.bind("rename_node.jstree",function(e,d){if(!c.cancelRename){c.trigger("nodeRename",d)}});if(c.allowDragDrop){c.bind_DragDrop()}if(c.data&&Mini2.isArray(c.data)){c.proLineData(c.data)}},bind_DragDrop:function(){var b=this,a=b.el;a.bind("move_node.jstree",function(d,c){try{var f=c.parent.substring(b.clientId.length+"_NODE_".length);b.moveNodeJson={node_id:c.node.a_attr.nodeId,parent_id:f,pos:c.position};b.onNodeMoved()}catch(e){alert("ui.tree.Panel.bind_DragDrop() 提交数据错误")}})},onNodeMoved:function(){var a=this;if(a.event_move){var b=window.widget1;if(b){b.subMethod($("form:first"),{subName:a.id,subMethod:"OnNodeMoved"})}}},trigger_selected:function(c,b){var d=this;d.focusNode=b;if(d.store){var e=b.node;var a=e.a_attr;d.store.setCurrntForId(a.nodeId)}if(d.event_selected){var f=window.widget1;if(f){f.subMethod($("form:first"),{subName:d.id,subMethod:"OnSelected"})}}d.trigger("nodeSelected",b)},render:function(){var a=this;a.baseRender()}});