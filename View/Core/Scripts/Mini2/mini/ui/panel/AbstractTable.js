Mini2.define("Mini2.ui.panel.AbstractTable",{StrJoin:function(a){var c="";for(var b=0;b<a.length;b++){c+=a[b]}return c},renderTo:Mini2.getBody(),getStore:function(){var a=this,b;if(!a.store){b=Mini2.create("Mini2.data.Store",{storeId:"MiniStore_"+Mini2.getIdentity()});a.bindStore(b)}return a.store},bindStore:function(b){var a=this;a.store=b;$(b).muBind("update",a,a.store_update).muBind("add",a,a.store_add).muBind("datachanged",a,a.store_dataChanged).muBind("refresh",a,a.store_refresh).muBind("load",a,a.store_load).muBind("bulkremove",a,a.store_bulkRemove).muBind("invalid",a,a.store_invalid).muBind("clear",a,a.store_clear).muBind("currentchanged",a,a.store_currentChanged)},store_invalid:function(b,f,c){var e=b.data;var g=e.getRowForRecord(f);var h=$(g).index();for(var d=0;d<c.length;d++){var a=e.getColumnForDataIndex(c[d]);e.afterCellUpdate(a,g,f,h,c)}},getColumnForDataIndex:function(c){var f=this,a,b=f.m_Cols,d=b.length,e=[];while(d--){a=b[d];if(a.dataIndex==c){e.push(a)}}return e},getRowForRecord:function(b){var a=this,e=[],g=a.tbodyEl,d,c,f=g.children("tr");$(f).each(function(){c=this;d=$(c).data("record");if(d===b){e.push(c)}});return e},afterCellUpdate:function(d,n,l,o,k){var j=this,c,e=d.dataIndex,m=l.index,f=d.renderer,a,i,h,b;a=$(n).children(":eq("+d.index+")");h=l.get(e);if(f&&f.call){try{value=f.call(d,h,c,c,l,o,e,j.store,j)}catch(g){}}else{value=h}b=$(a).children(".mi-grid-cell-inner");b.html(value);i=l.isModified(e);$(a).toggleClass("mi-grid-dirty-cell",i);if(l&&l.errors&&d.dataIndex&&d.dataIndex!=""){if(l.errors){d.markInvalid(l,a,d.dataIndex)}else{d.clearInvalid(l,a,d.dataIndex)}}},store_currentChanged:function(b,d,g){var f=b.data,c="mi-grid-row-focused",h,i,j=$(f.tbodyEl).children(),e=f.lastRowFocused,a=null;if(d>-1){$(j).each(function(){h=this;i=$(h).data("record");if(i===g){a=h;return false}});$(a).addClass(c)}$(e).removeClass(c);f.lastRowFocused=a},store_clear:function(a){var b=a.data;b.itemRemoteAll();if(b.rowCheckColumn){b.rowCheckColumn.updateHeaderState()}},store_bulkRemove:function(b,a,d,e){var f=b.data,c,g,h,i=f.tbodyEl.children("tr");$(i).each(function(){h=this;g=$(h).data("record");c=Mini2.Array.contains(a,g);if(c){$(h).remove();Mini2.Array.remove(f.checkedRecords,g);return false}});f.itemsReset()},store_update_forRow:function(l,m,k,h){var f=this,c,e,a,b,g,o=f.rowStyleType,n=f.rowStyleField,d=false;for(c=0;c<h.length;c++){g=h[c];if(o&&g==n){d=true;continue}b=f.getColumnForDataIndex(g);e=b.length;while(e--){a=b[e];f.afterCellUpdate(a,l,k,m,h)}}return d},store_update_setInvalid:function(rowEl,record){var me=this,i,j,rowStyleType=me.rowStyleType,rowStyleField=me.rowStyleField,jsonStr=record.get(rowStyleField),json,cellEl,colStyle,colMsgs,colName,col,cols;if(!jsonStr){return}if(""==jsonStr){return}try{json=eval("("+jsonStr+")")}catch(ex){log.debug("json 解析数据错误"+jsonStr);return}var invalidCols={};record.clearInvalidAll();me.clearRowInvalid(rowEl,record);for(i=0;i<json.cols.length;i++){colStyle=json.cols[i];colMsgs=colStyle.msgs;colName=colStyle.name;cols=me.getColumnForDataIndex(colName);j=cols.length;while(j--){col=cols[j];cellEl=$(rowEl).children(":eq("+col.index+")");if(colMsgs&&colMsgs.length){col.markInvalid.call(col,record,cellEl,col.dataIndex,colMsgs);invalidCols[colName]=true}else{col.clearInvalid.call(col,record,cellEl,col.dataIndex)}}}},clearRowInvalid:function(f,e){var d=this,c,a,b=d.m_Cols;for(c=0;c<b.length;c++){a=b[c];cellEl=$(f).children(":eq("+a.index+")");a.clearInvalid.call(a,e,cellEl,a.dataIndex)}},store_update:function(d,j,i,h){var f=d.data,c="mi-grid-dirty-cell",b,l,k,a,g,e,m=f.getRowForRecord(j);$(m).each(function(){k=this;l=$(k).index();if(h){e=f.store_update_forRow(k,l,j,h);if(e){try{f.store_update_setInvalid(k,j)}catch(n){alert("处理单元格提示信息失败。"+n.message)}}}else{a=$(m).children("."+c);$(a).removeClass(c)}});if(f.rowCheckColumn){f.rowCheckColumn.updateHeaderState()}},store_refresh:function(a,e){var c=a.data,b,d;c.itemRemoteAll();d=c.store.data;for(b=0;b<d.length;b++){c.itemAdd(d.get(b))}c.itemsReset();if(c.rowCheckColumn){c.rowCheckColumn.updateHeaderState()}},store_load:function(a,h){var d=a.data,b,e,f=h.data,c,g=d.rowCheckColumn;d.itemRemoteAll();c=f.length;for(b=0;b<c;b++){e=f.get(b);d.itemInsert(b,e)}if(g){g.updateHeaderState()}},store_dataChanged:function(b,c){var d=b.data,a=d.editor;if(a){a.hide()}},store_add:function(a,c,e){var d=a.data,b,f=d.rowCheckColumn;for(b=0;b<e.length;b++){d.itemInsert(c+b,e[b])}if(f){f.updateHeaderState()}}});