Mini2.define("Mini2.ui.panel.Table",{extend:"Mini2.ui.panel.AbstractTable",defaultEditorMode:"auto",isResetCellWidth:true,readOnly:false,rowLines:true,columnLines:true,isInit:false,columns:[],m_Cols:[],m_ColGroups:null,dock:"top",m_Table:null,tbodyEl:null,store:false,bodyEl:null,el:null,el:null,cellValues:{},autoRowCheck:false,m_NewRowIndex:0,lastRowFocused:null,curRowFocused:null,m_FocusCell:null,m_LastCell:null,m_LastEditor:null,width:"100%",height:"600px",headerContainer:null,checkedRecords:[],checkedMode:"MULTI",rowCheckColumn:null,pager:{},editor:null,sortable:true,pagerVisible:true,cellTpl:['<td role="gridcell" class="mi-grid-cell mi-grid-td ">','<div class="mi-grid-cell-inner">',"</div>","</td>"],rowStyleType:"json",rowStyleField:"ROW_STYLE_JSON",rowAltEnabled:true,updateLayout:function(c){var b=this,d,a;if(c.muid){d=c.getWidth();a=c.getHeight()}},createColGroup:function(){var e=this,d=0,a,c=e.m_Cols,b="";for(;d<c.length;d++){a=c[d];b+=e.StrJoin(["<colgroup>",'<col style="width:',a.width,'px;" />',"</colgroup>"])}return b},renderCell:function(n,d,l,m,e,k,o){var j=this,p=j.selModel,b=j.cellValues,q,a,h,g,c=d.renderer;g=l.data[d.dataIndex];a=d.renderCell();$(n).append(a);h=a.children(":first");if(j.isResetCellWidth){h.css("width",(d.width-2)+"px")}if(c&&c.call){q=c.call(d,g,b,b,l,m,e,j.store,j)}else{q=g}b.value=(q==null||q==="")?"&#160;":q;h.html(b.value);$(a).addClass(d.tdCls);if(Mini2.isFunction(d.innerCls)){$(h).addClass(d.innerCls.call(d))}else{$(h).addClass(d.innerCls)}if(l.isModified(d.dataIndex)){$(a).addClass("mi-grid-dirty-cell")}cellInnerEl=$(a).children(".mi-grid-cell-inner");cellInnerEl.html(q);if(d.bindEvent){d.bindEvent.call(d,j,a,m,e,null,l,o)}try{if(l&&d.dataIndex&&d.dataIndex!=""){if(l.errors){d.markInvalid.call(d,l,a,d.dataIndex)}else{d.clearInvalid.call(d,l,a,d.dataIndex)}}}catch(f){log.error("创建错误标记失败. column.markInvalid（....) ")}return a},renderRow:function(j,h,l,g){var f=this,e=0,k,b,a,c=f.m_Cols;k=$('<tr role="row" class="mi-grid-row  mi-grid-data-row" tabindex="-1" ></tr>');$(j).append(k);k.data("record",h);for(;e<c.length;e++){b=c[e];try{a=f.renderCell(k,b,h,l,b.dataIndex,g,k)}catch(d){throw new Error("初始化单元格错误.miType="+b.miType)}}try{f.store_update_setInvalid(k,h)}catch(d){log.debug("设置异常提示信息失败.")}return k},renderRows:function(b,c,a){},render_GridBody:function(){var b=this,a,d,c;a=b.createColGroup();c=Mini2.$joinStr(['<div class="mi-panel-body ',"mi-grid-body ","mi-panel-body-default ","mi-layout-fit ","mi-panel-body-default ",'mi-noborder-rbl" ','style="width:',b.width,'; height: 284px; left: 0px; top: 0px; ">','<div class="mi-grid-view mi-fit-item mi-grid-view-default" ','style="overflow: auto; margin: 0px; width: ',b.width,'; height: 283px; " tabindex="-1" >',"</div>","</div>"]);d=Mini2.$joinStr(['<table class="mi-grid-table" border="0" cellspacing="0" cellpadding="0" >',a,"<tbody>","</tbldy>","</table>"]);b.bodyEl=c;b.gridViewEl=c.children(".mi-grid-view:first");if(b.rowLines){b.el.addClass("mi-grid-with-row-lines")}if(b.columnLines){b.el.addClass("mi-grid-with-col-lines")}$(b.el).append(b.bodyEl);$(b.gridViewEl).append(d);b.m_ColGroups=d.children("colgroup");b.m_Table=d;b.tbodyEl=d.children("tbody:first")},setSize:function(m,d){var f=this,b=f.el,a=f.bodyEl,c=f.gridViewEl,g=0,j,l=0,k=f.summary,e=f.headerContainer.height;if(undefined!=m){f.width=m;b.width(m);a.width(m);c.width(m);f.headerContainer.setWidth(m);if(k){k.setWidth(m)}}if(undefined!=d){d=parseInt(d);g=f.getPagetHeight();l=f.getSummaryHeight();j=d-e-2-g-l;f.height=d;b.css("height",d);a.css("height",j);c.css("height",j)}return f},render_Panel:function(){var b=this,a;b.el=a=Mini2.$joinStr(['<div class="mi-panel mi-panel-default-framed mi-grid" ','style="width: 100%; height: 350px; right: auto; left: 0px; top: 0px;" >',"</div>"]);a.css({width:b.width,height:b.height});if(b.applyTo){$(b.applyTo).replaceWith(a)}else{$(b.renderTo).append(a)}},pager_click:function(b,c){var a=this;c.loadPage(b)},render_Pager:function(){var b=this,a,c=b.pager,d=!!b.pagerVisible;if((c&&c.visible==false)||b.pagerVisible==false){return}b.pagerVisible=d;a=Mini2.apply(b.pager,{renderTo:b.el,store:b.getStore(),visible:d,click:b.pager_click});c=Mini2.create("Mini2.ui.Pagination",a);c.render();b.pager=c},render_Summary:function(){var a=this,b;if(a.summaryVisible){b=Mini2.create("Mini2.ui.grid.feature.Summary",{renderTo:a.el,grid:a,store:a.getStore(),columns:a.m_Cols});b.render();a.summary=b}},getSummaryHeight:function(){var a=this,b=a.summary;if(b&&b.muid){return b.height}return 0},getPagetHeight:function(){var a=this,b=a.pager;if(!a.pagerVisible){return 0}if(b&&b.muid){return 24}return 0},render:function(e){var d=this,a=null,b,h=d.width,c=d.height;d.onInit();d.render_Panel();a=d.el;d.headerContainer=b=Mini2.create("Mini2.ui.grid.header.Container",{renderTo:a,columns:d.m_Cols,width:h,grid:d});b.render();b.columnWidthResize(function(){d.resetBodyWidth()});d.render_GridBody();d.render_Summary();d.render_Pager();d.setSize(h,c);d.syncScrollLeft();d.resetBodyWidth();store=d.getStore();store.load();var f=$(a).parent();var g=$(f).hasClass("mi-box-target");if(!g){$(window).resize(function(){var k=$(f).width();var j=$(f).height();d.setSize(k,j)})}a.data("me",d)},setTop:function(c){var b=this,a=b.el;a.css("top",c);return b},setLeft:function(b){var c=this,a=c.el;a.css("left",b);return c},getTop:function(){var b=this,a=b.el;return a.css("top")},getLeft:function(){var b=this,a=b.el;return a.css("left")},setWidth:function(b){var a=this;a.setSize(b,undefined);return a},setHeight:function(a){var b=this;b.setSize(undefined,a)},getWidth:function(){var b=this,a=b.el;return a.width()},getHeight:function(){var b=this,a=b.el;return a.height()},getSize:function(){var c=this,a=c.el,d=a.width(),b=a.height();return{width:d,height:b}},isVisible:function(){var b=this,a=b.el;return a.is(":visible")},syncScrollLeft:function(){var b=this,a=b.gridViewEl;$(a).mousedown(function(c){Mini2.ui.FocusMgr.setControl(b);Mini2.EventManager.clear()});a.scroll(function(c){var d=$(this).scrollLeft();b.headerContainer.scrollLeft(d);if(b.summary){b.summary.scrollLeft(d)}})},resizeCellWidth:function(){var f=this,d,e,b=f.m_Cols,a,k=f.tbodyEl,h=k.children("tr.mi-grid-row"),g,l,c;for(d=0;d<h.size();d++){g=h[d];tdEls=$(g).children("td.mi-grid-cell");for(e=0;e<b.length;e++){a=b[e];l=tdEls[e];c=$(l).children(".mi-grid-cell-inner:first");$(c).css("width",(a.width-2)+"px")}}if(f.summary){f.summary.resizeCellWidth.call(f.summary)}},resetBodyWidth:function(){var f=this,e,d=f.m_Cols,a,b,h=0,g,c;g=$(f.bodyEl).find(".mi-grid-table:first");c=$(g).children("colgroup");for(e=0;e<d.length;e++){b=$(c[e]).children("col");a=d[e];h+=a.width;b.css("width",a.width)}f.m_Table.css("width",h);if(f.editor){f.editor.hide()}if(f.isResetCellWidth){f.resizeCellWidth()}},itemRemoteAll:function(){var a=this,b=$(a.tbodyEl).children();$(b).remove();a.m_NewRowIndex=0;a.checkedRecords=[]},itemInsert:function(d,b){var e=this,m=e.tbodyEl,c,a,f,g,h,j=[],l,k;l=$(m).children();a=l.size();if(d>a){d=a}if(Mini2.isArray(b)){g=b}else{g=[b]}for(c=0;c<g.length;c++){f=g[c];h=e.renderRow(e.tbodyEl,f,e.m_NewRowIndex);j.push(h)}if(a){if(d==0){k=$(l).eq(0);$(k).before(j)}else{k=$(l).eq(d-1);$(k).after(j)}}e.itemsReset();for(c=0;c<j.length;c++){h=j[c];f=g[c];e.bindEvent_ForRow(f,h);e.bindEvent_ForCell(f,h)}},getCellPosition:function(a){var c=this,d,e,b,k,h,j,f,g;j=a.index();h=a.parent();d=0;e=0;f=$(a).prevUntil();f.each(function(){d+=$(this).outerWidth()});g=h.prevUntil();g.each(function(){e+=$(this).outerHeight()});e+=c.headerContainer.height;b=d-c.gridViewEl.scrollLeft();k=e-c.gridViewEl.scrollTop();return{left:b,top:k}},getCellSize:function(a){var c,b;c=a.outerWidth()+1;b=a.outerHeight();return{width:c,height:b}},setHeaderCheck:function(a){var b=this;b.headerContainer.setHeaderCheck(a)},setRecordCheck:function(j,f){var g=this,c=g.rowCheckColumn,l,m,e,a,h,d="mi-grid",b=d+"-checkcolumn-checked",k=d+"-row",n=k+"-selected";m=$(g.tbodyEl).children();$(m).each(function(){l=$(this);h=l.data("record");if(h.getId()==j){g.setRowCheck(l,f);return false}})},setRowCheck_ForSingle:function(j,h,e,l,c){var g=this,a,k,d,b,f;if("SINGLE"==g.checkedMode){a=$(j).parent();k=$(a).children("."+l);$(k).each(function(){j=$(this);d=j.data("record");if(d===h){return}b=j.children(":eq("+e.index+")");f=b.find("img:first");j.removeClass(l);$(f).removeClass(c)});g.checkedRecords.length=0}},setRowCheck:function(j,e){var f=this,g=$(j).data("record"),c=f.rowCheckColumn,a,d,h="mi-grid-row",k=h+"-selected",b="mi-grid-checkcolumn-checked";if(c!=null){a=$(j).children(":eq("+c.index+")");d=a.find("img:first");f.setRowCheck_ForSingle(j,g,c,k,b);$(j).toggleClass(k,e);$(d).toggleClass(b,e);if(e){Mini2.Array.include(f.checkedRecords,g)}else{Mini2.Array.remove(f.checkedRecords,g)}c.onSelectChange()}},setRowCheckAll:function(e){var f=this,j,k,d,a,g,c=f.rowCheckColumn,h="mi-grid",l=h+"-row-selected",b=h+"-checkcolumn-checked";k=$(f.tbodyEl).children();f.checkedRecords=[];$(k).each(function(){j=$(this);a=j.children("td:eq("+c.index+")");g=j.data("record");d=a.find("img:first");j.toggleClass(l,e);d.toggleClass(b,e);if(e){f.checkedRecords.push(g)}})},cell_click_rowCheckColumn:function(a,b,g,f){var e=this,c,d;Mini2.ui.FocusMgr.setControl(b,e,null);c=a.find("img:first");d=c.hasClass("mi-grid-checkcolumn-checked");e.setRowCheck(g,!d)},cell_click_checkColumn:function(a,b,d,h){var g=this,e,f,c="mi-grid-checkcolumn-checked";if(!g.readOnly){Mini2.ui.FocusMgr.setControl(b,g,null);e=a.find("img:first");e.toggleClass(c);f=$(e).hasClass(c);h.set(d.dataIndex,f)}},cell_click_propertyColumn:function(a,b,c,o){var l=this;var p=o.data.Type;var m=o.data.Name;var e="";switch(p){case"int":e="numberfield";break;case"date":e="datefield";break;case"bool":e="combobox";break;case"enum":e="combobox";break;default:e="textfield";break}c.xtype=e;var d;if(p=="enum"){d=m+"_"+e}else{d=e}var n=c.propEditor[d];if(!n){n={xtype:e};c.propEditor[d]=n}if(!n.isInit){switch(p){case"bool":Mini2.apply(n,{fields:["value","text"],store:[{value:"true",text:"true"},{value:"false",text:"false"}]});break;case"enum":var g=o.data.Extend;var h=[];if(Mini2.isArray(g)){for(var k=0;k<g.length;k++){var j=g[k];if(Mini2.isString(j)){h.push({value:j,text:j})}}}else{for(var f in g){var j=g[f];h.push({value:f,text:j})}}Mini2.apply(n,{fields:["value","text"],store:h});break}}},cell_Click:function(b){var g=this,a,k,m,j,c,h;if(!b){return}a=$(b);if(0==a.length){return}k=a.parent();m=a.index();j=$(k).data("record");c=g.m_Cols[m];h=c.miType;g.m_LastCell=g.m_FocusCell;if(g.m_LastCell!=null){var f=$(g.m_LastCell).children(".mi-grid-cell-inner");f.show()}g.m_FocusCell=a;if("rowcheckcolumn"==h){g.cell_click_rowCheckColumn(a,b,k,j);return}else{if("actioncolumn"==h){return}}if(g.autoRowCheck&&"SINGLE"==g.checkedMode){g.setRowCheck(k,true)}if(g.readOnly){return}if(j.isLocked&&j.isLocked()){return}if("checkcolumn"==h){g.cell_click_checkColumn(a,b,c,j);return}if(Mini2.isFunction(c.click)){var e=j.get(c.dataIndex);var l=$(k).index();c.click.call(c,e,j,c,b,k,l,m,g.store,g)}if(!c.editor||"none"==c.editorMode){Mini2.ui.FocusMgr.setControl(b,g,null);return}var n=c.editor.xtype;if(c.isPropertyColumn){g.cell_click_propertyColumn(a,b,c,j)}if(Mini2.ui.grid.CellEditor){var d=g.getEditor(c,j);g.showEditor(a,b,k,c,j,d)}else{In("Mini2.ui.grid.CellEditor",function(){var o=g.getEditor(c,j);g.showEditor(a,b,k,c,j,o)})}},showEditor:function(a,b,j,c,h,e){var f=this,d=a.children(".mi-grid-cell-inner"),k,g;if(!e){throw new Error("编辑控件不存在")}if(!e.isSaveed){e.isSaveed=true}d.hide();k=f.getCellSize(a);g=f.getCellPosition(a);g.top-=2;g.left-=2;e.startEditByPosition(g).setSize(k).focus().setRowCell(j,b).startEdit(h,c,{});f.editor=e},getEditor:function(a,k){var f=this,l,b,e,c;if(a.isPropertyColumn){var h=a.propEditor,g=k.data.Name,j=k.data.Type,d=a.xtype;if(j=="enum"){d=g+"_"+a.xtype}c=h[d];if(!c.isInit){l=a.xtype||"textcolumn";b=Mini2.applyIf({grid:f,renderTo:f.el,isInit:true,visible:false,xtype:l},c);e=Mini2.create("Mini2.ui.grid.CellEditor",b);e.config=c;e.render();h[d]=e}return h[d]}else{c=a.editor;if(c.isInit==false){l=c.xtype||"textcolumn";b=Mini2.applyIf({grid:f,renderTo:f.el,isInit:true,visible:false},c);e=Mini2.create("Mini2.ui.grid.CellEditor",b);e.config=c;e.render();a.editor=e}return a.editor}},clearSelectAndFocus:function(){var a=this,b="mi-grid-row",d=b+"-selected",c=a.tbodyEl.children("."+d);$(c).removeClass(d)},autoFocusScroll:function(f){var h=this,a=h.gridViewEl;var d=$(f);if(d.size()==0){return}var l=0,m=0;var k=d.parent();var q=d.index();var p=h.getCellSize(d);var j=h.getCellPosition(d);var c=a.width();var b=a.height();var g=j.left+p.width;var e=j.top+p.height;var n=a.scrollLeft();var o=a.scrollTop();if(g>c-15){l=g-c+15}else{if(j.left<0){l=j.left-2}}if(e>(b+16-2)){m=(e-b-16+2)}else{if(j.top<h.headerContainer.height){m=-(h.headerContainer.height-j.top)}}a.scrollLeft(n+l);a.scrollTop(o+m);Mini2.EventManager.setMouseDown(f);Mini2.ui.FocusManager.setControl(f)},extendCellEvent:function(a){var b=this;$(a).focusin(function(){$(this).addClass("mi-grid-cell-selected")}).focusout(function(){$(this).removeClass("mi-grid-cell-selected")});$(a).muBind("mousedown",function(c){b.autoFocusScroll(this)}).muBind("mouseup",function(c){var f,d;f=$(this).parent();d=$(f).data("record");b.store.setCurrent(d);b.cell_Click(this)});$(a).muBind("keydown",function(c,d){var g=event.keyCode;if(g==9){var f=d.data;var h=$(this).next();if(h.size()>=1){f.autoFocusScroll(h);f.cell_Click(h);f.m_FocusCell=h;Mini2.EventManager.stopEvent()}}});return b},bindEvent_ForCell:function(b,c){var a=this,d=$(c).children("td");$(d).each(function(){a.extendCellEvent(this)})},bindEvent_ForRow:function(c,e){var a=this,d="mi-grid-row",b=d+"-over";$(e).mouseenter(function(f){$(this).addClass(b)}).mouseleave(function(f){$(this).removeClass(b)})},getColumnByType:function(g){var f=this,a,d=0,b=[],c=f.m_Cols,e=c.length;for(;d<e;d++){a=c[d];if(a.miType.toLowerCase()==g){b.push(a)}}return b},itemsReset:function(){var d=this,h=null,j,g,f=0,b=d.itemReseted,e=d.rowAltEnabled,a="mi-grid-row-alt",c="mi-grid-locked-row";j=$(d.tbodyEl).children(".mi-grid-row");g=d.getColumnByType("rownumberer");$(j).each(function(){var o=$(this),n,m,l=g.length;if(e){o.toggleClass(a,!(f%2))}if(l){n=o.data("record");m=n.isLocked();o.toggleClass(c,m);while(l--){d.afterCellUpdate(g[l],this,n,f)}}if(b){try{b.call(d,{rowEl:o,rowIndex:f,record:n})}catch(k){log.debug("调用刷新记录错误.")}}f++});d.m_NewRowIndex=f},onInit:function(){var b=this,a=0;if(b.isInit){return}b.isInit=true;if(typeof b.store=="string"){var c=Mini2.data.StoreManager.lookup(b.store);b.bindStore(c)}delete b.m_Cols;b.m_Cols=[];$(b.columns).each(function(){b.getColumnForConfig(a,this);a++});b.cellTpl=b.StrJoin(b.cellTpl)},getColumnNameForMiType:function(b){var a="Mini2.ui.grid.column.";switch(b){case"booleancolumn":case"boolcolumn":a+="Boolean";break;case"checkcolumn":a+="CheckColumn";break;case"rownumberer":a+="RowNumberer";break;case"rowcheckcolumn":a+="RowCheckColumn";break;case"numbercolumn":a+="Number";break;case"datecolumn":a+="Date";break;case"actioncolumn":a+="Action";break;case"propertycolumn":a+="PropertyColumn";break;default:a+="Colunm";break}return a},getColumnForConfig:function(f,b){var g=this,h,a,e=g.m_Cols,c,d;h=b.miType=b.miType.toLowerCase();d=g.getColumnNameForMiType(h);a=Mini2.create(d,b);switch(h){case"rowcheckcolumn":g.rowCheckColumn=a;break}a.grid=g;a.store=g.getStore();c=a.editor;if(c){c.isInit=false}if(c.store){var j,k;j=Mini2.clone(a.editor.store);k=Mini2.create("Mini2.data.Store",{storeId:"MiniStore_"+Mini2.getIdentity(),idField:"value",fields:["value","text"],data:j});a.displayStore=k}if(!a.renderer){}a.index=f;e.push(a)},setReadOnly:function(b){var a=this;a.readOnly=b},getJson:function(){var g=this,c=g.rowCheckColumn,f,b={records:[]};if(!c){return b}var j,h,a,d,e,k=$(g.tbodyEl).children();$(k).each(function(){j=$(this);h=j.data("record");a=j.children("td:eq("+c.index+")");d=a.find("img:first");e=$(d).hasClass("mi-grid-checkcolumn-checked");if(e){var l={action:"none",id:h.getId(),clientId:h.muid,index:j.index()};if(h.dirty){l.action="modified"}if(!l.id){l.action="added";l.values={};for(i in h.data){l.values[i]=h.data[i]}}b.records.push(l)}});f=Mini2.Json.toJson(b);return f}});