Mini2.define("Mini2.ui.form.field.ComboBoxBase",{extend:"Mini2.ui.form.field.Trigger",displayField:"text",itemDisplayField:"textEx",valueField:"value",curRecord:null,initComponent:function(){var b=this;$(b).muBind("focusout",function(){b.fieldEl.removeClass("mi-form-focus");b.el.removeClass("mi-form-trigger-wrap-focus");b.hideDropDownPanel()});b.initStore();b.initLabelable();var a=Mini2.$joinStr(['<input type="hidden" name="',b.clientId+'_curResult" />']);b.curRecordEl=a},getItemDisplayText:function(b){var a=this;var c=b.get(a.itemDisplayField);if(undefined==c||""==c){c=b.get(a.displayField)}return c},getBoundPanel:function(){var f=this,b,a,g,e,m,l=f.store,k=l.data,j,c=l.getCount();a=Mini2.$joinStr(['<div class="mi-boundlist-list-ct mi-unselectable" style="overflow: auto; height: 100px; font-size:12px; ">','<ul class="mi-list-plain"></ul>',"</div>"]);var h=a.children(".mi-list-plain");var d=$('<li role="option" unselectable="on" class="mi-boundlist-item"></li>');f.boundListEl=a;f.listPlainEl=h;k=l.data;for(b=0;b<k.getCount();b++){j=k.get(b);g=d.clone();m=f.getItemDisplayText(j);g.html(m);g.data("record",j);$(h).append(g)}e=h.children();f.bindItems(e);c=(c>8?8:c);a.css("height",24*c);return a},refresh:function(){var g=this,b,a,h,e,m,l=g.store,k=l.data,j,c=l.getCount();var f=g.listPlainEl;var d=$('<li role="option" unselectable="on" class="mi-boundlist-item"></li>');f.html("");k=l.data;for(b=0;b<k.getCount();b++){j=k.get(b);h=d.clone();m=g.getItemDisplayText(j);h.html(m);h.data("record",j);$(f).append(h)}e=f.children();g.bindItems(e);c=(c>8?8:c);g.boundListEl.css("height",24*c);g.proDropDownPanel_SizeALocal()},bindItems:function(a){var b=this;$(a).mouseenter(function(){$(this).addClass("mi-boundlist-item-over")}).mouseleave(function(){$(this).removeClass("mi-boundlist-item-over")}).mouseup(function(c){var g=$(this).data("record");var i=g.get(b.valueField);var h=g.get(b.displayField);if("none"==b.mode){b.hideEl.val(i);b.inputEl.val(h)}else{b.inputEl.val(i)}b.curRecord=g;var d=b.store.getJsonForRecord(g);var f=Mini2.Json.toJson(d);b.curRecordEl.val(f);b.value=i;b.text=h;b.hideDropDownPanel();b.clearInvalid();b.focus();if(b.changed){b.changed.call(b)}})},setValue:function(k){var g=this,h,l=g.valueField,a=g.displayField,c=g.hideEl,i=g.store,j,d=g.inputEl;g.value=k;if("none"==g.mode&&i){try{h=i.filterFirstBy(l,k);if(h){g.curRecord=h;var e=g.store.getJsonForRecord(h);var f=Mini2.Json.toJson(e);g.curRecordEl.val(f);j=h.get(a);d.val(j)}else{d.val(k)}}catch(b){alert("错误啦。"+b.Message)}}else{d.val(k)}if(c){c.val(k)}},getValue:function(){var b=this,a=b.hideEl,c;if(b.readOnly&&a){c=a.val()}else{c=b.inputEl.val()}b.value=c;return b.value},proDropDownPanel_SizeALocal:function(){var f=this,b=f.el,c=f.fieldEl,h,g,k,e,l=$(window).height(),a,i,d,j;h=f.dropDownPanel;g=c.offset();d=c.width();k=f.dropDownWidth||d;if(k<d){k=d}e=f.store.getCount();if(e>8){e=8}j=24*e;a=(g.top+b.height()-2)+j;if(a>l){i=g.top-j}else{i=g.top+b.height()-2}h.css({"border-width":1,width:k,height:j,left:g.left,top:i}).show();return f},showDropDownPanel:function(){var g=this,b=g.el,d=g.fieldEl,i,h,l,f,m=$(window).height(),a,j,e,k;g.init_DropDwonPanel();i=g.dropDownPanel;if(g.dropDown){try{g.dropDown.call(g,g)}catch(c){throw new Error("执行 Trigger.dropDown(...) 事件发生错误")}}g.proDropDownPanel_SizeALocal();return g},render:function(){var b=this,a="td.mi-form-item-body:first";b.baseRender();b.appendCell(b.el,b.curRecordEl,a);b.el.data("me",b)}});