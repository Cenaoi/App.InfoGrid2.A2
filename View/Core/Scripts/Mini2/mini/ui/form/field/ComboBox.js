Mini2.define("Mini2.ui.form.field.ComboBox",{extend:"Mini2.ui.form.field.Trigger",displayField:"text",itemDisplayField:"textEx",valueField:"value",initComponent:function(){var a=this;$(a).muBind("focusout",function(){a.fieldEl.removeClass("mi-form-focus");a.el.removeClass("mi-form-trigger-wrap-focus");a.hideDropDownPanel()});a.initStore();a.initLabelable()},getItemDisplayText:function(b){var a=this;var c=b.get(a.itemDisplayField);if(null==c||undefined==c||""==c){c=b.get(a.displayField)}return c},add:function(a){},getBoundPanel:function(){var f=this,b,a,g,e,m,l=f.store,k=l.data,j,c=l.getCount();a=Mini2.$joinStr(['<div class="mi-boundlist-list-ct mi-unselectable" style="overflow: auto; height: 100px; font-size:12px; ">','<ul class="mi-list-plain"></ul>',"</div>"]);var h=a.children(".mi-list-plain");var d=$('<li role="option" unselectable="on" class="mi-boundlist-item"></li>');f.boundListEl=a;f.listPlainEl=h;k=l.data;for(b=0;b<k.getCount();b++){j=k.get(b);g=d.clone();m=f.getItemDisplayText(j);g.html(m);g.data("record",j);$(h).append(g)}e=h.children();f.bindItems(e);c=(c>8?8:c);a.css("height",24*c);return a},bindItems:function(a){var b=this;$(a).mouseenter(function(){$(this).addClass("mi-boundlist-item-over")}).mouseleave(function(){$(this).removeClass("mi-boundlist-item-over")}).mouseup(function(c){var d=$(this).data("record");var g=d.get(b.valueField);var f=d.get(b.displayField);if("none"==b.mode){b.hideEl.val(g);b.inputEl.val(f)}else{b.inputEl.val(g)}b.curRecord=d;b.value=g;b.text=f;b.hideDropDownPanel();b.clearInvalid();b.focus();if(b.changed){b.changed.call(b)}})},setValue:function(i){var e=this,f,c=e.hideEl,g=e.store,h,d=e.inputEl,j=e.valueField,a=e.displayField;e.value=i;if("none"==e.mode&&g){try{f=g.filterFirstBy(j,i);if(f){e.curRecord=f;h=f.get(a);e.text=h;d.val(h)}else{e.text="";d.val("")}}catch(b){alert("ComboBox.setValue(...) 赋值错误啦。"+b.Message)}}else{f=g.filterFirstBy(j,i);e.curRecord=f;if(f){e.text=f.get(e.displayField)}else{e.text=""}d.val(i)}if(c){c.val(i)}},getValue:function(){var b=this,c,e=b.valueField,a=b.hideEl,d;if(b.readOnly&&a){d=a.val()}else{d=b.inputEl.val()}c=b.store.filterFirstBy(e,d);b.curRecord=c;if(c){b.text=c.get(b.displayField)}else{b.text=""}b.value=d;return b.value},showDropDownPanel:function(){var g=this,b=g.el,d=g.fieldEl,i,h,k,f,l=$(window).height(),a,j,e;g.init_DropDwonPanel();i=g.dropDownPanel;if(g.dropDown){try{g.dropDown.call(g,g)}catch(c){throw new Error("执行 Trigger.dropDown(...) 事件发生错误."+c.Message)}}g.proDropDownPanel_SizeALocal();return g},refresh:function(){var g=this,b,a,h,e,m,l=g.store,k=l.data,j,c=l.getCount();var f=g.listPlainEl;var d=$('<li role="option" unselectable="on" class="mi-boundlist-item"></li>');f.html("");k=l.data;for(b=0;b<k.getCount();b++){j=k.get(b);h=d.clone();m=g.getItemDisplayText(j);if(m==null||m==undefined||m==""){m="&nbsp;"}h.html(m);h.data("record",j);$(f).append(h)}e=f.children();g.bindItems(e);c=(c>8?8:c);g.boundListEl.css("height",24*c);g.proDropDownPanel_SizeALocal()},proDropDownPanel_SizeALocal:function(){var f=this,b=f.el,c=f.fieldEl,h,g,k,e,l=$(window).height(),a,i,d,j;h=f.dropDownPanel;g=c.offset();d=c.width();k=f.dropDownWidth||d;if(k<d){k=d}e=f.store.getCount();if(e>8){e=8}j=24*e;a=(g.top+b.height()-2)+j;if(a>l){i=g.top-j}else{i=g.top+b.height()-2}h.css({"border-width":1,width:k,height:j,left:g.left,top:i}).show();return f}});