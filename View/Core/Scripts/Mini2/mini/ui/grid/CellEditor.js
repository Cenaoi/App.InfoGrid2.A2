Mini2.define("Mini2.ui.grid.CellEditor",{extend:"Mini2.ui.Editor",grid:null,el:null,inputObj:null,renderTo:Mini2.getBody(),rowEl:null,cellEl:null,record:null,columnHeader:null,xtype:"TextColumn",readOnly:false,initComponent:function(){var a=this},focus:function(){var a=this;Mini2.ui.FocusMgr.setControl(a,a.cellEl,a.el);return a},getBox:function(){var a=Mini2.$joinStr(['<div class="',"mi-editor ","mi-small-editor ","mi-grid-editor ","mi-grid-cell-editor ","mi-layer ","mi-editor-default ",'" ','style="right: auto;left: 0px;top: -91px;z-index: 19000;position: relative;" ',">","</div>"]);return a},css:function(c,d){var b=this,a=b.el;return a.css(c,d)},setSize:function(f,b){var d=this,a=arguments,e=a[0],c=d.inputObj;if(a.length==1&&typeof e=="object"){c.setWidth(e.width);c.setHeight(e.height)}else{c.setWidth(f);c.setHeight(b)}return d},setWidth:function(b){var a=this;a.inputObj.setWidth(b);return a.el.css("width",b)},setHeight:function(b){var a=this;a.inputObj.setHeight(b);return a.el.css("height",b)},show:function(){var a=this;a.visible=true;a.el.show();return a},setRowCell:function(c,a){var b=this;b.rowEl=c;b.cellEl=a;return b},setRow:function(b){var a=this;a.rowEl=b;return a},setCell:function(a){var b=this;b.cellEl=a;return b},setCellValue:function(b){var a=this;a.inputObj.setValue(b)},setValue:function(a){this.setCellValue(a);return this},hide:function(){var b=this,a=b.cellEl;if(!b.visible){return}b.visible=false;b.el.hide();if(b.lastKeyCode!="27"&&b.editing){b.inputSave(a);b.endEdit()}$(a).cFirst("div.mi-grid-cell-inner").show();b.cellEl=null;return b},layoutReset:function(){var a=this;a.inputObj.layoutReset()},inputSave:function(a){var e=this,c=e.inputObj;if(e.editing&&(c.isValueChanged&&c.isValueChanged())){var d=(c.isValueChanged?c.isValueChanged():true);if(d){var f=e.inputObj.getValue();var b=e.columnHeader.dataIndex;e.setMapValues(e.record,c.curRecord,f);e.record.set(b,f)}}},setMapValues:function(e,f,h){var d=this,a,b,c=d.mapItems,g;if(c){for(a=0;a<c.length;a++){b=c[a];if(""==b.srcField||""==b.targetField){continue}if(f){g=f.get(b.srcField)}else{g=null}e.set(b.targetField,g)}}},lastKeyCode:0,onKeydown:function(a){var d=this,b=d.inputObj;var c=event.keyCode;d.lastKeyCode=c;if(13==c){d.inputSave(d.cellEl);if(b.mapping){b.mapping.call(b)}d.endEdit();Mini2.ui.FocusMgr.setControl(d.cellEl)}else{if(9==c){d.inputSave(d.cellEl);d.endEdit();var f=$(d.cellEl).next();if(f.size()>1){d.grid.autoFocusScroll(f);Mini2.EventManager.stopEvent()}}else{if(27==c){d.record.cancelEdit();Mini2.ui.FocusMgr.setControl(d.cellEl)}else{d.on("keydown",a)}}}},gotoNextCell:function(f){var d=this,c=d.grid;var e=d.columnHeader.index+1;var a=c.m_Cols[e];if(a.miType=="checkcolumn"){d.hide();Mini2.ui.FocusMgr.setControl(f,c,null);return}else{if(a.miType=="rowcheckcolumn"){return}else{if(a.miType=="actioncolumn"){return}}}if(!a.editor||a.editorMode=="none"){Mini2.ui.FocusMgr.setControl(f,c,null)}else{var b=c.getEditor(a,d.record);c.showEditor(f,f,d.rowEl,a,d.record,b);Mini2.EventManager.stopEvent()}},onKeyup:function(a){var c=this,b=event.keyCode;if(9==b){var d=$(c.cellEl).next();if(d.size()){c.gotoNextCell(d)}}else{c.on("keyup",a)}},bind_key:function(a){var b=this;$(a).muBind("keydown",function(c){b.onKeydown(c)}).muBind("keyup",function(c){b.onKeyup(c)})},bind_mouse:function(a){var b=this;$(b.inputObj).muBind("mousedown",function(c){b.on("mousedown",c)}).muBind("mouseup",function(c){b.on("mouseup",c)}).muBind("mousemove",function(c){})},render:function(a){var e=this,b,c,d;e.el=c=$(e.getBox());e.visible=false;switch(e.xtype.toLowerCase()){case"combobox":b="Mini2.ui.form.field.ComboBox";break;case"comboboxbase":b="Mini2.ui.form.field.ComboBoxBase";break;case"datefield":b="Mini2.ui.form.field.Date";break;case"numberfield":b="Mini2.ui.form.field.Number";break;case"trigger":b="Mini2.ui.form.field.Trigger";break;default:b="Mini2.ui.form.field.Text";break}var f=Mini2.applyIf({renderTo:c,scope:c,labelable:{hideLabel:true}},e.config);e.inputObj=d=Mini2.create(b,f);d.render();$(e.renderTo).append(c);e.bind_key(d);e.bind_mouse(d);$(e).muBind("focusin",function(g){var h=this}).muBind("focusout",function(g,i){var h=this;if(i.data!=h.cellEl){if(27!=h.lastKeyCode){h.inputSave(i.data);h.endEdit()}}if(i.target!=h){h.hide();h.inputObj.on("focusout",i)}})},hideDropDownPanel:function(){var b=this,a=b.inputObj;if(a&&a.hideDropDownPanel){b.inputSave(b.cellEl);a.hideDropDownPanel()}return b},init:function(a){this.grid=a},onInit:function(){this.init()},isCellEditable:function(b,a){},startEdit:function(f,b,c){var e=this,d=e.inputObj,a=b;f.beginEdit();e.record=f;e.columnHeader=a;c.originalValue=c.value=f.get(a.dataIndex);d.oldValue=c.value;d.record=f;d.dataIndex=a.dataIndex;d.mapItems=e.mapItems;d.cellDisplayField=a.displayField;e.setCellValue(c.value);e.show();d.focus();e.editing=true;return e},showEditor:function(b,a,c){},getEditor:function(b,a){},getCell:function(c,a){var b=this;return b.cell},cancelEdit:function(){var a=this,b=a.record;b.cancelEdit();a.editing=false},endEdit:function(){var a=this,b=a.record;b.endEdit();a.editing=false},onShow:function(){},onHide:function(){},afterRender:function(){},onEditorTab:function(){},startEditByPosition:function(c){var b=this,a=b.inputObj;b.css({left:c.left,top:c.top+2});if(a&&a.onPositionChanged){a.onPositionChanged()}return b}});