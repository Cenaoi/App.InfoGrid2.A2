Mini2.define("Mini2.data.Store",{storeId:false,autoLoad:true,autoSync:true,autoSyncSuspended:false,remoteSort:false,remoteFilter:false,remoteGroup:false,groupField:undefined,groupDir:"ASC",sorters:false,pageSize:65535,currentPage:0,buffered:false,data:[],proxy:{},modelDefaults:null,model:null,implicitModel:false,isLoadData:false,autoSave:true,vTotalCount:-1,summary:false,on:function(b,a,d){var c=this;if(c.isLoadData){return c}$(c).triggerHandler(b,a);return c},intiSorters:function(){var a=this,b=a.sorters;a.sorters=new Mini2.collection.ArrayList(false,function(c){return c.id||c.property});if(b){a.sorters.addAll(a.decodeSorters(b))}},createImplicitModel:function(){var b=this,a=b.fields,c;if(!b.model&&a){c="Mini2.data.Store.ImplicitModel_"+(b.storeId||Mini2.getIdentity());b.model=Mini2.define(c,{extend:"Mini2.data.Model",fields:a});delete b.fields;b.implicitModel=true}},createInlineData:function(){var e=this,c,a,f,b=e.data,d=(b?b.length:0);if(b&&d>0){for(c=0;c<d;c++){a=e.data[c];f=Mini2.ModelManager.create(a,e.model);f.joinStore(e);b[c]=f}}e.inlineData=b;delete e.data;e.data=new Mini2.collection.ArrayList(e.inlineData);e.updateRecordsIndex()},constructor:function(a){var f=this;if(f.storeId){Mini2.data.StoreManager.regStore(f)}f.removed=[];f.model=Mini2.ModelManager.getModel(f.model);f.intiSorters();f.createImplicitModel();if(!f.disableMetaChangeEvent){var c,e,b=f.model.prototype.fields,d,g,h=new Mini2.collection.ArrayList(false,function(i){return i.name});for(c=0,e=b.length;c<e;c++){g=new Mini2.data.Field(b[c]);if(d&&((g.mapping&&(g.mapping===d.mapping))||(g.name===d.name))){idFieldDefined=true;g.defaultValue=undefined}h.add(g)}f.model.prototype.constructor.fields=h;if(f.idField){var d=new Mini2.data.Field(f.idField);f.model.prototype.constructor.idField=d;delete f.idField}if(f.lockedField){f.model.prototype.constructor.lockedField=f.lockedField;delete f.lockedField}}f.createInlineData();f.createBindEvent();if(f.totalCount<=0){f.totalCount=f.data.getCount()}},setSummary:function(a,e){var c=this,b,d=c.summary||{};if(!c.summary){c.summary=d}if(Mini2.isString(a)){d[a]=e;b={};b[a]=e;c.on("summarychnaged",[b])}else{for(b in a){d[b]=a[b]}c.on("summarychnaged",[a])}return c},getSummary:function(a){var b=this,c=b.summary||{};if(arguments.length){return c[a]}return c},setCurrentPage:function(a){this.currentPage=a},getCurrentPage:function(){return this.currentPage},updated_tag:false,createBindEvent:function(){var a=this;if(a.autoSave){$(a).muBind("update",a,function(){var b=a.getUpdatedRecords();if(0==b.length){return}a.updated_tag=true;if(!a.timeId){a.timeId=window.setInterval(function(){if(a.updated_tag){var c=a.getUpdatedRecords();if(0==c.length){return}a.updated_tag=false;widget1.subMethod($("form:first"),{subName:a.id,subMethod:"SaveAll"})}else{window.clearInterval(a.timeId);delete a.timeId}},1000)}})}},updateRecordsIndex:function(){var c=this,b,d,a=c.data;for(b=0;b<c.data.getCount();b++){d=a.get(b);d.index=b}},afterCommit:function(c,b){var a=this;if(!b){b=null}a.on("update",[c,"COMMIT",b])},setCurrntForId:function(a){var b=this,c;c=b.getById(a);b.setCurrent(c)},setCurrent:function(d){var f=this,a,b,e,c=f.data;if(undefined==c){return}if(Mini2.isNumber(d)){a=c.get(d);b=d}else{e=c.filterBy(function(g){if(g==d){return true}return false});if(e.length>0){a=e.get(0);b=a.index}else{a=null;b=-1}}f.current=a;f.currentIndex=b;f.on("currentchanged",[b,a]);if(f.currentChanged){f.currentChanged.call(f)}},getCurrent:function(){var a=this;return a.current},getCurrentIndex:function(){var a=this;return a.currentIndex},commitChanges:function(){var c=this,d=c.getModifiedRecords(),b=d.length,a=0;for(;a<b;a++){d[a].commit()}c.removed.length=0},commitChangesForMuid:function(e,d){var c=this,a=c.data,f,b;b=a.findIndexBy(function(g){if(g.muid==e){return true}});if(b==-1){return}f=a.get(b);f.commit(null,d)},add:function(a){var d=this,e,c,b;if(Mini2.isArray(a)){e=a}else{e=arguments[0]}c=e.length;e=d.insert(1000000,e);return e},load:function(c){var a=this,b;b=Mini2.apply({action:"read",sorters:a.getSorters()},c);a.lastOptions=b;a.on("load",[a])},filterNewOnly:function(a){return a.phantom===true},filterNew:function(a){return a.phantom===true&&a.isValid()},filterUpdated:function(a){return a.dirty===true&&a.phantom!==true},getNewRecords:function(){return this.data.filterBy(this.filterNew)},getUpdatedRecords:function(){return this.data.filterBy(this.filterUpdated)},getRemovedRecords:function(){return this.removed},sync:function(d){var a=this,c={},e=a.getNewRecords(),g=a.getUpdatedRecords(),f=a.getRemovedRecords(),b=false;if(e.length>0){c.create=e;b=true}if(g.length>0){c.update=g;b=true}if(f.length>0){c.destroy=f;b=true}if(b&&a.on("beforesync",c)!==false){d=d||{}}return a},removeById:function(b,e){var d=this,c,a=d.data;if(!Mini2.isArray(b)){b=[b]}c=a.filterBy(function(f){return Mini2.Array.contains(b,f.getId(),true)});d.remove(c,false,e);return c},removeByMuid:function(d,e){var c=this,b,a=c.data;if(!Mini2.isArray(d)){d=[d]}b=a.filterBy(function(f){return Mini2.Array.contains(d,f.muid)});c.remove(b,false,e);return b},removeAll:function(c){var b=this,d=b.snapshot,a=b.data;if(d){d.removeAll(a.getRange())}b.remove({start:0,end:b.getCount()-1},false,c);if(c!==true){b.on("clear",b);b.onDataChanged()}return b},beginLoadData:function(){var a=this;a.isLoadData=true},endLoadData:function(){var a=this;if(a.isLoadData){a.isLoadData=false;a.onLoad();a.onDataChanged();a.setCurrent(a.currentIndex)}},onDataChanged:function(){var a=this;if(a.getCount()>a.totalCount){a.totalCount=a.getCount()}a.on("datachanged",a)},onLoad:function(){var a=this;a.on("load",a)},remove:function(p,h,s){h=h===true;var m=this,u=false,t=m.snapshot,b=m.data,d=0,l,g=[],a=[],f=[],k,j,e,o,r,q;if(p.isModel){p=[p];l=1}if(p.isModel){p=[p];l=1}else{if(Mini2.isIterable(p)){if(p.toArray){p=p.toArray()}l=p.length}else{if(typeof p==="object"){r=true;d=p.start;l=p.end+1;q=l-d}}}if(!r){for(var d=0;d<l;d++){o=p[d];e=b.remove(o);o.unjoinStore(m);f.push(e);a.push(o);m.removed.push(o);m.on("remove",o,e,!!h)}}if(r){b.removeRange(p.start,q)}m.updateRecordsIndex();if(!s){m.on("bulkremove",[a,f,!!h]);m.onDataChanged()}var c=Mini2.Array.contains(f,m.currentIndex);if(c){var n=-1;if(m.currentIndex>=m.data.length){n=m.data.length-1}else{n=m.currentIndex}m.setCurrent(n)}},afterEdit:function(d,c){var b=this,a,e;b.on("update",[d,"EDIT",c])},clearInvalidAll_ByRecordId:function(d,a){var b=this,c=b.getById(d);if(c){c.clearInvalid(a)}},clearInvalid_ByRecordId:function(d,a){var b=this,c=b.getById(d);if(c){c.clearInvalid(a)}},markInvalid_ByRecordId:function(e,a){var c=this,d=c.getById(e);if(d){try{d.markInvalid(a)}catch(b){alert("Ö´ÐÐº¯Êý´íÎó: markInvalid_ByRecordId(...,..)."+b.Message)}}},afterInvalid:function(c,a){var b=this;b.on("invalid",[c,a])},filterFirstBy:function(b,e){var d=this,c,a=d.data;c=a.filterFirstBy(function(f){return e==f.get(b)});return c},getById:function(b){var d=this,c,a=d.data;c=a.filterFirstBy(function(e){return b==e.getId()});return c},setRecordValue:function(d,a,e){var b=this,c=b.getById(d);if(c){c.set(a,e);c.commit(null,[a])}},getModifiedRecords:function(){return[].concat(this.getNewRecords().toArray(),this.getUpdatedRecords().toArray())},sort:function(h){var d=this;d.sortText=h;if(!d.requestOptions){var f=d.currentPage,g=d.pageSize,e;e=Mini2.apply({action:"read",sorters:d.getSorters()},{});e.page=f;e.start=f*g;e.limit=g;e.end=e.start+e.limit;d.requestOptions=e}d.requestOptions.sorters=d.getSorters();var b=d.clientId+"_Action";var a=$("#"+b);var c=d.getRequestJson();a.val(c);d.loadPage(0)},doSort:function(b){var a=this;if(a.remoteSort){a.load()}else{a.data.sortBy(b);a.onDataChanged();a.on("refresh",a)}a.on("sort",a,a.sorters.getRange())},setReadOnly:function(b){var a=this;a.readOnly=b;return a},getReadOnly:function(){var a=this;return !!a.readOnly},refresh:function(){var a=this;a.on("refresh",a)},getTotalCount:function(){return this.totalCount},setTotalCount:function(a){this.totalCount=a},getCount:function(){var a=this;return a.data.getCount()},each:function(e,g){var b=this.data.items,c=b.length,f,a;for(a=0;a<c;a++){f=b[a];if(e.call(g||f,f,a,c)===false){break}}},createModel:function(a){if(!a.isModel){a=Mini2.ModelManager.create(a,this.model)}return a},insert:function(c,h){var e=this,j=false,b,d,g,a=e.modelDefaults,f;if(Mini2.isArray(h)){f=h}else{f=[h]}h=f;d=h.length;for(b=0;b<d;b++){g=h[b];if(!g.isModel){g=e.createModel(g)}g.joinStore(e);f[b]=g;if(a){g.set(a)}j=j||g.phantom===true;e.data.insert(c+b,g)}e.updateRecordsIndex();e.on("add",[c,f]);e.onDataChanged()},getCount:function(){return this.data.getCount()},loadPage:function(c){var a=this,b;if(undefined==c){c=a.currentPage}b=Mini2.apply({action:"read",sorters:a.getSorters()},{});b.page=c;b.start=c*a.pageSize;b.limit=a.pageSize;b.end=b.start+b.limit;a.requestOptions=b;var d=window.widget1;if(d&&d.subMethod){d.subMethod("form:first",{subName:a.id,subMethod:"LoadPage",actionPs:c})}},getSorters:function(){var a=this;return a.sortText},getJsonForRecord:function(d){var b=this,a;var c={action:"none",id:d.getId(),clientId:d.muid,index:b.currentIndex,values:{}};if(d.dirty){c.action="modified"}for(a in d.data){c.values[a]=d.data[a]}return c},getJsonForRecordModified:function(e,a){var c=this,b,d;d={action:"none",id:e.getId(),clientId:e.muid,index:a,values:{}};if(e.dirty){d.action="modified"}for(b in e.modified){d.values[b]=e.get(b)}return d},getRequestJson:function(){var b=this;var a=Mini2.Json.toJson(b.requestOptions);return a},getUploadJson:function(){var e=this,g,a,f,c,b,h=e.data,d=h.getCount();b={cur_index:e.currentIndex,current:null,records:[]};if(e.current&&e.currentIndex>-1){g=e.current;b.current=e.getJsonForRecord(g)}for(a=0;a<d;a++){g=h.get(a);if(!g.dirty){continue}f=e.getJsonForRecordModified(g,a);b.records.push(f)}c=Mini2.Json.toJson(b);return c},onLoader:function(){var a=this;a.setCurrent(0)}},function(){var a=this;Mini2.apply(this,arguments[0]);a.constructor()});