/// Mini2.js 创建日期:2021/6/11 19:21:55


/************************************************************************/
/*                                           */
/*    template.js                                                          */
/*                                           */
/************************************************************************/

/*!
 * artTemplate - Template Engine
 * https://github.com/aui/artTemplate
 * Released under the MIT, BSD, and GPL Licenses
 */

!(function () {


    /**
     * 模板引擎
     * @name    template
     * @param   {String}            模板名
     * @param   {Object, String}    数据。如果为字符串则编译并缓存编译结果
     * @return  {String, Function}  渲染好的HTML字符串或者渲染方法
     */
    var template = function (filename, content) {
        return typeof content === 'string'
        ? compile(content, {
            filename: filename
        })
        : renderFile(filename, content);
    };


    template.version = '3.0.0';


    /**
     * 设置全局配置
     * @name    template.config
     * @param   {String}    名称
     * @param   {Any}       值
     */
    template.config = function (name, value) {
        defaults[name] = value;
    };



    var defaults = template.defaults = {
        openTag: '<%',    // 逻辑语法开始标签
        closeTag: '%>',   // 逻辑语法结束标签
        escape: true,     // 是否编码输出变量的 HTML 字符
        cache: true,      // 是否开启缓存（依赖 options 的 filename 字段）
        compress: false,  // 是否压缩输出
        parser: null      // 自定义语法格式器 @see: template-syntax.js
    };


    var cacheStore = template.cache = {};


    /**
     * 渲染模板
     * @name    template.render
     * @param   {String}    模板
     * @param   {Object}    数据
     * @return  {String}    渲染好的字符串
     */
    template.render = function (source, options) {
        return compile(source, options);
    };


    /**
     * 渲染模板(根据模板名)
     * @name    template.render
     * @param   {String}    模板名
     * @param   {Object}    数据
     * @return  {String}    渲染好的字符串
     */
    var renderFile = template.renderFile = function (filename, data) {
        var fn = template.get(filename) || showDebugInfo({
            filename: filename,
            name: 'Render Error',
            message: 'Template not found'
        });
        return data ? fn(data) : fn;
    };


    /**
     * 获取编译缓存（可由外部重写此方法）
     * @param   {String}    模板名
     * @param   {Function}  编译好的函数
     */
    template.get = function (filename) {

        var cache;

        if (cacheStore[filename]) {
            // 使用内存缓存
            cache = cacheStore[filename];
        } else if (typeof document === 'object') {
            // 加载模板并编译
            var elem = document.getElementById(filename);

            if (elem) {
                var source = (elem.value || elem.innerHTML)
                .replace(/^\s*|\s*$/g, '');
                cache = compile(source, {
                    filename: filename
                });
            }
        }

        return cache;
    };


    var toString = function (value, type) {

        if (typeof value !== 'string') {

            type = typeof value;
            if (type === 'number') {
                value += '';
            } else if (type === 'function') {
                value = toString(value.call(value));
            } else {
                value = '';
            }
        }

        return value;

    };


    var escapeMap = {
        "<": "&#60;",
        ">": "&#62;",
        '"': "&#34;",
        "'": "&#39;",
        "&": "&#38;"
    };


    var escapeFn = function (s) {
        return escapeMap[s];
    };

    var escapeHTML = function (content) {
        return toString(content)
        .replace(/&(?![\w#]+;)|[<>"']/g, escapeFn);
    };


    var isArray = Array.isArray || function (obj) {
        return ({}).toString.call(obj) === '[object Array]';
    };


    var each = function (data, callback) {
        var i, len;
        if (isArray(data)) {
            for (i = 0, len = data.length; i < len; i++) {
                callback.call(data, data[i], i, data);
            }
        } else {
            for (i in data) {
                callback.call(data, data[i], i);
            }
        }
    };


    var utils = template.utils = {

        $helpers: {},

        $include: renderFile,

        $string: toString,

        $escape: escapeHTML,

        $each: each

    };/**
 * 添加模板辅助方法
 * @name    template.helper
 * @param   {String}    名称
 * @param   {Function}  方法
 */
    template.helper = function (name, helper) {
        helpers[name] = helper;
    };

    var helpers = template.helpers = utils.$helpers;




    /**
     * 模板错误事件（可由外部重写此方法）
     * @name    template.onerror
     * @event
     */
    template.onerror = function (e) {
        var message = 'Template Error\n\n';
        for (var name in e) {
            message += '<' + name + '>\n' + e[name] + '\n\n';
        }

        if (typeof console === 'object') {
            console.error(message);
        }
    };


    // 模板调试器
    var showDebugInfo = function (e) {

        template.onerror(e);

        return function () {
            return '{Template Error}';
        };
    };


    /**
     * 编译模板
     * 2012-6-6 @TooBug: define 方法名改为 compile，与 Node Express 保持一致
     * @name    template.compile
     * @param   {String}    模板字符串
     * @param   {Object}    编译选项
     *
     *      - openTag       {String}
     *      - closeTag      {String}
     *      - filename      {String}
     *      - escape        {Boolean}
     *      - compress      {Boolean}
     *      - debug         {Boolean}
     *      - cache         {Boolean}
     *      - parser        {Function}
     *
     * @return  {Function}  渲染方法
     */
    var compile = template.compile = function (source, options) {

        // 合并默认配置
        options = options || {};
        for (var name in defaults) {
            if (options[name] === undefined) {
                options[name] = defaults[name];
            }
        }


        var filename = options.filename;


        try {

            var Render = compiler(source, options);

        } catch (e) {

            e.filename = filename || 'anonymous';
            e.name = 'Syntax Error';

            return showDebugInfo(e);

        }


        // 对编译结果进行一次包装

        function render(data) {

            try {

                return new Render(data, filename) + '';

            } catch (e) {

                // 运行时出错后自动开启调试模式重新编译
                if (!options.debug) {
                    options.debug = true;
                    return compile(source, options)(data);
                }

                return showDebugInfo(e)();

            }

        }


        render.prototype = Render.prototype;
        render.toString = function () {
            return Render.toString();
        };


        if (filename && options.cache) {
            cacheStore[filename] = render;
        }


        return render;

    };




    // 数组迭代
    var forEach = utils.$each;


    // 静态分析模板变量
    var KEYWORDS =
        // 关键字
        'break,case,catch,continue,debugger,default,delete,do,else,false'
        + ',finally,for,function,if,in,instanceof,new,null,return,switch,this'
        + ',throw,true,try,typeof,var,void,while,with'

        // 保留字
        + ',abstract,boolean,byte,char,class,const,double,enum,export,extends'
        + ',final,float,goto,implements,import,int,interface,long,native'
        + ',package,private,protected,public,short,static,super,synchronized'
        + ',throws,transient,volatile'

        // ECMA 5 - use strict
        + ',arguments,let,yield'

        + ',undefined';

    var REMOVE_RE = /\/\*[\w\W]*?\*\/|\/\/[^\n]*\n|\/\/[^\n]*$|"(?:[^"\\]|\\[\w\W])*"|'(?:[^'\\]|\\[\w\W])*'|\s*\.\s*[$\w\.]+/g;
    var SPLIT_RE = /[^\w$]+/g;
    var KEYWORDS_RE = new RegExp(["\\b" + KEYWORDS.replace(/,/g, '\\b|\\b') + "\\b"].join('|'), 'g');
    var NUMBER_RE = /^\d[^,]*|,\d[^,]*/g;
    var BOUNDARY_RE = /^,+|,+$/g;
    var SPLIT2_RE = /^$|,+/;


    // 获取变量
    function getVariable(code) {
        return code
        .replace(REMOVE_RE, '')
        .replace(SPLIT_RE, ',')
        .replace(KEYWORDS_RE, '')
        .replace(NUMBER_RE, '')
        .replace(BOUNDARY_RE, '')
        .split(SPLIT2_RE);
    };


    // 字符串转义
    function stringify(code) {
        return "'" + code
        // 单引号与反斜杠转义
        .replace(/('|\\)/g, '\\$1')
        // 换行符转义(windows + linux)
        .replace(/\r/g, '\\r')
        .replace(/\n/g, '\\n') + "'";
    }


    function compiler(source, options) {

        var debug = options.debug;
        var openTag = options.openTag;
        var closeTag = options.closeTag;
        var parser = options.parser;
        var compress = options.compress;
        var escape = options.escape;



        var line = 1;
        var uniq = { $data: 1, $filename: 1, $utils: 1, $helpers: 1, $out: 1, $line: 1 };



        var isNewEngine = ''.trim;// '__proto__' in {}
        var replaces = isNewEngine
        ? ["$out='';", "$out+=", ";", "$out"]
        : ["$out=[];", "$out.push(", ");", "$out.join('')"];

        var concat = isNewEngine
            ? "$out+=text;return $out;"
            : "$out.push(text);";

        var print = "function(){"
        + "var text=''.concat.apply('',arguments);"
        + concat
        + "}";

        var include = "function(filename,data){"
        + "data=data||$data;"
        + "var text=$utils.$include(filename,data,$filename);"
        + concat
        + "}";

        var headerCode = "'use strict';"
        + "var $utils=this,$helpers=$utils.$helpers,"
        + (debug ? "$line=0," : "");

        var mainCode = replaces[0];

        var footerCode = "return new String(" + replaces[3] + ");"

        // html与逻辑语法分离
        forEach(source.split(openTag), function (code) {
            code = code.split(closeTag);

            var $0 = code[0];
            var $1 = code[1];

            // code: [html]
            if (code.length === 1) {

                mainCode += html($0);

                // code: [logic, html]
            } else {

                mainCode += logic($0);

                if ($1) {
                    mainCode += html($1);
                }
            }


        });

        var code = headerCode + mainCode + footerCode;

        // 调试语句
        if (debug) {
            code = "try{" + code + "}catch(e){"
            + "throw {"
            + "filename:$filename,"
            + "name:'Render Error',"
            + "message:e.message,"
            + "line:$line,"
            + "source:" + stringify(source)
            + ".split(/\\n/)[$line-1].replace(/^\\s+/,'')"
            + "};"
            + "}";
        }



        try {


            var Render = new Function("$data", "$filename", code);
            Render.prototype = utils;

            return Render;

        } catch (e) {
            e.temp = "function anonymous($data,$filename) {" + code + "}";
            throw e;
        }




        // 处理 HTML 语句
        function html(code) {

            // 记录行号
            line += code.split(/\n/).length - 1;

            // 压缩多余空白与注释
            if (compress) {
                code = code
                .replace(/\s+/g, ' ')
                .replace(/<!--[\w\W]*?-->/g, '');
            }

            if (code) {
                code = replaces[1] + stringify(code) + replaces[2] + "\n";
            }

            return code;
        }


        // 处理逻辑语句
        function logic(code) {

            var thisLine = line;

            if (parser) {

                // 语法转换插件钩子
                code = parser(code, options);

            } else if (debug) {

                // 记录行号
                code = code.replace(/\n/g, function () {
                    line++;
                    return "$line=" + line + ";";
                });

            }


            // 输出语句. 编码: <%=value%> 不编码:<%=#value%>
            // <%=#value%> 等同 v2.0.3 之前的 <%==value%>
            if (code.indexOf('=') === 0) {

                var escapeSyntax = escape && !/^=[=#]/.test(code);

                code = code.replace(/^=[=#]?|[\s;]*$/g, '');

                // 对内容编码
                if (escapeSyntax) {

                    var name = code.replace(/\s*\([^\)]+\)/, '');

                    // 排除 utils.* | include | print

                    if (!utils[name] && !/^(include|print)$/.test(name)) {
                        code = "$escape(" + code + ")";
                    }

                    // 不编码
                } else {
                    code = "$string(" + code + ")";
                }


                code = replaces[1] + code + replaces[2];

            }

            if (debug) {
                code = "$line=" + thisLine + ";" + code;
            }

            // 提取模板中的变量名
            forEach(getVariable(code), function (name) {

                // name 值可能为空，在安卓低版本浏览器下
                if (!name || uniq[name]) {
                    return;
                }

                var value;

                // 声明模板变量
                // 赋值优先级:
                // [include, print] > utils > helpers > data
                if (name === 'print') {

                    value = print;

                } else if (name === 'include') {

                    value = include;

                } else if (utils[name]) {

                    value = "$utils." + name;

                } else if (helpers[name]) {

                    value = "$helpers." + name;

                } else {

                    value = "$data." + name;
                }

                headerCode += name + "=" + value + ",";
                uniq[name] = true;


            });

            return code + "\n";
        }


    };



    // 定义模板引擎的语法


    defaults.openTag = '{{';
    defaults.closeTag = '}}';


    var filtered = function (js, filter) {
        var parts = filter.split(':');
        var name = parts.shift();
        var args = parts.join(':') || '';

        if (args) {
            args = ', ' + args;
        }

        return '$helpers.' + name + '(' + js + args + ')';
    }


    defaults.parser = function (code, options) {

        // var match = code.match(/([\w\$]*)(\b.*)/);
        // var key = match[1];
        // var args = match[2];
        // var split = args.split(' ');
        // split.shift();

        code = code.replace(/^\s/, '');

        var split = code.split(' ');
        var key = split.shift();
        var args = split.join(' ');



        switch (key) {

            case 'if':

                code = 'if(' + args + '){';
                break;

            case 'else':

                if (split.shift() === 'if') {
                    split = ' if(' + split.join(' ') + ')';
                } else {
                    split = '';
                }

                code = '}else' + split + '{';
                break;

            case '/if':

                code = '}';
                break;

            case 'each':

                var object = split[0] || '$data';
                var as = split[1] || 'as';
                var value = split[2] || '$value';
                var index = split[3] || '$index';

                var param = value + ',' + index;

                if (as !== 'as') {
                    object = '[]';
                }

                code = '$each(' + object + ',function(' + param + '){';
                break;

            case '/each':

                code = '});';
                break;

            case 'echo':

                code = 'print(' + args + ');';
                break;

            case 'print':
            case 'include':

                code = key + '(' + split.join(',') + ');';
                break;

            default:

                // 过滤器（辅助方法）
                // {{value | filterA:'abcd' | filterB}}
                // >>> $helpers.filterB($helpers.filterA(value, 'abcd'))
                // TODO: {{ddd||aaa}} 不包含空格
                if (/^\s*\|\s*[\w\$]/.test(args)) {

                    var escape = true;

                    // {{#value | link}}
                    if (code.indexOf('#') === 0) {
                        code = code.substr(1);
                        escape = false;
                    }

                    var i = 0;
                    var array = code.split('|');
                    var len = array.length;
                    var val = array[i++];

                    for (; i < len; i++) {
                        val = filtered(val, array[i]);
                    }

                    code = (escape ? '=' : '=#') + val;

                    // 即将弃用 {{helperName value}}
                } else if (template.helpers[key]) {

                    code = '=#' + key + '(' + split.join(',') + ');';

                    // 内容直接输出 {{value}}
                } else {

                    code = '=' + code;
                }

                break;
        }


        return code;
    };



    // RequireJS && SeaJS
    if (typeof define === 'function') {
        define(function () {
            return template;
        });

        // NodeJS
    } else if (typeof exports !== 'undefined') {
        module.exports = template;
    } else {
        this.template = template;
    }

})();


/************************************************************************/
/*                                           */
/*    Mini.js                                                              */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
//this.constructor.base.xxxXxx();

var Mini2 = Mini2 || {};
Mini2._startTime = new Date().getTime();

//对象定义
Mini2.classDefine = {};

//单件模式
Mini2.singleton = {};

Mini2.identity = 0;

//当前页面的配置信息
Mini2.onwerPage = Mini2.onwerPage || {};
Mini2.onwerPage.controls = Mini2.onwerPage.controls || {};
Mini2.find = function (conId) {
    return Mini2.onwerPage.controls[conId];
};

/**
* typeahead 输入提示框,显示的数量
*/
Mini2.onwerPage.typeahead = [];


enumerables = true;
enumerablesTest = { toString: 1 };

Mini2.getIdentity = function () {

    Mini2.identity++;

    return Mini2.identity;

};

Mini2.newId = Mini2.getIdentity;


Mini2.ClassType = function () {};


/**
 * 继承
 * @example 调用方法：  this.constructor.base.函数名.call(this);
 *                      this.constructor.base.setValue.call(this, valueStr);
 */
Mini2.extend = function (subClass, superClass) {
    "use strict";

    var F = function () { };
    F.prototype = superClass.prototype;
    subClass.prototype = new F();
    subClass.prototype.constructor = subClass;

    //subClass.superclass = superClass.prototype;
    subClass.base = superClass.prototype;

    if (superClass.prototype.constructor == Object.prototype.constructor) {
        superClass.prototype.constructor = superClass;
    }


    return subClass;
}


Mini2.overriden = function (origclass, overrides) {
    "use strict";
    if (overrides) {
        var p = origclass.prototype;
        for (var method in overrides) {
            p[method] = overrides[method];
        }
    }
}


Mini2.apply = function (obj, config, defaults) {
    "use strict";
    /// <summary>创建对象</summary>

    if (defaults) {
        Mini2.apply(obj, defaults);
    }

    if (obj && config && typeof config === 'object') {
        var i, j, k;

        for (i in config) {
            obj[i] = config[i];
        }
    }

    return obj;

}


Mini2.applyIf = function (o, c) {
    "use strict";
    if (o && c) {
        for (var p in c) {
            if (typeof o[p] == "undefined") { o[p] = c[p]; }
        }
    }
    return o;
}

Mini2.ns = function (namespace) {
    "use strict";
    var nn,strFList = namespace.split('.'),
        len = strFList.length,
        pNn = Mini2,
        i;

    for (i = 1; i < len ; i++) {

        nn = strFList[i];

        if (!pNn[nn]) {
            pNn[nn] = {};
        }

        pNn = pNn[nn];

    }
}

Mini2.defineClass = function (fullname, classT) {
    "use strict";
    if (!fullname) { return; }

    var strFList = fullname.split('.'),
        len = strFList.length,
        className = strFList[len - 1],
        pNn = Mini2,
        i,nn;

    if ('Mini2' != strFList[0]) {

        if (len >= 2) {
            var v = strFList[0];
            pNn = window[v];

            if (!pNn) {
                pNn = window[v] = {};
            }
        }
    }

    for (i = 1; i < len - 1; i++) {

        nn = strFList[i];

        if (!pNn[nn]) {
            pNn[nn] = {};
        }

        pNn = pNn[nn];

    }

    pNn[className] = classT;

    return className;
}

/**
* 定义对象
* 
* @param {String} fullname 对象名称
* @param {Object} codeObj 类的内容
* @param {Function} returnFn 实例化对象后, 执行的函数(构造函数)
*/
Mini2.define = function (fullname, codeObj, returnFn) {
    "use strict";
    /// <summary></summary>
    /// <param name="fullname" type="String">对象名称</param>
    /// <param name="codeObj" type="object">对象参数</param>
    var F, extend,mixins, extendObj, name, funType;

    if (codeObj instanceof Function) {
        //Mini2.overriden(F, codeObj);

        Mini2.classDefine[fullname] = codeObj;

        return codeObj;
    }

    //新建一个空的构造函数
    F = function () {
        return ((typeof this._returnFn == 'function') ?
             this._returnFn((arguments.length > 0 ? arguments[0] : false), (arguments.length > 1 ? arguments[1] : false)) : this._returnFn);
    };

    extend = codeObj.extend;
    mixins = codeObj.mixins;

    if (undefined != extend && extend != null && extend != '') {

        extendObj = Mini2.classDefine[extend];

        if (undefined === extendObj) {
            throw new Error(fullname + "继承对象 '" + extend + "' 不存在");
        }

        Mini2.extend(F, extendObj);
    }

    if (mixins ) {

        if (Mini2.isString(mixins)) {
            mixins = [mixins];
        }

        var mmm = null;

        for (var i = 0; i < mixins.length; i++) {

            mmm = mixins[i];
            extendObj = Mini2.classDefine[mmm];


            if (undefined === extendObj) {
                throw new Error(fullname + "继承对象 " + mmm + " 不存在");
            }

            Mini2.extend(F, extendObj);
        }
       
    }


    Mini2.overriden(F, codeObj);


    if (returnFn != undefined) {
        F.prototype._returnFn = returnFn;
    }

    Mini2.classDefine[fullname] = F;
    name = Mini2.defineClass(fullname, F);


    funType = new Mini2.ClassType();
    funType.fullName = fullname;
    funType.name = name;

    F.prototype.getType = function () {
        return eval("this.classType");
    };
    F.prototype.classType = funType;


    //别名的特殊处理
    if (codeObj.alternateClassName) {

        var i, altName,
            altNames = codeObj.alternateClassName,
            len ;

        if (Mini2.isString(altNames)) { altNames = [altNames]; }

        len = altNames.length;

        for (i = 0; i < len; i++) {

            altName = altNames[i];

            Mini2.classDefine[altName] = F;
            Mini2.defineClass(altName, F);
        }
    }

    //别名
    if (codeObj.alias) {
        Mini2.ClassManager.setAlias(fullname, codeObj.alias);
    }

    //如果是单件模式，就直接实例化处理
    if (codeObj.singleton) {
        return Mini2.create(fullname);
    }

    return F;
}

/**
* 创建单间类(静态类)
*
* @param {function} F 
* @param {String} fullname 全名
* @param {Object} ps 
* @return {Object} 静态类
*/
Mini2.createSingleton = function (F, fullname, ps) {
    "use strict";
    var obj = Mini2.singleton[fullname];


    if (obj != undefined) {
        return obj;
    }

    obj = new F(ps);
    obj.muid = "mu_" + Mini2.newId();

    for (var i in ps) {
        newObj[i] = ps[i];
    }

    Mini2.singleton[fullname] = obj;

    Mini2.defineClass(fullname, obj);


    if (F.prototype.alternateClassName) {

        var altNames = F.prototype.alternateClassName,
            altName,
            i,
            len;

        if (Mini2.isString(altNames)) { altNames = [altNames]; }

        len = altNames.length;

        for (i = 0; i < len; i++) {
            altName = altNames[i];
            Mini2.singleton[altName] = obj;
            Mini2.defineClass(altName, obj);
        }
    }

    return obj;
}

/**
 * 创建对象
 *
 */
Mini2.create = function (fullname, ps) {
    "use strict";

    var newObj = null,
        F;
    
    if (Mini2.String.startsWith(fullname, 'widget.')) {
        fullname = Mini2.ClassManager.getNameByAlias(fullname);
    }


    F = Mini2.classDefine[fullname];
    

    if (undefined === F) {
        throw new Error("对象 " + fullname + " 不存在, 无法创建实例.");
    }

    ps = ps || {};
        
    //单件模式
    if (F.prototype.singleton) {

        newObj = Mini2.createSingleton(F, fullname, ps);
    }
    else {

        ps.muid = "mu_" + Mini2.newId();

        newObj = new F(ps);
        
        if (undefined === F.prototype._returnFn) {
            Mini2.apply(newObj, ps);
        }
    }


    return newObj;
}


/**
 * 在浏览器的最外层实例化对象， 一般针对 Window 弹出窗口。
 */
Mini2.createTop = function (fullname, ps) {
    "use strict";

    var pMini2 = Mini2.getTopMini2();

    return pMini2.create(fullname, ps);
};


/**
 * 根据别名, 实例化组件
 */
Mini2.createByAlias = function (alias, ps) {
    "use strict";

    var newObj,
        fullname,
        F;
    
    fullname = Mini2.ClassManager.getNameByAlias(alias);

    F = Mini2.classDefine[fullname]

    ps.muid = "mu_" + Mini2.newId();

    newObj = new F(ps);


    if (undefined === F.prototype._returnFn) {
        Mini2.apply(newObj, ps);
    }

    return newObj;
};


Mini2.__isDisignMode = false;

/**
 * 设计模式
 */
Mini2.designMode = function (value) {

    if (arguments.length == 0) {
        return Mini2.__isDisignMode;
    }
    else {
        Mini2.__isDisignMode = !!value;
    }
};

Mini2.support = {


};

Mini2.support.mozilla = /firefox/.test(navigator.userAgent.toLowerCase()) || /mozilla/.test(navigator.userAgent.toLowerCase());
Mini2.support.webkit = /webkit/.test(navigator.userAgent.toLowerCase());
Mini2.support.opera = /opera/.test(navigator.userAgent.toLowerCase());
Mini2.support.msie = /msie/.test(navigator.userAgent.toLowerCase());

Mini2.support.ipad = /ipad/.test(navigator.userAgent.toLowerCase());
Mini2.support.iphone = /iphone os/.test(navigator.userAgent.toLowerCase());
Mini2.support.android = /android/.test(navigator.userAgent.toLowerCase());



//console.trace("Mini2.support", Mini2.support);

Mini2.apply(Mini2, {

    emptyFn: function () { },

    baseCSSPrefix: 'mi-',

    toString: Object.prototype.toString,

    defaultEl: $('<div></div>'),

    isEmpty: function (obj) {

        if (obj == undefined || obj == null) {
            return true;
        }

        if (typeof obj == 'string') {
            if (obj == "") {
                return true;
            }
        }

        return false;

    },

    getBody: function () { return $(document.body); },

    iterableRe: /\[object\s*(?:Array|Arguments|\w*Collection|\w*List|HTML\s+document\.all\s+class)\]/,





    
    getParentWindow: function () {

        var lastParent = window;

        var i = 0;
        for (i = 0; i < 9; i++) {
            if (lastParent.parent == lastParent || lastParent.parent == undefined) {
                break;
            }

            lastParent = lastParent.parent;
        }

        return lastParent;
    },

    //获取最顶层的 Mini2 对象
    getTopMini2: function () {

        var lastParent = window;

        var tops = [window];

        var i = 0;
        for (i = 0; i < 9; i++) {

            if (lastParent.parent === lastParent || lastParent.parent === undefined) {
                break;
            }
            
            lastParent = lastParent.parent;

            tops.push(lastParent);
        }

        var n = tops.length;

        var mini2Obj = Mini2;

        while (n--) {
            var curWin = tops[n];

            if (curWin.Mini2) {
                mini2Obj = curWin.Mini2;
                break;
            }
        }

        return mini2Obj;
    },

    /**
    * 作废
    */
    $joinStr: function (array) {

        var str = array.join('');

        return $(str);
    },

    $join:function(array){
        var str = Mini2.join(array);
        return $(str);
    },

    join: function (array) {

        if (Mini2.isString(array)) { return array; }

        return array.join('');
    },


    typeOf: function (value) {
        "use strict";
        var type,
            typeToString;

        if (value === null) {
            return 'null';
        }

        type = typeof value;

        if (type === 'undefined' || type === 'string' || type === 'number' || type === 'boolean') {
            return type;
        }

        typeToString = Object.prototype.toString.call(value);

        switch (typeToString) {
            case '[object Array]':
                return 'array';
            case '[object Date]':
                return 'date';
            case '[object Boolean]':
                return 'boolean';
            case '[object Number]':
                return 'number';
            case '[object RegExp]':
                return 'regexp';
        }

        if (type === 'function') {
            return 'function';
        }

        if (type === 'object') {
            if (value.nodeType !== undefined) {
                if (value.nodeType === 3) {
                    return (nonWhitespaceRe).test(value.nodeValue) ? 'textnode' : 'whitespace';
                }
                else {
                    return 'element';
                }
            }
            return 'object';
        }
    },


    //克隆对象
    clone: function (item) {
        "use strict";
        var type,
                i,
                j,
                k,
                clone,
                key;

        if (item === null || item === undefined) {
            return item;
        }

        // DOM nodes
        // TODO proxy this to Ext.Element.clone to handle automatic id attribute changing
        // recursively
        if (item.nodeType && item.cloneNode) {
            return item.cloneNode(true);
        }

        type = Object.prototype.toString.call(item);

        // Date
        if (type === '[object Date]') {
            return new Date(item.getTime());
        }


        // Array
        if (type === '[object Array]') {
            i = item.length;
            clone = [];

            while (i--) {
                clone[i] = Mini2.clone(item[i]);
            }
        }
        // Object
        else if (type === '[object Object]' && item.constructor === Object) {
            clone = {};

            for (key in item) {
                clone[key] = Mini2.clone(item[key]);
            }

            if (enumerables) {
                for (j = enumerables.length; j--; ) {
                    k = enumerables[j];
                    if (item.hasOwnProperty(k)) {
                        clone[k] = item[k];
                    }
                }
            }
        }

        return clone || item;
    },

    isString: function (value) {
        if (value === false) { return; }
        return (typeof value == 'string') || (value instanceof String);
    },

    isDate: function (value) {
        if (value === false) { return; }

        return Object.prototype.toString.call(value) === '[object Date]';
    },

    isArray: function (value) {
        return value && (value.isArray || $.isArray(value));
    },

    isFunction: function (value) {
        return $.isFunction(value);
    },

    isBoolean: function (value) {
        return (typeof value === "boolean");
    },

    isNumber: function (value) {
        return (typeof value === 'number');
    },


    isDom: function (value) {
        /// <summary>是否为 文档对象 节点</summary>

        if (!value) {
            return false;
        }

        var typeToString = value.toString();

        var len = typeToString.length;

        if (len < 12) {
            return false;
        }

        var subTag = typeToString.substr(0, 12);

        return (subTag === '[object HTML');
    },

    type: function (value) {

    },

    isIterable: function (value) {
        "use strict";
        if (!value || typeof value.length !== 'number' || typeof value === 'string') {
            return false;
        }

        if (value.muid) {
            return true;
        }

        // Certain "standard" collections in IE (such as document.images) do not offer the correct
        // Javascript Object interface; specifically, they lack the propertyIsEnumerable method.
        // And the item property while it does exist is not typeof "function"
        if (!value.propertyIsEnumerable) {
            return !!value.item;
        }

        // If it is a regular, interrogatable JS object (not an IE ActiveX object), then...
        // If it has its own property called "length", but not enumerable, it's iterable
        if (value.hasOwnProperty('length') && !value.propertyIsEnumerable('length')) {
            return true;
        }


        // Test against whitelist which includes known iterable collection types
        return this.iterableRe.test(Object.prototype.toString.call(value));

    },

    functionFactory: function () {
        var me = this,
            args = Array.prototype.slice.call(arguments),
            ln;

        if (Mini2.isSandboxed) {
            ln = args.length;
            if (ln > 0) {
                ln--;
                args[ln] = 'var Mini=window.' + Mini2.name + ';' + args[ln];
            }
        }

        return Function.prototype.constructor.apply(Function.prototype, args);
    },


    isDefined: function (value) {
        return typeof value !== 'undefined';
    },




    //弹出当前对象的属性集合
    alertProps: function (obj) {

        var txt = "";

        for (var i in obj) {

//            if (Mini2.isFunction(obj[i])) {
//                continue;
//            }

            txt += i + " = " + obj[i] + "\n";
        }

        alert(txt);

    }

});


jQuery.fn.extend({

    cFirst: function (until) {
        return $(this).children(until + ":first");
    },


    mFind: function (until) {
        return $(this).find(until + ":first");
    },


    addCls: function (cls) {
        "use strict";
        var args = arguments,
            $el = $(this),
            i = 0,
            len;

        if (Mini2.isArray(cls)) {
            args = cls;
        }

        len = args.length;

        for (i = 0; i < len; i++) {            
            $el.addClass(args[i]);
        }

        return this;
    },


    removeCls: function (cls) {
        "use strict";
        var args = arguments,
            i;

        if (Mini2.isArray(cls)) {
            args = cls;
        }

        i = args.length;

        while (i--) {
            $(this).removeClass(args[i]);
        }

    },



    muBind: function (eventName, data, fn) {
        "use strict";
        if (arguments.length == 2) {
            fn = arguments[1];
            data = null;
        }


        var me = this;

        if (typeof fn != 'function') {
            throw new Error("参数必须是 function 对象");
        }

        switch (eventName) {
            case 'mousedown':


                //$(me).on('mu_' + eventName, fn);

                $(me).on(eventName, data, function (evt) {

                    //console.debug("鼠标按键: ", evt.button);

                    Mini2.EventManager.setMouseDown(this, data, null, evt);

                    fn.call(this, evt, this);

                    //$(this).triggerHandler('mu_mousedown', [evt]);
                });

                break;
            case 'mouseup':
                $(me).on('mu_' + eventName, fn);

                $(me).on(eventName, data, function (evt) {

                    Mini2.EventManager.setMouseUp(this, evt);
                });

                break;
            case 'mousemove':
                $(me).on('mu_' + eventName, fn);

                $(me).on(eventName, data, function (evt) {
                    Mini2.EventManager.setMouseMove(this, evt);
                });
                break;
            default:

                if (me.length == 0) {
                    console.error('对象不存在,无法绑定事件 "' + eventName + '";');
                }

                //针对 JQuery.3.0 做了特殊处理
                if (me[0].muid && ('focusout' == eventName || 'focusin' == eventName)) {
                    eventName = 'mu_focusout';
                }

                try {
                    me.on(eventName, data, fn);
                }
                catch (ex) {
                    console.error("这个错误肯定是 JQuery 3.0 产生的错误. 事件名:" + eventName);
                    throw ex;
                }


                break;
        }

        return me;
    },

    muTriggerHandler: function (eventName, fun) {

        var me = this;

        /*****注: 以下代码( 针对 JQuery.3.0 做了特殊处理 )  *******/
        if (me[0].muid && ('focusout' == eventName || 'focusin' == eventName)) {
            eventName = 'mu_focusout';
        }

        me.triggerHandler(eventName, fun);
    }

});

//数据格式化显示,支持多参数
//例子： result = $.format('你好!{0}先生.', '黄');
//result：你好!黄先生
$.format = function (source, params) {
    "use strict";
    if (arguments.length == 1)
        return function () {
            var args = $.makeArray(arguments);
            args.unshift(source);
            return $.format.apply(this, args);
        };
    if (arguments.length > 2 && params.constructor != Array) {
        params = $.makeArray(arguments).slice(1);
    }
    if (params.constructor != Array) {
        params = [params];
    }
    $.each(params, function (i, n) {
        source = source.replace(new RegExp("\\{" + i + "\\}", "g"), n);
    });
    return source;
};

$(document).ready(function () {
    $(document.body).addClass("mi-webkit mi-border-box mi-body");
});



/************************************************************************/
/*                                           */
/*    class/ClassManager.js                                                */
/*                                           */
/************************************************************************/




Mini2.ClassManager = new function () {
    "use strict";

    var ClassManager = this;

    Mini2.apply(ClassManager, {

        //log: Mini2.Logger.getLogger('Mini2.ClassManager'),  //日志管理器


        /**
         * @private
         */
        maps: {
            alternateToName: {},
            aliasToName: {},
            nameToAliases: {},
            nameToAlternates: {}
        },

        /**
         * Register the alias for a class.
         *
         * @param {Ext.Class/String} cls a reference to a class or a className
         * @param {String} alias Alias to use when referring to this class
         */
        setAlias: function (cls, alias) {
            var me = this,
                maps = me.maps,
                aliasToNameMap = maps.aliasToName,
                nameToAliasesMap = maps.nameToAliases,
                className;


            if (typeof cls == 'string') {
                className = cls;
            } else {
                className = this.getName(cls);
            }

            if (alias && aliasToNameMap[alias] !== className) {

                aliasToNameMap[alias] = className;
            }

            if (!nameToAliasesMap[className]) {
                nameToAliasesMap[className] = [];
            }


            if (alias) {
                Mini2.Array.include(nameToAliasesMap[className], alias);
            }

            return me;
        },

        getName: function (cls) {

            return cls;
        },


        /**
         * Get the name of a class by its alias.
         *
         * @param {String} alias
         * @return {String} className
         */
        getNameByAlias: function (alias) {
            return this.maps.aliasToName[alias] || '';
        },


    });

};


/************************************************************************/
/*                                           */
/*    ajax.js                                                              */
/*                                           */
/************************************************************************/

/// <reference path="../../jquery/jquery-1.4.1-vsdoc.js" />


Mini2.post = function (url, formParsms, ok_Callback, error_Callback) {
    
    var me = this;

    if ($.isFunction(formParsms)) {
        error_Callback = ok_Callback;
        ok_Callback = formParsms;
        formParsms = null;
    }

    $.post(url, formParsms, function (result) {
                
        Mini2.Ajax.proResult(result,ok_Callback, error_Callback);
    });

};



Mini2.get = function (url, formParsms, ok_Callback, error_Callback) {

    var me = this;

    if ($.isFunction(formParsms)) {
        error_Callback = ok_Callback;
        ok_Callback = formParsms;
        formParsms = null;
    }

    $.get(url, formParsms, function (result) {

        Mini2.Ajax.proResult(result,ok_Callback, error_Callback);

    });

};


/**
* 数组操作类
*/
Mini2.Ajax = new function () {
    "use strict";

    Mini2.apply(this, {

        /**
        * 克隆函数
        */
        proResult: function (result, ok_Callback, error_Callback) {

            var pack;

            try {
                pack = JSON.parse(result);
            }
            catch (ex) {
                console.error('解析服务器反馈消息包错误,数据内容: ', result);
                return;
            }

            if (pack.success === true || pack.success === false) {

                try{
                    this.proResutV1(pack,result, ok_Callback, error_Callback);
                }
                catch (ex) {
                    console.error('反馈后执行错误', ex);
                    console.trace();
                }
            }
            else if (pack.result) {
                try{
                    this.proResultV2(pack,result, ok_Callback, error_Callback);
                }
                catch (ex) {
                    console.error('反馈后执行错误', ex);
                    console.trace();
                }
            }



        },

        proResutV1: function (pack,result, ok_Callback, error_Callback) {

            if (pack.success) {

                var data = pack.data;

                if (ok_Callback) {
                    ok_Callback( data, pack, result);
                }
            }
            else {

                if (error_Callback) {
                    error_Callback( pack, result);
                }
                else {
                    console.error('(v1)服务器反馈消息', pack.error_msg || pack.msg);

                    if (Mini2.Msg && Mini2.Msg.alert) {
                        //Mini2.Msg.alert('服务器反馈错误', pack.error_msg || pack.msg);
                    }
                }
            }
        },

        proResultV2: function (pack,result, ok_Callback, error_Callback) {


            if ('ok' == pack.result) {

                var data = pack.data;

                if (ok_Callback) {
                    ok_Callback(data, pack, result);
                }
            }
            else {

                if (error_Callback) {
                    error_Callback( pack, result);
                }
                else {
                    console.error('(v2)服务器反馈消息 ', pack.error_msg || pack.msg);

                    if (Mini2.Msg && Mini2.Msg.alert) {
                        //Mini2.Msg.alert('服务器反馈错误', pack.error_msg || pack.msg);
                    }
                }
            }
        }

    });


};



/************************************************************************/
/*                                           */
/*    lang/Timer.js                                                        */
/*                                           */
/************************************************************************/



/**
* 定时器
*/ 
Mini2.define('Mini2.Timer', {

    owner: null,

    enabled : false,

    /**
    * 执行的间隔
    */
    interval: 100,

    /**
    * 已经执行的次数
    */
    count: 0,

    /**
    * 限制执行的次数, 0=没有限制
    */
    limit: 0,

    /**
    * 超时,自动停止
    */
    overtime: 0,

    /**
    * 开始执行的时间
    */ 
    timeStart : null,
    
    tick: Mini2.emptyFn,

    
    timer:null,


    /**
    * 停止计时
    */
    stop: function () {
        var me = this;
        me.enabled = false;

        if (me.timer) {
            clearTimeout(me.timer);

            delete me.timer;
        }
        
        return me;
    },
    
    /**
    * 开始计时
    */
    start: function () {
        var me = this;

        if (!me.enabled) {
            me.timeStart = new Date().getTime();
            me.enabled = true;

            me.callTick();
        }
        return me;
    },

    /**
    * 重置
    */
    reset: function(){
        var me = this;

        me.count = 0;
        me.timeStart = new Date().getTime();

        return me;
    },

    /**
    * 重置后再启动
    */
    resetStart:function(){
        var me = this;
        
        me.reset().start();

        return me;
    },

    /**
    * 重置后再启动
    */
    restart: function(){
        var me = this;

        me.reset().start();

        return me;
    },

    /**
    * 调用定时函数
    */
    callTick: function () {

        var me = this,
            owner = me.owner,
            nowDate,
            limit = me.limit,
            overtime = me.overtime,
            result;


        if (!me.enabled) {
            return;
        }

        if (limit > 0 && me.count >= limit) {
            me.stop();
            return;
        }

        if (overtime > 0) {
            nowDate = new Date();
            span = nowDate.getTime() - me.timeStart;

            if (span >= overtime) {
                me.stop();
                return;
            }
        }

        me.timer = setTimeout(function () {

            nowDate = new Date();
            span = nowDate.getTime() - me.timeStart;

            if (span >= me.interval) {

                result = me.tick.call(owner);

                me.count++;

                if (false === result) {
                    me.stop();
                    return;
                }
            }

            me.callTick.call(me);
            
        }, me.interval);

    }

}, function () {
    var me = this;

    Mini2.apply(this, arguments[0]);

    this.start();
});

/**
* 设置定时器, 简化 Mini2.Timer 的配置
* 
* @param {Function} tickFn 触发执行的函数
* @parma {interval} 定时间隔(毫秒), 也可以是参数设置
*/
Mini2.setTimer = function (tickFn, interval) {
    var timer,
        cfg = {};

    if (undefined == interval) {

    }
    else if (Mini2.isArray(interval)) {
        cfg = Mini2.apply(cfg, {
            interval: interval[0],
            limit: interval[1]
        });
    }
    else if (Mini2.isNumber(interval)) {
        cfg.interval = interval;
    }
    else {
        cfg = Mini2.apply(cfg, interval);
    }

    cfg.tick = tickFn;

    timer = Mini2.create('Mini2.Timer', cfg);

    return timer;
}


/**
 * 运行一次的数据区
 */
Mini2.run1_data = {};

/**
 * 运行一次
 * @param code {String} 执行此函数的唯一编码
 * @param interval {int} 时间范围内 (毫秒)
 * @param owner {Object} 执行函数所属的对象
 * @param tickFun {Function} 执行函数
 */
Mini2.awaitRun = function (code, interval, owner, tickFun) {

    var me = this;

    var data = Mini2.run1_data;

    var item = data[code];

    if (item) {

        item.restart();

    }
    else {
        item = Mini2.setTimer(function () {
            tickFun.call(owner);

            delete me.run1_data[code];
            
        }, [interval, 1]);

        item.owner = me;
         
        data[code] = item;
    }

}


/************************************************************************/
/*                                           */
/*    lang/Guid.js                                                         */
/*                                           */
/************************************************************************/



Mini2.Guid = new function () {
    "use strict";
    Mini2.apply(this, {

        newGuid: function (formatParam) {

            var guid = "",
                i,
                n;

            formatParam = formatParam || 'D';
            
            if (formatParam == 'D') {

                for (i = 1; i <= 32; i++) {
                    n = Math.floor(Math.random() * 16.0).toString(16);

                    guid += n;

                    if ((i == 8) || (i == 12) || (i == 16) || (i == 20)) {
                        guid += "-";
                    }
                }
            }
            else if(formatParam == 'N'){
                for (i = 1; i <= 32; i++) {
                    n = Math.floor(Math.random() * 16.0).toString(16);

                    guid += n;

                }
            }

            return guid;

        }

    });
};



/************************************************************************/
/*                                           */
/*    lang/Function.js                                                     */
/*                                           */
/************************************************************************/



Mini2.Function = {

    bind: function (fn, scope, args, appendArgs) {
        "use strict";
        if (arguments.length === 2) {
            return function() {
                return fn.apply(scope, arguments);
            };
        }

        var method = fn,
            slice = Array.prototype.slice;

        return function() {
            var callArgs = args || arguments;

            if (appendArgs === true) {
                callArgs = slice.call(arguments, 0);
                callArgs = callArgs.concat(args);
            }
            else if (typeof appendArgs == 'number') {
                callArgs = slice.call(arguments, 0); // copy arguments first
                Mini2.Array.insert(callArgs, appendArgs, args);
            }

            return method.apply(scope || Ext.global, callArgs);
        };
    }

}


/************************************************************************/
/*                                           */
/*    lang/Json.js                                                         */
/*                                           */
/************************************************************************/



Mini2.Json = new function () {
    "use strict";
    Mini2.apply(this, {

        toJson: function (o) {

            if (o == undefined) {
                return "\"\"";
            }

            var r = [];
            if (typeof o == "string") return "\"" + o.replace(/([\"\\])/g, "\\$1").replace(/(\n)/g, "\\n").replace(/(\r)/g, "\\r").replace(/(\t)/g, "\\t").replace(/\+/g, '%2B') + "\"";
            if (Mini2.isDate(o)) { return "\"" + Mini2.Date.format(o, 'Y-m-d H:i:s.u') + "\""; }
            if (typeof o == "object") {
                if (!o.sort) {
                    for (var i in o)
                        r.push("\"" + i + "\":" + Mini2.Json.toJson(o[i]));
                    if (!!document.all && !/^\n?function\s*toString\(\)\s*\{\n?\s*\[native code\]\n?\s*\}\n?\s*$/.test(o.toString)) {
                        r.push("toString:" + o.toString.toString());
                    }
                    r = "{" + r.join() + "}"
                } else {
                    for (var i = 0; i < o.length; i++)
                        r.push(Mini2.Json.toJson(o[i]))
                    r = "[" + r.join() + "]";
                }
                return r;
            }
            return o.toString().replace(/\"\:/g, '":""');
        }
    });
};





/************************************************************************/
/*                                           */
/*    lang/Array.js                                                        */
/*                                           */
/************************************************************************/



/**
* 数组操作类
*/
Mini2.Array = new function () {
    "use strict";
    Mini2.apply(this, {

        /**
        * 克隆函数
        */ 
        clone: Mini2.clone,


        /**
        * 判断数组是否包含元素
        * 
        * @param {Array} srcArray 数据集合
        * @param {Object} item 需要判断的元素对象
        * @param {Boolean} isValueType 是否值类型
        * @return {Boolean} 是否包含对象
        */
        contains: function (srcArray, item, isValueType) {

            var isExist = false,
                i=0,
                len = srcArray.length;

            if (isValueType) {
                for (; i < len; i++) {
                    if (srcArray[i] == item) {
                        isExist = true;
                        break;
                    }
                }
            }
            else {
                for (; i < len; i++) {
                    if (srcArray[i] === item) {
                        isExist = true;
                        break;
                    }
                }
            }

            return isExist;
        },

        
        lastIndexOf: function (srcArray, item) {

            var n = -1,
                len = srcArray.length,
                index = len;

            while (index--) {
                if (srcArray[index] === item) {
                    n = index;
                    break;
                }
            }
            return n;
        },


        indexOf: function (srcArray, item) {

            var n = -1,
                i = 0,
                result = false,
                srcItem,
                len = srcArray.length;

            if (Mini2.isFunction(item)) {
                for (; i < len; i++) {
                    srcItem = srcArray[i];
                    result = item.call( srcItem )

                    if (result) {
                        n = i;
                        break;
                    }
                }
            }
            else {
                for (; i < len; i++) {
                    if (srcArray[i] === item) {
                        n = i;
                        break;
                    }
                }
            }

            return n;
        },


        /**
        * 包含元素, 如果不存在,就直接添加
        *
        * @parma {Array} srcArray 原数据数组
        * @param {Object} item 数据元素
        */
        add: function (srcArray, item) {

            srcArray.push(item);

        },


        /**
        * 包含元素, 如果不存在,就直接添加
        *
        * @parma {Array} srcArray 原数据数组
        * @param {Object} item 数据元素
        */
        include: function (srcArray, item) {
            var c = [];
            if (this.contains(srcArray, item)) {
                return;
            }
            srcArray.push(item);
        },

        /**
        * 删除数据的元素
        * 
        * @param {Array} srcArray 原数据数组
        * @param {Object} item 数据元素
        * @return {Int} 已删除元素的位置
        */
        remove: function (srcArray, item) {
            var c = [],
                n;

            n = this.indexOf(srcArray, item);

            if (n > -1) {
                srcArray.splice(n, 1);
            }

            return n;
        },

        /**
        * 移动元素
        *
        * @param {Array} srcArray 原数据数组
        * @param {Int} fromIndex 移动前的位置
        * @parma {Int} toIndex 移动的位置
        */
        move: function (srcArray, fromIndex, toIndex) {
            var item = srcArray[fromIndex],
                newIndex = toIndex;

            srcArray.splice(fromIndex, 1);

            if (fromIndex > toIndex) {
                newIndex++;
            }

            srcArray.splice(newIndex, 0, item);
        }

    });

};



/************************************************************************/
/*                                           */
/*    lang/Date.js                                                         */
/*                                           */
/************************************************************************/

/*
This file is part of Ext JS 4.2

Copyright (c) 2011-2013 Sencha Inc

Contact:  http://www.sencha.com/contact

Commercial Usage
Licensees holding valid commercial licenses may use this file in accordance with the Commercial
Software License Agreement provided with the Software or, alternatively, in accordance with the
terms contained in a written agreement between you and Sencha.

If you are unsure which license is appropriate for your use, please contact the sales department
at http://www.sencha.com/contact.

Build date: 2013-05-16 14:36:50 (f9be68accb407158ba2b1be2c226a6ce1f649314)
*/
// @tag foundation,core
// @require Object.js
// @define Mini2.Date

/**
* @class Mini2.Date
* A set of useful static methods to deal with date
* Note that if Mini2.Date is required and loaded, it will copy all methods / properties to
* this object for convenience
*
* The date parsing and formatting syntax contains a subset of
* [PHP's `date()` function](http://www.php.net/date), and the formats that are
* supported will provide results equivalent to their PHP versions.
*
* The following is a list of all currently supported formats:
* <pre class="">
Format      Description                                                               Example returned values
------      -----------------------------------------------------------------------   -----------------------
d         Day of the month, 2 digits with leading zeros                             01 to 31
D         A short textual representation of the day of the week                     Mon to Sun
j         Day of the month without leading zeros                                    1 to 31
l         A full textual representation of the day of the week                      Sunday to Saturday
N         ISO-8601 numeric representation of the day of the week                    1 (for Monday) through 7 (for Sunday)
S         English ordinal suffix for the day of the month, 2 characters             st, nd, rd or th. Works well with j
w         Numeric representation of the day of the week                             0 (for Sunday) to 6 (for Saturday)
z         The day of the year (starting from 0)                                     0 to 364 (365 in leap years)
W         ISO-8601 week number of year, weeks starting on Monday                    01 to 53
F         A full textual representation of a month, such as January or March        January to December
m         Numeric representation of a month, with leading zeros                     01 to 12
M         A short textual representation of a month                                 Jan to Dec
n         Numeric representation of a month, without leading zeros                  1 to 12
t         Number of days in the given month                                         28 to 31
L         Whether it&#39;s a leap year                                                  1 if it is a leap year, 0 otherwise.
o         ISO-8601 year number (identical to (Y), but if the ISO week number (W)    Examples: 1998 or 2004
belongs to the previous or next year, that year is used instead)
Y         A full numeric representation of a year, 4 digits                         Examples: 1999 or 2003
y         A two digit representation of a year                                      Examples: 99 or 03
a         Lowercase Ante meridiem and Post meridiem                                 am or pm
A         Uppercase Ante meridiem and Post meridiem                                 AM or PM
g         12-hour format of an hour without leading zeros                           1 to 12
G         24-hour format of an hour without leading zeros                           0 to 23
h         12-hour format of an hour with leading zeros                              01 to 12
H         24-hour format of an hour with leading zeros                              00 to 23
i         Minutes, with leading zeros                                               00 to 59
s         Seconds, with leading zeros                                               00 to 59
u         Decimal fraction of a second                                              Examples:
(minimum 1 digit, arbitrary number of digits allowed)                     001 (i.e. 0.001s) or
100 (i.e. 0.100s) or
999 (i.e. 0.999s) or
999876543210 (i.e. 0.999876543210s)
O         Difference to Greenwich time (GMT) in hours and minutes                   Example: +1030
P         Difference to Greenwich time (GMT) with colon between hours and minutes   Example: -08:00
T         Timezone abbreviation of the machine running the code                     Examples: EST, MDT, PDT ...
Z         Timezone offset in seconds (negative if west of UTC, positive if east)    -43200 to 50400
c         ISO 8601 date
Notes:                                                                    Examples:
1) If unspecified, the month / day defaults to the current month / day,   1991 or
the time defaults to midnight, while the timezone defaults to the      1992-10 or
browser's timezone. If a time is specified, it must include both hours 1993-09-20 or
and minutes. The "T" delimiter, seconds, milliseconds and timezone     1994-08-19T16:20+01:00 or
are optional.                                                          1995-07-18T17:21:28-02:00 or
2) The decimal fraction of a second, if specified, must contain at        1996-06-17T18:22:29.98765+03:00 or
least 1 digit (there is no limit to the maximum number                 1997-05-16T19:23:30,12345-0400 or
of digits allowed), and may be delimited by either a '.' or a ','      1998-04-15T20:24:31.2468Z or
Refer to the examples on the right for the various levels of              1999-03-14T20:24:32Z or
date-time granularity which are supported, or see                         2000-02-13T21:25:33
http://www.w3.org/TR/NOTE-datetime for more info.                         2001-01-12 22:26:34
U         Seconds since the Unix Epoch (January 1 1970 00:00:00 GMT)                1193432466 or -2138434463
MS        Microsoft AJAX serialized dates                                           \/Date(1238606590509)\/ (i.e. UTC milliseconds since epoch) or
\/Date(1238606590509+0800)\/
time      A javascript millisecond timestamp                                        1350024476440
timestamp A UNIX timestamp (same as U)                                              1350024866            
</pre>
*
* Example usage (note that you must escape format specifiers with '\\' to render them as character literals):
*
*     // Sample date:
*     // 'Wed Jan 10 2007 15:05:01 GMT-0600 (Central Standard Time)'
*     
*     var dt = new Date('1/10/2007 03:05:01 PM GMT-0600');
*     console.log(Mini2.Date.format(dt, 'Y-m-d'));                          // 2007-01-10
*     console.log(Mini2.Date.format(dt, 'F j, Y, g:i a'));                  // January 10, 2007, 3:05 pm
*     console.log(Mini2.Date.format(dt, 'l, \\t\\he jS \\of F Y h:i:s A')); // Wednesday, the 10th of January 2007 03:05:01 PM
*
* Here are some standard date/time patterns that you might find helpful.  They
* are not part of the source of Mini2.Date, but to use them you can simply copy this
* block of code into any script that is included after Mini2.Date and they will also become
* globally available on the Date object.  Feel free to add or remove patterns as needed in your code.
*
*     Mini2.Date.patterns = {
*         ISO8601Long:"Y-m-d H:i:s",
*         ISO8601Short:"Y-m-d",
*         ShortDate: "n/j/Y",
*         LongDate: "l, F d, Y",
*         FullDateTime: "l, F d, Y g:i:s A",
*         MonthDay: "F d",
*         ShortTime: "g:i A",
*         LongTime: "g:i:s A",
*         SortableDateTime: "Y-m-d\\TH:i:s",
*         UniversalSortableDateTime: "Y-m-d H:i:sO",
*         YearMonth: "F, Y"
*     };
*
* Example usage:
*
*     var dt = new Date();
*     console.log(Mini2.Date.format(dt, Mini2.Date.patterns.ShortDate));
*
* Developer-written, custom formats may be used by supplying both a formatting and a parsing function
* which perform to specialized requirements. The functions are stored in {@link #parseFunctions} and {@link #formatFunctions}.
* @singleton
*/

/*
* Most of the date-formatting functions below are the excellent work of Baron Schwartz.
* (see http://www.xaprb.com/blog/2005/12/12/javascript-closures-for-runtime-efficiency/)
* They generate precompiled functions from format patterns instead of parsing and
* processing each pattern every time a date is formatted. These functions are available
* on every Date object.
*/


Mini2.Date = new function () {
    "use strict";
    var utilDate = this,
      stripEscapeRe = /(\\.)/g,
      hourInfoRe = /([gGhHisucUOPZ]|MS)/,
      dateInfoRe = /([djzmnYycU]|MS)/,
      slashRe = /\\/gi,
      numberTokenRe = /\{(\d+)\}/g,
      MSFormatRe = new RegExp('\\/Date\\(([-+])?(\\d+)(?:[+-]\\d{4})?\\)\\/'),
      code = [
    // date calculations (note: the code below creates a dependency on Mini2.Number.from())
        "var me = this, dt, y, m, d, h, i, s, ms, o, O, z, zz, u, v, W, year, jan4, week1monday, daysInMonth, dayMatched,",
            "def = me.defaults,",
            "from = Mini2.Number.from,",
            "results = String(input).match(me.parseRegexes[{0}]);", // either null, or an array of matched strings

        "if(results){",
            "{1}",

            "if(u != null){", // i.e. unix time is defined
                "v = new Date(u * 1000);", // give top priority to UNIX time
            "}else{",
    // create Date object representing midnight of the current day;
    // this will provide us with our date defaults
    // (note: clearTime() handles Daylight Saving Time automatically)
                "dt = me.clearTime(new Date);",

                "y = from(y, from(def.y, dt.getFullYear()));",
                "m = from(m, from(def.m - 1, dt.getMonth()));",
                "dayMatched = d !== undefined;",
                "d = from(d, from(def.d, dt.getDate()));",

    // Attempt to validate the day. Since it defaults to today, it may go out
    // of range, for example parsing m/Y where the value is 02/2000 on the 31st of May.
    // It will attempt to parse 2000/02/31, which will overflow to March and end up
    // returning 03/2000. We only do this when we default the day. If an invalid day value
    // was set to be parsed by the user, continue on and either let it overflow or return null
    // depending on the strict value. This will be in line with the normal Date behaviour.

                "if (!dayMatched) {",
                    "dt.setDate(1);",
                    "dt.setMonth(m);",
                    "dt.setFullYear(y);",

                    "daysInMonth = me.getDaysInMonth(dt);",
                    "if (d > daysInMonth) {",
                        "d = daysInMonth;",
                    "}",
                "}",

                "h  = from(h, from(def.h, dt.getHours()));",
                "i  = from(i, from(def.i, dt.getMinutes()));",
                "s  = from(s, from(def.s, dt.getSeconds()));",
                "ms = from(ms, from(def.ms, dt.getMilliseconds()));",

                "if(z >= 0 && y >= 0){",
    // both the year and zero-based day of year are defined and >= 0.
    // these 2 values alone provide sufficient info to create a full date object

    // create Date object representing January 1st for the given year
    // handle years < 100 appropriately
                    "v = me.add(new Date(y < 100 ? 100 : y, 0, 1, h, i, s, ms), me.YEAR, y < 100 ? y - 100 : 0);",

    // then add day of year, checking for Date "rollover" if necessary
                    "v = !strict? v : (strict === true && (z <= 364 || (me.isLeapYear(v) && z <= 365))? me.add(v, me.DAY, z) : null);",
                "}else if(strict === true && !me.isValid(y, m + 1, d, h, i, s, ms)){", // check for Date "rollover"
                    "v = null;", // invalid date, so return null
                "}else{",
                    "if (W) {", // support ISO-8601
    // http://en.wikipedia.org/wiki/ISO_week_date
    //
    // Mutually equivalent definitions for week 01 are:
    // a. the week starting with the Monday which is nearest in time to 1 January
    // b. the week with 4 January in it
    // ... there are many others ...
    //
    // We'll use letter b above to determine the first week of the year.
    //
    // So, first get a Date object for January 4th of whatever calendar year is desired.
    //
    // Then, the first Monday of the year can easily be determined by (operating on this Date):
    // 1. Getting the day of the week.
    // 2. Subtracting that by one.
    // 3. Multiplying that by 86400000 (one day in ms).
    // 4. Subtracting this number of days (in ms) from the January 4 date (represented in ms).
    // 
    // Example #1 ...
    //
    //       January 2012
    //   Su Mo Tu We Th Fr Sa
    //    1  2  3  4  5  6  7
    //    8  9 10 11 12 13 14
    //   15 16 17 18 19 20 21
    //   22 23 24 25 26 27 28
    //   29 30 31
    //
    // 1. January 4th is a Wednesday.
    // 2. Its day number is 3.
    // 3. Simply substract 2 days from Wednesday.
    // 4. The first week of the year begins on Monday, January 2. Simple!
    //
    // Example #2 ...
    //       January 1992
    //   Su Mo Tu We Th Fr Sa
    //             1  2  3  4
    //    5  6  7  8  9 10 11
    //   12 13 14 15 16 17 18
    //   19 20 21 22 23 24 25
    //   26 27 28 29 30 31
    // 
    // 1. January 4th is a Saturday.
    // 2. Its day number is 6.
    // 3. Simply subtract 5 days from Saturday.
    // 4. The first week of the year begins on Monday, December 30. Simple!
    //
    // v = Mini2.Date.clearTime(new Date(week1monday.getTime() + ((W - 1) * 604800000)));
    // (This is essentially doing the same thing as above but for the week rather than the day)
                        "year = y || (new Date()).getFullYear(),",
                        "jan4 = new Date(year, 0, 4, 0, 0, 0),",
                        "week1monday = new Date(jan4.getTime() - ((jan4.getDay() - 1) * 86400000));",
                        "v = Mini2.Date.clearTime(new Date(week1monday.getTime() + ((W - 1) * 604800000)));",
                    "} else {",
    // plain old Date object
    // handle years < 100 properly
                        "v = me.add(new Date(y < 100 ? 100 : y, m, d, h, i, s, ms), me.YEAR, y < 100 ? y - 100 : 0);",
                    "}",
                "}",
            "}",
        "}",

        "if(v){",
    // favor UTC offset over GMT offset
            "if(zz != null){",
    // reset to UTC, then add offset
                "v = me.add(v, me.SECOND, -v.getTimezoneOffset() * 60 - zz);",
            "}else if(o){",
    // reset to GMT, then add offset
                "v = me.add(v, me.MINUTE, -v.getTimezoneOffset() + (sn == '+'? -1 : 1) * (hr * 60 + mn));",
            "}",
        "}",

        "return v;"
      ].join('\n');

    // create private copy of Ext JS's `Mini2.util.Format.format()` method
    // - to remove unnecessary dependency
    // - to resolve namespace conflict with MS-Ajax's implementation
    function xf(format) {
        var args = Array.prototype.slice.call(arguments, 1);
        return format.replace(numberTokenRe, function (m, i) {
            return args[i];
        });
    }

    Mini2.apply(utilDate, {
        /**
        * Returns the current timestamp.
        * @return {Number} Milliseconds since UNIX epoch.
        * @method
        */
        now: Date.now || function () {
            return +new Date();
        },

        /**
        * @private
        * Private for now
        */
        toString: function (date) {
            var pad = Mini2.String.leftPad;

            return date.getFullYear() + "-"
            + pad(date.getMonth() + 1, 2, '0') + "-"
            + pad(date.getDate(), 2, '0') + "T"
            + pad(date.getHours(), 2, '0') + ":"
            + pad(date.getMinutes(), 2, '0') + ":"
            + pad(date.getSeconds(), 2, '0');
        },

        /**
        * Returns the number of milliseconds between two dates.
        * @param {Date} dateA The first date.
        * @param {Date} [dateB=new Date()] (optional) The second date.
        * @return {Number} The difference in milliseconds
        */
        getElapsed: function (dateA, dateB) {
            return Math.abs(dateA - (dateB || utilDate.now()));
        },

        /**
        * Global flag which determines if strict date parsing should be used.
        * Strict date parsing will not roll-over invalid dates, which is the
        * default behavior of JavaScript Date objects.
        * (see {@link #parse} for more information)
        * @type Boolean
        */
        useStrict: false,

        // private
        formatCodeToRegex: function (character, currentGroup) {
            // Note: currentGroup - position in regex result array (see notes for Mini2.Date.parseCodes below)
            var p = utilDate.parseCodes[character];

            if (p) {
                p = typeof p == 'function' ? p() : p;
                utilDate.parseCodes[character] = p; // reassign function result to prevent repeated execution
            }

            return p ? Mini2.applyIf({
                c: p.c ? xf(p.c, currentGroup || "{0}") : p.c
            }, p) : {
                g: 0,
                c: null,
                s: Mini2.String.escapeRegex(character) // treat unrecognized characters as literals
            };
        },

        /**
        * An object hash in which each property is a date parsing function. The property name is the
        * format string which that function parses.
        *
        * This object is automatically populated with date parsing functions as
        * date formats are requested for Ext standard formatting strings.
        *
        * Custom parsing functions may be inserted into this object, keyed by a name which from then on
        * may be used as a format string to {@link #parse}.
        *
        * Example:
        *
        *     Mini2.Date.parseFunctions['x-date-format'] = myDateParser;
        *
        * A parsing function should return a Date object, and is passed the following parameters:<div class="mdetail-params"><ul>
        * <li><code>date</code> : String<div class="sub-desc">The date string to parse.</div></li>
        * <li><code>strict</code> : Boolean<div class="sub-desc">True to validate date strings while parsing
        * (i.e. prevent JavaScript Date "rollover") (The default must be `false`).
        * Invalid date strings should return `null` when parsed.</div></li>
        * </ul></div>
        *
        * To enable Dates to also be _formatted_ according to that format, a corresponding
        * formatting function must be placed into the {@link #formatFunctions} property.
        * @property parseFunctions
        * @type Object
        */
        parseFunctions: {
            "MS": function (input, strict) {
                // note: the timezone offset is ignored since the MS Ajax server sends
                // a UTC milliseconds-since-Unix-epoch value (negative values are allowed)
                var r = (input || '').match(MSFormatRe);
                return r ? new Date(((r[1] || '') + r[2]) * 1) : null;
            },
            "time": function (input, strict) {
                var num = parseInt(input, 10);
                if (num || num === 0) {
                    return new Date(num);
                }
                return null;
            },
            "timestamp": function (input, strict) {
                var num = parseInt(input, 10);
                if (num || num === 0) {
                    return new Date(num * 1000);
                }
                return null;
            }
        },
        parseRegexes: [],

        /**
        * An object hash in which each property is a date formatting function. The property name is the
        * format string which corresponds to the produced formatted date string.
        *
        * This object is automatically populated with date formatting functions as
        * date formats are requested for Ext standard formatting strings.
        *
        * Custom formatting functions may be inserted into this object, keyed by a name which from then on
        * may be used as a format string to {@link #format}.
        *
        * Example:
        *
        *     Mini2.Date.formatFunctions['x-date-format'] = myDateFormatter;
        *
        * A formatting function should return a string representation of the passed Date object, and is passed the following parameters:<div class="mdetail-params"><ul>
        * <li><code>date</code> : Date<div class="sub-desc">The Date to format.</div></li>
        * </ul></div>
        *
        * To enable date strings to also be _parsed_ according to that format, a corresponding
        * parsing function must be placed into the {@link #parseFunctions} property.
        * @property formatFunctions
        * @type Object
        */
        formatFunctions: {
            "MS": function () {
                // UTC milliseconds since Unix epoch (MS-AJAX serialized date format (MRSF))
                return '\\/Date(' + this.getTime() + ')\\/';
            },
            "time": function () {
                return this.getTime().toString();
            },
            "timestamp": function () {
                return utilDate.format(this, 'U');
            }
        },

        y2kYear: 50,

        /**
        * Date interval constant
        * @type String
        */
        MILLI: "ms",

        /**
        * Date interval constant
        * @type String
        */
        SECOND: "s",

        /**
        * Date interval constant
        * @type String
        */
        MINUTE: "mi",

        /** Date interval constant
        * @type String
        */
        HOUR: "h",

        /**
        * Date interval constant
        * @type String
        */
        DAY: "d",

        /**
        * Date interval constant
        * @type String
        */
        MONTH: "mo",

        /**
        * Date interval constant
        * @type String
        */
        YEAR: "y",

        /**
        * An object hash containing default date values used during date parsing.
        * 
        * The following properties are available:<div class="mdetail-params"><ul>
        * <li><code>y</code> : Number<div class="sub-desc">The default year value. (defaults to undefined)</div></li>
        * <li><code>m</code> : Number<div class="sub-desc">The default 1-based month value. (defaults to undefined)</div></li>
        * <li><code>d</code> : Number<div class="sub-desc">The default day value. (defaults to undefined)</div></li>
        * <li><code>h</code> : Number<div class="sub-desc">The default hour value. (defaults to undefined)</div></li>
        * <li><code>i</code> : Number<div class="sub-desc">The default minute value. (defaults to undefined)</div></li>
        * <li><code>s</code> : Number<div class="sub-desc">The default second value. (defaults to undefined)</div></li>
        * <li><code>ms</code> : Number<div class="sub-desc">The default millisecond value. (defaults to undefined)</div></li>
        * </ul></div>
        * 
        * Override these properties to customize the default date values used by the {@link #parse} method.
        * 
        * __Note:__ In countries which experience Daylight Saving Time (i.e. DST), the `h`, `i`, `s`
        * and `ms` properties may coincide with the exact time in which DST takes effect.
        * It is the responsibility of the developer to account for this.
        *
        * Example Usage:
        * 
        *     // set default day value to the first day of the month
        *     Mini2.Date.defaults.d = 1;
        *
        *     // parse a February date string containing only year and month values.
        *     // setting the default day value to 1 prevents weird date rollover issues
        *     // when attempting to parse the following date string on, for example, March 31st 2009.
        *     Mini2.Date.parse('2009-02', 'Y-m'); // returns a Date object representing February 1st 2009
        *
        * @property defaults
        * @type Object
        */
        defaults: {},

        //<locale type="array">
        /**
        * @property {String[]} dayNames
        * An array of textual day names.
        * Override these values for international dates.
        *
        * Example:
        *
        *     Mini2.Date.dayNames = [
        *         'SundayInYourLang',
        *         'MondayInYourLang'
        *         // ...
        *     ];
        */
        dayNames: [
        "星期日",
        "星期一",
        "星期二",
        "星期三",
        "星期四",
        "星期五",
        "星期六"
    ],
        //</locale>

        //<locale type="array">
        /**
        * @property {String[]} monthNames
        * An array of textual month names.
        * Override these values for international dates.
        *
        * Example:
        *
        *     Mini2.Date.monthNames = [
        *         'JanInYourLang',
        *         'FebInYourLang'
        *         // ...
        *     ];
        */
        monthNames: [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December"
    ],
        //</locale>

        //<locale type="object">
        /**
        * @property {Object} monthNumbers
        * An object hash of zero-based JavaScript month numbers (with short month names as keys. **Note:** keys are case-sensitive).
        * Override these values for international dates.
        *
        * Example:
        *
        *     Mini2.Date.monthNumbers = {
        *         'LongJanNameInYourLang': 0,
        *         'ShortJanNameInYourLang':0,
        *         'LongFebNameInYourLang':1,
        *         'ShortFebNameInYourLang':1
        *         // ...
        *     };
        */
        monthNumbers: {
            January: 0,
            Jan: 0,
            February: 1,
            Feb: 1,
            March: 2,
            Mar: 2,
            April: 3,
            Apr: 3,
            May: 4,
            June: 5,
            Jun: 5,
            July: 6,
            Jul: 6,
            August: 7,
            Aug: 7,
            September: 8,
            Sep: 8,
            October: 9,
            Oct: 9,
            November: 10,
            Nov: 10,
            December: 11,
            Dec: 11
        },
        //</locale>

        //<locale>
        /**
        * @property {String} defaultFormat
        * The date format string that the {@link Mini2.util.Format#dateRenderer}
        * and {@link Mini2.util.Format#date} functions use.  See {@link Mini2.Date} for details.
        *
        * This may be overridden in a locale file.
        */
        defaultFormat: "m/d/Y",
        //</locale>
        //<locale type="function">
        /**
        * Get the short month name for the given month number.
        * Override this function for international dates.
        * @param {Number} month A zero-based JavaScript month number.
        * @return {String} The short month name.
        */
        getShortMonthName: function (month) {
            return Mini2.Date.monthNames[month].substring(0, 3);
        },
        //</locale>

        //<locale type="function">
        /**
        * Get the short day name for the given day number.
        * Override this function for international dates.
        * @param {Number} day A zero-based JavaScript day number.
        * @return {String} The short day name.
        */
        getShortDayName: function (day) {
            return Mini2.Date.dayNames[day].substring(0, 3);
        },
        //</locale>

        //<locale type="function">
        /**
        * Get the zero-based JavaScript month number for the given short/full month name.
        * Override this function for international dates.
        * @param {String} name The short/full month name.
        * @return {Number} The zero-based JavaScript month number.
        */
        getMonthNumber: function (name) {
            // handle camel casing for English month names (since the keys for the Mini2.Date.monthNumbers hash are case sensitive)
            return Mini2.Date.monthNumbers[name.substring(0, 1).toUpperCase() + name.substring(1, 3).toLowerCase()];
        },
        //</locale>

        /**
        * Checks if the specified format contains hour information
        * @param {String} format The format to check
        * @return {Boolean} True if the format contains hour information
        * @method
        */
        formatContainsHourInfo: function (format) {
            return hourInfoRe.test(format.replace(stripEscapeRe, ''));
        },

        /**
        * Checks if the specified format contains information about
        * anything other than the time.
        * @param {String} format The format to check
        * @return {Boolean} True if the format contains information about
        * date/day information.
        * @method
        */
        formatContainsDateInfo: function (format) {
            return dateInfoRe.test(format.replace(stripEscapeRe, ''));
        },

        /**
        * Removes all escaping for a date format string. In date formats,
        * using a '\' can be used to escape special characters.
        * @param {String} format The format to unescape
        * @return {String} The unescaped format
        * @method
        */
        unescapeFormat: function (format) {
            // Escape the format, since \ can be used to escape special
            // characters in a date format. For example, in a Spanish
            // locale the format may be: 'd \\de F \\de Y'
            return format.replace(slashRe, '');
        },

        /**
        * The base format-code to formatting-function hashmap used by the {@link #format} method.
        * Formatting functions are strings (or functions which return strings) which
        * will return the appropriate value when evaluated in the context of the Date object
        * from which the {@link #format} method is called.
        * Add to / override these mappings for custom date formatting.
        *
        * __Note:__ Mini2.Date.format() treats characters as literals if an appropriate mapping cannot be found.
        *
        * Example:
        *
        *     Mini2.Date.formatCodes.x = "Mini2.util.Format.leftPad(this.getDate(), 2, '0')";
        *     console.log(Mini2.Date.format(new Date(), 'X'); // returns the current day of the month
        * @type Object
        */
        formatCodes: {
            d: "Mini2.String.leftPad(this.getDate(), 2, '0')",
            D: "Mini2.Date.getShortDayName(this.getDay())", // get localized short day name
            j: "this.getDate()",
            l: "Mini2.Date.dayNames[this.getDay()]",
            N: "(this.getDay() ? this.getDay() : 7)",
            S: "Mini2.Date.getSuffix(this)",
            w: "this.getDay()",
            z: "Mini2.Date.getDayOfYear(this)",
            W: "Mini2.String.leftPad(Mini2.Date.getWeekOfYear(this), 2, '0')",
            F: "Mini2.Date.monthNames[this.getMonth()]",
            m: "Mini2.String.leftPad(this.getMonth() + 1, 2, '0')",
            M: "Mini2.Date.getShortMonthName(this.getMonth())", // get localized short month name
            n: "(this.getMonth() + 1)",
            t: "Mini2.Date.getDaysInMonth(this)",
            L: "(Mini2.Date.isLeapYear(this) ? 1 : 0)",
            o: "(this.getFullYear() + (Mini2.Date.getWeekOfYear(this) == 1 && this.getMonth() > 0 ? +1 : (Mini2.Date.getWeekOfYear(this) >= 52 && this.getMonth() < 11 ? -1 : 0)))",
            Y: "Mini2.String.leftPad(this.getFullYear(), 4, '0')",
            y: "('' + this.getFullYear()).substring(2, 4)",
            a: "(this.getHours() < 12 ? 'am' : 'pm')",
            A: "(this.getHours() < 12 ? 'AM' : 'PM')",
            g: "((this.getHours() % 12) ? this.getHours() % 12 : 12)",
            G: "this.getHours()",
            h: "Mini2.String.leftPad((this.getHours() % 12) ? this.getHours() % 12 : 12, 2, '0')",
            H: "Mini2.String.leftPad(this.getHours(), 2, '0')",
            i: "Mini2.String.leftPad(this.getMinutes(), 2, '0')",
            s: "Mini2.String.leftPad(this.getSeconds(), 2, '0')",
            u: "Mini2.String.leftPad(this.getMilliseconds(), 3, '0')",
            O: "Mini2.Date.getGMTOffset(this)",
            P: "Mini2.Date.getGMTOffset(this, true)",
            T: "Mini2.Date.getTimezone(this)",
            Z: "(this.getTimezoneOffset() * -60)",

            c: function () { // ISO-8601 -- GMT format
                var c, code, i, l, e;
                for (c = "Y-m-dTH:i:sP", code = [], i = 0, l = c.length; i < l; ++i) {
                    e = c.charAt(i);
                    code.push(e == "T" ? "'T'" : utilDate.getFormatCode(e)); // treat T as a character literal
                }
                return code.join(" + ");
            },
            /*
            c: function() { // ISO-8601 -- UTC format
            return [
            "this.getUTCFullYear()", "'-'",
            "Mini2.util.Format.leftPad(this.getUTCMonth() + 1, 2, '0')", "'-'",
            "Mini2.util.Format.leftPad(this.getUTCDate(), 2, '0')",
            "'T'",
            "Mini2.util.Format.leftPad(this.getUTCHours(), 2, '0')", "':'",
            "Mini2.util.Format.leftPad(this.getUTCMinutes(), 2, '0')", "':'",
            "Mini2.util.Format.leftPad(this.getUTCSeconds(), 2, '0')",
            "'Z'"
            ].join(" + ");
            },
            */

            U: "Math.round(this.getTime() / 1000)"
        },

        /**
        * Checks if the passed Date parameters will cause a JavaScript Date "rollover".
        * @param {Number} year 4-digit year
        * @param {Number} month 1-based month-of-year
        * @param {Number} day Day of month
        * @param {Number} hour (optional) Hour
        * @param {Number} minute (optional) Minute
        * @param {Number} second (optional) Second
        * @param {Number} millisecond (optional) Millisecond
        * @return {Boolean} `true` if the passed parameters do not cause a Date "rollover", `false` otherwise.
        */
        isValid: function (y, m, d, h, i, s, ms) {
            // setup defaults
            h = h || 0;
            i = i || 0;
            s = s || 0;
            ms = ms || 0;

            // Special handling for year < 100
            var dt = utilDate.add(new Date(y < 100 ? 100 : y, m - 1, d, h, i, s, ms), utilDate.YEAR, y < 100 ? y - 100 : 0);

            return y == dt.getFullYear() &&
            m == dt.getMonth() + 1 &&
            d == dt.getDate() &&
            h == dt.getHours() &&
            i == dt.getMinutes() &&
            s == dt.getSeconds() &&
            ms == dt.getMilliseconds();
        },

        /**
        * Parses the passed string using the specified date format.
        * Note that this function expects normal calendar dates, meaning that months are 1-based (i.e. 1 = January).
        * The {@link #defaults} hash will be used for any date value (i.e. year, month, day, hour, minute, second or millisecond)
        * which cannot be found in the passed string. If a corresponding default date value has not been specified in the {@link #defaults} hash,
        * the current date's year, month, day or DST-adjusted zero-hour time value will be used instead.
        * Keep in mind that the input date string must precisely match the specified format string
        * in order for the parse operation to be successful (failed parse operations return a null value).
        * 
        * Example:
        *
        *     //dt = Fri May 25 2007 (current date)
        *     var dt = new Date();
        *     
        *     //dt = Thu May 25 2006 (today&#39;s month/day in 2006)
        *     dt = Mini2.Date.parse("2006", "Y");
        *     
        *     //dt = Sun Jan 15 2006 (all date parts specified)
        *     dt = Mini2.Date.parse("2006-01-15", "Y-m-d");
        *     
        *     //dt = Sun Jan 15 2006 15:20:01
        *     dt = Mini2.Date.parse("2006-01-15 3:20:01 PM", "Y-m-d g:i:s A");
        *     
        *     // attempt to parse Sun Feb 29 2006 03:20:01 in strict mode
        *     dt = Mini2.Date.parse("2006-02-29 03:20:01", "Y-m-d H:i:s", true); // returns null
        *
        * @param {String} input The raw date string.
        * @param {String} format The expected date string format.
        * @param {Boolean} [strict=false] (optional) `true` to validate date strings while parsing (i.e. prevents JavaScript Date "rollover").
        * Invalid date strings will return `null` when parsed.
        * @return {Date} The parsed Date.
        */
        parse: function (input, format, strict) {
            var p = utilDate.parseFunctions;
            if (p[format] == null) {
                utilDate.createParser(format);
            }
            return p[format].call(utilDate, input, Mini2.isDefined(strict) ? strict : utilDate.useStrict);
        },

        // Backwards compat
        parseDate: function (input, format, strict) {
            return utilDate.parse(input, format, strict);
        },


        // private
        getFormatCode: function (character) {
            var f = utilDate.formatCodes[character];

            if (f) {
                f = typeof f == 'function' ? f() : f;
                utilDate.formatCodes[character] = f; // reassign function result to prevent repeated execution
            }

            // note: unknown characters are treated as literals
            return f || ("'" + Mini2.String.escape(character) + "'");
        },

        // private
        createFormat: function (format) {
            var code = [],
            special = false,
            ch = '',
            i;

            for (i = 0; i < format.length; ++i) {
                ch = format.charAt(i);
                if (!special && ch == "\\") {
                    special = true;
                } else if (special) {
                    special = false;
                    code.push("'" + Mini2.String.escape(ch) + "'");
                } else {
                    code.push(utilDate.getFormatCode(ch));
                }
            }
            utilDate.formatFunctions[format] = Mini2.functionFactory("return " + code.join('+'));
        },

        // private
        createParser: function (format) {
            var regexNum = utilDate.parseRegexes.length,
            currentGroup = 1,
            calc = [],
            regex = [],
            special = false,
            ch = "",
            i = 0,
            len = format.length,
            atEnd = [],
            obj;

            for (; i < len; ++i) {
                ch = format.charAt(i);
                if (!special && ch == "\\") {
                    special = true;
                } else if (special) {
                    special = false;
                    regex.push(Mini2.String.escape(ch));
                } else {
                    obj = utilDate.formatCodeToRegex(ch, currentGroup);
                    currentGroup += obj.g;
                    regex.push(obj.s);
                    if (obj.g && obj.c) {
                        if (obj.calcAtEnd) {
                            atEnd.push(obj.c);
                        } else {
                            calc.push(obj.c);
                        }
                    }
                }
            }

            calc = calc.concat(atEnd);

            utilDate.parseRegexes[regexNum] = new RegExp("^" + regex.join('') + "$", 'i');
            utilDate.parseFunctions[format] = Mini2.functionFactory("input", "strict", xf(code, regexNum, calc.join('')));
        },

        // private
        parseCodes: {
            /*
            * Notes:
            * g = {Number} calculation group (0 or 1. only group 1 contributes to date calculations.)
            * c = {String} calculation method (required for group 1. null for group 0. {0} = currentGroup - position in regex result array)
            * s = {String} regex pattern. all matches are stored in results[], and are accessible by the calculation mapped to 'c'
            */
            d: {
                g: 1,
                c: "d = parseInt(results[{0}], 10);\n",
                s: "(3[0-1]|[1-2][0-9]|0[1-9])" // day of month with leading zeroes (01 - 31)
            },
            j: {
                g: 1,
                c: "d = parseInt(results[{0}], 10);\n",
                s: "(3[0-1]|[1-2][0-9]|[1-9])" // day of month without leading zeroes (1 - 31)
            },
            D: function () {
                for (var a = [], i = 0; i < 7; a.push(utilDate.getShortDayName(i)), ++i); // get localised short day names
                return {
                    g: 0,
                    c: null,
                    s: "(?:" + a.join("|") + ")"
                };
            },
            l: function () {
                return {
                    g: 0,
                    c: null,
                    s: "(?:" + utilDate.dayNames.join("|") + ")"
                };
            },
            N: {
                g: 0,
                c: null,
                s: "[1-7]" // ISO-8601 day number (1 (monday) - 7 (sunday))
            },
            //<locale type="object" property="parseCodes">
            S: {
                g: 0,
                c: null,
                s: "(?:st|nd|rd|th)"
            },
            //</locale>
            w: {
                g: 0,
                c: null,
                s: "[0-6]" // JavaScript day number (0 (sunday) - 6 (saturday))
            },
            z: {
                g: 1,
                c: "z = parseInt(results[{0}], 10);\n",
                s: "(\\d{1,3})" // day of the year (0 - 364 (365 in leap years))
            },
            W: {
                g: 1,
                c: "W = parseInt(results[{0}], 10);\n",
                s: "(\\d{2})" // ISO-8601 week number (with leading zero)
            },
            F: function () {
                return {
                    g: 1,
                    c: "m = parseInt(me.getMonthNumber(results[{0}]), 10);\n", // get localised month number
                    s: "(" + utilDate.monthNames.join("|") + ")"
                };
            },
            M: function () {
                for (var a = [], i = 0; i < 12; a.push(utilDate.getShortMonthName(i)), ++i); // get localised short month names
                return Mini2.applyIf({
                    s: "(" + a.join("|") + ")"
                }, utilDate.formatCodeToRegex("F"));
            },
            m: {
                g: 1,
                c: "m = parseInt(results[{0}], 10) - 1;\n",
                s: "(1[0-2]|0[1-9])" // month number with leading zeros (01 - 12)
            },
            n: {
                g: 1,
                c: "m = parseInt(results[{0}], 10) - 1;\n",
                s: "(1[0-2]|[1-9])" // month number without leading zeros (1 - 12)
            },
            t: {
                g: 0,
                c: null,
                s: "(?:\\d{2})" // no. of days in the month (28 - 31)
            },
            L: {
                g: 0,
                c: null,
                s: "(?:1|0)"
            },
            o: {
                g: 1,
                c: "y = parseInt(results[{0}], 10);\n",
                s: "(\\d{4})" // ISO-8601 year number (with leading zero)

            },
            Y: {
                g: 1,
                c: "y = parseInt(results[{0}], 10);\n",
                s: "(\\d{4})" // 4-digit year
            },
            y: {
                g: 1,
                c: "var ty = parseInt(results[{0}], 10);\n"
                + "y = ty > me.y2kYear ? 1900 + ty : 2000 + ty;\n", // 2-digit year
                s: "(\\d{1,2})"
            },
            /*
            * In the am/pm parsing routines, we allow both upper and lower case
            * even though it doesn't exactly match the spec. It gives much more flexibility
            * in being able to specify case insensitive regexes.
            */
            //<locale type="object" property="parseCodes">
            a: {
                g: 1,
                c: "if (/(am)/i.test(results[{0}])) {\n"
                + "if (!h || h == 12) { h = 0; }\n"
                + "} else { if (!h || h < 12) { h = (h || 0) + 12; }}",
                s: "(am|pm|AM|PM)",
                calcAtEnd: true
            },
            //</locale>
            //<locale type="object" property="parseCodes">
            A: {
                g: 1,
                c: "if (/(am)/i.test(results[{0}])) {\n"
                + "if (!h || h == 12) { h = 0; }\n"
                + "} else { if (!h || h < 12) { h = (h || 0) + 12; }}",
                s: "(AM|PM|am|pm)",
                calcAtEnd: true
            },
            //</locale>
            g: {
                g: 1,
                c: "h = parseInt(results[{0}], 10);\n",
                s: "(1[0-2]|[0-9])" //  12-hr format of an hour without leading zeroes (1 - 12)
            },
            G: {
                g: 1,
                c: "h = parseInt(results[{0}], 10);\n",
                s: "(2[0-3]|1[0-9]|[0-9])" // 24-hr format of an hour without leading zeroes (0 - 23)
            },
            h: {
                g: 1,
                c: "h = parseInt(results[{0}], 10);\n",
                s: "(1[0-2]|0[1-9])" //  12-hr format of an hour with leading zeroes (01 - 12)
            },
            H: {
                g: 1,
                c: "h = parseInt(results[{0}], 10);\n",
                s: "(2[0-3]|[0-1][0-9])" //  24-hr format of an hour with leading zeroes (00 - 23)
            },
            i: {
                g: 1,
                c: "i = parseInt(results[{0}], 10);\n",
                s: "([0-5][0-9])" // minutes with leading zeros (00 - 59)
            },
            s: {
                g: 1,
                c: "s = parseInt(results[{0}], 10);\n",
                s: "([0-5][0-9])" // seconds with leading zeros (00 - 59)
            },
            u: {
                g: 1,
                c: "ms = results[{0}]; ms = parseInt(ms, 10)/Math.pow(10, ms.length - 3);\n",
                s: "(\\d+)" // decimal fraction of a second (minimum = 1 digit, maximum = unlimited)
            },
            O: {
                g: 1,
                c: [
                "o = results[{0}];",
                "var sn = o.substring(0,1),", // get + / - sign
                    "hr = o.substring(1,3)*1 + Math.floor(o.substring(3,5) / 60),", // get hours (performs minutes-to-hour conversion also, just in case)
                    "mn = o.substring(3,5) % 60;", // get minutes
                "o = ((-12 <= (hr*60 + mn)/60) && ((hr*60 + mn)/60 <= 14))? (sn + Mini2.String.leftPad(hr, 2, '0') + Mini2.String.leftPad(mn, 2, '0')) : null;\n" // -12hrs <= GMT offset <= 14hrs
            ].join("\n"),
                s: "([+-]\\d{4})" // GMT offset in hrs and mins
            },
            P: {
                g: 1,
                c: [
                "o = results[{0}];",
                "var sn = o.substring(0,1),", // get + / - sign
                    "hr = o.substring(1,3)*1 + Math.floor(o.substring(4,6) / 60),", // get hours (performs minutes-to-hour conversion also, just in case)
                    "mn = o.substring(4,6) % 60;", // get minutes
                "o = ((-12 <= (hr*60 + mn)/60) && ((hr*60 + mn)/60 <= 14))? (sn + Mini2.String.leftPad(hr, 2, '0') + Mini2.String.leftPad(mn, 2, '0')) : null;\n" // -12hrs <= GMT offset <= 14hrs
            ].join("\n"),
                s: "([+-]\\d{2}:\\d{2})" // GMT offset in hrs and mins (with colon separator)
            },
            T: {
                g: 0,
                c: null,
                s: "[A-Z]{1,5}" // timezone abbrev. may be between 1 - 5 chars
            },
            Z: {
                g: 1,
                c: "zz = results[{0}] * 1;\n" // -43200 <= UTC offset <= 50400
                  + "zz = (-43200 <= zz && zz <= 50400)? zz : null;\n",
                s: "([+-]?\\d{1,5})" // leading '+' sign is optional for UTC offset
            },
            c: function () {
                var calc = [],
                arr = [
                    utilDate.formatCodeToRegex("Y", 1), // year
                    utilDate.formatCodeToRegex("m", 2), // month
                    utilDate.formatCodeToRegex("d", 3), // day
                    utilDate.formatCodeToRegex("H", 4), // hour
                    utilDate.formatCodeToRegex("i", 5), // minute
                    utilDate.formatCodeToRegex("s", 6), // second
                    {c: "ms = results[7] || '0'; ms = parseInt(ms, 10)/Math.pow(10, ms.length - 3);\n" }, // decimal fraction of a second (minimum = 1 digit, maximum = unlimited)
                    {c: [ // allow either "Z" (i.e. UTC) or "-0530" or "+08:00" (i.e. UTC offset) timezone delimiters. assumes local timezone if no timezone is specified
                        "if(results[8]) {", // timezone specified
                            "if(results[8] == 'Z'){",
                                "zz = 0;", // UTC
                            "}else if (results[8].indexOf(':') > -1){",
                                utilDate.formatCodeToRegex("P", 8).c, // timezone offset with colon separator
                            "}else{",
                                utilDate.formatCodeToRegex("O", 8).c, // timezone offset without colon separator
                            "}",
                        "}"
                    ].join('\n')
                }
                ],
                i,
                l;

                for (i = 0, l = arr.length; i < l; ++i) {
                    calc.push(arr[i].c);
                }

                return {
                    g: 1,
                    c: calc.join(""),
                    s: [
                    arr[0].s, // year (required)
                    "(?:", "-", arr[1].s, // month (optional)
                        "(?:", "-", arr[2].s, // day (optional)
                            "(?:",
                                "(?:T| )?", // time delimiter -- either a "T" or a single blank space
                                arr[3].s, ":", arr[4].s,  // hour AND minute, delimited by a single colon (optional). MUST be preceded by either a "T" or a single blank space
                                "(?::", arr[5].s, ")?", // seconds (optional)
                                "(?:(?:\\.|,)(\\d+))?", // decimal fraction of a second (e.g. ",12345" or ".98765") (optional)
                                "(Z|(?:[-+]\\d{2}(?::)?\\d{2}))?", // "Z" (UTC) or "-0530" (UTC offset without colon delimiter) or "+08:00" (UTC offset with colon delimiter) (optional)
                            ")?",
                        ")?",
                    ")?"
                ].join("")
                };
            },
            U: {
                g: 1,
                c: "u = parseInt(results[{0}], 10);\n",
                s: "(-?\\d+)" // leading minus sign indicates seconds before UNIX epoch
            }
        },

        //Old Mini2.Date prototype methods.
        // private
        dateFormat: function (date, format) {
            return utilDate.format(date, format);
        },

        /**
        * Compares if two dates are equal by comparing their values.
        * @param {Date} date1
        * @param {Date} date2
        * @return {Boolean} `true` if the date values are equal
        */
        isEqual: function (date1, date2) {
            // check we have 2 date objects
            if (date1 && date2) {
                return (date1.getTime() === date2.getTime());
            }
            // one or both isn't a date, only equal if both are falsey
            return !(date1 || date2);
        },

        /**
        * Formats a date given the supplied format string.
        * @param {Date} date The date to format
        * @param {String} format The format string
        * @return {String} The formatted date or an empty string if date parameter is not a JavaScript Date object
        */
        format: function (date, format) {
            var formatFunctions = utilDate.formatFunctions;


            if (!Mini2.isDate(date)) {
                return '';
            }

            if (formatFunctions[format] == null) {
                utilDate.createFormat(format);
            }
            return formatFunctions[format].call(date) + '';
        },

        /**
        * Get the timezone abbreviation of the current date (equivalent to the format specifier 'T').
        *
        * __Note:__ The date string returned by the JavaScript Date object's `toString()` method varies
        * between browsers (e.g. FF vs IE) and system region settings (e.g. IE in Asia vs IE in America).
        * For a given date string e.g. "Thu Oct 25 2007 22:55:35 GMT+0800 (Malay Peninsula Standard Time)",
        * getTimezone() first tries to get the timezone abbreviation from between a pair of parentheses
        * (which may or may not be present), failing which it proceeds to get the timezone abbreviation
        * from the GMT offset portion of the date string.
        * @param {Date} date The date
        * @return {String} The abbreviated timezone name (e.g. 'CST', 'PDT', 'EDT', 'MPST' ...).
        */
        getTimezone: function (date) {
            // the following list shows the differences between date strings from different browsers on a WinXP SP2 machine from an Asian locale:
            //
            // Opera  : "Thu, 25 Oct 2007 22:53:45 GMT+0800" -- shortest (weirdest) date string of the lot
            // Safari : "Thu Oct 25 2007 22:55:35 GMT+0800 (Malay Peninsula Standard Time)" -- value in parentheses always gives the correct timezone (same as FF)
            // FF     : "Thu Oct 25 2007 22:55:35 GMT+0800 (Malay Peninsula Standard Time)" -- value in parentheses always gives the correct timezone
            // IE     : "Thu Oct 25 22:54:35 UTC+0800 2007" -- (Asian system setting) look for 3-4 letter timezone abbrev
            // IE     : "Thu Oct 25 17:06:37 PDT 2007" -- (American system setting) look for 3-4 letter timezone abbrev
            //
            // this crazy regex attempts to guess the correct timezone abbreviation despite these differences.
            // step 1: (?:\((.*)\) -- find timezone in parentheses
            // step 2: ([A-Z]{1,4})(?:[\-+][0-9]{4})?(?: -?\d+)?) -- if nothing was found in step 1, find timezone from timezone offset portion of date string
            // step 3: remove all non uppercase characters found in step 1 and 2
            return date.toString().replace(/^.* (?:\((.*)\)|([A-Z]{1,5})(?:[\-+][0-9]{4})?(?: -?\d+)?)$/, "$1$2").replace(/[^A-Z]/g, "");
        },

        /**
        * Get the offset from GMT of the current date (equivalent to the format specifier 'O').
        * @param {Date} date The date
        * @param {Boolean} [colon=false] (optional) true to separate the hours and minutes with a colon.
        * @return {String} The 4-character offset string prefixed with + or - (e.g. '-0600').
        */
        getGMTOffset: function (date, colon) {
            var offset = date.getTimezoneOffset();
            return (offset > 0 ? "-" : "+")
            + Mini2.String.leftPad(Math.floor(Math.abs(offset) / 60), 2, "0")
            + (colon ? ":" : "")
            + Mini2.String.leftPad(Math.abs(offset % 60), 2, "0");
        },

        /**
        * Get the numeric day number of the year, adjusted for leap year.
        * @param {Date} date The date
        * @return {Number} 0 to 364 (365 in leap years).
        */
        getDayOfYear: function (date) {
            var num = 0,
            d = Mini2.Date.clone(date),
            m = date.getMonth(),
            i;

            for (i = 0, d.setDate(1), d.setMonth(0); i < m; d.setMonth(++i)) {
                num += utilDate.getDaysInMonth(d);
            }
            return num + date.getDate() - 1;
        },

        /**
        * Get the numeric ISO-8601 week number of the year.
        * (equivalent to the format specifier 'W', but without a leading zero).
        * @param {Date} date The date
        * @return {Number} 1 to 53
        * @method
        */
        getWeekOfYear: (function () {
            // adapted from http://www.merlyn.demon.co.uk/weekcalc.htm
            var ms1d = 864e5, // milliseconds in a day
            ms7d = 7 * ms1d; // milliseconds in a week

            return function (date) { // return a closure so constants get calculated only once
                var DC3 = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate() + 3) / ms1d, // an Absolute Day Number
                AWN = Math.floor(DC3 / 7), // an Absolute Week Number
                Wyr = new Date(AWN * ms7d).getUTCFullYear();

                return AWN - Math.floor(Date.UTC(Wyr, 0, 7) / ms7d) + 1;
            };
        } ()),

        /**
        * Checks if the current date falls within a leap year.
        * @param {Date} date The date
        * @return {Boolean} True if the current date falls within a leap year, false otherwise.
        */
        isLeapYear: function (date) {
            var year = date.getFullYear();
            return !!((year & 3) == 0 && (year % 100 || (year % 400 == 0 && year)));
        },

        /**
        * Get the first day of the current month, adjusted for leap year.  The returned value
        * is the numeric day index within the week (0-6) which can be used in conjunction with
        * the {@link #monthNames} array to retrieve the textual day name.
        *
        * Example:
        *
        *     var dt = new Date('1/10/2007'),
        *         firstDay = Mini2.Date.getFirstDayOfMonth(dt);
        *     console.log(Mini2.Date.dayNames[firstDay]); // output: 'Monday'
        *
        * @param {Date} date The date
        * @return {Number} The day number (0-6).
        */
        getFirstDayOfMonth: function (date) {
            var day = (date.getDay() - (date.getDate() - 1)) % 7;
            return (day < 0) ? (day + 7) : day;
        },

        /**
        * Get the last day of the current month, adjusted for leap year.  The returned value
        * is the numeric day index within the week (0-6) which can be used in conjunction with
        * the {@link #monthNames} array to retrieve the textual day name.
        *
        * Example:
        *
        *     var dt = new Date('1/10/2007'),
        *         lastDay = Mini2.Date.getLastDayOfMonth(dt);
        *     console.log(Mini2.Date.dayNames[lastDay]); // output: 'Wednesday'
        *
        * @param {Date} date The date
        * @return {Number} The day number (0-6).
        */
        getLastDayOfMonth: function (date) {
            return utilDate.getLastDateOfMonth(date).getDay();
        },


        /**
        * Get the date of the first day of the month in which this date resides.
        * @param {Date} date The date
        * @return {Date}
        */
        getFirstDateOfMonth: function (date) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        },

        /**
        * Get the date of the last day of the month in which this date resides.
        * @param {Date} date The date
        * @return {Date}
        */
        getLastDateOfMonth: function (date) {
            return new Date(date.getFullYear(), date.getMonth(), utilDate.getDaysInMonth(date));
        },

        /**
        * Get the number of days in the current month, adjusted for leap year.
        * @param {Date} date The date
        * @return {Number} The number of days in the month.
        * @method
        */
        getDaysInMonth: (function () {
            var daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

            return function (date) { // return a closure for efficiency
                var m = date.getMonth();

                return m == 1 && utilDate.isLeapYear(date) ? 29 : daysInMonth[m];
            };
        } ()),

        //<locale type="function">
        /**
        * Get the English ordinal suffix of the current day (equivalent to the format specifier 'S').
        * @param {Date} date The date
        * @return {String} 'st, 'nd', 'rd' or 'th'.
        */
        getSuffix: function (date) {
            switch (date.getDate()) {
                case 1:
                case 21:
                case 31:
                    return "st";
                case 2:
                case 22:
                    return "nd";
                case 3:
                case 23:
                    return "rd";
                default:
                    return "th";
            }
        },
        //</locale>

        /**
        * Creates and returns a new Date instance with the exact same date value as the called instance.
        * Dates are copied and passed by reference, so if a copied date variable is modified later, the original
        * variable will also be changed.  When the intention is to create a new variable that will not
        * modify the original instance, you should create a clone.
        *
        * Example of correctly cloning a date:
        *
        *     //wrong way:
        *     var orig = new Date('10/1/2006');
        *     var copy = orig;
        *     copy.setDate(5);
        *     console.log(orig);  // returns 'Thu Oct 05 2006'!
        *
        *     //correct way:
        *     var orig = new Date('10/1/2006'),
        *         copy = Mini2.Date.clone(orig);
        *     copy.setDate(5);
        *     console.log(orig);  // returns 'Thu Oct 01 2006'
        *
        * @param {Date} date The date.
        * @return {Date} The new Date instance.
        */
        clone: function (date) {
            return new Date(date.getTime());
        },

        /**
        * Checks if the current date is affected by Daylight Saving Time (DST).
        * @param {Date} date The date
        * @return {Boolean} `true` if the current date is affected by DST.
        */
        isDST: function (date) {
            // adapted from http://sencha.com/forum/showthread.php?p=247172#post247172
            // courtesy of @geoffrey.mcgill
            return new Date(date.getFullYear(), 0, 1).getTimezoneOffset() != date.getTimezoneOffset();
        },

        /**
        * Attempts to clear all time information from this Date by setting the time to midnight of the same day,
        * automatically adjusting for Daylight Saving Time (DST) where applicable.
        *
        * __Note:__ DST timezone information for the browser's host operating system is assumed to be up-to-date.
        * @param {Date} date The date
        * @param {Boolean} [clone=false] `true` to create a clone of this date, clear the time and return it.
        * @return {Date} this or the clone.
        */
        clearTime: function (date, clone) {
            if (clone) {
                return Mini2.Date.clearTime(Mini2.Date.clone(date));
            }

            // get current date before clearing time
            var d = date.getDate(),
            hr,
            c;

            // clear time
            date.setHours(0);
            date.setMinutes(0);
            date.setSeconds(0);
            date.setMilliseconds(0);

            if (date.getDate() != d) { // account for DST (i.e. day of month changed when setting hour = 0)
                // note: DST adjustments are assumed to occur in multiples of 1 hour (this is almost always the case)
                // refer to http://www.timeanddate.com/time/aboutdst.html for the (rare) exceptions to this rule

                // increment hour until cloned date == current date
                for (hr = 1, c = utilDate.add(date, Mini2.Date.HOUR, hr); c.getDate() != d; hr++, c = utilDate.add(date, Mini2.Date.HOUR, hr));

                date.setDate(d);
                date.setHours(c.getHours());
            }

            return date;
        },

        /**
        * Provides a convenient method for performing basic date arithmetic. This method
        * does not modify the Date instance being called - it creates and returns
        * a new Date instance containing the resulting date value.
        *
        * Examples:
        *
        *     // Basic usage:
        *     var dt = Mini2.Date.add(new Date('10/29/2006'), Mini2.Date.DAY, 5);
        *     console.log(dt); // returns 'Fri Nov 03 2006 00:00:00'
        *
        *     // Negative values will be subtracted:
        *     var dt2 = Mini2.Date.add(new Date('10/1/2006'), Mini2.Date.DAY, -5);
        *     console.log(dt2); // returns 'Tue Sep 26 2006 00:00:00'
        *
        *      // Decimal values can be used:
        *     var dt3 = Mini2.Date.add(new Date('10/1/2006'), Mini2.Date.DAY, 1.25);
        *     console.log(dt3); // returns 'Mon Oct 02 2006 06:00:00'
        *
        * @param {Date} date The date to modify
        * @param {String} interval A valid date interval enum value.
        * @param {Number} value The amount to add to the current date.
        * @return {Date} The new Date instance.
        */
        add: function (date, interval, value) {
            var d = Mini2.Date.clone(date),
            Date = Mini2.Date,
            day, decimalValue, base = 0;
            if (!interval || value === 0) {
                return d;
            }

            decimalValue = value - parseInt(value, 10);
            value = parseInt(value, 10);

            if (value) {
                switch (interval.toLowerCase()) {
                    // See EXTJSIV-7418. We use setTime() here to deal with issues related to       
                    // the switchover that occurs when changing to daylight savings and vice       
                    // versa. setTime() handles this correctly where setHour/Minute/Second/Millisecond       
                    // do not. Let's assume the DST change occurs at 2am and we're incrementing using add       
                    // for 15 minutes at time. When entering DST, we should see:       
                    // 01:30am       
                    // 01:45am       
                    // 03:00am // skip 2am because the hour does not exist       
                    // ...       
                    // Similarly, leaving DST, we should see:       
                    // 01:30am       
                    // 01:45am       
                    // 01:00am // repeat 1am because that's the change over       
                    // 01:30am       
                    // 01:45am       
                    // 02:00am       
                    // ....       
                    //        
                    case Mini2.Date.MILLI:
                        d.setTime(d.getTime() + value);
                        break;
                    case Mini2.Date.SECOND:
                        d.setTime(d.getTime() + value * 1000);
                        break;
                    case Mini2.Date.MINUTE:
                        d.setTime(d.getTime() + value * 60 * 1000);
                        break;
                    case Mini2.Date.HOUR:
                        d.setTime(d.getTime() + value * 60 * 60 * 1000);
                        break;
                    case Mini2.Date.DAY:
                        d.setDate(d.getDate() + value);
                        break;
                    case Mini2.Date.MONTH:
                        day = date.getDate();
                        if (day > 28) {
                            day = Math.min(day, Mini2.Date.getLastDateOfMonth(Mini2.Date.add(Mini2.Date.getFirstDateOfMonth(date), Mini2.Date.MONTH, value)).getDate());
                        }
                        d.setDate(day);
                        d.setMonth(date.getMonth() + value);
                        break;
                    case Mini2.Date.YEAR:
                        day = date.getDate();
                        if (day > 28) {
                            day = Math.min(day, Mini2.Date.getLastDateOfMonth(Mini2.Date.add(Mini2.Date.getFirstDateOfMonth(date), Mini2.Date.YEAR, value)).getDate());
                        }
                        d.setDate(day);
                        d.setFullYear(date.getFullYear() + value);
                        break;
                }
            }

            if (decimalValue) {
                switch (interval.toLowerCase()) {
                    case Mini2.Date.MILLI: base = 1; break;
                    case Mini2.Date.SECOND: base = 1000; break;
                    case Mini2.Date.MINUTE: base = 1000 * 60; break;
                    case Mini2.Date.HOUR: base = 1000 * 60 * 60; break;
                    case Mini2.Date.DAY: base = 1000 * 60 * 60 * 24; break;

                    case Mini2.Date.MONTH:
                        day = utilDate.getDaysInMonth(d);
                        base = 1000 * 60 * 60 * 24 * day;
                        break;

                    case Mini2.Date.YEAR:
                        day = (utilDate.isLeapYear(d) ? 366 : 365);
                        base = 1000 * 60 * 60 * 24 * day;
                        break;
                }
                if (base) {
                    d.setTime(d.getTime() + base * decimalValue);
                }
            }

            return d;
        },

        /**
        * Provides a convenient method for performing basic date arithmetic. This method
        * does not modify the Date instance being called - it creates and returns
        * a new Date instance containing the resulting date value.
        * 
        * Examples:
        *
        *     // Basic usage:
        *     var dt = Mini2.Date.subtract(new Date('10/29/2006'), Mini2.Date.DAY, 5);
        *     console.log(dt); // returns 'Tue Oct 24 2006 00:00:00'
        *
        *     // Negative values will be added:
        *     var dt2 = Mini2.Date.subtract(new Date('10/1/2006'), Mini2.Date.DAY, -5);
        *     console.log(dt2); // returns 'Fri Oct 6 2006 00:00:00'
        *
        *      // Decimal values can be used:
        *     var dt3 = Mini2.Date.subtract(new Date('10/1/2006'), Mini2.Date.DAY, 1.25);
        *     console.log(dt3); // returns 'Fri Sep 29 2006 06:00:00'
        * 
        * @param {Date} date The date to modify
        * @param {String} interval A valid date interval enum value.
        * @param {Number} value The amount to subtract from the current date.
        * @return {Date} The new Date instance.
        */
        subtract: function (date, interval, value) {
            return utilDate.add(date, interval, -value);
        },

        /**
        * Checks if a date falls on or between the given start and end dates.
        * @param {Date} date The date to check
        * @param {Date} start Start date
        * @param {Date} end End date
        * @return {Boolean} `true` if this date falls on or between the given start and end dates.
        */
        between: function (date, start, end) {
            var t = date.getTime();
            return start.getTime() <= t && t <= end.getTime();
        },

        //Maintains compatibility with old static and prototype window.Date methods.
        compat: function () {
            var nativeDate = window.Date,
            p,
            statics = ['useStrict', 'formatCodeToRegex', 'parseFunctions', 'parseRegexes', 'formatFunctions', 'y2kYear', 'MILLI', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'MONTH', 'YEAR', 'defaults', 'dayNames', 'monthNames', 'monthNumbers', 'getShortMonthName', 'getShortDayName', 'getMonthNumber', 'formatCodes', 'isValid', 'parseDate', 'getFormatCode', 'createFormat', 'createParser', 'parseCodes'],
            proto = ['dateFormat', 'format', 'getTimezone', 'getGMTOffset', 'getDayOfYear', 'getWeekOfYear', 'isLeapYear', 'getFirstDayOfMonth', 'getLastDayOfMonth', 'getDaysInMonth', 'getSuffix', 'clone', 'isDST', 'clearTime', 'add', 'between'],
            sLen = statics.length,
            pLen = proto.length,
            stat, prot, s;

            //Append statics
            for (s = 0; s < sLen; s++) {
                stat = statics[s];
                nativeDate[stat] = utilDate[stat];
            }

            //Append to prototype
            for (p = 0; p < pLen; p++) {
                prot = proto[p];
                nativeDate.prototype[prot] = function () {
                    var args = Array.prototype.slice.call(arguments);
                    args.unshift(this);
                    return utilDate[prot].apply(utilDate, args);
                };
            }
        }
    });
};



/************************************************************************/
/*                                           */
/*    lang/String.js                                                       */
/*                                           */
/************************************************************************/


Mini2.String = (function () {
    "use strict";
    var trimRegex = /^[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000]+|[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000]+$/g,
        escapeRe = /('|\\)/g,
        formatRe = /\{(\d+)\}/g,
        escapeRegexRe = /([-.*+?\^${}()|\[\]\/\\])/g,
        basicTrimRe = /^\s+|\s+$/g,
        whitespaceRe = /\s+/,
        varReplace = /(^[^a-z]*|[^\w])/gi,
        charToEntity,
        entityToChar,
        charToEntityRegex,
        entityToCharRegex,
        htmlEncodeReplaceFn = function (match, capture) {
            return charToEntity[capture];
        },
        htmlDecodeReplaceFn = function (match, capture) {
            return (capture in entityToChar) ? entityToChar[capture] : String.fromCharCode(parseInt(capture.substr(2), 10));
        },
        boundsCheck = function (s, other) {
            if (s === null || s === undefined || other === null || other === undefined) {
                return false;
            }

            return other.length <= s.length;
        };

    return {


        /**
        * Inserts a substring into a string.
        * @param {String} s The original string.
        * @param {String} value The substring to insert.
        * @param {Number} index The index to insert the substring. Negative indexes will insert from the end of
        * the string. Example: 
        *
        *     Ext.String.insert("abcdefg", "h", -1); // abcdefhg
        *
        * @return {String} The value with the inserted substring
        */
        insert: function (s, value, index) {
            if (!s) {
                return value;
            }

            if (!value) {
                return s;
            }

            var len = s.length;

            if (!index && index !== 0) {
                index = len;
            }

            if (index < 0) {
                index *= -1;
                if (index >= len) {
                    // negative overflow, insert at start
                    index = 0;
                } else {
                    index = len - index;
                }
            }

            if (index === 0) {
                s = value + s;
            } else if (index >= s.length) {
                s += value;
            } else {
                s = s.substr(0, index) + value + s.substr(index);
            }
            return s;
        },

        /**
        * Checks if a string starts with a substring
        * @param {String} s The original string
        * @param {String} start The substring to check
        * @param {Boolean} [ignoreCase=false] True to ignore the case in the comparison
        */
        startsWith: function (s, start, ignoreCase) {
            var result = boundsCheck(s, start);

            if (result) {
                if (ignoreCase) {
                    s = s.toLowerCase();
                    start = start.toLowerCase();
                }
                result = s.lastIndexOf(start, 0) === 0;
            }
            return result;
        },

        /**
        * Checks if a string ends with a substring
        * @param {String} s The original string
        * @param {String} start The substring to check
        * @param {Boolean} [ignoreCase=false] True to ignore the case in the comparison
        */
        endsWith: function (s, end, ignoreCase) {
            var result = boundsCheck(s, end);

            if (result) {
                if (ignoreCase) {
                    s = s.toLowerCase();
                    end = end.toLowerCase();
                }
                result = s.indexOf(end, s.length - end.length) !== -1;
            }
            return result;
        },

        /**
        * Converts a string of characters into a legal, parse-able JavaScript `var` name as long as the passed
        * string contains at least one alphabetic character. Non alphanumeric characters, and *leading* non alphabetic
        * characters will be removed.
        * @param {String} s A string to be converted into a `var` name.
        * @return {String} A legal JavaScript `var` name.
        */
        createVarName: function (s) {
            return s.replace(varReplace, '');
        },

        /**
        * Convert certain characters (&, <, >, ', and ") to their HTML character equivalents for literal display in web pages.
        * @param {String} value The string to encode.
        * @return {String} The encoded text.
        * @method
        */
        htmlEncode: function (value) {
            return (!value) ? value : String(value).replace(charToEntityRegex, htmlEncodeReplaceFn);
        },

        /**
        * Convert certain characters (&, <, >, ', and ") from their HTML character equivalents.
        * @param {String} value The string to decode.
        * @return {String} The decoded text.
        * @method
        */
        htmlDecode: function (value) {
            return (!value) ? value : String(value).replace(entityToCharRegex, htmlDecodeReplaceFn);
        },

        /**
        * Adds a set of character entity definitions to the set used by
        * {@link Ext.String#htmlEncode} and {@link Ext.String#htmlDecode}.
        *
        * This object should be keyed by the entity name sequence,
        * with the value being the textual representation of the entity.
        *
        *      Ext.String.addCharacterEntities({
        *          '&amp;Uuml;':'Ü',
        *          '&amp;ccedil;':'ç',
        *          '&amp;ntilde;':'ñ',
        *          '&amp;egrave;':'è'
        *      });
        *      var s = Ext.String.htmlEncode("A string with entities: èÜçñ");
        *
        * __Note:__ the values of the character entities defined on this object are expected
        * to be single character values.  As such, the actual values represented by the
        * characters are sensitive to the character encoding of the JavaScript source
        * file when defined in string literal form. Script tags referencing server
        * resources with character entities must ensure that the 'charset' attribute
        * of the script node is consistent with the actual character encoding of the
        * server resource.
        *
        * The set of character entities may be reset back to the default state by using
        * the {@link Ext.String#resetCharacterEntities} method
        *
        * @param {Object} entities The set of character entities to add to the current
        * definitions.
        */
        addCharacterEntities: function (newEntities) {
            var charKeys = [],
                entityKeys = [],
                key, echar;
            for (key in newEntities) {
                echar = newEntities[key];
                entityToChar[key] = echar;
                charToEntity[echar] = key;
                charKeys.push(echar);
                entityKeys.push(key);
            }
            charToEntityRegex = new RegExp('(' + charKeys.join('|') + ')', 'g');
            entityToCharRegex = new RegExp('(' + entityKeys.join('|') + '|&#[0-9]{1,5};' + ')', 'g');
        },

        /**
        * Resets the set of character entity definitions used by
        * {@link Ext.String#htmlEncode} and {@link Ext.String#htmlDecode} back to the
        * default state.
        */
        resetCharacterEntities: function () {
            charToEntity = {};
            entityToChar = {};
            // add the default set
            this.addCharacterEntities({
                '&amp;': '&',
                '&gt;': '>',
                '&lt;': '<',
                '&quot;': '"',
                '&#39;': "'"
            });
        },

        /**
        * URL 地址附加内容到 QueryStering Appends content to the query string of a URL, handling logic for whether to place
        * a question mark or ampersand.
        * @param {String} url The URL to append to.
        * @param {String} string The content to append to the URL.
        * @param {bool} ignoreCache  忽略 cache , 默认 true
        * @return {String} The resulting URL
        */
        urlAppend: function (url, string, ignoreCache) {

            if (!Mini2.isEmpty(string)) {
                var n = 0,
                    newStr = '',
                    attrs = string, i;

                if (Mini2.typeOf(string) == 'object') {
                    attrs = string;

                    for (i in attrs) {
                        if (n++ > 0) { newStr += '&'; }
                        newStr += (i + '=' + attrs[i]);
                    }
                }

                if (true === ignoreCache) {
                    if (n++ > 0) { newStr += '&'; }
                    newStr += Mini2.Guid.newGuid();
                }

                if (n > 0) {
                    string = newStr;
                }

                return url + (url.indexOf('?') === -1 ? '?' : '&') + string;

            }

            return url;
        },
        

        /**
        * Trims whitespace from either end of a string, leaving spaces within the string intact.  Example:
        *
        *     var s = '  foo bar  ';
        *     alert('-' + s + '-');                   //alerts "- foo bar -"
        *     alert('-' + Ext.String.trim(s) + '-');  //alerts "-foo bar-"
        *
        * @param {String} string The string to trim.
        * @return {String} The trimmed string.
        */
        trim: function (string) {
            return string.replace(trimRegex, "");
        },

        /**
        * Capitalize the given string
        * @param {String} string
        * @return {String}
        */
        capitalize: function (string) {
            return string.charAt(0).toUpperCase() + string.substr(1);
        },

        /**
        * Uncapitalize the given string.
        * @param {String} string
        * @return {String}
        */
        uncapitalize: function (string) {
            return string.charAt(0).toLowerCase() + string.substr(1);
        },

        /**
        * Truncate a string and add an ellipsis ('...') to the end if it exceeds the specified length.
        * @param {String} value The string to truncate.
        * @param {Number} length The maximum length to allow before truncating.
        * @param {Boolean} [word=false] `true` to try to find a common word break.
        * @return {String} The converted text.
        */
        ellipsis: function (value, len, word) {
            if (value && value.length > len) {
                if (word) {
                    var vs = value.substr(0, len - 2),
                    index = Math.max(vs.lastIndexOf(' '), vs.lastIndexOf('.'), vs.lastIndexOf('!'), vs.lastIndexOf('?'));
                    if (index !== -1 && index >= (len - 15)) {
                        return vs.substr(0, index) + "...";
                    }
                }
                return value.substr(0, len - 3) + "...";
            }
            return value;
        },

        /**
        * Escapes the passed string for use in a regular expression.
        * @param {String} string
        * @return {String}
        */
        escapeRegex: function (string) {
            return string.replace(escapeRegexRe, "\\$1");
        },

        /**
        * Escapes the passed string for ' and \
        * @param {String} string The string to escape
        * @return {String} The escaped string
        */
        escape: function (string) {
            return string.replace(escapeRe, "\\$1");
        },

        /**
        * Utility function that allows you to easily switch a string between two alternating values.  The passed value
        * is compared to the current string, and if they are equal, the other value that was passed in is returned.  If
        * they are already different, the first value passed in is returned.  Note that this method returns the new value
        * but does not change the current string.
        *
        *     // alternate sort directions
        *     sort = Ext.String.toggle(sort, 'ASC', 'DESC');
        *
        *     // instead of conditional logic:
        *     sort = (sort === 'ASC' ? 'DESC' : 'ASC');
        *
        * @param {String} string The current string.
        * @param {String} value The value to compare to the current string.
        * @param {String} other The new value to use if the string already equals the first value passed in.
        * @return {String} The new value.
        */
        toggle: function (string, value, other) {
            return string === value ? other : value;
        },

        /**
        * Pads the left side of a string with a specified character.  This is especially useful
        * for normalizing number and date strings.  Example usage:
        *
        *     var s = Ext.String.leftPad('123', 5, '0');
        *     // s now contains the string: '00123'
        *
        * @param {String} string The original string.
        * @param {Number} size The total length of the output string.
        * @param {String} [character=' '] (optional) The character with which to pad the original string.
        * @return {String} The padded string.
        */
        leftPad: function (string, size, character) {
            var result = String(string);
            character = character || " ";
            while (result.length < size) {
                result = character + result;
            }
            return result;
        },

        rightPad:function(string, size, character){
            var result = String(string);
            character = character || " ";
            while (result.length < size) {
                result += character;
            }
            return result;
        },

        /**
        * Allows you to define a tokenized string and pass an arbitrary number of arguments to replace the tokens.  Each
        * token must be unique, and must increment in the format {0}, {1}, etc.  Example usage:
        *
        *     var cls = 'my-class',
        *         text = 'Some text';
        *     var s = Ext.String.format('<div class="{0}">{1}</div>', cls, text);
        *     // s now contains the string: '<div class="my-class">Some text</div>'
        *
        * @param {String} string The tokenized string to be formatted.
        * @param {Mixed...} values The values to replace tokens `{0}`, `{1}`, etc in order.
        * @return {String} The formatted string.
        */
        format: function (format) {
            var args = Mini2.Array.toArray(arguments, 1);
            return format.replace(formatRe, function (m, i) {
                return args[i];
            });
        },

        /**
        * Returns a string with a specified number of repetitions a given string pattern.
        * The pattern be separated by a different string.
        *
        *      var s = Ext.String.repeat('---', 4); // = '------------'
        *      var t = Ext.String.repeat('--', 3, '/'); // = '--/--/--'
        *
        * @param {String} pattern The pattern to repeat.
        * @param {Number} count The number of times to repeat the pattern (may be 0).
        * @param {String} sep An option string to separate each pattern.
        */
        repeat: function (pattern, count, sep) {
            if (count < 1) {
                count = 0;
            }
            for (var buf = [], i = count; i--; ) {
                buf.push(pattern);
            }
            return buf.join(sep || '');
        },

        /**
        * Splits a string of space separated words into an array, trimming as needed. If the
        * words are already an array, it is returned.
        *
        * @param {String/Array} words
        */
        splitWords: function (words) {
            if (words && typeof words == 'string') {
                return words.replace(basicTrimRe, '').split(whitespaceRe);
            }
            return words || [];
        },

        //判断是否为空白
        isBlank: function (string) {

            if (undefined === string || null === string) {
                return true;
            }

            if (typeof string == 'string') {

                if (string.length === 0) {
                    return true;
                }

                var trimStr = Mini2.String.trim(string);

                if (trimStr.length === 0) {
                    return true;
                }
            }

            return false;
        }
    };
} ());

Mini2.isBlank = Mini2.String.isBlank;

// initialize the default encode / decode entities
Mini2.String.resetCharacterEntities();

/**
* Old alias to {@link Ext.String#htmlEncode}
* @deprecated Use {@link Ext.String#htmlEncode} instead
* @method
* @member Ext
* @inheritdoc Ext.String#htmlEncode
*/
Mini2.htmlEncode = Mini2.String.htmlEncode;


/**
* Old alias to {@link Ext.String#htmlDecode}
* @deprecated Use {@link Ext.String#htmlDecode} instead
* @method
* @member Ext
* @inheritdoc Ext.String#htmlDecode
*/
Mini2.htmlDecode = Mini2.String.htmlDecode;

/**
* Old alias to {@link Ext.String#urlAppend}
* @deprecated Use {@link Ext.String#urlAppend} instead
* @method
* @member Ext
* @inheritdoc Ext.String#urlAppend
*/
Mini2.urlAppend = Mini2.String.urlAppend;


/************************************************************************/
/*                                           */
/*    lang/Number.js                                                       */
/*                                           */
/************************************************************************/




Mini2.Number = new function () {
    "use strict";
    var me = this,
        isToFixedBroken = (0.9).toFixed() !== '1',
        math = Math;

    Mini2.apply(this, {
        /**
        * Checks whether or not the passed number is within a desired range.  If the number is already within the
        * range it is returned, otherwise the min or max value is returned depending on which side of the range is
        * exceeded. Note that this method returns the constrained value but does not change the current number.
        * @param {Number} number The number to check
        * @param {Number} min The minimum number in the range
        * @param {Number} max The maximum number in the range
        * @return {Number} The constrained value if outside the range, otherwise the current value
        */
        constrain: function (number, min, max) {
            var x = parseFloat(number);

            // Watch out for NaN in Chrome 18
            // V8bug: http://code.google.com/p/v8/issues/detail?id=2056

            // Operators are faster than Math.min/max. See http://jsperf.com/number-constrain
            // ... and (x < Nan) || (x < undefined) == false
            // ... same for (x > NaN) || (x > undefined)
            // so if min or max are undefined or NaN, we never return them... sadly, this
            // is not true of null (but even Math.max(-1,null)==0 and isNaN(null)==false)
            return (x < min) ? min : ((x > max) ? max : x);
        },

        /**
        * Snaps the passed number between stopping points based upon a passed increment value.
        *
        * The difference between this and {@link #snapInRange} is that {@link #snapInRange} uses the minValue
        * when calculating snap points:
        *
        *     r = Ext.Number.snap(56, 2, 55, 65);        // Returns 56 - snap points are zero based
        *
        *     r = Ext.Number.snapInRange(56, 2, 55, 65); // Returns 57 - snap points are based from minValue
        *
        * @param {Number} value The unsnapped value.
        * @param {Number} increment The increment by which the value must move.
        * @param {Number} minValue The minimum value to which the returned value must be constrained. Overrides the increment.
        * @param {Number} maxValue The maximum value to which the returned value must be constrained. Overrides the increment.
        * @return {Number} The value of the nearest snap target.
        */
        snap: function (value, increment, minValue, maxValue) {
            var m;

            // If no value passed, or minValue was passed and value is less than minValue (anything < undefined is false)
            // Then use the minValue (or zero if the value was undefined)
            if (value === undefined || value < minValue) {
                return minValue || 0;
            }

            if (increment) {
                m = value % increment;
                if (m !== 0) {
                    value -= m;
                    if (m * 2 >= increment) {
                        value += increment;
                    } else if (m * 2 < -increment) {
                        value -= increment;
                    }
                }
            }
            return me.constrain(value, minValue, maxValue);
        },

        /**
        * Snaps the passed number between stopping points based upon a passed increment value.
        *
        * The difference between this and {@link #snap} is that {@link #snap} does not use the minValue
        * when calculating snap points:
        *
        *     r = Ext.Number.snap(56, 2, 55, 65);        // Returns 56 - snap points are zero based
        *
        *     r = Ext.Number.snapInRange(56, 2, 55, 65); // Returns 57 - snap points are based from minValue
        *
        * @param {Number} value The unsnapped value.
        * @param {Number} increment The increment by which the value must move.
        * @param {Number} [minValue=0] The minimum value to which the returned value must be constrained.
        * @param {Number} [maxValue=Infinity] The maximum value to which the returned value must be constrained.
        * @return {Number} The value of the nearest snap target.
        */
        snapInRange: function (value, increment, minValue, maxValue) {
            var tween;

            // default minValue to zero
            minValue = (minValue || 0);

            // If value is undefined, or less than minValue, use minValue
            if (value === undefined || value < minValue) {
                return minValue;
            }

            // Calculate how many snap points from the minValue the passed value is.
            if (increment && (tween = ((value - minValue) % increment))) {
                value -= tween;
                tween *= 2;
                if (tween >= increment) {
                    value += increment;
                }
            }

            // If constraining within a maximum, ensure the maximum is on a snap point
            if (maxValue !== undefined) {
                if (value > (maxValue = me.snapInRange(maxValue, increment, minValue))) {
                    value = maxValue;
                }
            }

            return value;
        },

        /**
        * Formats a number using fixed-point notation
        * @param {Number} value The number to format
        * @param {Number} precision The number of digits to show after the decimal point
        */
        toFixed: isToFixedBroken ? function (value, precision) {
            precision = precision || 0;
            var pow = math.pow(10, precision);
            return (math.round(value * pow) / pow).toFixed(precision);
        } : function (value, precision) {
            return value.toFixed(precision);
        },

        /**
        * Validate that a value is numeric and convert it to a number if necessary. Returns the specified default value if
        * it is not.

        Mini2.Number.from('1.23', 1); // returns 1.23
        Mini2.Number.from('abc', 1); // returns 1

        * @param {Object} value
        * @param {Number} defaultValue The value to return if the original value is non-numeric
        * @return {Number} value, if numeric, defaultValue otherwise
        */
        from: function (value, defaultValue) {
            if (isFinite(value)) {
                value = parseFloat(value);
            }

            return !isNaN(value) ? value : defaultValue;
        },

        /**
        * Returns a random integer between the specified range (inclusive)
        * @param {Number} from Lowest value to return.
        * @param {Number} to Highst value to return.
        * @return {Number} A random integer within the specified range.
        */
        randomInt: function (from, to) {
            return math.floor(math.random() * (to - from + 1) + from);
        },

        /**
        * Corrects floating point numbers that overflow to a non-precise
        * value because of their floating nature, for example `0.1 + 0.2`
        * @param {Number} The number
        * @return {Number} The correctly rounded number
        */
        correctFloat: function (n) {
            // This is to correct the type of errors where 2 floats end with
            // a long string of decimals, eg 0.1 + 0.2. When they overflow in this
            // manner, they usually go to 15-16 decimals, so we cut it off at 14.
            return parseFloat(n.toPrecision(14));
        }
    });

    /**
    * @deprecated 4.0.0 Please use {@link Ext.Number#from} instead.
    * @member Ext
    * @method num
    * @inheritdoc Ext.Number#from
    */
    Mini2.num = function () {
        return me.from.apply(this, arguments);
    };
};


/************************************************************************/
/*                                           */
/*    lang/log.js                                                          */
/*                                           */
/************************************************************************/


Mini2.define('Mini2.log.MethodLogger', {

    owner: null,

    name: null,


    debugFormat: function (text, params) {
        var me = this,
                    console = window.console,
                    i,
                    d = new Date(),
                    strD,
                    spaceStr = "";

        if (arguments.length > 1) {
            text = $.format(text, params);
        }


        if (console && console.log) {
            console.log(me.now() + 'DEBUG ' + me.className + ' - ' + spaceStr + text);
        }
    },

    debug: function (text, optionParams) {
        var me = this,
                    console = window.console,
                    i,
                    d = new Date(),
                    strD,
                    spaceStr = "";

        strD = me.now();

        if (console && console.log) {
            console.log(strD + 'DEBUG ' + me.className + ' - ' + spaceStr + text, optionParams);
        }
    }

    


});

Mini2.define('Mini2.log.Logger',{
    
    className: '',

    enabled : true,

    now: function () {
        var d = new Date(),
            ttt = d.getTime() + '',
            strD = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds() + "." + d.getMilliseconds() ;

        return strD;
    },

    getMethod:function(methodName){
        var me = this,
            methodLog;

        methodLog = Mini2.create('Mini2.log.MethodLogger', {
            owner: me,
            name : methodName
        });

        return methodLog;
    },

    debugFormat: function (text, params) {
        var me = this,
                    console = window.console,
                    i,
                    d = new Date(),
                    strD,
                    spaceStr = "";

        if (!me.enabled) {
            return;
        }

        if (arguments.length > 1) {
            text = $.format(text, params);
        }


        if (console && console.debug) {
            var logText = '%c' + me.now() + ' %cDEBUG %c' + me.className + ' - ' + spaceStr + text;

            console.debug(logText, 'color:#0', 'color:#00A49D', 'color:#0');
        }
    },

    debug: function (text, optionParams) {
        var me = this,
                    console = window.console,
                    i,
                    d = new Date(),
                    strD,
                    spaceStr = "";

        if (!me.enabled) {
            return;
        }
        
        if (console && console.debug) {

            var logText = '%c' + me.now() + ' %cDEBUG %c' + me.className + ' - ' + spaceStr + text;
            
            if (arguments.length == 1) {
                console.debug(logText, 'color:#0', 'color:#00A49D', 'color:#0');
            }
            else {
                console.debug(logText, 'color:#0', 'color:#00A49D', 'color:#0', optionParams);
            }
        }
    },



    error: function (text, optionParams) {
        var me = this,
                    console = window.console,
                    i,
                    d = new Date(),
                    strD,
                    spaceStr = "";

        if (console && console.error) {

            var logText = '%c' + me.now() + ' %ERROR %c' + me.className + ' - ' + spaceStr + text;

            if (arguments.length == 1) {
                console.error(logText, 'color:#0', 'color:red', 'color:#0');
            }
            else {
                console.error(logText, 'color:#0', 'color:red', 'color:#0', optionParams);
            }

            console.trace();
        }
    },

    fatal: function (text, params) {

    },

    info: function (text, params) {

    },

    warn: function (text, params) {

    },

    trace: function (text, params) {

    }


});

window.log = Mini2.Logger = new function () {
    "use strict";
    Mini2.apply(this, {

        space: -4,
        
        begin: function (text) {

            var console = window.console;

            this.space += 4;

            if (!text) {
                return;
            }

            var spaceStr = "";

            for (var i = 0; i < this.space; i++) {
                spaceStr += " ";
            }

            var d = new Date();

            var strD = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds() + "  ";

            if (console && console.log) {
                console.log(strD + spaceStr + "【" + text + "】");
            }
        },

        end: function (text) {

            if (text) {
                this.debug('【end】:' + text);
            }
            else {
                this.debug('【end】');
            }

            this.space -= 4;
        },


        error:function(text){
            var me = this,
                console = window.console,
                i,
                d = new Date(),
                strD,
                spaceStr = "";


            if (arguments.length > 1) {

                var args = [];

                for (var i = 1; i < arguments.length; i++) {
                    args.push(arguments[i - 1]);
                }

                //text = $.format(text, args);
            }


            for (i = 0; i < this.space; i++) {
                spaceStr += " ";
            }

            strD = me.now() + "  ";

            if (console && console.log) {
                console.log(strD + spaceStr + "[ERROR]" + text);
            }
        },

        debug: function (text, optionParams) {
            var me = this, 
                console = window.console,
                i,
                d = new Date(),
                strD,
                spaceStr = "";

            for (i = 0; i < this.space; i++) {
                spaceStr += " ";
            }

            strD = me.now() + "  ";

            if (arguments.length > 1) {
                text = $.format(text, optionParams);
            }
            

            if (console && console.log) {

                if (arguments.length == 1) {
                    console.log(strD + spaceStr + text);
                }
                else {
                    console.log(strD + spaceStr + text, optionParams);
                }
            }
        },



        now: function () {
            var d = new Date(),
                ttt = d.getTime() + '',
                strD = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds() + "." + d.getMilliseconds() ;

            return strD;
        },

        d: function (text, optionParams) {
            var me = this,
                d = new Date(),
                strD,
                spaceStr = "";



            var logText = '%c' + me.now() + ' %cDEBUG %c' + me.className + ' - ' + spaceStr + text;

            return logText;
        },


        getLogger: function (className, enabled) {
            if (enabled === console) {
                return console;
            }

            if (undefined == enabled) {
                enabled = true;
            }

            
            var item = Mini2.create('Mini2.log.Logger', {
                className: className,
                enabled : enabled
            });

            return item;
        }



    });
};



/************************************************************************/
/*                                           */
/*    util/Filter.js                                                       */
/*                                           */
/************************************************************************/






/************************************************************************/
/*                                           */
/*    util/Sorter.js                                                       */
/*                                           */
/************************************************************************/



Mini2.define('Mini2.util.Sorter', {

    direction: "ASC",

    constructor: function (config) {
        var me = this;

        Mini2.apply(me, config);

        alert("dddddddddddddddddddddddddddd");

        //me.updateSortFunction();
    },

    serialize: function () {
        return {
            root: this.root,
            property: this.property,
            direction: this.direction
        };
    }

});


/************************************************************************/
/*                                           */
/*    util/Format.js                                                       */
/*                                           */
/************************************************************************/



(function () {
    Mini2.ns('Mini2.util');

    var UtilFormat = Mini2.util.Format = {},
        stripTagsRE = /<\/?[^>]+>/gi,
        stripScriptsRe = /(?:<script.*?>)((\n|\r|.)*?)(?:<\/script>)/ig,
        nl2brRe = /\r?\n/g,
        allHashes = /^#+$/,

        // Match a format string characters to be able to detect remaining "literal" characters
        formatPattern = /[\d,\.#]+/,

        // A RegExp to remove from a number format string, all characters except digits and '.'
        formatCleanRe = /[^\d\.#]/g,

        // A RegExp to remove from a number format string, all characters except digits and the local decimal separator.
        // Created on first use. The local decimal separator character must be initialized for this to be created.
        I18NFormatCleanRe,

        // Cache ofg number formatting functions keyed by format string
        formatFns = {};

    Mini2.apply(UtilFormat, {
        //<locale>
        /**
         * @property {String} thousandSeparator
         * The character that the {@link #number} function uses as a thousand separator.
         *
         * This may be overridden in a locale file.
         */
        thousandSeparator: ',',
        //</locale>

        //<locale>
        /**
         * @property {String} decimalSeparator
         * The character that the {@link #number} function uses as a decimal point.
         *
         * This may be overridden in a locale file.
         */
        decimalSeparator: '.',
        //</locale>

        //<locale>
        /**
         * @property {Number} currencyPrecision
         * The number of decimal places that the {@link #currency} function displays.
         *
         * This may be overridden in a locale file.
         */
        currencyPrecision: 2,
        //</locale>

        //<locale>
        /**
         * @property {String} currencySign
         * The currency sign that the {@link #currency} function displays.
         *
         * This may be overridden in a locale file.
         */
        currencySign: '$',
        //</locale>

        //<locale>
        /**
         * @property {Boolean} currencyAtEnd
         * This may be set to <code>true</code> to make the {@link #currency} function
         * append the currency sign to the formatted value.
         *
         * This may be overridden in a locale file.
         */
        currencyAtEnd: false,
        //</locale>

        /**
         * Checks a reference and converts it to empty string if it is undefined.
         * @param {Object} value Reference to check
         * @return {Object} Empty string if converted, otherwise the original value
         */
        undef: function (value) {
            return value !== undefined ? value : "";
        },

        /**
         * Checks a reference and converts it to the default value if it's empty.
         * @param {Object} value Reference to check
         * @param {String} [defaultValue=""] The value to insert of it's undefined.
         * @return {String}
         */
        defaultValue: function (value, defaultValue) {
            return value !== undefined && value !== '' ? value : defaultValue;
        },

        /**
         * Returns a substring from within an original string.
         * @param {String} value The original text
         * @param {Number} start The start index of the substring
         * @param {Number} length The length of the substring
         * @return {String} The substring
         * @method
         */
        substr: 'ab'.substr(-1) != 'b'
        ? function (value, start, length) {
            var str = String(value);
            return (start < 0)
                ? str.substr(Math.max(str.length + start, 0), length)
                : str.substr(start, length);
        }
        : function (value, start, length) {
            return String(value).substr(start, length);
        },

        /**
         * Converts a string to all lower case letters.
         * @param {String} value The text to convert
         * @return {String} The converted text
         */
        lowercase: function (value) {
            return String(value).toLowerCase();
        },

        /**
         * Converts a string to all upper case letters.
         * @param {String} value The text to convert
         * @return {String} The converted text
         */
        uppercase: function (value) {
            return String(value).toUpperCase();
        },

        /**
         * Format a number as US currency.
         * @param {Number/String} value The numeric value to format
         * @return {String} The formatted currency string
         */
        usMoney: function (v) {
            return UtilFormat.currency(v, '$', 2);
        },

        /**
         * Format a number as a currency.
         * @param {Number/String} value The numeric value to format
         * @param {String} [sign] The currency sign to use (defaults to {@link #currencySign})
         * @param {Number} [decimals] The number of decimals to use for the currency
         * (defaults to {@link #currencyPrecision})
         * @param {Boolean} [end] True if the currency sign should be at the end of the string
         * (defaults to {@link #currencyAtEnd})
         * @return {String} The formatted currency string
         */
        currency: function (v, currencySign, decimals, end) {
            var negativeSign = '',
                format = ",0",
                i = 0;
            v = v - 0;
            if (v < 0) {
                v = -v;
                negativeSign = '-';
            }
            decimals = Mini2.isDefined(decimals) ? decimals : UtilFormat.currencyPrecision;
            format += (decimals > 0 ? '.' : '');
            for (; i < decimals; i++) {
                format += '0';
            }
            v = UtilFormat.number(v, format);
            if ((end || UtilFormat.currencyAtEnd) === true) {
                return Mini2.String.format("{0}{1}{2}", negativeSign, v, currencySign || UtilFormat.currencySign);
            } else {
                return Mini2.String.format("{0}{1}{2}", negativeSign, currencySign || UtilFormat.currencySign, v);
            }
        },

        /**
         * Formats the passed date using the specified format pattern.
         * @param {String/Date} value The value to format. If a string is passed, it is converted to a Date
         * by the Javascript's built-in Date#parse method.
         * @param {String} [format] Any valid date format string. Defaults to {@link Ext.Date#defaultFormat}.
         * @return {String} The formatted date string.
         */
        date: function (v, format) {
            if (!v) {
                return "";
            }
            if (!Mini2.isDate(v)) {
                v = new Date(Date.parse(v));
            }
            return Mini2.Date.dateFormat(v, format || Mini2.Date.defaultFormat);
        },

        /**
         * Returns a date rendering function that can be reused to apply a date format multiple times efficiently.
         * @param {String} format Any valid date format string. Defaults to {@link Ext.Date#defaultFormat}.
         * @return {Function} The date formatting function
         */
        dateRenderer: function (format) {
            return function (v) {
                return UtilFormat.date(v, format);
            };
        },

        /**
         * Strips all HTML tags.
         * @param {Object} value The text from which to strip tags
         * @return {String} The stripped text
         */
        stripTags: function (v) {
            return !v ? v : String(v).replace(stripTagsRE, "");
        },

        /**
         * Strips all script tags.
         * @param {Object} value The text from which to strip script tags
         * @return {String} The stripped text
         */
        stripScripts: function (v) {
            return !v ? v : String(v).replace(stripScriptsRe, "");
        },

        /**
         * Simple format for a file size (xxx bytes, xxx KB, xxx MB).
         * @param {Number/String} size The numeric value to format
         * @return {String} The formatted file size
         */
        fileSize: (function () {
            var byteLimit = 1024,
                kbLimit = 1048576,
                mbLimit = 1073741824;

            return function (size) {
                var out;
                if (size < byteLimit) {
                    if (size === 1) {
                        out = '1 byte';
                    } else {
                        out = size + ' bytes';
                    }
                } else if (size < kbLimit) {
                    out = (Math.round(((size * 10) / byteLimit)) / 10) + ' KB';
                } else if (size < mbLimit) {
                    out = (Math.round(((size * 10) / kbLimit)) / 10) + ' MB';
                } else {
                    out = (Math.round(((size * 10) / mbLimit)) / 10) + ' GB';
                }
                return out;
            };
        })(),

        /**
         * It does simple math for use in a template, for example:
         *
         *     var tpl = new Ext.Template('{value} * 10 = {value:math("* 10")}');
         *
         * @return {Function} A function that operates on the passed value.
         * @method
         */
        math: (function () {
            var fns = {};

            return function (v, a) {
                if (!fns[a]) {
                    fns[a] = Mini2.functionFactory('v', 'return v ' + a + ';');
                }
                return fns[a](v);
            };
        }()),

        /**
         * Rounds the passed number to the required decimal precision.
         * @param {Number/String} value The numeric value to round.
         * @param {Number} precision The number of decimal places to which to round the first parameter's value.
         * @return {Number} The rounded value.
         */
        round: function (value, precision) {
            var result = Number(value);
            if (typeof precision == 'number') {
                precision = Math.pow(10, precision);
                result = Math.round(value * precision) / precision;
            }
            return result;
        },

        /**
         * Formats the passed number according to the passed format string.
         *
         * The number of digits after the decimal separator character specifies the number of
         * decimal places in the resulting string. The *local-specific* decimal character is
         * used in the result.
         *
         * The *presence* of a thousand separator character in the format string specifies that
         * the *locale-specific* thousand separator (if any) is inserted separating thousand groups.
         *
         * By default, "," is expected as the thousand separator, and "." is expected as the decimal separator.
         *
         * ## New to Ext JS 4
         *
         * Locale-specific characters are always used in the formatted output when inserting
         * thousand and decimal separators.
         *
         * The format string must specify separator characters according to US/UK conventions ("," as the
         * thousand separator, and "." as the decimal separator)
         *
         * To allow specification of format strings according to local conventions for separator characters, add
         * the string `/i` to the end of the format string.
         *
         * examples (123456.789):
         * 
         * - `0` - (123456) show only digits, no precision
         * - `0.00` - (123456.78) show only digits, 2 precision
         * - `0.0000` - (123456.7890) show only digits, 4 precision
         * - `0,000` - (123,456) show comma and digits, no precision
         * - `0,000.00` - (123,456.78) show comma and digits, 2 precision
         * - `0,0.00` - (123,456.78) shortcut method, show comma and digits, 2 precision
         * - `0.####` - (123,456,789) Allow maximum 4 decimal places, but do not right pad with zeroes
         *
         * @param {Number} v The number to format.
         * @param {String} format The way you would like to format this text.
         * @return {String} The formatted number.
         */
        number: function (v, formatString) {
            if (!formatString) {
                return v;
            }

            if (formatString.substr(-1,1) == '%') {
                formatString = formatString.replace('%', 'pct');
            }

            var formatFn = formatFns[formatString];


            // Generate formatting function to be cached and reused keyed by the format string.
            // This results in a 100% performance increase over analyzing the format string each invocation.
            if (!formatFn) {

                var originalFormatString = formatString,
                    comma = UtilFormat.thousandSeparator,
                    decimalSeparator = UtilFormat.decimalSeparator,
                    hasComma,
                    splitFormat,
                    extraChars,
                    precision = 0,
                    multiplier,
                    trimTrailingZeroes,
                    code;

                // The "/i" suffix allows caller to use a locale-specific formatting string.
                // Clean the format string by removing all but numerals and the decimal separator.
                // Then split the format string into pre and post decimal segments according to *what* the
                // decimal separator is. If they are specifying "/i", they are using the local convention in the format string.
                if (formatString.substr(formatString.length - 2) == '/i') {
                    if (!I18NFormatCleanRe) {
                        I18NFormatCleanRe = new RegExp('[^\\d\\' + UtilFormat.decimalSeparator + ']', 'g');
                    }
                    formatString = formatString.substr(0, formatString.length - 2);
                    hasComma = formatString.indexOf(comma) != -1;
                    splitFormat = formatString.replace(I18NFormatCleanRe, '').split(decimalSeparator);
                } else {
                    hasComma = formatString.indexOf(',') != -1;
                    splitFormat = formatString.replace(formatCleanRe, '').split('.');
                }
                extraChars = formatString.replace(formatPattern, '');

                if (splitFormat.length > 2) {
                    //<debug>
                    Mini2.Error.raise({
                        sourceClass: "Mini2.util.Format",
                        sourceMethod: "number",
                        value: v,
                        formatString: formatString,
                        msg: "Invalid number format, should have no more than 1 decimal"
                    });
                    //</debug>
                } else if (splitFormat.length === 2) {
                    precision = splitFormat[1].length;

                    // Formatting ending in .##### means maximum 5 trailing significant digits
                    trimTrailingZeroes = allHashes.test(splitFormat[1]);
                }

                // The function we create is called immediately and returns a closure which has access to vars and some fixed values; RegExes and the format string.
                code = [
                    'var utilFormat=Mini2.util.Format,extNumber=Mini2.Number,neg,fnum,parts' +
                        (hasComma ? ',thousandSeparator,thousands=[],j,n,i' : '') +
                        (extraChars ? ',formatString="' + formatString + '",formatPattern=/[\\d,\\.#]+/' : '') +
                        (trimTrailingZeroes ? ',trailingZeroes=/\\.?0+$/;' : ';') +
                    'return function(v){' +
                    'if(typeof v!=="number"&&isNaN(v=extNumber.from(v,NaN)))return"";' +
                    'neg=v<0;',
                    'fnum=Mini2.Number.toFixed(Math.abs(v), ' + precision + ');'
                ];

                if (hasComma) {
                    // If we have to insert commas...

                    // split the string up into whole and decimal parts if there are decimals
                    if (precision) {
                        code[code.length] = 'parts=fnum.split(".");';
                        code[code.length] = 'fnum=parts[0];';
                    }
                    code[code.length] =
                        'if(v>=1000) {';
                    code[code.length] = 'thousandSeparator=utilFormat.thousandSeparator;' +
                    'thousands.length=0;' +
                    'j=fnum.length;' +
                    'n=fnum.length%3||3;' +
                    'for(i=0;i<j;i+=n){' +
                        'if(i!==0){' +
                            'n=3;' +
                        '}' +
                        'thousands[thousands.length]=fnum.substr(i,n);' +
                    '}' +
                    'fnum=thousands.join(thousandSeparator);' +
                '}';
                    if (precision) {
                        code[code.length] = 'fnum += utilFormat.decimalSeparator+parts[1];';
                    }

                } else if (precision) {
                    // If they are using a weird decimal separator, split and concat using it
                    code[code.length] = 'if(utilFormat.decimalSeparator!=="."){' +
                        'parts=fnum.split(".");' +
                        'fnum=parts[0]+utilFormat.decimalSeparator+parts[1];' +
                    '}';
                }

                if (trimTrailingZeroes) {
                    code[code.length] = 'fnum=fnum.replace(trailingZeroes,"");';
                }

                /*
                 * Edge case. If we have a very small negative number it will get rounded to 0,
                 * however the initial check at the top will still report as negative. Replace
                 * everything but 1-9 and check if the string is empty to determine a 0 value.
                 */
                code[code.length] = 'if(neg&&fnum!=="' + (precision ? '0.' + Mini2.String.repeat('0', precision) : '0') + '")fnum="-"+fnum;';

                code[code.length] = 'return ';

                // If there were extra characters around the formatting string, replace the format string part with the formatted number.
                if (extraChars) {
                    code[code.length] = 'formatString.replace(formatPattern, fnum);';
                } else {
                    code[code.length] = 'fnum;';
                }
                code[code.length] = '};'

                formatFn = formatFns[originalFormatString] = Mini2.functionFactory('Mini2', code.join(''))(Mini2);
            }
            return formatFn(v);
        },

        /**
         * Returns a number rendering function that can be reused to apply a number format multiple
         * times efficiently.
         *
         * @param {String} format Any valid number format string for {@link #number}
         * @return {Function} The number formatting function
         */
        numberRenderer: function (format) {
            return function (v) {
                return UtilFormat.number(v, format);
            };
        },

        /**
         * Formats an object of name value properties as HTML element attribute values suitable for using when creating textual markup.
         * @param {Object} attributes An object containing the HTML attributes as properties eg: `{height:40, vAlign:'top'}`
         */
        attributes: function (attributes) {
            if (typeof attributes === 'object') {
                var result = [],
                    name;

                for (name in attributes) {
                    result.push(name, '="', name === 'style' ? Mini2.DomHelper.generateStyles(attributes[name]) : Mini2.htmlEncode(attributes[name]), '"');
                }
                attributes = result.join('');
            }
            return attributes || '';
        },

        /**
         * Selectively do a plural form of a word based on a numeric value. For example, in a template,
         * `{commentCount:plural("Comment")}`  would result in `"1 Comment"` if commentCount was 1 or
         * would be `"x Comments"` if the value is 0 or greater than 1.
         *
         * @param {Number} value The value to compare against
         * @param {String} singular The singular form of the word
         * @param {String} [plural] The plural form of the word (defaults to the singular with an "s")
         */
        plural: function (v, s, p) {
            return v + ' ' + (v == 1 ? s : (p ? p : s + 's'));
        },

        /**
         * Converts newline characters to the HTML tag `<br/>`
         *
         * @param {String} v The string value to format.
         * @return {String} The string with embedded `<br/>` tags in place of newlines.
         */
        nl2br: function (v) {
            return Mini2.isEmpty(v) ? '' : v.replace(nl2brRe, '<br/>');
        },

        /**
         * Alias for {@link Ext.String#capitalize}.
         * @method
         * @inheritdoc Ext.String#capitalize
         */
        capitalize: Mini2.String.capitalize,

        /**
         * Alias for {@link Ext.String#ellipsis}.
         * @method
         * @inheritdoc Ext.String#ellipsis
         */
        ellipsis: Mini2.String.ellipsis,

        /**
         * Alias for {@link Ext.String#format}.
         * @method
         * @inheritdoc Ext.String#format
         */
        format: Mini2.String.format,

        /**
         * Alias for {@link Ext.String#htmlDecode}.
         * @method
         * @inheritdoc Ext.String#htmlDecode
         */
        htmlDecode: Mini2.String.htmlDecode,

        /**
         * Alias for {@link Ext.String#htmlEncode}.
         * @method
         * @inheritdoc Ext.String#htmlEncode
         */
        htmlEncode: Mini2.String.htmlEncode,

        /**
         * Alias for {@link Ext.String#leftPad}.
         * @method
         * @inheritdoc Ext.String#leftPad
         */
        leftPad: Mini2.String.leftPad,

        /**
         * Alias for {@link Ext.String#trim}.
         * @method
         * @inheritdoc Ext.String#trim
         */
        trim: Mini2.String.trim,

        /**
         * Parses a number or string representing margin sizes into an object.
         * Supports CSS-style margin declarations (e.g. 10, "10", "10 10", "10 10 10" and
         * "10 10 10 10" are all valid options and would return the same result).
         *
         * @param {Number/String} v The encoded margins
         * @return {Object} An object with margin sizes for top, right, bottom and left
         */
        parseBox: function (box) {
            box = box || 0;

            if (typeof box === 'number') {
                return {
                    top: box,
                    right: box,
                    bottom: box,
                    left: box
                };
            }

            var parts = box.split(' '),
                ln = parts.length;

            if (ln == 1) {
                parts[1] = parts[2] = parts[3] = parts[0];
            }
            else if (ln == 2) {
                parts[2] = parts[0];
                parts[3] = parts[1];
            }
            else if (ln == 3) {
                parts[3] = parts[1];
            }

            return {
                top: parseInt(parts[0], 10) || 0,
                right: parseInt(parts[1], 10) || 0,
                bottom: parseInt(parts[2], 10) || 0,
                left: parseInt(parts[3], 10) || 0
            };
        },

        /**
         * Escapes the passed string for use in a regular expression.
         * @param {String} str
         * @return {String}
         */
        escapeRegex: function (s) {
            return s.replace(/([\-.*+?\^${}()|\[\]\/\\])/g, "\\$1");
        }
    });

    
    formatFns['0pct'] = function (value) {

        var intV = parseInt(value * 100);

        if (isNaN(intV)) {
            return '';
        }

        return intV + "%";
    };


    formatFns['0.0pct'] = function (value) {

        var intV = Mini2.util.Format.number(value * 100, '0.0');

        if (isNaN(intV)) {
            return '';
        }

        return intV + "%";
    };

    formatFns['0.00pct'] = function (value) {

        var intV = Mini2.util.Format.number(value * 100, '0.00');

        if (isNaN(intV)) {
            return '';
        }

        return intV + "%";
    };

    formatFns['0.#pct'] = function (value) {

        var intV = Mini2.util.Format.number(value * 100, '0.#');
        if (isNaN(intV)) {
            return '';
        }

        return intV + "%";
    };

    formatFns['0.##pct'] = function (value) {

        var intV = Mini2.util.Format.number(value * 100, '0.##');
        if (isNaN(intV)) {
            return '';
        }
        return intV + "%";
    };

}());




/************************************************************************/
/*                                           */
/*    collection/ArrayList.js                                              */
/*                                           */
/************************************************************************/




/// <reference path="../Mini2.js" />
/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />


Mini2.define('Mini2.collection.ArrayList', {

    isArray:true,

    log: Mini2.Logger,  //日志管理器

    constructor: function (config, getFn) {
        "use strict";
        var me = this,
            args = arguments;

        me.length = 0;
        me.items = [];

        if (Mini2.isArray(args[0])) {

            me.items = args[0];

            me.length = me.items.length;

        }


        if (Mini2.isFunction(getFn)) {
            me.getFun = getFn;
        }
    },


    getCount: function () {

        return this.items.length;
    },

    add: function (item) {
        "use strict";
        var me = this,
            srcItems = me.items;


        if (item && item.length) {
            me.items = srcItems = srcItems.concat(item);
        }
        else {
            srcItems.push(item);
        }

        me.length = srcItems.length;

    },

    erase: function (index, removeCount) {



    },

    insert: function (index, item) {
        "use strict";
        var me = this,
            subLen = 0,
            lastList,
            items = me.items,
            i, n;

        if (index > items.length) {
            index = items.length;
        }

        lastList = me.getRange(index, null);

        if (typeof item == 'array') {

            for (i = 0; i < item.length; i++) {
                n = i + index;
                items[n] = item[i];
            }

            subLen = index + item.length;

        }
        else {
            items[index] = item;

            subLen = index + 1;

        }


        for (i = 0; i < lastList.length; i++) {
            n = subLen + i;

            items[n] = lastList[i];
        }


        me.length = items.length;
    },

    remoteAt: function (index) {
        "use strict";
        var me = this,
            items = me.items,
            item;

        if (index < me.length && index >= 0) {

            item = items[index];

            items.splice(index, 1);

            me.length = items.length;

            return item;
        }

        return false;
    },

    removeAll: function () {
        "use strict";
        var me = this;

        while (me.length) {
            me.removeAt(0);
        }


        me.length = me.items.length;
    },

    remove: function (item) {
        "use strict";
        var me = this,
            curItem,
            i = 0,
            n = -1,
            items = me.items,
            len = items.length;

        for (; i < len; i++) {

            curItem = items[i];

            if (curItem === item) {
                n = i;
                break;
            }
        }

        me.remoteAt(n);


        me.length = items.length;

        return n;
    },

    removeRange: function (start, end) {
        "use strict";
        var me = this,
            items = me.items,
            range = [],
            len = items.length,
            tmp, reverse;


        if (len < 1) {
            return range;
        }

        if (start > end) {
            reverse = true;
            tmp = start;
            start = end;
            end = tmp;
        }

        if (start < 0) {
            start = 0;
        }

        if (end == null || end >= len) {
            end = len - 1;
        }

        range = items.splice(start, end + 1);


        me.length = items.length;

        return range;
    },

    getByProp: function (propName, value) {
        "use strict";
        var me = this,
            item = null,
            items = me.items,
            curItem,
            c,i=0;


        for (; i < items.length; i++) {
            curItem = items[i];
            c = curItem[propName];
            if (c == value) {
                item = curItem;
                break;
            }
        }


        return item;
    },

    get: function (index) {
        "use strict";
        var me = this,
            item = null;

        item = me.items[index];

        return item;
    },

    set: function (index, value) {

        this.items[index] = value;
    },

    first: function () {

        return this.items[0];
    },

    last: function () {

        return this.items[this.length - 1];
    },

    getRange: function (start, end) {
        "use strict";
        var me = this,
            items = me.items,
            range = [],
            len = items.length,
            tmp, reverse;



        if (len < 1) {
            return range;
        }

        if (end != undefined && end != null && start > end) {
            reverse = true;
            tmp = start;
            start = end;
            end = tmp;
        }


        if (start < 0) {
            start = 0;
        }

        if (end == null || end >= len) {
            end = len - 1;
        }


        range = items.slice(start, end + 1);

        if (reverse && range.length) {
            range.reverse();
        }
        return range;
    },

    //查找第一个
    filterFirstBy: function (fn, scope) {
        "use strict";
        var me = this,
            newObj = null,
            items = me.items,
            length = items.length,
            i=0;


        for (; i < length; i++) {
            if (fn.call(scope || me, items[i])) {
                newObj = items[i];
                break;
            }
        }

        return newObj;
    },

    //查找全部
    filterBy: function (fn, scope) {
        "use strict";
        var me = this,
            newList = new Mini2.collection.ArrayList(),
            items = me.items,
            length = items.length,
            i=0;


        for (; i < length; i++) {
            if (fn.call(scope || me, items[i])) {
                newList.add(items[i]);
            }
        }

        return newList;
    },

    findIndexBy: function (fn, scope, start) {
        "use strict";
        var me = this,
            item,
            items = me.items,
            length = items.length,
            i = start,
            index = -1;

        if (start == undefined) {
            i = 0;
        }


        for (; i < length; i++) {

            if (fn.call(scope || me, items[i])) {
                index = i;
                break;
            }
        }

        return index;
    },

    toArray: function () {
        return this.items;
    }


}, function (args) {
    "use strict";
    var me = this,
        newArgs = [],
        srcArgs = arguments,
        i=0;

    for (; i < srcArgs.length; i++) {
        newArgs[i] = srcArgs[i];
    }

    me.muid = Mini2.getIdentity();

    me.constructor(newArgs[0], newArgs[1]);

});


/************************************************************************/
/*                                           */
/*    SystemInfo.js                                                        */
/*                                           */
/************************************************************************/


/// <reference path="define.js" />
/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />

//系统信息
Mini2.define("Mini2.SystemInfo", {

    singleton: true,

    mode : 'default',

    //表单
    form: {

        //下一个键
        tabKeyCode: 13,

        //元素的间距
        itemMarginBottom: 8,
        
        //元素的间距
        itemMarginRight: 8

    },

    //表单触发器的按钮
    formTrigger:{

        width: 22
        
    },

    //工具栏
    toolbar: {
        //高度
        height: 36,

        item_span: 4,

        //普通按钮组
        uiType_buttonGroup: {
            height: 36,
            item_span : 0
        },

        //大扁平模式
        uiType_largeFlat: {
            height: 36,
            item_span: 0
        }
    },

    //表格
    table: {

        //表格列头宽度的比率
        headerWidthRaed: 1,

        headerHeight: 31,
        rowHeight: 31,

        //底部高度
        footerHeight: 36,

        headerAlign: 'center',

        columnLines: true,

        focusBorders: true,

        cols: {

            rowNumberer: {
                width: 40
            },

        }
    },


    window: {
        headerHeight: 24,
        footerHeight: 36,

        contentHeight: 70,

        //消息框高度
        msgHeight : 180
    },

    list:{

        itemHeight: 24

    },

    //字体
    font: {

        //字体尺寸
        size: 12,

        //半角字符宽度
        chatWidth: 6
    },

    //工具栏
    tabPanel: {
        //标签页高度
        tabHeight: 32
    },

    //分页控件
    pagination:{

        height: 24
    },


    //菜单
    menu:{

        paddingTop: 3,
        paddingBottom:3

    },

    modeList:false,

    'defaultMode':false,

    //设置模式
    setMode: function (mode) {
        "use strict";
        var me = this,
            modeFn;

        if (!me.modeList) {

            me.defaultMode = me.computeMode;

            me.modeList = {
                "default": me.computeMode,
                "compute": me.computeMode,
                "touch": me.touchMode,
                "mobile": me.mobileMode,
                "compact": me.compact,   //紧凑版
                "bootstrap": me.bootstrap,
                "triton2": me.triton2,
            }

        }
        
        modeFn = me.modeList[mode];

        if (modeFn) {
            modeFn.call(me);
        }
        else {
            me.defaultMode.call(me);
        }
    },


    //紧凑版
    compactMode:function(){
        "use strict";
        var me = this;

        me.toolbar.height = 24;

        Mini2.apply(me.table, {
            headerHeight: 24,
            rowHeight: 24,
            headerWidthRaed: 0.8,
            footerHeight: 24
        });
    },

    //Bootstrap
    bootstrap : function(){
        "use strict";
        var me = this;

        me.mode = 'bootstrap';

        console.debug('切换 SystemInfo.mode 为 ', Mini2.SystemInfo.mode);


        me.toolbar.height = 44;
    },

    triton2: function () {
        "use strict";
        var me = this;

        me.mode = 'triton2';

        Mini2.apply(me.table, {
            columnLines: false,
            focusBorders: false,
            headerWidthRaed: 1.1,
            headerHeight: 52,
            rowHeight:52
        });

        Mini2.apply(me.toolbar, {
            height:44,
            item_span: 0,
        });

        //普通按钮组
        Mini2.apply(me.toolbar.uiType_buttonGroup, {
            height: 34,
            item_span: 0
        });

        //大扁平模式
        Mini2.apply(me.toolbar.uiType_largeFlat, {
            height: 44,
            item_span: 0
        });

        Mini2.apply(me.pagination, {
            height: 45
        });
    },
    
    //电脑模式
    computeMode:function(){
        var me = this;

        
    },
    
    //平板模式(默认模式);
    touchMode: function () {
        "use strict";
        var me = this;

        me.mode = 'touch';

        console.debug('切换 SystemInfo.mode 为 ', Mini2.SystemInfo.mode);

        Mini2.apply(me.toolbar, {
            height: 60
        });

        Mini2.apply(me.table, {
            headerWidthRaed: 1,
            footerHeight: 37,
            headerHeight: 37,
            rowHeight : 37
        });


        Mini2.apply(me.table.cols.rowNumberer, {

            width : 60

        });

        
        Mini2.apply(me.window, {
            footerHeight: 52,
            contentHeight: 70,
            msgHeight: 180,
            itemHeight:46
        });

        Mini2.apply(me.list, {
            itemHeight: 46
        });

        Mini2.apply(me.tabPanel, {
            tabHeight: 42
        });

        Mini2.apply(me.pagination, {
            height: 50
        });

        Mini2.apply(me.form, {

            //元素的间距
            itemMarginBottom: 15,

            //元素的间距
            itemMarginRight: 15

        });

        Mini2.apply(me.formTrigger, {
            width: 38
        });
    },

    //手机模式
    mobileMode: function () {

    }

}, function () {

    var me = this;




});


/************************************************************************/
/*                                           */
/*    LoaderManager.js                                                     */
/*                                           */
/************************************************************************/


/// <reference path="define.js" />
/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />

/**
* 加载机
*/
Mini2.define("Mini2.LoaderManager", {

    //单件模式
    singleton: true,


    log: Mini2.Logger.getLogger('Mini2.LoaderManager'),  //日志管理器


    afterRenderItems: [],

    resizeItems: [],

    resize: function (item) {
        var me = this;

        me.resizeItems.push(item);
    },


    ready:function(fun){
        var me = this;

        if (!Mini2.isFunction(fun)) {
            throw new Error('必须是指定 fun 函数对象.');
        }

        me.afterRenderItems.push(fun);
    },

    afterRender: function (item) {
        var me = this;

        if (!Mini2.isFunction( item.afterRender)) {
            throw new Error('这个对象不存在 afterRender 函数.');
        }

        me.afterRenderItems.push(item);

    },

    callItemResize:function(){
        "use strict";
        var me = Mini2.LoaderManager,
            item,
            resizeFn,
            i = 0,
            items = me.resizeItems,
            len = items.length;

        for (; i < len; i++) {
            item = items[i];
            resizeFn = item.resize;


            if (resizeFn) {
                resizeFn.call(item);
            }
        }
    },

    //页面第一次加载的时候，执行的函数
    preResizeFirst: function () {
        var me = Mini2.LoaderManager;

        me.callItemResize();
        setTimeout(me.callItemResize, 50);  //临时解决方法， 50毫秒后重新计算一次
    },


    // 定时器函数
    resizeTimer : null,    

    preResize: function () {
        var me = Mini2.LoaderManager;


        Mini2.awaitRun(me.muid, 100, me, function () {
            me.callItemResize();
            setTimeout(me.callItemResize, 50);  //临时解决方法， 50毫秒后重新计算一次
        });
    },


    preRenderComplete: function () {
        "use strict";
        var me = this,
            log = me.log,
            item,
            i=0,
            items = me.afterRenderItems,
            len = items.length;

        for (; i < len; i++) {
            item = items[i];

            if (Mini2.isFunction(item)) {
                item();
            }
            else if (item.afterRender) {
                item.afterRender.call(item);
            }
        }

        delete me.afterRenderItems;

        if (Mini2.data && Mini2.data.StoreManager) {
            Mini2.data.StoreManager.loader();
        }

        me.preResizeFirst();
        
        $(window).bind('resize', me.preResize);


    }

});


/*
* 加载管理器
*/
Mini2.ready = function (fn) {

    Mini2.LoaderManager.ready(fn);

}







/************************************************************************/
/*                                           */
/*    TweenManager.js                                                      */
/*                                           */
/************************************************************************/



/**
* 动画管理器
*/
Mini2.TweenManager = new function () {
    "use strict";

    var TweenManager = this;

    Mini2.apply(TweenManager, {

        log: Mini2.Logger.getLogger('Mini2.TweenManager'),  //日志管理器

        items: {},

        len: 0,

        /**
        * 运行中
        */
        isRunning : false,

        /**
        * 添加动画进程
        */
        add: function (tween) {
            var me = this,
                items = me.items,
                id = tween.muid;

            items[id] = tween;

            me.len++;

            if (!me.isRunning) {
                me.isRunning = true;
                requestAnimationFrame(function (time2) {
                    me.animate(time2);
                });
            }

            return me;
        },

        /**
        * 删除动画进程
        */
        remove: function (tween) {
            var me = this,
                items = me.items,
                id = tween.muid;

            if (items[id]) {
                delete items[id];

                me.len--;
            }

            return me;
        },

        animate:function(time){
            var me = this;

            if (me.len <= 0) {
                me.isRunning = false;
                return;
            }

            requestAnimationFrame(function (time2) {
                me.animate(time2);
            });

            TWEEN.update(time);
            
        }
        
        //requestAnimationFrame(animate);

        //    function animate(time) {
        //        requestAnimationFrame(animate);
        //        TWEEN.update(time);
        //    }
        


    });


}


/************************************************************************/
/*                                           */
/*    EventBuilder.js                                                      */
/*                                           */
/************************************************************************/



Mini2.define('Mini2.EventBuilder', {

    /**
    * 触发事件
    *
    * @param {String} eventName 事件名称
    * @parma {Object} data 事件附带的数据
    */
    trigger : function (eventName, data) {
        "use strict";
        var me = this,
            sender,
            i,
            event = '_EVENT_' + eventName,
            funs,
            fun,
            cancel;

        // console.debug('触发事件', eventName);
        funs = me[event];


        if (funs) {
            for (i = 0; i < funs.length; i++) {
                fun = funs[i];

                if (fun.sender) {
                    sender = fun.sender;
                    fun = fun.fun;
                }
                else {
                    sender = me;
                }

                cancel = fun.call(sender, data);

                if (true === cancel) {
                    break;
                }
            }
        }

        return cancel;
    },

    /**
    * 绑定事件
    *
    * @param {String} eventName 事件名称
    * @param {Object} trigger 触发源
    * @param {Function} fun 函数
    * 
    */
    on: function (eventName, sender, fun) {
        "use strict";
        var me = this,
            event = '_EVENT_' + eventName,
            funs = me[event];

        if (typeof sender === 'function') {
            fun = sender;
            sender = null;
        }

        if (!Mini2.isFunction(fun)) {
            throw new Error('必须指定一个函数类型.');
        }

        if (!funs) {
            me[event] = funs = [];
        }


        if (sender) {
            fun = {
                sender:sender,
                fun: fun
            };
        }

        funs.push(fun)

        return me;
    }
})


/************************************************************************/
/*                                           */
/*    EventHandler.js                                                      */
/*                                           */
/************************************************************************/

/// <reference path="define.js" />
/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.EventHandler', {

    listenerList: null,

    owner: null,

    //事件名
    eventName: '',

    //空事件
    isEmpty: false,


    /**
    * 添加回调函数
    *
    * @param {Function} fn 回调函数
    */
    addListener: function (fn) {

        var me = this;

        me.listenerList.push(fn);

    },

    /**
    * 删除回调函数
    *
    * @param {Function} fn 回调函数
    */
    removeListener: function (fn) {

        var me = this;

    },

    /**
    * 回调函数的数量
    *
    * @return {Number} 
    */
    getCount: function () {
        var me = this;

        return me.listenerList.length;

    },

    trigger: function (e) {
        "use strict";
        var me = this,
            i,
            fun,
            funList = me.listenerList,
            len = funList.length;

        e = e || {};

        e.sender = me.owner;

        //alert(me.eventName + " = " + fnList.length);

        for (i = 0; i < len; i++) {
            fun = funList[i];
            fun(e);
        }


        //        delete e;
    },

    /**
    * 绑定回调函数
    *
    */
    on: function (fn) {
        "use strict";
        var me = this;

        me.listenerList.push(fn);

        //console.log("EventHeadle.on(fn)    muid = " + me.muid);
    },

    un: Mini2.emptyFn

}, function () {
    var me = this;

    me.listenerList = [];

});

Mini2.employEventHandler = Mini2.create('Mini2.ui.EventHandler', { isEmpty: true });


/************************************************************************/
/*                                           */
/*    EventManager.js                                                      */
/*                                           */
/************************************************************************/

/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="define.js" />



Mini2.EventManager = new function () {
    "use strict";
    /// <summary>事件管理器</summary>

    var EventManager = this,
        doc = document,
        win = window;

    Mini2.apply(EventManager, {

        log: Mini2.Logger.getLogger('Mini2.EventManager'),  //日志管理器

        //控件
        con: null,

        //范围
        scope: null,

        data: null,

        //拖动
        drag: false,

        //鼠标最后动作时间
        lastTimeMouseAction: 0,

        //键盘最后动作时间
        lastTimeKeyAction: 0,

        //全部最后动作时间
        lastTimeAction: 0,




        /**
        * 设置鼠标最后执行时间
        */
        setMouseAction: function () {
            var me = this;
            me.lastTimeMouseAction = me.lastTimeAction = Mini2.Date.now();

        },

        //设置键盘最后执行时间
        setKeyAction:function(){
            var me = this;
            me.lastTimeKeyAction = me.lastTimeAction = Mini2.Date.now();

        },

        //设置活动
        setAction:function(){
            var me = this;
            me.lastTimeAction = Mini2.Date.now();

        },


        //是否活动状态
        isAction: function (timeSpan) {
            "use strict";
            var me = this,
                isInput = Mini2.ui.FocusMgr.isInputting(),
                lastTime = me.lastTimeAction,
                span;

            if (isInput) { return true; }
            
            timeSpan = timeSpan || 0;

            span = Mini2.Date.now() - lastTime - timeSpan;

            return (span <= 0);
        },


        stopEvent: function (e) {

            //log.begin("stopEvent(e)");
            e = e || window.event;

            if (e) {
                this.stopPropagation(e);
                this.preventDefault(e);
            }

            //log.end();
        },

        stopPropagation: function (e) {

            //log.debug("stopPropagation(e)");

            e = e || window.event;

            if (e.stopPropagation) {
                e.stopPropagation();
            }
            else {
                e.cancelBubble = false;
            }
        },

        preventDefault: function (e) {

            //log.debug("preventDefault(e)");

            e = e || window.event;

            if (e.preventDefault) {
                e.preventDefault();

            } else {
                e.returnValue = false;
            }
        },

        withinOne: function (el, related, allowEl) {
            "use strict";
            var me = this,
                objs ;

            if (allowEl && allowEl.el && typeof allowEl == 'object') {
                allowEl = allowEl.el;
            }


            if (allowEl) {

                if (el == allowEl || el === allowEl) {
                    return true;
                }

                //console.log("objs.length = ?");

                objs = $(allowEl).find(el);

                //console.log("objs.length = " + objs.length);

                return (objs.length > 0);
            }
        },

        within: function (el, related, allowEl) {
            "use strict";
            var me = this;

            if (el && el.el && typeof el == 'object') {
                el = el.el;
            }

            if (el) {

                if (allowEl instanceof Array) {

                    var allowEls = allowEl,
                        i = 0,
                        subEl,
                        isWithin;

                    for (; i < allowEls.length; i++) {

                        subEl = allowEls[i];

                        isWithin = me.withinOne(el, related, subEl);

                        if (isWithin) {
                            return true;
                        }
                    }

                }
                else {
                    return me.withinOne(el, related, allowEl);
                }
            }


            return false;

        },

        //查找父级范围
        offsetParent: function (elem) {
            "use strict";
            var el = $(elem),
                cls = 'mi-border-box',
                i = 0;

            if (el.hasClass(cls)) {
                return elem;
            }

            for (; i < 99; i++) {

                el = el.parent();

                if (el.hasClass(cls)) {

                    break;
                }
            }

            return el;
        },

        getBorderBox: function (con) {
            "use strict";
            var me = this,
                log = me.log;

            if (con == undefined || con == null) {
                return me;
            }

            if (con.toString() == '[object Window]') {
                con = window.document.body;
            }

            if (con && con.el) {

                if (con.el.jquery) {
                    con = con.el.get(0);
                }
                else if (Mini2.isDom(con.el)) {
                    con = con.el;
                }
            }

            if (!Mini2.isDom(con)) {
                return me;
            }

            var borderBox;


            if ($(con).hasClass("mi-border-box")) {
                //log.debug("自身是 mi-border-box");
                borderBox = $(con);
            }
            else {
                borderBox = me.offsetParent(con);
            }

            var eventMgr = null;

            if (borderBox.length) {
                eventMgr = borderBox.data("EVENT_MANAGER");

                if (!eventMgr) {

                    eventMgr = {
                        control: null,
                        data: null,
                        scope: null,
                        el: borderBox.get(0),
                        typeString: borderBox.get(0).toString(),
                        muid: "F_" + Mini2.getIdentity()
                    };

                    //log.debug("创建 eventMgr = " + eventMgr);
                    //$.data(borderBox, 'EVENT_MANAGER', eventMgr); 
                    borderBox.data("EVENT_MANAGER", eventMgr);
                }

                //log.end();
                return eventMgr;
            }

            //log.end();

            return me;
        },

        //当前控件
        curControl: function () {

            var me = this,
                mm = me.getBorderBox(con);

            return mm.con;
        },

        //清理
        clear: function (con) {

            //console.log("EventManager.clear()");

            var me = this,
                mm = me.getBorderBox(con);

            mm.con = null;
            mm.scope = null;

        },

        //设置有效范围
        setScope: function (con, scope) {
            var me = this,
                mm = me.getBorderBox(con);

            //console.log("setScope(); " + "scope = " + scope);

            mm.con = con;
            mm.scope = scope;
        },


        setKeyDown: function (con, e, scope) {

            var me = this,
                mm = this.getBorderBox(con);

            me.setKeyAction();

            if (mm.con != null) {
                return;
            }


            //console.log("EventManager.setKeyDown();  me.scope = " + me.scope);

            mm.con = con;
            mm.scope = scope;

            $(con).trigger('keydown', e);

            me.stopEvent(e);
        },

        setKeyUp: function (con, e) {
            "use strict";
            var me = this,
                allow,
                mm = this.getBorderBox(con);

            me.setKeyAction();

            allow = me.within(con, null, me.scope);




            if (allow) {

                $(con).trigger('keyup', e);
            }
            else {
                Mini2.ui.FocusMgr.setControl(con);
            }

            mm.con = null;

            me.stopEvent(e);

            //log.end();
        },

        setMouseDown: function (con, data, scope, event, continueEvent) {

            var me = this,
                log = me.log,
                mm = this.getBorderBox(scope || con);


            me.mousedownControl = con;

            me.setMouseAction();

            me.borderBox = mm;
            mm.mouseUp_repetition = 'no';

            if (mm.con != null) {
                return;
            }

            if (scope == undefined) {
                scope = con;
            }

            //log.begin("EventMgr.setMouseDown()");

            mm.con = con;
            mm.scope = scope;
            mm.data = data;


            if (con && !continueEvent) {
                me.stopEvent(event);
            }

            //log.end();
        },

        borderBox: null,

        setMouseMove: function (con, evt) {

            var me = this,
                log = me.log,
                mm = me.borderBox || this.getBorderBox(con),
                lastCon = mm.con,
                lastScope = mm.scope;

            me.setMouseAction();

            //log.debug('-------mouseUp :' + event.pageX);



            lastCon = lastCon || con;

            $(lastCon).triggerHandler('mu_mousemove', [evt, con]);
            
            //me.stopEvent(event);

        },

        setMouseUp: function (con, evt) {


            var me = this,
                log = me.log,
                con = con || me.mousedownControl,
                mm = me.borderBox || this.getBorderBox(con),
                lastCon = mm.con,
                lastScope = mm.scope;


            me.mousedownControl = null;

            me.setMouseAction();

            if (mm.con && mm.mouseUp_repetition == 'no') {
                mm.mouseUp_repetition = 'yes';

                //log.begin("EventMgr.setMouseUp()");

                $(mm.con).triggerHandler('mu_mouseup', [evt, con]);

                mm.con = null;
                mm.data = null;

                if (evt == null) {
                    log.error("没有事件啊", evt);
                }

                me.stopPropagation(evt);

                me.borderBox = null;

                //log.end();
            }


        },

        addListener: function (element, eventName, fn, scope, options) {


        },

        removeListener: function (element, eventName, fn, scope) {

        },

        //tab 按键触发
        tab: function (curTab) {
            var parent = curTab.ownerParent,
                nextItem = null;


            if (!parent) {
                return nextItem;
            }

            var pItems = parent.getTabItems();  //获取允许带 Tab 对象的


            var pLen = pItems.length;

            var curTabIndex = -1;

            for (var i = 0; i < pLen; i++) {
                var item = pItems[i];

                if (item === curTab) {
                    curTabIndex = i;

                    break;
                }
            }

            if (curTabIndex >= 0) {


                var nextTabIndex = curTabIndex + 1;

                if (nextTabIndex >= pLen) {
                    parent.focus();
                    return;
                }

                nextItem = pItems[nextTabIndex];

                try {

                    nextItem.focus();

                    //如果文本框，自动选择全部
                    if (nextItem.select) {
                        nextItem.select();
                    }
                }
                catch (ex) {
                    console.error('焦点属性赋值错误.', item);
                    console.log('pLen', pLen);
                }

            }

            return nextItem;
        }

    });



};

$(document).on('keydown',function (e) {
    "use strict";
    var keyCode = e.keyCode,
        log = Mini2.Logger,
        foucsCon = Mini2.ui.FocusMgr.lastActionControl,
        tagName = e.target.tagName,
        eventMgr = Mini2.EventManager,
        tabKeyCode = Mini2.SystemInfo.form.tabKeyCode || 9;


    eventMgr.setKeyAction();

    //console.log('foucsCon=', foucsCon);

    //console.log($.format('tagName={0}, keyCode={1}', tagName , keyCode));

    if (tagName == 'TEXTAREA') {
        return;
    }

    
    if (keyCode == tabKeyCode || keyCode === 9) {
        //eventMgr.stopEvent(e);

        return false;
    }

    //if (keyCode == tabKeyCode) {
    //    var data = Mini2.ui.FocusMgr.data;
               
        
    //    if (foucsCon != null) {

    //        var ea = {
    //            data: data,
    //            cancel: false
    //        };

    //        $(foucsCon).triggerHandler('keydown', ea);

    //        if (ea.cancel) {
    //            eventMgr.stopEvent(e);
    //            return;
    //        }
    //    }
        
    //    eventMgr.stopEvent(e);

    //    var nextCon = eventMgr.tab(foucsCon);
               
    //    if (nextCon) {
    //        return;
    //    }
    //}
    //else if (keyCode == 13) {

    //    eventMgr.stopEvent(e);
    //}


    /***************************************************************/

    //console.log("xxxxxxxxxxxxxxxxxxxxxxxxxx");


});


$(document).bind('keyup', function (e) {
    "use strict";
    var keyCode = e.keyCode,
        log = Mini2.Logger,
        foucsCon = Mini2.ui.FocusMgr.lastActionControl,
        tagName = e.target.tagName,
        eventMgr = Mini2.EventManager,
        tabKeyCode = Mini2.SystemInfo.form.tabKeyCode || 9;


    eventMgr.setKeyAction();

    if (tagName == 'TEXTAREA') {
        return;
    }


    if (keyCode == tabKeyCode || keyCode === 9) {
        var data = Mini2.ui.FocusMgr.data;


        if (foucsCon != null) {

            var ea = {
                data: data,
                cancel: false
            };

            $(foucsCon).triggerHandler('keyup', ea);

            if (ea.cancel) {
                eventMgr.stopEvent(e);
                return;
            }
        }

        eventMgr.stopEvent(e);

        var nextCon = eventMgr.tab(foucsCon);

        if (nextCon) {
            return;
        }
    }
   

    //////////////////////////////////

    var conME = foucsCon;

    var conEl = conEl;

    if (conME && conME.muid) {

    }
    else {

        var conEl = foucsCon;

        for (var i = 0; i < 99; i++) {

            conME = $(conEl).data('me');

            if (conME && conME.muid) {

                break;
            }

            conEl = $(conEl).parent();

        }
    }

    //log.debug("事件 conME.proKeyEvent = " + conME.proKeyEvent);
    //console.log(conME);

    if (conME && conME.proKeyEvent) {

        conME.proKeyEvent.call(conME, e);

    }

});


$(window)
.mousedown(function (e) {
    var eventMgr = Mini2.EventManager;

    eventMgr.setMouseAction();
})
.mouseup(function (e) {
    
    var keyCode = e.keyCode,
        foucsCon = Mini2.ui.FocusMgr.control,
        target = e.target,
        tagName = target.tagName,
        eventMgr = Mini2.EventManager;
    
    if (target && $(target).hasClass('mi-mask')) {
        eventMgr.stopEvent(e);
        return;
    }

    if (eventMgr.mousedownControl) {
        Mini2.ui.FocusMgr.setControl(eventMgr.mousedownControl);
    }
    else {
        Mini2.ui.FocusMgr.setControl(this);
    }

    eventMgr.setMouseUp(null, e);

    if (Mini2.ui && Mini2.ui.menu && Mini2.ui.menu.Manager) {
        Mini2.ui.menu.Manager.hideAll();
    }
})
.mousemove(function (e) {
    var me = this,
        eventMgr = Mini2.EventManager;

    eventMgr.setMouseMove(this, e);

});


/************************************************************************/
/*                                           */
/*    ModelManager.js                                                      */
/*                                           */
/************************************************************************/


/// <reference path="define.js" />
/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />

//焦点管理
Mini2.define("Mini2.ModelManager", {


    log: Mini2.Logger,  //日志管理器

    alternateClassName: 'Mini2.ModelMgr',

    typeName: 'mtype',

    singleton: true,

    types: {},

    create: function (config, name, id) {
        "use strict";
        var conObj,
            Con = (typeof name == 'function') ? name : this.types[name || config.name];

        conObj = new Con(config, id);

        return conObj;
    },



    registerType: function (name, config) {
        "use strict";
        /// <summary>注册类型</summary>

        //log.begin("ModelManager.registerType(...)   " + name);

        var proto = config.prototype,
            model;

        if (proto && proto.isModel) {
            model = config;
        }
        else {

            if (Mini2.String.isBlank(config.extend)) {
                config.extend = 'Mini2.data.Model';
            }

            model = Mini2.define(name, config);
        }


        this.types[name] = model;

        //log.end();

        return model;
    },



    getModel: function (id) {
        "use strict";
        var model = id;
        if (typeof model == 'string') {
            model = this.types[model];

            //if (model == null) {
            //    model = Mini2.create(id);
            //}
        }

        return model;
    }


});


/************************************************************************/
/*                                           */
/*    data/AbstractStore.js                                                */
/*                                           */
/************************************************************************/


/// <reference path="../Mini2.js" />
/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />


Mini2.define('Mini2.data.Store', {


    log: Mini2.Logger,  //日志管理器

    getNewRecords: function () {
        return [];
    },

    getUpdatedRecords: function() {
        return [];
    },

    getModifiedRecords : function(){
        //return [].concat(this.getNewRecords(), this.getUpdatedRecords());
    },

    getRemovedRecords: function() {
        return this.removed;
    },

    filter: function(filters, value) {

    },

    getCount: Mini2.emptyFn,

    removeAll: Mini2.emptyFn
});


/************************************************************************/
/*                                           */
/*    data/Errors.js                                                       */
/*                                           */
/************************************************************************/

/// <reference path="../Mini2.js" />
/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />


Mini2.define('Mini2.data.Errors', {

    extend: 'Mini2.collection.ArrayList',

    isValid: function() {
        return this.length === 0;
    },

    getByField: function (fieldName) {
        var errors = [],
            error, i;

        for (i = 0; i < this.length; i++) {
            error = this.items[i];

            if (error.field == fieldName) {
                errors.push(error);
            }
        }

        return errors;
    }

});


//定义异常信息集合
Mini2.define('Mini2.data.Invalids', {
    
    length: 0,

    items: []


});


/************************************************************************/
/*                                           */
/*    data/Field.js                                                        */
/*                                           */
/************************************************************************/

/// <reference path="../Mini2.js" />
/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />


Mini2.define('Mini2.data.Field', {

    isField: true,


    constructor: function (config) {

        var me = this;

        if (Mini2.isString(config)) {
            config = { name: config };
        }

        Mini2.apply(me, config);

    },

    dateFormat: null,

    dateReadFormat: null,

    dateWriteFormat: null,

    useNull: false,

    defaultValue: "",

    mapping: null,

    sortType: null,

    sortDir: "ASC",

    allowBlank: true,

    persist: true

}, function () {
    this.constructor(arguments[0]);
});


/************************************************************************/
/*                                           */
/*    data/Model.js                                                        */
/*                                           */
/************************************************************************/

/// <reference path="../Mini.js" />
/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />


//数据实体
Mini2.define('Mini2.data.Model', {



    //别名：数据记录
    alternateClassName: ['Mini2.data.Record'],

    persistenceProperty: 'data',

    log: Mini2.Logger.getLogger('Mini2.data.Model', false),  //日志管理器

    emptyData: [],

    idField: [],

    //锁的字段名称
    //lockedField:'',

    idProperty: 'id',

    dataSave: false,

    evented: false,

    isModel: true,

    editing: false,

    //已经修改
    //dirty: false,

    //新创建，但未保存
    //phantom: false,

    //锁行规则
    //lockedRule:false,

    //字段集合 []
    fields: false,
    
    //字段模式: fixed=固定模式, free=自由模式
    //固定模式,不允许没有字段的实体保存
    fieldModeId: 'fixed',

    modified: false,


    statics: {

        PREFIX: 'Mini-record',

        AUTO_ID: 1,

        EDIT: 'edit',

        REJECT: 'reject',

        COMMIT: 'commit',

        id: function (rec) {

        }
    },

    //构造函数
    //raw = 原数据,可不填写
    onInit: function (data, id, raw, convertedData) {
        "use strict";
        var me = this,
            log = me.log,
            passedId = (id || id === 0),
            hasId,
            fields,
            len,
            field,
            name,
            value,
            newId,
            persistenceProperty,
            idProperty = me.idProperty,
            idField = me.constructor.idField,
            lockedField = me.constructor.lockedField,
            i;

        me.id = me.muid;

        me.raw = raw || data;
        me.modified = {};

        me.data = data;
        me.dataSave = {};

        me.stores = [];


        fields = me.fields;

        for (i = 0, len = fields.length; i < len; i++) {
            field = new Mini2.data.Field(fields[i]);

            fields[i] = field;
        }

        me.fields = new Mini2.collection.ArrayList(fields);

        me.idField = idField;

        me.lockedField = lockedField;
        //log.end();

        me.initProperty();
    },


    /**
    * 把字段名映射为属性
    */
    initProperty: function () {
        var me = this,
            log = me.log,
            field,
            fields = me.fields,
            i,
            len = fields.length;

        if (Object.defineProperty) {

            for (i = 0; i < len; i++) {
                field = fields.get(i);

                if (!Mini2.isString(field.name) ) {
                    log.debug('无法自定义属性的字段: ', field);
                    continue;
                }

                if (Mini2.String.isBlank(field.name)) {
                    log.debug('无法自定义空字段的属性: ', field);
                    continue;
                }

                if (me[field.name]) {
                    continue;
                }

                try{
                    (function () {
                        var name = field.name;
                        Object.defineProperty(me, name, {
                            get: function () {
                                return me.get(name)
                            },
                            set: function (value) {
                                me.set(name, value);
                            }
                        });
                    })();

                }
                catch (ex) {
                    //console.error('自定义属性错误: ', field.name, ex);
                    //console.debug('自定义属性: ', field);
                }
            }
        }
        else {
            console.error("浏览器不支持 Object.defineProperty 函数.");
        }
    },

    inheritableStatics: {

        setFields: function (fields, idProperty, clientIdProperty) {

        },

        getFields: function () {
            return this.prototype.fields.items;
        }
    },

    _singleProp: {},

    isEqual: function (a, b) {
        "use strict";
        if (a instanceof Date && b instanceof Date) {
            return a.getTime() === b.getTime();
        }
        return a === b;
    },

    setFields: function (fields, idProperty, clientIdProperty) {
        "use strict";
        var me = this,
            log=  me.log,
            newField,
            idField,
            idFieldDefined = false,
            proto = me.prototype,
            prototypeFields = proto.fields,
            superFields = proto.superClass.fields,
            len,
            i;



        if (idProperty) {
            proto.idProperty = idProperty;
            idField = idProperty.isField ? idProperty : new Mini2.data.Field(idProperty);

        }
        if (clientIdProperty) {
            proto.clientIdProperty = clientIdProperty;
        }

        if (prototypeFields) {
            prototypeFields.clear();
        }
        else {
            prototypeFields = me.prototype.fields = new Mini2.collection.ArrayList();
        }


        if (superFields) {
            fields = superFields.items.concat(fields);
        }


        for (i = 0, len = fields.length; i < len; i++) {
            newField = new Mini2.data.Field(fields[i]);

            if (idField && ((newField.mapping && (newField.mapping === idField.mapping)) || (newField.name === idField.name))) {
                idFieldDefined = true;
                newField.defaultValue = undefined;
            }
            prototypeFields.add(newField);
        }


        if (idField && !idFieldDefined) {
            idField.defaultValue = undefined;
            prototypeFields.add(idField);
        }

        me.fields = prototypeFields;

        return prototypeFields;
    },

    //获取主键值
    getId: function () {
        "use strict";
        var me = this,
            idField = me.idField,
            id;

        if (!idField) {
            return null;
        }

        id = me.get(idField.name);

        if (id == undefined) {
            id = null;
        }

        return id;
    },

    get: function (field) {
        return this[this.persistenceProperty][field];
    },


    baseSet: function(fieldName, newValue){
        "use strict";
        var me = this,
            log = me.log,
            data = me[me.persistenceProperty],
            fieldModeId = me.fieldModeId,   // fixed=固定, free=自由
            fields = me.fields,
            modified = me.modified,
            single = Mini2.isString(fieldName),
            currentValue, field, idChanged, key, modifiedFieldNames, name, oldId,
            newId, value, values;

        if (undefined == fieldName) {
            throw new Error("没有指定字段名，无法对实体进行赋值");
        }


        if (single) {
            values = me._singleProp;
            values[fieldName] = newValue;
        }
        else {
            values = fieldName;
        }

        //log.debug("model : " + fieldName + " = " + newValue);

        for (name in values) {


            if (!values.hasOwnProperty(name)) {

                if ('fixed' == fieldModeId) {
                    continue;
                }
            }


            value = values[name];
            field = (fields ? fields.getByProp('name', name) : null);

            if (fields && field && field.convert) {
                value = field.convert(value, me);

                //                    log.debug("转换数据");
            }


            currentValue = data[name];

            //字符串会有以下问题。
            if ((currentValue == '' && value == null) ||
                (currentValue == null && value == '')) {
                continue;
            }

            if (me.isEqual(currentValue, value)) {
                continue; // new value is the same, so no change...
            }

            //me[name] = value;
            data[name] = value;
            (modifiedFieldNames || (modifiedFieldNames = [])).push(name);

            //log.debug("赋值: " + name + " = " + value);

            if (field && field.persist) {
                if (modified.hasOwnProperty(name)) {
                    if (me.isEqual(modified[name], value)) {

                        delete modified[name];

                        me.dirty = false;

                        for (key in modified) {
                            if (modified.hasOwnProperty(key)) {
                                me.dirty = true;
                                break;
                            }
                        }
                    }
                }
                else {
                    me.dirty = true;
                    modified[name] = currentValue;
                }
            }

            //log.debug("me.dirty = " + me.dirty);

        }

        if (single) {
            // cleanup our reused object for next time... important to do this before
            // we fire any events or call anyone else (like afterEdit)!
            delete values[fieldName];
        }

        //if (!me.editing) {
        //    log.debug('实体赋值失败:没有开启编辑状态 Model.beginEdit() 。');
        //}

        //log.debug("editing = " + me.editing + ", " + modifiedFieldNames + " = " + value);

        if (!me.editing && modifiedFieldNames) {
            //log.debug('触发 afterEdit 事件.', modifiedFieldNames);
            me.afterEdit(modifiedFieldNames);
        }

        if (me.editing && modifiedFieldNames) {
            //log.debug("触发 afterCommit 事件.", modifiedFieldNames);
            me.afterCommit(modifiedFieldNames);
        }


        return modifiedFieldNames || null;

    },

    set: function (fieldName, newValue) {
        var me = this;

        return me.baseSet(fieldName, newValue);
    },


    //调用数据仓库的某个函数
    callStore: function (fn) {
        "use strict";
        var args = [],
            stores = this.stores,
            i,
            j,
            len = stores.length,
            aLen = arguments.length,
            store;

        for (j = 0; j < aLen; j++) {
            args[j] = arguments[j];
        }

        args[0] = this;

        for (i = 0; i < len; ++i) {
            store = stores[i];

            if (store && Mini2.isFunction(store[fn])) {

                store[fn].apply(store, args);
            }
        }

    },

    //出现异常，产生的事件
    afterInvalid: function (fieldNames) {
        this.callStore('afterInvalid', fieldNames);
    },


    //修改后触发的事件
    //modifiedFieldNames : 修改的字段名集合
    afterEdit: function (modifiedFieldNames) {
        this.callStore('afterEdit', modifiedFieldNames);
    },

    //丢弃修改触发的事件
    afterReject: function () {
        this.callStore('afterReject');
    },

    //保存修改触发的事件
    //modifiedFieldNames : 修改的字段名集合
    afterCommit: function (modifiedFieldNames) {
        this.callStore('afterCommit', modifiedFieldNames);
    },


    //执行锁行规则。
    // 返回 true = 锁行,false = 不锁行
    execLockedRule: function () {
        "use strict";
        var me = this,
            lockedRule = me.lockedRule,
            result = false;


        if (lockedRule && lockedRule != '') {

            if (Mini2.isString(lockedRule)) {
                
                try {
                    result = eval(lockedRule);
                }
                catch (ex) {
                    log.debug('执行锁行规则错误:' + lockedRule);

                    throw new Error('执行锁行规则错误:' + lockedRule);
                }
            }
            else if (Mini2.isFunction(lockedRule)) {

                try {
                    result = lockedRule.call(me);
                }
                catch (ex) {
                    log.debug('执行锁行规则错误:' + lockedRule);

                    throw new Error('执行锁行规则错误:' + lockedRule);
                }

            }
        }

        return result;
    },


    //是否已经是锁住整个实体
    isLocked: function () {
        "use strict";
        var me = this,
            log = me.log,
            value,
            lockedField = me.lockedField,
            store = me.store;

        if (store && store.readOnly) {

            //log.debug("isLocked() ---- store.readOnly ", store.readOnly);
                       

            return true;
        }


        try {
            
            if (me.execLockedRule()) {

                //log.debug("isLocked() ---- me.execLockedRule() ", me.execLockedRule());

                return true;
            }
        }
        catch (ex) {
            console.error('执行锁行代码错误.' + ex.Message, ex);
        }


        if (lockedField) {
            value = me.get(lockedField);

            //log.debug("isLocked() ---- me.lockedField() ", value);


            return !!value;
        }
        //        if (me.get('COL_14') == '已收款') {
        //            return true;
        //        }

        return false;
    },

    //锁后, 排除的字段集合
    isLockedExclusionField:function(fieldName){
        var me = this,
            store = me.store,
            fs = store.lockedExclusionFields;

        if (fs) {

            var exist = Mini2.Array.contains(fs, fieldName);

            if (exist) {
                return true;
            }
        }

        return false;
    },


    //字段值是否已经锁住
    isLockedForField: function (fieldName) {
        var me = this;
        
        return false;
    },

    //字段是否无效，配合 UI 使用。
    isDisabledForField:function(fieldName){
        return false;
    },



    //开始编辑
    beginEdit: function () {
        "use strict";
        var me = this,
            key,
            data,
            o;


        //log.begin("Model.beginEdit();   " + me.editing);


        if (!me.editing) {
            me.editing = true;
            me.dirtySave = me.dirty;

            o = me[me.persistenceProperty];
            data = me.dataSave = {};
            for (key in o) {
                if (o.hasOwnProperty(key)) {
                    data[key] = o[key];
                }
            }

            o = me.modified;
            data = me.modifiedSave = {};
            for (key in o) {
                if (o.hasOwnProperty(key)) {
                    data[key] = o[key];
                }
            }
        }

        //log.end();
    },


    //取消编辑
    cancelEdit: function () {
        "use strict";
        var me = this,
            log = me.log;


        //log.debug("Mode.cancelEdit();   " + me.editing);

        if (me.editing) {
            me.editing = false;
            // reset the modified state, nothing changed since the edit began
            me.modified = me.modifiedSave;
            me[me.persistenceProperty] = me.dataSave;
            me.dirty = me.dirtySave;
            me.modifiedSave = me.dataSave = me.dirtySave = null;
        }
    },


    //结束编辑
    endEdit: function (silent, modifiedFieldNames) {
        "use strict";
        var me = this,
            dataSave,
            changed;

        //        log.begin("Model.endEdit();   " + me.editing);

        silent = silent === true;
        if (me.editing) {
            me.editing = false;
            dataSave = me.dataSave;
            me.modifiedSave = me.dataSave = me.dirtySave = null;
            if (!silent) {
                if (!modifiedFieldNames) {
                    modifiedFieldNames = me.getModifiedFieldNames(dataSave);
                }
                changed = me.dirty || modifiedFieldNames.length > 0;
                if (changed) {
                    me.afterEdit(modifiedFieldNames);

                }
            }
        }

        //        log.end();
    },

    //获取修改过的字段名集合
    getModifiedFieldNames: function (saved) {
        "use strict";
        var me = this,
            data = me[me.persistenceProperty],
            modified = [],
            key;

        saved = saved || me.dataSave;
        for (key in data) {
            if (data.hasOwnProperty(key)) {
                if (!me.isEqual(data[key], saved[key])) {
                    modified.push(key);
                }
            }
        }
        return modified;
    },



    getChanges: function () {
        "use strict";
        var modified = this.modified,
            changes = {},
            field;

        for (field in modified) {
            if (modified.hasOwnProperty(field)) {
                changes[field] = this.get(field);
            }
        }

        return changes;
    },


    //丢弃修改
    reject: function (silent) {
        "use strict";
        var me = this,
            modified = me.modified,
            field;

        for (field in modified) {
            if (modified.hasOwnProperty(field)) {
                if (typeof modified[field] != "function") {
                    me[me.persistenceProperty][field] = modified[field];
                }
            }
        }

        me.dirty = false;
        me.editing = false;
        me.modified = {};

        if (silent !== true) {
            me.afterReject();
        }
    },


    //设为正常状态
    commit: function (silent, modifiedFieldNames) {
        "use strict";
        var me = this,
            modified = me.modified;

        me.phantom = me.dirty = me.editing = false;

        //me.modified = {};

        if (modified && modifiedFieldNames) {

            for (var i = 0; i < modifiedFieldNames.length; i++) {
                var field = modifiedFieldNames[i];

                if (modified.hasOwnProperty(field)) {
                    delete modified[field];
                }
            }

        }

        if (true !== silent) {

            me.afterCommit(modifiedFieldNames);
        }
    },


    //判断字段已修改
    isModified: function (fieldName) {
        "use strict";
        return this.modified.hasOwnProperty(fieldName);
    },


    //关联数据仓库对象
    joinStore: function (store) {
        "use strict";
        /// <summary>连接数据仓库，作为联动用。</summary>

        var me = this;

        // Code for the 99% use case using fast way!
        if (!me.stores.length) {
            me.stores[0] = store;
        } else {
            Mini2.Array.include(this.stores, store);
        }

        /**
        * @property {Ext.data.Store} store
        * The {@link Ext.data.Store Store} to which this instance belongs. NOTE: If this
        * instance is bound to multiple stores, this property will reference only the
        * first. To examine all the stores, use the {@link #stores} property instead.
        */
        this.store = this.stores[0]; // compat w/all releases ever
    },


    //断开关联数据仓库对象
    unjoinStore: function (store) {
        "use strict";
        Mini2.Array.remove(this.stores, store);
        this.store = this.stores[0] || null; // compat w/all releases ever
    },


    //错误信息
    errors: false,



    //创建异常信息
    //消息格式 {field:'字段名', message:'消息', level:'ALL'}
    markInvalid: function (error) {
        "use strict";
        var me = this,
            errors = me.errors,
            items,
            item,
            field = error.field,
            fields = [field];

        if (!errors) {
            me.errors = errors = {
                length: 0,
                items: {}
            };
        }

        items = errors.items;
        item = items[field];

        if (!item) {
            items[field] = item = [];
        }

        item.push(error);

        errors.length++;

        try {
            me.afterInvalid(fields);
        }
        catch (ex) {
            console.error("调用错误: Model.afterInvalid(error)\n" + ex.Message,ex);
        }
    },


    /**
    * 清理全部异常信息
    **/
    clearInvalidAll: function () {
        var me = this;

        if (me.errors) {
            
            var fields = [];

            for (var field in me.errors) {
                fields.push(field);
            }

            delete me.errors;

            me.afterInvalid(fields);
        }

    },

    //清理异常信息
    clearInvalid: function (field) {
        "use strict";
        var me = this,
            errors = me.errors;

        if (errors) {
            if (field) {
                delete errors.items[field];

                me.afterInvalid(fields);
            }
            else {
                delete me.errors;
                me.errors = false;

                me.afterInvalid(fields);
            }
        }
    },

    //按字段获取错误消息集合
    getErrors: function (fieldName) {
        "use strict";
        var me = this,
            errors = me.errors,
            items,
            error;

        try {
            if (errors) {
                items = errors.items;
                error = items[fieldName];
            }
        } catch (ex) {
            alert(ex.Message);
        }

        return error;
    },


    //验证数据
    isValid: function () {
        return this.validate().isValid();
    },



    //验证
    validate: function () {
        "use strict";
        var me = this,
            errors = new Mini2.data.Errors(),
            validations = me.validations,
            validators = Mini2.data.validations,
            length, validation, field, valid, type, i;


        if (validations) {
            length = validations.length;

            for (i = 0; i < length; i++) {
                validation = validations[i];
                field = validation.field || validation.name;
                type = validation.type;
                valid = validators[type](validation, me.get(field));

                if (!valid) {
                    errors.add({
                        field: field,
                        message: validation.message || validators[type + 'Message']
                    });
                }
            }
        }

        return errors;
    },

    //释放内存
    dispose: function () {
        var me = this;

        if (!me.isDisposed) {
            me.isDisposed = true;

            //delete me.data;
            //delete me.raw;
            //delete me.fields;
            //delete me.modified;
            //delete me.idField;
            //delete me.lockedField;
            //delete me.dataSave;
            //delete me.stores;

        }

    }

}, function () {
    var me = this;

    me.muid = Mini2.newId();

    //Mini2.apply(me, arguments[0]);
    me.onInit(arguments[0]);


});


//自由实体
Mini2.define('Mini2.data.FreeModel', {

    extend: 'Mini2.data.Model',

    fieldModeId: 'free'

        
});

Mini2.ModelManager.registerType('Mini2.data.FreeModel', Mini2.create('Mini2.data.FreeModel'));


Mini2.define('Mini2.data.ModelX', {

    extend: 'Mini2.data.Model',
    

    //lockedRule:'',


    //字段值是否已经锁住
    isLockedForField: function (fieldName) {
        var me = this;

        //if ('COL_4' == fieldName) {

        //    var v = me.get('COL_2');

        //    if (v == '123') {
        //        return true;
        //    }
        //}

        return false;
    },

    //字段是否无效，配合 UI 使用。
    isDisabledForField: function (fieldName) {
        var me = this;

        if ('COL_4' == fieldName) {

            if (me.get('COL_2') == '123') {
                return true;
            }

        }

        return false;
    },


    //设置字段值
    set: function (fieldName, newValue) {
        var me = this,
            result ;

        result = me.baseSet(fieldName, newValue);



        return result;
    }

});


/************************************************************************/
/*                                           */
/*    data/Validations.js                                                  */
/*                                           */
/************************************************************************/


Mini2.define('Mini2.data.Validations', {
    singleton: true,

    /**
    * @property {String} presenceMessage
    * The default error message used when a presence validation fails.
    */
    presenceMessage: 'must be present',

    /**
    * @property {String} lengthMessage
    * The default error message used when a length validation fails.
    */
    lengthMessage: 'is the wrong length',

    /**
    * @property {String} formatMessage
    * The default error message used when a format validation fails.
    */
    formatMessage: 'is the wrong format',

    /**
    * @property {String} inclusionMessage
    * The default error message used when an inclusion validation fails.
    */
    inclusionMessage: 'is not included in the list of acceptable values',

    /**
    * @property {String} exclusionMessage
    * The default error message used when an exclusion validation fails.
    */
    exclusionMessage: 'is not an acceptable value',

    /**
    * @property {String} emailMessage
    * The default error message used when an email validation fails
    */
    emailMessage: 'is not a valid email address',

    /**
    * @property {RegExp} emailRe
    * The regular expression used to validate email addresses
    */
    emailRe: /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,

    /**
    * Validates that the given value is present.
    * For example:
    *
    *     validations: [{type: 'presence', field: 'age'}]
    *
    * @param {Object} config Config object
    * @param {Object} value The value to validate
    * @return {Boolean} True if validation passed
    */
    presence: function (config, value) {
        // No configs read, so allow just value to be passed
        if (arguments.length === 1) {
            value = config;
        }

        //we need an additional check for zero here because zero is an acceptable form of present data
        return !!value || value === 0 || value === false;
    },

    /**
    * Returns true if the given value is between the configured min and max values.
    * For example:
    *
    *     validations: [{type: 'length', field: 'name', min: 2}]
    *
    * @param {Object} config Config object
    * @param {String} value The value to validate
    * @return {Boolean} True if the value passes validation
    */
    length: function (config, value) {
        if (value === undefined || value === null) {
            return false;
        }

        var length = value.length,
            min = config.min,
            max = config.max;

        if ((min && length < min) || (max && length > max)) {
            return false;
        } 
        else {
            return true;
        }
    },

    /**
    * Validates that an email string is in the correct format
    * @param {Object} config Config object
    * @param {String} email The email address
    * @return {Boolean} True if the value passes validation
    */
    email: function (config, email) {
        return Mini2.data.Validations.emailRe.test(email);
    },

    /**
    * Returns true if the given value passes validation against the configured `matcher` regex.
    * For example:
    *
    *     validations: [{type: 'format', field: 'username', matcher: /([a-z]+)[0-9]{2,3}/}]
    *
    * @param {Object} config Config object
    * @param {String} value The value to validate
    * @return {Boolean} True if the value passes the format validation
    */
    format: function (config, value) {
        return !!(config.matcher && config.matcher.test(value));
    },

    /**
    * Validates that the given value is present in the configured `list`.
    * For example:
    *
    *     validations: [{type: 'inclusion', field: 'gender', list: ['Male', 'Female']}]
    *
    * @param {Object} config Config object
    * @param {String} value The value to validate
    * @return {Boolean} True if the value is present in the list
    */
    inclusion: function (config, value) {
        return config.list && Mini2.Array.indexOf(config.list, value) != -1;
    },

    /**
    * Validates that the given value is not present in the configured `list`.
    * For example:
    *
    *     validations: [{type: 'exclusion', field: 'username', list: ['Admin', 'Operator']}]
    *
    * @param {Object} config Config object
    * @param {String} value The value to validate
    * @return {Boolean} True if the value is not present in the list
    */
    exclusion: function (config, value) {
        return config.list && Mini2.Array.indexOf(config.list, value) == -1;
    }
});


/************************************************************************/
/*                                           */
/*    data/ResultSet.js                                                    */
/*                                           */
/************************************************************************/



Mini2.define('Mini2.data.ResultSet', {

    loaded: true,

    count: 0,

    total: 0,

    success: false,

    constructor: function (config) {
        Mini2.apply(this, config);

        /**
        * @property {Number} totalRecords
        * Copy of this.total.
        * @deprecated Will be removed in Ext JS 5.0. Use {@link #total} instead.
        */
        this.totalRecords = this.total;

        if (config.count === undefined) {
            this.count = this.records.length;
        }
    }

});


/************************************************************************/
/*                                           */
/*    data/Field.js                                                        */
/*                                           */
/************************************************************************/

/// <reference path="../Mini2.js" />
/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />


Mini2.define('Mini2.data.Field', {

    isField: true,


    constructor: function (config) {

        var me = this;

        if (Mini2.isString(config)) {
            config = { name: config };
        }

        Mini2.apply(me, config);

    },

    dateFormat: null,

    dateReadFormat: null,

    dateWriteFormat: null,

    useNull: false,

    defaultValue: "",

    mapping: null,

    sortType: null,

    sortDir: "ASC",

    allowBlank: true,

    persist: true

}, function () {
    this.constructor(arguments[0]);
});


/************************************************************************/
/*                                           */
/*    data/StoreManager.js                                                 */
/*                                           */
/************************************************************************/


/// <reference path="../Mini2.js" />
/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />


Mini2.define('Mini2.data.StoreManager', {

    singleton: true,

    log: Mini2.Logger.getLogger('Mini2.data.StoreManager'),

    data: [],

    lookup: function (store) {

        var me = this,
            storeObj = store;

        if (typeof store == 'string') {
            storeObj = me.lookup_ForId(store);
        }

        return storeObj;
    },

    lookup_ForId: function (storeId) {
        var me = this,
            i,
            data = me.data,
            len = data.length,
            store;

        for (i = 0; i < len; i++) {

            store = data[i];

            if (storeId == store.storeId) {

                return store;
            }

        }

        return null;
    },

    //加载以后触发的事件
    loader: function () {
        var me = this,
            i,
            data = me.data,
            len = data.length,
            store;

        for (i = 0; i < len; i++) {
            store = me.data[i];

            store.onLoader();
        }

    },

    regStore: function (store) {

        var me = this,
            data = me.data;

        data.push(store);

    }
});


/************************************************************************/
/*                                           */
/*    data/Store.js                                                        */
/*                                           */
/************************************************************************/



/// <reference path="../Mini.js" />

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="StoreManager.js" />
/// <reference path="../lang/Array.js" />


Mini2.define('Mini2.data.Store', {

    log: Mini2.Logger.getLogger('Mini2.data.Store',false),
        
    storeId: false,

    /**
    * 全部提交.
    * smaple | full
    */
    jsonMode: 'sample',
    
    isStore:true,

    /**
     * 增量加载模式
     */
    isIncr : false,

    //自动加载数据
    autoLoad: true,

    /**
    * 自动触发回调函数. 默认 true
    */
    autoCallback:true,

    //自动同步
    autoSync: true,


    autoSyncSuspended: false,

    //远程排序参数
    remoteSort: false,

    //远程过滤参数
    remoteFilter: false,

    //远程分组参数
    remoteGroup: false,

    //
    groupField: undefined,

    //"ASC" and "DESC".
    groupDir: "ASC",

    sorters: false,


    pageSize: 65535,

    //当前页码
    currentPage: 0,

    //已缓冲, 默认 false
    buffered: false,

    data: false,

    //fields: [],

    //idField : '',  //组件字段

    //lockedField:'' ,//锁字段，不允许修改

    //锁后, 排序的字段集合
    //lockedExclusionFields:false,


    //代理器
    proxy: {},

    modelDefaults: null,

    //数据实体模型
    model: null,

    //数据仓库内部的实体对象
    implicitModel: false,

    //是否已经加载了数据
    isLoadData: false,


    totalCount: 0,


    //自动提交保存到服务器
    autoSave: true,

    //虚拟的数量，也就是分页中的总数量
    vTotalCount: -1,

    //特殊汇总字段
    summary: false,

    //自动焦点触发
    autoFocus: true,

    //当前焦点行
    //current 

    //当前焦点行的索引
    //currentIndex

    /* requestOperation 请求的参数 */

    
    on: function (eventName, data, scope) {
        "use strict";
        /// <summary>绑定事件</summary>
        var me = this;

        if (me.isLoadData) { return me; }

        $(me).triggerHandler(eventName, data);

        return me;
    },



    intiSorters: function () {
        "use strict";
        var me = this,
            sorters = me.sorters;

        me.sorters = new Mini2.collection.ArrayList(false, function (item) {
            return item.id || item.property;
        });

        if (sorters) {
            me.sorters.addAll(me.decodeSorters(sorters));
        }


    },

    //创建隐形实体
    createImplicitModel: function () {
        "use strict";
        var me = this,
            name = me.modelName,
            fields = me.fields,
            newModelId;

        if (!me.model && fields) {

            newModelId = 'Mini2.data.Store.ImplicitModel_' + (me.storeId || Mini2.newId());


            me.model = Mini2.define(newModelId, {
                name: name,
                extend: 'Mini2.data.ModelX',
                fields: fields
            });

            delete me.fields;
            me.implicitModel = true;
        }
    },

    //创建初始化数据集
    createInlineData: function () {
        "use strict";
        var me = this,
            log = me.log,
            model = me.model,
            i,
            config,
            record,
            data = me.data,
            len ;

        if (data ) {

            len = data.length;

            for (i = 0; i < len; i++) {
                config = data[i];
                
                record = Mini2.ModelManager.create(config, model);

                record.joinStore(me);

                data[i] = record;
            }
        }

        me.inlineData = data;
        delete me.data;

        //log.debug('封装 data', data);
        me.data = new Mini2.collection.ArrayList(me.inlineData);

        //log.debug('封装后 data', me.data);

        me.updateRecordsIndex();
    },

    preInit: function (config) {
        "use strict";

        var me = this,
            modelName,
            model = me.model,
            log = me.log;


        if (me.storeId) {
            //log.debug("Mini2.data = " + Mini2.data);
            Mini2.data.StoreManager.regStore(me);
        }

        me.removed = [];


        if (Mini2.isBlank(model)) {

            model = Mini2.ModelManager.getModel('Mini2.data.FreeModel');

        }
        else {

            if (Mini2.isString(model)) {
                modelName = model;
                me.modelName = modelName;
            }

            model = Mini2.ModelManager.getModel(model);

            if (model) {
                model.prototype.name = modelName;
            }
        }

        me.model = model;

        me.intiSorters();

        me.createImplicitModel();   //创建隐形实体


        if (!me.disableMetaChangeEvent) {
            //原：me.proxy.on('metachange', me.onMetaChange, me);



            var i,
                len,
                fields ,
                idField, newField,
                prototypeFields = new Mini2.collection.ArrayList(false, function (field) {
                    return field.name;
                });

            fields = me.model.prototype.fields;
            

            for (i = 0, len = fields.length; i < len; i++) {
                newField = new Mini2.data.Field(fields[i]);

                if (idField && ((newField.mapping && (newField.mapping === idField.mapping)) || (newField.name === idField.name))) {
                    idFieldDefined = true;
                    newField.defaultValue = undefined;
                }
                prototypeFields.add(newField);
            }

            me.model.prototype.constructor['fields'] = prototypeFields;

            if (me.idField) {
                var idField = new Mini2.data.Field(me.idField);
                me.model.prototype.constructor['idField'] = idField;

                delete me.idField;
            }

            if (me.lockedField) {

                me.model.prototype.constructor['lockedField'] = me.lockedField;

                delete me.lockedField;
            }

            if (me.lockedRule) {

                me.model.prototype.lockedRule = me.lockedRule;
                delete me.lockedRule;
            }

        }


        me.createInlineData();  //创建初始化数据集

        me.createBindEvent();

        if (me.totalCount <= 0) {
            me.totalCount = me.data.getCount();
        }
    },



    //设置汇总字段值
    setSummary: function (field, value) {
        "use strict";
        var me = this,
            i,
            summary = me.summary || {};

        if (!me.summary) {
            me.summary = summary;
        }

        if (Mini2.isString(field)) {
            summary[field] = value;

            i = {};
            i[field] = value;

            me.on('summarychnaged', [i]);
        }
        else {
            for (i in field) {
                summary[i] = field[i];
            }

            me.on('summarychnaged', [field]);
        }


        return me;
    },

    //获取汇总字段值
    getSummary: function (field) {
        "use strict";
        var me = this,
            summary = me.summary || {};

        if (arguments.length) {
            return summary[field];
        }

        return summary;
    },



    //设置当前页码
    setCurrentPage: function (page) {
        this.currentPage = page;
    },

    //获取当前页码
    getCurrentPage: function () {
        return this.currentPage;
    },

    //更新数据的标记,用于触发自动保存的时候.
    //updated_tag: false,


    //循环调用
    loopSaveAll: function () {
        "use strict";
        var me = this,
            log = me.log;

        if (!me.autoCallback) {
            return;
        }

        Mini2.awaitRun( me.muid, 500, me, function () {

            var fields = me.getUpdatedRecords();

            if (0 == fields.length) {
                return;
            }


            try {

                var widget = window.widget1;

                if (widget && widget.subMethod) {
                    try {
                        widget.subMethod($('form:first'), {
                            subName: me.id,
                            subMethod: 'SaveAll'
                        });
                    }
                    catch (ex) {
                        console.error("提交失败", ex);
                        alert('提交失败:' + ex.message);
                    }
                }
            }
            catch (ex) {
                log.debug("error:" + ex.message);
            }

        });
        



        //setTimeout(function () {

        //    if (!me.updated_tag) {
        //        return;
        //    }

        //    me.updated_tag = false;

        //    try {
        //        var fields = me.getUpdatedRecords();

        //        if (0 == fields.length) {
        //            return;
        //        }

        //        var widget = window.widget1;
        //        if (widget && widget.subMethod) {
        //            try {
        //                widget.subMethod($('form:first'), {
        //                    subName: me.id,
        //                    subMethod: 'SaveAll'
        //                });
        //            }
        //            catch (ex) {
        //                console.error("提交失败", ex);
        //                alert('提交失败:' + ex.message);
        //            }
        //        }
        //    }
        //    catch (ex) {
        //        log.debug("error:" + ex.message);
        //    }


        //    me.loopSaveAll();

        //},1000);
    },



    //创建绑定事件,配合服务器控件使用
    createBindEvent: function () {
        "use strict";
        var me = this;

        if (me.autoSave) {

            $(me).muBind('update', me, function () {

                //var fields = me.getUpdatedRecords();
                //if (0 == fields.length) {
                //    return;
                //}

                //me.updated_tag = true;

                me.loopSaveAll();

            });
        }
    },




    updateRecordsIndex: function () {
        "use strict";
        var me = this,
            i = 0,
            record,
            data = me.data,
            count = data.getCount();

        for (; i < count ; i++) {

            record = data.get(i);
            record.index = i;
        }
    },


    //记录恢复为正常状态触发的事件
    afterCommit: function (record, modifiedFieldNames) {
        "use strict";

        var me = this;

        if (!modifiedFieldNames) {
            modifiedFieldNames = null;
        }

        //alert("update");

        me.on('update', [record, 'COMMIT', modifiedFieldNames]);

        //me.on('update', this, record, Ext.data.Model.COMMIT, modifiedFieldNames);
    },


    //根据id，设置记录为焦点行
    setCurrntForId: function (id) {
        "use strict";
        var me = this,
            rect;

        rect = me.getById(id);
                
        me.setCurrent(rect);

        return !!rect;
    },

    //给外部作为手动触发事件
    onCurrentChanged:function(){
        "use strict";
        var me = this,
            log = me.log,
            cur = me.current,
            curIndex = me.currentIndex;
        
        me.on('currentchanged', [curIndex, cur]);

    },


    __lastCurIndex :-1,

    //设置当前焦点行
    setCurrent: function (index,isTriggerSer) {
        "use strict";
        var me = this,
            log = me.log,
            cur,
            curIndex,
            list,
            data = me.data;



        log.debug("设置当前焦点行 setCurrent({0})", index);
        log.debug("记录数量", data.length);

        if (undefined == data || data.length == 0) {

            me.current = null;
            me.currentIndex = -1;

            log.debug("setCurrent(...) 触发 currentchange 事件");

            me.on('currentchanged', [me.currentIndex, me.current]);


            log.debug("isTriggerSer = ", isTriggerSer);


            if (me.currentChanged) {
                me.currentChanged.call(me);
            }

            return;
        }

        if (Mini2.isNumber(index)) {

            cur = data.get(index);
            curIndex = index;
        }
        else {

            list = data.filterBy(function (rec) {
                if (rec == index) {
                    return true;
                }

                return false;
            });

            if (list.length > 0) {
                cur = list.get(0);

                curIndex = cur.index;
            }
            else {
                cur = null;
                curIndex = -1;
            }
        }

        me.current = cur;
        me.currentIndex = curIndex;


        me.on('currentchanged', [curIndex, cur]);

        if (me.__lastCurIndex !== curIndex) {

            me.__lastCurIndex = curIndex;

            if (me.currentChanged) {
                me.currentChanged.call(me);
            }
        }
    },


    //获取当前焦点对象
    getCurrent: function () {
        var me = this;

        return me.current;
    },

    //获取当前焦点对象的索引值
    getCurrentIndex: function () {
        "use strict";
        var me = this;

        return me.currentIndex;
    },


    //更改全部记录为正常状态
    commitChanges: function () {
        "use strict";
        var me = this,
            recs = me.getModifiedRecords(),
            len = recs.length,
            i = 0;

        for (; i < len; i++) {
            recs[i].commit();
        }

        // Since removals are cached in a simple array we can simply reset it here.
        // Adds and updates are managed in the data MixedCollection and should already be current.
        me.removed.length = 0;
    },


    //根据 muid ，更改记录某些字段为正常状态
    commitChangesForMuid: function (muid, modifiedNames) {
        "use strict";
        var me = this,
            data = me.data,
            record,
            index;

        index = data.findIndexBy(function (record) {
            if (record.muid == muid) {
                return true;
            }
        });

        if (index == -1) {
            console.debug('没有找打需要修改的记录, muid=', muid);
            return;
        }

        record = data.get(index);

        record.commit(null, modifiedNames);

    },


    //添加记录。可以是对象，或集合
    add: function (arg) {
        "use strict";
        var me = this,
            records,
            length, isSorted;

        if (Mini2.isArray(arg)) {
            records = arg;
        }
        else {
            records = arguments[0];
        }


        length = records.length;

        //records = me.insert(me.data.length, records);
        records = me.insert(1000000, records);


        return records;
    },


    load: function (options) {
        "use strict";
        /// <summary>加载数据</summary>

        var me = this;

        me.lastOptions = Mini2.apply({
            action: 'read',
            sorters: me.getSorters()
        }, options);

        me.on('load', [me]);

    },

    //过滤器：
    filterNewOnly: function (item) {
        return item.phantom === true;
    },


    //过滤器：
    filterNew: function (item) {
        return item.phantom === true && item.isValid();
    },


    //过滤器：
    filterUpdated: function (item) {
        //return item.dirty === true && item.phantom !== true && item.isValid();

        return item.dirty === true && item.phantom !== true;
    },


    //获取新建的记录集合
    getNewRecords: function () {
        return this.data.filterBy(this.filterNew);
    },


    //获取更新的记录集合
    getUpdatedRecords: function () {
        return this.data.filterBy(this.filterUpdated);
    },

    //获取删除的记录集合
    getRemovedRecords: function () {
        return this.removed;
    },


    //同步过程
    sync: function (options) {
        "use strict";
        var me = this,
            operations = {},
            toCreate = me.getNewRecords(),
            toUpdate = me.getUpdatedRecords(),
            toDestroy = me.getRemovedRecords(),
            needsSync = false;

        if (toCreate.length > 0) {
            operations.create = toCreate;
            needsSync = true;
        }

        if (toUpdate.length > 0) {
            operations.update = toUpdate;
            needsSync = true;
        }

        if (toDestroy.length > 0) {
            operations.destroy = toDestroy;
            needsSync = true;
        }

        //alert("needsSync = " + needsSync);

        if (needsSync && me.on('beforesync', operations) !== false) {
            options = options || {};

            //            me.proxy.batch(Ext.apply(options, {
            //                operations: operations,
            //                listeners: me.getBatchListeners()
            //            }));
        }

        return me;
    },


    //按 id 删除记录
    removeById: function (id, silent) {
        "use strict";
        //log.debug("按 id 删除记录.");

        var me = this,
            log = me.log,
            list,
            data = me.data;


        if (!Mini2.isArray(id)) {
            id = [id];
        }

        list = data.filterBy(function (record) {
            return Mini2.Array.contains(id, record.getId(), true);
        });

        //log.debug("删除 " + list.length + " 记录");

        me.remove(list, false, silent);
        
        me.disposeModels(list); //释放实体的内存

        return list;
    },


    removeByMuid: function (muid, silent) {
        "use strict";
        /// <summary>按 muid 删除记录</summary>

        //log.debug("按 muid 删除记录.");

        var me = this,
            list,
            data = me.data;

        if (!Mini2.isArray(muid)) {
            muid = [muid];
        }

        list = data.filterBy(function (record) {
            return Mini2.Array.contains(muid, record.muid);
        });


        me.remove(list, false, silent);
        
        me.disposeModels(list); //释放实体的内存

        return list;
    },

    //释放记录对象
    disposeModels: function (records) {
        "use strict";
        var me = this,
            record,
            len,
            i = 0;

        if (records && Mini2.isArray(records)) {
            len = records.length;
            for (i; i < len; i++) {
                record = records[i];

                if (record && record.isModel) {
                    record.dispose();
                }
            }
        }
    },


    removeAll: function (silent) {
        "use strict";
        var me = this,
            snapshot = me.snapshot,
            data = me.data,
            list;

        me.__lastCurIndex = -1;

        if (snapshot) {
            snapshot.removeAll(data.getRange());
        }

        list = me.remove({
            start: 0,
            end: me.getCount() - 1
        }, false, silent);



        if (silent !== true) {
            me.on('clear', me);

            me.onDataChanged();
        }

        me.disposeModels(list); //释放实体的内存

        return me;
    },

    /**
     * 当前加载的数据
     */
    curLoadData : null,

    beginLoadData: function () {
        "use strict";
        var me = this;

        me.isLoadData = true;

        me.curLoadData = [];

        me.onBeginLoaded();

        return me;
    },

    endLoadData: function () {
        var me = this,
            log = me.log;

        if (me.isLoadData) {

            me.isLoadData = false;
            me.onLoad();

            //me.on('add', [10000000, me.curLoadData]);

            me.onDataChanged();

            try {


                if (me.autoFocus) {
                    me.setCurrent(me.currentIndex || 0);
                }
            }
            catch (ex) {
                console.error('自动设置焦点行错误', ex);
            }

            me.onEndLoaded();
        }

        return me;
    },

    onBeginLoaded:function(){
        var me = this;

        try{
            me.on('beginloaded',me);
        }
        catch (ex) {
            console.error('触发 onBeginLoaded 错误', ex);
        }

    },

    onEndLoaded: function () {
        var me = this;


        try {
            me.on('endloaded', me);
        }
        catch (ex) {
            console.error('触发 onEndLoaded 错误', ex);
        }

    },


    onDataChanged: function () {
        "use strict";
        var me = this,
            log = me.log;



        if (me.getCount() > me.totalCount) {
            me.totalCount = me.getCount();
        }

        log.debug("触发 onDataChanged 事件。");

        try {
            me.on('datachanged', me);
        }
        catch (ex) {
            console.error('触发 onDataChanged 错误', ex);
        }
    },

    onLoad: function () {
        var me = this;

        try{
            me.on('load', me);
        }
        catch (ex) {
            console.error('触发 onLoad 错误', ex);
        }
    },


    //删除记录，或范围
    //返回：被删除的对象。
    remove: function (records, /* private */isMove, silent) {
        "use strict";
        isMove = isMove === true;

        var me = this,
            sync = false,
            snapshot = me.snapshot,
            data = me.data,
            i = 0,
            length,
            info = [],
            allRecords = [],
            indexes = [],
            item,
            isNotPhantom,
            index,
            record,
            removeRange,
            removeCount,
            resultItems = [];

        //fireRemoveEvent = !silent && me.hasListeners.remove;

        // Remove a single record
        if (records.isModel) {
            records = [records];
            length = 1;
        }

        if (records.isModel) {
            records = [records];
            length = 1;

        }
        else if (Mini2.isIterable(records)) {

            if (records.toArray) {
                records = records.toArray();
            }

            length = records.length;

        }
        else if (typeof records === 'object') {
            removeRange = true;
            i = records.start;
            length = records.end + 1;
            removeCount = length - i;
        }




        if (!removeRange) {


            for (i = 0; i < length; i++) {
                record = records[i];

                index = data.remove(record);

                record.unjoinStore(me);

                indexes.push(index);
                allRecords.push(record);


                me.removed.push(record);

                me.on('remove', record, index, !!isMove);
            }

            resultItems = records;
        }

        if (removeRange) {
            resultItems = data.removeRange(records.start, removeCount);
        }


        me.updateRecordsIndex();

        if (!silent) {

            me.on('bulkremove', [allRecords, indexes, !!isMove]);
            me.onDataChanged();
        }


        //删除记录后,重新设置焦点行

        var existDel = Mini2.Array.contains(indexes, me.currentIndex);


        if (existDel) {

            var newCurIndex = -1;

            if (me.currentIndex >= me.data.length) {
                newCurIndex = me.data.length - 1;
            }
            else {
                newCurIndex = me.currentIndex;
            }

            me.setCurrent(newCurIndex);
        }

        return resultItems;
    },


    //编辑以后触发的事件
    afterEdit: function (record, modifiedFieldNames) {
        "use strict";
        var me = this,
            i, shouldSync;



        //        if (me.autoSync && !me.autoSyncSuspended) {
        //            for (i = modifiedFieldNames.length; i--; ) {
        //                // only sync if persistent fields were modified
        //                if (record.fields.get(modifiedFieldNames[i]).persist) {
        //                    shouldSync = true;
        //                    break;
        //                }
        //            }
        //            if (shouldSync) {
        //                me.sync();
        //            }
        //        }

        //me.onUpdate(record, Ext.data.Model.EDIT, modifiedFieldNames);

        //console.log('store.record', record);
        //console.log('store.modifiedFieldNames', modifiedFieldNames);

        me.on('update', [record, 'EDIT', modifiedFieldNames]);
    },




    //根据 record 主键，清理
    clearInvalidAll_ByRecordId: function (recordId, fields) {
        var me = this,
            record = me.getById(recordId);

        if (record) {
            record.clearInvalid(fields);
        }
    },



    //根据 record 主键，清理
    clearInvalid_ByRecordId: function (recordId, fields) {
        var me = this,
            record = me.getById(recordId);

        if (record) {
            record.clearInvalid(fields);
        }
    },


    //根据 record 主键，设置错误信息
    markInvalid_ByRecordId: function (recordId, error) {
        var me = this,
            record = me.getById(recordId);

        if (record) {
            try {
                record.clearInvalidAll();
                record.markInvalid(error);
            }
            catch (ex) {
                console.error("执行函数错误: markInvalid_ByRecordId(...,..)." + ex.Message);
            }
        }

    },


    //创建异常信息触发的事件
    afterInvalid: function (record, fieldNames) {
        var me = this;

        me.on('invalid', [record, fieldNames]);
    },


    filterFirstBy: function (field, value) {
        "use strict";
        var me = this,
            list,
            data = me.data;

        list = data.filterFirstBy(function (record) {
            return value == record.get(field);
        });

        return list;
    },


    getById: function (id) {
        "use strict";
        var me = this,
            list,
            data = me.data;

        list = data.filterFirstBy(function (record) {
            return id == record.getId();
        });

        return list;
    },



    //更新记录值
    // dirty: true=弄脏， false=正常状态
    setRecordValue: function (recordId, field, value, dirty) {
        "use strict";
        var me = this,
            log = me.log,
            record;


        record = me.getById(recordId);

        
        if (record) {

            record.set(field, value);

            //log.debug("setRecordValue(...) field=" + field + ", dirty=", dirty);
            
            if (dirty !== true) {
                record.commit(null, [field]);
            }
        }
        else {
            //console.error('没找到主键对应的实体。主键值=', recordId);
        }
    },


    getModifiedRecords: function () {

        return [].concat(this.getNewRecords().toArray(), this.getUpdatedRecords().toArray());
    },


    //排序
    sort: function (sortText) {
        "use strict";
        var me = this;

        me.sortText = sortText;

        if (!me.requestOptions) {

            var page = me.currentPage,
                pageSize = me.pageSize,
                op;

            op = Mini2.apply({
                action: 'read',
                //filters: me.filters.items,    //过滤
                sorters: me.getSorters()
            }, {});

            op.page = page;
            op.start = page * pageSize;
            op.limit = pageSize;
            op.end = op.start + op.limit;

            me.requestOptions = op;
        }

        me.requestOptions.sorters = me.getSorters();


        var actId = me.clientId + '_Action';
        var actEl = $('#' + actId);

        var json = me.getRequestJson();
        actEl.val(json);

        me.loadPage(0);
    },

    //触发排序事件
    doSort: function (sorterFn) {
        "use strict";
        var me = this;

        if (me.remoteSort) {
            //the load function will pick up the new sorters and request the sorted data from the proxy
            me.load();
        }
        else {
            me.data.sortBy(sorterFn);
            me.onDataChanged();
            me.on('refresh', me);
        }

        me.on('sort', me, me.sorters.getRange());
    },

    //设置只读
    setReadOnly: function (value) {
        var me = this;

        me.readOnly = value;

        return me;
    },

    getReadOnly: function () {
        var me = this;

        return !!me.readOnly;
    },

    /**
    * 刷新实体
    *
    **/
    refresh: function () {
        var me = this;

        me.on('refresh', me);

        return me;
    },


    /**
    * 获取分页时使用的总数量 
    * @return {int}
    **/
    getTotalCount: function () {
        return this.totalCount;
    },

    setTotalCount: function (value) {
        this.totalCount = value;
    },

    /**
    * 获取当前显示的记录数量
    *
    **/
    getCount: function () {
        var me = this;
        return me.data.getCount();
    },


    each: function (fn, scope) {
        "use strict";
        var data = this.data.items,
            len = data.length,
            record, i;

        for (i = 0; i < len; i++) {
            record = data[i];
            if (fn.call(scope || record, record, i, len) === false) {
                break;
            }
        }

    },


    //创建记录实体
    createModel: function (record) {
        "use strict";
        //log.begin("Store.createModel()");
        var me = this;

        if (!record.isModel) {
            if (!me.model ) {
                throw new Error('Store.Model 不能等于 null');
            }

            record = Mini2.ModelManager.create(record, me.model);
        }

        //log.end();


        return record;
    },


    //插入记录
    insert: function (index, records, triggerEvent) {
        "use strict";
        var me = this,
            sync = false,
            i, len, record,
            defaults = me.modelDefaults,
            out;

        if (Mini2.isArray(records)) {
            out = records;
        }
        else {
            out = [records];
        }

        records = out;

        len = records.length;

        for (i = 0; i < len; i++) {
            record = records[i];

            if (!record.isModel) {

                try{
                    record = me.createModel(record);
                }
                catch (ex) {
                    throw new Error('创建 record 实体错误.'+ ex.message);
                }
            }

            record.joinStore(me);


            out[i] = record;
            if (defaults) {
                record.set(defaults);
            }


            //record.join(me);

            sync = sync || record.phantom === true;


            me.data.insert(index + i, record);

            if (me.curLoadData) {
                me.curLoadData.push(record);
            }
        }



        if (undefined === triggerEvent || true === triggerEvent) {

            me.updateRecordsIndex();

            me.on('add', [index, out]);


            me.onDataChanged();
        }

        return me;
    },


    /**
     * 递增模式
     */
    isIncr: false,

    incrPage: 0,

    /**
     * 最后一页
     */
    isLastPage:function(){

        var me = this,
            data = me.data,
            totalCount = me.totalCount;

        if (data.length >= totalCount) {
            return true;
        }

        return false;

    },

    nextPage: function(result){

        "use strict";
        var me = this,
            log = me.log,
            op;
        

        me.incrPage++;
        
        me.loadPage(me.incrPage);


        return me;

    },


    //按页码加载数据集
    loadPage: function (page) {
        "use strict";
        var me = this,
            log = me.log,
            op;

        if (undefined == page) {
            page = me.currentPage;
        }

        op = Mini2.apply({
            action: 'read',
            //filters: me.filters.items,
            sorters: me.getSorters()
        }, {});

        op.page = page;
        op.start = page * me.pageSize;
        op.limit = me.pageSize;
        op.end = op.start + op.limit;

        me.requestOptions = op;

        console.debug('---------- op ', op);

        var widget = window.widget1;

        if (widget && widget.subMethod) {

            widget.subMethod('form:first', {
                subName: me.id,
                subMethod: 'LoadPage',
                actionPs: page
            });

        }

        return me;
    },

    //获取排序的字段
    getSorters: function () {
        /// <summary>获取排序参数</summary>
        var me = this;

        return me.sortText;
    },


    getJsonForRecord: function (record) {
        "use strict";
        var me = this,
            srcData,
            i;

        var recObj = {
            action: "none",
            id: record.getId(),
            clientId: record.muid,
            index: me.currentIndex,
            values: {}
        };


        if (record.dirty) {
            recObj.action = 'modified';
        }

        srcData = record.data;

        for (i in srcData) {
            if ('_ownerTreeNode' == i) {
                continue;
            }
            
            recObj.values[i] = srcData[i];
        }

        return recObj;
    },


    //按修改过的记录 json
    getJsonForRecordModified: function (record, i) {
        "use strict";
        var me = this,
            j,
            recObj;

        recObj = {
            action: 'none',
            id: record.getId(),
            clientId: record.muid,
            index: i,
            values: {}
        };

        if (record.dirty) {
            recObj.action = 'modified';
        }

        for (j in record.modified) {
            recObj.values[j] = record.get(j);
        }

        return recObj;
    },




    getRequestJson: function () {
        "use strict";
        /// <summary>获取请求的json参数</summary>

        var me = this;



        var jsonStr = Mini2.Json.toJson(me.requestOptions);


        return jsonStr;
    },



    getUploadJson: function () {
        "use strict";
        /// <summary>获取提交 JSON 记录数据</summary>

        var me = this,
            log = me.log,
            record,
            i,
            recObj,
            jsonStr,
            jsonObj,
            records = me.data,
            len = records.getCount();

        //var reqJson = me.getRequestJson();

        jsonObj = {
            cur_index: me.currentIndex,
            current: null,    //当前焦点记录
            records: []     //记录状态
        };


        try {
            if (me.current && me.currentIndex > -1) {
                record = me.current;
                jsonObj.current = me.getJsonForRecord(record);
            }


            for (i = 0; i < len; i++) {
                record = records.get(i);

                if ('full' == me.jsonMode) {
                    recObj = me.getJsonForRecord(record);
                }
                else {
                    if (!record.dirty) {
                        continue;
                    }
                    recObj = me.getJsonForRecordModified(record, i);
                }

                jsonObj.records.push(recObj);
            }
        }
        catch (ex) {

            log.error('Store.getUploadJson(...) 执行错误。' + ex.message);

            throw new Error('Store.getUploadJson(...) 执行错误。' + ex.message);
        }

        try {
            jsonStr = Mini2.Json.toJson(jsonObj);
        }
        catch (ex) {
            console.error("getUpladJson ", jsonObj);

            log.error('执行 Mini2.Json.toJson(...) 错误', ex.message);
            throw new Error('执行 Mini2.Json.toJson(...) 错误', ex.message);
        }


        return jsonStr;
    },


    //页面加载结束后，触发的事件
    onLoader: function () {
        var me = this,
            log = me.log;

        log.debug(me.id + '  onLoader()');

        if (me.autoFocus) {
            log.debug('自动设置焦点记录。');
            me.setCurrent(0);
        }
    }



}, function () {
    "use strict";
    var me = this,
        log = me.log,
        args = arguments;
    
    if (args && args[0]) {
        Mini2.apply(this, args[0]);
    }

    me.preInit();
});


/************************************************************************/
/*                                           */
/*    data/TreeModel.js                                                    */
/*                                           */
/************************************************************************/

/// <reference path="../Mini.js" />

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="StoreManager.js" />
/// <reference path="../lang/Array.js" />



Mini2.define('Mini2.data.TreeModel', {

    //用户数据
    data: null,

    isNode: true,

    //下级节点
    childs: null,

    //上级节点
    parentNode: null,

    //上级ID
    parentId: null,
    index:0,

    //深度
    depth: 0,

    //展开
    expanded: false,

    //叶
    leaf: false,

    //是否最后节点
    isLast: false,
    isFirst:false,

    //加载完成
    loaded: false,
    loading: false,

    hasChild: false,

    //复选框
    checked: false,

    cls: '',
    icon: '',
    iconCls: '',


    model:false,

    onInit: function () {
        var me = this,
            data = me.data,
            userData,   //用户数据
            nodeAttrs    //节点属性;

        me.attrs = {};
        me.childs = [];

        if (data.isNode) {
            userData = data.data;

            delete data.data;

            nodeAttrs = data;
        }
        else {
            userData = data;

            nodeAttrs = data;
        }

        if (!userData.isModel) {
            userData = Mini2.ModelManager.create(userData, this.model);
        }

        me.data = userData;

        Mini2.apply(me.attrs, nodeAttrs);

    },


    addNode:function(parentId, node){
        var me = this;

        

    },

    getAttr: function (attr) {
        var me = this,
            attrs = me.attrs;

        return attrs[attr];
    },

    setArrt: function (attr, value) {
        var me = this,
            attrs = me.attrs;

        attrs[attr] = value;

        return me;
    }

}, function () {
    var me = this;

    me.muid = Mini2.newId();

    Mini2.apply(me, arguments[0]);
    me.onInit(arguments[0]);


});


/************************************************************************/
/*                                           */
/*    data/Tree.js                                                         */
/*                                           */
/************************************************************************/

/// <reference path="../Mini.js" />

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="StoreManager.js" />
/// <reference path="../lang/Array.js" />


Mini2.define('Mini2.data.Tree', {

    root: null,

    groupBuffer: false,

    PID_EX:'PID_',

    constructor: function (root) {
        var me = this,
            data = me.data;

        if (root) {
            me.root = root;
        }

        me.groupBuffer = {};

        if (data) {
            me.initGroupBuffer(data);

            delete me.data;
        }

    },

    //把并行数据转换为树结构
    initGroupBuffer:function(data){
        var me = this,
            i,
            record,
            len = data.length;


        for (i = 0; i < len; i++) {
            record = data.get(i);

            me.insertNode(record);


        }
    },


    removeNode:function(record){
        var me = this,
            pValue,
            pField = me.parentField,
            group = me.groupBuffer,
            records,
            tmpRec,
            i,id;


        pValue = 'PID_' + record.get(pField);

        records = group[pValue];

        if (records) {
            
            id = record.getId();

            for (i = 0; i < records.length; i++) {

                tmpRec = records[i];

                if (tmpRec.isNode) {
                    tmpRec = tmpRec.data;
                }

                if (tmpRec.getId() == id) {
                    records.splice(i, 1);

                    break;
                }

            }
        }

    },

    insertNode:function(record){
        var me = this,
            pValue,
            pField = me.parentField,
            tmpRecords,
            group = me.groupBuffer
            ;

        pValue = 'PID_' + record.get(pField);

        tmpRecords = group[pValue];

        if (!tmpRecords) {
            tmpRecords = [];
            group[pValue] = tmpRecords;
        }


        if (!record.isNode) {
            record = Mini2.create('Mini2.data.TreeModel', {
                model: me.model,
                data: record
            });
        }

        tmpRecords.push(record);
    },

    //根据上级Id，获取子节点集合
    getChilds:function(parentId){
        var me = this,
            pValue = 'PID_' + parentId,
            group = me.groupBuffer,
            records;

        records = group[pValue];

        return records;
    },



    getRootNode: function () {
        return this.root;
    },

}, function () {
    var me = this;

    me.muid = Mini2.getIdentity();

    Mini2.apply(me, arguments[0]);
    me.constructor(arguments[0]);


});


/************************************************************************/
/*                                           */
/*    data/TreeStore.js                                                    */
/*                                           */
/************************************************************************/

/// <reference path="../Mini.js" />

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="StoreManager.js" />
/// <reference path="../lang/Array.js" />



Mini2.define('Mini2.data.TreeStore', {

    extend: 'Mini2.data.Store' ,

    isTreeStore : true ,

    //上级字段名
    parentField: null,

    textField: null,

    //记录分组
    tree : false,

    //根节点的值
    rootValue: '0',

    //动态处理子节点
    dymHasChild:true,


    //是否有子节点
    hasChilds: function (parentId) {
        var me = this,
            tree = me.tree || me.createTree();

        return !!tree.getChilds(parentId)
    },

    //根据上级Id，获取子节点集合
    getByGroup: function (parentId) {
        var me = this,
            tree = me.tree || me.createTree();
        
        return tree.getChilds(parentId)
    },


    //初始化树分组
    createTree: function () {
        var me = this,
            pField = me.parentField,
            tree = me.tree,
            srcData = me.data ;

        if (!tree) {
            me.tree = tree = Mini2.create('Mini2.data.Tree', {
                model:me.model,
                parentField: pField,
                data : srcData
            });
        }

        return tree;
    },


    //创建初始化数据集
    createInlineData: function () {
        "use strict";
        var me = this,
            log = me.log,
            model = me.model,
            i,
            config,
            record,
            data = me.data,
            len;

        if (data) {

            len = data.length;

            for (i = 0; i < len; i++) {
                config = data[i];

                if ('tree-model' == config.role) {

                    var has_child = config.has_child;
                    var role = config.role;

                    record = Mini2.ModelManager.create(config.data, model);
                    
                    record.has_child = has_child;
                    record.role = role;

                }
                else {
                    record = Mini2.ModelManager.create(config, model);
                }

                record.joinStore(me);


                data[i] = record;
            }
        }

        me.inlineData = data;
        delete me.data;

        //log.debug('封装 data', data);
        me.data = new Mini2.collection.ArrayList(me.inlineData);

        //log.debug('封装后 data', me.data);

        me.updateRecordsIndex();
    },


    //按 id 删除记录
    removeById: function (id, silent) {
        "use strict";
        //log.debug("按 id 删除记录.");

        var me = this,
            log = me.log,
            i,
            list,
            data = me.data;


        if (!Mini2.isArray(id)) {
            id = [id];
        }

        //list = data.filterBy(function (record) {
        //    return Mini2.Array.contains(id, record.getId(), true);
        //});

        //if (list.length) {
        //    me.remove(list, false, silent);
        //}
        //else {

            var resultRecords = id;

            if (!silent) {

                me.on('remove', [resultRecords, false]);
                me.onDataChanged();
            }

        //}


        me.disposeModels(list); //释放实体的内存

        return list;
    },



    remove: function (records, /* private */isMove, silent) {
        var me = this,
            base = me.constructor.base,
            resultRecords,
            i,
            tree = me.tree || me.createTree();;
        
        resultRecords = base.remove.call(me, records, isMove, silent);

        for (i = 0; i < resultRecords.length; i++) {
            tree.removeNode(resultRecords[i]);
        }
    },

    //创建记录实体
    createModel: function (record) {
        "use strict";
        //log.begin("Store.createModel()");
        var me = this;

        //console.debug('加载实体...', record);

        if ('tree-model' == record.role) {

            if (!me.model) {
                throw new Error('Store.Model 不能等于 null');
            }

            var hasChild = record.has_child;

            record = Mini2.ModelManager.create(record, me.model);


            record.role = 'tree-model';
            record.has_child = hasChild;


        }
        else if (!record.isModel) {
            if (!me.model) {
                throw new Error('Store.Model 不能等于 null');
            }


            record = Mini2.ModelManager.create(record, me.model);

        }

        //log.end();


        return record;
    },


    //插入记录
    insert: function (index, records) {
        var me = this,
            log = me.log,
            base = me.constructor.base,
            treeModel,
            record,
            out ,
            records2 = [],
            treeModels = [],
            i,
            tree = me.tree || me.createTree();

        if (!Mini2.isArray(records)) {
            out = [records];
        }
        else{
            out = records;
        }

        records = out;
        

        for (i = 0; i < records.length; i++) {

            record = records[i];
            
            if ('tree-model' == record.role) {

                treeModel = record;

                record = record.data;

                record._ownerTreeNode = treeModel;
                
                record.role = 'tree-model';
                record.has_child = treeModel.has_child;
                
            }
            else if (record.isNode) {
                treeModel = record;
                record = treeModel.data;

                record._ownerTreeNode = treeModel;

                //if (treeModel.has_child) {
                //    record.has_child = treeModel.has_child;
                //}
            }
            else {

                //try {
                //    record = me.createModel(record);
                //}
                //catch (ex) {
                //    throw new Error('创建 record 实体错误.' + ex.message);
                //}

            }
            
            records2.push(record);

        }

        //基础函数
        base.insert.call(me, index, records2, false);

        
        for (i = 0; i < records2.length; i++) {
            tree.insertNode(records2[i]);
        }

        me.updateRecordsIndex();

        me.on('add', [index, records2]);

        me.onDataChanged();

    },



    //设置当前焦点行
    setCurrent: function (index, isTriggerSer) {
        "use strict";
        var me = this,
            log = me.log,
            cur,
            curIndex = 0,
            list,
            data = me.data;

        console.debug('数据仓库 setCurrent ', index);
        
        if (undefined === data ) {

            me.current = null;
            me.currentIndex = -1;

            me.focusNode = null;

            
            me.on('currentchanged', [me.currentIndex, me.current]);

            if (me.currentChanged) {
                me.currentChanged.call(me);
            }

            return;
        }

        if (Mini2.isNumber(index)) {

        }
        else {
            cur = index;

            me.focusNode = cur;
            me.current = cur;
            me.currentIndex = curIndex;
        }

        me.on('currentchanged', [curIndex, cur]);

        if (me.currentChanged) {
            me.currentChanged.call(me);
        }
    }

});


/************************************************************************/
/*                                           */
/*    ui/SecManager.js                                                     */
/*                                           */
/************************************************************************/




Mini2.ns('Mini2.ui');

Mini2.ui.SecManager = new function () {
    "use strict";

    Mini2.apply(this, {

        defaultProp :'visible',

        /**
         * 属性索引
         */
        propDict: {
            'visible': {},
            'readonly': {}
        },


        /**
         * 注册控件
         *
         * @param {String} 权限编码
         * @param {Object} 控件
         */
        reg: function (secFunCode, con, prop) {
            "use strict";
            
            if (Mini2.isBlank(secFunCode)) { return this; }

            prop = prop || this.defaultProp;

            var me = this,
                cons = me.propDict[prop],// me.secControls,
                items = cons[secFunCode];


            if (!items) {
                cons[secFunCode] = items = [];
            }

            items.push(con);


            return me;
        },


        /**
         * 卸载注册控件
         * @param {String} 权限编码
         * @param {Object} 控件
         */
        unreg: function(secFunCode, con, prop){
            "use strict";

            if (Mini2.isBlank(secFunCode)) { return this; }

            prop = prop || this.defaultProp;

            var me = this,
                cons = me.propDict[prop],//me.secControls,
                items = cons[secFunCode];
                        
            if (!items) {
                cons[secFunCode] = items = [];
            }

            Mini2.Array.remove(items, con);

            return me;
        },

        /**
         * 获取控件集合
         * @param {Array} 
         */
        getItems : function(secFunCode){
            "use strict";

            var me = this,
                cons = me.secControls,
                items = cons[secFunCode];

            return items || null;
        },

        /**
         * 设置可视的
         */
        setFun: function (defaultEnabled, secFunCodeList) {
            "use strict";

            var me = this;

            me.setFun_ForVisible(defaultEnabled, secFunCodeList);

            me.setFun_FroReadonly(defaultEnabled, secFunCodeList);
                        

            //重新刷新界面
            Mini2.LoaderManager.preResize();

            return me;
        },

        /**
         * 获取激活的分组
         */
        getEnableGroup: function (cons, secFunCodeList) {
            "use strict";
            var me = this,
                tItems = [],
                fItems = [],
                group = {
                    T: tItems,
                    F: fItems
                };
            
            for (var funCode in cons) {

                if (Mini2.Array.contains(secFunCodeList, funCode, true)) {
                    tItems[funCode] = cons[funCode];
                }
                else {
                    fItems[funCode] = cons[funCode];
                }

            }

            return group;
        },

        setFun_ForVisible:function(defaultEnabled, secFunCodeList ){
            "use strict";

            var me = this,
                funName = 'setVisible',
                cons = me.propDict['visible'],
                group ;// me.secControls;


            group = me.getEnableGroup(cons, secFunCodeList);
            
            me.callFun(group.T, funName, true);
            me.callFun(group.F, funName, false);
            
            return me;
        },

        setFun_FroReadonly:function(defaultEnabled, secFunCodeList){
            "use strict";

            var me = this,
                funName = 'setReadOnly',
                cons = me.propDict['readonly'],
                group;// me.secControls;

            group = me.getEnableGroup(cons, secFunCodeList);

            me.callFun(group.T, funName, true);
            me.callFun(group.F, funName, false);

            return me;
        },

        callFun:function( cons, funName , value){
            var me = this,
                fun,
                items,
                item;

            for (var funCode in cons) {

                items = cons[funCode] || [];

                for (var i = 0; i < items.length; i++) {

                    item = items[i];
                    
                    fun = item[funName];

                    if (fun) {
                        fun.call(item, value);
                    }
                    else {
                        console.warn('没有找到这个控件对应的函数名: ' + funName);
                    }

                }

            }

            return me;
        }


    });

};


/************************************************************************/
/*                                           */
/*    ui/FocusManager.js                                                   */
/*                                           */
/************************************************************************/

/// <reference path="define.js" />
/// <reference path="../Mini.js" />
/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />

//焦点管理
Mini2.define("Mini2.ui.FocusManager", {


    //单件模式
    singleton: true,

    log: Mini2.Logger.getLogger('Mini2.ui.FocusManager', false),

    //别名
    alternateClassName: ['Mini2.ui.FocusMgr'],

    //控件
    control: null,


    //附带数据
    data: null,

    scope: null,

    el: null,

    //最后光标所在位置
    lastActionControl: null,
    lastActionTime:Mini2.Date.now(),


    //设置焦点判断
    setActionControl: function (con) {
        "use strict";
        var me = this;
        me.lastActionControl = con;
        me.lastActionTime = Mini2.Date.now();
    },

    //是否用户输入中.
    isInputting: function () {
        "use strict";
        var me = this,
            isInput,
            span,
            con = me.lastActionControl;

        isInput = (con && con.isInput) || false;

        //如果超过20秒还没有进行输入,就证明这个界面没有用户在进行操作..
        if (isInput) {

            span = Mini2.Date.now() - me.lastActionTime;

            //log.debug("超时:" + span);

            if (span > 20000) {
                isInput = false;
            }
        }

        return isInput;
    },

    offsetParent: function (elem) {
        "use strict";
        var el = $(elem),
            cls = 'mi-border-box',
            i = 0;

        if (el.hasClass(cls)) {
            return elem;
        }

        for (i; i < 999; i++) {

            el = el.parent();

            if (el.hasClass(cls)) {

                break;
            }

        }

        return el;
    },

    getBorderBox: function (con) {
        "use strict";
        var me = this;

        if (con == undefined) {
            return me;
        }

        if (con.toString() == '[object Window]') {
            con = window.document.body;

        }

        if (con.el) {
            if (con.el.jquery) {
                con = con.el.get(0);
            }
            else if (Mini2.isDom(con.el)) {
                con = con.el;
            }
        }

        if (!Mini2.isDom(con)) {
            return me;
        }

        var borderBox;

        //log.debug("con Type = " + con.toString());

        //if (con.toString() == "[object HTMLDivElement]") {
        //log.debug($(con).html());
        //}

        if ($(con).hasClass("mi-border-box")) {
            borderBox = $(con);
        }
        else {
            borderBox = me.offsetParent(con);
        }


        var eventMgr = null;

        if (borderBox.length) {
            eventMgr = borderBox.data("FOCUS_MANAGER");

            if (!eventMgr) {

                eventMgr = {
                    control: null,
                    data: null,
                    scope: null,
                    el: borderBox.get(0),
                    typeString: borderBox.get(0).toString(),
                    muid: "F_" + Mini2.getIdentity()
                };

                borderBox.data("FOCUS_MANAGER", eventMgr);

//                log.debug("创建焦点管理器");
            }

            return eventMgr;
        }

        return me;
    },

    clear: function (con) {
        var me = this,
            mm = me.getBorderBox(con);

        mm.data = null;
        mm.scope = null;
        mm.control = null;
    },


    setControl: function (con, data, scope, isReset) {
        "use strict";
        /// <summary>设置控件焦点</summary>
        /// <param name="con" type="Control">UI 控件</param>
        /// <param name="data" type="object">附带对象</param>
        /// <param name="isReset" type="bool" >强制重置焦点控件</param>

        var me = this,
            log = me.log,
            mm = me.getBorderBox(con),
            lastCon = mm.control,
            lastData = mm.data;

        if (con) {
            
            if (con.getType) {
                log.debug(con.getType().fullName);
            }
        }


        //if (undefined == scope) { scope = con; }

        //if (undefined == data) {
        //    data = null;
        //}



        //scope = scope || con;

        con = scope || con;

        data = data || null;


        if (isReset != true) {
            if (lastCon == con && lastData == data) {

                log.debug('对比控件相同, 退出');
                return;
            }
        }

        log.debug('lastCon', lastCon);

        log.debug("cur con : " , con);
        

        if (lastCon) {

            //var lastMM = me.getBorderBox(lastCon);
            log.debug("触发控件移出的事件");

            $(lastCon).muTriggerHandler('focusout', [{
                sender: lastCon,    //原焦点控件
                target: con,        //新获取焦点控件
                data: lastData      //原附带的数据
            }]);

        }


        mm.control = con;
        mm.data = data;


        me.setActionControl(con);   // 最后选中的控件

        if (con) {
            //            log.debug("调用事件 con.focusin");

            $(con).triggerHandler('focusin');
        }


        //        log.end();
    }



});




/************************************************************************/
/*                                           */
/*    ui/Component.js                                                      */
/*                                           */
/************************************************************************/


/// <reference path="../Mini.js" />


/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="FocusManager.js" />
/// <reference path="EventManager.js" />



//焦点管理
Mini2.define("Mini2.ui.Component", {

    el: null,

    log: Mini2.Logger.getLogger('Mini2.ui.Component'),

    /**
    * 设备类型 [auto | computer | touch ]
    */
    deviceType : 'auto', 

    //配合样式使用
    ui : 'default', 

    //区域范围
    scope: null,

    isComponent: true,


    renderTo: null, // Mini2.getBody(),

    visible: true,

    disabled: false,//无效

    //组件附带的事件
    eventNames: [],


    //父容器
    ownerParent: null,

    /**
    * 调用父容器,通知本容器已经刷新
    */
    callParent: function () {
        var me = this,
            ownerParent = me.ownerParent;

        if (ownerParent && ownerParent.updateLayout) {
            ownerParent.updateLayout();
        }

        return me;
    },


    //初始化组件
    initComponent: Mini2.emptyFn,

    defaultRenderer: Mini2.emptyFn,


    //触发事件
    trigger: function (eventName, eventParams) {
        "use strict";
        var me = this,
            owner,
            i,
            event = '_EVENT_' + eventName,
            funs,
            fun,
            cancel;

        // console.debug('触发事件', eventName);
        funs = me[event];

        if (funs) {
            for (i = 0; i < funs.length; i++) {
                fun = funs[i];

                if (fun.owner) {
                    owner = fun.owner;
                    fun = fun.fun;
                }
                else {
                    owner = me;
                }

                cancel = fun.call(owner, eventParams);
                
                if (true === cancel) {
                    break;
                }
            }
        }

        return cancel;
    },

    //绑定事件
    bind: function (eventName, owner, fun) {
        "use strict";
        var me = this,
            event = '_EVENT_' + eventName,
            funs;

        funs = me[event] || [];


        if (undefined === fun) {
            fun = owner;
        }
        else {
            fun = {
                owner: owner,
                fun: fun
            }
        }

        funs.push(fun);

        if (!me[event]) {
            me[event] = funs;
        }

        return me;
    },


    on: function (eventName, data, scope) {
        "use strict";
        /// <summary>绑定事件</summary>
        var me = this;

        switch (eventName) {
            case 'mouseup':
                Mini2.EventManager.setMouseUp(me,data);
                break;
            case 'mousemove':
                Mini2.EventManager.setMouseMove(me,data);
                break;
            default:
                $(me).muTriggerHandler(eventName, data);
                break;

        }

        return me;
    },



    addCls: function (cls) {
        "use strict";
        var me = this,
            el = me.rendered ? me.el : me.protoEl;

        //el.addCls.apply(el, arguments);
        $(me.el).addClass(cls);

        return me;
    },



    onResize: function (width, height, oldWidth, oldHeight) {

    },



    setLocation: function (x, y) {
        return this.setLeft(x).setTop(y);
    },
    
    setLocal: function (x, y) {
        var me = this;
        return me.setLocation(x, y);
    },

    setTop: function (v) {
        var me = this;
        me.top = v;
        me.el.css('top', v);

        return this;
    },

    getTop:function(){
        var me = this,
            el = me.el;
        return el.css('top');
    },



    setLeft: function (v) {
        var me = this,
            el = me.el;

        me.left = v;
        el.css('left', v);
        return me;
    },
    getLeft:function(){
        var me = this,
            el = me.el;
        return el.css('left');
    },


    setHeight: function (v) {
        this.setSize(undefined, v);
    },

    setWidth: function (v) {
        this.setSize(v);
    },


    getWidth: function (includeMargin) {
        var me = this,
            el = me.el;

        if (true === includeMargin) {
            return el.outerWidth(includeMargin);
        }
        else {
            return el.outerWidth();
        }
    },

    getHeight: function (includeMargin) {
        var me = this,
            el = me.el;

        if (true === includeMargin) {
            return el.outerHeight(includeMargin);
        }
        else {
            return el.outerHeight();
        }
    },

    setSize: function (w, h) {
        //throw new Error('未实现');
    },

    getSize: function (includeMargin ){
        var me = this;

        if (true === includeMargin) {
            return {
                width: me.getWidth(includeMargin),
                height: me.getHeight(includeMargin)
            };
        }
        else {
            return {
                width: me.getWidth(),
                height: me.getHeight()
            };
        }
    },
    
    /**
    * 隐藏组件
    */
    hide: function () {
        var me = this,
            el = me.el;

        me.visible = false;

        if (el) {
            el.hide();
        }

        me.callParent();

        return me;
    },

    /**
    * 显示组件
    */
    show: function () {
        var me = this,
            el = me.el;

        me.visible = true;

        if (el) {
            el.show();
        }

        me.callParent();

        return me;
    },

    /**
    * 设置组件可视状态
    * @param {bool} value 
    */
    setVisible: function (value) {
        "use strict";
        var me = this;
        value = !!value;
        me.visible = value;

        if (value) {
            me.show();
        }
        else {
            me.hide();
        }

        return me;
    },

    /**
    * 获取组件可视状态
    * @return {bool} 
    */
    getVisible: function () {
        "use strict";
        var me = this;

        return me.visible;
    },

    /**
    * 获取无效
    */
    setDisabled: function (value) {
        "use strict";
        var me = this;

        me.disabled = !!value;


    },

    getDisabled:function(){
        var me = this;

        return me.disabled;
    },




    onLostFocus: function () {


        //console.log("失去焦点");
    },


    /**
    * 重置层次
    */
    resetPaint: Mini2.emptyFn,

    /**
    * 触发焦点事件
    */
    onFocus: Mini2.emptyFn,


    focus: Mini2.emptyFn,

    dispose: Mini2.emptyFn

}, function () {
    var me = this;

    me.renderTo = Mini2.getBody();

    Mini2.apply(me, arguments[0]);

    me.initComponent();

});


/************************************************************************/
/*                                           */
/*    ui/Editor.js                                                         */
/*                                           */
/************************************************************************/

/// <reference path="define.js" />


Mini2.define('Mini2.ui.Editor', {

    extend: 'Mini2.ui.Component',
    

    value: '',

    offsets: [0, 0],

    cancelOnEsc: true,

    focusOnToFront: false,

    hidden: true,

    field: null,



    initComponent: function () {


    },

    afterRender: function (ct, position) {
        
    },

    startEdit: function (el, value) {
        /// <summary>开始编辑</summary>

    },


    onShow: function () {

    },

    cancelEdit: function (remainVisible) {
        /// <summary>取消编辑</summary>
    
    
    },


    hideEdit: function (remainVisible) {
        /// <summary>隐藏编辑</summary>



    },


    onHide: function () {



    },

    setValue : function(value) {
        this.field.setValue(value);
    },

    getValue : function() {
        return this.field.getValue();
    }
});


/************************************************************************/
/*                                           */
/*    ui/EcView.js                                                         */
/*                                           */
/************************************************************************/


Mini2.define('Mini2.ui.EcView', {

    /**
     * 获得父窗口的句柄
     */
    parentPage: null,
    
    getParentWin :function (){

        var lastParent = window;

        var i = 0;

        for (i = 0; i < 9; i++) {
            if (lastParent.parent == lastParent || lastParent.parent == undefined) {
                break;
            }

            lastParent = lastParent.parent;
        }

        return lastParent;
    },


    ///转换 Url 地址，配合 EcView 使用
    changeAppUri : function(srcUri) {
        var me = this;

        if (undefined == srcUri ) {
            throw new Error('srcUrl 不能为空.');
        }

        if (srcUri.length && srcUri.substr(0, 1) == '/') {
            return srcUri;
        }

        if (srcUri.indexOf('http:') == 0 || srcUri.indexOf('https:')) {
            return srcUri;
        }



        var path = window.location.pathname;
        var search = window.location.search;

        var n = path.lastIndexOf('/');

        var dir = path.substr(0, n + 1);


        while ((srcUri.length > 3 && srcUri.substr(0, 3) == "../")) {
            n = dir.lastIndexOf('/', dir.length - 2);

            dir = dir.substr(0, n + 1);

            srcUri = srcUri.substr(3);
        }

        var newPath = dir + srcUri;

        return newPath;
    },


    show : function (uri, title, iconCls, width, height) {
        var me = this,
            win ;

        uri = me.changeAppUri(uri);

        win = me.getParentWin();
        
        if (win.AddTab) {

            if (iconCls) {

                win.AddTab(uri, { label: title, iconCls: iconCls, parentPage: window });
            }
            else {

                win.AddTab(uri, title, true, true, window);
            }
            return;
        }

        if (width == undefined) { width = 800; }
        if (height == undefined) { height = 600; }

        window.open(uri, title, "height=" + width + ",width=" + height + ",toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no");
    }



});


Mini2.EcView = {


    show: function (uri, title, iconCls, parentPage ) {

        var ev = Mini2.create('Mini2.ui.EcView', {
            
        });

        ev.show(uri, title, iconCls);

        return ev;
    }

};


/************************************************************************/
/*                                           */
/*    ui/WindowManager.js                                                  */
/*                                           */
/************************************************************************/

/// <reference path="../Mini.js" />
/// <reference path="../lang/Array.js" />

//页面
Mini2.define('Mini2.ui.Page', {

    singleton: true,

    margin: {
        top: 40
    },

    curMax:{
        con:null,
        srcWidth:0,
        srcHeight:0,
        srcTop:0,
        srcLeft:0
    },

    

    //初始化组件
    initComponent: function () {
        var me = this;


    },

    //是否有最大化的控件
    hasMaxControl:function(){
        return !!this.curMax.con;
    },

    resize: function () {
        "use strict";
        var me = this,
            cur = me.curMax,
            con = cur.con;

        if (con) {


            var win = $(window);
            con.setSize(undefined, win.height() - me.margin.top);

        }
    },

    //设置当前最大化的控件
    maxControl: function (con) {
        "use strict";
        var me = this,
            cur = me.curMax,
            el = $;
        
        if (con.el) {
            el = $(con.el);
        }

        if (el.hasClass('mi-state-max')) {
            return;
        }

        el = con.el;

        try{
            cur.con = con;
            cur.srcHeight = con.getHeight();
            cur.srcWidth = con.getWidth();
            cur.srcTop = con.getTop();
            cur.srcLeft = con.getLeft();

            el.addClass('mi-state-max');

            var win = $(window);
            con.setSize(undefined, win.height() - me.margin.top);
        }
        catch (ex) {
            var miType = con.getType();
            console.log('最大化错误. con.fullName=' + miType.fullName);
            console.log(ex);
        }

        //log.debug("放大");
        
    },

    
    //恢复控件
    resetMaxControl: function (con) {
        "use strict";
        var me = this,
            cur = me.curMax,
            el = $;

        if (!cur.con ) { return; }

        if (con.el) {
            el = $(con.el);
        }

        //log.debug("缩小");

        el.removeClass('mi-state-max');

        con.setLeft(cur.srcLeft)
            .setTop(cur.srcTop)
            .setSize(cur.srcWidth, cur.srcHeight);

        cur.con = null;


    }


});


//弹出窗口管理器
Mini2.define('Mini2.ui.WindowManager', {


    //单件模式
    singleton: true,

    items: [],

    defaultZIndex :19000,

    zIndex: 19000,

    //
    isUpdateLayout:false,

    //注册弹出的窗体
    regWin: function (win) {
        "use strict";
        var me = this,
            items = me.items,
            len = items.length;

        Mini2.Array.add(items, win);

        win.setZIndex(me.zIndex + len * 20);

        //log.debug("Win 数量:" + me.items.length);
    },

    //移动窗体到最前方
    moveFirst: function (win) {
        "use strict";
        var me = this,
            item,
            i,
            len,
            index,
            items = me.items;
            
        index = Mini2.Array.lastIndexOf(items, win);
        len = items.length;

        if (index == len - 1) {
            return;
        }

        for (i = index; i < len - 1; i++) {
            items[i] = items[i + 1];
        }

        items[len - 1] = win;

        for (i = index; i < len; i++) {
            item = items[i];

            item.setZIndex(me.zIndex + i * 20);
        }

    },

    //删除窗体
    removeWin: function (win) {
        "use strict";
        var me = this,
            items = me.items;

        Mini2.Array.remove(items, win);

        if (!items.length) {
            me.zIndex = me.defaultZIndex;
        }

        //log.debug("Win 数量:" + me.items.length);
    }
});



/************************************************************************/
/*                                           */
/*    ui/WindowHeader.js                                                   */
/*                                           */
/************************************************************************/

/// <reference path="../Mini.js" />


Mini2.define('Mini2.ui.WindowHeader', {

    renderTo: Mini2.getBody(),

    text: 'Window',

    headerTpl: [
        '<div class="mi-window-header ',
            'mi-header ',
            'mi-header-horizontal ',
            'mi-header-draggable ',
            'mi-docked ',
            'mi-unselectable ',
            'mi-window-header-default ',
            'mi-horizontal ',
            'mi-window-header-horizontal ',
            'mi-window-header-default-horizontal ',
            'mi-top ',
            'mi-window-header-top ',
            'mi-window-header-default-top ',
            'mi-docked-top ',
            'mi-window-header-docked-top ',
            'mi-window-header-default-docked-top" ',
            'style="right: auto; left: -5px; top: -5px; width: 400px; ">',
            '<div class="mi-header-body ',
                'mi-window-header-body ',
                'mi-window-header-body-default ',
                'mi-window-header-body-horizontal ',
                'mi-window-header-body-default-horizontal ',
                'mi-window-header-body-top ',
                'mi-window-header-body-default-top ',
                'mi-window-header-body-default-docked-top ',
                'mi-box-layout-ct ',
                'mi-window-header-body-default-horizontal ',
                'mi-window-header-body-default-top " ',
                'style="width: 380px; ">',
                '<div class="mi-box-inner " role="presentation" style="width: 380px;  ">',
                    '<div class="mi-box-target" style="width: 380px; ">',
                        '<div class="mi-component ',
                            'mi-header-text-container ',
                            'mi-window-header-text-container ',
                            'mi-window-header-text-container-default ',
                            'mi-box-item mi-component-default" ',
                            'unselectable="on" ',
                            'style="right: auto; left: 0px; top: 0px; margin: 0px; width: 358px; ">',
                            '<span class="mi-header-text ',
                                'mi-window-header-text ',
                                'mi-window-header-text-default" ',
                                'unselectable="on">',
                                'Window',
                            '</span>',
                        '</div>',

                        '<div class="mi-tool ',
                            'mi-box-item ',
                            'mi-tool-default ',
                            'mi-tool-after-title" ',
                            'title="关闭"',
                            'style="width: 16px; height: 16px;  left: 364px; top: 0px; right: auto;margin: 0px; " >',
                            '<img role="presentation" ',
                                'src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" ',
                                'class="mi-tool-img mi-tool-close">',
                        '</div>',

                    '</div>',
                '</div>',
            '</div>',
        '</div>'
    ],


    /**
     * 关闭按钮激活
     */
    closeEnabled: true,


    setText: function (value) {
        this.headerTextEl.html(value);
    },

    getText: function () {
        return this.headerTextEl.html();
    },


    setWidth: function (value) {
        "use strict";
        var me = this,
            sysInfo = Mini2.SystemInfo;

        me.el.css('width', value);

        me.boxInnerEl.css('width', value - 20);
        me.boxTargetEl.css('width', value - 20);

        me.textContainerEl.css('width', value - 32);
        
        if ('touch' == sysInfo.mode) {
            me.toolEl.css({
                left: value - 46
            });
        }
        else {
            me.toolEl.css({
                left: value - 36
            });
        }
    },

    srcLocation: {},
    srcX: 0,
    srcY: 0,

    button1: false,

    isDrag: false,

    mouseBind: function (el) {
        "use strict";
        var me = this;

        el.muBind('mousedown', me, function (e) {
            me.button1 = true;

            me.srcLocation = me.owner.getOffset();

            me.srcX = event.pageX;
            me.srcY = event.pageY;

            me.owner.focus();

        })
        .muBind('mouseup', me, function (e) {
            me.button1 = false;

            if (me.isDrag) {

                me.isDrag = false;
                me.owner.endDrag();

                Mini2.EventManager.stopEvent(e);
            }
        })
        .muBind('mousemove', me, function (e) {

            if (me.button1) {

                var offsetX = event.pageX - me.srcX;
                var offsetY = event.pageY - me.srcY;

                var x = offsetX + me.srcLocation.left;
                var y = offsetY + me.srcLocation.top;

                if (!me.isDrag) {
                    if (Math.abs(offsetX) >= 4 || Math.abs(offsetY) >= 4) {

                        me.isDrag = true;
                        me.owner.beginDrag();
                    }
                }
                else if (me.isDrag) {
                    me.owner.setGhostLocation(x, y);
                }
            }
        });


    },

    render: function () {
        "use strict";
        var me = this,
            sysInfo = Mini2.SystemInfo,
            cfg = sysInfo.window;

        var el = Mini2.$joinStr(me.headerTpl);

        var headerBodyEl = el.cFirst('.mi-header-body');
        var boxInnerEl = headerBodyEl.cFirst('.mi-box-inner');
        var boxTargetEl = boxInnerEl.cFirst('.mi-box-target');

        var textContainerEl = boxTargetEl.cFirst('.mi-header-text-container');
        var headerTextEl = textContainerEl.cFirst('.mi-header-text');
        var toolEl = boxTargetEl.cFirst('.mi-tool');

        console.debug('me.closeEnabled = ', me.closeEnabled);

        if (!me.closeEnabled) {
            toolEl.hide();
        }

        headerTextEl.html(me.text);


        me.el = el;

        me.headerBodyEl = headerBodyEl;
        me.boxInnerEl = boxInnerEl;
        me.boxTargetEl = boxTargetEl;

        me.textContainerEl = textContainerEl;
        me.headerTextEl = headerTextEl;
        me.toolEl = toolEl;


        if ('touch' == sysInfo.mode) {

            toolEl.css({
                width: 32,
                height: 32,
                top: -10,
            });
        }


        $(toolEl).mouseenter(function () {
            $(this).addClass('mi-tool-over');
        })
        .mouseout(function () {
            $(this).removeClass('mi-tool-over');
        })
        .muBind('mousedown',Mini2.emptyFn)
        .muBind('mouseup', function (e) {
            me.onAction('close',e);
        });

        $(me.renderTo).append(el);
        
        boxInnerEl.css('height', cfg.headerHeight || 16);

        //width: 16px; height: 16px;  left: 364px; top: 0px; 


        me.mouseBind(el);
    },

    onAction: function (name) {
        "use strict";
        //log.debug('onAction = ' + name);

        $(this).triggerHandler('action', [name]);

        Mini2.EventManager.stopEvent();
    }

});



/************************************************************************/
/*                                           */
/*    ui/Window.js                                                         */
/*                                           */
/************************************************************************/

/// <reference path="../Mini.js" />




Mini2.define('Mini2.ui.Window', {

    extend: 'Mini2.ui.Component',

    alias: 'widget.window',

    text: 'Window',

    /**
     * 特殊属性, 用于非 IFrame 框架的...作为内部处理用
     */
    bite: true,

    /**
     * 启动晃动
     */
    isTween:true,


    formClosed: function (fun) {
        this.bind('formClosed', fun);
    },

    formClosing: function (fun) {
        this.bind('formClosing', fun);
    },

    closeEnabled:true,

    windwoBoxTpl: [
        '<div class="mi-window ',
            'mi-layer ',
            'mi-window-default ',
            'mi-closable ',
            'mi-window-closable ',
            'mi-window-default-closable ',
            'mi-border-box ',
            'mi-resizable ',
            'mi-window-resizable ',
            'mi-window-default-resizable" ',
            'style="right: auto; position: fixed !important;">',
        '</div>'
    ],

    ghostTpl: ['<div class="mi-window-proxy" style="right: auto;display:none;"></div>'],


    bodyTpl: [
        '<div class="mi-window-body mi-window-body-default mi-closable mi-window-body-closable mi-window-body-default-closable ',
            'mi-window-body-default mi-window-body-default-closable mi-noborder-trbl " ',
            'style="padding: 0px; overflow: hide; left: 0px;">',
        '</div>'
    ],

    shadowTpl: [
        '<div class="mi-css-shadow mi-css-shadow-default" role="presentation" style="right: auto;position: fixed ; ',
            'left: 572px; top: 186px; width: 400px; height: 261px; ',
            'display: block;">',
        '</div>'
    ],

    maskTpl: ['<div class="mi-mask" style="right: auto; left: 0px; top: 0px; position: fixed;"></div>'],

    //蒙层的透明度
    //maskOpacity:1,


    contentTpl: ['<iframe src="" frameborder="0" dock="full">框架窗体</iframe>'],


    url: null,


    iframe: true,

    // iframe 内容
    iframeContent: null, 

    //default,center_screen,center_parent
    startPosition: 'default',

    //normal = 根据尺寸, min, max = 最大化
    //    state: 'normal',

    autoScroll: false,

    width: 600,
    height: 400,

    left: 100,
    top: 20,


    headerVisible: true,    //显示标题
    shadowVisible: true,    //显示阴影

    header: null,

    onInit: Mini2.emptyFn,

    onLoad: Mini2.emptyFn,

    //@private
    zIndex: 19000,

    //模式窗体
    mode: false,

    buttons: false,
    buttonPanel: false,
    buttonAlign: 'right',




    //初始化组件
    initComponent: function () {
        "use strict";
        var me = this;

        Mini2.ui.WindowManager.regWin(this);

        me.onInit();
        me.onLoad();

    },

    render_ButtonPanel: function (renderTo) {
        "use strict";
        var me = this,
            panel,
            btns = me.buttons,
            sysInfo = Mini2.SystemInfo,
            cfg = sysInfo.window;

        if (btns) {

            var footerHeight = (cfg.footerHeight + 12) || 24;

            //console.debug("footerHeight = ", cfg.footerHeight);

            panel = Mini2.create('Mini2.ui.panel.Panel', {
                baseCls: Mini2.baseCSSPrefix + 'toolbar',
                dock: 'bottom',
                ui: 'footer',
                height: footerHeight,
                scroll: 'none',
                padding: {
                    left: 8,
                    top: 8,
                    right: 8,
                    bottom: 4
                },
                renderTo: renderTo
            });

            panel.render();


            me.render_Button(panel.boxTarget);

            me.buttonPanel = panel;
        }

    },


    /**
    * 初始化按钮组
    **/
    render_Button: function (renderTo) {
        "use strict";
        var me = this,
            cfg,
            btn,
            i,
            btns = me.buttons,
            newBtns = [];

        if (btns) {

            for (i = 0; i < btns.length; i++) {
                cfg = Mini2.applyIf(Mini2.clone(btns[i]), {
                    renderTo: renderTo,
                    ownerWindow: me
                });

                newBtns[i] = btn = Mini2.create('Mini2.ui.button.Button', cfg);
                btn.render();

                btn.el.addClass('mi-box-item');
            }

            delete me.buttons;
            me.buttons = newBtns;

        }
    },

    focusBase:function(){
        "use strict";
        var me = this;

        Mini2.ui.WindowManager.moveFirst(me);

        Mini2.ui.FocusMgr.setControl(me);

        return me;
    },

    focus: function () {
        return this.focusBase();
    },


    setZIndex: function (zIndex) {
        "use strict";

        var me = this,
            el = me.el;

        me.zIndex = zIndex;

        if (!me.el) {
            return;
        }

        el.css('z-index', zIndex);

        if (me.shadowVisible) {
            me.shadowEl.css({ 'z-index': zIndex - 1 });
        }

    },


    header_Action: function (e, name) {
        "use strict";
        var me = e.data;

        switch (name) {
            case 'close': me.close(); break;
            default:

        }

    },


    getOffset: function () {
        return $(this.el).offset();
    },


    getBtnWidth: function (btns) {
        "use strict";
        var w = 0, i = btns.length;

        while (i--) {
            w += btns[i].getWidth();
        }

        return w;
    },

    setButtonLayout: function (x, btns) {
        "use strict";
        var me = this,
            i,
            btn,
            len = btns.length;

        for (i = 0; i < len; i++) {
            btn = btns[i];
            btn.setLeft(x);

            x += btn.getWidth() + 6;
        }

    },

    updateLayout: function () {
        "use strict";
        var me = this,
            btn,
            w, i,
            l,
            btns = me.buttons;

        if (btns) {
            i = btns.length;
            w = me.getBtnWidth(btns);
            l = me.width - w - i * 6 - 20;

            switch (me.buttonAlign) {
                case 'left': me.setButtonLayout(0, btns); break;
                case 'center': me.setButtonLayout(l / 2, btns); break;
                case 'right': me.setButtonLayout(l, btns); break;
            }
        }

    },


    setSizeBase:function(w,h){
        "use strict";
        var me = this,
            el = me.el,
            bodyH = h - 10,
            bodyT = 0,
            btn,
            btns = me.buttons,
            bodyW = w - 10,
            contentEl = me.contentEl,
            size,
            sysInfo = Mini2.SystemInfo,
            cfg = sysInfo.window;


        me.width = w || me.width;
        me.height = h || me.height;

        el.css({ width: w, height: h });

        if (me.buttonPanel) {

            var footerHeight = (cfg.footerHeight + 8) || 36; //12 是 padding-top + padding-bottom

            me.buttonPanel.setSize(w - 10, footerHeight);


            bodyH -= footerHeight;

            me.updateLayout();
        }

        if (me.headerVisible) {
            me.header.setWidth(w);
            bodyH -= cfg.headerHeight + 12 || 31;
            bodyT += cfg.headerHeight + 12 || 31;
        }

        if (me.buttonPanel) {
            me.buttonPanel.setTop(bodyT + bodyH);
        }

        size = { width: bodyW, height: bodyH };

        me.bodyEl.css(size).css({
            top: bodyT
        });


        if (contentEl && ('full' == contentEl.attr('dock') || 'full' == contentEl.attr('data-dock'))) {

            if (contentEl.get(0).tagName == 'IFRAME') {
                contentEl.attr(size);
            }
            else {
                contentEl.css(size);

                if (me.bite) {
                    //因为事件机制的不完善，加了两个事件，防止点击到底下 Window，触发了其他事件。
                    contentEl.bind('mousedown', function (e) {

                        Mini2.ui.FocusMgr.setControl(this);

                    });
                    contentEl.muBind('mouseup', Mini2.emptyFn);
                }

            }
        }


        if (me.shadowVisible) {
            me.shadowEl.css({
                width: w,
                height: h - 8
            });
        }
            
        return me;
    },


    //@private
    setSize: function (w, h) {
        var me = this;

        me.setSizeBase(w, h);

        return me;
    },

    /**
    * 设置尺寸(动画效果)
    */
    setSizeTween: function (w, h) {
        "use strict";
        var me = this,
            srcX = me.left,
            srcY = me.top,
            srcW = me.width,
            srcH = me.height;

        if (!TWEEN) {
            me.setSize(w, h);
            return;
        }

        var span = 300;

        if (!me.isTween) {
            span = 100;
        }

        var coords = {
            x: srcX, y: srcY,
            w: srcW, h: srcH
        };

        var tween = new TWEEN.Tween(coords)
            .to({
                x: srcX - (w - srcW) / 2,
                y: srcY - (h - srcH) / 2,
                w: w,
                h: h
            }, span)
            .onUpdate(function () {
                me.setLocation(this.x,this.y);
                me.setSize(this.w, this.h);

            })
            .onComplete(function () {
                Mini2.TweenManager.remove(tween);
            })
            .easing(TWEEN.Easing.Quadratic.In);

        tween.muid = Mini2.newId();
            
        Mini2.TweenManager.add(tween);

        tween.start();


        return me;
    },

    setLocationTween:function(x,y){
        "use strict";
        var me = this,
            srcX = me.left,
            srcY = me.top;

        var coords = {
            x: srcX, y: srcY,
            opacity:0
        };

        var tween = new TWEEN.Tween(coords)
            .to({
                x: x,
                y: y,
                opacity: 1
            }, 500)
            .onUpdate(function () {

                me.setLocation(this.x, this.y);

                me.el.css('opacity', this.opacity)
            })
            .onComplete(function () {

                Mini2.TweenManager.remove(tween);

            })
            .easing(TWEEN.Easing.Quadratic.In);

        tween.muid = Mini2.newId();

        Mini2.TweenManager.add(tween);

        tween.start();


        return me;
    },

    setLocation: function (x, y, isInit) {
        "use strict";
        var me = this;


        if (!Mini2.isNumber(x)) {
            x = parseInt(x);
        }

        if (!Mini2.isNumber(y)) {
            y = parseInt(y);
        }

        if (isInit && ('center_screen' == me.startPosition || 'default' == me.startPosition)) {
            x = ($(window).width() - me.width) / 2;
            y = ($(window).height() - me.height) / 2;
        }

        if (y < 0) { y = 0; }

        me.left = x;
        me.top = y;


        me.el.css({ left: x, top: y });

        if (me.shadowVisible) {
            me.shadowEl.css({ left: x, top: y + 8 });
        }
        return me;
    },


    initGhost: function () {
        "use strict";
        var me = this;

        if (!me.ghostEl) {
            me.ghostEl = Mini2.$joinStr(me.ghostTpl);

            $(me.renderTo).append(me.ghostEl);


        }
    },


    setGhostLocation: function (x, y) {
        "use strict";
        var me = this,
            ghostEl = me.ghostEl;

        ghostEl.css({
            left: x,
            top: y
        });
        return me;
    },


    beginDrag: function () {
        "use strict";
        var me = this,
            ghostEl,
            el = me.el,
            zIndex = el.css('z-index');

        zIndex = parseInt(zIndex);

        me.initGhost();

        ghostEl = me.ghostEl;



        ghostEl.css({
            left: el.css('left'),
            top: el.css('top'),
            width: el.css('width'),
            height: el.css('height'),
            'z-index': zIndex + 100
        });

        ghostEl.muBind('mouseup', Mini2.emptyFn);

        ghostEl.show();

        if (me.shadowVisible) {
            me.shadowEl.hide();
        }

        el.hide();
        return me;
    },


    endDrag: function () {
        "use strict";
        var me = this,
            ghostEl = me.ghostEl,
            el = me.el,
            x, y;

        ghostEl.hide();

        x = ghostEl.css('left');
        y = ghostEl.css('top');

        me.setLocation(x, y);

        if (me.shadowVisible) {
            me.shadowEl.show();
        }

        el.show();

        return me;

    },

    

    /**
    * 显示蒙层
    **/
    renderMask: function () {
        "use strict";
        var me = this,
            el,
            maskEl,
            win = $(window);

        if (me.mode) {

            me.maskEl = maskEl = Mini2.$join(me.maskTpl);
            //maskEl.removeClass('mi-mask-hide');

            maskEl.css({
                width: win.width(),
                height: win.height(),
                'z-index': me.zIndex - 2
            });


            if (me.maskOpacity) {
                maskEl.css('opacity', me.maskOpacity);
                maskEl.css('filter', 'alpha(opacity=' + me.maskOpacity * 100 + ')');
            }

            me.renderTo.append(maskEl);

            //因为事件机制的不完善，加了两个事件，防止点击到底下 Window，触发了其他事件。
            maskEl.muBind('mousedown', Mini2.emptyFn);
            maskEl.muBind('mouseup', Mini2.emptyFn);
        }
        return me;

    },


    getText: function () {
        return this.text;
    },

    setText: function (value) {
        "use strict";
        var me = this;
        me.text = value;
        me.header.setText(value);
        return me;
    },

    //显示标题
    renderHeader: function (el) {
        "use strict";
        var me = this;
        if (me.headerVisible) {

            var header = me.header = Mini2.create('Mini2.ui.WindowHeader', {
                width: me.width,
                owner: me,
                renderTo: el,
                text: me.text,
                closeEnabled : me.closeEnabled
            });

            header.render();
            $(header).bind('action', me, me.header_Action);
        }
        return me;
    },

    //显示阴影
    renderShadow: function () {
        "use strict";
        var me = this;
        if (me.shadowVisible) {
            me.shadowEl = Mini2.$joinStr(me.shadowTpl);
            me.shadowEl.css('z-index', me.zIndex - 1);

            me.renderTo.append(me.shadowEl);

        }

        return me;
    },

    renderEl: function () {
        "use strict";
        var me = this,
            el,
            bodyEl,
            header;

        me.el = el = Mini2.$join(me.windwoBoxTpl);
        me.renderTo.append(el);

        el.mouseup(function (e) {

            Mini2.EventManager.stopEvent(e);

        });


        el.data('me', me);
        el.css('z-index', me.zIndex);


        me.bodyEl = bodyEl = Mini2.$join(me.bodyTpl);
        el.append(bodyEl);

        if (me.autoScroll && !me.iframe) {
            bodyEl.css('overflow', 'auto');
        }

        bodyEl.css('border-style', 'none');

        me.renderHeader(el);
        me.renderShadow();

        me.render_ButtonPanel(el);

        return me.el;
    },

    setUrl: function (url) {
        "use strict";
        var me = this,
            contentEl = me.contentEl;

        if (me.iframe) {
            contentEl.attr('src', me.url);
        }
    },

    getContentEl:function(){
        var me = this,
            contentEl;

        contentEl = Mini2.$joinStr(me.contentTpl);

        return contentEl;
    },

    renderContent: function () {
        "use strict";
        var me = this,
            contentEl,
            curMini2;

        me.contentEl = contentEl = me.getContentEl();
        me.bodyEl.append(contentEl);

        if (me.iframe) {


            contentEl.attr('muid', me.muid);

            if (!me.autoScroll) {
                contentEl.attr('scrolling', 'no');
            }

            //var win = contentEl[0].contentWindow;

            //win.ownerWindow = me;

            //curMini2 = win.Mini2;

            //if (curMini2 && curMini2.onwerPage) {
            //    curMini2.onwerPage.ownerWindow = me;
            //}

            contentEl.bind('load', { 'owner': me }, me.iframe_load);

            me.iFrameReady.call(me, contentEl[0], function () {

                //console.log("xxxxxxxxxx" + new Date().getTime());

                var win = contentEl[0].contentWindow;
                win.ownerWindow = me;

                curMini2 = win.Mini2;

                if (curMini2 && curMini2.onwerPage) {
                    curMini2.onwerPage.ownerWindow = me;
                }
            });

            if (me.url) {
                contentEl.attr('src', me.url);
            }
            else if (me.iframeContent) {

                var cw = contentEl[0].contentWindow;
                var doc = cw.document;

                doc.open();
                doc.write(me.iframeContent);
                doc.close();
            }

        }

        return contentEl;
    },

    iframe_load: function (e) {
        "use strict";
        var me = this,
            iframeId = $(me).attr('muid'),
            win = me.contentWindow,
            curMi,
            doc = win.document,
            body = doc.body;

        //console.log("iframe 加载完成" + new Date().getTime(), win);

        if (!win.ownerWindow) {

            //console.log("iframe 加载完成 2");

            win.ownerWindow = e.data['owner'];

            curMi = win.Mini2;

            if (curMi && curMi.onwerPage) {
                curMi.onwerPage.ownerWindow = e.data['owner'];
            }
        }
        //        body.attr('mi-owner-window', 'true');    //当做标记。
    },


    renderBase: function () {
        "use strict";
        var me = this,
            el,
            win = $(window);

        me.renderMask();
        el = me.renderEl();

        me.renderContent();



        if ('max' == me.state) {

            me.win_resize.call(me);

            win.resize(function () {
                me.win_resize.call(me);
            });

        }
        else {


            me.setSize(me.width, me.height);
            me.setLocation(me.left, me.top, true);
        }


        return el;
    },

    render: function () {
        "use strict";
        var me = this,
            el;

        el = me.renderBase();
        return el;
    },

    win_resize: function () {
        "use strict";
        var me = this,
            win = $(window),
            w = win.width() - 20,
            h = win.height() - 20;

        me.setSize(w, h);
        me.setLocation(10, 10, true);
    },

    setOpacity:function(value){
        var me = this,
            el = me.el;

        el.css({
            opacity: value
        });

        if (me.shadowVisible) {
            me.shadowEl.css({ opacity: value });
        }

        return me;
    },

    setOpacityTween: function (value) {
        "use strict";
        var me = this,
            el = me.el;

        if (!window.TWEEN) {

            el.css({ opacity: value });

            if (me.shadowVisible) {
                me.shadowEl.css({ opacity: value });
            }

            return;
        }

        var coords = {
            opacity: el.css('opacity')
        };

        var tween = new TWEEN.Tween(coords)
            .to({
                opacity: 1
            }, 300)
            .onUpdate(function () {
                el.css('opacity', this.opacity)

                if (me.shadowVisible) {
                    me.shadowEl.css({ opacity: this.opacity });
                }

            })
            .onComplete(function () {

                Mini2.TweenManager.remove(tween);

            })
            .easing(TWEEN.Easing.Quadratic.In);

        tween.muid = Mini2.newId();

        Mini2.TweenManager.add(tween);

        tween.start();

        return me;
    },

    firstShow: 0,


    /**
    * show 之前执行的函数
    */
    showBefore: Mini2.emptyFn,

    /**
    * show 之后执行的函数
    */
    showAfter: Mini2.emptyFn,

    //显示窗体
    show: function () {
        "use strict";
        var me = this,
            isTween = me.isTween,
            el = me.el,
            shadowEl;

        if (!this.el) {
            me.firstShow = 0;
            me.render();
        }
        else {
            me.firstShow++;
        }

        el = me.el;

        if (isTween) {
            me.setOpacity(0);
        }


        shadowEl = me.shadowEl;

        if (me.shadowVisible) {
            shadowEl.show();
        }

        me.showBefore();

        el.show();

        me.showAfter();

        if (isTween) {
            me.setOpacityTween(1);
        }

        me.focus();

        return me;
    },


    //隐藏窗体，不关闭
    hide: function () {
        "use strict";
        var me = this,
            el = me.el,
            shadowEl = me.shadowEl,
            maskEl = me.maskEl;

        if (el) {
            el.hide();
        }

        if (me.shadowVisible) {
            shadowEl.hide();
        }

        if (me.mode) {


            if (maskEl[0].addEventListener) {

                maskEl[0].addEventListener("webkitAnimationStart", function () {
                    me.isCartoonEnd = true;
                });

                maskEl[0].addEventListener("webkitAnimationEnd", function () {
                    if (me.isDispose) {
                        maskEl.remove();
                    }
                });



                //如果 100 毫秒内没有开始动画, 那么直接销毁掉
                Mini2.setTimer(function () {
                    if (me.isCartoonEnd) {
                        return false;
                    }

                    if (me.isDispose) {
                        maskEl.remove();
                        return false;
                    }
                }, {
                    limit: 1,
                    overtime: 1000,
                    interval: 100,
                });

            }
            else {

                Mini2.setTimer(function () {
                    if (me.isDispose) {
                        maskEl.remove();
                        return false;
                    }
                }, {
                    limit: 1,       //只执行一次
                    interval: 300
                });
            }


            maskEl.addClass('mi-mask-hide');


        }

        return me;
    },

    // This function ONLY works for iFrames of the same origin as their parent
    iFrameReady: function(iFrame, fn) {
        var timer;
        var fired = false;

        function ready() {
            if (!fired) {
                fired = true;
                clearTimeout(timer);
                fn.call(this);
            }
        }

        function readyState() {
            if (this.readyState === "complete") {
                ready.call(this);
            }
        }

        // cross platform event handler for compatibility with older IE versions
        function addEvent(elem, event, fn) {
            if (elem.addEventListener) {
                return elem.addEventListener(event, fn);
            } else {
                return elem.attachEvent("on" + event, function () {
                    return fn.call(elem, window.event);
                });
            }
        }

        // use iFrame load as a backup - though the other events should occur first
        addEvent(iFrame, "load", function () {
            ready.call(iFrame.contentDocument || iFrame.contentWindow.document);
        });

        function checkLoaded() {

            var doc;

            if (iFrame.contentDocument) {
                doc = iFrame.contentDocument;
            }

            if (!doc && iFrame.contentWindow) {
                doc = iFrame.contentWindow.document;
            }

            
            
            // We can tell if there is a dummy document installed because the dummy document
            // will have an URL that starts with "about:".  The real document will not have that URL
            if (doc && doc.URL.indexOf("about:") !== 0) {
                if (doc.readyState === "complete") {
                    ready.call(doc);
                } else {
                    // set event listener for DOMContentLoaded on the new document
                    addEvent(doc, "DOMContentLoaded", ready);
                    addEvent(doc, "readystatechange", readyState);
                }
            } else {
                // still same old original document, so keep looking for content or new document
                timer = setTimeout(checkLoaded, 1);
            }
        }

        checkLoaded();
    },



    //关闭窗体
    close: function (e) {
        "use strict";
        var me = this,
            cancel;

        e = e || {};

        cancel = me.trigger('formClosing', e);

        if (!cancel) {
            me.trigger('formClosed', e);

            me.hide();

            me.dispose();
        }

        return me;
    },


    isDispose : false,

    //释放内存
    dispose: function () {
        "use strict";
        var me = this,
            el = me.el,
            shadowEl = me.shadowEl,
            mask = me.maskEl;

        me.isDispose = true;

        //if (mask) {
        //    if (mask.hasClass('mi-mask-hide')) {
        //        setTimeout(function () {
        //            mask.remove();
        //        }, 300);
        //    }
        //    else {
        //        mask.remove();
        //    }
        //}

        if (el) { el.remove(); }
        if (shadowEl) { shadowEl.remove(); }
        if (me.ghostEl) { me.ghostEl.remove(); }

        Mini2.ui.WindowManager.removeWin(me);
    }

});




/**
* 拖拽
*
*
*/
Mini2.define('Mini2.ui.Draggable', {

    el: null,

    srcX: 0,
    srcY: 0,

    srcLocation:null,

    bind: function () {

        "use strict";
        var me = this,
            el = me.el;

        el.muBind('mousedown', me, function (e) {

            me.srcLocation = $(el).offset();

            me.srcX = event.pageX;
            me.srcY = event.pageY;

            el.focus();

            console.log("ddddddddddd");

        })
        .muBind('mouseup', me, function (e) {

        })
        .muBind('mousemove', me, function (e) {

            var offsetX = event.pageX - me.srcX;
            var offsetY = event.pageY - me.srcY;

            var x = offsetX + me.srcLocation.left;
            var y = offsetY + me.srcLocation.top;

            if (!me.isDrag) {
                if (Math.abs(offsetX) >= 4 || Math.abs(offsetY) >= 4) {
                    me.isDrag = true;

                }
            }
            else if (me.isDrag) {
                el.css({
                    'left': x,
                    'top': y
                });
                
                //me.owner.setGhostLocation(x, y);
            }
            
        });

    }

});




/************************************************************************/
/*                                           */
/*    ui/MessageBox.js                                                     */
/*                                           */
/************************************************************************/

/// <reference path="../Mini.js" />


Mini2.define('Mini2.ui.MessageBox', {

    extend: 'Mini2.ui.Window',

    mode: true,

    buttonAlign: 'center',

    startPosition: 'center_screen',

    width:350,

    height:130,

    icon:'info',

    buttons: [{
        text: '确定',
        width: 80,
        click: function (e) {
            this.ownerWindow.close();
        }
    }],



    /**
    * @property
    * The CSS class that provides the INFO icon image
    */
    INFO: Mini2.baseCSSPrefix + 'message-box-info',
    /**
    * @property
    * The CSS class that provides the WARNING icon image
    */
    WARNING: Mini2.baseCSSPrefix + 'message-box-warning',
    /**
    * @property
    * The CSS class that provides the QUESTION icon image
    */
    QUESTION: Mini2.baseCSSPrefix + 'message-box-question',
    /**
    * @property
    * The CSS class that provides the ERROR icon image
    */
    ERROR: Mini2.baseCSSPrefix + 'message-box-error',

    contentTpl: [
         '<div class="mi-box-inner " role="presentation" style="height: 55px; width: 339px;" dock="full">',
            '<div class="mi-box-target" style="width: 339px;">',
                '<div class="mi-container mi-box-item mi-window-item mi-container-default mi-box-layout-ct" ',
                    'style="overflow: hidden; padding: 10px; margin: 0px; right: auto; left: 0px; top: 0px;">',



                '</div>',
            '</div>',
        '</div>'],

    contentTpl2:[

        '<div class="mi-box-inner " role="presentation" style="width: 319px; height: 35px;">',
            '<div class="mi-box-target" style="width: 319px;">',
                '<div class="mi-component mi-box-item mi-component-default mi-dlg-icon " ',
                    'style="width: 50px; height: 35px; margin: 0px; right: auto; left: 0px; top: 0px;">',
                '</div>',
                '<div class="mi-container mi-box-item mi-container-default" style="margin: 0px;right: auto; left: 50px; top: 0px;">',
                    '<span style="display: table;">',
                        '<div class="mi-message-box-textbox" style="height: 100%; vertical-align: top;  white-space:nowrap;">',

                        '</div>',
                    '</span>',
                '</div>',
            '</div>',
        '</div>'
    ],

    title: '标题',

    msg: '提示信息',
        
    renderHeader: function (el) {
        "use strict";
        var me = this,
            header;
        if (me.headerVisible) {
            header = me.header = Mini2.create('Mini2.ui.WindowHeader', {
                width: me.width,
                owner: me,
                renderTo: el,
                text: me.title
            });
            header.render();
            $(header).bind('action', me, me.header_Action);
        }
    },

    renderContent: function () {
        "use strict";
        var me = this,
            sysInfo = Mini2.SystemInfo,
            cfg = sysInfo.window,
            content2El,
            contentEl,
            iconEl,
            inputEl,
            inputBodyEl,
            bodyEl = me.bodyEl;

        me.contentEl = contentEl = Mini2.$join(me.contentTpl);
        
        bodyEl.append(contentEl);

        me.content2El = content2El = Mini2.$join(me.contentTpl2);

        $(contentEl).find('.mi-container').append(content2El);



        me.iconEl = iconEl = content2El.find('.mi-dlg-icon');
        me.inputBodyEl = inputBodyEl = content2El.find('.mi-message-box-textbox');

        //默认 'info': 
        switch (me.icon) {
            case 'error': iconEl.addClass(me.ERROR);break;
            case 'question':iconEl.addClass(me.QUESTION);break;
            case 'warning': iconEl.addClass(me.WARNING);break; 
            default: iconEl.addClass(me.INFO);break;  
        }

        inputBodyEl.html(me.msg);

        //me.inputEl = inputEl = Mini2.create('Mini2.ui.form.Label', {
        //    renderTo: inputBodyEl,
        //    hideLabel: true,
        //    value: me.msg
        //});

        //inputEl.render();
    },



    render: function () {
        "use strict";
        var me = this,
            sysInfo = Mini2.SystemInfo,
            cfg = sysInfo.window;

        me.renderMask();
        me.renderEl();

        me.renderContent();


        var msgHeight = me.inputBodyEl.height();
        var msgWidth = me.inputBodyEl.width() ;

        if (msgWidth < 200) { msgWidth = 200; }
        if (msgHeight < 40) { msgHeight = 40; }

        var footerHeight = me.buttonPanel.getHeight();

        me.content2El.height(msgHeight);
        me.content2El.width(msgWidth + 50);

        var innerEl = me.content2El.children('.mi-box-inner');

        me.height = msgHeight + (cfg.headerHeight + 16) + footerHeight;   //  || cfg.msgHeight || me.height;

        me.height += 30;

        me.width = msgWidth + 40 + 50;

        me.setSize(me.width, me.height);
        me.setLocation(me.left, me.top, true);

        setTimeout(function () {

            me.buttons[0].focus();

        }, 200);
    }



});



//带文本框的收入窗体
Mini2.define('Mini2.ui.PromptWinddow', {

    extend: 'Mini2.ui.Window',

    width:500,
    height:180,

    mode: true,
    text: '文本框',
    iframe: false,
    startPosition: 'center_screen',

    contentTpl: [
        '<div style="padding:10px;" class="mi-form-item-body">',
            '<div class="input-message" style="height:40px;">请输入:</div>',
            '<input type="text" style="width:100%;resize: none;" class="input-box mi-form-field mi-form-text">',
                '',
            '</input>',
        '</div>'
    ],

    buttons: [{
        text: '确定',
        width: 80,
        click: function () {
            var me = this,
                win = me.ownerWindow,
                okClick = win.okClick,
                cancel ;

            if (okClick) {
                cancel = okClick.call(win);

                if (true === cancel) {
                    return;
                }
            }

            win.close({ result: 'ok' });
        }
    }, {
        text: '取消',
        width: 80,
        click: function () {
            var me = this,
                win = me.ownerWindow;

            if (win.cancelClick) {
                win.cancelClick.call(win);
            }

            win.close({ result: 'cancel' });
            
        }
    }],

    okClick: false,

    cancelClick: false,


    setValue: function (value) {
        "use strict";
        var me = this;

        $(me.contentEl).children('.input-box').val(value);
        return me;
    },

    getValue: function () {
        "use strict";
        var me = this;

        return $(me.contentEl).children('.input-box').val();
    },


    render: function () {
        "use strict";
        var me = this,
            contentEl;

        me.renderBase();

        contentEl = $(me.contentEl);

        contentEl.children('.input-message').html(me.message);

        setTimeout(function () {

            contentEl.children('.input-box').focus();

        }, 100);
    }


});




Mini2.Msg = {

    /**
    * 提示框
    **/
    alert: function (title, msg, fn) {
        "use strict";

        var msgBox, cfg;

        if (typeof msg === 'function') {
            fn = msg;
            msg = title;
            title = '';
        }
        else if (1 == arguments.length) {
            msg = title;
            title = '提示';
        }

        cfg = {
            title: title,
            msg: msg,
            icon: 'info',
            buttons: [{
                text: '确定',
                width: 80,
                click: fn ? fn : function (e) {
                    this.ownerWindow.close();
                }
            }]
        };

        msgBox = Mini2.createTop('Mini2.ui.MessageBox', cfg);
        msgBox.show();

        return msgBox;
    },




    /**
    * 询问
    **/
    confirm: function (title, msg, fn, cancelFn) {
        "use strict";
        var msgBox, cfg;

        console.debug("title", title);
        console.debug("msg", msg);

        if (typeof msg === 'function') {
            cancelFn = fn;
            fn = msg;
            msg = title;
            title = '询问';
        }


        cfg = {
            title: title,
            msg: msg,
            icon: 'question',
            buttons: [{
                text: '确定',
                width: 80,
                click: function (e) {
                    var result;

                    if (fn) {
                        result = fn.call(this);
                    }

                    if (false !== result) {
                        this.ownerWindow.close();
                    }
                }
            }, {
                text: '取消',
                width: 80,
                click: function (e) {
                    var result;

                    if (cancelFn) {
                        result = cancelFn.call(this);
                    }

                    if (false !== result) {
                        this.ownerWindow.close();
                    }
                }
            }]
        };


        msgBox = Mini2.createTop('Mini2.ui.MessageBox', cfg);
        msgBox.show();

        return msgBox;
    },


    /**
    * 文字收入框
    **/
    prompt: function (title, msg, fn, cancelFn) {
        "use strict";
        var msgBox;
        
        if (typeof msg === 'function') {
            cancelFn = fn;
            fn = msg;
            msg = title;
                        
            title = '';
        }

        msgBox = Mini2.createTop('Mini2.ui.PromptWinddow', {

            text: title,
            message: msg,
            
            okClick: fn,

            cancelClick: cancelFn

        }); 

        msgBox.show();

        return msgBox;
    }

}


/************************************************************************/
/*                                           */
/*    ui/Toast.js                                                          */
/*                                           */
/************************************************************************/


//Notiser.init = function (text) {
//    this.text = text || '';
//    this.style = 'basic';
//    this.age = basicAge;
//    this.validate();
//};

Mini2.define('Mini2.ui.Toast', {

    //基础容器
    basePanelTpl: [
        '<div class="mi-toast-panel" >',
            '<div class="mi-toast-panel-innser" >',
                '<div class="mi-toast-target mi-toast-left-notify" style="width:25%; pointer-events:none;" ></div>',
                '<div class="mi-toast-target mi-toast-right-notify" style="left:75%; width:25%; pointer-events:none;" ></div>',
                '<div class="mi-toast-target mi-toast-center-notify" style="left:33.33%; width:33.33%; pointer-events:none;" ></div>',
            '</div>',
        '</div>'],

    

    supportedStyles : ['basic', 'warning', 'success'],

    basicDuration: 3000,

    //text: '',

    style:'basic',


    validate: function () {
        var me = this,
            supportedStyles = me.supportedStyles;

        // if user sets not supported style, setting style to basic
        if (Mini2.Array.indexOf(supportedStyles,me.style) === -1) {
            me.style = supportedStyles[0];
        }
    },

    // Setting style
    setStyle: function (style) {
        var me = this;

        me.style = style;
        me.validate();
        return me;
    },

    // Setting text
    setText: function (text) {
        var me = this;
        me.text = text || '';
        return me;
    },

    // Setting time how long notify is showing
    setDuration: function (duration) {
        var me = this;

        me.duration = duration > 0 ? duration : me.basicDuration;
        return this;
    },

    show : function(selector) {
        var me = this,
            basePanelEl,
            notiserElement;

        if ($('.mi-toast-panel').length == 0) {
            basePanelEl = Mini2.$join(me.basePanelTpl);

            $('body').append(basePanelEl);
        }

        notiserElement = $(document.createElement('div'))
          .addClass('mi-toast-notiser ' + me.style).append(me.text);

        // adding created div to first in notify list
        notiserElement.prependTo($(selector)).hide().slideDown();

        notiserElement.one('click', function() {
            me.fadeOutAndRemoveElement(me.el);
        });

        me.clear(notiserElement)

        return me;
    },

    // clearing notify after timeout
    clear: function (element) {
        var me = this;

        setTimeout(me.fadeOutAndRemoveElement, me.duration, element);
    },

    // fading out element and removing element from dom
    fadeOutAndRemoveElement : function(element) {
        element.fadeOut(function() {
            this.remove();
        });
    }
    
});

//显示一个消息，会在2秒钟后自动消失
Mini2.toast = function (text, duration, style) {     

    var frm = Mini2.createTop('Mini2.ui.Toast', {
        text: text,
        duration: duration || 3000,
        style: style || 'basic'
    });


    frm.show('.mi-toast-center-notify');

    //frm.render();

    return frm;
};


/************************************************************************/
/*                                           */
/*    ui/Pagination.js                                                     */
/*                                           */
/************************************************************************/

/// <reference path="../Mini.js" />

Mini2.define('Mini2.ui.Pagination', {

    //store: undefined,


    renderTo: Mini2.getBody(),

    urlFormat: '?page={0}',

    prevText: '上一页',
    nextText: '下一页',

    firstText: '首页',
    lastText: '尾页',


    curPage: 0,

    itemTotal: 0,
    rowCount: 20,

    pageCount: 0,

    startPage: 0,
    endPage: 0,


    /**
     * ui 类型, default=带分页码, more=更多, backAndNext=上一页, 下一页
     */
    uiType: 'default',


    /**
    * 隐藏行数选择框
    */
    hideRowCountSelect: false,

    /**
    el:null,
    **/

    visible: true,

    constructor: function (options) {
        "use strict";
        /// <summary>初始化</summary>
        var me = this;

        if (Mini2.isString(me.store)) {

            var store = Mini2.data.StoreManager.lookup(me.store);

            me.store = store;
        }

        me.bindStore(me.store);

    },

    bindStore: function (store) {
        "use strict";
        /// <summary>绑定数据仓库</summary>
        var me = this;

        if (!store) { return; }

        me.itemTotal = store.getTotalCount();
        me.renderButton();

        $(store).muBind('datachanged', me, me.store_dataChanged);
        $(store).muBind('load', me, me.store_load);
    },

    store_load: function (event, store) {
        "use strict";
        var me = event.data;

        me.itemTotal = store.getTotalCount();
        me.rowCount = store.pageSize;

        me.curPage = store.currentPage;

        me.renderButton();

    },

    store_dataChanged: function (event, store) {
        "use strict";
        var me = event.data;

        me.itemTotal = store.getTotalCount();
        me.rowCount = store.pageSize;

        me.curPage = store.currentPage;

        me.renderButton();

    },

    click: function (page, store) {

        var me = this;

        if (store) {
            store.loadPage(page);
        }
    },


    getFirstUrl: function () {
        "use strict";
        /// <summary>获取"首页"的超链接</summary>
        var me = this;
        return $.format(me.urlFormat, 0);
    },

    getPrevUrl: function () {
        "use strict";
        /// <summary>获取"上一页"的链接</summary>
        var me = this,
            p = me.curPage - 1;

        if (p < 0) { p = 0; }

        return $.format(me.urlFormat, p);
    },

    getNextUrl: function () {
        "use strict";
        /// <summary>获取"下一页"的链接</summary>
        var me = this,
            p = me.curPage + 1;

        if (p >= me.pageCount) {
            p = me.pageCount - 1;
        }

        return $.format(me.urlFormat, p);
    },


    /**
     * 获取"尾页"的链接
     */
    getLastUrl: function () {
        "use strict";
        var me = this;
        return $.format(me.urlFormat, me.pageCount - 1);
    },

    /**
     * 重新计算参数
     */
    resetParam: function () {
        "use strict";

        var me = this,
            curPage = me.curPage,
            itemTotal = me.itemTotal || 0,
            rowCount = me.rowCount,
            pageCount,
            startPage,
            endPage,
            startRow,
            endRow;

        var m = itemTotal % rowCount;

        pageCount = (itemTotal - m) / rowCount;

        if (m > 0) {
            pageCount++;
        }

        startPage = curPage - 4;
        endPage = curPage + 5;

        if (startPage < 0) {
            startPage = 0;

            //            m_EndPageIndex += 4 - m_Params.curPage;
        }

        if (endPage >= pageCount) {
            endPage = pageCount - 1;
        }


        startRow = curPage * rowCount;
        endRow = startRow + rowCount;

        if (endRow > itemTotal) {
            endRow = itemTotal;
        }

        me.pageCount = pageCount;
        me.startPage = startPage;
        me.endPage = endPage;

        me.startRow = startRow;
        me.endRow = endRow;
    },

    render: function () {
        "use strict";
        var me = this,
            el,
            uiType = me.uiType;

        me.visible = !!me.visible;

        if ('default' == uiType) {

            me.el = el = $('<div class="flickr" style="border-color: silver;border-width: 1px;"></div>');


            if (me.applyTo) {
                $(me.applyTo).append(el);
            }
            else {
                $(me.renderTo).append(el);
            }
                      

            if (!me.visible) {
                el.hide();
            }

            me.renderButton();
        }
        else if ('more' == uiType) {
            me.el = el = Mini2.$join([
                '<nav>',
                '<ul class="pager" style="margin:4px;">',
                '<li><a href="#">加载更多</a></li>',
                '</ul>',
                '</nav>']);


            if (me.applyTo) {
                $(me.applyTo).append(el);
            }
            else {
                $(me.renderTo).append(el);
            }
            if (!me.visible) {
                el.hide();
            }
        }
        else if ('backAndNext' == uiType) {

        }

    },


    /**
    * 渲染页数的选择框
    */
    renderRowCountSelectBox: function () {
        "use strict";
        var me = this,
            el = $(me.el),
            rowCount = me.rowCount;

        var pageSizeTB = Mini2.$joinStr([
            '<span style="float:left;position: relative;top: -6px;">',
            '<span>每页显示 </span>',
            '<select style="padding: 0px 2px 0px 2px;  border-bottom-style: none;" class="mi-form-field mi-form-text">',
            '<option>20</option>',
            '<option>50</option>',
            '<option>100</option>',
            '</select>',
            '<span> 行</span>',
            '</span>']);

        //每页显示多少的下拉框
        var selectEl = pageSizeTB.children('.mi-form-field');

        //显示多少条记录
        selectEl.val(me.rowCount);

        //改变事件
        selectEl.change(function () {
            me.rowCount = parseInt($(this).val());
            me.store.pageSize = me.rowCount;
            me.click.call(this, 0, me.store);
            return false;
        });


        el.append(pageSizeTB);
    },

    renderButton: function () {
        "use strict";
        /// <summary>重新设置</summary>


        var me = this,
            i;

        me.resetParam();

        var curPage = me.curPage,
            itemTotal = me.itemTotal || 0,
            rowCount = me.rowCount,
            pageCount = me.pageCount,
            startPage = me.startPage,
            endPage = me.endPage,
            el = $(me.el),
            command = 'loadPage';

        //log.debug("itemTotal = " + itemTotal);

        //重新构造分页的所有按钮
        el.html("");

        var btnFormat = "<a href='{0}' command='{3}' commandParam='{2}' page='{2}' class='button' valid='false'>{1}</a>";

        if (!me.hideRowCountSelect) {
            me.renderRowCountSelectBox();   //渲染行数选择框
        }

        if (curPage > 0) {
            el.append($.format(btnFormat, me.getFirstUrl(), me.firstText, 0, command));
        }
        else {
            el.append($.format("<span class='disabled'>{0}</span>", me.firstText));
        }

        if (curPage > 0) {
            el.append($.format(btnFormat, me.getPrevUrl(), me.prevText, curPage - 1, command));
        }
        else {
            el.append($.format("<span class='disabled'>{0}</span>", me.prevText));
        }


        for (i = startPage; i <= endPage; i++) {

            var url = $.format(me.urlFormat, i);
            if (i == curPage) {
                el.append($.format("<span class='current'>{0}</span>", i + 1));
            }
            else {
                el.append($.format(btnFormat, url, i + 1, i, command));
            }
        }


        if (curPage < pageCount - 1) {
            el.append($.format(btnFormat, me.getNextUrl(), me.nextText, curPage + 1, command));
            el.append($.format(btnFormat, me.getLastUrl(), me.lastText, pageCount - 1, command));
        }
        else {
            el.append($.format("<span class='disabled'>{0}</span>", me.nextText));
            el.append($.format("<span class='disabled'>{0}</span>", me.lastText));
        }

        //给各个按钮加上事件
        if (me.click) {
            var items = el.children("a.button");
            $(items).click(function () {
                var page = parseInt($(this).attr('page'));
                me.click.call(this, page, me.store);
                return false;
            });
        }

        el.append($.format("当前记录 {0}--{1} 条,共 {2} 条记录", me.startRow + 1, me.endRow, itemTotal));
    },

    show: function () {
        var me = this,
            el = me.el;

        el.show();
    },

    hide: function () {
        var me = this,
            el = me.el;

        el.hide();
    }
},
    function () {
        var me = this;

        Mini2.apply(this, arguments[0]);

        me.constructor();
    });


/************************************************************************/
/*                                           */
/*    ui/Offline.js                                                        */
/*                                           */
/************************************************************************/

/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.Offline', {

    tpl: [
        //offline-ui offline-ui-down offline-ui-down-5s
        //offline-ui offline-ui-down offline-ui-connecting offline-ui-waiting
        //offline-ui offline-ui-up offline-ui-up-5s

        '<div class="mi-offline" >',
            '<div class="mi-offline-content" >',
                '<div class="mi-offline-icon"></div>',
                '<div class="mi-offline-text">(尝试重新连接...)</div>',
            '</div>',
            '<a class="mi-offline-retry" >重新连接</a>',
        '</div>'
    ],

    info : {

        recont: '尝试重新连接...',

        lost: '你与服务器发生断网.',

        success: '你已重新连接服务器'
    },


    visible: false,



    initComponent:function(){
        var me = this;

    },

    baseRender:function(){
        var me = this,
            el ;

        me.el = el = Mini2.$join(me.tpl);

        me.textEl = el.find('.mi-offline-text')

        if (me.visible) {

            el.show(); 
        }
        else {
            el.hide();
        }

        $('body').append(el);

        return me;
    },

    render: function () {
        var me = this;

        me.baseRender();

        return me;
    },


    hide: function () {
        var me = this,
            txt,
            el = me.el;

        if (!me.visible) {
            return;
        }

        me.visible = false;

        txt = me.info['success'];
        me.textEl.html(txt);

        el.removeClass('mi-offline-down').removeClass('mi-offline-connecing');
        el.addClass('mi-offline-online');

        setTimeout(function () {
            el.animate({ top: -100 }, function () {
                el.hide();
            });
        }, 2000);

        return me;
    },

    show: function (infoCode) {
        var me = this,
            txt,
            el = me.el;

        if (me.visible) {
            return;
        }


        me.visible = true;

        infoCode = infoCode || 'lost';

        if (!el) {
            me.render();
            el = me.el;
        }

        txt = me.info[infoCode];
        
        me.textEl.html(txt);

        el.removeClass('mi-offline-connecing').removeClass('mi-offline-online');
        el.addClass('mi-offline-down');

        
        if (el.is(':visible')) {
        }
        else {
            el.css({ top: -100 });
            el.show().animate({ top: '0px' });
        }

        setTimeout(function () {

            txt = me.info['recont'];
            me.textEl.html(txt);

            el.removeClass('mi-offline-down').removeClass('mi-offline-online');
            el.addClass('mi-offline-connecing');

        }, 3000);

        //setTimeout(function () {

        //    me.hide();

        //}, 5000);
    }

}, function () {
    var me = this;

    me.renderTo = Mini2.getBody();

    Mini2.apply(me, arguments[0]);

    me.initComponent();

});


/************************************************************************/
/*                                           */
/*    ui/icon/Manager.js                                                   */
/*                                           */
/************************************************************************/



//图标插件
Mini2.define("Mini2.ui.icon.Manager", {


    /**
     *单件模式
     */
    singleton: true,

    /**
     * 按钮插件
     */
    btnConfig: [{
        keys: ['添加','新建', '新增', 'new', 'create'],
        iconCls: 'fa-plus'

    }, {
        keys: ['保存', 'save'],
        iconCls: 'fa-save'
    }, {
        keys: ['删除', 'delete', 'remote'],
        icon: null,
        iconCls: 'fa-remove',
        cls: 'mi-btn-remove',
        hoverCls: null
    }, {
        keys: ['编辑', '修改', 'edit', 'update'],
        iconCls: 'fa-pencil'
    }, {
        keys: ['打印', 'print'],
        iconCls: 'fa-print'
    }, {
        keys: ['查找', '查询', '搜索', 'search'],
        iconCls: 'fa-search'
    }, {
        keys: ['刷新', 'refresh'],
        iconCls: 'fa-refresh  ',

    }, {
        keys: ['导出 Excel', '导出Excel'],
        icon: '/res/file_ico/excel.png',
        iconCls: null
    }, {
        keys: ['导入'],
        icon: '/res/icon/leading_in.png'
    }, {
        keys: ['导出', 'export'],
        icon: '/res/icon/Export.png'
    }, {
        keys: ['下载', 'download'],
        iconCls: 'fa-download'
    }, {
        keys: ['查看', 'view'],
        iconCls: 'fa-search'
    }, {
        keys: ['选择'],
        iconCls: 'fa-list-alt'
    }, {
        keys: ['提交'],
        iconCls: 'fa-upload'
    }, {
        keys: ['撤销', '撤销提交'],
        iconCls: 'fa-reply'
    }, {
        keys: ['审核', '结案', '归档'],
        iconCls: 'fa-lock'
    }],



    buffer: {},



    /**
     * 获取插件
     */
    getPlugin: function (pluginName) {

        var me = this,
            plugin = me.buffer[pluginName];

        if (!plugin) {

            if (me[pluginName]) {

                plugin = Mini2.create('Mini2.ui.icon.Plugin', {

                    cfg: me[pluginName]

                });

                me.buffer[pluginName] = plugin;

            }


        }

        return plugin;


    }


});


/************************************************************************/
/*                                           */
/*    ui/icon/Plugin.js                                                    */
/*                                           */
/************************************************************************/


/// <reference path="../Mini.js" />


/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="FocusManager.js" />
/// <reference path="EventManager.js" />



//图标插件
Mini2.define("Mini2.ui.icon.Plugin", {


    cfg: null,

    buffer: null,

    initComponent: function () {

        var me = this;

        me.buffer = {};

        if (me.cfg) {
            me.setConfig(me.cfg);

            delete me.cfg;
        }
    },

    /**
     * 根据 关键字, 获取按钮配置信息
     */
    getItem: function (btnKey) {
        var me = this,
            buffer = me.buffer,
            item = buffer[btnKey];

        return item;
    },

    /**
     * 模糊查找
     */
    getItemForLink: function (btnKey) {
        var me = this,
            buffer = me.buffer,
            item = null;

        if (Mini2.isBlank(btnKey)) { return item; }

        for (var i in buffer) {

            if (btnKey.indexOf(i) >= 0) {
                item = buffer[i];
                break;
            }

        }


        return item;
    },

    getIcon: function (btnKey) {
        var me = this,
            item = me.getItem(btnKey);

        if (!item) {
            item = me.getItemForLink(btnKey);
        }

        if (item && !Mini2.isBlank(item.icon)) {
            return item.icon;
        }


        return null;
    },

    getIconCls: function (btnKey) {
        var me = this,
            item = me.getItem(btnKey);

        if (!item) {
            item = me.getItemForLink(btnKey);
        }


        if (item && !Mini2.isBlank(item.iconCls)) {
            return item.iconCls;
        }

        return null;
    },

    getCls: function (btnKey) {
        var me = this,
            item = me.getItem(btnKey);

        if (!item) {
            item = me.getItemForLink(btnKey);
        }

        if (item && !Mini2.isBlank(item.cls)) {
            return item.cls;
        }

        return null;
    },


    getItemConfig: function (btnKey) {
        var me = this,
            item = me.getItem(btnKey);

        if (!item) {
            item = me.getItemForLink(btnKey);
        }

        return item;
    },



    /**
     * 设置配置内容
     */
    setConfig: function (cfg) {

        var me = this,
            buffer = me.buffer;

        $(cfg).each(function () {
            var item = this;
            var keys = item.keys;

            var itemCfg = {};

            Mini2.apply(itemCfg, item);


            if (Mini2.isString(keys)) {
                keys = [keys];
            }

            for (var i = 0; i < keys.length; i++) {

                var key = keys[i];

                buffer[key] = itemCfg;
            }
        });

    }

}, function () {
    var me = this;

    Mini2.apply(me, arguments[0]);

    me.initComponent();

});


/************************************************************************/
/*                                           */
/*    ui/button/Button.js                                                  */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini2.js" />
/// <reference path="../../lang/String.js" />
/// <reference path="../../lang/Number.js" />
/// <reference path="../../lang/log.js" />
/// <reference path="../../lang/Json.js" />
/// <reference path="../../lang/Function.js" />
/// <reference path="../../lang/Date.js" />
/// <reference path="../../lang/Array.js" />


Mini2.define('Mini2.ui.button.Button', {

    extend: 'Mini2.ui.Component',

    alias: 'widget.button',


    btnInner: null,

    baseCls: Mini2.baseCSSPrefix + 'btn',

    scale: 'small',

    allowedScales: ['small', 'medium', 'large'],

    dock: 'none',

    text: '按钮',

    icon: false,

    el: null,

    userCls: false,


    /**
    * 选中的样式
    */
    checkedCls : false,

    radioCls: false,

    isButton: true,

    //beforeClick:true,

    hrefTarget: '_blank',

    /**
    * 分组名称
    */
    group: false,

    
    /**
    * 按钮类型: button=普通按钮, check=复选框按钮, radio=单选框类型
    */
    buttonType : 'button',
    
    //当做复选框使用的时候
    checked: false,




    renderTpl: [
        '<a class="mi-btn ',
            'mi-unselectable ',
            '" ',
            'role="button" hidefocus="on" unselectable="on" tabindex="0" >',
            '<span class="mi-btn-wrap" unselectable="on">',
                '<span class="mi-btn-button">',
                    '<span class="mi-btn-inner mi-btn-inner-center" unselectable="on">',
                    '</span>',
                '</span>',
            '</span>',
        '</a>'
    ],



    //初始化组件
    initComponent: function () {
        var me = this;


    },

    /**
    * 复选框模式
    */
    setChekced: function (value, trigger) {
        var me = this,
            el = me.el,
            item,
            group = me.group,
            btnType = me.buttonType,
            checkCls = me.checkCls;

        me.checked = value;
        
        if (checkCls) {
            el.toggleClass(checkCls, value);
        }

               
        if (false !== trigger && 'radio' == btnType) {

            var items = Mini2.GroupManager.get(group);

            for (var i = 0; i < items.length; i++) {
                if (items[i] === me) {
                    continue;
                }

                item = items[i];

                item.setChekced(false, false);
            }
        }

        
        return me;
    },


    setTop: function (v) {
        var me = this,
            el = me.el;
        el.css('top', v);
        return me;
    },

    setLeft: function (v) {
        var me = this,
            el = me.el;
        el.css('left', v);
        return me;
    },

    focus: function () {
        var me = this;

        Mini2.ui.FocusMgr.setControl(me);
    },

    getInputEl: function () {
        "use strict";
        var me = this,
            support = Mini2.support,
            scale = me.scale,
            margin = me.margin,
            href = me.href,
            hrefTarget = me.hrefTarget,
            baseCls = me.baseCls,
            command = me.command,
            pressedTag = '-pressed',
            overTag = '-over',
            el = Mini2.$join(me.renderTpl);

        if (support.ipad || support.iphone) {
            el.attr('readonly', true);
        }

        me.overCls = [
            'mi' + overTag,
            baseCls + overTag,
            baseCls + '-default-' + scale + overTag];

        me.pressedCls = [
            'mi' + pressedTag,
            baseCls + pressedTag,
            baseCls + '-default-' + scale + pressedTag];


        if (!Mini2.isBlank(command)) {
            el.attr('command', command);
        }


        el.css({
            width: me.width,
            height: me.height,
            left: me.left
        });

        if (me.minWidth) { el.css('min-width', me.minWidth);}
        if (me.minHeight) { el.css('min-height', me.minHeight);}

        if (me.maxWidth) { el.css('max-width', me.maxWidth); }
        if (me.maxHeight) { el.css('max-height', me.maxHeight); }




        el.addCls(baseCls + '-default-' + scale);

        if (margin) {
            if (Mini2.isString(margin)) {
                el.css('margin', margin);
            }
            else {
                for (var i in margin) {
                    el.css('margin-' + i, margin[i]);
                }
            }
        }

        me.btnInner = el.find('.mi-btn-inner:first');
        me.btnInner.html(me.text);

        if (me.icon && '' != me.icon) {
            el.addCls(
                'mi-icon-text-left',
                baseCls + '-icon-text-left',
                baseCls + '-default-' + scale + '-icon-text-left'
            );

            me.imgEl = $('<img src="" class="mi-btn-icon-el mi-btn-glyph"  />');
            me.imgEl.attr('src', me.icon);

            el.mFind('.' + baseCls + '-button').append(me.imgEl);
        }



        el.on('mouseenter', function () {
            $(this).addCls(me.overCls);
        })
        .on('mouseleave', function () {
            $(this).removeCls(me.overCls);
        });

        if (href) {

            el.attr('href', href);

            if (href) {
                el.attr('target', hrefTarget);
            }
        }
        else {
            el.muBind('mousedown', function (e) {

                $(this).addCls(me.pressedCls);



                Mini2.ui.FocusMgr.setControl(me);

            })
            .muBind('mouseup', function (e,srcEvt) {
                "use strict";

                $(this).removeCls(me.overCls);
                $(this).removeCls(me.pressedCls);
                
                if (0 == srcEvt.button) {
                    if (me.beforeClick) {

                        var result = me.beforeClick.call(me, e);

                        if (false ===  result) {
                            return;
                        }
                    }
                    else if (!Mini2.isBlank( me.beforeAskText)) {

                        return me.showAskMsg.call(me);

                    }


                    var btnType = me.buttonType;

                    if ('radio' == btnType) {
                        me.setChekced(true);
                    }
                    else if ('check' == btnType) {
                        me.setChekced(!me.checked);
                    }

                    me.callback_click.call(me);
                }



            });
        }


        return el;
    },

    //显示询问弹出窗口
    showAskMsg: function () {
        "use strict";
        var me = this;

        Mini2.Msg.confirm("询问", me.beforeAskText, function () {
            me.click();
        });

        return false;
    },

    //扩展添加 class 
    expandCls: function (cls) {
        "use strict";
        var me = this,
            el = me.el,
            i, ns;

        if (cls) {
            ns = cls.split(' ');

            for (i = 0; i < ns.length; i++) {
                el.addClass(ns[i]);
            }
        }
    },

    //提交到服务器
    serverForSubmit: function () {
        "use strict";
        var me = this,
            widget = me.widget || window.widget1;

        if (widget) {
            widget.submit(me.el, {
                command: me.command,
                commandParam: me.commandParams
            });
        }
    },

    setHref: function (href) {
        "use strict";
        var me = this,
            el = me.el;

        me.href = href;

        el.attr('href', href);
    },

    getHref: function () {
        var me = this,
            el = me.el;

        return me.href;
    },

    render: function () {
        "use strict";
        var me = this,
            el,
            cId = me.clientId;


        me.el = el = me.getInputEl();

        el.attr('id', cId)
            .data('me', me);


        me.expandCls(me.userCls);

        if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else {
            $(me.renderTo).append(el);
        }


        if (me.click) {
            me.userClick = me.click;

            delete me.click;
        }

        me.click = me.callback_click;


        if (me.group) {
            el.attr('data-group', me.group);

            Mini2.GroupManager.add(me.group, me);
        }


        try {
            Mini2.ui.SecManager.reg(me.secFunCode, me);
        }
        catch (ex) {
            console.error('注册权限错误', ex);
        }

        return me;
    },


    callback_click: function () {
        "use strict";
        var me = this;

        if (me.userClick) {
            me.userClick.call(me);
        }
        else if (me.command) {
            me.serverForSubmit.call(me);
        }
    }

});




/************************************************************************/
/*                                           */
/*    ui/container/DockingContainer.js                                     */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini.js" />


Mini2.define('Mini2.ui.container.DockingContainer', {


    isDockingContainer: true,

    //    items: {
    //        top: [],
    //        left: [],
    //        right: [],
    //        bottom: [],
    //        full:[],
    //        center: []
    //    },

    //    length: 0,

    owner: window,


    //初始化组件
    initComponent: function () {
        var me = this;

        me.clearItems();
    },

    configureItem: function (item) {


    },

    clearItems: function () {
        var me = this;

        me.length = 0;
        me.items = {
            top: [],
            left: [],
            right: [],
            bottom: [],
            center: [],
            full: []
        };
    },

    addDocked: function (items, pos) {
        var me = this,
            i = 0,
            ms = me.items,
            item,
            len = items.length;



        for (; i < len; i++) {
            item = items[i];

            if (Mini2.isDom(item)) {
                item.dock = $(item).attr('data-dock') || $(item).attr('dock');
            }
            else {
                item.dock = item.dock || 'top';
            }


            switch (item.dock) {
                case 'none': break;
                case 'top': ms.top.push(item); break;
                case 'bottom': ms.bottom.push(item); break;
                case 'left': ms.left.push(item); break;
                case 'right': ms.right.push(item); break;
                case 'full': ms.full.push(item); break;
                case 'center': ms.center.push(item); break; //注:这个居中属性放在整个引擎里面。有待商议或取消
                    //default: ms.contre.push(item); break;                                   
            }
        }


        me.length = len;
    },

    updateLayout: function (owner) {

        var me = this,
            ms = me.items,
            el = me.el,
            padding = me.padding,
            itemMargin = me.itemMargin,
            vScroll = false, //垂直滚动条

            h,
            w,
            h0 = 0,
            h1 = 0,
            h2 = 0,

            w0 = 0,
            w1 = 0,
            w2 = 0,
            wCenter = 0;


        if (!me.length) {
            return;
        }

        owner = owner || me.owner;


        itemMargin = Mini2.clone(itemMargin);

        if ('auto' == itemMargin.left) {
            itemMargin.left = 0;
        }
        else if (Mini2.isString(itemMargin.left)) {
            itemMargin.left = parseInt(itemMargin.left);
        }

        if ('auto' == itemMargin.right) {
            itemMargin.right = 0;
        }
        else if (Mini2.isString(itemMargin.right)) {
            itemMargin.right = parseInt(itemMargin.right);
        }

        if ('auto' == itemMargin.top) {
            itemMargin.top = 0;
        }
        else if (Mini2.isString(itemMargin.top)) {
            itemMargin.top = parseInt(itemMargin.top);
        }

        if ('auto' == itemMargin.buttom) {
            itemMargin.buttom = 0;
        }
        else if (Mini2.isString(itemMargin.buttom)) {
            itemMargin.buttom = parseInt(itemMargin.buttom);
        }


        me.itemMargin = itemMargin;


        h0 = me.getItemsHeight(ms.top);
        hC = me.getItemsHeight(ms.full);
        h2 = me.getItemsHeight(ms.bottom);



        w0 = me.getItemsWidth(ms.left);


        w2 = me.getItemsWidth(ms.right);


        if (owner && owner.muid) {
            w = owner.getWidth();
            h = owner.getHeight();
        }
        else {
            w = $(owner).width();
            h = $(owner).height();
        }


        h -= (padding.top + padding.bottom);
        w -= (padding.left + padding.right);

        h1 = h - h0 - h2;
        w1 = w - w0 - w2;



        if ('none' != owner.scroll && h0 + hC + h2 > h ) {
            w1 -= 20;
        }

        //设置[上、下] 的高度和宽度
        if (ms.top.length || ms.bottom.length) {
            me.setItemsTop2(padding.top, ms.top);
            me.setItemsTop2(padding.top + h0 + h1, ms.bottom);

            me.setItemsWidth(w1, ms.top);
            me.setItemsWidth(w1, ms.bottom);
        }



        //设置[左、右] 的 宽度,坐标
        if (ms.left.length || ms.right.length) {

            //me.setItemsTop(padding.top + h0, ms.left);
            //me.setItemsTop(padding.top + h0, ms.right);

            me.setItemsTop(h0, ms.left);
            me.setItemsTop(h0, ms.right);

            me.setItemsLeft2(0, ms.left);
            me.setItemsLeft2(w0 + w1 + itemMargin.right, ms.right);

            me.setItemsHeight(h1, ms.left);
            me.setItemsHeight(h1, ms.right);


        }


        if (ms.center.length) {
            wCenter = me.getItemsWidth(ms.center);

            me.setItemsLeft2(padding.left + (w - wCenter) / 2, ms.center);
        }


        //设置中心填充部分
        if (ms.full.length) {

            //me.setItemsLeft(padding.left + w0, ms.full);
            //me.setItemsTop(padding.top + h0, ms.full);

            me.setItemsLeft(w0, ms.full);
            me.setItemsTop(h0, ms.full);

            me.setItemsWidth(w1, ms.full);
            me.setItemsHeight(h1, ms.full);
        }


    },


    setItemCss: function (item, value, propName, cssName) {
        var me = this;

        if (item) {
            if (item[propName]) {
                item[propName](value);
            }
            else {
                $(item).css(cssName, value);
            }
        }
    },



    setItemsWidth: function (w, items) {
        var me = this,
            i,
            item,
            len = items.length;

        if (len) {
            for (i = 0; i < len; i++) {
                item = items[i];
                me.setItemCss(item, w, 'setWidth', 'width');
            }
        }
    },

    setItemsHeight: function (h, items) {
        var me = this,
            item,
            len = items.length;

        if (len) {

            $(items).each(function () {
                me.setItemCss(this, h, 'setHeight', 'height');
            });
        }
    },


    setItemsTop: function (y, items) {
        var me = this,
            item,
            v = y,
            len = items.length;

        if (len) {

            $(items).each(function () {
                me.setItemCss(this, v, 'setTop', 'top');
            });
        }
    },

    setItemsTop2: function (y, items) {
        var me = this,
            item,
            itemMargin = me.itemMargin,
            v = y,
            len = items.length;

        if (len) {

            $(items).each(function () {
                item = this;
                v += itemMargin.top;

                if (item.marginTop) {
                    try {
                        var top = parseInt(item.marginTop);

                        v += top;
                    }
                    catch (ex) {

                    }
                }

                me.setItemCss(item, v, 'setTop', 'top');

                v += itemMargin.bottom;


                if (item.getHeight) {
                    v += item.getHeight();
                }
                else {
                    v += $(item).outerHeight();
                }
            });
        }
    },

    setItemsLeft: function (x, items) {
        var me = this,
            item,
            itemMargin = me.itemMargin,
            v = x,
            len = items.length;

        if (len) {

            $(items).each(function () {
                me.setItemCss(this, v, 'setLeft', 'left');
            });
        }
    },

    setItemsLeft2: function (x, items) {

        var me = this,
            item,
            itemMargin = me.itemMargin,
            v = x,
            itemW,
            len = items.length;

        if (len) {

            $(items).each(function () {
                item = this;

                if ('auto' != itemMargin.left) {
                    v += itemMargin.left;
                }

                if (item.setLeft) {
                    item.setLeft(v);
                    itemW = item.getWidth();
                }
                else {
                    $(item).css("left", v);
                    itemW = $(item).outerWidth();
                }

                if (!Mini2.isNumber(itemW)) {
                    itemW = parseInt(itemW);
                }

                v += itemW;

                if ('auto' != itemMargin.right) {
                    v += itemMargin.right;
                }

            });
        }
    },

    getItemsWidth: function (items) {
        var me = this,
            item,
            itemMargin = me.itemMargin,
            v = 0,
            itemW;

        if (items.length) {

            $(items).each(function () {
                item = this;
                if (item.getWidth) {
                    itemW = item.getWidth();
                }
                else {
                    itemW = $(item).outerWidth();
                }

                if (!Mini2.isNumber(itemW)) {
                    itemW = parseInt(itemW);
                }

                v += (itemW + itemMargin.left + itemMargin.right);

            });
        }

        return v;
    },

    getItemsHeight: function (items) {
        var me = this,
            item,
            itemMargin = me.itemMargin,
            v = 0,
            len = items.length;

        if (len) {
            $(items).each(function () {
                item = this;
                if (item.getHeight) {
                    v += item.getHeight();
                }
                else {
                    v += $(item).outerHeight();
                }

                v += itemMargin.top + itemMargin.bottom;
            });
        }

        return v;
    }

}, function () {
    var me = this;

    Mini2.apply(this, arguments[0]);

    me.initComponent();

});


/************************************************************************/
/*                                           */
/*    ui/container/Viewport.js                                             */
/*                                           */
/************************************************************************/



/// <reference path="../../Mini.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />



Mini2.define("Mini2.ui.container.Viewport", {

    log: Mini2.Logger.getLogger('Mini2.ui.container.Viewport',false),

    alias: 'Mini2.ui.Viewport',

    layout: 'border',

    owner: window,

    /**
    * 容器模式
    */
    isContainer:false,

    /**
    * 各个方位之间的间距
    */
    space : 0,

    el: null,

    //    northItems: [], //北
    //    southItems: [], //南
    //    westItems: [],   //西
    //    eastItems: [], //东
    //    centerItems: [], //中间

    //    region: {
    //        north: [],
    //        south: [],
    //        west: [],
    //        east: [],
    //        center: []
    //    },
    
    //disable: true,

    //宽度补充
    widthOffset: 0,

    //高度补充
    heightOffset: 0,

    /**
     * 版面锚固定的项目
     */
    anchorfixedItems : null,

    margin: {
        top: 0
    },

    //初始化组件
    initComponent: function () {
        "use strict";
        var me = this;

        //me.disabled = false;

        me.length = 0;
        me.region = {
            north: [],
            south: [],
            west: [],
            east: [],
            center: []
        };

        me.isHide_north = false;
        me.isHide_south = false;
        me.isHide_west = false;
        me.isHide_east = false;
        
    },

    //设置为激活状态
    enable:function(){
        this.disabled = false;
    },

    //设置为无效状态
    disable:function(){
        this.disabled = true;
    },


    toggleRegion: function (region) {
        "use strict";
        var me = this,
            isVisibled = me.isVisibled(region);


        if (isVisibled) {
            me.hideRegion(region);
        }
        else {
            me.showRegion(region);
        }

        return me;
    },

    isVisibled: function (region) {
        "use strict";
        var me = this,
            tag,
            hide = false;

        tag = 'isHide_' + region;

        hide = me[tag];

        return !hide;
    },


    //显示版面
    showRegion: function (region) {
        "use strict";
        var me = this,
            el = me.el,
            ms = me.region,
            panel,
            items = ms[region];

        if (items && items.length) {

            if ('west' == region) {
                if (!me.isHide_west) { return; }

                me.isHide_west = false;

                panel = items[0];

                var panelWidth = panel.getWidth();

                var x0 = 0;
                var x1 = -panelWidth;

                panel.show().animate({ 'left': 0 }, 'fast', 'swing');

            }
            else if ('east' == region) {    //东
                if (!me.isHide_east) { return; }
                me.isHide_east = false;

                panel = items[0];

                var viewWidth = el.width();
                var panelWidth = panel.getWidth();

                var x0 = viewWidth - panelWidth;
                var x1 = viewWidth;

                panel.setLeft(x1).show().animate({ 'left': x0 }, 'fast', 'swing');

            }
            else if ('north' == region) {    //北

                if (!me.isHide_north) { return; }

                me.isHide_north = false;

                panel = items[0];

                var panelHeight = panel.getHeight();

                var y0 = 0;
                var y1 = -panelHeight;

                panel.setTop(y1).show().animate({ 'top': y0 }, 'fast', 'swing');


            }
            else if ('south' == region) {    //南
                if (!me.isHide_south) { return; }
                me.isHide_south = false;

                panel = items[0];

                var viewHeight = el.height();
                var panelHeight = panel.getHeight();

                var y0 = viewHeight - panelHeight;
                var x1 = viewHeight;

                panel.setTop(x1).show().animate({ 'top': x0 }, 'fast', 'swing');
            }

            me.resize(me.owner);
        }

    },

    //隐藏版面
    hideRegion: function (region) {
        "use strict";
        var me = this,
            el = me.el,
            ms = me.region,
            margin = me.margin,
            panel,
            items = ms[region];

        if (items && items.length) {

            if ('west' == region) { //西

                if (me.isHide_west) { return; }

                me.isHide_west = true;

                panel = items[0];

                var panelWidth = panel.getWidth();

                var x0 = 0;
                var x1 = -panelWidth;

                panel.animate({ 'left': x1 }, 'fast', 'swing', function () {
                    panel.hide();
                });

            }
            else if ('east' == region) {    //东

                if (me.isHide_east) { return; }

                me.isHide_east = true;

                panel = items[0];

                var viewWidth = el.width();
                var panelWidth = panel.getWidth();

                var x0 = viewWidth - panelWidth;
                var x1 = viewWidth;

                panel.animate({ 'left': x1 }, 'fast', 'swing', function () {
                    panel.hide();
                });

            }
            else if ('north' == region) {    //北

                if (me.isHide_north) { return; }

                me.isHide_north = true;

                panel = items[0];

                var panelHeight = panel.getHeight();

                var y0 = margin.top;
                var y1 = -panelHeight + margin.top;

                panel.animate({ 'top': y1, 'z-index': 800 }, 'fast', 'swing', function () {
                    panel.hide();
                });

            }
            else if ('south' == region) {    //南

            }

            me.resize(me.owner);
        }
    },


    winResize: function (e) {
        "use strict";
        var me = e.data['owner'],
            log = me.log;

        me.resize(me.owner);
        
    },





    resize: function (owner) {
        "use strict";
        var me = this,
            log = me.log,
            el = me.el,
            ms = me.region,
            h,
            heightAll ,
            w,
            space = me.space,
            margin = me.margin,

            mTop = margin.top || 0,
            mBtm = margin.buttom || 0,

            h0 = 0, //north 北方-的高度
            h1 = 0,
            h2 = 0, //south 南方-的高度

            w0 = 0,
            w1 = 0,
            w2 = 0;

        owner = owner || me.owner;

        //log.debug("viewport.resize(...)");
        
        h0 = me.isHide_north ? 0 : me.getItemsHeight(ms.north);
        h2 = me.isHide_south ? 0 : me.getItemsHeight(ms.south);


        w0 = me.isHide_west ? 0 : me.getItemsWidth(ms.west);
        w2 = me.isHide_east ? 0 : me.getItemsWidth(ms.east);


        if (owner && owner.muid) {
            w = owner.getWidth();
            h = owner.getHeight();
        }
        else {

            var ownerWidth = $(owner).width();

            if (me.isContainer) {

                if (ownerWidth >= 1200) {
                    w = 1170;
                }
                else if (ownerWidth >= 992) {
                    w = 970;
                }
                else if (ownerWidth >= 768) {
                    w = 750;
                }
                else {
                    w = ownerWidth;
                }
            }
            else {
                w = ownerWidth;
            }

            h = $(owner).height();
        }

        //if ('widget1_I_TopViewport' != me.clientId) {
            
        //    console.log("viewport.id = '%s'", me.clientId);

        //    console.log("scroll = " + me.scroll);

        //    console.log("win.Height = ", $(window).height());

        //    console.log("mTop = %d, mBtm = %d", mTop, mBtm);
        //}

        
        h -= (mTop + mBtm);

        h += me.heightOffset;   
        w += me.widthOffset;


        el.css({ width: w , height: $(window).height() - (mTop + mBtm) });


        //if ('widget1_I_TopViewport' != me.clientId) {

        //    console.log("h = %d", h);

        //    console.log("h0 = %d ,h2 = %d", h0, h2);
        //}

        h1 = h - h0 - h2;

        var minCentreH = me.getItemsHeight(ms.center, h1);

        if ( h1 < minCentreH) {

            heightAll = h0 + h1 + h2;

            if ('none' != me.scroll) {
                

            }

            //console.log("减去滚动条");

            w -= 18;    //减去滚动条
            el.css({
                'overflow-y': 'scroll'
            });
        }
        else {
            heightAll = h;

            el.css({
                'overflow-y': 'hidden'
            });
        }
        
        //if ('widget1_I_TopViewport' != me.clientId) {
        //    console.log("minCentreH = ", minCentreH);

        //    console.log("h1 = %d", h1);
        //}

        w1 = w - w0 - w2;

        //设置 [北, 南] 的高度和宽度
        if (ms.north.length || ms.south.length) {
            me.setItemsTop(0, ms.north);

            if (h1 < minCentreH) {
                me.setItemsTop(h0 + minCentreH, ms.south);
            }
            else {
                me.setItemsTop(h0 + h1, ms.south);
            }



            me.setItemsWidth(w, ms.north);
            me.setItemsWidth(w, ms.south);
        }


        //设置[东,西] 的 宽度,坐标
        if (ms.west.length || ms.east.length) {

            var hC0 = h0 + (ms.north.length ? space : 0);

            me.setItemsTop(hC0, ms.west);
            me.setItemsTop(hC0, ms.east);

            me.setItemsLeft(0, ms.west);
            me.setItemsLeft(w0 + w1, ms.east);

            var hC1 = h1 - (ms.north.length ? space - 1 : 0) - (ms.south.length ? space - 1 : 0);

            me.setItemsHeight(hC1, ms.west);
            me.setItemsHeight(hC1, ms.east);
        }

        var hPaddingH1 = 0;
        var hPaddingH2 = 0;

        //设置中心部分
        if (ms.center.length) {

            hPaddingH1 = (ms.north.length ? space : 0);
            hPaddingH2 = (ms.south.length ? space : 0);

            var wC0 = w0 + (ms.west.length ? space : 0);
            var wC1 = w1 - (ms.west.length ? space : 0) - (ms.east.length ? space : 0);

            var hC0 = h0 + hPaddingH1;
            var hC1 = h1 - (hPaddingH1 > 0 ? hPaddingH1 - 1 : 0) - (hPaddingH2 > 0 ? hPaddingH2 - 1 : 0);

            //if ('widget1_I_TopViewport' != me.clientId) {
            //    console.debug("hC0 = ", hC0);
            //    console.debug("hC1 = ", hC1);
            //}


            me.setItemsLeft(wC0, ms.center);
            me.setItemsTop(hC0, ms.center);


            me.setItemsWidth(wC1, ms.center);
            me.setItemsHeight(hC1, ms.center);
        }

        var allH = heightAll - (hPaddingH1 > 0 ? hPaddingH1 - 1 : 0) - (hPaddingH2 > 0 ? hPaddingH2 - 1 : 0);
        var allW = w;

        if (heightAll > h) {
            allW -= 20;
        }



        if ('none' == me.scroll) {

            me.innerEl.css({
                width: allW,
                height: h
            });
        }
        else {

            me.innerEl.css({
                width: allW,
                height: allH
            });
        }




        var items = me.anchorfixedItems;

        if (items) {

            $(items).each(function () {
                var item = this;
                item._tmpAnchor = null;
            });
            
            me.preAnchorFixedItem();
            
        }

        return me;
    },

    setItemsWidth: function (w, items) {
        "use strict";
        var me = this,
            item;

        $(items).each(function () {
            item = this;

            if ('relative' == item.position) {
                return;
            }

            if (item.isVisible && item.isVisible()) {
                item.setWidth(w);
            }
        });
    },

    setItemsHeight: function (h, items) {
        "use strict";
        var me = this,
            item;

        $(items).each(function () {
            item = this;

            if ('relative' == item.position) {
                return;
            }

            if (item.isVisible && item.isVisible()) {
                item.setHeight(h);
            }
        });
    },


    setItemsTop: function (y, items) {
        "use strict";
        var me = this,
            item,
            v = y;

        $(items).each(function () {
            item = this;

            if ('relative' == item.position ) {
                return;
            }
            if (item.isVisible && item.isVisible()) {
                item.setTop(v);


                var minHeight = item.minHeight || 0;
                var height = item.getHeight();

                if (height < minHeight) {
                    v += minHeight;
                }
                else {
                    v += height;
                }

            }
        });

        return me;
    },

    setItemsLeft: function (x, items) {
        "use strict";
        var me = this,
            item,
            v = x;

        $(items).each(function () {
            item = this;

            if ('relative' == item.position) {
                return;
            }


            if (item.isVisible && item.isVisible()) {
                item.setLeft(v);
                v += item.getWidth();
            }
        });

        return me;
    },

    getItemsWidth: function (items) {
        "use strict";
        var me = this,
            item,
            v = 0;

        $(items).each(function () {
            item = this;
            if ('relative' == item.position) {
                return;
            }

            if (item.isVisible && item.isVisible()) {
                v += item.getWidth();
            }
        });

        return v;
    },

    //curHeight : 
    getItemsHeight: function (items, curHeight) {
        "use strict";
        var me = this,
            item,
            v = 0;

        $(items).each(function () {
            item = this;
            if ('relative' == item.position) {
                return;
            }
            if (item.isVisible && item.isVisible()) {


                var minHeight = item.minHeight || 0;
                var height = item.getHeight();

                if (height < minHeight) {
                    v += minHeight;
                }
                else {
                    v += height;
                }
            }
        });



        return v;
    },


    getItem: function (ps) {
        "use strict";
        var me = this,
            panel;

        if (ps.muid) {
            return ps;
        }


        panel = Mini2.create('Mini2.ui.panel.Panel', ps);

        panel.render();

        return panel;
    },


    /**
     * 初始化固定锚的项目
     */
    initAnchorFixedItems: function () {
        var me = this,
            el = me.el,
            items = [],
            westItems = me.region['west'],
            eastItems = me.region['east'];   //西

        $(westItems, eastItems).each(function () {

            if ('topbottom' == this.anchorFixedType) {
                items.push(this);
            }
        });

        if (items.length) {

            me.anchorfixedItems = items;

            $(el).scroll(function () {

                me.preAnchorFixedItem();

            });
        }
    },


    scrollTop: function (value) {
        var me = this,
            el = me.el;

        el.scrollTop(value);

        return me;
    },

    preAnchorFixedItem: function () {
        var me = this,
            el = me.el,
            items = me.anchorfixedItems,
            sTop = $(el).scrollTop(),
            vpHeight = $(el).height();


        $(items).each(function () {

            var item = this,
                newH,
                newTop = -1,
                tmpAnchor = item._tmpAnchor;

            if (!tmpAnchor) {

                tmpAnchor = {
                    top: parseInt(item.getTop()),
                    height: parseInt(item.getHeight()),

                    tmpTop: 0,     //临时y
                    tmpHeight: 0    //临时高度
                };

                item._tmpAnchor = tmpAnchor;
            }


            if (sTop > tmpAnchor.top) {
                newTop = sTop - 1;
            }
            else {
                newTop = tmpAnchor.top;
            }

            if (newTop != tmpAnchor.tmpTop) {
                tmpAnchor.tmpTop = newTop;
                item.setTop(newTop);
            }

            if (sTop > 0) {

                newH = sTop + tmpAnchor.height;

                if (newH > vpHeight) {
                    newH = vpHeight ;
                }

                if (tmpAnchor.tmpHeight != newH) {
                    tmpAnchor.tmpHeight = newH;
                    item.setHeight(newH);
                }

            }



        });


    },


    baseRender: function () {
        "use strict";
        var me = this,
            el,
            innerEl,
            i = 0,
            margin = me.margin,
            item,
            len,
            items = me.items;

        me.el = el = $(me.contentEl);

        el.addClass('mi-viewport');
        me.innerEl = innerEl = $(el).children('.mi-viewport-inner');

        if (me.isContainer) {

            el.addClass('mi-viewport-container');

            el.css({
                'margin-left': 'auto',
                'margin-right': 'auto'
            });

        }
        else {
            

            if (margin) {
                el.css({
                    'position': 'absolute',
                    'top': margin.top
                });
            }
        }

        if ('none' == me.scroll ) {
            el.css('overflow', 'hidden');
            innerEl.css('overflow', 'hidden');
        }
        else {
            el.css('overflow-x', 'hidden');
            innerEl.css('overflow-x', 'hidden');

            setTimeout(function () {
                me.initAnchorFixedItems();  //初始化固定锚的版面

            }, 500);
            

        }

        if (items) {

            len = items.length;

            //1.分析结构
            for (i; i < len; i++) {

                item = items[i];

                if (!item || !item.contentEl) { continue; }

                if (!Mini2.isString(item.contentEl)) { continue; }


                var c = item.contentEl.substr(0, 1);

                if (c == '#') {
                    var panel = Mini2.create('Mini2.ui.panel.Panel', item);

                    panel.render();



                    items[i] = panel;
                }
            }
        }

    },

    afterRender: function () {
        "use strict";
        var me = this,
            i = 0,
            item,
            region,
            obj,
            ms = me.region,
            items = me.items,
            rItem;


        if (items) {

            //1.分析结构
            for (i; i < items.length; i++) {

                item = items[i];

                if (item.isAfterRender) {
                    item = window[item.id];
                }

                region = item.region || 'north';
                obj = me.getItem(item);


                obj.el.addClass('mi-box-item');
                //if ( 'relative' != obj.position ) {
                //    obj.el.addClass('mi-box-item');
                //}

                rItem = ms[region];

                if (rItem) {
                    rItem.push(obj);
                }
                else {
                    ms['center'].push(obj);
                }
            };

            delete me.items;
        }

        return me;
    },

    setZIndex: function (items, zIndex) {
        "use strict";
        var me = this,
            i,
            n;

        if (items) {

            n = items.length;

            while (n--) {
                items[n].css('z-index', zIndex);
            }
        }

        return me;
    },

    //        north: [],
    //        south: [],
    //        west: [],
    //        east: [],
    //        center: []

    //重新设置各个版面的z坐标
    resetZIndex: function () {
        "use strict";
        var me = this,
            region = me.region,
            items,
            setZIndex = me.setZIndex;

        setZIndex(region['center'], 50);

        setZIndex(region['north'], 40);
        setZIndex(region['south'], 30);
        setZIndex(region['west'], 20);
        setZIndex(region['east'], 10);

    },

    render: function () {
        "use strict";
        var me = this;

        me.baseRender();

        me.resetZIndex();

        Mini2.LoaderManager.afterRender(me);

        Mini2.LoaderManager.resize(me);



        //        setTimeout(function () {
        //            me.resize(me.owner);
        //        }, 100);

        //        $(window).bind('resize', { 'owner': me }, me.winResize);
    }

}, function () {
    var me = this;

    Mini2.apply(this, arguments[0]);

    me.initComponent();

});


/************************************************************************/
/*                                           */
/*    ui/form/Base.js                                                      */
/*                                           */
/************************************************************************/



Mini2.define('Mini2.ui.form.Base', {

    

});


/************************************************************************/
/*                                           */
/*    ui/form/field/Base.js                                                */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />
/// <reference path="../../EventManager.js" />
/// <reference path="../../FocusManager.js" />


Mini2.define('Mini2.ui.form.field.Base', {

    extend: 'Mini2.ui.Component',

    log: Mini2.Logger.getLogger('Mini2.ui.form.field.Base'),

    mixins: {
        labelable: 'Mini2.ui.form.Labelable'
    },

    secFunCode: null,

    secReadonly:null,
    

    //清除按钮
    clearText: false,

    /**
    * 用户自定义样式. 
    * 例如:
    */
    style: null,

    //输入容器对象
    isInput:true,

    //有错误的红色边框样式
    invalidCls: 'mi-form-invalid',

    //扩展字段
    extraFieldBodyCls : false,
    
    //获取或设置一个值，该值指示用户能否使用 Tab 键将焦点放到该控件上。
    tabStop : true,


    labelable: null,

    //    forceValidation: true,    //强制验证

    preventMark: false,  //阻止显示错误信息

    disabled: false,

    //    boxLable:false,

    renderTo: Mini2.getBody(),

    el: null,
    //    inputEl: null,

    name: '',

    oldValue: '',
    newValue: '',

    /**
    * 自动去掉左右空格
    */
    autoTrim : true,

    //自动提示。
    autoComplete: 'off',

    //允许空白
    allowBlank: true,

    readOnly: false,

    //left,right
    align: 'left',

    width: "100%",
    height: '',

    inputDom: null, //输入框的html元素

    //placeholder: '',

    autoWidth: true,

    //弄脏，做标记用
    dirty: false,

    //private  焦点的时间,（特殊处理)
    //_focusTimeout: null,

    //初始化组件
    initComponent: function () {
        "use strict";
        var me = this;

        $(me).muBind('focusout', function () {

            
            if (me._focusTimeout) {
                clearTimeout(me._focusTimeout);
                delete me._focusTimeout;
            }

            if (me.fieldEl) {
                me.fieldEl.removeClass("mi-form-focus").trigger('blur'); //让文本框失去焦点
            }


            me.el.removeClass("mi-form-trigger-wrap-focus");

            me.on('hided');

            me.clearInvalid();
            //me.isValid();

            if (me.clearBtnEl) {
                me.clearBtnEl.hide();
            }

            if (me.autoTrim) {
                var srcValue = me.getValue();

                if (srcValue) {
                    var curValue = Mini2.String.trim(srcValue);

                    if (curValue != srcValue) {
                        me.setValue(curValue);
                    }
                }
            }


        });

        me.initLabelable();



    },


    //弄脏
    setDirty:function(value){
        var me = this,
            el = me.el,
            fieldEl = me.fieldEl;

        value = !!value;
        

        me.dirty = value;
        el.toggleClass('mi-form-dirty-item', value);

        return me;
    },

    getDirty :function(){
        var me = this;

        return me.dirty;
    },


    getRawValue: function () {
        "use strict";
        var me = this,
            value;

        if (me.readOnly && me.hideEl) {
            value = me.hideEl.val();
        }
        else {
            value = me.inputEl.val();
        }
        return value;

    },

    processRawValue: function (rawValue) {

        return rawValue;
    },

    isValid: function () {
        "use strict";
        var me = this,
            disabled = me.disabled,
            validate = me.forceValidation || !disabled;


        return validate ? me.validateValue(me.processRawValue(me.getRawValue())) : disabled;
    },


    //获取错误信息
    getErrors: function (value) {
        "use strict";
        var me = this;

        if (value == '' || value == null) {

            return '必填';
        }

        return '';
    },

    //验证值
    validateValue: function (value) {
        "use strict";
        var me = this,
            log = me.log,
            errors = me.getErrors(value),
            isValid = Mini2.isEmpty(errors);

        //log.debug('Errors = ' + errors);

        if (!me.preventMark) {
            if (isValid) {
                me.clearInvalid();
            }
            else {
                me.markInvalid(errors);
            }
        }

        return isValid;
    },


    getActiveError: function () {
        "use strict";
        var me = this,
            labelable = me.labelable;

        return labelable.getActiveError();
    },

    //判断有没有显示错误标记
    hasActiveError: function () {
        "use strict";
        var me = this,
            labelable = me.labelable;

        return labelable.hasActiveError();
    },

    //卸载删除错误标记
    unsetActiveError: function () {
        var me = this,
            labelable = me.labelable;

        labelable.unsetActiveError();
    },

    //清理异常提示
    clearInvalid: function () {
        "use strict";
        var me = this,
            el = me.el,
            hadError = me.hasActiveError(),
            inputEl = me.inputEl,
            fieldEl = me.fieldEl,
            invalidCls = me.invalidCls;


        el.removeClass(invalidCls);

        if (fieldEl) {
            fieldEl.removeClass(invalidCls + '-field');
        }
        else if (inputEl && inputEl.removeClass) {
            inputEl.removeClass(invalidCls + '-field');
        }

        me.unsetActiveError();
        if (hadError) {
            me.setError('');
        }
    },


    //创建异常提示
    markInvalid: function (errors) {
        "use strict";
        var me = this,
            el = me.el,
            oldMsg = me.getActiveError(),
            inputEl = me.inputEl,
            fieldEl = me.fieldEl,
            invalidCls = me.invalidCls;

        el.addClass(invalidCls);

        if (fieldEl) {
            fieldEl.addClass(invalidCls + '-field');
        }
        else {
            inputEl.addClass(invalidCls + '-field');
        }

        if (oldMsg !== errors) {
            me.setError(errors);
        }

        return me;
    },

    //设置错误提示消息
    setError: function (active) {
        "use strict";
        var me = this,
            msgTarget = me.msgTarget,
            prop,
            labelable = me.labelable;

        if (active == undefined || active == '' || active == null) {
            me.unsetActiveError();
        }
        else {
            if (labelable) {
                labelable.setActiveError(active);
            }
        }
    },

    insertText: function (obj, str) {
        "use strict";
        if (document.selection) {
            var sel = document.selection.createRange();
            sel.text = str;
        }
        else if (typeof obj.selectionStart === 'number' && typeof obj.selectionEnd === 'number') {
            var startPos = obj.selectionStart,
                endPos = obj.selectionEnd,
                cursorPos = startPos,
                tmpStr = obj.value;

            obj.value = tmpStr.substring(0, startPos) + str + tmpStr.substring(endPos, tmpStr.length);
            cursorPos += str.length;
            obj.selectionStart = obj.selectionEnd = cursorPos;
        }
        else {
            obj.value += str;
        }
    },

    moveEnd: function (obj) {
        "use strict";
        obj.focus();
        var len = obj.value.length;
        if (document.selection) {
            var sel = obj.createTextRange();
            sel.moveStart('character', len);
            sel.collapse();
            sel.select();
        }
        else if (typeof obj.selectionStart == 'number' && typeof obj.selectionEnd == 'number') {
            obj.selectionStart = obj.selectionEnd = len;
        }
    },


    layoutReset: function () {

    },


    onPositionChanged: Mini2.emptyFn,


    isValueChanged: function () {
        var me = this,
            log = me.log;

        log.debug('---- oldValue = ' + me.oldValue);
        log.debug('---- me.getValue = ' + me.getValue());

        return me.oldValue != me.getValue();
    },

    getLeft: function () {
        var me = this;

        return me.el.css('left');
    },

    setLeft: function (value) {
        var me = this,
            el = me.el;
        el.css('left', value);

        return me;
    },

    getTop: function () {
        var me = this,
            el = me.el;

        return el.css('top');
    },

    setTop: function (value) {
        var me = this,
            el = me.el;

        el.css('top', value);

        return me;
    },

    setWidth: function (value) {
        var me = this,
            el = me.el;

        me.width = value;
        el.css('width', value);

        return me;
    },

    getWidth: function () {
        return this.width;
    },

    setHeight: function (value) {
        var me = this;
        me.height = value;
        me.el.css('height', value);
        return me;
    },

    getHeight: function () {
        return this.height;
    },


    setValue: function (value) {
        var me = this,
            log = me.log,
            hideEl = me.hideEl;

        me.inputEl.val(value);

        if (hideEl) {
            hideEl.val(value);
        }
        
        return me;
    },

    getValue: function () {
        var me = this,
            hideEl = me.hideEl,
            value;

        if (me.readOnly || 'none' == me.mode) {
            value = hideEl.val();
        }
        else {
            value = me.inputEl.val();
        }



        return value;
    },


    hide: function () {
        var me = this;

        me.visible = false;

        me.el.hide();

        me.callParent();

        return me;
    },





    focus: function () {
        "use strict";
        var me = this,
            log = me.log,
            el = me.el,
            fieldEl = me.fieldEl,
            inputEl = me.inputEl;
       
        Mini2.ui.FocusMgr.setControl(me, null, me.scope);

        if (!el.hasClass('mi-form-trigger-wrap-focus')) {

            if (fieldEl) {
                fieldEl.addCls("mi-form-focus", me.focusCls);
            }

            el.addClass("mi-form-trigger-wrap-focus");            
        }

        //特殊处理，延时获取焦点。不然无法及时得到焦点。
        if (!me.readOnly && inputEl && inputEl.focus && !me._focusTimeout) {
            
            me._focusTimeout = setTimeout(function () {

                if (el.hasClass('mi-form-trigger-wrap-focus')) {
                    inputEl.focus();
                }

                me._focusTimeout = null;

            }, 200);
        }


        if (me.clearBtnEl) {
            me.clearBtnEl.css('display', 'inline');
        }


        return me;
    },

    select: function () {

        var me = this;

        me.inputEl.select();

        return me;
    },

    onLostFocus: function (e) {
        var me = this;

        me.inputEl.removeClass('mi-form-focus');

        me.on('hided');
    },

    show: function () {

        var me = this;

        me.visible = true;

        me.el.show();

        me.callParent();

        return me;
    },

    fieldCls: 'mi-form-type-text',


    //获取带标签的表格元素
    getTableContainer: function () {
        "use strict";
        /// <summary>获取容器</summary>

        var me = this,
            mixins = me.mixins,
            labelable = mixins.labelable,
            tableEl;

        if (me.labelable) {
            tableEl = me.labelable.labelableRenderTpl;
        }
        else {
            tableEl = Mini2.$join([
            '<table class="mi-field mi-table-plain mi-form-item  mi-field-default " ',
                'cellpadding="0" cellspacing="0" style="table-layout: fixed; width: 100%; ">',
                '<tbody>',
                    '<tr role="presentation" class="mi-form-item-input-row">',
                        '<td class="mi-form-item-body"></td>',
                    '</tr>',
                '</tbody>',
            '</table>']);
        }


        //如果是设计模式, 就在外面套一层 div
        //if (Mini2.designMode()) {
        //    tableEl = tableEl.wrap('<div></div>');
        //}


        tableEl.addClass(me.fieldCls);
        tableEl.css('width', me.width);

        if (me.left) {
            tableEl.css('left', me.left);
        }

        if (me.top) {
            tableEl.css('top', me.top);
        }

        if ('static' != me.position) {
            tableEl.css('position', me.position);
        }

        return tableEl;
    },



    bindInputEl_Key: function (inputEl) {
        "use strict";
        var me = this;

        $(inputEl)
        .on('keydown', function (e) {


            me.on('keydown', e);
        })
        .on('keyup', function (e) { me.on('keyup', e); })
        .on('keypress', function (e) {

            me.on('keypress', e);
        });

        //        $(inputEl).change(function (e) {
        //            me.isValid();

        //            log.debug(" me========");
        //        });
    },

    bindInputEl_Mouse: function (inputEl) {
        "use strict";
        var me = this;


        $(inputEl).muBind('mousedown', function (e) {
            me.focus();
            me.on('mousedown', e);
            //Mini2.EventManager.preventDefault(e); 
        }).muBind('mouseup', function (e) {

            me.on('mouseup', e);
            Mini2.EventManager.stopEvent(e);
        });
    },


    getCell: function (tableEl, rowIndex, colIndex) {
        "use strict";
        var tbodyEl, rowEl, tdEl;

        tbodyEl = $(tableEl).children("tbody:first");

        if (tbodyEl.length == 0) {
            tbodyEl = tableEl;
        }

        rowEl = $(tbodyEl).children("tr:eq(" + rowIndex + ")");

        tdEl = $(rowEl).children(":eq(" + colIndex + ")");

        return tdEl;

    },


    /**
    * 附加到单元格中
    */
    appendCell: function (tableEl, targetEl, rowIndex, colIndex) {
        "use strict";
        var me = this,
            cellEl,
            args = arguments;

        if (targetEl) {

            if (args.length == 4) {
                cellEl = me.getCell(tableEl, rowIndex, colIndex);
            }
            else if (Mini2.isString(args[2])) {
                cellEl = tableEl.find(args[2]);


                if (cellEl.length == 0) {
                    console.error('没有找到对应的节点, 无法附加元素');
                }
            }
            else {
                console.error("错误....");
            }

            $(cellEl).append(targetEl);

        }
        else {
            console.error("targetEl 不能为空, 无法附加到框架上.", targetEl);
        }

        return me;
    },

    //初始化标签容器
    initLabelable: function () {
        "use strict";
        var me = this,
            mixins = me.mixins,
            labelable = mixins.labelable,
            labCfg = me.labelable || {},
            lab;


        if (labCfg && labCfg.hideLable) {
            return;
        }

        labCfg = Mini2.apply(labCfg, {
            owner: me,
            required: me.required
        });

        lab = Mini2.create(labelable, labCfg);

        delete me.labelable;

        me.labelable = lab;

        try {

            var sec = Mini2.ui.SecManager;

            sec.reg(me.secFunCode, me, 'visible');
            sec.reg(me.secReadonly, me, 'readonly');
        }
        catch (ex) {
            console.error('注册权限错误', ex);
        }

    },


    //隐藏标记
    hideEl: null,


    //创建隐藏标记
    createHideEl: function () {
        "use strict";
        var me = this,
            name = me.name,
            hideEl = $('<input type="hidden" value="" />');

        if (name) {
            hideEl.attr('name', name);
        }


        hideEl.val(me.value || me.srcValue);

        return hideEl;
    },



    //设置只读状态。bool 值
    setReadOnly: function (value) {
        "use strict";
        var me = this,
            el = me.el,
            inputEl = me.inputEl,
            hideEl = me.hideEl,
            readonly = 'readonly',
            readonlyCls = 'mi-form-item-readonly';

        value = !!value;
        me.readOnly = value;

        el && el.toggleClass(readonlyCls, value);
        

        if (!inputEl) {
            return;
        }

        if (value) {

            inputEl.attr(readonly, readonly);
        }
        else {
            inputEl.removeAttr(readonly);
        }


        if (value) {
            if (!hideEl) {
                inputEl.attr('name', '');
                me.hideEl = hideEl = me.createHideEl();

                var bodyCls = 'td.mi-form-item-body:first';
                var tableEl = me.getTableContainer();

                me.appendCell(tableEl, hideEl, bodyCls);
            }
            
        }
        else {
            if (hideEl) {
                inputEl.attr('name', me.name);

                $(hideEl).remove();

                delete me.hideEl;
            }

        }

        $(inputEl).change(function () {
            me.clearInvalid();
        });

        $(inputEl).keydown(function () {
            me.clearInvalid();
        });

        return me;
    },

    getReadOnly: function () {
        var me = this;
        return me.readOnly;
    },


    /**
     * 映射值
     */
    setMap: function (record, userMapItems) {
        "use strict";
        var me = this,
            mapItems = userMapItems || me.mapItems,
            ownerParent = me.ownerParent,
            store,
            curRect;

        //没有映射就取消
        if (!mapItems) {
            return;
        }

        if (me.record) {
            curRect = me.record;
        }
        else {

            if (!ownerParent) {
                return;
            }

            store = ownerParent.store;

            if (!store) {
                return;
            }

            curRect = store.getCurrent();
        }


        for (var i = 0; i < mapItems.length; i++) {
            var mapItem = mapItems[i];

            if (mapItem && mapItem.srcField && mapItem.targetField) {

                var value;

                if (record.get) {
                    value = record.get(mapItem.srcField);
                }
                else {
                    value = record[mapItem.srcField];
                }

                curRect.set(mapItem.targetField, value);
            }
            else {
                console.warn("映射规则定义错误:", mapItem);
            }
        }


    },


    /**
    * 获取要发送的数据
    */
    getSentDataForTypeahead: function () {
        "use strict";
        var me = this,
            sentData = {},
            ps = me.typeaheadParams;

        $(ps).each(function () {

            var p = this;

            if ('query_string' == p.role) {
                var qValue = $.query.get(p.queryStringField);

                sentData[p.name] = qValue;
            }
            else if ('control' == p.role) {

                var con = Mini2.find(p.control);

                var value = con.getValue();

                sentData[p.name] = value;

            }
            else {

                var paramDef = p['default'];

                if (paramDef.indexOf('{{') >= 0 && paramDef.indexOf('}}')) {

                    var artTemp = template.compile(paramDef);
                    var valueStr = artTemp({
                        T: { '未定义': '' }
                    });

                    sentData[p.name] = valueStr;
                }
                else {
                    sentData[p.name] = paramDef;
                }

            }

        });

        return sentData;
    },


    /**
    * 初始化输入提示
    */
    initTypeahead: function (inputEl) {
        "use strict";
        var me = this,
            type = me.type || 'text',
            th = me.typeahead;



        if (th && 'text' == type) {

            $(inputEl).addClass('mi-typeahead');

            $(inputEl).typeahead({
                //fitToElement: true,
                autoSelect: th.autoSelect || false,
                appendTo: Mini2.getBody(),
                delay: 200,

                items: th.items,

                source: function (query, process) {
                    //'/api/InfoGrid2/View/Sample/Examples/WebAPI/Doc001Form?action=query_search'
                    var ps = me.getSentDataForTypeahead();

                    ps[th.searchKey || 'name'] = query;

                    
                    return Mini2.post(th.remoteUrl, ps,
                        function (data) {
                            return process(data);
                        }
                    );
                },
                //matcher: function (item) {
                //    return true;
                //},
                //updater: function (item) {

                //    console.debug('选中: ' + item);

                //    return item ;//这里一定要return，否则选中不显示，外加调用display的时候null reference错误。
                //},
                displayText: function (item) {

                    return item[th.field] || '未指定字段';
                },
                afterSelect: function (item) {
                    //选择项之后的时间，item是当前选中的项
                    //console.debug("---- 选择项之后的 ", item);

                    me.curRecord = item;

                    try {

                        me.setMap(item, me.typeaheadMapItems);
                    }
                    catch (ex) {
                        console.error('设置映射值错误', ex);
                    }


                },
                highlighter: function (text, item) {

                    if (th.displayFormat) {
                        var artTemp = me.artTemplate;

                        if (!artTemp) {
                            me.artTemplate = artTemp = template.compile(th.displayFormat);
                        }

                        var valueStr = artTemp({
                            T: item
                        });

                        return valueStr;
                    }
                    else {
                        return text;
                    }
                }
            });
        }
    },


    getFieldEl: function () {
        "use strict";
        var me = this,
            type = me.type || 'text',
            inputEl = Mini2.$joinStr([
            '<input type="',type,'" class="mi-form-field mi-form-text" ',
                'aria-invalid="false"  style="width: 100%; " autocomplete="off" spellcheck="false"  >']);


        if (me.name) {
            inputEl.attr('name', me.name);
        }

        inputEl.attr("id", me.clientId)
            .attr('placeholder', me.placeholder)
            .css('text-align', me.align);


        me.initTypeahead(inputEl);


        //        if (me.readOnly) {
        //            inputEl.attr('readonly', 'readonly');
        //        }

        //附加属性
        //me.inputEl.attr("data-errorqtip", "");
        //

        //inputEl.addClass("mi-form-required-field");



        me.bindInputEl_Mouse(inputEl);
        me.bindInputEl_Key(inputEl);


        me.inputEl = inputEl;

        return inputEl;

    },

    renderForLableable: function (tableEl) {
        "use strict";
        var me = this,
            labelEl,
            labelable = me.labelable;


        if (labelable ) {

            //处理显示的标签
            if (!labelable.hideLabel) {
                labelEl = labelable.getEl();

                if (me.clientId) {
                    labelEl.attr("for", me.clientId);
                }

                me.appendCell(tableEl, labelEl, 'td.mi-field-label-cell:first');

                if (!Mini2.designMode()) {
                    labelEl.muBind('mousedown', function (e) {
                        me.focus();
                    });
                    labelEl.muBind('mouseup', function (e) {
                        Mini2.EventManager.stopEvent(e);
                    });
                }
            }

            //处理显示的帮助信息
            if (!labelable.hideHelper) {



            }

        }

        return me;
    },

    renderForBoxLabel: function (tableEl) {
        "use strict";
        var me = this,
            boxLabelEl;

        if (me.boxLabel) {
            boxLabelEl = Mini2.$joinStr([
                '<label class="mi-form-cb-label mi-form-cb-label-after" for="', me.clientId, '">',
                    me.boxLabel,
                '</label>'
            ]);

            boxLabelEl.muBind('mousedown', function (e) {
                me.focus();
            });
            boxLabelEl.muBind('mouseup', function (e) {
                Mini2.EventManager.stopEvent(e);
            });

            me.boxLableEl = boxLabelEl;

            me.appendCell(tableEl, boxLabelEl, 'td.mi-form-item-body:first');
        }

        return me;
    },


    baseRenderSize:function(tableEl){
        'use strict';
        var me = this,
            i, cssName,
            cssAttrs = null,
            attrs = {
                'width': 'width',
                'height': 'height',
                'minHeight': 'min-height',
                'minWidth': 'min-width',
                'maxHeight': 'max-height',
                'maxWidth' : 'max-width'
            };


        for (i in attrs) {
            if (me[i]) {
                cssName = attrs[i];

                cssAttrs = cssAttrs || {};
                cssAttrs[cssName] = me[i];
            }
        }

        if (cssAttrs) {
            tableEl.css(cssAttrs);
        }
    },


    ////获取 body 扩展对象
    //getBodyExpand:function(){
    //    return null;
    //},

    baseRender: function () {
        "use strict";
        var me = this,
            log = me.log,
            tableEl, fieldEl,
            bodyExpandEl,
            bodyCls = 'td.mi-form-item-body:first';

        //容器
        tableEl = me.getTableContainer();

        //存放于 body 里面的对象
        fieldEl = me.getFieldEl();

        //容器尺寸
        me.baseRenderSize(tableEl);

        if (me.applyTo) {

            if (me.parentEl && Mini2.isString(me.applyTo)) {
                var srcEl = $(me.parentEl).find(me.applyTo);
                srcEl.replaceWith(tableEl);
            }
            else {
                $(me.applyTo).replaceWith(tableEl);
            }

        }
        else {
            $(me.renderTo).append(tableEl);
        }

        //容器中 body DOM 节点
        me.fieldBodyEl = tableEl.find(bodyCls);


        //显示表单的标签
        me.renderForLableable(tableEl);

        if (me.srcInputEl) {
            me.appendCell(tableEl, me.srcInputEl, bodyCls);
        }

        me.appendCell(tableEl, fieldEl, bodyCls);

        //扩展 dom属性
        if (me.getBodyExpand) {
            bodyExpandEl = me.getBodyExpand();

            if (bodyExpandEl) {
                me.appendCell(tableEl, bodyExpandEl, bodyCls);
            }
        }

        me.renderForBoxLabel(tableEl);


        me.fieldEl = fieldEl;



        if (me.clearText) {
            
            var clearBtnEl;

            me.clearBtnEl = clearBtnEl = $('<a class="mi-form-text-clear" style="display:none;"></a>');

            $(fieldEl).after(clearBtnEl)

            $(clearBtnEl).click(function () {
                fieldEl.val('');                
            });            
        }

        me.el = tableEl;

        if (me.readOnly) {
            me.setReadOnly(me.readOnly);
        }


        me.fieldBodyEl.addClass(me.extraFieldBodyCls);

        if (me.dirty) {
            me.setDirty(me.dirty);
        }


        if (me.dataSource ) {

            //log.debug("查找数据源:" + me.dataSource);
            var dataSource = Mini2.data.StoreManager.lookup(me.dataSource);

            me.dataSource = dataSource;

            //console.log("数据对象", dataSource);

            me.bindDataSource(dataSource);

        }

        me.initValue();

        if (undefined != me.value) {
            me.oldValue = me.value;
            me.setValue(me.value);
            delete me.value;
        }

        //用户自定义样式
        if (me.style) {

            var srcStyle = tableEl.attr('style');

            srcStyle += me.style;

            tableEl.attr('style', srcStyle);

        }

        return me;
    },


    /**
     * 设置集合
     */
    setRecord:function(record){
        var me = this,
            value ,
            field = me.dataField;

        if (!Mini2.isBlank(field)) {
            
            if (record.isModel) {
                value = record.get(field);
            }
            else {
                value = record[field];
            }
            
            me.oldValue = value;
            me.setValue(value);
        }

        me.record = record;

        return me;
    },
    

    bindDataSource: function (dataSource) {
        "use strict";
        var me = this,
            log = me.log;
        
        log.debug("bindDataSource 绑定数据源");

        $(dataSource)
            .muBind('update', me, me.dataSource_update)              //监听记录更新事件
            //.muBind('add', me, me.store_add)                    //监听记录添加事件
            //.muBind('datachanged', me, me.store_dataChanged)    //监听数据更改
            //.muBind('refresh', me, me.store_refresh)            //监听刷新事件
            .muBind('load', me, me.dataSource_load)                  //加载事件
            //.muBind('bulkremove', me, me.store_bulkRemove)      //左上角标记移除事件
            //.muBind('invalid', me, me.store_invalid)            //出现异常的单元格
            //.muBind('clear', me, me.store_clear)                //删除全部记录事件
            .muBind('currentchanged', me, me.dataSource_currentChanged);  //焦点行发生改变的事件

    },


    dataSource_update: function (event, record, operation, modifiedFieldNames) {
        "use strict";
        var me = event.data,
            i, j,
            modifiedField,
            items,
            len,
            isUpdateStyleField = false;


        if ('COMMIT' == operation) {

            var value = record.get(me.dataField);

            me.setValue(value);
        }
        else if ('EDIT' == operation) {

            var value = record.get(me.dataField);

            me.setValue(value);
        }
        else {
            console.error('operation=', operation);
        }

        return isUpdateStyleField;
    },

    dataSource_load: function (event, store) {
        "use strict";
        var me = event.data,
            log = me.log,
            i,
            record,
            records = store.data,
            len;


        log.debug('store_load(...)');

    },


    dataSource_currentChanged: function (event, index, record) {
        "use strict";
        var me = event.data,
            log = me.log;

        log.debug("数据仓库数据发生变化 store_currentChanged(...)");

        if (index > -1) {

            if (!record) {
                return;
            }

            //log.debug('item.dataField', item.dataField);

            var rectValue = record.get(me.dataField);

            //log.debug('value=' + rectValue);

            if (me.setOldValue) {
                me.setOldValue(rectValue);
            }
            else {
                me.oldValue = rectValue;
            }

            me.setValue(rectValue);

            

        }


    },




    initValue: Mini2.emptyFn,

    //显示延迟
    delayRender: function () {
        "use strict";
        var me = this,
            el = $(me.applyTo);

        me.isDelayRender = true;

        Mini2.delayRS = Mini2.delayRS || {};

        Mini2.delayRS[me.clientId] = me;

        el.attr('mi-delay-render', 'true');
        el.data('me', me);

        return me;
    },



    render: function () {
        "use strict";
        var me = this,
            el;

        me.baseRender();

        el = me.el;

        el.attr('data-muid', me.muid);
        el.data('me', me);

        if (!me.visible) {
            el.hide();
        }

        return me;
    }

});


/************************************************************************/
/*                                           */
/*    ui/form/Labelable.js                                                 */
/*                                           */
/************************************************************************/

/// <reference path="../../Mini.js" />



Mini2.define('Mini2.ui.form.Labelable', {

    childEls: [
    /**
    * @property {Ext.Element} labelCell
    * The `<TD>` Element which contains the label Element for this component. Only available after the component has been rendered.
    */
        'labelCell',

    /**
    * @property {Ext.Element} labelEl
    * The label Element for this component. Only available after the component has been rendered.
    */
        'labelEl',

    /**
    * @property {Ext.Element} bodyEl
    * The div Element wrapping the component's contents. Only available after the component has been rendered.
    */
        'bodyEl',

    // private - the TD which contains the msgTarget: 'side' error icon
        'sideErrorCell',

    /**
    * @property {Ext.Element} errorEl
    * The div Element that will contain the component's error message(s). Note that depending on the configured
    * {@link #msgTarget}, this element may be hidden in favor of some other form of presentation, but will always
    * be present in the DOM for use by assistive technologies.
    */
        'errorEl',

        'inputRow',

        /**
        * @property 帮助模块
        */
        'helperEl',
    ],

    activeErrorsTpl: [
        '<td role="presentation" sid="sideErrorCell" valign="middle" style="" width="21">',
            '<div role="presentation" sid="textfield-XXX-errorEl" class="mi-form-error-msg mi-form-invalid-icon" title="" ',
                'style="" data-errorqtip="&lt;ul class=&quot;mi-list-plain&quot;&gt;&lt;li role=&quot;alert&quot;&gt;Name is required&lt;/li&gt;&lt;/ul&gt;">',
                '<ul class="mi-list-plain"><li role="alert"></li></ul>',
            '</div>',
        '</td>'
    ],


    /**
    * 帮助信息
    */
    helperTpl: [
        '<td role="helper" >',
            '<div role="helper-inner" style="mi-form-helper-msg mi-form-helper-icon" >',
                '<ul class="mi-list-plain"><li role="alert"></li></ul>',
            '</div>',
        '</td>'
    ],


    //activeError: null ,

    labelableRenderTpl: [
        '<table role="Labelable" class="mi-field mi-table-plain mi-form-item mi-field-default " ',
            'cellpadding="0" cellspacing="0" style="table-layout: fixed; width: 100%; ">',
            '<tbody>',
                '<tr role="presentation" class="mi-form-item-input-row">',
                    '<td role="presentation" class="mi-form-item-body"></td>',
                '</tr>',
            '</tbody>',
        '</table>'
    ],


    requiredTpl: [
        '<span style="color:red;font-weight:bold" data-qtip="Required">*</span>'
    ],



    formItemCls: Mini2.baseCSSPrefix + 'form-item',

    labelCls: Mini2.baseCSSPrefix + 'form-item-label',

    helerCls : Mini2.baseCSSPrefix + 'form-helper-msg',

    errorMsgCls: Mini2.baseCSSPrefix + 'form-error-msg',

    baseBodyCls: Mini2.baseCSSPrefix + 'form-item-body',

    inputRowCls: Mini2.baseCSSPrefix + 'form-item-input-row',

    fieldBodyCls: '',

    mixinsPropertys: [
        'fieldLabel',
        'labelAlign',
        'labelWidth',
        'labelPad',
        'labelSeparator',
        'hideLabel',

        'hideHelper',
        'helperText',
        'helperLayout',
        'helperStyle'
    ],

    clearCls: Mini2.baseCSSPrefix + 'clear',

    invalidCls: Mini2.baseCSSPrefix + 'form-invalid',

    fieldLabel: undefined,


    //默认 left
    //bodyAlign :'left',

    labelAlign: 'left',

    labelWidth: 100,

    labelPad: 5,

    labelSeparator: ':',

    hideLabel: false,

    labelCell: undefined,


    getEl: function () {
        "use strict";
        var me = this,
            labEl,
            fieldLabel = me.fieldLabel;

        labEl = $('<label class="mi-form-item-label mi-unselectable" unselectable="on"></label>');
        labEl.html((fieldLabel ? fieldLabel : '标签') + me.labelSeparator);

        labEl.addClass("mi-form-item-label-" + me.labelAlign);
        labEl.css({
            "width": me.labelWidth + "px",
            "margin-right": me.labelPad + "px"
        });

        if (me.required) {
            labEl.append(Mini2.$join(me.requiredTpl));
        }

        return labEl;
    },

    setHideLabel: function (value) {
        "use strict";
        var me = this,
            labelCell = me.labelCell;

        me.hideLabel = value;

        if (value) {
            if (!labelCell) {
                me.renderLabelCell();
            }
        }
        else if (labelCell) {
            labelCell.hide();
        }
    },


    setLabelPad: function (value) {
        "use strict";
        var me = this,
            el,
            owner = me.owner,
            cellEl,
            labEl,
            labelCls = me.labelCls;

        me.labelPad = value;

        if (owner && owner.el) {
            el = owner.el;

            cellEl = el.find('td.mi-field-label-cell:first');
            labEl = cellEl.find('label:first');
        }

        labEl.css({ "margin-right": me.labelPad + "px" });
    },

    getLabelPad: function () {
        return this.labelPad;
    },

    setLabelAlign: function (value) {
        "use strict";
        var me = this, 
            owner = me.owner,
            el,
            cellEl,
            labEl,
            labelCls = me.labelCls;

        me.labelAlign = value;

        if (owner && owner.el) {
            el = owner.el;

            cellEl = el.find('td.mi-field-label-cell:first');
            labEl = cellEl.find('label:first');

            labEl.removeClass(labelCls + '-left');
            labEl.removeClass(labelCls + '-right');
        }

        labEl.addClass("mi-form-item-label-" + me.labelAlign);
    },

    getLabelAlign: function () {
        var me = this;

        return me.labelAlign;
    },

    setWidth: function (value) {
        "use strict";
        var me = this,
            owner = me.owner,
            el,
            labEl,
            cellEl,
            labelWidth;

        me.labelWidth = value;


        if (owner && owner.el) {
            el = owner.el;

            cellEl = el.find('td.mi-field-label-cell:first');
            labEl = cellEl.find('label:first');

            labelWidth = value + me.labelPad;

            $(cellEl).css('width', labelWidth);
            $(labEl).css('width', value);
        }
    },

    getWidth: function () {
        var me = this;
        return me.labelWidth;
    },

    renderLabelCell: function () {
        "use strict";
        var me = this,
            labelCell,
            bodyEl;

        bodyEl = me.labelableRenderTpl.find("td.mi-form-item-body:first");

        me.labelCell = labelCell = Mini2.$join(['<td role="presentation" valign="top" halign="left" class="mi-field-label-cell"></td>']);

        labelCell.css('width',me.labelWidth + me.labelPad);

        $(bodyEl).before(labelCell);

    },

    initLabelable: function () {
        "use strict";
        var me = this,
            labeEl = me.labelableRenderTpl;


        labeEl = Mini2.$join(labeEl);

        me.labelableRenderTpl = labeEl;

        /**
        *
        * 注意: 设计模式下, 外面套多一层 div
        *
        **/
        if (Mini2.designMode()) {
            var divEl = $('<div class="mi-form-item"></div>');

            labeEl.appendTo(divEl);

            me.labelableRenderTpl = divEl;
        }
        
        me.lastActiveError = '';

        if (!me.hideLabel) {
            me.renderLabelCell();
        }

        if (!me.hideHelper) {
            me.renderHelperCell();
        }

    },


    /**
    * 渲染帮助信息框
    */
    renderHelperCell:function(){
        "use strict";
        var me = this,
            helperCell,
            helperStyle,
            iconEl,
            bodyEl;


        if (!me.hideHelper && !Mini2.isBlank(me.helperText) ) {

            helperStyle = me.helperStyle;
            

            bodyEl = me.labelableRenderTpl.find("td.mi-form-item-body:first");

            me.helperCell = helperCell = Mini2.$join([
                '<td role="presentation" valign="top" halign="left" class="mi-field-helper-cell">',
                    '<ul>',
                        '<li>',
                            '<div class="mi-helper-icon"></div>',
                        '</li>',
                    '</ul>',
                '</td>'
            ]);

            iconEl = helperCell.find('.mi-helper-icon');

            if ('icontext' == helperStyle) {
                var textEl = Mini2.$join('<div class="mi-helper-text">', me.helperText, '</div>');

                iconEl.after(textEl);
            }
            else if('icon' == helperStyle) {

                iconEl.attr('data-original-title', me.helperText);
                
                if (iconEl.tooltip) {
                    iconEl.tooltip({
                        placement: 'right',
                        delay: 200,
                        container: Mini2.getBody()
                    });
                }
            }
            

            helperCell.css('width', 0);

            $(bodyEl).parent().append(helperCell);
        }
    },


    /**
    * 设置帮助信息
    */
    setHelper: function (heler, styles, layout) {

    },


    getActiveError: function () {
        return this.activeError || '';
    },

    hasActiveError: function () {
        return !!this.getActiveError();
    },

    setActiveError: function (msg) {

        this.setActiveErrors(msg);
    },

    //获取错误集合
    getActiveErrors: function () {
        return this.activeErrors || [];
    },

    //设置错误集合信息
    setActiveErrors: function (errors) {
        var me = this;

        if (!Mini2.isArray(errors)) {
            errors = [errors];
        }

        me.activeError = errors[0];
        me.activeErrors = errors;

        //        me.activeError = me.getTpl('activeErrorsTpl').apply({
        //            errors: errors,
        //            listCls: Ext.plainListCls 
        //        });

        me.renderActiveError();
    },

    //删除错误提示的 dom 元素
    unsetActiveError: function () {
        var me = this;
        delete me.activeError;
        delete me.activeErrors;
        me.renderActiveError();
    },


    renderActiveError: function () {
        "use strict";
        var me = this,
            activeError = me.getActiveError(),
            hasError = !!activeError,
            errorEl = me.errorEl;

        if (activeError !== me.lastActiveError) {
            //me.on('errorchange', me, activeError);
            me.lastActiveError = activeError;
        }

        if (hasError) {

            if (!errorEl) {

                me.errorEl = errorEl = Mini2.$joinStr(me.activeErrorsTpl);

                var bodyEl = me.labelableRenderTpl.find("td.mi-form-item-body:first");

                $(bodyEl).after(errorEl);
            }

            errorEl.show();

            var errMsgEl = errorEl.children('.mi-form-error-msg');
            $(errMsgEl).attr('title', activeError);
        }
        else {
            if (errorEl) {
                errorEl.hide();
            }
        }

        //        if (me.rendered && !me.isDestroyed && !me.preventMark) {
        //            // Add/remove invalid class
        //            me.el[hasError ? 'addCls' : 'removeCls'](me.invalidCls);

        //            // Update the aria-invalid attribute
        //            me.getActionEl().dom.setAttribute('aria-invalid', hasError);

        //            // Update the errorEl (There will only be one if msgTarget is 'side' or 'under') with the error message text
        //            if (me.errorEl) {
        //                me.errorEl.dom.innerHTML = activeError;
        //            }
        //        }

    }


}, function (args) {
    "use strict";
    var me = this;

    Mini2.apply(me, args);

    if (me.owner) {
        var owner = me.owner,
            i,
            mixinsPropertys = me.mixinsPropertys,
            len = mixinsPropertys.length,
            propName;

        for (i = 0; i < len; i++) {
            propName = mixinsPropertys[i];

            me[propName] = owner[propName] || me[propName];
        }
    }

    me.initLabelable();
});


/************************************************************************/
/*                                           */
/*    ui/form/CheckboxGroup.js                                             */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini.js" />
/// <reference path="../../Mini-more.js" />


Mini2.define('Mini2.ui.form.CheckboxGroup', {

    extend: 'Mini2.ui.form.field.Base',

    alias: 'widget.checkboxgroup',

    log: Mini2.Logger.getLogger('Mini2.ui.form.CheckboxGroup'),

    mixins: {
        labelable: 'Mini2.ui.form.Labelable'
    },

    /**
    * 关键标记
    */
    isCheckGroup: true,

    labeldable: null,


    columns: 'auto',

    repeatColumns: 0,
    repeatDirection: 'vertical',
    repeatLayout: 'table',

    vertical: false,

    blankText: "You must select at least one item in this group",

    defaultType: 'checkboxfield',

    defaultItemType: 'Mini2.ui.form.field.CheckBox',


    groupCls: Mini2.baseCSSPrefix + 'form-check-group',

    // private
    extraFieldBodyCls: Mini2.baseCSSPrefix + 'form-checkboxgroup-body',

    // private
    layout: 'checkboxgroup',

    componentCls: Mini2.baseCSSPrefix + 'form-checkboxgroup',


    /**
    * @type {Array}
    */
    items: null,


    //初始化组件
    initComponent: function () {
        "use strict";
        var me = this,
            i,
            items = me.items,
            len = items.length,
            itemCfg,
            elem;


        $(me).muBind('focusout', function () {

            me.fieldEl.removeClass("mi-form-focus");
            me.el.removeClass("mi-form-trigger-wrap-focus");

            me.on('hided');

            //me.isValid();
        });

        me.initLabelable();



        for (i = 0; i < len; i++) {
            itemCfg = Mini2.apply({
                hideLabel: true,
                name: me.name,
                width: ''
            }, items[i]);



            elem = Mini2.create(me.defaultItemType, itemCfg);

            items[i] = elem;
        }

    },


    /**
     * 清空所有 items 
     */
    clearItems: function () {

        "use strict";

        var me = this,
            layouyt = me.repeatLayout,
            items = me.items;

        for (var i = 0; i < items.length; i++) {
            var itemEl = items[i].el;

            $(itemEl).remove();
        }

        me.items = [];

        return me;
    },


    insert :function(items){

        throw new Error('未完成此函数...');

        var me = this;

        if (!Mini2.isArray(items)) {
            items = [items];
        }


        for (var i = 0; i < items.length; i++) {

            var item = items[i];


            var itemCfg = Mini2.apply({
                hideLabel: true,
                name: me.name,
                width: ''
            }, item);



            var elem = Mini2.create(me.defaultItemType, itemCfg);

            me.items.push(elem);

        }

    },

    /**
     * 重置新的 items 
     */
    resetItems: function (items) {
        "use strict";
        var me = this,
            el = me.el, i, j,
            fieldEl = me.fieldEl,
            item,
            itemEl,
            cellEl,
            cols = me.columns,
            layout = me.repeatLayout;
            
        me.clearItems();
        


        for (i = 0; i < items.length; i++) {
            var itemCfg = Mini2.apply({
                hideLabel: true,
                name: me.name,
                width: ''
            }, items[i]);



            var elem = Mini2.create(me.defaultItemType, itemCfg);

            items[i] = elem;
        }

        me.items = items;


        console.debug("layout = ", me.repeatLayout);

        if ('table' == me.repeatLayout) {
            

            fieldEl.find('tbody:first').children().remove();

            var tableEl = fieldEl.children('table');

            var groupTableEl = me.getGroup_TableCell(tableEl, cols, items);


            var row = groupTableEl.row;
            var col = groupTableEl.col;

            var tableEl = groupTableEl.el;//.find('table:first');
            var itemIndex = 0;


            for (i = 0; i < row; i++) {

                for (j = 0; j < col; j++) {
                    cellEl = me.getCell(tableEl, i, j);

                    item = items[itemIndex++];

                    item.renderTo = cellEl;
                    item.render();

                    item.el.css('margin', '0px 15px 0px 0px');

                    if (itemIndex >= items.length) {
                        break;
                    }
                }
            }

        }
        else if ('flow' == me.repeatLayout) {

            var groupTableEl = me.getGroup_Flow();
            groupTableEl = groupTableEl.el;

            var itemWidth = 0;

            if (me.repeatColumns > 0) {
                itemWidth = parseInt(100 / me.repeatColumns);
            }

            for (i = 0; i < items.length; i++) {

                item = items[i];
                item.renderTo = groupTableEl;
                item.render();

                itemEl = item.el;

                //itemEl.css('margin', '0px 15px 0px 0px');

                var itemBodyEl = $(itemEl).find('td.mi-form-item-body:first');

                itemBodyEl.css('padding-right', '15px');


                if ('vertical' == me.repeatDirection) {
                    itemEl.css('float', 'left');
                }

                if (itemWidth > 0) {
                    itemEl.css('width', itemWidth + '%');
                }
            }

        }

        console.debug("----------------------");

        me.bindItemAll(items);
    },

    initValue: function () {
        "use strict";
        var me = this,
            valueCfg = me.value;

        me.originalValue = me.lastValue = valueCfg || me.getValue();

        me.setValue(valueCfg, false);

    },



    getValue: function () {
        "use strict";
        var me = this,
            log = me.log,
            item,
            items = me.items,
            len = items.length,
            checked,
            resultValueStr = '',
            n = 0,
            i;

        for (i = 0; i < len; i++) {

            item = items[i];

            checked = item.checked;

            if (checked) {

                if (n++ > 0) { resultValueStr += ', '; }

                resultValueStr += item.inputValue;
            }
        }

        return resultValueStr;

    },

    setValue: function (value, triggerChangedEvent) {
        "use strict";
        var me = this,
            log = me.log,
            item,
            items = me.items,
            len = items.length,
            isEqual,
            i, j,
            valueList,
            valueDict;

        if (me.locked) {
            console.debug('上锁..');
            return me;
        }

        if (Mini2.isBlank(value)) {
            value = '';
        }

        if (Mini2.isArray(value)) {
            valueList = value;
        }
        else if(Mini2.isString(value)) {
            valueList = value.split(',');
        }

        valueDict = {};

        for (j = 0; j < valueList.length; j++) {
            var v = valueList[j];

            if (Mini2.isString(v)) {
                v = Mini2.String.trim(v);
            }
            else {
                v = v + '';
            }
            valueList[j] = v;
            valueDict[v] = true;
        }

        for (i = 0; i < len; i++) {

            item = items[i];

            isEqual = !!valueDict[item.inputValue];


            item.setValue(isEqual, triggerChangedEvent);

        }

        return me;

    },

    setHeight: function (value) {

    },

    createGroupCell: function (tableEl, row, col) {
        "use strict";
        var i,
            j,
            tbodyEl,
            trEl;

        tbodyEl = tableEl.find('tbody:first');

        for (i = 0; i < row; i++) {

            trEl = $('<tr></tr>');

            tbodyEl.append(trEl);

            for (j = 0; j < col; j++) {
                //tdEl = $();
                trEl.append('<td class="mi-form-radio-group" valign="top"></td>');
            }
        }
    },



    getGroup_TableCell: function (tableEl, columns, items) {
        "use strict";
        var me = this,
            result,
            col, yuNum, row,
            len = items.length;
            
        if ('auto' == columns) {
            me.createGroupCell(tableEl, 1, len);

            result = { 'el': tableEl, 'row': 1, 'col': len };
        }
        else if (columns <= 1) {
            me.createGroupCell(tableEl, len, 1);

            result = { 'el': tableEl, 'row': len, 'col': 1 };
        }
        else {
            col = parseInt(columns);
            yuNum = len % col;
            row = (len - yuNum) / col;

            if (yuNum > 0) { row++; }

            me.createGroupCell(tableEl, row, col);


            result = { 'el': tableEl, 'row': row, 'col': col };
        }

        return result;
    },

    getGroup_Table: function () {
        "use strict";
        var me = this,
            items = me.items,
            columns = me.repeatColumns,
            
            tableEl,
            result;

        tableEl = Mini2.$join([
            '<div class="mi-checkbox-group-inner" >',
                '<table id="radiogroup-', me.muid, '-innerCt" class="mi-table-plain" cellpadding="0" role="presentation" style="table-layout: auto;">',
                    '<tbody>',
                    '</tbody>',
                '</table>',
            '</div>'
        ]);

        result = me.getGroup_TableCell(tableEl, columns, items);

        return result;
    },

    //获取组的流
    getGroup_Flow: function () {
        "use strict";

        var me = this,
            result,
            columns = me.repeatColumns,
            tableEl;

        tableEl = Mini2.$join([
            '<div>',
            '</div>']);

        result = { 'el': tableEl };

        return result;
    },

    

    getFieldEl: function () {
        "use strict";
        var me = this,
            i, j,
            item,
            itemEl,
            cellEl,
            items = me.items;

        if ('table' == me.repeatLayout) {
            var groupTableEl = me.getGroup_Table();

            var row = groupTableEl.row;
            var col = groupTableEl.col;

            groupTableEl = groupTableEl.el;
            var tableEl = groupTableEl.children('table');
            var itemIndex = 0;


            for (i = 0; i < row; i++) {

                for (j = 0; j < col; j++) {
                    cellEl = me.getCell(tableEl, i, j);

                    item = items[itemIndex++];

                    item.renderTo = cellEl;
                    item.render();

                    item.el.css('margin', '0px 15px 0px 0px');

                    if (itemIndex >= items.length) {
                        break;
                    }
                }
            }

            return groupTableEl;
        }
        else if ('flow' == me.repeatLayout) {

            var groupTableEl = me.getGroup_Flow();
            groupTableEl = groupTableEl.el;

            var itemWidth = 0;

            if (me.repeatColumns > 0) {
                itemWidth = parseInt(100 / me.repeatColumns);
            }

            for (i = 0; i < items.length; i++) {

                item = items[i];
                item.renderTo = groupTableEl;
                item.render();

                itemEl = item.el;

                //itemEl.css('margin', '0px 15px 0px 0px');

                var itemBodyEl = $(itemEl).find('td.mi-form-item-body:first');

                itemBodyEl.css('padding-right', '15px');


                if ('vertical' == me.repeatDirection) {
                    itemEl.css('float', 'left');
                }

                if (itemWidth > 0) {
                    itemEl.css('width', itemWidth + '%');
                }
            }

            return groupTableEl;
        }
    },

    /**
     * 绑定所有控件的事件
     *
     */
    bindItemAll: function (items) {
        var me = this;

        items = items || me.items;

        $(items).each(function () {
            
            me.bindItem(this);
        });

        return me;
    },

    /**
     * 绑定 item 的 changed 事件
     */
    bindItem: function (item) {

        var me = this;

        $(item).muBind('change', function (e) {
            
            console.debug("触发事件了.......");
            console.debug("item2 === ", item.muid);

            var lastData = item.getValue();

            //上锁,防止触发事件导致'值倒灌'.
            me.locked = true;

            try {
                $(me).muTriggerHandler('changed', [{
                    sender: this,    //原焦点控件
                    target: null,        //新获取焦点控件
                    data: lastData      //原附带的数据
                }]);

            }
            catch (ex) {
                console.error('执行 changed 事件错误.', ex);
            }

            me.locked = false;
        });

    },



    baseRender: function () {
        "use strict";
        var me = this,
            log = me.log,
            bodyCls = 'td.mi-form-item-body:first',
            tableEl,
            fieldEl;

        tableEl = me.getTableContainer();


        if (me.minWidth) {
            tableEl.css({ 'min-width': me.minWidth });
        }

        if (me.maxWidth) {
            tableEl.css({ 'max-width': me.maxWidth });
        }



        if (me.applyTo) {
            $(me.applyTo).replaceWith(tableEl);
        }
        else {
            $(me.renderTo).append(tableEl);
        }

        me.fieldBodyEl = tableEl.find(bodyCls);

        fieldEl = me.getFieldEl();

        me.renderForLableable(tableEl);

        me.appendCell(tableEl, fieldEl, bodyCls);

        me.renderForBoxLabel(tableEl);


        me.fieldEl = fieldEl;
        me.el = tableEl;
        //////////////////////


        me.el.addClass(me.componentCls);
        me.fieldBodyEl.addClass(me.extraFieldBodyCls);

        me.initValue();

        me.bindItemAll();

        if (me.dirty) {
            me.setDirty(me.dirty);
        }

        //me.el.css({ 'height': '24px' });
    },


    render: function () {
        var me = this;

        me.baseRender();

        me.el.data('me', me);
    }
});



/************************************************************************/
/*                                           */
/*    ui/form/RadioGroup.js                                                */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini.js" />
/// <reference path="../../Mini-more.js" />


Mini2.define('Mini2.ui.form.RadioGroup', {

    extend: 'Mini2.ui.form.CheckboxGroup',
    alias: 'widget.radiogroup',

    log: Mini2.Logger.getLogger('Mini2.ui.form.RadioGroup',false),

    defaultType: 'radiofield',

    defaultItemType: 'Mini2.ui.form.field.Radio',

    groupCls: Mini2.baseCSSPrefix + 'form-radio-group',

    // private
    extraFieldBodyCls: Mini2.baseCSSPrefix + 'form-radiogroup-body',

    // private
    layout: 'radiogroup',

    componentCls: Mini2.baseCSSPrefix + 'form-radiogroup',

    //aaa: bindItem
    bindItem: function (item) {
        "use strict";
        var me = this,
            log = me.log;

        $(item).on('change', this, function (e, newValue, oldValue) {

            if (newValue) {
                me.setCheck(this);
            }


            var lastData = item.getValue();

            //上锁,防止触发事件导致'值倒灌'.
            me.locked = true;

            try {
                $(me).muTriggerHandler('changed', [{
                    sender: this,    //原焦点控件
                    target: null,        //新获取焦点控件
                    data: lastData      //原附带的数据
                }]);
            }
            catch (ex) {
                console.error('触发 changed 事件错误', ex);
            }

            me.locked = false;
        });
    },

    setCheck: function (checkItem) {
        "use strict";

        var me = this,
            item,
            items = me.items,
            len = items.length,
            i = len;

        while (i--) {
            item = items[i];
            if (item !== checkItem) {
                item.setValue(false);
            }
        }

        return me;
    },

    setValue: function (value) {
        "use strict";
        var me = this,
            log = me.log,
            item,
            items = me.items,
            len = items.length,
            isEqual,
            i;

        console.trace();

        console.group("setValue=" + value);

        for (i = 0; i < len; i++) {

            item = items[i];

            isEqual = (item.inputValue == value);


            console.debug(this.id + "初始化......." + item.inputValue + "....", isEqual);
            

            if (isEqual) {
                console.debug("item = ", item);
                item.setValue(isEqual);
                break;
            }
        }

        console.groupEnd();
        
        me.trigger('changed', {
            value: value
        });


        return me;
    }


});


/************************************************************************/
/*                                           */
/*    ui/form/Label.js                                                     */
/*                                           */
/************************************************************************/





Mini2.define('Mini2.ui.form.Label', {

    extend: 'Mini2.ui.form.field.Base',
    alias: 'widget.label' ,
    mode: 'ENCODE',

    getFieldEl: function () {
        "use strict";
        var me = this,
            inputEl;

        if ('ENCODE' == me.mode) {
            me.inputEl = inputEl = Mini2.$joinStr(['<label role="Label" class="mi-form-field mi-form-label" ',
                'aria-invalid="false" style="width: 100%; "></label>']);


            if (me.name) {
                inputEl.attr('name', me.name);
            }

            inputEl.text(me.value)
            .attr("id", me.clientId)
            .css('text-align', me.align)
            .attr('autocomplete', me.autoComplete);
        }
        else {
            me.inputEl = inputEl = Mini2.$joinStr(['<div role="Label" class="mi-form-field mi-form-label" ',
                'aria-invalid="false" style="width: 100%; "></div>']);
        }


        return inputEl;
    },


    setValue: function (value) {
        "use strict";
        var me = this,
            hideEl = me.hideEl,
            inputEl = me.inputEl;


        //if ('ENCODE' != me.mode) {
        //    alert(value);
        //    inputEl.val(value);
        //}
        //else {
        //    inputEl.html(value);
        //}


        inputEl.val(value);
        inputEl.html(value);

        if (hideEl) {
            hideEl.val(value);
        }

        return me;
    },

    getValue: function () {
        "use strict";
        var me = this,
            hideEl = me.hideEl,
            inputEl = me.inputEl,
            value;

        if (me.readOnly && hideEl) {
            value = hideEl.val();
        }
        else {
            if ('ENCODE' == me.mode) {
                value = inputEl.val();
            }
            else {
                value = inputEl.html();
            }
        }

        return value;
    },

    render: function () {
        "use strict";
        var me = this,
            hideEl,
            value = me.value;


        me.baseRender();

        me.inputEl.removeAttr('name');

        me.hideEl = hideEl = me.createHideEl();

        hideEl.val(value);

        var bodyCls = 'td.mi-form-item-body:first';
        var tableEl = me.getTableContainer();

        var bodyEl = tableEl.find(bodyCls);

        if (me.bodyAlign) {
            bodyEl.css('text-align', me.bodyAlign);
        }

        me.appendCell(tableEl, hideEl, bodyCls);

        me.el.data('me', me);
    }


});


/************************************************************************/
/*                                           */
/*    ui/form/field/Text.js                                                */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />



Mini2.define('Mini2.ui.form.field.Text', {

    extend: 'Mini2.ui.form.field.Base',


    alias: 'widget.text',

    size: 20,
    minLength: 0,
    maxLength: Number.MAX_VALUE,
    minLengthText: 'The minimum length for this field is {0}',
    maxLengthText: 'The maximum length for this field is {0}',


    //    initComponent: function () {

    //        var me = this;


    //        me.initLabelable();
    //        //this.constructor.base.initComponent.call(this);

    //        //alert("Mini2.ui.form.field.Text");
    //    },


    initEvents: function () {


    },

    bindInputEl_Mouse: function (inputEl) {

        var me = this;

        $(inputEl)
        .on('mousedown', function (e) {

            me.focus();
            Mini2.EventManager.setMouseDown(me, null, me.scope || me, e, true);
        })
        .on('mouseup', function (e) {
            me.on('mouseup', e);
            Mini2.EventManager.setMouseUp(me, e);
        });

    },

    bindInputEl_Key:function(inputEl){
        var me = this;

        $(inputEl).on('keydown', function (e) {
            //console.log('text = ', e);
            me.on('keydown', e);
        }).on('keyup', function (e) {
            me.on('keyup', e);
        });
    },


    //获取文本框光标位置
    getCursorPosition: function () {
        var me = this,
            inputEl = me.inputEl[0],
            curPos = 0,
            selectItem, range;

        if (inputEl) {

            if (inputEl.selectionStart) {//非IE浏览器
                curPos = inputEl.selectionStart;
            }
            else {//IE
                var selectItem = document.selection;

                if (selectItem) {
                    range = selectItem.createRange();
                    range.moveStart("character", -inputEl.value.length);
                    curPos = range.text.length;
                }
            }
        }

        return curPos;
    },



    //光标是否在开始位置
    isFirstCursorPos: function () {
        var me = this,
            curPos = me.getCursorPosition();

        return curPos == 0;
    },

    //光标是否在尾部
    isLastCursorPos: function () {
        var me = this,
            inputEl = me.inputEl,
            len = $(inputEl).val().length,
            curPos = me.getCursorPosition();

        return curPos == len;
    },


    onChange: function (newVal, oldVal) {


        this.autoSize();



    },


    autoSize: function () {


    }

});


/************************************************************************/
/*                                           */
/*    ui/form/field/Password.js                                            */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />



Mini2.define('Mini2.ui.form.field.Password', {

    extend: 'Mini2.ui.form.field.Text',

    alias: 'widget.password',
    type:'password'


});


/************************************************************************/
/*                                           */
/*    ui/form/field/Trigger.js                                             */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />



Mini2.define('Mini2.ui.form.field.Trigger', {

    extend: 'Mini2.ui.form.field.Text',

    alias: 'widget.trigger',
    log : Mini2.Logger.getLogger( 'Mini2.ui.form.field.Trigger',  false),

    //按钮元素
    buttonEl: null,

    //弹出的版面
    dropDownPanel: null,


    emptyText: '',

    focusCls: 'mi-form-focus',

    //数据仓库
    store: false,

    itemBody: null,

    content: null,

    changed: Mini2.emptyFn,


    /**
     * 模式，可编辑-UserInput， 不可键盘输入-None .  mode=[none|user_input]
     */
    mode: 'user_input',

    //buttonCls:'mi-form-trigger-more',


    //初始化组件
    initComponent: function () {

        var me = this;

        me.fieldCls = 'mi-form-type-text';

        $(me).muBind('focusout', function () {

            me.fieldEl.removeClass('mi-form-focus');
            //me.fieldEl.removeClass('mi-form-invalid-field');

            me.el.removeClass("mi-form-trigger-wrap-focus");

            me.hideDropDownPanel();

            me.clearInvalid();
        });

        me.initStore();

        me.initLabelable();
    },


    initStore: function () {
        /// <summary>初始化数据仓库</summary>

        var me = this,
            srcStore = me.store,
            store;


        if (Mini2.isString(srcStore)) {
            store = Mini2.data.StoreManager.lookup(me.store);

            delete me.store;
        }
        else if (Mini2.isArray(srcStore)) {

            store = Mini2.create('Mini2.data.Store', {
                storeId: 'MiniStore_' + Mini2.newId(),
                fields: me.fields || [],
                data: srcStore,
                autoSave: false
            });

            delete me.store;
        }
        else {
            store = me.store;
        }

        me.store = store;

        me.bindStore(store);
    },


    getStore: function () {

        var me = this;

        return me.store;

    },

    bindStore: function (store) {
        //        var me = this;
        //        me.store = store;

        //        $(store).muBind('add', me, me.store_add);
        //        $(store).muBind('datachanged', me, me.store_dataChanged);
        //        $(store).muBind('refresh', me, me.store_refresh);
        //        $(store).muBind('load', me, me.store_load);
    },


    getTriggerMarkup: function () {

        var me = this,
            tpl = Mini2.$join([
            '<div class="mi-boundlist ',
                'mi-layer ',
                'mi-border-box" ',
                'style="border-width: 1px; right: auto; z-index: 39001; display:none; ">',
                '',
            '</div>'
        ]);

        //    '<div id="datepicker-1041-innerEl" role="grid">']);

        return tpl;
    },


    /**
     * 改写隐藏标签
     */
    hide: function () {

        var me = this;
        
        me.visible = false;

        me.el.hide();

        me.hideDropDownPanel();

        me.callParent();

        return me;
    },

    layoutReset: function () {
        var me = this;

        me.hideDropDownPanel();

    },





    init_DropDwonPanel: function () {
        /// <summary>初始化下拉版面</summary>

        var me = this;
        if (me.dropDownPanel != null) {
            return;
        }


        var tpl = me.getTriggerMarkup();

        me.dropDownPanel = $(tpl);
        $(document.body).append(me.dropDownPanel);

        $(me.dropDownPanel).mousedown(function (e) {

            //log.debug("form.field.Trigger.mousedown() ");

            //Mini2.EventManager.setScope(this, [me.el, me.dropDownPanel]);
        })
        .mousemove(function (e) {

        })
        .mouseup(function (e) {
            //console.log("form.field.Trigger.mouseup() ");

            Mini2.EventManager.stopEvent(e);
            Mini2.EventManager.clear(me.scope || me.el);

        });

    },


    getBoundPanel: Mini2.emptyFn,

    initContentPanel: function () {

        var me = this;

        if (!me.isCustom) {
            var content = null;

            if (Mini2.isString(me.content)) {

                if (window[me.content]) {
                    content = window[me.content];
                }
                else {
                    content = $(me.content);
                }

                delete me.content;
            }
            else {
                content = me.content;
            }

            me.isCustom = true;


            $(content).addCls('mi-boundlist', 'mi-layer', 'mi-border-box')
                .css({ right: 'auto', 'z-index': 39001 })
                .show();

            me.dropDownPanel = content;

        }
    },


    beforeShowDropDownPanel: function () {
        /// <summary>开始显示之前的</summary>
        var me = this;

        if (me.content) {
            me.initContentPanel();
        }

        if (!me.isCustom) {
            me.init_DropDwonPanel();
            var panel = me.dropDownPanel;

            var boundList = me.getBoundPanel();
            $(panel).children().remove();
            $(panel).append(boundList);

        }
    },


    showDropDownPanel: function () {
        /// <summary>显示下拉框</summary>

        var me = this;

        me.init_DropDwonPanel();

        if (me.dropDown) {
            try {
                me.dropDown.call(me, me);
            }
            catch (ex) {
                throw new Error("执行 Trigger.dropDown(...) 事件发生错误");
            }
        }


        me.trigger('dropDown'); //触发下拉框


        var el = me.el,
            panel = me.dropDownPanel,
            w = me.dropDownWidth || (me.dropDownWidth > 0) || el.width(),
            h = me.dropDownHeight, //|| 200;
            office = me.fieldEl.offset();


        //console.log("下拉偏移量",office);

        if (!me.isCustom) {
            panel.css({
                'width': w - 4,
                'height': h
            });
        }

        var buttomY = office.top + el.height() - 2 + h;


        panel.css({
            'left': office.left,
            'top': office.top + el.height() - 2
        }).show();


    },


    hideDropDownPanel: function () {
        var me = this,
            dropDownPanel = me.dropDownPanel;

        if (dropDownPanel == null) {
            return;
        }

        dropDownPanel.hide();


        me.trigger('dropDownClosed'); //下拉框关闭的事件
    },


    triggerDropDownPanel: function () {
        var me = this,
            dropDownPanel = me.dropDownPanel;

        if (dropDownPanel  && dropDownPanel.css('display') != 'none') {
            //console.log('隐藏');
            me.hideDropDownPanel();
        }
        else {
            //console.log('显示');
            me.beforeShowDropDownPanel();
            me.showDropDownPanel();
        }
    },

    onPositionChanged: function () {
        var me = this,
            el = me.el,
            office,
            panel = me.dropDownPanel;

        if (panel) {
            office = el.offset();

            panel.css({
                left: office.left,
                top: office.top + el.height() - 2
            });
        }
    },

    //引发事件
    onButtonClick: function () {
        var me = this,
            btnClick = me.buttonClick,
            btnClick_Cb = me.buttonClick_Callback;
        

        if (btnClick || btnClick_Cb) {

            if (btnClick && Mini2.isFunction(btnClick)) {
                btnClick.call(me,me);
            }

            if (btnClick_Cb && Mini2.isFunction(btnClick_Cb)) {
                btnClick_Cb.call(me,me);
            }

        }
        else {
            me.triggerDropDownPanel();
        }


    },

    //按钮绑定事件
    bindEvent_Button: function (btnEl) {
        var me = this,
            baseCls = "mi-form",
            overCls = baseCls + "-trigger-over",
            clickCls = baseCls + "-trigger-click";

        $(btnEl).mouseenter(function () {
            if (!me.readOnly) {
                $(this).addClass(overCls);
            }
        })
        .mouseleave(function () {
            if (!me.readOnly) {
                $(this).removeClass(overCls);
            }
        });

        $(btnEl).muBind('mousedown',function (e) {
            if (!me.readOnly) {
                me.focus();
            }
            Mini2.EventManager.stopEvent(e);
        })
        .muBind('mouseup',function (e) {
            if (!me.readOnly) {
                $(this).removeClass(clickCls);

                me.onButtonClick();
            }
            Mini2.EventManager.stopEvent(e);
        });


    },



    focus: function () {

        var me = this,
            el = me.el,
            fieldEl = me.fieldEl;

        if (!el.hasClass('mi-form-trigger-wrap-focus')) {
            fieldEl.addClass('mi-form-focus');

            el.addClass('mi-form-trigger-wrap-focus');


            //特殊处理，延时获取焦点。不然无法及时得到焦点。
            if (!me._focusTimeout) {

                if (me.inputEl) {
                    me._focusTimeout = setTimeout(function () {

                        var inputEl = me.inputEl;

                        //如果焦点已经移除， 那么就作废
                        if (fieldEl.hasClass('mi-form-focus')) {

                            inputEl.focus();

                        }

                        me._focusTimeout = null;

                    }, 200);
                }
            }

            //console.log('me.scope', me.scope);

            //最后一个参数,强制设置
            Mini2.ui.FocusManager.setControl(me.scope || me, null, null, true);
        }
    },




    bindInputEl_Mouse2: function (inputEl) {

        var me = this;

        if ('none' == me.mode) {

            inputEl.css('current', 'pointer');

            $(inputEl).mousedown(function (e) {
                if (!me.readOnly) {
                    me.focus();
                }
                Mini2.EventManager.stopEvent(e);
            })
            .mouseup(function (e) {
                if (!me.readOnly) {
                    me.onButtonClick();
                }
                Mini2.EventManager.stopPropagation(e);
            });

            //$(inputEl).keyup(function (e) {

            //    if (!me.readOnly) {

            //        console.debug('----keys = ', e.keyCode);

            //        if (46 == e.keyCode) {
            //            me.setValue('');
            //            Mini2.EventManager.stopPropagation(e);
            //        }
            //    }

            //});
        }


    },


    getFieldEl: function () {
        var me = this,
            log = me.log,
            tableEl,
            inputEl,
            btnEl,
            sysInfo = Mini2.SystemInfo.formTrigger;

        tableEl = Mini2.$join([
            '<table class="mi-form-trigger-wrap" cellpadding="0" cellspacing="0" style="table-layout: fixed; width: 100%; ">',
                '<tbody>',
                    '<tr>',
                        '<td class="mi-form-trigger-input-cell" style="width: 100%; "></td>',
                        '<td valign="top" class="mi-trigger-cell mi-unselectable" style="width:22px;" role="button" ></td>',
                    '</tr>',
                '</tbody>',
            '</table>'
        ]);

        me.inputEl = inputEl = Mini2.$join([
            '<input type="text" class="mi-form-field mi-form-text" ',
                'autocomplete="off" aria-invalid="false" spellcheck="false" style="width: 100%; ">'
        ]);

        if (!Mini2.isBlank(me.placeholder)) {
            inputEl.attr('placeholder', me.placeholder);
        }

        if (me.required) {
            inputEl.addClass('mi-form-required-field');
        }

        btnEl = Mini2.$join(['<div class="mi-form-trigger mi-form-arrow-trigger " role="button"></div>']);

        me.buttonEl = btnEl;

        if (me.buttonCls) {
            btnEl.addCls(me.buttonCls);
        }

        inputEl.attr("id", me.clientId);

        if (me.name) {
            inputEl.attr('name', me.name);
        }

        me.appendCell(tableEl, inputEl, 'td.mi-form-trigger-input-cell');
        me.appendCell(tableEl, btnEl, 'td.mi-trigger-cell');


        tableEl.find('td.mi-trigger-cell').width(sysInfo.width);

        if (undefined != me.value) {
            me.setValue(me.value);

            me.srcValue = me.value;

            delete me.value;
        }

        me.bindEvent_Button(btnEl);

        me.bindInputEl_Mouse(inputEl);
        me.bindInputEl_Key(inputEl);

        me.bindInputEl_Mouse2(inputEl);

        me.initTypeahead(inputEl);  //绑定输入提示


        $(me).on('keyup', function (data, ea) {

                      
            
            if (13 == ea.keyCode && me.mapping) { //13=回车
                me.onMaping();
                ea.cancel = true;
            }

        });


        if ('none' == me.mode) {
            me.setMode(true);
        }

        return tableEl;
    },


    /**
    * 触发映射
    *
    */
    onMaping:function(){

        var me = this,
            mapTimer = me.mapTimer;

        if (mapTimer) {
            mapTimer.resetStart();
        }
        else {
            me.mapTimer = Mini2.setTimer(function () {
                       
                me.mapping.call(me, me);

            }, [500,1]);
        }

    },



    //设置只读状态。bool 值
    setMode: function (value) {
        "use strict";
        var me = this,
            log = me.log,
            el = me.el,
            inputEl = me.inputEl,
            hideEl = me.hideEl,
            readonly = 'readonly';



        if (value) {
            //log.debug('设置只读属性');
            inputEl.attr(readonly, readonly);
        }
        else {
            //log.debug('删除只读属性');
            inputEl.removeAttr(readonly);
        }

        if (value) {
            if (!hideEl) {
                //log.debug('创建隐藏标签');

                inputEl.attr('name', '');
                me.hideEl = hideEl = me.createHideEl();
                hideEl.attr('name', me.name);
                inputEl.after(hideEl);
            }
        }
        else {
            if (hideEl) {

                //log.debug("删除隐藏标签");

                inputEl.attr('name', me.name);

                $(hideEl).remove();

                delete me.hideEl;
            }
        }


        return me;
    },


    //设置只读状态。bool 值
    setReadOnly: function (value) {
        "use strict";
        var me = this,
            log = me.log,
            el = me.el,
            inputEl = me.inputEl,
            hideEl = me.hideEl,
            readonly = 'readonly',
            readonlyCls = 'mi-form-item-readonly';

        //log.debugFormat('调用 setReadOnly({0}) 函数', value);

        value = !!value;
        me.readOnly = value;
        el && el.toggleClass(readonlyCls, value);


        if (!inputEl) {
            return;
        }

        if (value || me.mode == 'none') {
            log.debug('设置只读属性');
            inputEl.attr(readonly, readonly);
        }
        else {
            log.debug('删除只读属性');
            inputEl.removeAttr(readonly);
        }


        if (value || me.mode == 'none') {
            if (!hideEl) {
                log.debug("创建隐藏标签");
                inputEl.attr('name', '');
                me.hideEl = hideEl = me.createHideEl();
                hideEl.attr('name', me.name);
                inputEl.after(hideEl);
            }
        }
        else {
            if (hideEl) {
                log.debug("删除隐藏标签");

                inputEl.attr('name', me.name);

                $(hideEl).remove();

                delete me.hideEl;
            }
        }

        $(inputEl).change(function () {
            me.clearInvalid();
        });

        $(inputEl).keyup(function () {
            me.clearInvalid();
        });

        return me;
    }


});


/************************************************************************/
/*                                           */
/*    ui/form/field/Field.js                                               */
/*                                           */
/************************************************************************/



Mini2.define('Mini2.ui.form.field.Field', {

    value:"",

    disabled:false,

    submitValue: true,

    validateOnChange: true,

    initField: function () {


    },


    initValue: function () {


    },


    
    getName: function() {
        return this.name;
    },


    
    getValue: function() {
        return this.value;
    },


    setValue: function(value) {
        var me = this;
        me.value = value;
        me.checkChange();
        return me;
    },


    isEqual: function(value1, value2) {
        return String(value1) === String(value2);
    },


    isEqualAsString: function(value1, value2){
        return String(Mini2.value(value1, '')) === String(Mini2.value(value2, ''));
    },


    getSubmitData: function() {
        var me = this,
            data = null;
        if (!me.disabled && me.submitValue && !me.isFileUpload()) {
            data = {};
            data[me.getName()] = '' + me.getValue();
        }
        return data;
    },



    getModelData: function() {
        var me = this,
            data = null;

        if (!me.disabled && !me.isFileUpload()) {
            data = {};
            data[me.getName()] = me.getValue();
        }
        return data;
    },


    reset : function(){
        var me = this;

        me.beforeReset();
        me.setValue(me.originalValue);
        me.clearInvalid();
        // delete here so we reset back to the original state
        delete me.wasValid;
    },
    

    
    beforeReset: Mini2.emptyFn,

    
    resetOriginalValue: function() {
        this.originalValue = this.getValue();
        this.checkDirty();
    },



    checkChange: function () {
        "use strict";
        if (!this.suspendCheckChange) {
            var me = this,
                newVal = me.getValue(),
                oldVal = me.lastValue;
            if (!me.isEqual(newVal, oldVal) && !me.isDestroyed) {
                me.lastValue = newVal;
                me.fireEvent('change', me, newVal, oldVal);
                me.onChange(newVal, oldVal);
            }
        }
    },


    onChange: function(newVal, oldVal) {
        if (this.validateOnChange) {
            this.validate();
        }
        this.checkDirty();
    },


    getErrors: function(value) {
        return [];
    },


    isValid : function() {
        var me = this;
        return me.disabled || Mini2.isEmpty(me.getErrors());
    },

    isFileUpload: function() {
        return false;
    },

    markInvalid: Mini2.emptyFn,

    clearInvalid: Mini2.emptyFn
});


/************************************************************************/
/*                                           */
/*    ui/form/field/Hidden.js                                              */
/*                                           */
/************************************************************************/



Mini2.define('Mini2.ui.form.field.Hidden', {

    extend: 'Mini2.ui.Component',


    alias: 'widget.hidden',


    initComponent: function () {

        var me = this;

    },





    setValue: function (value) {
        var me = this,
            el = me.el;

        el.val(value);


        log.debug('赋值 hidden.value = ' + me.el.val());

        return me;
    },

    getValue: function () {
        var me = this,
            el = me.el,
            value;

        value =  el.val();
        
        return value;
    },



    baseRender: function () {
        "use strict";
        var me = this,
            el;

        


        if (me.applyTo) {
            
            var srcEl = $(me.applyTo);

            if (srcEl.length) {
                me.el = el = srcEl;
            }
            else {
                me.el = el = $('<input type="hidden" />');

                $(me.applyTo).replaceWith(el);
            }
        }
        else {
            me.el = el = $('<input type="hidden" />');
            $(me.renderTo).append(el);
        }

        el.attr('name', me.name);
        
        if (me.value != undefined) {
            me.setValue(me.value);
            delete me.value;
        }

        return me;
    },

    initValue: Mini2.emptyFn,


    render: function () {
        var me = this;

        me.baseRender();


        me.el.data('me', me);
    }


});



/************************************************************************/
/*                                           */
/*    ui/form/field/CheckBox.js                                            */
/*                                           */
/************************************************************************/


/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />


Mini2.define('Mini2.ui.form.field.CheckBox', {

    extend: 'Mini2.ui.form.field.Base',


    alias: 'widget.checkbox',

    log: Mini2.Logger.getLogger('Mini2.ui.form.field.CheckBox',false),

    alternateClassName: 'Mini2.ui.form.Checkbox',

    fieldCls: Mini2.baseCSSPrefix + '-form-type-checkbox',

    focusCls: Mini2.baseCSSPrefix + 'form-checkbox-focus',

    checkedCls: Mini2.baseCSSPrefix + 'form-cb-checked',

    // private
    extraFieldBodyCls: Mini2.baseCSSPrefix + 'form-checked-body',

    componentLayout: 'field',

    isCheckbox: true,
    
    checked: null,


    textEl: null, //标签文本对象
    //true 文本标签
    trueText: null,

    //false 标签
    falseText: null,


    inputValue: 'on',

    inputType: 'checkbox',

    inputTypeAttr: 'button',

    originalValue: false,

    lastValue: false,

    initComponent: function () {
        "use strict";
        var me = this;

        $(me).muBind('focusout', function () {


            me.fieldEl.removeClass("mi-form-focus")
                .removeClass(me.focusCls);

            me.el.removeClass("mi-form-trigger-wrap-focus");

        });

        me.initLabelable();

        //        if (me.checked) {
        //            me.baseSetValue(true);
        //        }
    },


    initValue: function () {
        "use strict";
        var me = this,
            checked = !!me.checked;

        /**
        * @property {Object} originalValue
        * The original value of the field as configured in the {@link #checked} configuration, or as loaded by the last
        * form load operation if the form's {@link Ext.form.Basic#trackResetOnLoad trackResetOnLoad} setting is `true`.
        */
        me.originalValue = me.lastValue = checked;

        // Set the initial checked state
        me.setValue(checked, false);

        if (me.textEl) {
            var txt = checked ? me.trueText : me.falseText;
            me.textEl.html(txt);
        }

    },


    //private
    baseSetValue: function (value, triggerChangedEvent) {
        "use strict";
        var me = this,
            el = me.el,
            srcInputEl = me.srcInputEl,
            checkedCls = me.checkedCls,
            checked,
            originalValue = me.originalValue;

        //if (value) {
        //    el.addClass(checkedCls);
        //}
        //else {
        //    el.removeClass(checkedCls);
        //}

        me.lastValue = me.checked;

        me.checked = checked = !!value;


        $(el).toggleClass(checkedCls, checked);

        if (srcInputEl) {
            srcInputEl.prop('checked', checked);
        }



        if (false !== triggerChangedEvent) {
            me.trigger('changed', {
                value: checked
            });
        }
    },

    setValue: function (value, triggerChangedEvent) {
        "use strict";
        var me = this,
            log = me.log,
            el = me.el,
            srcInputEl = me.srcInputEl,
            checkedCls = me.checkedCls,
            checked,
            originalValue = me.originalValue;

        value = !!value;

        if (me.checked === value && $(el).hasClass(checkedCls) ) {


            return;
        }

        me.lastValue = me.checked;

        me.checked = checked = value;
        
        $(el).toggleClass(checkedCls, checked);
        
        if (srcInputEl) {
            srcInputEl.prop('checked', checked);
        }

        //if (value) {
        //    $(me.inputEl).children().removeClass('switch-off').addClass('switch-on');
        //}
        //else {
        //    $(me.inputEl).children().removeClass('switch-on').addClass('switch-off');

        //}

        if (me.textEl) {

            var txt = value ? me.trueText : me.falseText;

            me.textEl.html(txt);
        }

        if (checked != originalValue) {
            
            if (false !== triggerChangedEvent) {
                me.onChange(checked, originalValue);
            }

            me.originalValue = checked;
        }



        if (false !== triggerChangedEvent) {
            me.trigger('changed', {
                value: checked
            });
        }


        return me;
    },

    getValue: function () {
        return this.checked;
    },


    onChange: function (newVal, oldVal) {
        "use strict";

        var me = this;

        if (Mini2.isFunction(me.change)) {
            me.change.call(me, newVal, oldVal);
        }

        $(me).triggerHandler('change', [newVal, oldVal]);

    },


    renderForLableable: function (tableEl) {
        "use strict";
        var me = this,
            labelable = me.labelable,
            labelEl;

        if (labelable && !labelable.hideLabel) {
            labelEl = labelable.getEl();

            if (me.clientId) {
                labelEl.attr("for", me.clientId);
            }

            labelEl.muBind('mousedown', function (e) { me.focus(); });
            //labelEl.muBind('mouseup', function (e) {

            //    me.setValue(!me.checked);
            //    Mini2.EventManager.stopEvent(e);
            //});


            me.appendCell(tableEl, labelEl, 'td.mi-field-label-cell:first');

            if (me.checked) {
                tableEl.addClass('mi-form-cb-checked');
            }
        }
    },


    renderForBoxLabel: function (tableEl) {
        "use strict";
        var me = this,
            boxLabel = me.boxLabel;

        if (boxLabel) {
            var boxLabelEl = Mini2.$joinStr([
                '<label class="mi-form-cb-label mi-form-cb-label-after" " >',
                    boxLabel,
                '</label>'
            ]);

            boxLabelEl.attr('for', me.clientId);

            boxLabelEl.muBind('mousedown', function (e) { me.focus(); });
            boxLabelEl.muBind('mouseup', function (e) {

                me.setValue(!me.checked);
                Mini2.EventManager.stopEvent(e);
            });

            me.boxLableEl = boxLabelEl;

            me.appendCell(tableEl, boxLabelEl, 'td.mi-form-item-body:first');
        }

    },

    /**
    * 初始化原控件
    **/
    initSrcInput: function () {
        "use strict";
        var me = this,
            srcInputEl;

        me.srcInputEl = srcInputEl = Mini2.$join(['<input type="checkbox" style="display:none;" />']);
        srcInputEl.attr('name', me.name)
            .attr('value', me.inputValue);

        if (me.checked) {
            srcInputEl.prop('checked', true);
        }
    },


    //扩展
    getBodyExpand:function(){
        var me = this,
            textEl,
            trueText = me.trueText,
            falseText = me.falseText;

        if (trueText || falseText) {

            textEl = $('<label style="white-space: nowrap;margin-top: 4px;margin-left: 4px;position: absolute; "></label>');

            textEl.attr('for', me.clientId);

            textEl.muBind('mousedown', function (e) { me.focus(); });
            textEl.muBind('mouseup', function (e) {

                me.setValue(!me.checked);
                Mini2.EventManager.stopEvent(e);
            });

            me.textEl = textEl;

            return textEl;
        }


    },

    getFieldEl: function () {
        "use strict";

        var me = this,
            inputEl, srcInputEl,
            checkedCls = me.checkedCls;

        me.initSrcInput();

        me.inputEl = inputEl = Mini2.$joinStr(['<input type="button" class="mi-form-field mi-form-checkbox mi-form-cb " ',
            'autocomplete="off" ',
            'hidefocus="true" ',
            'aria-invalid="false" ',
            'data-errorqtip="" style="" >']);


        inputEl.attr("id", me.clientId);



        $(inputEl).muBind('mousedown', function (e) {

            me.focus();

            Mini2.EventManager.stopEvent(e);

        }).muBind('mouseup', function (e) {

            var isChecked = me.checked; // me.el.hasClass(me.checkedCls);

            me.setValue(!isChecked);

            Mini2.EventManager.stopEvent(e);
        });




        //var tip = [
        //    '<div class="switch has-switch">',
        //        '<div class="switch-on switch-animate">',
        //            '<input type="checkbox" checked="">',
        //            '<span class="switch-left switch-small">是</span>',
        //            '<label class="switch-small">&nbsp;</label>',
        //            '<span class="switch-right switch-small">否</span>',
        //        '</div>',
        //    '</div>'];


        //me.inputEl = inputEl = Mini2.$joinStr(tip);


        //$(inputEl).muBind('mousedown', function (e) {

        //    me.focus();

        //    Mini2.EventManager.stopEvent(e);

        //}).muBind('mouseup', function (e) {

        //    var isChecked = me.checked; // me.el.hasClass(me.checkedCls);

        //    isChecked = !isChecked;

        //    me.setValue(isChecked);
            
        //    Mini2.EventManager.stopEvent(e);
        //});

        return inputEl;
    }


});



/************************************************************************/
/*                                           */
/*    ui/form/field/TextButton.js                                          */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />

//带按钮的文本框
Mini2.define('Mini2.ui.form.field.TextButton', {



    extend: 'Mini2.ui.form.field.Trigger',
    

    alias: 'widget.textbutton',

    //引发事件
    onButtonClick: function () {
        var me = this;

        var win = Mini2.createTop('Mini2.ui.Window', {
            mode: true,
            text: '文本框',
            buttons: [{
                text: '确定',
                width: 100
            }, {
                text: '取消',
                width: 100,
                click: Mini2.emptyFn
            }]
        });

        win.show();

    }

});


/************************************************************************/
/*                                           */
/*    ui/form/field/TextArea.js                                            */
/*                                           */
/************************************************************************/



Mini2.define('Mini2.ui.form.field.TextArea', {

    extend: 'Mini2.ui.form.field.Text',

    alias: 'widget.textarea',

    cols: 20,

    rows: 4,

    //获取或设置一个值，该值指示用户能否使用 Tab 键将焦点放到该控件上。
    tabStop: false,

    bindInputEl_Key: function (inputEl) {

        var me = this;

        $(inputEl)
        .on('keydown', function (e) {

            if (13 == e.keyCode) {
                me.insertText(this, "\n");

                Mini2.EventManager.stopEvent(e);

                return;
            }

            me.on('keydown', e);
        })
        .on('keyup', function (e) {

            me.on('keyup', e);

            //Mini2.EventManager.stopEvent(e);
        })
        .on('keypress', function (e) {

            me.on('keypress', e);
            //Mini2.EventManager.stopEvent(e);
        });
    },



    setValue: function (value) {
        var me = this,
            hideEl = me.hideEl,
            inputEl = me.inputEl;

        inputEl.val(value);

        if (hideEl) {
            hideEl.val(value);
        }

        return me;
    },

    getValue: function () {
        var me = this,
            hideEl = me.hideEl,
            inputEl = me.inputEl,
            value;

        if (me.readOnly && hideEl) {
            value = hideEl.val();
        }
        else {
            value = inputEl.val();
        }
        
        return value;
    },

    getFieldEl: function () {

        var me = this,
            inputEl;

        me.inputEl = inputEl = Mini2.$joinStr([
            '<textarea class="mi-form-field mi-form-text mi-form-textarea" ',
                'aria-invalid="false" style="width: 100%;resize: none; " ',
                'spellcheck="false" autocapitalize="off" autocomplete="off" autocorrect="off">',
            '</textarea>']);


        if (me.name) {
            inputEl.attr('name', me.name);
        }

        inputEl.attr("id", me.clientId)
            .attr('placeholder', me.placeholder)
            .attr('autocomplete', me.autoComplete)
            .attr('cols', me.cols)
            .attr('rows', me.rows);

        inputEl.css({
            'text-align': me.align,
            'height': me.height
        });


        if (me.readOnly) {
            inputEl.attr('readonly', 'readonly');
        }

        //附加属性
        //me.inputEl.attr("data-errorqtip", "");
        //

        //inputEl.addClass("mi-form-required-field");

        me.bindInputEl_Mouse(inputEl);
        me.bindInputEl_Key(inputEl);


        

        return inputEl;

    }

});


/************************************************************************/
/*                                           */
/*    ui/form/field/ComboBox.js                                            */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />


Mini2.define('Mini2.ui.form.field.ComboBox', {

    extend: 'Mini2.ui.form.field.Trigger',

    alias: 'widget.combobox',

    log: Mini2.Logger.getLogger('Mini2.ui.form.field.ComboBox', console),

    //绑定显示的字段名
    displayField: 'text',

    //绑定显示的字段名
    itemDisplayField: 'textEx',


    //绑定值的字段名
    valueField: 'value',

    //复选框模式: single=单选, multi=多选
    checkedMode: 'single',

    //
    //mode: 'user-input'

    /**
     * 空项目激活
     */
    emptyEnabled: true,

    /**
     * 空项目的值
     */
    emptyValue: '',

    /**
     * 空项目显示的内容
     */
    emptyText: '',

    /**
    * 创建关闭项目
    */
    createCloseItemEl: function (store) {
        var me = this,
            record = {},
            emptyValue = me.emptyValue,
            itemEl = Mini2.$join(me.itemTpl);


        record[me.valueField] = me.emptyValue;
        record[me.displayField] = '';
        record[me.itemDisplayField] = '[ X ]';// me.emptyText;

        record = store.createModel(record);

        itemEl.addClass("mi-boundlist-empty").html('[ X ]').data('record', record);

        return itemEl;
    },



    //初始化组件
    initComponent: function () {

        "use strict";
        var me = this,
            log = me.log;


        $(me).muBind('focusout', function () {

            if (me._focusTimeout) {
                clearTimeout(me._focusTimeout);
                delete me._focusTimeout;
            }

            //log.debug("失去焦点啦。。。");


            me.fieldEl.removeClass("mi-form-focus");
            me.el.removeClass("mi-form-trigger-wrap-focus");

            me.hideDropDownPanel();
        });

        me.initStore();

        me.initLabelable();

    },

    //获取下拉条目显示的内容
    getItemDisplayText: function (record) {
        "use strict";
        var me = this,
            text ;

        text = record.get(me.itemDisplayField);

        if (Mini2.isBlank(text)) {
            text = record.get(me.displayField);
        }

        return text;
    },


    add: function (item) {


    },


    getBoundPanel: function () {
        "use strict";
        var me = this,
            i,
            divEl,
            newItemEl,
            itemEls,
            text,
            store = me.store,
            records = store.data,
            record,
            itemCount = store.getCount(),
            cfg = Mini2.SystemInfo.list,
            itemHeight = cfg.itemHeight || 24;

        divEl = Mini2.$join([
            '<div class="mi-boundlist-list-ct mi-unselectable" style="overflow: auto; height: 100px; font-size:12px; ">',
                '<ul class="mi-list-plain"></ul>',
            '</div>'
        ]);



        var plainEl = divEl.children(".mi-list-plain");

        me.boundListEl = divEl;     //容器
        me.listPlainEl = plainEl;   //小容器


        if (me.checkedMode == 'multi') {

            var itemEl = Mini2.$joinStr([
                '<li role="option" unselectable="on" class="mi-boundlist-item">',
                    '<img class="mi-form-checkbox" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" style="">',
                '</li>']);

            records = store.data;

            var values = me.value || '';

            var valueList = values.split(',');

            for (var i = 0; i < valueList.length; i++) {
                valueList[i] = Mini2.String.trim(valueList[i]);
            }

            for (i = 0; i < records.getCount() ; i++) {

                record = records.get(i);

                newItemEl = itemEl.clone(); //克隆一个对象出来

                text = me.getItemDisplayText(record);

                newItemEl.append(text);


                newItemEl.data('record', record);

                if (Mini2.Array.contains(valueList, text, true)) {
                    newItemEl.addClass('mi-boundlist-item-selected');
                }

                $(plainEl).append(newItemEl);

            };

            itemEls = plainEl.children();
            me.bindItems_ForMulti(itemEls);
        }
        else {

            var itemEl = $('<li role="option" unselectable="on" class="mi-boundlist-item"></li>');

            records = store.data;

            for (i = 0; i < records.getCount() ; i++) {

                record = records.get(i);

                newItemEl = itemEl.clone();

                text = me.getItemDisplayText(record);

                newItemEl.html(text);


                newItemEl.data('record', record);

                $(plainEl).append(newItemEl);

            };


            itemEls = plainEl.children();

            me.bindItems(itemEls);  //绑定每个项目 单选事件
        }


        itemCount = (itemCount > 8 ? 8 : itemCount);

        divEl.css('height', itemHeight * itemCount);

        return divEl;
    },


    //获取多选的值
    getMultiValues: function (listPlainEl) {
        "use strict";
        var me = this;

        var checkedItemEls = $(listPlainEl).children('.mi-boundlist-item-selected');

        var values = '';

        var j = 0;

        $(checkedItemEls).each(function () {

            var record = $(this).data("record");

            var value = record.get(me.valueField);
            var text = record.get(me.displayField);

            if (j++ > 0) { values += ','; }

            values += value;

        })

        return values;

    },

    //多选模式的事件...暂时只支持字符串
    bindItems_ForMulti: function (itemEls) {
        "use strict";
        var me = this;

        $(itemEls).on('mouseenter', function () {
            $(this).addClass("mi-boundlist-item-over");
        }).on('mouseleave', function () {
            $(this).removeClass("mi-boundlist-item-over");
        }).on('mouseup', function (e) {

            $(this).toggleClass('mi-boundlist-item-selected');

            var values = me.getMultiValues($(this).parent());

            if ('none' == me.mode) {
                me.hideEl.val(values);
                me.inputEl.val(values);
            }
            else {
                me.inputEl.val(values);
            }

            me.value = values;
            me.text = values;


            //me.hideDropDownPanel();

            me.clearInvalid();  //清理异常信息

            me.focus();


            if (me.changed) {
                me.changed.call(me);
            }

            me.trigger('changed', { value: value, text: text });

            me.trigger('changed_callback', { values: values });

        });


    },

    bindItems: function (itemEls) {
        "use strict";
        var me = this;

        $(itemEls).on('mouseenter', function () {
            $(this).addClass("mi-boundlist-item-over");
        }).on('mouseleave', function () {
            $(this).removeClass("mi-boundlist-item-over");
        })
        .on('mouseup', function (e) {
            var record = $(this).data("record");

            var value = record.get(me.valueField);
            var text = record.get(me.displayField);

            //me.log.debug($.format('value={0} ,text={1}', value,text));
            //me.log.debug('me.mode = ', me.mode);

            if ('none' == me.mode) {
                me.hideEl.val(value);
                me.inputEl.val(text);
            }
            else {
                me.inputEl.val(value);
            }


            me.curRecord = record;

            me.value = value;
            me.text = text;


            me.hideDropDownPanel();

            me.clearInvalid();  //清理异常信息

            me.focus();


            if (me.changed) {
                me.changed.call(me);
            }

            me.trigger('changed', { value: value, text: text });

            me.trigger('changed_callback', { value: value, text: text });


            Mini2.EventManager.stopPropagation(e);
        });

    },


    setValue: function (value) {
        "use strict";
        var me = this,
            log = me.log,
            record,
            hideEl = me.hideEl,
            store = me.store,
            text,
            inputEl = me.inputEl,
            valueField = me.valueField,
            displayField = me.displayField;

        me.value = value;


        if ('none' == me.mode && store) {


            try {

                var tmpValue;


                if (true === value) {
                    tmpValue = "true";
                }
                else if (false === value) {
                    tmpValue = "false";
                }
                else {
                    tmpValue = value;
                }


                record = store.filterFirstBy(valueField, tmpValue);

                //if (me.fieldLabel == '是否会签') {
                //    log.debug(me.fieldLabel + '  setValue = ', tmpValue);
                //    log.debug(typeof value);
                //    log.debug("record ", record);

                //    console.trace();
                //}


                if (record) {
                    me.curRecord = record;
                    text = record.get(displayField);

                    me.text = text;

                    inputEl.val(text);
                }
                else {
                    me.text = '';
                    inputEl.val('');
                }
            }
            catch (ex) {
                log.error("ComboBox.setValue(...) 赋值错误啦。", ex);
            }

        }
        else {

            record = store.filterFirstBy(valueField, value);

            me.curRecord = record;

            if (record) {
                me.text = record.get(me.displayField);
            }
            else {
                me.text = '';
            }

            inputEl.val(value);

        }

        if (hideEl) {
            hideEl.val(value);
        }
    },

    getValue: function () {
        "use strict";
        var me = this,
            log = me.log,
            record,
            valueField = me.valueField,
            hideEl = me.hideEl,
            value;




        if (me.readOnly || 'none' == me.mode) {
            value = hideEl.val();
        }
        else {
            value = me.inputEl.val();
        }


        record = me.store.filterFirstBy(valueField, value);

        me.curRecord = record;

        if (record) {
            me.text = record.get(me.displayField);
        }
        else {
            me.text = '';
        }


        //log.debug('getValue() return ' + value);

        me.value = value;

        return value;
    },



    /**
    * 获取要发送的数据
    */
    getSentData: function () {
        var me = this,
            sentData = {},
            ps = me.remoteParams;

        if (ps && ps.length) {

            $(ps).each(function () {

                var p = this;

                if ('query_string' == p.role) {
                    var qValue = $.query.get(p.queryStringField);

                    sentData[p.name] = qValue;
                }
                else if ('control' == p.role) {

                    var con = Mini2.find(p.control);

                    var value = con.getValue();

                    sentData[p.name] = value;

                }
                else {

                    var pDef = p['default'];

                    //发现有这个 {{ }} , 进行编译
                    if (pDef.indexOf('{{') >= 0 && pDef.indexOf('}}')) {

                        var artTemp = template.compile(pDef);
                        var valueStr = artTemp({
                            T: { '未定义': '' }
                        });

                        sentData[p.name] = valueStr;
                    }
                    else {
                        sentData[p.name] = pDef;
                    }

                }

            });

        }

        return sentData;
    },



    showDropDownPanel: function () {
        "use strict";
        /// <summary>显示下拉框</summary>

        var me = this,
            el = me.el;

        me.init_DropDwonPanel();
        

        // 激活 "获取远程数据"
        if (me.remoteEnabled) {

            var sentData = me.getSentData();

            Mini2.post(me.remoteUrl, sentData, function (data) {

                var store = me.store;

                store.removeAll();

                store.add(data);

                me.refresh();

            });

        }


        if (me.dropDown) {
            try {
                me.dropDown.call(me, me);
            }
            catch (ex) {
                throw new Error("执行 Trigger.dropDown(...) 事件发生错误." + ex.Message);
            }
        }


        me.proDropDownPanel_SizeALocal();

        return me;
    },


    itemTpl: ['<li role="option" unselectable="on" class="mi-boundlist-item"></li>'],



    /**
    * 创建关闭项目
    */
    createCloseItemEl: function (store) {
        var me = this,
            record = {},
            emptyValue = me.emptyValue,
            itemEl = Mini2.$join(me.itemTpl);


        record[me.valueField] = me.emptyValue;
        record[me.displayField] = '';
        record[me.itemDisplayField] = '[ X ]';// me.emptyText;

        record = store.createModel(record);

        itemEl.addClass("mi-boundlist-empty").html('[ X ]').data('record', record);

        return itemEl;
    },



    //刷新
    refresh: function () {
        "use strict";
        var me = this,
            i,
            divEl,
            itemTpl = me.itemTpl,
            newItemEl,
            itemEls,
            text,
            store = me.store,
            records = store.data,
            record,
            itemCount = store.getCount(),
            cfg = Mini2.SystemInfo.list,
            itemHeight = cfg.itemHeight || 24;

        var listPlainEl = me.listPlainEl;

        listPlainEl.html('');

        if (me.emptyEnabled) {

            var emptyItemEl = me.createCloseItemEl(store);

            $(listPlainEl).append(emptyItemEl);
        }

        records = store.data;

        for (i = 0; i < records.getCount() ; i++) {

            record = records.get(i);

            text = me.getItemDisplayText(record);

            if (Mini2.isBlank(text)) { text = '&nbsp;'; }

            newItemEl = Mini2.$join(itemTpl);
            newItemEl.html(text);


            newItemEl.data('record', record);

            $(listPlainEl).append(newItemEl);

        };


        itemEls = listPlainEl.children();
        me.bindItems(itemEls);

        itemCount = (itemCount > 8 ? 8 : itemCount);


        me.boundListEl.css('height', itemHeight * itemCount);


        me.proDropDownPanel_SizeALocal();

    },

    getStrLength: function (str) {
        var cArr = str.match(/[^\x00-\xff]/ig);
        return str.length + (cArr == null ? 0 : cArr.length);
    },

    //处理下拉框的形状和位置
    proDropDownPanel_SizeALocal: function () {
        "use strict";

        var me = this,
            el = me.el,
            fieldEl = me.fieldEl,
            panel = me.dropDownPanel,
            office,
            width,
            itemCount,
            winH = $(window).height(),
            buttomY,
            panelTop,
            fieldElWidth,
            targetHeight,
            cfg = Mini2.SystemInfo.list,
            itemHeight = cfg.itemHeight || 24;


        office = fieldEl.offset();

        fieldElWidth = fieldEl.outerWidth();
        width = me.dropDownWidth || fieldElWidth;

        if (width < fieldElWidth) {
            width = fieldElWidth;
        }
        
        itemCount = me.store.getCount();

        if (itemCount > 8) {
            itemCount = 8;
        }

        targetHeight = itemHeight * itemCount;

        buttomY = (office.top + fieldEl.height() + 2) + targetHeight;

        if (buttomY > winH) {
            panelTop = office.top - targetHeight;
        }
        else {
            panelTop = office.top + fieldEl.height() + 1;
        }


        panel.css({
            'border-width': 1,
            'width': width,
            'height': targetHeight,
            'left': office.left,
            'top': panelTop
        }).show();


        return me;

    }

});


/************************************************************************/
/*                                           */
/*    ui/form/field/ComboBoxBase.js                                        */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />
/// <reference path="../../../Mini.js" />


Mini2.define('Mini2.ui.form.field.ComboBoxBase', {

    extend: 'Mini2.ui.form.field.Trigger',

    alias: 'widget.comboboxbase',


    log: Mini2.Logger.getLogger('Mini2.ui.form.field.ComboBoxBase', true),

    //绑定显示的字段名
    displayField: 'text',

    //绑定显示的字段名
    itemDisplayField: 'textEx',


    //绑定值的字段名
    valueField: 'value',

    //当前选中的记录
    curRecord: null,


    //复选框模式: single=单选, multi=多选
    checkedMode: 'single',

    itemHeight : 24,

    // private
    // 字符最大长度.
    //maxItemTextLen:0,

    /**
    * 激活远程数据模式
    */
    remoteEnabled: false,

    /**
    * 远程地址
    */
    remoteUrl: null,

    /**
    * 获取远程数据,提交的 post 数据
    */
    remoteParams: null,

    /**
     * 空项目激活
     */
    emptyEnabled: true,

    /**
     * 空项目的值
     */
    emptyValue: '',

    /**
     * 空项目显示的内容
     */
    emptyText: '',

    emptyItemEl:null,
    emptyItemHeight :0,


    //初始化组件
    initComponent: function () {
        "use strict";
        var me = this;


        $(me).muBind('focusout', function () {


            if (me._focusTimeout) {
                clearTimeout(me._focusTimeout);
                delete me._focusTimeout;
            }



            me.fieldEl.removeClass("mi-form-focus");
            me.el.removeClass("mi-form-trigger-wrap-focus");

            me.hideDropDownPanel();
        });

        me.initStore();

        me.initLabelable();

        me.curRecordEl = Mini2.$join(['<input type="hidden" name="', me.clientId , '_curRecord" />']);

    },

    //获取下拉条目显示的内容
    getItemDisplayText: function (record) {
        "use strict";
        var me = this,
            text;

        text = record.get(me.itemDisplayField);

        if (undefined == text || '' == text) {
            text = record.get(me.displayField);
        }

        return text;
    },





    getBoundPanel: function () {
        "use strict";
        var me = this,
            sysInfo = Mini2.SystemInfo,
            i,
            divEl,
            newItemEl,
            itemEls,
            text,
            store = me.store,
            records = store.data,
            len,
            record,
            itemCount = store.getCount(),
            cfg = Mini2.SystemInfo.list,
            itemHeight = cfg.itemHeight || me.itemHeight;

        divEl = Mini2.$joinStr([
            '<div class="mi-boundlist-list-ct mi-unselectable" style="overflow: auto; height: 100px; font-size:12px; ">',
                '<ul class="mi-list-plain"></ul>',
            '</div>'
        ]);



        var plainEl = divEl.children(".mi-list-plain");

        me.boundListEl = divEl;     //容器
        me.listPlainEl = plainEl;   //小容器

        records = store.data;

        if ('multi' == me.checkedMode) {

            var itemEl = Mini2.$joinStr([
                '<li role="option" unselectable="on" class="mi-boundlist-item">',
                    '<img class="mi-form-checkbox" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" style="">',
                '</li>']);

            records = store.data;

            var values = me.value || '';

            var valueList = values.split(',');

            for (i = 0, len = valueList.length ; i < len; i++) {
                valueList[i] = Mini2.String.trim(valueList[i]);
            }

            for (i = 0, len = records.getCount() ; i < len ; i++) {

                record = records.get(i);

                newItemEl = itemEl.clone(); //克隆一个对象出来

                text = me.getItemDisplayText(record);

                newItemEl.append(text + '&nbsp;');


                newItemEl.data('record', record);

                if (Mini2.Array.contains(valueList, text, true)) {
                    newItemEl.addClass('mi-boundlist-item-selected');
                }

                $(plainEl).append(newItemEl);

            };

            itemEls = plainEl.children();
            me.bindItems_ForMulti(itemEls);
        }
        else {
            var itemEl = $('<li role="option" unselectable="on" class="mi-boundlist-item"></li>');

            var text2,
                len2,
                maxTextLen = 0;

            for (i = 0, len = records.getCount() ; i < len ; i++) {

                record = records.get(i);

                newItemEl = itemEl.clone();

                text = me.getItemDisplayText(record);

                newItemEl.html(text + '&nbsp;');

                text2 = newItemEl.text();
                len2 = me.getStrLength(text2);

                maxTextLen = Math.max(maxTextLen, len2);


                newItemEl.data('record', record);

                $(plainEl).append(newItemEl);

            };

            me.maxItemTextLen = maxTextLen * sysInfo.font.chatWidth + 16;   //36 = 2*8边距 + 20滚动条


            itemEls = plainEl.children();
            me.bindItems(itemEls);
        }

        itemCount = (itemCount > 8 ? 8 : itemCount);



        divEl.css({
            height: itemHeight * itemCount
        });


        

        return divEl;
    },


    itemTpl: ['<li role="option" unselectable="on" class="mi-boundlist-item"></li>'],



    /**
    * 创建关闭项目
    */
    createCloseItemEl:function(store){
        var me = this,
            record = {},
            emptyValue = me.emptyValue,
            itemEl = Mini2.$join(me.itemTpl);


        record[me.valueField] = me.emptyValue;
        record[me.displayField] = '';
        record[me.itemDisplayField] = '[ X ]';// me.emptyText;

        record = store.createModel(record);

        itemEl.addClass("mi-boundlist-empty").html('[ X ]').data('record', record);

        return itemEl;
    },


    //刷新
    refresh: function () {
        "use strict";
        var me = this,
            sysInfo = Mini2.SystemInfo,
            i,
            divEl,
            itemTpl = me.itemTpl,
            emptyItemEl,
            emptyItemHeight =0,
            newItemEl,
            itemEls,
            text,
            store = me.store,
            records = store.data,
            record,
            itemCount = store.getCount(),
            listPlainEl = me.listPlainEl,
            len,
            text2, len2, maxTextLen = 0,
            cfg = Mini2.SystemInfo.list,
            itemHeight = cfg.itemHeight || me.itemHeight;

        
        listPlainEl.html('');


        if (me.emptyEnabled) {
            
            me.emptyItemEl = emptyItemEl = me.createCloseItemEl(store);

            $(listPlainEl).append(emptyItemEl);

            me.emptyItemHeight = emptyItemHeight = $(emptyItemEl).outerHeight() + 2;

        }

        records = store.data;

        for (i = 0, len = records.getCount() ; i < len; i++) {

            record = records.get(i);

            newItemEl = Mini2.$join(itemTpl);
            
            text = me.getItemDisplayText(record);

            if (Mini2.isBlank(text)) { text = '&nbsp;'; }

            newItemEl.html(text);

            text2 = newItemEl.text();
            len2 = me.getStrLength(text2);

            maxTextLen = Math.max(maxTextLen, len2);

            newItemEl.data('record', record);

            $(listPlainEl).append(newItemEl);

        };

        me.maxItemTextLen = maxTextLen * sysInfo.font.chatWidth + 16;   //36 = 2*8边距 + 20滚动条

        itemEls = listPlainEl.children();
        me.bindItems(itemEls);

        itemCount = (itemCount > 8 ? 8 : itemCount);

        me.boundListEl.css({
            height: itemHeight * itemCount + emptyItemHeight
        });


        me.proDropDownPanel_SizeALocal();

    },

    getStrLength: function (str) {
        "use strict";
        var cArr = str.match(/[^\x00-\xff]/ig);
        return str.length + (cArr == null ? 0 : cArr.length);
    },


    //获取多选的值
    getMultiValues: function (listPlainEl) {
        "use strict";
        var me = this;
            
        var checkedItemEls = $(listPlainEl).children('.mi-boundlist-item-selected');

        var values = '';

        var j = 0;

        $(checkedItemEls).each(function () {

            var record = $(this).data("record");

            var value = record.get(me.valueField);
            var text = record.get(me.displayField);

            if (j++ > 0) { values += ',';}

            values += value;

        })
        
        return values;

    },


    bindItems_ForMulti: function (itemEls) {
        "use strict";
        var me = this;

        $(itemEls).mouseenter(function () {
            $(this).addClass("mi-boundlist-item-over");
        }).mouseleave(function () {
            $(this).removeClass("mi-boundlist-item-over");
        })
        .mouseup(function (e) {

            $(this).toggleClass('mi-boundlist-item-selected');

            var values = me.getMultiValues($(this).parent());
            
            if ('none' == me.mode) {
                me.hideEl.val(values);
                me.inputEl.val(values);
            }
            else {
                me.inputEl.val(values);
            }

            me.value = values;
            me.text = values;


            //me.hideDropDownPanel();

            me.clearInvalid();  //清理异常信息

            me.focus();


            if (me.changed) {
                me.changed.call(me);
            }

            me.trigger('changed_callback', { value: value, text: text });

        });


    },


    //选中的项目到值
    selectItemToValue: function (item) {
        "use strict";
        var me = this,
            value, text,
            record = $(item).data("record");

        if (record.isModel) {
            value = record.get(me.valueField);
            text = record.get(me.displayField);
        }
        else {
            value = record[me.valueField];
            text = record[me.displayField];
        }


        if ('none' == me.mode) {
            me.hideEl.val(value);
            me.inputEl.val(text);
        }
        else {
            me.inputEl.val(value);
        }

        me.curRecord = record;

        var jsonObj = me.store.getJsonForRecord(record);
        var jsonStr = Mini2.Json.toJson(jsonObj);

        me.curRecordEl.val(jsonStr);

        me.value = value;
        me.text = text;


        try{
            me.setMap(record);
        }
        catch (ex) {
            console.error('设置映射值错误', ex);
        }

        me.hideDropDownPanel();

        me.clearInvalid();  //清理异常信息

        me.focus();


        if (me.changed) {
            me.changed.call(me);
        }

        me.trigger('changed_callback', { value: value, text: text });

    },


    /**
     * 映射值
     */
    setMap:function(record){

        var me = this,
            mapItems = me.mapItems,
            ownerParent = me.ownerParent,
            store ;

        //没有映射就取消
        if (!mapItems) {
            return;
        }

        if (!ownerParent) {
            return;
        }

        store = ownerParent.store;

        if (!store) {
            return;
        }


        var curRect = store.getCurrent();

        for (var i = 0; i < mapItems.length; i++) {
            var mapItem = mapItems[i];
            
            if (mapItem && mapItem.srcField && mapItem.targetField) {

                var value = record.get(mapItem.srcField);

                curRect.set(mapItem.targetField, value);
            }
        }
    },

    bindItems: function (itemEls) {
        "use strict";
        var me = this;

        $(itemEls).mouseenter(function () {
            $(this).addClass("mi-boundlist-item-over");
        })
        .mouseleave( function () {
            $(this).removeClass("mi-boundlist-item-over");
        });


        $(itemEls).muBind('mousedown', function (e) {

        })
        .muBind('mouseup',function (e) {
            
            me.selectItemToValue.call(me,this);
        });


    },


    setValue: function (value) {
        "use strict";
        var me = this,
            record,
            valueField = me.valueField,
            displayField = me.displayField,
            hideEl = me.hideEl,
            store = me.store,
            text,
            inputEl = me.inputEl;

        me.value = value;

        //log.debug("setValue() = " + value);

        if ('none' == me.mode && store) {

            try {

                record = store.filterFirstBy(valueField, value);

                if (record) {

                    me.curRecord = record;

                    var jsonObj = store.getJsonForRecord(record);
                    var jsonStr = Mini2.Json.toJson(jsonObj);

                    me.curRecordEl.val(jsonStr);

                    text = record.get(displayField);

                    inputEl.val(text);
                }
                else {
                    inputEl.val(value);
                }
            }
            catch (ex) {
                alert("错误啦。" + ex.Message);
            }

        }
        else {
            inputEl.val(value);
        }

        if (hideEl) {
            hideEl.val(value);
        }
    },

    getValue: function () {
        "use strict";
        var me = this,
            log = me.log,
            hideEl = me.hideEl,
            value;


        if (me.readOnly || 'none' == me.mode) {
            value = hideEl.val();
        }
        else {
            value = me.inputEl.val();
        }

        log.debug('getValue() return ' + value);

        me.value = value;

        return value;
    },


    //处理下拉框的形状和位置
    proDropDownPanel_SizeALocal: function () {
        "use strict";

        var me = this,
            el = me.el,
            fieldEl = me.fieldEl,
            panel,
            office,
            width,
            itemCount,
            winH = $(window).height(),
            buttomY,
            panelTop,
            fieldElWidth,
            targetHeight,
            cfg = Mini2.SystemInfo.list,
            itemHeight = cfg.itemHeight || me.itemHeight;

        panel = me.dropDownPanel;

        office = fieldEl.offset();

        fieldElWidth = fieldEl.outerWidth() + 2;
        width = me.dropDownWidth || me.maxItemTextLen || fieldElWidth;

        width = Math.max(width, fieldElWidth);

        itemCount = me.store.getCount();
        
        if (itemCount > 8) {
            itemCount = 8;
            width += 20;    //出现滚动条..加上20像素
        }

        targetHeight = itemHeight * itemCount + me.emptyItemHeight;

        buttomY = (office.top + fieldEl.height() - 2) + targetHeight;

        if (buttomY > winH) {
            panelTop = office.top - targetHeight;
        }
        else {
            panelTop = office.top + fieldEl.height() + 1;
        }


        panel.css({
            'border-width': 1,
            'width': width,
            'height': targetHeight,
            'left': office.left,
            'top': panelTop
        }).show();


        return me;

    },



    //光标是否在开始位置
    isFirstCursorPos: function () {
        return true;
    },

    //光标是否在尾部
    isLastCursorPos: function () {
        return true;
    },


    proKeyEvent: function (e) {
        "use strict";
        var me = this,
            dropDownPanel = me.dropDownPanel,
            listPlainEl = $(me.listPlainEl),
            keyCode = e.keyCode,
            cls = 'mi-boundlist';

        if (Mini2.onwerPage.typeahead.length) {
            /* 如果出现自动补充提示框, 就忽略按键 */
            return;
        }



        if (40 == keyCode) {        //上

            if (!dropDownPanel || dropDownPanel.is(":hidden")) {

                me.beforeShowDropDownPanel();
                me.showDropDownPanel();
            }


            var sItem = $(listPlainEl).children(".mi-boundlist-selected");

            sItem.removeClass('mi-boundlist-selected');

            if (sItem.length == 0) {
                sItem = listPlainEl.children(".mi-boundlist-item:first");
            }
            else {
                sItem = sItem.next(".mi-boundlist-item");
            }

            sItem.addClass('mi-boundlist-selected');

            Mini2.EventManager.stopEvent(e);
            e.stoped = true;
            
        }
        else if (38 == keyCode) {   //下
            

            if (!dropDownPanel || dropDownPanel.is(":hidden")) {

                me.beforeShowDropDownPanel();
                me.showDropDownPanel();
            }


            var sItem = $(listPlainEl).children(".mi-boundlist-selected");

            sItem.removeClass('mi-boundlist-selected');

            if (sItem.length == 0) {
                sItem = listPlainEl.children(".mi-boundlist-item:last");
            }
            else {
                sItem = sItem.prev(".mi-boundlist-item");
            }

            sItem.addClass('mi-boundlist-selected');


            Mini2.EventManager.stopEvent(e);
            e.stoped = true;
        }
        else if (13 == keyCode) {   //回车

            if (!dropDownPanel || dropDownPanel.is(":hidden")) {
                return;
            }

            var sItem = $(listPlainEl).children(".mi-boundlist-selected");


            me.selectItemToValue.call(me, sItem);


            Mini2.EventManager.stopEvent(e);
            e.stoped = true;
        }
    },


    /**
    * 获取要发送的数据
    */
    getSentData:function(){
        var me = this,
            sentData = {},
            ps = me.remoteParams;
        
        if (ps && ps.length) {
            
            $(ps).each(function () {

                var p = this;

                if ('query_string' == p.role) {
                    var qValue = $.query.get(p.queryStringField);

                    sentData[p.name] = qValue;
                }
                else if ('control' == p.role) {

                    var con = Mini2.find(p.control);

                    var value = con.getValue();

                    sentData[p.name] = value;

                }
                else {

                    var pDef = p['default'];

                    if (pDef.indexOf('{{') >= 0 && pDef.indexOf('}}')) {

                        var artTemp = template.compile(pDef);
                        var valueStr = artTemp({
                            T: {'未定义':''}
                        });

                        sentData[p.name] = valueStr;
                    }
                    else {
                        sentData[p.name] = pDef;
                    }

                }

            });

        }

        return sentData;
    },


    showDropDownPanel: function () {
        "use strict";
        /// <summary>显示下拉框</summary>

        var me = this,
            el = me.el,
            fieldEl = me.fieldEl,
            panel,
            office,
            width,
            itemCount,
            winH = $(window).height(),
            buttomY,
            panelTop,
            fieldElWidth,
            targetHeight;

        me.init_DropDwonPanel();

        panel = me.dropDownPanel;

        // 激活 "获取远程数据"
        if (me.remoteEnabled) {

            var sentData = me.getSentData();
            
            Mini2.post(me.remoteUrl, sentData, function (data) {

                var store = me.store;

                store.removeAll();

                store.add(data);

                me.refresh();

            });
        }


        if (me.dropDown) {
            try {
                me.dropDown.call(me, me);
            }
            catch (ex) {
                throw new Error("执行 Trigger.dropDown(...) 事件发生错误");
            }
        }

        me.proDropDownPanel_SizeALocal();

        return me;
    },

    render: function () {
        "use strict";
        var me = this,
            bodyCls = 'td.mi-form-item-body:first';

        me.baseRender();


        me.appendCell(me.el, me.curRecordEl, bodyCls);



        me.el.data('me', me);
    }


});


/************************************************************************/
/*                                           */
/*    ui/form/field/ComboGrid.js                                           */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />


Mini2.define('Mini2.ui.form.field.ComboGrid', {

    extend: 'Mini2.ui.form.field.Trigger',
    
    
    alias: 'widget.combogrid',

    log: Mini2.Logger.getLogger('Mini2.ui.form.field.ComboGrid', true),

    dropDownPanel :null,

    //表格对象
    grid: null,

    //表格的数据仓库
    store : null,

    dropDownWidth: 500,
    dropDownHeight: 400,

    //绑定值的字段名
    valueField: 'value',

    /**
     * 配合表格, 动态增加行的.
     */
    delayLoad: true,

    //初始化组件
    initComponent: function () {

        var me = this;


        me.fieldCls = 'mi-form-type-text';

        $(me).muBind('focusout', function () {

            me.fieldEl.removeClass('mi-form-focus');
            //me.fieldEl.removeClass('mi-form-invalid-field');

            me.el.removeClass("mi-form-trigger-wrap-focus");

            me.hideDropDownPanel();

            me.clearInvalid();
        });

        me.initStore();

        me.initLabelable();
    },


    beforeShowDropDownPanel: function () {
        /// <summary>开始显示之前的</summary>
        var me = this;

        if (!me.isCustom && !me.content ) {
            me.content = me.initGrid();
        }

        if (me.content) {
            me.initContentPanel();
        }

        if (!me.isCustom) {
            me.init_DropDwonPanel();
            var panel = me.dropDownPanel;

            var boundList = me.getBoundPanel();
            $(panel).children().remove();
            $(panel).append(boundList);

        }
    },


    store_currentChanged: function (event, index, record) {
        "use strict";
        var me = event.data,
            focusedCls = 'mi-grid-row-focused',
            row,
            rowRecord,
            rows = $(me.tbodyEl).children(),
            lastRow = me.lastRowFocused,
            curRow = null;

        if (index > -1) {

            var value = record.get(me.valueField);

            me.setValue(value);

            if (me.ownerParent && me.ownerParent.store) {

                var ownerStore = me.ownerParent.store;
                var ownerRect = ownerStore.current;

                $(me.mapItems).each(function () {

                    var src = this.srcField;
                    var target = this.targetField;

                    var srcValue = record.get(src);


                    ownerRect.set(target, srcValue);

                });
            }


        }

    },

    initGrid :function(){
        
        var me = this,
            bodyEl = Mini2.getBody(),
            panelEl,
            delayLoad = me.delayLoad;

        panelEl = $('<div class="mi-boundlist mi-box-target" style="display:none;"></div>');
        panelEl.css({
            width: me.dropDownWidth,
            height: me.dropDownHeight
        });

        $(bodyEl).append(panelEl);

        if (!me.store) {
            var store = Mini2.create('Mini2.data.Store', {

                pageSize: 0,
                totalCount: 0,
                jsonMode: 'sample',
                //idField: 'IG2_TABLE_ID',
                model: 'Mini2.data.FreeModel',

                fields: me.fields,
                data: me.data

            });

            me.store = store;
        }

        $(me.store).muBind('currentchanged', me, me.store_currentChanged);  //焦点行发生改变的事件


        if (undefined == delayLoad || null == delayLoad) {
            delayLoad = true;
        }

        var grid = Mini2.create('Mini2.ui.panel.Table', {

            scope: me,
            delayLoad: delayLoad,
            renderTo: panelEl,
            store: me.store,
            checkedMode: 'SINGLE',
            focusBorders:false,
            scroll: 'auto',
            columnLines: false,
            dock: 'full',
            selType: 'checkBoxModel',
            readOnly: true,
            autoRowCheck:true,
            columns: me.columns
        });

        grid.render();
                
        grid.setSize(panelEl.width(), panelEl.height());

        
        panelEl.muBind('mousedown', function (e) {

            Mini2.EventManager.stopEvent(e);

        });

        return panelEl;

    }



});


/************************************************************************/
/*                                           */
/*    ui/form/field/ComboTree.js                                           */
/*                                           */
/************************************************************************/



/**
 * 下拉树控件
 *
 */
Mini2.define('Mini2.ui.form.field.ComboTree', {

    extend: 'Mini2.ui.form.field.Trigger',


    alias: 'widget.combotree',

    log: Mini2.Logger.getLogger('Mini2.ui.form.field.ComboTree', true),

    dropDownPanel: null,

    //表格对象
    grid: null,

    //表格的数据仓库
    store: null,

    dropDownWidth: 200,
    dropDownHeight: 300,

    //绑定值的字段名
    valueField: 'value',


    //初始化组件
    initComponent: function () {
        "use strict";
        var me = this;


        me.fieldCls = 'mi-form-type-text';

        $(me).muBind('focusout', function () {

            me.fieldEl.removeClass('mi-form-focus');
            //me.fieldEl.removeClass('mi-form-invalid-field');

            me.el.removeClass("mi-form-trigger-wrap-focus");

            me.hideDropDownPanel();

            me.clearInvalid();
        });

        me.initStore();

        me.initLabelable();
    },


    /**
     * 调用远程数据
     *
     */
    callRemoteData:function(){
        "use strict";
        var me = this,
            store = me.store;

        console.debug('开始加载远程数据...', me.remoteUrl);

        var remotePs = {
            parent_id: me.rootValue
        };

        Mini2.post(me.remoteUrl, remotePs, function (data) {

            console.debug('数据回来了...', data);

            store.add(data);

        });



    },

    /**
     * 开始显示之前的
     *
     */
    beforeShowDropDownPanel: function () {
        "use strict";
        var me = this;

        if (!me.isCustom && !me.content) {
            me.content = me.initTree();


            //开始加载远程数据

            if (me.remoteEnabled) {

                me.callRemoteData();

                
            }

        }

        if (me.content) {
            me.initContentPanel();
        }

        if (!me.isCustom) {
            me.init_DropDwonPanel();
            var panel = me.dropDownPanel;

            var boundList = me.getBoundPanel();
            $(panel).children().remove();
            $(panel).append(boundList);

        }
    },


    /**
     * 数据仓库焦点行发生变化
     *
     */
    store_currentChanged: function (event, index, record) {
        "use strict";
        var me = event.data,
            focusedCls = 'mi-grid-row-focused',
            row,
            rowRecord,
            rows = $(me.tbodyEl).children(),
            lastRow = me.lastRowFocused,
            curRow = null;

        if (index > -1) {

            var field = me.valueField,
                value;

            if (record.get) {
                value = record.get(field);
            }
            else {
                value = record[field]
            }

            me.setValue(value);


        }

    },

    /**
     * 初始化树控件
     *
     */
    initTree: function () {
        "use strict";
        var me = this,
            bodyEl = Mini2.getBody(),
            store = me.store,
            panelEl;

        panelEl = $('<div class="mi-boundlist mi-box-target" style="display:none;"></div>');
        panelEl.css({
            width: me.dropDownWidth,
            height: me.dropDownHeight
        });

        $(bodyEl).append(panelEl);

        if (!store) {
            store = Mini2.create('Mini2.data.TreeStore', {

                id : 'store' + Mini2.newId(),

                remoteEnabled: me.remoteEnabled,
                remoteUrl: me.remoteUrl,

                pageSize: 0,
                totalCount: 0,
                jsonMode: 'sample',
                //idField: 'IG2_TABLE_ID',
                model: 'Mini2.data.FreeModel',

                idField: me.idField,
                parentField: me.parField,
                textField: me.displayField,
                rootValue: me.rootValue,
                rootText: me.rootText,

                sortText: me.sortText,
                

                fields: me.fields,
                data: me.data

            });

            me.store = store;
        }

        $(store).muBind('currentchanged', me, me.store_currentChanged);  //焦点行发生改变的事件

        var tree = Mini2.create('Mini2.ui.tree.Panel', {
            id: 'tree' + Mini2.newId() ,

            renderTo: panelEl,

            store: store,

            remoteEnabled: me.remoteEnabled,
            remoteUrl : me.remoteUrl,

            scroll: 'auto',
            dock: 'full',
            region: 'north',

            rootId: me.rootValue,

            idField: me.idField,
            parField: me.parField,
            valueField: me.valueField,
            textField: me.displayField,

            triggerEvent_selected: false,
            triggerEvent_create: false,
            triggerEvent_remove: false,
            triggerEvent_rename: false,

            types: {
                'default': { icon: '/res/icon/application_view_columns.png' },
                table: { icon: '/res/icon/table.png' },
                view: { icon: '/res/icon/view.png' }
            },
            contextMenu: [],
            event_selected: false,
            event_move: false,

            isTree: true
        });
        tree.render();


        tree.setSize(panelEl.width(), panelEl.height());


        panelEl.muBind('mousedown', function (e) {

            Mini2.EventManager.stopEvent(e);

        });

        return panelEl;

    },


});


/************************************************************************/
/*                                           */
/*    ui/form/field/Date.js                                                */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../../Mini.js" />

/// <reference path="../../define.js" />
/// <reference path="../../lang/Date.js" />



Mini2.define('Mini2.ui.form.field.Date', {

    extend: 'Mini2.ui.form.field.Trigger',

    alias: 'widget.date',

    log: Mini2.Logger.getLogger('Mini2.ui.form.field.Date', false),  //日志管理器

    //绑定显示的字段名
    displayField: 'text',

    //绑定值的字段名
    valueField: 'value',

    isLoaded: false,

    dateEl: null,

    defaultValue: null,

    useStrict: undefined,

    format: "Y-m-d",

    initTimeFormat: 'H',

    initTime: '24',

    showTime: false,

    timeEl: null,

    buttonCls: 'mi-icon-date-trigger',

    setWidth: function (value) {
        "use strict";
        var me = this,
            el = me.el;

        me.width = value,
        el.css('width', value);
    },

    getWidth: function () {
        return this.width;
    },

    getTriggerMarkup: function () {
        "use strict";
        var me = this,
            tpl = Mini2.$join(['<div class="mi-layer mi-border-box" style="z-index:39001;" >', '</div>']);

        return tpl;
    },


    focus: function () {

        var me = this,
            el = me.el,
            fieldEl = me.fieldEl;

        if (!el.hasClass('mi-form-trigger-wrap-focus')) {
            fieldEl.addClass('mi-form-focus');

            el.addClass('mi-form-trigger-wrap-focus');


            //特殊处理，延时获取焦点。不然无法及时得到焦点。
            if (!me._focusTimeout) {

                if (me.inputEl) {
                    me._focusTimeout = setTimeout(function () {

                        var inputEl = me.inputEl;

                        //如果焦点已经移除， 那么就作废
                        if (fieldEl.hasClass('mi-form-focus')) {

                            inputEl.focus();

                        }

                        me._focusTimeout = null;

                    }, 200);
                }
            }

            //console.log('me.scope', me.scope);

            //最后一个参数,强制设置
            Mini2.ui.FocusManager.setControl(me.scope || me, null, null, true);
        }
    },


    /**
     * 原生控件
     */
    getFieldEl_Native: function () {
        var me = this,
            $join = Mini2.$join,
            log = me.log,
            tableEl,
            inputEl,
            btnEl,
            sysInfo = Mini2.SystemInfo.formTrigger;

        if (me.showTime) {
            me.inputEl = inputEl = $join([
                '<input type="datetime-local" class="mi-form-field mi-form-text" ',
                    'autocomplete="off" aria-invalid="false" style="width: 100%; ">'
            ]);
        }
        else {
            me.inputEl = inputEl = $join([
                '<input type="date" class="mi-form-field mi-form-text" ',
                    'autocomplete="off" aria-invalid="false" style="width: 100%; ">'
            ]);
        }

        tableEl = me.inputEl;

        inputEl.attr("id", me.clientId);

        if (me.name) {
            inputEl.attr('name', me.name);
        }

        $(inputEl).change(function () {

        });

        $(inputEl).muBind('focus', function () {
            me.focus();
        });

        $(inputEl).muBind('click', function () {
            me.focus();
        });

        return tableEl;
    },



    getFieldEl_M2: function () {
        var me = this,
            $join = Mini2.$join,
            log = me.log,
            tableEl,
            inputEl,
            btnEl,
            sysInfo = Mini2.SystemInfo.formTrigger;

        tableEl = $join([
            '<table class="mi-form-trigger-wrap" cellpadding="0" cellspacing="0" style="table-layout: fixed; width: 100%; ">',
                '<tbody>',
                    '<tr>',
                        '<td class="mi-form-trigger-input-cell" style="width: 100%; "></td>',
                        '<td valign="top" class="mi-trigger-cell mi-unselectable" style="width:22px;" role="button" ></td>',
                    '</tr>',
                '</tbody>',
            '</table>'
        ]);

        me.inputEl = inputEl = $join([
            '<input type="text" class="mi-form-field mi-form-text" ',
                'autocomplete="off" aria-invalid="false" style="width: 100%; ">'
        ]);

        if (!Mini2.isBlank(me.placeholder)) {
            inputEl.attr('placeholder', me.placeholder);
        }

        if (me.required) {
            inputEl.addClass('mi-form-required-field');
        }

        btnEl = $join(['<div class="mi-form-trigger mi-form-arrow-trigger " role="button"></div>']);

        me.buttonEl = btnEl;

        if (me.buttonCls) {
            btnEl.addCls(me.buttonCls);
        }

        inputEl.attr("id", me.clientId);

        if (me.name) {
            inputEl.attr('name', me.name);
        }

        me.appendCell(tableEl, inputEl, 'td.mi-form-trigger-input-cell');
        me.appendCell(tableEl, btnEl, 'td.mi-trigger-cell');


        tableEl.find('td.mi-trigger-cell').width(sysInfo.width);

        if (undefined != me.value) {
            me.setValue(me.value);

            me.srcValue = me.value;

            delete me.value;
        }

        me.bindEvent_Button(btnEl);

        me.bindInputEl_Mouse(inputEl);
        me.bindInputEl_Key(inputEl);

        me.bindInputEl_Mouse2(inputEl);


        $(me).on('keydown', function (data, ea) {

            if (13 == ea.keyCode && me.mapping) {
                me.onMaping();
                ea.cancel = true;
            }

        });

        return tableEl;
    },

    getFieldEl: function () {
        var me = this,
            $join = Mini2.$join,
            log = me.log,
            tableEl,
            inputEl,
            btnEl,
            sysInfo = Mini2.SystemInfo.formTrigger;


        if ('touch' == Mini2.SystemInfo.mode || Mini2.support.ipad || Mini2.support.iphone) {
            tableEl = me.getFieldEl_Native();
        }
        else {
            tableEl = me.getFieldEl_M2();
        }


        if ('none' == me.mode) {
            me.setMode(true);
        }

        return tableEl;
    },


    callDatepickerShow: function (divEl) {
        "use strict";
        var me = this;

        me.initLocalMessage();

        $.datepicker.formatDate('yy-mm-dd', new Date());

        $(divEl).datepicker({

            dateFormat: 'yy-mm-dd',

            changeMonth: true,
            changeYear: true,
            showOn: '',


            buttonImageOnly: false,

            showOptions: { direction: '' },

            showButtonPanel: true,

            inline: false,

            onSelect: function (dateText, inst) {


                if (me.showTime) {
                    var text = dateText + " " + me.timeEl.val();

                    me.inputEl.val(text);
                }
                else {
                    me.inputEl.val(dateText);
                }

                me.hideDropDownPanel();

                me.focus();

                me.clearInvalid();  //清理异常信息
            }

        });





    },

    //初始化时间控件
    initTimeBox: function () {
        "use strict";
        var me = this,
            panel = me.dropDownPanel;


        if (me.showTime && !me.timeEl) {

            var timeEl = Mini2.$joinStr([
                '<div class="ui-datepicker-time" style="padding: 3px 0px 0px 6px; background-color: #FFF;">',
                    '<span>时间：</span>',
                        '<input type="text" class="ui-time" style="width:80px;" value="12:59:59" />',
                '</div>']);

            //var buttons = $(me.dateEl).find('.ui-datepicker-buttonpane:first');

            $(panel).append(timeEl);

            me.timeEl = timeEl.find('.ui-time:first');
        }
    },


    //扩展关闭按钮
    initCloseBtn: function () {
        "use strict";
        var me = this;



        var buttons = $(me.dateEl).find('.ui-datepicker-buttonpane:first');


        if (buttons.children('.ui-datepicker-close').length > 0) {
            return;
        }


        var closeBtnEl = Mini2.$joinStr(["<button type='button' ",
            "class='ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all' ",
            "data-handler='hide' data-event='click'>关闭</button>"]);

        $(buttons).append(closeBtnEl);

        $(closeBtnEl).click(function () {
            me.hideDropDownPanel();
        });


    },

    getBoundPanel: function () {
        "use strict";
        var me = this;

        me.dateEl = Mini2.$joinStr(['<div style="font-size:12px; "></div>']);


        if ($.fn.datepicker) {
            me.callDatepickerShow(me.dateEl);
        }
        else {
            In('jq.ui.datepicker', function () {
                me.callDatepickerShow.call(me, me.dateEl);
            });
        }

        return me.dateEl;
    },

    beforeShowDropDownPanel: function () {
        "use strict";
        /// <summary>开始显示之前的</summary>

        var me = this;

        me.init_DropDwonPanel();

        if (me.isLoaded) {
            me.initCloseBtn();

            me.initTimeBox();

            console.debug("me.dateEl", me.dateEl);

            return;
        }

        var panel = me.dropDownPanel;


        var boundList = me.getBoundPanel();

        $(panel).children().remove();

        $(panel).append(boundList);

        me.initCloseBtn();

        me.initTimeBox();

        me.isLoaded = true;
    },


    loadDataPicker: function () {
        "use strict";
        var me = this,
            log = me.log,
            el = me.el,
            fieldEl = me.fieldEl,
            pos,
            dateEl = me.dateEl,
            panel = me.dropDownPanel,
            winH = $(window).height(),
            panelTop, buttomY, targetHeight,
            timeEl = me.timeEl;


        pos = fieldEl.offset();

        var dateStr = me.inputEl.val();

        if (me.pw == undefined || me.ph == undefined) {
            me.pw = dateEl.width();
            me.ph = dateEl.height();
        }


        //$(dateEl).datepicker({
        //    currentText: dateStr
        //});

        $(dateEl).datepicker('setDate', dateStr);


        if (timeEl) {

            if (dateStr == '') {
                timeEl.val('00:00:00');
            }
            else {

                /**
                * 注意: 针对 IE 旧版,火狐,进行替换
                */
                if (Mini2.support.msie || Mini2.support.mozilla) {
                    dateStr = dateStr.replace(/-/g, '/');
                }

                var tmpDate = new Date(dateStr);

                var timeStr = Mini2.Date.format(tmpDate, 'H:i:s');

                timeEl.val(timeStr);
            }
        }

        targetHeight = me.ph;

        if (me.showTime) {
            targetHeight += 30;
        }

        buttomY = (pos.top + el.height() - 2) + targetHeight;

        if (buttomY > winH) {
            panelTop = pos.top - targetHeight;
        }
        else {
            panelTop = pos.top + el.height() - 1;
        }

        var elWidth = el.width();

        var posX = pos.left + fieldEl.width() - $(panel).width() + 2;

        var posH = me.ph;

        if (me.showTime) {
            posH += 30; //加上 30像素时间像素
        }

        log.debug('posX', posX);

        panel.css({
            width: me.pw,
            height: posH,
            left: posX,
            top: panelTop
        });

        panel.show();

    },


    //初始化本土信息
    initLocalMessage: function () {
        "use strict";
        if ($.datepicker.regional['zh-CN']) {
            return;
        }

        $.datepicker.regional['zh-CN'] = {
            closeText: '关闭',
            prevText: '&#x3C;上月',
            nextText: '下月&#x3E;',
            currentText: '今天',
            monthNames: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
            monthNamesShort: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
            dayNames: ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'],
            dayNamesShort: ['周日', '周一', '周二', '周三', '周四', '周五', '周六'],
            dayNamesMin: ['日', '一', '二', '三', '四', '五', '六'],
            weekHeader: '周',
            dateFormat: 'yy-mm-dd',
            firstDay: 1,
            isRTL: false,
            showMonthAfterYear: true,
            yearSuffix: '年'
        };

        $.datepicker.setDefaults($.datepicker.regional['zh-CN']);

    },

    //显示下拉版面
    showDropDownPanel: function () {
        "use strict";
        /// <summary>显示下拉框</summary>

        var me = this;

        me.init_DropDwonPanel();

        if ($.fn.datepicker) {
            me.loadDataPicker();
        }
        else {
            In('jq.ui.datepicker', function () {

                me.loadDataPicker.call(me);

            });
        }
    },


    parseDate: function (value) {
        "use strict";
        if (!value || Mini2.isDate(value)) {
            return value;
        }

        var me = this,
            val = me.safeParse(value, me.format),
            altFormats = me.altFormats,
            altFormatsArray = me.altFormatsArray,
            i = 0,
            len;

        if (!val && altFormats) {
            altFormatsArray = altFormatsArray || altFormats.split('|');
            len = altFormatsArray.length;
            for (; i < len && !val; ++i) {
                val = me.safeParse(value, altFormatsArray[i]);
            }
        }

        return val;
    },

    safeParse: function (value, format) {
        "use strict";
        var me = this,
            log = me.log,
            utilDate = Mini2.Date,
            result = null,
            strict = me.useStrict,
            parsedDate;


        if (utilDate.formatContainsHourInfo(format)) {
            // if parse format contains hour information, no DST adjustment is necessary
            result = utilDate.parse(value, format, strict);

        }
        else {
            // set time to 12 noon, then clear the time
            parsedDate = utilDate.parse(value + ' ' + me.initTime, format + ' ' + me.initTimeFormat, strict);
            log.debug(format + ' ' + me.initTimeFormat);
            if (parsedDate) {
                result = utilDate.clearTime(parsedDate);
            }
        }

        return result;
    },





    setOldValue: function (value) {
        "use strict";
        var me = this,
            valueStr = value,
            support = Mini2.support,
            timeStr = '';

        if (!value) {
            me.oldValue = ''
            return;
        }


        if (Mini2.isDate(valueStr)) {
            if (me.showTime) {
                valueStr = Mini2.Date.format(value, 'Y-m-d\\TH:i:s');
            }
            else {
                valueStr = Mini2.Date.format(tmpDate, 'Y-m-d');
            }
            //valueStr = Mini2.Date.format(value, me.format);

            timeStr = Mini2.Date.format(value, 'H:i:s');
        }
        else if (Mini2.isString(valueStr)) {

            if (valueStr != "") {


                if ('touch' == Mini2.SystemInfo.mode || support.ipad || support.iphone) {

                    var tmpDate = new Date(valueStr);

                    //console.debug("转化类型前, ", tmpDate);


                    if (me.showTime) {
                        valueStr = Mini2.Date.format(tmpDate, 'Y-m-d\\TH:i:s');
                    }
                    else {
                        valueStr = Mini2.Date.format(tmpDate, 'Y-m-d');
                    }

                    //console.debug("转化类型后, ", valueStr);
                }
                else if (support.mozilla) {

                    //火狐浏览器特殊处理

                    var sssIndex = value.lastIndexOf("."),
                        dtStr, sssStr, dt;

                    if (sssIndex > 0) {
                        dtStr = value.substring(0, sssIndex);   //获取年月日时分秒
                        sssStr = value.substr(sssIndex + 1); //获取毫秒

                        dtStr = dtStr.replace(/-/g, "/");

                        dt = new Date(dtStr);

                        try {
                            dt.setMilliseconds(sssStr);
                        }
                        catch (ex) {
                            console.log("错误啦...." + ex.message);
                        }

                        value = dt;
                    }

                    valueStr = Mini2.Date.format(value, me.format);
                    //timeStr = Mini2.Date.format(value, 'H:i:s');

                }
                else {
                    var tmpDate = new Date(valueStr);

                    valueStr = Mini2.Date.format(tmpDate, me.format);
                    //timeStr = Mini2.Date.format(tmpDate, 'H:i:s');
                }
            }

        }




        me.oldValue = valueStr;
    },

    getValue: function () {
        "use strict";
        var me = this,
            support = Mini2.support,
            defaultValue = me.defaultValue,
            valueStr,
            value = me.constructor.base.getValue.call(me);

        if (value == '') {
            return me.defaultValue;
        }

        if ('touch' == Mini2.SystemInfo.mode || support.ipad || support.iphone) {

            value = me.inputEl.val()


            return value;
        }
        else {
            value = me.constructor.base.getValue.call(me)
            if (value == '') {
                return me.defaultValue;
            }

            value = new Date(value);

            value = Mini2.Date.format(value, me.format);
        }



        return value;
    },

    setValue: function (value) {
        "use strict";
        var me = this,
            support = Mini2.support,
            valueStr = value,
            timeStr = '';

        if (!value) {
            me.constructor.base.setValue.call(me, '');
            return;
        }

        if (Mini2.isDate(valueStr)) {
            if (me.showTime) {
                valueStr = Mini2.Date.format(value, 'Y-m-d\\TH:i:s');
            }
            else {
                valueStr = Mini2.Date.format(tmpDate, 'Y-m-d');
            }

            timeStr = Mini2.Date.format(value, 'H:i:s');

        }
        else if (Mini2.isString(valueStr)) {

            if (valueStr != "") {


                if ('touch' == Mini2.SystemInfo.mode || support.ipad || support.iphone) {

                    if (valueStr.indexOf('T') > 0) {

                        me.inputEl.val(valueStr);
                    }
                    else {
                        console.debug("转化类型前1, ", valueStr);
                        var tmpDate = new Date(valueStr);  //--就是这里出现问题, 多了 8 个小时

                        console.debug("转化类型后2, ", tmpDate);


                        if (me.showTime) {
                            valueStr = Mini2.Date.format(tmpDate, 'Y-m-d\\TH:i:s');
                        }
                        else {
                            valueStr = Mini2.Date.format(tmpDate, 'Y-m-d');
                        }

                        console.debug("转化类型后, ", valueStr);

                        me.inputEl.val(valueStr);
                    }



                    return;
                }
                else if (support.mozilla) {

                    //火狐浏览器特殊处理

                    var sssIndex = value.lastIndexOf("."),
                        dtStr, sssStr, dt;

                    if (sssIndex > 0) {
                        dtStr = value.substring(0, sssIndex);   //获取年月日时分秒
                        sssStr = value.substr(sssIndex + 1); //获取毫秒

                        dtStr = dtStr.replace(/-/g, "/");

                        dt = new Date(dtStr);

                        try {
                            dt.setMilliseconds(sssStr);
                        }
                        catch (ex) {
                            console.log("错误啦...." + ex.message);
                        }

                        value = dt;
                    }
                    else {
                        value = new Date(value);
                    }

                    valueStr = Mini2.Date.format(value, me.format);

                }
                else {
                    var tmpDate = new Date(valueStr);

                    valueStr = Mini2.Date.format(tmpDate, me.format);
                }
            }

        }

        me.constructor.base.setValue.call(me, valueStr);

    },



    isValueChanged: function () {
        var me = this,
            log = me.log,
            oldValue = me.oldValue,
            curValue = me.getValue();

        if (undefined === oldValue || '' == oldValue) {
            oldValue = null;
        }

        if (undefined === curValue || '' == curValue) {
            curValue = null;
        }

        return oldValue != curValue;
    },


    //处理下拉框的形状和位置
    proDropDownPanel_SizeALocal: function () {
        "use strict";
        var me = this,
            el = me.el,
            fieldEl = me.fieldEl,
            panel,
            office,
            width,
            itemCount,
            winH = $(window).height(),
            buttomY,
            panelTop,
            fieldElWidth,
            targetHeight;

        panel = me.dropDownPanel;

        office = fieldEl.offset();

        fieldElWidth = fieldEl.width();
        width = me.dropDownWidth || fieldElWidth;

        if (width < fieldElWidth) {
            width = fieldElWidth;
        }


        itemCount = me.store.getCount();

        if (itemCount > 8) {
            itemCount = 8;
        }

        targetHeight = 24 * itemCount;

        buttomY = (office.top + el.height() - 2) + targetHeight;

        if (buttomY > winH) {
            panelTop = office.top - targetHeight;
        }
        else {
            panelTop = office.top + el.height() - 2
        }


        panel.css({
            'border-width': 1,
            'width': width,
            'height': targetHeight,
            'left': office.left,
            'top': panelTop
        }).show();


        return me;

    }

});


/************************************************************************/
/*                                           */
/*    ui/form/field/DateRange.js                                           */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../../Mini.js" />


Mini2.define('Mini2.ui.form.field.DateRange', {

    extend: 'Mini2.ui.form.field.Base',

    alias: 'widget.daterange',
    isRangeControl:true,

    startItem: null,

    endItem: null,

    startCellEl: null,

    endCellEl: null,

    //改写:初始化组件
    initComponent: function () {
        "use strict";
        var me = this;

        me.initLabelable();
    },



    getFieldEl: function () {
        "use strict";
        var me = this,
            tableEl,
            rowEl,
            startCellEl,
            endCellEl;


        tableEl = Mini2.$joinStr([
            '<table class="mi-table-plain"  cellpadding="0" cellspacing="0" border="0" role="presentation" style="table-layout: auto;">',
                '<tbody>',
                    '<tr>',
                        '<td class="mi-item-cell-start"></td>',
                        '<td>&nbsp;-&nbsp;</td>',
                        '<td class="mi-item-cell-end"></td>',
                    '</tr>',
                '</tbody>',
            '</table>']);

        rowEl = tableEl.find('tr:first');

        me.startCellEl = startCellEl = rowEl.children('.mi-item-cell-start');
        me.endCellEl = endCellEl = rowEl.children('.mi-item-cell-end');

        me.startItem = Mini2.create('Mini2.ui.form.field.Date', {
            renderTo: startCellEl,
            hideLabel: true,
            value: me.startValue,
            clientId: me.clientId + '_Start',
            name: me.name + '_Start'
        });


        me.endItem = Mini2.create('Mini2.ui.form.field.Date', {
            renderTo: endCellEl,
            hideLabel: true,
            value:me.endValue,
            clientId: me.clientId + '_End',
            name: me.name + '_End'
        });


        return tableEl;
    },


    setStartValue: function (value) {
        var me = this,
            startItem = me.startItem;

        startItem.setValue(value);

        return me;
    },

    getStartValue: function () {
        var me = this,
            startItem = me.startItem;

        return startItem.getValue();
    },


    setEndValue: function (value) {
        var me = this,
            endItem = me.endItem;

        endItem.setValue(value);

        return me;
    },

    getEndValue: function () {
        var me = this,
            endItem = me.endItem;

        return endItem.getValue();
    },


    setOldValue:function(rangeType, value){
        var me = this;

        if ('start' == rangeType) {
            me.startItem.setOldValue(value);
        }
        else if ('end' == rangeType) {
            me.endItem.setOldValue(value);
        }
        else {
            throw new Error('无效类型, 参数只有 ["start" | "end"] 两个选择. 用户输入: ' + rangeType);
        }

        return me;
    },

    setValue: function (rangeType, value) {
        var me = this;

        if ('start' == rangeType) {
            me.startItem.setValue(value);
        }
        else if ('end' == rangeType) {
            me.endItem.setValue(value);
        }
        else {
            throw new Error('无效类型, 参数只有 ["start" | "end"] 两个选择. 用户输入: ' + rangeType);
        }

        return me;
    },

    getValue: function (rangeType) {
        var me = this;

        if ('start' == rangeType) {
            return me.startItem.getValue();
        }
        else if ('end' == rangeType) {
            return me.endItem.getValue();
        }
        else {
            //throw new Error('无效类型, 参数只有 ["start" | "end"] 两个选择. 用户输入: ' + rangeType);
        }
    },

    /**
    * 设置
    *
    */
    setDirty:function(rangeType, dirty){
        var me = this,
            startItem = me.startItem,
            endItem = me.endItem;

        if ('start' == rangeType) {
            startItem.setDirty(dirty);
        }
        else if ('end' == rangeType) {
            endItem.setDirty(dirty);
        }
        else {
            throw new Error('无效类型, 参数只有 ["start" | "end"] 两个选择. 用户输入: ' + rangeType);
        }

        return me;
    },


    /**
    * 值是否发生变化
    * @param {string} rangeType [ start | end ] 
    */
    isValueChanged:function(rangeType){

        var me = this,
            startItem = me.startItem,
            endItem = me.endItem;

        if (rangeType) {

            if ('start' == rangeType) {
                return startItem.isValueChanged();
            }
            else if ('end' == rangeType) {
                return endItem.isValueChanged();
            }
            else {
                throw new Error('无效类型, 参数只有 ["start" | "end"] 两个选择. 用户输入: ' + rangeType);
            }
        }
        else {
            return (startItem.isValueChanged() || endItem.isValueChanged());
        }


    },


    render: function () {
        "use strict";
        var me = this,
            bodyCls = 'td.mi-form-item-body:first',
            tableEl,
            fieldEl;


        tableEl = me.getTableContainer();

        fieldEl = me.getFieldEl();

        if (me.applyTo) {
            $(me.applyTo).replaceWith(tableEl);
        }
        else {
            $(me.renderTo).append(tableEl);
        }


        me.appendCell(tableEl, fieldEl, bodyCls);

        me.renderForLableable(tableEl);


        me.startItem.render();

        me.endItem.render();


        $(me.startItem).muBind('focusout', function (e) {

            var lastData = me.startItem.getValue();

            $(me).muTriggerHandler('focusout', [{
                sender: this,    //原焦点控件
                target: null,        //新获取焦点控件
                data: lastData      //原附带的数据
            }]);
        });


        $(me.endItem).muBind('focusout', function (e) {

            var lastData = me.endItem.getValue();

            $(me).muTriggerHandler('focusout', [{
                sender: this,    //原焦点控件
                target: null,        //新获取焦点控件
                data: lastData      //原附带的数据
            }]);
        });


        me.el = tableEl;

        tableEl.data('me', me);
    }



});


/************************************************************************/
/*                                           */
/*    ui/form/field/Time.js                                                */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />



Mini2.define('Mini2.ui.form.field.Time', {

    extend: 'Mini2.ui.form.field.Text',

    inputTpl:[
        '<table class="mi-form-trigger-wrap" cellpadding="0" cellspacing="0" style="table-layout: fixed;">',
            '<tr>',
                '<td style="">',
                    '<input type="text" class="mi-form-time-hour" style="width:100%; font-size:15px; border:none; " value="0:0" maxLength="5" />',
                '</td>',
                //'<td style="width:6px;">:</td>',
                //'<td style="width:20px;">',
                //    '<input type="text" class="mi-form-time-minute" style="width:100%;font-size:14px; border:none; " value="00" maxLength="2" />',
                //'</td>',
                '<td style="display:none;">',
                    '<input type="hidden" class="mi-form-timepicker-input" />',
                    
                '</td>',

                //'<td>',
                //    '<div class="mi-form-trigger mi-form-arrow-trigger " role="button"></div>',
                //'</td>',
            '</tr>',
        '</table>'
    ],



    initComponent: function () {
        "use strict";
        var me = this,
            log = me.log;

        $(me).muBind('focusout', function () {



            if (me._focusTimeout) {
                clearTimeout(me._focusTimeout);
                delete me._focusTimeout;
            }

            if (me.fieldEl) {
                me.fieldEl.removeClass("mi-form-focus").trigger('blur'); //让文本框失去焦点
            }


            me.el.removeClass("mi-form-trigger-wrap-focus");

            me.on('hided');

            me.clearInvalid();
            //me.isValid();

            if (me.clearBtnEl) {
                me.clearBtnEl.hide();
            }
            
        });

        me.initLabelable();
    },

    /**
    * 数值的值
    */
    numVaue: 0,


    getTimeObj :function(value){
        "use strict";
        var me = this;

        if (Mini2.isNumber(value)) {

            var m1 = value % 3600;

            var sec = m1 % 60;

            var hour = (value - m1) / 3600;
            var min = (m1 - sec) / 60;

            return {
                hour: hour,
                minute: min,
                sec: sec
            };
        }
        else {

        }

    },


    /*
    * 设置时间值
    */
    setValue:function(value){
        "use strict";
        var me = this,
            hideEl = me.hideEl;
        
        if (Mini2.isBlank(value)) {

            me.numVaue = null;

            me.hideValueEl.val('');

            me.hourEl.val('');

            return me;
        }

        if (Mini2.isNumber(value)) {

            var timeObj = me.getTimeObj(value);

            
            me.numVaue = value;

            me.hideValueEl.val(value);

            me.hourEl.val(timeObj.hour + ":" + timeObj.minute);

            if (hideEl) {
                hideEl.val(value);
            }
        }
        else {

        }

        return me;
    },


    textToNum:function(valueText){

        var sp = valueText.split(':');

        var numValue = 0;

        numValue += parseInt(sp[0]) * 3600;
        numValue += parseInt(sp[1]) * 60;
       
        if (sp[2]) {
            numValue += parseInt(sp[2]);
        }

        return numValue;
    },

    //获取时间值
    getValue: function (value) {
        "use strict";
        var me = this;

        var srcText = me.hourEl.val();
        
        if (Mini2.isBlank(srcText)) {
            return null;
        }

        me.numVaue = me.textToNum(srcText);

        return me.numVaue;
    },

    
    //textValid: function (textEl) {
    //    "use strict";
    //    var obj = textEl,
    //        reg = /^[\d]+$/g;

    //    if (!reg.test(obj.value)) {
    //        var txt = obj.value;

    //        txt.replace(/[^0-9]+/, function (char, index, val) {//匹配第一次非数字字符
    //            obj.value = val.replace(/\D/g, "");//将非数字字符替换成""
    //            var rtextRange = null;

    //            if (obj.setSelectionRange) {
    //                obj.setSelectionRange(index, index);
    //            }
    //            else {//支持ie
    //                rtextRange = obj.createTextRange();
    //                rtextRange.moveStart('character', index);
    //                rtextRange.collapse(true);
    //                rtextRange.select();
    //            }
    //        });
    //    }
    //},

    getFieldEl: function () {
        "use strict";

        var me = this,
            hideValueEl,
            inputEl, srcInputEl,
            checkedCls = me.checkedCls;


        me.inputEl = inputEl = Mini2.$join(me.inputTpl);

        me.hideValueEl = hideValueEl = inputEl.find('.mi-form-timepicker-input');

        hideValueEl.attr("id", me.clientId);
        hideValueEl.attr('name', me.name);
        hideValueEl.attr('value', me.value);

       
        
        var hourEl = inputEl.find('.mi-form-time-hour');
        //var minEl = inputEl.find('.mi-form-time-minute');

        //hourEl.muBind('keyup', function (e) {
        //    me.textValid(this);
        //});

        me.hourEl = hourEl;

        me.bindInputEl_Mouse(hourEl);



        //minEl.muBind('keyup', function (e) {
        //    me.textValid(this);
        //});


        //me.bindInputEl_Mouse(minEl);

        return inputEl;
    }


});


/************************************************************************/
/*                                           */
/*    ui/form/field/Number.js                                              */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />


Mini2.define('Mini2.ui.form.field.Number', {
    extend: 'Mini2.ui.form.field.Text',
    alias: 'widget.number',

    log : Mini2.Logger.getLogger('Mini2.ui.form.field.Number'),

    allowDecimals: true,

    decimalSeparator: '.',

    submitLocaleSeparator: true,

    decimalPrecision: 2,

    minValue: -1000000000,

    maxValue: 1000000000,

    step: 1,

    /**
    * 方向(水平,垂直)
    * h v
    */
    direction: 'h', //'horizontal',

    value: 0,
    defaultValue: 0,

    align: 'right',


    initComponent: function () {
        "use strict";
        var me = this,
            log = me.log;

        $(me).muBind('focusout', function () {

            var oldValue = me.getValue();

            var value = Mini2.Number.from(oldValue, me.defaultValue);

            if (value < me.minValue)
            {
                me.setValue(me.minValue);
            }
            else if (value > me.maxValue) {
                me.setValue(me.maxValue);
            }
            else {
                me.setValue(value);
            }

            
            if (me._focusTimeout) {
                clearTimeout(me._focusTimeout);
                delete me._focusTimeout;
            }


            me.fieldEl.removeClass("mi-form-focus");
            me.el.removeClass("mi-form-trigger-wrap-focus");
            
            me.clearInvalid();

        });

        me.initLabelable();
    },


    getValue: function () {
        "use strict";
        var me = this,
            defaultValue = me.defaultValue;

        var value = this.constructor.base.getValue.call(this);

        if (value == '') {
            return 0;
        }

        value = Mini2.Number.from(value, defaultValue);


        return value;
    },

    setMinValue: function (value) {
        "use strict";
        var me = this,
            allowed;

        me.minValue = Mini2.Number.from(value, Number.NEGATIVE_INFINITY);
        me.toggleSpinners();

        // Build regexes for masking and stripping based on the configured options
        if (me.disableKeyFilter !== true) {
            allowed = me.baseChars + '';

            if (me.allowExponential) {
                allowed += me.decimalSeparator + 'e+-';
            }
            else {
                if (me.allowDecimals) {
                    allowed += me.decimalSeparator;
                }
                if (me.minValue < 0) {
                    allowed += '-';
                }
            }

            allowed = Mini2.String.escapeRegex(allowed);
            me.maskRe = new RegExp('[' + allowed + ']');
            if (me.autoStripChars) {
                me.stripCharsRe = new RegExp('[^' + allowed + ']', 'gi');
            }
        }
    },

    setMaxValue: function (value) {
        this.maxValue = Mini2.Number.from(value, Number.MAX_VALUE);
        this.toggleSpinners();
    },


    toggleSpinners: function () {
        "use strict";
        var me = this,
            value = me.getValue(),
            valueIsNull = value === null,
            enabled;

        // If it's disabled, only allow it to be re-enabled if we are
        // the ones who are disabling it.
        if (me.spinUpEnabled || me.spinUpDisabledByToggle) {
            enabled = valueIsNull || value < me.maxValue;
            me.setSpinUpEnabled(enabled, true);
        }


        if (me.spinDownEnabled || me.spinDownDisabledByToggle) {
            enabled = valueIsNull || value > me.minValue;
            me.setSpinDownEnabled(enabled, true);
        }
    },


    rawToValue: function (rawValue) {
        var value = this.fixPrecision(this.parseValue(rawValue));
        if (value === null) {
            value = rawValue || null;
        }
        return value;
    },


    valueToRaw: function (value) {
        var me = this,
            decimalSeparator = me.decimalSeparator;
        value = me.parseValue(value);
        value = me.fixPrecision(value);
        value = Mini2.isNumber(value) ? value : parseFloat(String(value).replace(decimalSeparator, '.'));
        value = isNaN(value) ? '' : String(value).replace('.', decimalSeparator);
        return value;
    },


    parseValue: function (value) {
        value = parseFloat(String(value).replace(this.decimalSeparator, '.'));
        return isNaN(value) ? null : value;
    },


    fixPrecision: function (value) {
        var me = this,
            nan = isNaN(value),
            precision = me.decimalPrecision;

        if (nan || !value) {
            return nan ? '' : value;
        } else if (!me.allowDecimals || precision <= 0) {
            precision = 0;
        }

        return parseFloat(Mini2.Number.toFixed(parseFloat(value), precision));
    },

    setSpinValue: function (value) {
        var me = this,
            len;

        //        if (me.enforceMaxLength) {
        //            // We need to round the value here, otherwise we could end up with a
        //            // very long number (think 0.1 + 0.2)
        //            if (me.fixPrecision(value).toString().length > me.maxLength) {
        //                return;
        //            }
        //        }
        me.setValue(value);
    },


    onSpinUp: function () {
        var me = this;

        if (!me.readOnly) {
            me.setSpinValue(Mini2.Number.constrain(me.getValue() + me.step, me.minValue, me.maxValue));
        }
    },


    onSpinDown: function () {
        var me = this;

        if (!me.readOnly) {
            me.setSpinValue(Mini2.Number.constrain(me.getValue() - me.step, me.minValue, me.maxValue));
        }
    },

    spinUpEnabled: function (enabled) {
        "use strict";
        var me = this;


        if (enabled) {
            me.onSpinUp();

            if (!me.spinUpDisabledByToggle) {
                me.spinUpDisabledByToggle = setInterval(function () {
                    me.onSpinUp();
                }, 200);
            }
        }
        else {

            if (me.spinUpDisabledByToggle) {
                clearInterval(me.spinUpDisabledByToggle);

                delete me.spinUpDisabledByToggle;
            }
        }
    },

    spinDownEnabled: function (enabled) {
        "use strict";
        var me = this;


        if (enabled) {
            me.onSpinDown();

            if (!me.spinDownDisabledByToggle) {

                me.spinDownDisabledByToggle = setInterval(function () {
                    me.onSpinDown();
                    //log.debug(me.getValue());
                }, 200);
            }
        }
        else {

            if (me.spinDownDisabledByToggle) {
                clearInterval(me.spinDownDisabledByToggle);

                delete me.spinDownDisabledByToggle;
            }
        }

    },

    btnUp_Click: function (e) {
        var me = e.data;

        me.onSpinUp();
        me.focus();
        Mini2.EventManager.stopEvent(e);
    },

    btnDown_Click: function (e) {
        var me = e.data;

        me.onSpinDown();
        me.focus();
        Mini2.EventManager.stopEvent(e);
    },




    bindInputEl_Key: function (inputEl) {
        "use strict";
        var me = this;

        $(inputEl)
        .on('keydown', function (e) {

            var keyCode = e.keyCode ;


            //107= +加按钮, 109= -减按钮

            if (107 == keyCode) {   //+ 按钮
                me.onSpinUp();
                Mini2.EventManager.stopEvent(e);
            }
            else if (109 == keyCode) { //-按钮
                me.onSpinDown();
                Mini2.EventManager.stopEvent(e);
            }
            //else if(37 == keyCode){ //左

            //    if (!me.isFirstCursor()) {

            //        Mini2.EventManager.stopEvent(e);
            //    }
            //}
            //else if (39 == keyCode) { //右

            //    if (!me.isLastCursor()) {

            //        Mini2.EventManager.stopEvent(e);
            //    }
            //}
            else {
                //log.debug(" - " + e.keyCode);


                me.on('keydown', e);
            }

            


        })
        .on('keyup', function (e) {


            me.on('keyup', e);


        })
        .on('keypress', function (e) {

            //            var keyCode = e.keyCode;

            //            log.debug(" - " + e.keyCode);

            me.on('keypress', e);
        });
    },


    getFieldEl_ForComputer:function(){
        "use strict";
        var me = this,
            inputEl;

        var tableEl = Mini2.$join([
            '<table class="mi-form-trigger-wrap" cellpadding="0" cellspacing="0" style="table-layout: fixed; width: 100%; ">',
                '<tbody>',
                    '<tr>',
                        '<td class="mi-form-trigger-input-cell" style="width: 100%; "></td>',
                        '<td valign="top" class="mi-trigger-cell"></td>',
                    '</tr>',
                '</tbody>',
            '</table>']);


        //if (Mini2.support.webkit) {
        //    inputEl = Mini2.$join([
        //        '<input type="number" class="mi-form-field mi-form-required-field mi-form-text" ',
        //            'autocomplete="off" aria-invalid="false" data-errorqtip="" style="width: 100%; " min="', me.mixValue ,'" max="',me.maxValue,'" >']);
        //}
        //else {
        inputEl = Mini2.$join([
            '<input type="text" class="mi-form-field mi-form-text" ',
                'autocomplete="off" aria-invalid="false"  style="width: 100%; ">']);
        //}

        //mi-form-required-field

        var btnUpEl = Mini2.$join(['<div class="mi-trigger-index-0 mi-form-trigger mi-form-spinner-up" role="button"></div>']);
        var btnDownEl = Mini2.$join(['<div class="mi-trigger-index-1 mi-form-trigger mi-form-spinner-down" role="button"></div>']);

        inputEl.attr("id", me.clientId);


        inputEl.val(me.value);

        if (me.name) {
            inputEl.attr('name', me.name);
        }

        me.appendCell(tableEl, inputEl, 'td.mi-form-trigger-input-cell');
        me.appendCell(tableEl, btnUpEl, 'td.mi-trigger-cell');
        me.appendCell(tableEl, btnDownEl, 'td.mi-trigger-cell');


        btnUpEl.muBind('mousedown', me, function (e) {
            me.focus();
            me.spinUpEnabled(true);
        });

        btnUpEl.muBind('mouseup', me, function (e) {
            me.spinUpEnabled(false);
            Mini2.EventManager.stopEvent(e);
        });

        btnDownEl.muBind('mousedown', me, function () {
            me.focus();
            me.spinDownEnabled(true);
        });
        btnDownEl.muBind('mouseup', me, function (e) {
            me.spinDownEnabled(false);
            Mini2.EventManager.stopEvent(e);
        });

        me.bindInputEl_Mouse(inputEl);
        me.bindInputEl_Key(inputEl);

        //me.bindInputEl_Mouse2(inputEl);

        me.inputEl = inputEl;


        return tableEl;

    },


    /**
     * 触摸控件
     */
    getFieldEl_ForTouch: function () {
        "use strict";
        var me = this,
            inputEl;

        var tableEl = Mini2.$join([
            '<table class="mi-form-trigger-wrap mi-form-trigger-wrap-touch" cellpadding="0" cellspacing="0" style="table-layout: fixed; width: 100%;padding:0px; ">',
                '<tbody>',
                    '<tr>',
                        '<td valign="" class="mi-trigger-cell mi-trigger-cell-left mi-trigger-down" ></td>',
                        '<td class="mi-form-trigger-input-cell" style="width: 100%; "></td>',
                        '<td valign="" class="mi-trigger-cell mi-trigger-cell-right mi-trigger-up" ></td>',
                    '</tr>',
                '</tbody>',
            '</table>']);

        inputEl = Mini2.$join([
            '<input type="text" class="mi-form-field mi-form-text" ',
                'autocomplete="off" aria-invalid="false"  style="width: 100%; ">']);


        var btnUpEl = Mini2.$join(['<div class="mi-trigger-index-0 mi-form-trigger fa fa-plus" role="button"></div>']);
        var btnDownEl = Mini2.$join(['<div class="mi-trigger-index-1 mi-form-trigger  fa fa-minus"  role="button"></div>']);

        inputEl.attr("id", me.clientId);


        inputEl.val(me.value);

        if (me.name) {
            inputEl.attr('name', me.name);
        }

        me.appendCell(tableEl, inputEl, 'td.mi-form-trigger-input-cell');
        me.appendCell(tableEl, btnUpEl, 'td.mi-trigger-up');
        me.appendCell(tableEl, btnDownEl, 'td.mi-trigger-down');


        btnUpEl.muBind('mousedown', me, function (e) {
            me.focus();
            me.spinUpEnabled(true);
        });

        btnUpEl.muBind('mouseup', me, function (e) {
            me.spinUpEnabled(false);
            Mini2.EventManager.stopEvent(e);
        });

        btnDownEl.muBind('mousedown', me, function () {
            me.focus();
            me.spinDownEnabled(true);
        });
        btnDownEl.muBind('mouseup', me, function (e) {
            me.spinDownEnabled(false);
            Mini2.EventManager.stopEvent(e);
        });

        me.bindInputEl_Mouse(inputEl);
        me.bindInputEl_Key(inputEl);

        //me.bindInputEl_Mouse2(inputEl);

        me.inputEl = inputEl;


        return tableEl;

    },



    /**
     * 触摸控件 (垂直的)
     */
    getFieldEl_ForTouch_V: function () {
        "use strict";
        var me = this,
            inputEl;

        var tableEl = Mini2.$join([
            '<table class="mi-form-trigger-wrap mi-form-trigger-wrap-vertical" cellpadding="0" cellspacing="0" style="table-layout: fixed;padding:0px; ">',
                '<tbody>',
                    '<tr>',
                        '<td valign="" class="mi-trigger-cell mi-trigger-cell-top mi-trigger-up" style="background-color:#EEE;" ></td>',
                    '</tr>',
                    '<tr>',
                        '<td class="mi-form-trigger-input-cell" style="width: 100%; "></td>',
                    '</tr>',
                    '<tr>',
                        '<td valign="" class="mi-trigger-cell mi-trigger-cell-bottom mi-trigger-down" style="background-color:#EEE;" ></td>',
                    '</tr>',
                '</tbody>',
            '</table>']);

        inputEl = Mini2.$join([
            '<input type="text" class="mi-form-field mi-form-text" ',
                'autocomplete="off" aria-invalid="false"  style="width: 100%; ">']);


        var btnUpEl = Mini2.$join(['<div class="mi-trigger-index-0 mi-form-trigger mi-form-spinner-up" role="button" style="margin: auto;background-color:#EEE;"></div>']);
        var btnDownEl = Mini2.$join(['<div class="mi-trigger-index-1 mi-form-trigger  mi-form-spinner-down"  role="button" style="margin: auto;background-color:#EEE;"></div>']);

        inputEl.attr("id", me.clientId);


        inputEl.val(me.value);

        if (me.name) {
            inputEl.attr('name', me.name);
        }

        me.appendCell(tableEl, inputEl, 'td.mi-form-trigger-input-cell');
        me.appendCell(tableEl, btnUpEl, 'td.mi-trigger-up');
        me.appendCell(tableEl, btnDownEl, 'td.mi-trigger-down');


        btnUpEl.muBind('mousedown', me, function (e) {
            me.focus();
            me.spinUpEnabled(true);
        });

        btnUpEl.muBind('mouseup', me, function (e) {
            me.spinUpEnabled(false);
            Mini2.EventManager.stopEvent(e);
        });

        btnDownEl.muBind('mousedown', me, function () {
            me.focus();
            me.spinDownEnabled(true);
        });
        btnDownEl.muBind('mouseup', me, function (e) {
            me.spinDownEnabled(false);
            Mini2.EventManager.stopEvent(e);
        });

        me.bindInputEl_Mouse(inputEl);
        me.bindInputEl_Key(inputEl);

        //me.bindInputEl_Mouse2(inputEl);

        me.inputEl = inputEl;


        return tableEl;

    },


    getFieldEl: function () {
        var me = this,
            tableEl ,
            deviceType = me.deviceType;

        
        if ('auto' === deviceType) {

            if ('touch' == Mini2.SystemInfo.mode) {

                deviceType = 'touch';

            }

        }
        
        if ('v' === me.direction || 'vertical' === me.direction) {

            tableEl = me.getFieldEl_ForTouch_V();
        }
        else {
            if ('auto' === deviceType || 'computer' === deviceType) {
                //电脑模式
                tableEl = me.getFieldEl_ForComputer();
            }
            else if ('touch' === deviceType) {
                //触摸模式

                tableEl = me.getFieldEl_ForTouch();
            }
        }


        return tableEl;
    },

    render: function () {
        var me = this;

        me.baseRender();

        //me.inputEl.css('padding-right', '0px');
        
        me.el.attr('data-muid', me.muid);

        me.el.data('me', me);

    }


});



/************************************************************************/
/*                                           */
/*    ui/form/field/NumRange.js                                            */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../../Mini.js" />


Mini2.define('Mini2.ui.form.field.NumRange', {

    extend: 'Mini2.ui.form.field.Base',

    alias: 'widget.numrange',

    isRangeControl: true,

    startItem: null,

    endItem: null,

    startCellEl: null,

    endCellEl: null,

    startValue: '',

    endValue: '',

    allowBlank: true,

    getFieldEl: function () {
        "use strict";
        var me = this,
            tableEl,
            rowEl,
            startCellEl,
            endCellEl;


        tableEl = Mini2.$joinStr([
            '<table class="mi-table-plain"  cellpadding="0" cellspacing="0" border="0" role="presentation" style="table-layout: auto;">',
                '<tbody>',
                    '<tr>',
                        '<td class="mi-item-cell-start"></td>',
                        '<td>&nbsp;-&nbsp;</td>',
                        '<td class="mi-item-cell-end"></td>',
                    '</tr>',
                '</tbody>',
            '</table>']);

        rowEl = tableEl.find('tr:first');

        me.startCellEl = startCellEl = rowEl.children('.mi-item-cell-start');
        me.endCellEl = endCellEl = rowEl.children('.mi-item-cell-end');

        me.startItem = Mini2.create('Mini2.ui.form.field.Number', {
            renderTo: startCellEl,
            hideLabel: true,
            clientId: me.clientId + '_Start',
            name: me.name + '_Start',
            allowBlank: me.allowBlank,
            value: me.startValue
        });


        me.endItem = Mini2.create('Mini2.ui.form.field.Number', {
            renderTo: endCellEl,
            hideLabel: true,
            clientId: me.clientId + '_End',
            name: me.name + '_End',
            allowBlank: me.allowBlank,
            value: me.endValue
        });


        return tableEl;
    },


    setStartValue: function (value) {
        var me = this,
            startItem = me.startItem;

        startItem.setValue(value);

        return me;
    },

    getStartValue: function () {
        var me = this,
            startItem = me.startItem;

        return startItem.getValue();
    },


    setEndValue: function (value) {
        var me = this,
            endItem = me.endItem;

        endItem.setValue(value);

        return me;
    },

    getEndValue: function () {
        var me = this,
            endItem = me.endItem;

        return endItem.getValue();
    },


    setValue: function (value) {
        var me = this;

        return me;
    },

    getValue: function () {

    },

    focus: function () {
        "use strict";
        var me = this,
            fieldEl = me.fieldEl,
            inputEl = me.startItem;

        Mini2.ui.FocusMgr.setControl(me.scope || me);

        //if (fieldEl) {
        //    fieldEl.addCls("mi-form-focus", me.focusCls);
        //}

        //me.el.addClass("mi-form-trigger-wrap-focus");


        //特殊处理，延时获取焦点。不然无法及时得到焦点。
        if (!me.readOnly && inputEl && inputEl.focus) {
            setTimeout(function () {
                inputEl.focus();
            }, 200);
        }
        return me;
    },

    render: function () {
        var me = this,
            bodyCls = 'td.mi-form-item-body:first',
            tableEl,
            fieldEl;


        tableEl = me.getTableContainer();

        fieldEl = me.getFieldEl();

        if (me.applyTo) {
            $(me.applyTo).replaceWith(tableEl);
        }
        else {
            $(me.renderTo).append(tableEl);
        }


        me.appendCell(tableEl, fieldEl, bodyCls);

        me.renderForLableable(tableEl);


        me.startItem.render();

        me.endItem.render();


        me.el = tableEl;

        tableEl.data('me', me);
    }



});


/************************************************************************/
/*                                           */
/*    ui/form/field/Radio.js                                               */
/*                                           */
/************************************************************************/


/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />


Mini2.define('Mini2.ui.form.field.Radio', {

    extend: 'Mini2.ui.form.field.CheckBox',
    alias: 'widget.radio',

    log: Mini2.Logger.getLogger('Mini2.ui.form.field.Radio'),

    alternateClassName: 'Mini2.ui.form.Radio',

    fieldCls: Mini2.baseCSSPrefix + '-form-type-radio',

    focusCls: Mini2.baseCSSPrefix + 'form-radio-focus',

    checkedCls: Mini2.baseCSSPrefix + 'form-cb-checked',


    inputType: 'radio',


    /**
    * 初始化原控件
    **/
    initSrcInput: function () {
        var me = this;

        var srcInputEl = Mini2.$joinStr(['<input type="radio" style="display:none;" />']);
        srcInputEl.attr('name', me.name)
            .attr('value', me.inputValue);

        me.srcInputEl = srcInputEl;
    },

    getFieldEl: function () {

        var me = this,
            inputEl;

        me.initSrcInput();

        me.inputEl = inputEl = Mini2.$joinStr(['<input type="button" class="mi-form-field mi-form-radio mi-form-cb " ',
            'autocomplete="off" ',
            'hidefocus="true" ',
            'aria-invalid="false" ',
            'data-errorqtip="" style="" >']);

        inputEl.attr("id", me.clientId);

        $(inputEl).muBind('mousedown', function (e) {

            me.focus();

            Mini2.EventManager.stopEvent(e);

        }).muBind('mouseup', function (e) {

            var isChecked = me.el.hasClass(me.checkedCls);

            //log.debug('me.checkedCls = ' + me.checkedCls);
            //log.debug('isChecked = '+ isChecked);

            if (!isChecked) {
                me.setValue(true);
            }

            //log.debug('me.checked=' + me.checked);

            Mini2.EventManager.stopEvent(e);
        });


        return inputEl;
    },


    renderForBoxLabel: function (tableEl) {
        "use strict";
        var me = this,
            boxLabel = me.boxLabel;

        if (boxLabel) {
            var boxLabelEl = Mini2.$joinStr([
                '<label class="mi-form-cb-label mi-form-cb-label-after" for="', me.clientId, '" >',
                    boxLabel,
                '</label>'
            ]);

            boxLabelEl.muBind('mousedown', function (e) { me.focus(); });
            boxLabelEl.muBind('mouseup', function (e) {

                if (!me.checked) {
                    me.setValue(!me.checked);
                }

                Mini2.EventManager.stopEvent(e);
            });

            me.boxLableEl = boxLabelEl;

            me.appendCell(tableEl, boxLabelEl, 'td.mi-form-item-body:first');
        }

    }


});


/************************************************************************/
/*                                           */
/*    ui/form/field/Image.js                                               */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />



Mini2.define('Mini2.ui.form.field.Image', {

    extend: 'Mini2.ui.form.field.Base',

    alias: 'widget.image',

    
    //normal | stretchimage | autosize | centerimage | zoom
    sizeMode: 'normal',

    initEvents: function () {


    },

    //图片地址
    value: null,
    

    getFieldEl: function () {

        var me = this,
            sizeMode = me.sizeMode,
            inputEl;

        me.inputEl = inputEl = Mini2.$joinStr([
            '<div class="mi-form-field mi-form-image" style="width:100%;height:auto; " >',
                '<img class="mi-form-image-item" src="" />',
            '</div>']);

        inputEl.attr("id", me.clientId);

        var imgEl = $(inputEl).children('.mi-form-image-item');

        imgEl.attr("src", me.value);

        console.log("sizeMode = ", sizeMode);

        //normal | stretchimage | autosize | centerimage | zoom
        if ('normal' == sizeMode) {
            inputEl.css('overflow', 'hidden');
        }
        else if ('zoom' == sizeMode) {
            inputEl.css('width', '100%');

            imgEl.css({ width: '100%' });
        }

        if (me.maxHeight) {
            inputEl.css('max-height', me.maxHeight);
        }

        if (me.height) {
            inputEl.css('height', me.height);
        }


        $(inputEl).muBind('mousedown', function (e) {

            me.focus();

            Mini2.EventManager.stopEvent(e);

        }).muBind('mouseup', function (e) {

            Mini2.EventManager.stopEvent(e);
        });


        return inputEl;
    },


    setValue: function (value) {
        var me = this,
            inputEl = me.inputEl,
            imgEl = $(inputEl).children('.mi-form-image-item');

        me.value = value;

        imgEl.attr('src', value);

        return value;
    }


});


/************************************************************************/
/*                                           */
/*    ui/form/field/ClipImage.js                                           */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../define.js" />


// 图像剪辑

Mini2.define('Mini2.ui.form.field.ClipImage', {

    extend: 'Mini2.ui.form.field.Trigger',

    alias: 'widget.clipimage',

    log: Mini2.Logger.getLogger('Mini2.ui.form.field.ClipImage', false),

    //normal | stretchimage | autosize | centerimage | zoom
    sizeMode: 'normal',

    initEvents: function () {


    },

    //绑定显示的字段名
    displayField: 'text',
    
    //绑定值的字段名
    valueField: 'value',

    //图片地址
    value: null,

    //初始化组件
    initComponent: function () {
        "use strict";
        var me = this,
            log = me.log;



        me.initStore();

        me.initLabelable();
    },





    getFieldEl: function () {
        "use strict";
        var me = this,
            sizeMode = me.sizeMode,
            inputEl;

        me.inputEl = inputEl = Mini2.$joinStr([
            '<div class="mi-form-field mi-form-image" style="width:100%;height:auto; " >',
                '<img class="mi-form-image-item" src="" />',
            '</div>']);

        inputEl.attr("id", me.clientId);

        var imgEl = $(inputEl).children('.mi-form-image-item');

        imgEl.attr("src", me.value);

        //console.log("sizeMode = ", sizeMode);

        //normal | stretchimage | autosize | centerimage | zoom
        if ('normal' == sizeMode) {
            inputEl.css('overflow', 'hidden');
        }
        else if ('zoom' == sizeMode) {
            inputEl.css('width', '100%');

            imgEl.css({ width: '100%' });
        }

        if (me.maxHeight) {
            inputEl.css('max-height', me.maxHeight);
        }

        if (me.height) {
            inputEl.css('height', me.height);
                       
        }



        $(inputEl).muBind('mousedown', function (e) {

            me.focus();

            Mini2.EventManager.stopEvent(e);

        }).muBind('mouseup', function (e) {

            Mini2.EventManager.stopEvent(e);
        });


        return inputEl;
    },


    setValue: function (value) {
        "use strict";
        var me = this,
            log = me.log,
            inputEl = me.inputEl,
            imgEl = $(inputEl).children('.mi-form-image-item'),
            record,
            store = me.store,
            imgSrc,
            displayField = me.displayField,
            valueField = me.valueField;

        me.value = value;

        //log.debug("setValue = ", value);

        record = store.filterFirstBy(valueField, value);

        //log.debug("record ", record);

        if (record) {
            me.curRecord = record;
            
            imgSrc = record.get(displayField);

        }
        else {
            imgSrc = null;
        }

        //log.debug("imgSrc = " ,imgSrc);

        imgEl.attr('src', imgSrc);

        return me;
    }

});


/************************************************************************/
/*                                           */
/*    ui/form/field/ProgressBar.js                                         */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="/Core/Scripts/Mini2/dev/Mini.js" />
/// <reference path="../../EventManager.js" />
/// <reference path="../../FocusManager.js" />


/**
* 进度条
* 需要 vue.js 
*/
Mini2.define('Mini2.ui.form.field.ProgressBar', {


    extend: 'Mini2.ui.form.field.Text',
    alias: 'widget.progressbar',

    log: Mini2.Logger.getLogger('Mini2.ui.form.field.ProgressBar'),

    allowDecimals: true,

    decimalSeparator: '.',

    submitLocaleSeparator: true,

    decimalPrecision: 2,

    minValue: Number.NEGATIVE_INFINITY,

    maxValue: Number.MAX_VALUE,

    step: 1,


    value: 0,
    defaultValue: 0,

    align: 'right',



    initComponent: function () {
        "use strict";
        var me = this,
            log = me.log;

        $(me).muBind('focusout', function () {


            if (me._focusTimeout) {
                clearTimeout(me._focusTimeout);
                delete me._focusTimeout;
            }


            me.fieldEl.removeClass("mi-form-focus");
            me.el.removeClass("mi-form-trigger-wrap-focus");

            me.clearInvalid();

        });

        me.initLabelable();
    },


    getValue: function () {
        "use strict";
        var me = this,
            defaultValue = me.defaultValue;

        var value = this.constructor.base.getValue.call(this);

        if (value == '') {
            return null;
        }

        value = Mini2.Number.from(value, defaultValue);


        return value;
    },

    setMinValue: function (value) {
        "use strict";
        var me = this,
            allowed;

        me.minValue = Mini2.Number.from(value, Number.NEGATIVE_INFINITY);
        me.toggleSpinners();

        // Build regexes for masking and stripping based on the configured options
        if (me.disableKeyFilter !== true) {
            allowed = me.baseChars + '';

            if (me.allowExponential) {
                allowed += me.decimalSeparator + 'e+-';
            }
            else {
                if (me.allowDecimals) {
                    allowed += me.decimalSeparator;
                }
                if (me.minValue < 0) {
                    allowed += '-';
                }
            }

            allowed = Mini2.String.escapeRegex(allowed);
            me.maskRe = new RegExp('[' + allowed + ']');
            if (me.autoStripChars) {
                me.stripCharsRe = new RegExp('[^' + allowed + ']', 'gi');
            }
        }
    },

    setMaxValue: function (value) {
        this.maxValue = Mini2.Number.from(value, Number.MAX_VALUE);
        this.toggleSpinners();
    },


    toggleSpinners: function () {
        "use strict";
        var me = this,
            value = me.getValue(),
            valueIsNull = value === null,
            enabled;

        // If it's disabled, only allow it to be re-enabled if we are
        // the ones who are disabling it.
        if (me.spinUpEnabled || me.spinUpDisabledByToggle) {
            enabled = valueIsNull || value < me.maxValue;
            me.setSpinUpEnabled(enabled, true);
        }


        if (me.spinDownEnabled || me.spinDownDisabledByToggle) {
            enabled = valueIsNull || value > me.minValue;
            me.setSpinDownEnabled(enabled, true);
        }
    },


    rawToValue: function (rawValue) {
        var value = this.fixPrecision(this.parseValue(rawValue));
        if (value === null) {
            value = rawValue || null;
        }
        return value;
    },


    valueToRaw: function (value) {
        var me = this,
            decimalSeparator = me.decimalSeparator;
        value = me.parseValue(value);
        value = me.fixPrecision(value);
        value = Mini2.isNumber(value) ? value : parseFloat(String(value).replace(decimalSeparator, '.'));
        value = isNaN(value) ? '' : String(value).replace('.', decimalSeparator);
        return value;
    },


    parseValue: function (value) {
        value = parseFloat(String(value).replace(this.decimalSeparator, '.'));
        return isNaN(value) ? null : value;
    },


    fixPrecision: function (value) {
        var me = this,
            nan = isNaN(value),
            precision = me.decimalPrecision;

        if (nan || !value) {
            return nan ? '' : value;
        } else if (!me.allowDecimals || precision <= 0) {
            precision = 0;
        }

        return parseFloat(Mini2.Number.toFixed(parseFloat(value), precision));
    },

    setSpinValue: function (value) {
        var me = this,
            len;

        //        if (me.enforceMaxLength) {
        //            // We need to round the value here, otherwise we could end up with a
        //            // very long number (think 0.1 + 0.2)
        //            if (me.fixPrecision(value).toString().length > me.maxLength) {
        //                return;
        //            }
        //        }
        me.setValue(value);
    },


    onSpinUp: function () {
        var me = this;

        if (!me.readOnly) {
            me.setSpinValue(Mini2.Number.constrain(me.getValue() + me.step, me.minValue, me.maxValue));
        }
    },


    onSpinDown: function () {
        var me = this;

        if (!me.readOnly) {
            me.setSpinValue(Mini2.Number.constrain(me.getValue() - me.step, me.minValue, me.maxValue));
        }
    },

    spinUpEnabled: function (enabled) {
        "use strict";
        var me = this;


        if (enabled) {
            me.onSpinUp();

            if (!me.spinUpDisabledByToggle) {
                me.spinUpDisabledByToggle = setInterval(function () {
                    me.onSpinUp();
                }, 200);
            }
        }
        else {

            if (me.spinUpDisabledByToggle) {
                clearInterval(me.spinUpDisabledByToggle);

                delete me.spinUpDisabledByToggle;
            }
        }
    },

    spinDownEnabled: function (enabled) {
        "use strict";
        var me = this;


        if (enabled) {
            me.onSpinDown();

            if (!me.spinDownDisabledByToggle) {

                me.spinDownDisabledByToggle = setInterval(function () {
                    me.onSpinDown();
                    //log.debug(me.getValue());
                }, 200);
            }
        }
        else {

            if (me.spinDownDisabledByToggle) {
                clearInterval(me.spinDownDisabledByToggle);

                delete me.spinDownDisabledByToggle;
            }
        }

    },

    btnUp_Click: function (e) {
        var me = e.data;

        me.onSpinUp();
        me.focus();
        Mini2.EventManager.stopEvent(e);
    },

    btnDown_Click: function (e) {
        var me = e.data;

        me.onSpinDown();
        me.focus();
        Mini2.EventManager.stopEvent(e);
    },




    getFieldEl: function () {
        "use strict";
        var me = this;

        //var tableEl = Mini2.$joinStr([
        //    '<table class="mi-form-trigger-wrap" cellpadding="0" cellspacing="0" style="table-layout: fixed; width: 100%; ">',
        //        '<tbody>',
        //            '<tr>',
        //                '<td class="mi-form-trigger-input-cell" style="width: 100%; "></td>',
        //            '</tr>',
        //        '</tbody>',
        //    '</table>']);

        //var inputEl = Mini2.$joinStr([
        //    '<div class="mi-progress">',
        //        '<span class="blue" style="width: 60%;"><span>60%</span></span>',
        //    '</div>'
        //]);

        var inputEl = '<mi-progressbar :ex_cls="ex_cls"  :value="value"></mi-progressbar>';


        //inputEl.attr("id", me.clientId);


        //inputEl.val(me.value);

        if (me.name) {
            //inputEl.attr('name', me.name);
        }

        //me.appendCell(tableEl, inputEl, 'td.mi-form-trigger-input-cell');

        me.inputEl = inputEl;



        return inputEl;
    },


    setValueCartoon:function(value){

        var me = this,
            vue = me.vue,
            oldValue = me.value || 0,
            newValue = value;

        new TWEEN.Tween({ num: oldValue })
          .easing(TWEEN.Easing.Quadratic.Out)
          .to({ num: newValue }, 500)
          .onUpdate(function () {
              vue.value = this.num.toFixed(0);
          })
          .start();
    },

    setValue:function(value){
        var me = this,
            vue = me.vue;

        if (vue && TWEEN) {
            me.setValueCartoon(value);
        }

        me.value = value;

        return me;
    },

    getValue:function(){
        var me = this;
        return me.value;
    },

    elemTpl: ['<div class="mi-progress">',
                '<span :class="[ex_cls]" style="min-width:0px;" :style="{width: value + \'%\'}">',
                    '<span>{{value}}%</span>',
                '</span>',
            '</div>'],


    /**
    * 注册 VUE 组件
    *
    */
    regVue:function(option){
        var me = this,
            cptName = 'mi-progressbar';


        Mini2.vue = Mini2.vue || {};
        Mini2.vue.component = Mini2.vue.component || {};

        if (!Mini2.vue.component[cptName]) {

            // 定义
            var miProgress = Vue.extend({
                template: Mini2.join( me.elemTpl),
                props: ['ex_cls', 'value'],
                methods: {

                }
            });

            // 注册
            Vue.component(cptName, miProgress);

            Mini2.vue.component[cptName] = true;
        }


        // 创建根实例
        me.vue = new Vue({
            el: '#' + me.id,
            data: option
        });


    },

    render: function () {
        var me = this;

        var value = me.value;

        me.baseRender();

        me.el.attr('id', me.id);

        //注册 vue 组件
        me.regVue({
            ex_cls: 'blue',
            value: 0
        });

        me.setValue(value);

        me.el.data('me', me);

    }


});



/************************************************************************/
/*                                           */
/*    ui/form/field/ListBox.js                                             */
/*                                           */
/************************************************************************/



/**
 * 列表控件
 *
 */
Mini2.define('Mini2.ui.form.field.ListBox', {

    extend: 'Mini2.ui.form.CheckboxGroup',

    alias: 'widget.listbox',


    height: 150,

    extraFieldBodyCls: false,
    
    getGroup_Table: function () {
        "use strict";
        var me = this,
            items = me.items,
            len = items.length,
            columns = me.repeatColumns,
            col, yuNum, row,
            tableEl,
            result,
            height = me.height;

        tableEl = Mini2.$join([
            '<div class="mi-checkbox-group-inner mi-form-trigger-wrap" style="overflow: auto; padding: 4px; border: 1px solid #CCCCCC;" >',
                '<table id="radiogroup-', me.muid, '-innerCt" class="mi-table-plain" cellpadding="0" role="presentation" style="table-layout: auto; width:100%;">',
                    '<tbody>',
                    '</tbody>',
                '</table>',
            '</div>'
        ]);


        if (height && height != 'auto') {
            tableEl.css('height', height);
        }



        if (columns == 'auto') {
            me.createGroupCell(tableEl, 1, len);

            result = { 'el': tableEl, 'row': 1, 'col': len };
        }
        else if (columns <= 1) {
            me.createGroupCell(tableEl, len, 1);

            result = { 'el': tableEl, 'row': len, 'col': 1 };
        }
        else {
            col = parseInt(columns);
            yuNum = len % col;
            row = len / (len - yuNum);

            if (yuNum > 0) { row++; }

            me.createGroupCell(tableEl, row, col);

            result = { 'el': tableEl, 'row': row, 'col': col };
        }


        $(tableEl).on('click', function () {

            me.focus();
        });


        return result;
    }

});


/************************************************************************/
/*                                           */
/*    ui/form/field/HtmlEditor.js                                          */
/*                                           */
/************************************************************************/

Mini2.define('Mini2.ui.form.field.HtmlEditor', {

    extend: 'Mini2.ui.form.field.Text',


    alias: 'widget.htmleditor',

    /**
     * 图片上传路径
     */
    imageUrl: '',

    /**
     * 文件上传路径
     */
    fileUrl: '',

    /**
    * 有焦点
    */
    hasFocus : false,


    getFieldEl: function () {
        "use strict";
        var me = this,
            inputEl ;




        me.inputEl = inputEl = Mini2.$join([
            '<textarea >',
            '</textarea>'
        ]);


        if (me.name) {
            inputEl.attr('name', me.name);
        }

        inputEl.attr("id", me.clientId);

        inputEl.css({
            'width': me.width,
            'height': me.height
        });


        if (me.readOnly) {
            inputEl.attr('readonly', 'readonly');
        }

        //附加属性
        //me.inputEl.attr("data-errorqtip", "");
        //

        //inputEl.addClass("mi-form-required-field");

        me.bindInputEl_Mouse(inputEl);
        me.bindInputEl_Key(inputEl);




        return inputEl;

    },


    _isValueChanged: false,

    /**
    * UEditor 是否已经准备好
    */
    isUEditReady: false,

    isValueChanged: function () {
        "use strict";
        var me = this;

        return me._isValueChanged;
    },


    getValue: function () {
        "use strict";
        var me = this,
            uedit = me.uedit,
            inputEl = me.inputEl;
        
        return inputEl.val();
    },

    setValue: function (value) {
        "use strict";
        var me = this,
            uedit = me.uedit,
            inputEl = me.inputEl;

        if (!me.hasFocus) {
            inputEl.val(value);

            if (me.isUEditReady) {
                uedit.setContent(value, false);
            }
        }
    },


    /**
    * 自动保存
    */
    autoSave:function(){
        var me = this,
            uedit = me.uedit;

        if (me.saveTimer) {

            me.saveTimer.resetStart();
        }
        else {
            me.saveTimer = Mini2.setTimer(function () {

                var html = uedit.getContent();

                me.inputEl.val(html);

                me._isValueChanged = true;

                var owner = me.ownerParent;

                if (owner && owner.setStoreRecrod) {
                    owner.setStoreRecrod.call(owner, me);
                }

            },{
                interval: 1000,
                limit: 1
            });
        }
    },


    render: function () {
        "use strict";
        var me = this,
            uedit,
            hideEl,
            bodyCls = '.mi-form-item-body:first';


        me.baseRender();

        me.el.data('me', me);


        //var imageUrl = Mini2.urlAppend('/App/InfoGrid2/View/CMS/CmsUploadHandler.aspx', {
        //    method: 'image_up',
        //    module: 'tile',
        //    cata_code: '',
        //    item_id: 123

        //}, true);

        me.uedit = uedit = UE.getEditor(me.clientId, {
            autoHeightEnabled: false,
            initialFrameHeight: 400,
            scaleEnabled: false,
            imageUrl: me.imageUrl,
            imagePath: '',
            maxImageSideLength:9000 //防止被压缩
        });


        //判断ueditor 编辑器是否创建成功
        uedit.addListener("ready", function () {

            me.isUEditReady = true;

        });

        uedit.addListener('focus', function (editor) {
            me.hasFocus = true;

            me.focus();
        });

        uedit.addListener('blur', function (editor) {
            me.hasFocus = false;

            me.autoSave();
        });

        uedit.addListener('selectionchange', function (editor) {
            me.autoSave();
        });



    }

});


/************************************************************************/
/*                                           */
/*    ui/form/field/FileUpload.js                                          */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />



//文件上传
Mini2.define('Mini2.ui.form.field.FileUpload', {


    extend: 'Mini2.ui.form.field.Base',

    alias: 'widget.fileupload',

    /**
    * 启动上传分块. 默认:false
    */
    chunked:false,


    //renderTpl: [
    //    '<div>',
    //        '<div style="border: 1px solid #CCCCCC; height:250px; width:250px; background-color: #F0F0F0; margin:2px;">',
    //            '<img src="" style="width:100%;">',
    //        '</div>',

    //    '</div>'
    //],


    buttonTpl:[
        '<a class="mi-btn ',
            'mi-unselectable ',
            'mi-btn-default-small ',
            '" ',
            'style="margin-left: 6px;" ',
            'role="button" hidefocus="on" unselectable="on" tabindex="0" >',

            '<input type="hidden" class="temp_value" value="" />',    //临时名称
            '<input type="hidden" class="value" />',                    //正式路径
            '<div class="progress" style="display:none; height:100%;width:20%; background-color:#ffffff;opacity:0.50; position:absolute;overflow:hidden; top:0px;left:0px;">',

            '</div>',
            '<span class="mi-btn-wrap" unselectable="on">',
            '</span>',
        '</a>'
    ],


    innerHtmlTpl: [
   
        '<span class="mi-btn-button">',
            '<span class="mi-btn-inner mi-btn-inner-center" unselectable="on">选择文件</span>',

        '</span>'
   
    ],

    //图像缩略图插件
    imageThumbPlugin:{

        htmlTpl: [
            '<div class="thumb" style="border: 1px solid #ddd; height:110px; width:110px; background-color: #FFFFFF; margin-bottom:4px; padding:4px; ',
                'border-radius: 4px;',
                '-webkit-box-shadow: 0 1px 2px rgba(0,0,0,0.075);box-shadow: 0 1px 2px rgba(0,0,0,0.075);',
                'display: block;">',
                '<div class="thumb-inner" style=" overflow:hidden;width:100px;height:100px;">',
                    '<img class="thumb-img" src="" style="height:100%;" />',
                '</div>',
            '</div>'
        ]


    },

    formType:'full',

    //fileUrl: '', //上传文件路径
    isUserUrl: false,   //自定义 url

    //插件类型。 none=没有， image=图片类型，other_file=其它文件
    pluginType: 'image',

    thumbWidth: 100,
    thumbHeight: 100,

    thumbEl : null, //预览对象


    valueEl: null,      //正式值的隐藏 dom
    tempValueEl:null,   //临时值的隐藏 dom 

    //server: '/View/Sample/WebForm1.aspx',

    widgetActionUrl: '/Core/Mini/EcWidgetAction.aspx',

    //appRelativeVirtualPath :  'InfoGrid2/View/Sample/XSS',


    text: '选择文件',
    
    //是否已经初始化预览
    isPreviewed :false,

    setValue:function(value){
        var me = this,
            pluginType = me.pluginType,
            valueEl = me.valueEl,
            thumbEl = me.thumbEl;

        valueEl.val(value);


        if (pluginType == 'image' ) {

            value = value || '';

            var imgEl = thumbEl.find('.thumb-img');

            var lines = value.split('||');

            imgEl.attr('data-original', lines[0]);

            if (imgEl && $.fn.viewer) {
                if (!me.isPreviewed) {

                    me.isPreviewed = true;

                    imgEl.viewer({
                        url: 'data-original'
                    });
                }
                else {
                    imgEl.viewer('update');
                }
            }


        }

        return me;
    },

    getValue: function () {
        var me = this,
            valueEl = me.valueEl,
            value;

        value = valueEl.val();

        return value;
    },

    setTempValue:function(value){
        var me = this,
            pluginType = me.pluginType,
            tempValueEl = me.tempValueEl;

        tempValueEl.val(value);

        if (pluginType == 'image') {

            me.thumbEl.find('.thumb-img').attr('src', value);
        }

        return me;
    },


    request:function() {
        var url = location.href,
            i, newStr,
            paraString;

        paraString = url.substring(url.indexOf("?") + 1, url.length).split("&");

        newStr = "";

        for (i = 0; j = paraString[i]; i++) {
            if (i > 0) {
                newStr += "$$$";
            }

            newStr += j ;
        }

        if (this.tag) {
            newStr += "$$$" + "tag=" + encodeURIComponent(this.tag);
        }

        

        return newStr;
    },

    DefaultParams : {
        __Path: '',
        __CID: '',
        __PID: '',
        __IsUser: 1,
        __Lang: '',
        __WidgetPs: '',
        __Action: '',
        __ActionPs: '',
        __ReturnFormat: '',
        __IsPost: '1',
        __SubName: '',
        __SubEvent: ''
    },

    getFieldEl:function(){
        var me = this,
            el,
            uploader,
            tempValueEl,
            valueEl,
            pluginType = me.pluginType,
            thumb = me.imageThumbPlugin;

        var widgetUriObj = {
            __Path: encodeURI(me.appRelativeVirtualPath),
            __Action: '',
            __ActionPs: '',
            __CID: 'widget1_I',
            __ReturnFormat: "script",
            __SubName: me.id,
            __SubMethod: 'OnUploader',
            __Query: me.request()
        };

        el = Mini2.$join(me.buttonTpl);

        if ('image' == pluginType ) {

            var thumbEl = Mini2.$join(thumb.htmlTpl);

            thumbEl.css({
                width: (me.thumbWidth + 10) + 'px',
                height: (me.thumbHeight + 10) + 'px'
            });

            $(thumbEl).children('.thumb-inner').css({
                width: me.thumbWidth  + 'px',
                height: me.thumbHeight + 'px' 
            });

            thumbEl.find('.thumb-img').attr('src', me.value).attr('data-original', me.value);

            var boxEl = $('<div></div>');

            boxEl.append(thumbEl);

            boxEl.append(el);

            el = boxEl;

            me.thumbEl = thumbEl;
        }


        el.attr('id', me.clientId);


        //if (me.applyTo) {
        //    $(me.applyTo).replaceWith(el);
        //}
        //else {
        //    $(me.renderTo).append(el);
        //}


        me.tempValueEl = tempValueEl = el.find('.temp_value:first');
        me.valueEl = valueEl = el.find('.value:first');

        tempValueEl.attr('name', me.clientId + '_temp_value');
        valueEl.attr('name', me.clientId + '_value')

        if (me.temp_value) {
            tempValueEl.val(me.temp_value);
        }

        if (me.value) {
            valueEl.val(me.value);
        }

        var url;

        if (!Mini2.String.isBlank(me.fileUrl)) {
            url = me.fileUrl;
            me.isUserUrl = true;
        }
        else {
            url = me.widgetActionUrl + "?" + $.param(widgetUriObj);
        }


        var innerHtmlTpl = [
            '<span class="mi-btn-button">',
                '<span class="mi-btn-inner mi-btn-inner-center" unselectable="on">' , me.text, '</span>',

            '</span>'
        ];

        me.uploader = uploader = new WebUploader.Uploader({
            swf: '\Core\Scripts\webuploader-0.1.5\Uploader.swf',
            pick: {
                id: el.find('.mi-btn-wrap:first'),
                multiple: true,
                innerHTML: Mini2.$join(innerHtmlTpl)
            },

            fileVal: me.clientId,

            // 文件接收服务端。
            server: url,

            auto: true,

            chunked: me.chunked, //分块

            resize: false



            // 其他配置项
        });



        if ('image' == pluginType) {
            uploader.on('fileQueued', function (file) {

                uploader.makeThumb(file, function (error, ret) {
                    if (error) {
                        console.error('预览错误');
                    }
                    else {
                        me.thumbEl.find('.thumb-img').attr('src', ret);
                    }
                }, me.thumbWidth, me.thumbHeight);

            });
        }

        uploader.on('startUpload', function () {

            var data = {};

            if ('full' == me.formType) {
                var formData = $('form:first').formToArray();

                for (var i = 0; i < formData.length; i++) {
                    var fd = formData[i];

                    data[fd.name] = fd.value;
                }
            }
            else if ('sample' == me.formType ) {
                //简单模式

                data[me.clientId + '_temp_value'] = me.tempValueEl.val();
                data[me.clientId + '_value'] = me.valueEl.val();
            }

            uploader.options.formData = data;

            $(el).find('.progress').show();
        });

        // 文件上传过程中创建进度条实时显示。
        uploader.on('uploadProgress', function (file, percentage) {
            //var $li = $('#' + file.id),
            //    $percent = $li.find('.progress span');

            //// 避免重复创建
            //if (!$percent.length) {
            //    $percent = $('<p class="progress"><span></span></p>')
            //            .appendTo($li)
            //            .find('span');
            //}

            //$percent.css('width', percentage * 100 + '%');

            var perText = percentage * 100 + '%';

            $(el).find('.progress').css('width', perText);
            $(el).find('.mi-btn-inner-center').text('已上传 ' + perText);
        });

        // 文件上传成功，给item添加成功class, 用样式标记上传成功。
        uploader.on('uploadSuccess', function (file, response) {
            console.log("上传完成", file);

            if (me.isUserUrl) {

                var url = response.url;
                console.debug("反馈回的路径: " + url);

                var valueEl = me.valueEl;
                valueEl.val(url);

               

                if (me.thumbEl && $.fn.viewer) {

                    me.thumbEl.find('.thumb-img').attr('data-original', url);

                    if (!me.isPreviewed) {

                        me.isPreviewed = true;

                        me.thumbEl.viewer({
                            url: 'data-original'
                        });
                    }
                    else {
                        me.thumbEl.viewer('update');
                    }
                }

                //me.setValue(response.url);

                /**
                * 注意: 触发这个事件,是给上级控件作为监控, 并自动保存
                */
                me.trigger('focusout'); 

                var owner = me.ownerParent;

                if (owner && owner.setStoreRecrod) {
                    owner.setStoreRecrod.call(owner, me);
                }

                me.trigger('uploadSuccess', response);

            }
            else {
                try {
                    var raw = response._raw + '';

                    eval( raw );

                }
                catch (ex) {
                    console.error('解析对象出错。' + ex.message + '\r\n' + response._raw);
                }
            }
        });

        // 文件上传失败，显示上传出错。
        uploader.on('uploadError', function (file, reason) {

            console.error("上传出错");
        });

        // 完成上传完了，成功或者失败，先删除进度条。
        uploader.on('uploadComplete', function (file) {
            //console.log("完成上传完了....", file);

            $(el).find('.mi-btn-inner-center').text(me.text);

            $(el).find('.progress').hide();
        });

        return el;
    },



    //设置新的地址
    setTag: function (tagString) {
        var me = this,
            uploader = me.uploader;

        me.tag = tagString;

        var widgetUriObj = {
            __Path: encodeURI(me.appRelativeVirtualPath),
            __Action: '',
            __ActionPs: '',
            __CID: 'widget1_I',
            __ReturnFormat: "script",
            __SubName: me.id,
            __SubMethod: 'OnUploader',
            __Query: me.request()
        };


        var url;

        if (!Mini2.String.isBlank(me.fileUrl)) {
            url = me.fileUrl;
            me.isUserUrl = true;
        }
        else {
            url = me.widgetActionUrl + "?" + $.param(widgetUriObj);
        }

        try {

            console.debug(uploader);

            uploader.options.server = url;
        }
        catch (ex) {
            console.error("设置 tag 属性错误", ex);
        }
    }



});


/************************************************************************/
/*                                           */
/*    ui/form/field/MoreFileUpload.js                                      */
/*                                           */
/************************************************************************/

/**
* 多文件上传
*
*
*/

Mini2.define('Mini2.ui.form.field.MoreFileUpload', {

    extend: 'Mini2.ui.form.field.Text',

    alias: 'widget.morefileupload',

    dataType: 'text',

    imageUrl: '',

    fileUrl: '',

    thumbWidth: 100,
    thumbHeight: 100,

    hideThumbTitle: false,


    height: 270,

    /**
    * 展示模式 .editor=编辑模式, preview=预览模式
    */
    displayMode: 'editor',

    /**
    * 分割线, 分区普通文件和正常文件
    */
    slicer: true,

    /**
    * 图片容器
    */
    imagePanelEl: null,

    /**
    * 其它文件容器
    */
    otherPanelEl: null,

    getFieldEl: function () {
        "use strict";
        var me = this,
            slicer = me.slicer, //分割线
            innerEl,
            inputEl;


        var height = parseInt(me.height);

        if ('editor' == me.displayMode) {

            me.inputEl = inputEl = Mini2.$join([
                '<div class="mi-file-panel" >',
                    '<div class="file-inner"  style="border: 1px solid #ddd; padding:10px; height:', height - 60, 'px; overflow: auto;">',

                    '</div>',
                    '<div class="mi-file-toobar"  style="border: 1px solid #ddd; padding:6px;height:50px;" >',
                        '<div class="upload-button" style="flow:left;"></div>',
                        '<button type="button" class="remove-btn" style="float:left;">删除</button>',
                    '</div>',
                '</div>'
            ]);
        }
        else if ('preview' == me.displayMode) {

            me.inputEl = inputEl = Mini2.$join([
                '<div class="mi-file-panel" >',
                    '<div class="file-inner"  style="border: 1px solid #ddd; padding:10px; height:', height - 60, 'px; overflow: auto;">',

                    '</div>',
                    '<div class="mi-file-toobar"  style="border: 1px solid #ddd; padding:6px;height:40px;" >',
                        '<button type="button" class="editor-btn" style="float:left; width:80px;">编辑</button>',
                    '</div>',
                '</div>'
            ]);


            $(inputEl).find('.editor-btn').click(function () {

                me.onButtonClick();
            });

        }

        me.fileInnerEl = innerEl = $(inputEl).children('.file-inner');

        if (me.maxHeight) {
            var mh = parseInt(me.maxHeight) - 50;
            innerEl.css('max-height', mh + 'px');
        }

        if (me.minHeight) {
            var mh = parseInt(me.minHeight) - 50;
            innerEl.css('min-height', mh + 'px');
        }


        if (slicer && 'preview' == me.displayMode) {

            var otherPanelEl = Mini2.$join([
                '<div role="other-file-panel" style="height:auto; margin-bottom:10px; padding-bottom:10px; border-bottom: 1px solid #dddddd;">',

                '</div>'
            ]);

            var imagePanelEl = Mini2.$join([
                '<div role="image-file-panel" style="height:auto;">',

                '</div>'
            ]);

            innerEl.append(otherPanelEl);
            innerEl.append(imagePanelEl);

            me.imagePanelEl = imagePanelEl;
            me.otherPanelEl = otherPanelEl;
        }
        else {
            me.imagePanelEl = innerEl;
            me.otherPanelEl = null;
        }


        inputEl.attr("id", me.clientId);

        $(inputEl).find('.upload-button').attr('id', me.clientId + '_UploadBtn');

        inputEl.css({
            'width': me.width,
            'height': me.height
        });


        if (me.readOnly) {
            inputEl.attr('readonly', 'readonly');
        }

        return inputEl;

    },


    _isValueChanged: false,


    isValueChanged: function () {
        "use strict";
        var me = this;

        return me._isValueChanged;
    },


    items: false,


    clear: function () {
        "use strict";
        var me = this,
            imagePanelEl = me.imagePanelEl,
            otherPanelEl = me.otherPanelEl,
            hideEl2 = me.hideEl2;

        me.items = [];

        imagePanelEl.children().remove();

        if (otherPanelEl) {
            otherPanelEl.children().remove();
        }

        if (hideEl2) {
            hideEl2.val('');
        }

        return me;
    },

    removeSeleted: function () {
        "use strict";
        var me = this,
            imagePanelEl = me.imagePanelEl,
            otherPanelEl = me.otherPanelEl,
            inputEl = me.inputEl,
            items = me.items,
            hideEl2 = me.hideEl2;

        console.debug('imagePanelEl = ', imagePanelEl);

        var checkEls = imagePanelEl.children('.mi-file-check');

        console.log("选中的图片数量: ", checkEls.length);

        for (var i = 0; i < checkEls.length; i++) {

            var checkEl = checkEls[i];

            var file_id = $(checkEl).attr('data-file-id');

            var n = Mini2.Array.indexOf(items, function () {
                return (this.file_id == file_id);
            });



            if (n >= 0) {
                items.splice(n, 1);
            }
        }

        checkEls.remove();

        me.autoSave();

        if (hideEl2) {
            var newValueStr = me.getValue();
            hideEl2.val(newValueStr);
        }
    },


    getValue: function () {
        "use strict";
        var me = this,
            items = me.items || [],
            txt, i, item,
            hideEl2 = me.hideEl2;

        if ('text' == me.dataType) {

            txt = '';

            for (i = 0; i < items.length; i++) {

                if (i > 0) { txt += '\n'; }

                item = items[i];


                txt += Mini2.join([item.url, '||', item.thumb_url, '||', item.title, '||', item.code]);

            }

            return txt;

        }


    },

    setValue: function (value) {
        "use strict";
        var me = this,
            inputEl = me.inputEl,
            hideEl2 = me.hideEl2;

        me.clear();


        if (Mini2.isBlank(value)) {
            return;
        }


        if ('text' == me.dataType) {

            var lines = value.split('\n');

            for (var i = 0; i < lines.length; i++) {

                var text = lines[i];

                if (Mini2.String.isBlank(text)) {
                    continue;
                }

                try {
                    me.addForText(text);
                }
                catch (ex) {
                    console.error("text", text);
                    console.error('添加对象失败', ex);
                }
            }

        }
        else if ('josn' == me.dataType) {

            if (Mini2.isString(value)) {
                try {
                    value = JSON.parse(value);
                }
                catch (ex) {
                    console.error("json 转化为 对象失败. ", value);
                }
            }

            for (var i = 0; i < value.length; i++) {

                var cfg = value[i];

                try {
                    me.add(cfg);
                }
                catch (ex) {
                    console.error("cfg", cfg);
                    console.error('添加对象失败', ex);
                }
            }
        }


        //if (hideEl2) {
        //    hideEl2.val(value);
        //}
    },

    //是否已经初始化预览窗体
    isPreviewed: false,

    /**
     * 预览的元素
     */
    previewEl: null,

    add: function (cfg) {
        "use strict";
        var me = this,
            innerEl = me.fileInnerEl,
            items = me.items,
            inputEl = me.inputEl,
            hideEl2 = me.hideEl2;


        if (!items) {
            me.items = items = [];
        }


        var fileId = "file" + Mini2.newId();

        cfg.file_id = fileId;   //临时id, 使用

        var fileEl = me.createFileEl(cfg);

        items.push(cfg);

        if (fileEl.hasClass('image')) {
            me.imagePanelEl.append(fileEl);
        }
        else {
            if (me.otherPanelEl) {
                me.otherPanelEl.append(fileEl);
            }
            else {
                me.imagePanelEl.append(fileEl);
            }
        }

        var xdd = me.imagePanelEl.html();

        //如果有 $.fn.viewer 多功能图片预览框
        if (window.Viewer) {

            me.initPreviewEl();

        }
        else {
            fileEl.attr('rel', 'boxer' + me.muid)
            fileEl.boxer({

            });
        }

        if (hideEl2) {

            var fileListStr = hideEl2.val();
            fileListStr += "\n" + (cfg.url + "||" + cfg.thumb_url + "||" + cfg.title + "||" + (cfg.code || ''));

            hideEl2.val(fileListStr);
        }

        return me;
    },


    initPreviewTime: null,

    /**
     * 初始化预览元素
     */
    initPreviewEl: function () {
        var me = this,
            time = me.initPreviewTime;


        if (time) {
            time.resetStart();
            return;
        }

        me.initPreviewTime = Mini2.setTimer(function () {
            
            if (me.previewEl) {
                me.previewEl.update();
            }
            else {
                me.previewEl = new Viewer(me.imagePanelEl[0], {
                    url: 'data-original'
                });
            }

        }, [1000, 1])

    },


    addForText: function (cfg) {
        var me = this,
            items = me.items,
            innerEl = me.fileInnerEl,
            inputEl = me.inputEl,
            hideEl2 = me.hideEl2 //这个对象在初始化的时候, 还未出现;



        if (Mini2.isString(cfg)) {

            var ps = cfg.split('||');

            cfg = {
                thumb_url: ps[1] || ps[0],
                url: ps[0],
                title: ps[2],
                code: ps[3]
            };
        }

        me.add(cfg);

        return me;
    },

    getUrlFilename: function (url) {

        var qIndex = url.indexOf('?');

        if (qIndex > 0) {
            url = url.substring(0, qIndex);
        }

        var arrUrl = url.split("/");
        var strPage = arrUrl[arrUrl.length - 1];

        return strPage;
    },

    createFileEl: function (cfg) {
        "use strict";
        var me = this,
            slicer = me.slicer,
            strPage,
            fileEl;
        
        strPage = me.getUrlFilename(cfg.url);

        var ldot = strPage.lastIndexOf(".");
        var type = strPage.substring(ldot).toLowerCase();

        var isImage = false;


        

        if (type == '.jpg' || type == '.jpeg' || type == '.gif' || type == '.png' || type == '.bmp') {
            isImage = true;
        }

        if ('editor' == me.displayMode) {
            fileEl = Mini2.$join([
                '<div class="mi-file thumb " style="" title="', cfg.title, '">',
                '<div class="mi-file-inner thumb-inner" style="width:', me.thumbWidth, 'px;height:', me.thumbHeight,'px;">',
                        '<img class="mi-file-image thumb-img" src="', cfg.thumb_url || cfg.url, '" data-original="', cfg.url || cfg.thumb_url, '" style="height:100%;">',
                    '</div>',
                    '<div class="mi-file-mask"></div>',
                    '<div class="mi-checkbox"></div>',                        
                '</div>',
            ]);

            if (!me.hideThumbTitle) {

                fileEl.append(Mini2.$join([
                    '<div class="mi-file-text" title="', strPage, '">',
                    strPage,
                    '</div>'
                ]));
            }

            $(fileEl).children('.mi-checkbox').muBind('click', function () {


                if ($(fileEl).hasClass('mi-file-check')) {
                    $(fileEl).removeClass('mi-file-check');
                }
                else {
                    $(fileEl).addClass('mi-file-check');
                }
            });



        }
        else if ('preview' == me.displayMode) {

            var thumbUrl = cfg.thumb_url || cfg.url;
            var srcUrl = cfg.url || cfg.thumb_url;

            if (slicer && !isImage) {
                fileEl = Mini2.$join([
                    '<a class="" style="display:block;margin-bottom:6px;" target="_blank" href="', cfg.url, '" title="', cfg.title, '">',
                    '<img class="mi-file-image" src="', thumbUrl, '" style="height:16px;height:16px; margin-right:4px;">',
                        '<span>', cfg.title, '</span>',
                    '</a>'
                ]);
            }
            else {
                fileEl = Mini2.$join([
                    '<div class="mi-file thumb " style=""  title="', cfg.title, '">',
                    '<div class="mi-file-inner thumb-inner" style="width:', me.thumbWidth, 'px;height:', me.thumbHeight, 'px;">',
                    '<img class="mi-file-image thumb-img" src="', thumbUrl, '" data-original="', srcUrl, '" style="height:100%;">',
                        '</div>',

                    '</div>',
                ]);
                

                if (!me.hideThumbTitle) {

                    fileEl.append(Mini2.$join([
                        '<div class="mi-file-text" title="', strPage, '">',
                        strPage,
                        '</div>'
                    ]));
                }
            }

        }


        if (isImage) {
            fileEl.addClass('image');
        }
        else {
            var typeName = type.substring(1);

            $(fileEl).find('.mi-file-image').attr('src', '/res/file_icon_256/' + typeName + '.png');
        }

        fileEl.attr('data-file-id', cfg.file_id);


        return fileEl;
    },

    autoSave: function () {
        "use strict";
        var me = this;

        me._isValueChanged = true;

        var owner = me.ownerParent;

        if (owner && owner.setStoreRecrod) {
            owner.setStoreRecrod.call(owner, me);
        }
    },

    /**
    * 附加一个隐藏元素
    */
    appendHideEl: function () {
        "use strict";
        var me = this,
            hideEl2 = me.hideEl2,
            bodyCls = '.mi-form-item-body:first';

        //return;

        console.debug("隐藏项目....+++++++++++++++++++++++++");

        me.hideEl2 = hideEl2 = Mini2.$join([
            '<input type="hidden"  />'
        ]);

        if (me.name) {
            hideEl2.attr('name', me.name);
        }

        console.debug("附加的值 :", me.oldValue);

        hideEl2.val(me.oldValue);

        me.appendCell(me.el, hideEl2, bodyCls);
    },

    appendUploadBtn: function () {
        "use strict";
        var me = this;


        var uploadBtn = Mini2.create('Mini2.ui.form.field.FileUpload', {

            id: me.id + '_UploadBtn',
            clientId: me.clientId + '_UploadBtn',

            hideLabel: true,
            pluginType: 'other',

            fileUrl: me.fileUrl,
            dock: 'left',
            applyTo: '#' + me.clientId + '_UploadBtn'

        });

        uploadBtn.render();

        uploadBtn.bind('uploadSuccess', function (response) {

            var r = response;
            //var ttt = r.url + '||' + (r.thumb_url || r.url) + '||' + r.original + '||' + (r.code || '')

            var cfg = {
                url: r.url,
                thumb_url: r.thumb_url || r.url,
                title: r.original,
                code: r.code || ''

            };



            me.add(cfg);

            me.autoSave();

            me.callParent();
        });


        if (uploadBtn.el) {
            uploadBtn.el.css({
                'float': 'left',
                width: 0,
                marginRight: '6px'
            });
        }


    },


    //引发事件
    onButtonClick: function () {




        var me = this,
            ownerParent = me.ownerParent,
            store = ownerParent.store,
            record = store.getCurrent();

        var urlStr = Mini2.urlAppend('/App/InfoGrid2/View/OneForm/Dialogs/MoreFileDialog.aspx', {
            table: store.modelName,
            field: me.dataField,
            row_pk: record.getId(),
            tag_code: me.tagCode || 'sub_file'
        }, true);


        var win = Mini2.createTop('Mini2.ui.Window', {
            width: 800,
            height: 600,
            url: urlStr,
            mode: true,
            text: '文件管理'
        });

        win.formClosed(function (e) {

            if (e.success) {

                try {
                    console.debug('界面关闭: ', e);

                    record.set(me.dataField, e.data);
                    //record.afterCommit([me.dataIndex]);
                }
                catch (ex) {
                    console.error("刷新数据仓库错误.", ex);
                }
            }

        });

        win.show();

    },

    render: function () {
        "use strict";
        var me = this,
            el,
            hideEl2;


        me.baseRender();

        el = me.el;



        //$(me.inputEl).find('.remove-btn').click(function () {

        //    me.removeSeleted();
        //});

        if ('editor' == me.displayMode) {

            me.appendHideEl();

            var delBtn = Mini2.create('Mini2.ui.button.Button', {
                text: '删除',
                width: 80,
                height: 28,
                applyTo: el.find('.remove-btn'),
                click: function () {
                    me.removeSeleted();
                }
            });

            delBtn.render();

            delBtn.el.css({ 'float': 'right' });

            me.appendUploadBtn();
        }

        me.el.data('me', me);


    }


});





/**
* 配合多文件列的, 多文件上传
*
*
*/
Mini2.define('Mini2.ui.form.field.MoreFileEditor', {

    extend: 'Mini2.ui.Component',

    buttonCls: 'mi-icon-more',


    //初始化组件
    initComponent: function () {

        var me = this;

        me.fieldCls = 'mi-form-type-text';

        $(me).muBind('focusout', function () {


            console.debug("失去焦点..");

            me.el.removeClass("mi-form-trigger-wrap-focus");

            //me.clearInvalid();

        });


    },


    focus: function () {
        var me = this;

        console.debug("获取焦点..");

        me.el.addClass('mi-form-trigger-wrap-focus');

        Mini2.ui.FocusMgr.setControl(me, null, me.scope);

        return me;
    },


    getFieldEl: function () {
        var me = this,
            log = me.log,
            tableEl,
            btnEl;

        tableEl = Mini2.$join([
            '<div class="" style="width: 120px;  position: relative; ">',

            '</div>'
        ]);


        btnEl = Mini2.$join(['<div role="button" class="mi-form-trigger mi-form-arrow-trigger " style="position: absolute;right:0px;background-color:#fff;border-color: #157fcc;    border-width: 1px; border-style: solid;" ></div>']);

        tableEl.append(btnEl);

        me.buttonEl = btnEl;

        if (me.buttonCls) {
            btnEl.addCls(me.buttonCls);
        }

        btnEl.click(function () {

            me.onButtonClick();


        });

        return tableEl;
    },


    setWidth: function (value) {
        var me = this;

        me.el.css('width', value);

    },


    //引发事件
    onButtonClick: function () {
        var me = this,
            record = me.record,
            store = record.store;

        console.debug("文件编辑", me);

        var urlStr = Mini2.urlAppend('/App/InfoGrid2/View/OneForm/Dialogs/MoreFileDialog.aspx', {
            table: store.modelName,
            field: me.dataIndex,
            row_pk: record.getId(),
            tag_code: me.tagCode || 'sub_file'
        }, true);


        var win = Mini2.createTop('Mini2.ui.Window', {
            width: 800,
            height: 600,
            url: urlStr,
            mode: true,
            text: '文件管理'
        });

        win.formClosed(function (e) {

            if (e.success) {

                try {
                    console.debug('界面关闭: ', e);

                    record.set(me.dataIndex, e.data);
                    //record.afterCommit([me.dataIndex]);
                }
                catch (ex) {
                    console.error("刷新数据仓库错误.", ex);
                }
            }

        });

        win.show();

    },


    value: null,

    setValue: function (value) {
        var me = this;

        console.debug("设置值...", value);

        me.value = value;

        return me;
    },

    getValue: function () {

        var me = this;

        return me.value;
    },


    render: function () {

        var me = this;

        var el = me.getFieldEl();

        if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else {
            $(me.renderTo).append(el);
        }

        el.data('me', me);

        me.el = el;


        return me;

    }

});



/************************************************************************/
/*                                           */
/*    ui/form/field/CodeEditor.js                                          */
/*                                           */
/************************************************************************/



Mini2.define('Mini2.ui.form.field.CodeEditor', {

    extend: 'Mini2.ui.form.field.Text',

    alias: 'widget.codeeditor',
    cols: 20,

    rows: 4,

    extraFieldBodyCls:'mi-code-editor-panel',


    mode: 'text/x-csharp',

    setValue: function (value) {
        var me = this,
            hideEl = me.hideEl,
            codeEl = me.codeEl,
            editor = me.editor;

        me.value = value;
        codeEl.val(value);

        if (editor && value) {
            try{
                editor.setValue(value);
            }
            catch (ex) {
                console.debug('editor.setValue(...) = ', value);
                console.error('代码编辑框赋值错误. ', ex);
            }
        }

        if (hideEl) {
            hideEl.val(value);
        }

        return me;
    },

    getValue: function () {
        var me = this,
            hideEl = me.hideEl,
            inputEl = me.inputEl,
            value;

        return me.value;

        //if (me.readOnly && hideEl) {
        //    value = hideEl.val();
        //}
        //else {
        //    value = me.codeEl.val();
        //}

        return value;
    },

    setSize:function(width, height){
        var me = this;

        console.debug("dddddddddddddd", height);
    },

    setHeight: function (value) {
        var me = this,
            editor = me.editor;

        me.height = value;
        me.el.css('height', value);

        if (editor) {
            editor.setSize("100%", me.height + 'px');
        }

        return me;
    },

    getFieldEl: function () {

        var me = this,
            inputEl,
            codeEl;


        me.inputEl = inputEl = Mini2.$joinStr([
            '<div>',
                '<div role="toolbar"></div>',
                '<textarea class="code-box" style="display:none;">',
                '</textarea>',
            '</div>'
        ]);

        me.codeEl = codeEl = $(inputEl).children('.code-box');

        //return inputEl;

        //me.inputEl = inputEl = Mini2.$joinStr([
        //    '<textarea class="mi-form-field mi-form-text mi-form-textarea" ',
        //        'aria-invalid="false" style="width: 100%;resize: none; " ',
        //        'spellcheck="false" autocapitalize="off" autocomplete="off" autocorrect="off">',
        //    '</textarea>']);


        if (me.name) {
            codeEl.attr('name', me.name);
        }

        inputEl.attr("id", me.clientId);

        //inputEl.attr("id", me.clientId)
        //    .attr('placeholder', me.placeholder)
        //    .attr('autocomplete', me.autoComplete)
        //    .attr('cols', me.cols)
        //    .attr('rows', me.rows);

        //inputEl.css({
        //    'text-align': me.align,
        //    'height': me.height
        //});


        //if (me.readOnly) {
        //    inputEl.attr('readonly', 'readonly');
        //}

        

        return inputEl;

    },

    
    render: function () {
        "use strict";
        var me = this,
            editor,
            inputEl,
            codeEl,
            bodyCls = '.mi-form-item-body:first';


        me.baseRender();

        me.el.data('me', me);

        inputEl = me.inputEl;

        //var codeEl = $(inputEl).children('.code-box');

        //console.debug("me.height = ", me.height);
        codeEl = me.codeEl;


        //console.debug("初始化", me.value);

        var editor = CodeMirror.fromTextArea(codeEl[0], {
            lineNumbers: true,
            mode: me.mode,
            autofocus: false

        });


        editor.setSize("100%", me.height + 'px')


        me.editor = editor;
        
        setTimeout(function () {

            editor.on("blur", function (Editor, changes) {
                
                me.value = Editor.getValue();

                //console.debug("触发保存",me.value);

                inputEl.val(me.value);

                me.autoSave();
            });

        }, 1000);

    },

    /**
    * 重置层次
    */
    resetPaint: function () {
        var me = this,
            editor = me.editor;

        //console.debug("CodeEditor resetPaint()");

        editor.refresh();

        return me;
    },

    autoSave: function () {
        "use strict";
        var me = this,
            saveTimer = me.saveTimer;

        if (saveTimer) {
            saveTimer.resetStart();
        }
        else {

            me.saveTimer = saveTimer = Mini2.setTimer(function () {

                me._isValueChanged = true;

                var owner = me.ownerParent;

                if (owner && owner.setStoreRecrod) {
                    owner.setStoreRecrod.call(owner, me);
                }

                var editor = me.editor;

                if (editor) {
                    editor.setSize("100%", me.height + 'px')
                }

            }, {
                interval: 500,
                limit: 1
            });
        }
    }
});


/************************************************************************/
/*                                           */
/*    ui/grid/CellFocusRegion.js	                                          */
/*                                           */
/************************************************************************/


/**
* 单元格的焦点框
* 
*/
Mini2.define('Mini2.ui.grid.CellFocusRegion', {



});


/************************************************************************/
/*                                           */
/*    ui/grid/header/Container.js                                          */
/*                                           */
/************************************************************************/

/// <reference path="../../Mini.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />




Mini2.define('Mini2.ui.grid.header.Container', {

    //    extend: '',


    renderTo: Mini2.getBody(),


    log: Mini2.Logger.getLogger('Mini2.ui.grid.header.Container'),  //日志管理器

    height: 31,

    //每行的高度
    rowHeight: 31,

    width: 600,


    //拖拉线1
    m_divMarker1: null,
    //拖拉线2
    m_divMarker2: null,

    //当前移动的 head 对象索引
    m_CurMoveHead: null,

    //是否有出现拖拉想
    m_IsLineMove: false,

    //准备拖来列格的宽度
    headerElMoveWidth: 0,

    headerEl: null,

    innerEl: null,

    targetEl: null,


    //标题集合
    columns: [],

    curIndex: -1,

    baseCls: 'mi-column-header',

    m_ColumnWidthResize: Mini2.emptyFn,

    //明细列, 数组
    detailCols: false,

    //全部列, 数组
    allCols: false,

    /**
    * 列移动事件
    */
    columnMoved: Mini2.emptyFn,

    columnWidthResize: function (fn) {

        this.m_ColumnWidthResize = fn;
    },

    strJoin: function (array) {
        "use strict";
        var i,
            str = "",
            len = array.length;
        for (i = 0; i < len; i++) {
            str += array[i];
        }

        return str;
    },

    headTpl: [
        '<div class="mi-column-header mi-box-item mi-column-header-default mi-unselectable " ',
            'style="right: auto; left: 0px; top: 0px; margin: 0px; ">',
            '<div class="mi-column-header-inner ">',
                '<span class="mi-column-header-text">',

                '</span>',
            '</div>',
        '</div>'
    ],


    //复选框列
    checkColumns: [],

    //最后排序的列
    lastSortColumn: null,

    //创建菜单
    createMenu: function (col, headEl) {
        "use strict";
        var me = this,
        baseCls = me.baseCls,
        headerInnerEl;

        headerInnerEl = headEl.children(".mi-column-header-inner." + baseCls + "-inner");

        if (!col.menuDisabled && col.menu) {

            console.debug("headerInnerEl.len = ", headerInnerEl.length);

            var headerTriggerEl = $('<div class="' + baseCls + '-trigger" ></div>');

            headerInnerEl.append(headerTriggerEl);

            return;

            headerInnerEl.on('mousedown', function (e) {

                var x, w, left, col = $(this).data('me');

                if (col && col.resizable) {
                    left = $(this).offset().left;

                    x = event.clientX - left;

                    w = $(this).width();

                    if (x < w - 4) {
                        console.log("拖住...");
                        Mini2.EventManager.setMouseDown(this, e);
                    }
                    else {

                        console.log("点击...");
                    }
                }

            }).on('mouseup', function (sender, e) {

                //alert("显示下拉菜单 mouseup");

                //var menu = Mini2.create('Mini2.ui.menu.Menu', {

                //    items: [{
                //        text : '固定栏目'
                //    }, {
                //        text: '哈哈哈'
                //    }]
                //});

                //menu.render();


            });
        }

    },

    createColumn: function (col) {
        "use strict";
        var me = this,
            grid = me.grid,
            baseCls = me.baseCls,
            headEl,
            headerTextEl,
            headerInnerEl;


        headEl = $(me.headTpl)
            .addClass(baseCls + "-align-" + col.headerAlign)
            .data('me', col);

        me.renderHeaderText(col, grid, headEl);


        me.createMenu(col, headEl);

        me.head_bindEvent(headEl);

        if (col.required) {
            headEl.find('.mi-column-header-text').after('<span style="color:red;font-weight:bold" data-qtip="Required">*</span>');
        }

        return headEl;
    },


    //创建表头组的容器
    // curDept = 当前深度
    // maxDept = 最大深度
    createGroupColumn: function (col, curDept, maxDept) {
        "use strict";
        var me = this,
            log = Mini2.Logger,  //日志管理器
            grid = me.grid,
            baseCls = me.baseCls,
            headEl,
            headerInnerEl,
            curColEl,
            boxInnerEl;

        //style="cursor: col-resize;"


        headEl = $(me.headTpl)
            .addClass(baseCls + '-align-' + col.headerAlign)
            .addClass('mi-group-header')
            .data('me', col);

        me.renderHeaderText(col, grid, headEl);

        if (col.required) {
            headEl.find('.mi-column-header-text').after('<span style="color:red;font-weight:bold" data-qtip="Required">*</span>');
        }

        headerInnerEl = headEl.children('.mi-column-header-inner');

        boxInnerEl = $('<div class="mi-box-inner" role="presentation" ></div>');

        headEl.append(boxInnerEl);


        var i,
            left = 0,
            width = 0,
            height = 0,
            subCols = col.columns,
            subCol;

        for (i = 0; i < subCols.length; i++) {

            subCol = subCols[i];

            me.allCols.push(subCol);

            subCol.deptPath = col.deptPath + '.' + i;

            if (subCol.columns) {
                curColEl = me.createGroupColumn(subCol, curDept + 1, maxDept);
            }
            else {
                curColEl = me.createColumn(subCol);

                if (maxDept - curDept > 1) {
                    $(curColEl).css({
                        'padding-top': (me.rowHeight * (maxDept - curDept) - me.rowHeight) / 2
                    })
                }
            }

            subCol.el = curColEl;

            curColEl.css({
                left: left + 'px',
                width: (subCol.width) + 'px',
                height: me.rowHeight * (maxDept - curDept)

            }).addClass('mi-group-sub-header').appendTo(boxInnerEl);



            width += subCol.width;
            left += subCol.width;
        }

        col.width = width;
        col.height = me.rowHeight * (maxDept - curDept);


        boxInnerEl.css({
            height: col.height
        });


        me.createMenu(col, headEl);

        me.head_bindEvent(headEl);


        //log.debug('col.width = ' + width);


        return headEl;
    },


    renderHeaderText: function (col, grid, headEl) {
        "use strict";
        var me = this,
            baseCls = me.baseCls;

        var headerTextEl = headEl.children('.mi-column-header-inner').children('.' + baseCls + '-text:first');

        if (col.getHeaderConfig) {

            var headerConfig = col.getHeaderConfig();

            col = Mini2.apply(col, headerConfig);

            me.checkColumns.push(col);

            if (grid && 'SINGLE' == grid.checkedMode) {
                var txt = col.headerText;
                headerTextEl.html(txt);
            }
            else {
                var headerTl = col.renderer.call(col, false, grid);
                headerTextEl.append(headerTl);
            }
        }
        else {

            headerTextEl.html(col.headerText);
        }
    },


    mouse_button: null,


    isDragCol: false,

    /**
    * 拖拽到上方的元素
    */
    dragHoverEl: null,

    /**
    * 拖拽的元素
    */
    dragColEl: null,

    mouseDownLocal: null,


    startColDrag: function (evt, srcEvt) {
        var me = this;

        var hoverEl = srcEvt.target;    //鼠标所在的元素上方

        if (!$(hoverEl).hasClass('mi-column-header')) {
            var cellEl = $(hoverEl).parents('.mi-column-header');
            hoverEl = cellEl[0];
        }


        if (!hoverEl) {
            return;
        }

        me.isDragCol = true;
        me.dragHoverEl = hoverEl;

        var pLocal = me.innerEl.offset();

        var aLocal = $(hoverEl).offset();
        var aWidth = $(hoverEl).width();
        var aHeight = $(hoverEl).height();


        //console.debug("col left=", aLocal.left + aWidth);

        var colMoveTopEl = me.colMoveTopEl;

        var colMoveBottomEl = me.colMoveBottomEl;

        //创建指示
        if (!colMoveTopEl) {

            colMoveTopEl = Mini2.$joinStr([
                '<div class="mi-col-move mi-col-move-top" style="display:none;"></div>'
            ]);

            $(document.body).append(colMoveTopEl);
            me.colMoveTopEl = colMoveTopEl;
        }

        if (!colMoveBottomEl) {

            colMoveBottomEl = Mini2.$joinStr([
                '<div class="mi-col-move mi-col-move-bottom" style="display:none;"></div>'
            ]);

            $(document.body).append(colMoveBottomEl);
            me.colMoveBottomEl = colMoveBottomEl;
        }

        me.colMoveTopEl.show();
        me.colMoveBottomEl.show();

        var left = aLocal.left + aWidth - 5;

        colMoveTopEl.css({
            'top': aLocal.top - 11,
            'left': left
        });


        colMoveBottomEl.css({
            'top': aLocal.top + me.headerEl.height(),
            'left': left
        });



    },

    endColDrag: function (target) {
        var me = this;

        var itemA = target;
        var itemB = me.dragHoverEl;

        var aIndex = $(itemA).index();
        var bIndex = $(itemB).index();

        if (aIndex === bIndex || aIndex - 1 === bIndex) {
            return;
        }

        me.columnMoved.call(me, {

            fromIndex: aIndex,
            toIndex: bIndex,

        });

    },


    //绑定 Head 事件
    head_bindEvent: function (headEl) {
        "use strict";
        var me = this;

        headEl.muBind('mousedown', function (evt, srcEvt) {

            me.mouse_button = evt.button;

            if (0 === me.mouse_button) {


                var col = $(this).data('me');


                if (col.isCheckerHd) {
                    me.dragColEl = null;
                    return;
                }

                var pX = 0; //子元素触发后, 没有预定的偏移量

                if (!$(evt.target).hasClass('mi-column-header')) {
                    
                    var pList = $(evt.target).parentsUntil('.mi-column-header');
                    
                    var pp = $(evt.target).position();
                    pX += pp.left;
                    
                    $(pList).each(function () {
                        pp = $(this).position();
                        pX += pp.left;
                    });
                    
                }

                var w = $(this).width();



                //console.log("header 事件 ", evt);
                //console.log("header 事件 ", col);
                //console.log("列头 down", evt.offsetX);
                //console.log("xxx", w);

                var evtX = evt.offsetX + pX;

                if (evtX > 4 && evtX < w - 4) {

                    //console.debug("点击 offset= (%d, %d)", evt.offsetX, evt.offsetY);

                    me.mouseDownLocal = {
                        x: evt.offsetX,
                        y: evt.offsetY
                    };

                    me.dragColEl = this;
                }
                else {
                    me.dragColEl = null;
                }


                Mini2.ui.FocusMgr.setControl(col, null, this,true);

            }

        }).muBind('mousemove', function (evt, srcEvt) {

            if (0 === me.mouse_button) {

                //console.debug("移动 offset= (%d, %d)", srcEvt.offsetX, srcEvt.offsetY);

                if (me.dragColEl) {
                    var isDrag;

                    var cX = Math.abs(me.mouseDownLocal.x - srcEvt.offsetX);
                    var cY = Math.abs(me.mouseDownLocal.y - srcEvt.offsetY);

                    isDrag = (cX > 8) || (cY > 8);

                    if (isDrag) {
                        me.startColDrag(evt, srcEvt);
                    }
                }

            }


        }).muBind('mouseup', function (sender, evt) {

            if (0 === me.mouse_button) {

                if (me.colMoveTopEl) {
                    me.colMoveTopEl.hide();
                }

                if (me.colMoveBottomEl) {
                    me.colMoveBottomEl.hide();
                }

                var targetEl;

                //console.debug("me.isDragCol ", me.isDragCol);
                //console.debug("dragColEl is ", me.dragColEl?true:false);


                if (me.isDragCol) {

                    me.endColDrag(this);
                }
                else {

                    //console.debug("col....", evt);
                    
                    if (me.dragColEl && $(evt.target).hasClass('mi-column-header-trigger')) {

                        targetEl = evt.target;

                        var col = $(this).data('me');

                        col.triggerClick.call(col);

                    }
                    else {
                        me.head_click.call(this, this, evt, me);
                    }

                }


                //console.log("列头 up", $(this).find('.mi-column-header-text').text());


            }


            me.isDragCol = false;
            me.dragHoverEl = null;

            me.mouse_button = null;

        }).muBind('dblclick', function (sender, e) {

            me.head_dblclick.call(this, sender, e, me);

        });
    },




    //表头单击
    head_click: function (sender, e, owner) {
        "use strict";
        var me = owner,
            checkedCls = 'mi-grid-checkcolumn-checked',

            imgEl, check,

            col = $(this).data('me');

        if (!me.m_IsLineMove) {

            //console.log("col ", col);

            //console.log("点击表头, col.isCheckerHd = ", col.isCheckerHd);

            Mini2.ui.FocusMgr.setControl(this);

            if (col && col.isCheckerHd) {

                imgEl = $(this).find('img:first');
                imgEl.toggleClass(checkedCls);

                check = $(imgEl).hasClass(checkedCls);

                col.onHeaderClick(this, col, check);

                Mini2.EventManager.stopEvent(e);
            }
        }
    },

    //表头双击
    head_dblclick: function (sender, e, owner) {
        "use strict";
        var me = owner,
            grid = me.grid,
            baseCls = me.baseCls,
            headerSortCls = baseCls + '-sort',
            checkedCls = 'mi-grid-checkcolumn-checked',
            descCls = headerSortCls + '-DESC',
            ascCls = headerSortCls + '-ASC',

            col = $(this).data("me");

        if (!me.m_IsLineMove) {

            Mini2.ui.FocusMgr.setControl(this);


            if (!col.isCheckerHd) {
                //alert("排序字段" + me.m_IsLineMove);

                if (!grid.sortable || !col.sortable) {
                    return;
                }

                if (col.columns && col.columns.length) {
                    return;
                }

                if (me.lastSortColumn === this) {
                    col.doSort();
                }
                else {
                    col.doSort('ASC');
                }


                $(me.lastSortColumn).removeCls(descCls, ascCls);

                if ('ASC' == col.direction) {
                    $(this).addClass(descCls);
                }
                else if ('DESC' == col.direction) {
                    $(this).addClass(ascCls);
                }

                me.lastSortColumn = this;

                Mini2.EventManager.stopEvent(e);

            }
        }
    },


    setHeaderCheck: function (isChecked) {
        "use strict";
        var me = this,
            col,
            cols = me.checkColumns,
            i,
            imgEl, colEl,
            targetEl = me.targetEl,
            checkcolumnCheckedCls = 'mi-grid-checkcolumn-checked',
            checkcolumnUndefined = 'mi-grid-checkcolumn-undefined';

        for (i = 0; i < cols.length; i++) {

            col = cols[i];

            colEl = $(targetEl).children(":eq(" + col.index + ")");

            imgEl = $(colEl).find("img:first");

            if (undefined === isChecked) {
                $(imgEl).removeClass(checkcolumnCheckedCls);
                $(imgEl).addClass(checkcolumnUndefined);
            }
            else {
                $(imgEl).removeClass(checkcolumnUndefined);
                $(imgEl).toggleClass(checkcolumnCheckedCls, isChecked);
            }
        }

    },

    // 计算标题行数
    getRowCount: function (columns, rowIndex) {
        "use strict";
        var me = this,
            cols = columns,
            i,
            curDept,
            col;

        rowIndex = rowIndex || 1;

        if (cols && cols.length) {

            var count = 0;

            //计算标题行数
            for (i = 0; i < cols.length; i++) {
                col = cols[i];

                if (col.columns) {
                    curDept = me.getRowCount(col.columns, rowIndex + 1);

                    count = Math.max(count, curDept);
                }

            }


            rowIndex = Math.max(rowIndex, count);
        }

        return rowIndex;
    },


    //填充明细列的信息,也就是最底层的
    fullDetailCols: function (detailCols, cols, dept) {
        "use strict";
        var me = this,
            i,
            col,
            subColumns;

        if (cols && cols.length) {

            //计算标题行数
            for (i = 0; i < cols.length; i++) {
                col = cols[i];
                subColumns = col.columns;

                if (subColumns && subColumns.length) {
                    me.fullDetailCols(detailCols, subColumns, dept + 1);
                }
                else {
                    detailCols.push(col);
                }

            }
        }

        return detailCols.length;
    },


    createColumns: function (headerCtEl) {
        "use strict";

        var me = this,
            i,
            curColEl,
            col,
            baseCls = me.baseCls,
            cols = me.columns,
            headHtml,
            left = 0,
            width = 0;


        var boxInnerEl = headerCtEl.cFirst(".mi-box-inner");

        var boxTargetEl = $(boxInnerEl).cFirst(".mi-box-target");


        var rowCount = me.getRowCount(me.columns);

        me.fullDetailCols(me.detailCols, me.columns, 1);


        me.height = me.rowHeight * rowCount - rowCount - 1;

        headerCtEl.height(me.height);
        boxInnerEl.height(me.height);


        for (i = 0; i < cols.length; i++) {
            col = cols[i];
            col.ownerParent = me.grid;

            me.allCols.push(col);

            if (col.isCheckerHd) {
                me.checkColumns.push(col);
            }

            col.deptPath = i + '';

            if (col.columns) {
                curColEl = me.createGroupColumn(col, 1, rowCount);
            }
            else {
                curColEl = me.createColumn(col);

                $(curColEl).css({
                    'padding-top': parseInt((me.height - me.rowHeight) / 2)
                });
            }

            col.el = curColEl;

            boxTargetEl.append(curColEl);

            //log.debug('left = ' + left + ', 【width】 = ' + col.width + ', col.deptPath = ' + col.deptPath);

            $(curColEl).css({
                left: left + "px",
                height: me.height + "px",
                width: (col.width - 1) + "px"
            });

            if (col.visible) {
                left += col.width;
                width += col.width;
            }
        }

        me.width = width;


        return headerCtEl;
    },


    createMarker: function () {
        "use strict";
        /// <summary>创建拖动条</summary>
        var me = this,
            divHtml,
            dm1 = me.m_divMarker1,
            dm2 = me.m_divMarker2;

        if (dm1 != null && dm2 != null) {
            return;
        }

        divHtml = '<div class="mi-grid-resize-marker" style="top:0;right: auto; left: -9999px; pointer-events: none;" ></div>';

        me.m_divMarker1 = dm1 = $(divHtml);
        me.m_divMarker2 = dm2 = $(divHtml);


        $(me.renderTo).append([dm1, dm2]);
    },

    onInit: function () {
        "use strict";
        var me = this;

        me.detailCols = me.detailCols || [];
        me.allCols = me.allCols || [];

        me.headTpl = me.strJoin(me.headTpl);
    },

    render: function () {
        "use strict";
        var me = this,
            baseCls = me.baseCls,
            headGroupsEl,
            boxInnerEl,
            boxTargetEl;


        me.onInit();

        var headerCtEl = Mini2.$join([
            '<div unselectable="on" >',
                '<div class="mi-box-inner" role="presentation" style="width: 644px; height: 29px;  overflow: visible;">',
                    '<div class="mi-box-target" style="width: 644px; "></div>',
                '</div>',
            '</div>']);

        headerCtEl.addCls(
            baseCls + "-ct",
            baseCls + "-ct-docked-top",
            baseCls + "-ct-default-docked-top",
            baseCls + "-ct-default",
            "mi-box-layout-ct",
            "mi-noborder-rl");


        $(me.renderTo).append(headerCtEl);

        me.createColumns(headerCtEl);


        boxInnerEl = $(headerCtEl).cFirst(".mi-box-inner");
        boxTargetEl = $(boxInnerEl).cFirst(".mi-box-target");



        me.headerEl = headerCtEl;
        me.innerEl = boxInnerEl;
        me.targetEl = boxTargetEl;


        me.IntiHeaderInner();
        me.InitHeadGroups();

        me.resetWidth();
    },

    setWidth: function (value) {
        "use strict";
        var me = this;

        me.width = value;


        me.innerEl.css("width", value - 1 - 16);
        me.targetEl.css("width", value);

        return me;
    },

    scrollLeft: function (x) {

        var me = this;

        //me.innerEl.scrollLeft(x);
        me.innerEl.css('left',-x);

        return me;
    },

    preventDefault: function (e) {
        e = e || window.event;
        if (e.preventDefault) {
            e.preventDefault();

        } else {
            e.returnValue = false;
        }
    },



    StartHeadDrog: function (e) {
        "use strict";
        /// <summary>开始调整列宽度</summary>
        var me = this,
            curMoveHead = $(me.m_CurMoveHead),
            renderTo = me.renderTo,
            headerEl = me.headerEl,
            conWidth,
            conLeft,
            x,
            h;

        me.createMarker();

        me.m_IsLineMove = true;
        me.curIndex = curMoveHead.index();

        conWidth = curMoveHead.width();
        conLeft = curMoveHead.offset().left - renderTo.offset().left;

        x = e.clientX - conLeft;

        h = renderTo.height() + headerEl.height();


        me.m_divMarker1.css({
            left: conLeft,
            top: 0,
            height: h
        });

        me.m_divMarker2.css({
            left: conLeft + conWidth,
            top: 0,
            height: h
        });


        me.headerElMoveWidth = conWidth;

        Mini2.ui.FocusMgr.setControl(headerEl);
    },


    HeadDroging: function (e, objOver) {
        "use strict";
        /// <summary>拖放过程</summary>
        /// <param name="e" type="object">事件源</param>
        /// <param name="objOver" type="object">拖到到上面的对象</param>

        var me = this,
            overEl = $(objOver),
            conWidth = overEl.width(),
            conLeft = overEl.offset().left,
            x,
            x1, x2, span, div2Left;

        x = e.clientX + conLeft;

        x1 = me.m_divMarker1.offset().left;
        x2 = e.clientX;

        span = x2 - x1;

        if (span > 4) {

            div2Left = x2 - $(me.renderTo).offset().left;

            me.m_divMarker2.css({ left: div2Left });

            me.headerElMoveWidth = x2 - x1;
        }
    },

    EndHeadDrog: function (e, objOver) {
        "use strict";
        var me = this,
            col,
            dm1 = me.m_divMarker1,
            dm2 = me.m_divMarker2,
            curMoveHead = me.m_CurMoveHead,
            moveWidth = me.headerElMoveWidth;

        if (dm1 && dm2) {

            dm1.css({ left: -9999 });
            dm2.css({ left: -9999 });


            $(curMoveHead).css({ width: moveWidth });

            me.m_IsLineMove = false;
            me.m_CurMoveHead = null;

            col = $(curMoveHead).data('me');

            if (col) {
                col.width = moveWidth;


                me.resetSubColumnWidth(col);    //重置子节点的宽度

                if (col.parent) {
                    me.resetSubColumnWidth(col.parent);
                }

            }

            me.resetWidth(col);

            me.setWidth(me.grid.width);
        }


    },

    // 重置子节点的宽度
    resetSubColumnWidth: function (col) {
        "use strict";
        var me = this,
            cols = col.columns,
            subCol,
            len,
            width = col.width,
            el,
            left = 0,
            vWidth = width,
            i;



        if (cols && cols.length) {

            len = cols.length;


            for (i = 0; i < len - 1; i++) {

                subCol = cols[i];

                subCol.el.css({
                    left: left
                });

                if (subCol.visible) {
                    vWidth -= subCol.width;

                    left += subCol.width;
                }
            }

            subCol = cols[len - 1];

            subCol.width = vWidth;

            el = subCol.el;

            el.css({
                left: left,
                width: vWidth
            });

            me.resetSubColumnWidth(subCol);
        }

    },





    InitHeadGroups: function () {
        "use strict";
        var me = this;

        var boxInner = $(me.headerEl).find(".mi-box-inner:first");

        boxInner.mousemove(function (e) {

            if (me.m_IsLineMove) {

                me.HeadDroging(e, this);

                me.preventDefault(e);
            }
        })
        .mouseup(function (e) {

            if (me.m_IsLineMove) {
                me.EndHeadDrog(e, this);
            }

            me.preventDefault(e);
        });
    },

    IntiHeaderInner: function () {
        "use strict";
        var owner = this,
            log = owner.log,
            headerEl = $(owner.headerEl),
            baseCls = owner.baseCls,
            headerInnerEls = headerEl.find('.' + baseCls + '-inner'),
            headerList = headerEl.find('.' + baseCls);

        //log.debug('headerInnerEls = ' + headerInnerEls.length);
        //log.debug('baseCls = ' + baseCls);


        //菜单样式
        $(headerInnerEls).muBind('mouseenter', function () {
            $(this).addClass("mi-column-header-over");
        })
        .muBind('mouseleave', function () {
            $(this).removeClass("mi-column-header-over");
        });



        $(headerList)
        .muBind('mousedown', function (evt) {


            //console.log("header target 事件 ", evt);

            if (owner.m_CurMoveHead != null) {

                Mini2.EventManager.drag = true;

                owner.StartHeadDrog(evt);
            }

            Mini2.EventManager.stopEvent(evt);

        })
        .muBind('mouseup', function (sender, e) {

            owner.m_IsLineMove = false;

            Mini2.EventManager.drag = false;

            owner.EndHeadDrog(e, this);
        })
        .muBind('mousemove', function (sender, e) {

            var me = $(this);

            if (owner.m_IsLineMove) {

                owner.HeadDroging(e, this);
                Mini2.EventManager.stopEvent(e);
                return;
            }

            var downCon = me;

            var conWidth = me.width() + 20;
            var conLeft = me.offset().left;

            var x = e.clientX - conLeft;

            var curMove1 = false,
                curMove2 = false,
                col = me.data('me');

            var n = me.index();


            if (x <= 4) {

                if (n > 0) {
                    n = me.prev().index();
                    //col = owner.columns[n];

                    if (col && col.resizable && me.prev().index() > 0) {
                        me.css("cursor", "col-resize");

                        owner.m_CurMoveHead = me.prev();
                        curMove1 = true;
                    }
                }
            }
            else if (x >= 20) {
                //log.debug("x = " + x);
            }
            else {
                me.css("cursor", "");
            }

            //n = me.index();
            //col = owner.columns[n];

            if (col.resizable && x > conWidth - 24) {
                //me.css("cursor", "col-resize");
                me.find('.' + baseCls + '-trigger:first').css("cursor", "col-resize");

                owner.m_CurMoveHead = me;
                curMove2 = true;

            }
            else {
                //me.css("cursor", "");
                me.find('.' + baseCls + '-trigger:first').css("cursor", "");
            }


            if (curMove1 == false && curMove2 == false) {
                owner.m_CurMoveHead = null;
            }

            Mini2.EventManager.stopEvent(e);
        });



    },

    clear: function () {
        "use strict";
        var me = this,
            targetEl = me.targetEl;

        $(targetEl).children().remove();
    },

    /**
    * 添加列集合
    *
    * @param {Array} columns 列集合
    */
    add: function (columns) {
        "use strict";
        var me = this,
            log = me.log,
            i,
            left = 0,
            width = 0,
            cols = columns,
            headerEl = me.headerEl,
            innerEl = me.innerEl,
            targetEl = me.targetEl;



        me.columns = [];
        me.checkColumns = [];
        me.detailCols = [];

        me.columns = columns;


        me.createColumns(headerEl);



        me.IntiHeaderInner();
        me.InitHeadGroups();

        me.resetWidth();


        return me;
    },


    /**
    * 重新设置标头宽度
    */
    resetWidth: function (curCol) {
        "use strict";
        var me = this,
            x = 0,
            n = 0,
            i, col, headerEl,
            colEl,
            cols = me.columns,
            len = cols.length;


        for (i = 0; i < len; i++) {
            col = cols[i];

            if (col.visible) {
                colEl = col.el;

                colEl.css('left', x);

                x += col.width;
            }
        }

        if (curCol) {
            me.m_ColumnWidthResize(curCol);
        }


    }
})


/************************************************************************/
/*                                           */
/*    ui/grid/column/Column.js                                             */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../../Mini.js" />


Mini2.define('Mini2.ui.grid.column.StyleAction', {

    /**
     * 原始值
     */
    srcValue: null,

    /**
     * 值
     */
    value: null,

    /**
     * 样式对象
     */
    style: null,

    /**
     * 样式集合
     */
    opClassList: null,    //操作样式的列表



    onInit: function () {

    },

    addClass: function (className) {
        "use strict";
        var me = this;

        var op = {
            action: 'add',
            className: className
        };

        if (me.opClassList) { me.me.opClassList = []; }

        me.opClassList.push(op);
    },

    removeClass: function (className) {
        "use strict";
        var me = this;

        var op = {
            action: 'remove',
            className: className
        };

        if (me.opClassList) { me.me.opClassList = []; }

        me.opClassList.push(op);
    },

    reset: function (value) {
        "use strict";
        var me = this;

        me.srcValue = value;
        me.value = value;
        me.style = {};

        if (me.opClassList) {
            me.opClassList = [];
        }
    },

    /**
     * 获取渲染结果后的值
     */
    getHtml: function (actT) {
        "use strict";
        var me = this,
            value = me.value;

        if (value != me.srcValue) {
            actT.isAct = true;
            return (actT.text || value);
        }



        if (actT.formatFun) {

            try {
                value = actT.formatFun(value, actT.formatStr);
            }
            catch (ex) {
                console.error('格式化错误:Mini2.util.Format.number = ' + value + ', format=' + actT.formatStr);
            }

            actT.isAct = true;
        }

        var hasStyle = false;

        for (var i in me.style) {
            hasStyle = true;
            break;
        }

        if (hasStyle && value != null) {

            actT.isAct = true;

            var spanEl = $('<span>' + (actT.text || value) + '</span>');

            if (hasStyle) {

                spanEl.css(me.style);
            }


            var tmpEl = $('<div></div>');
            tmpEl.append(spanEl);

            var html = tmpEl.html();

            return html;
        }
        else {
            return (actT.text || value);
        }
    }

}, function () {

    var me = this;
    me.style = {};
});

Mini2.define('Mini2.ui.grid.column.Colunm', {

    extend: 'Mini2.ui.Component',

    //列默认宽度。单位是 px
    width: 120,

    /**
    * 录入的时候,自动去除左右两边的空格
    */
    autoTrim: true,

    headerWidth: 120,

    handleWidth: 4,

    headerAlign: 'left',

    noWrap: true,

    emptyCellText: '&#160;',

    //数据类型
    miType: 'col',

    //数据。字段名或属性名称
    dataIndex: '',

    //标题
    headerText: '&#160',

    //显示的格式
    renderer: false,

    //编辑器
    editor: false,

    //自动锁定
    autoLock: false,

    //可改变大小
    resizable: true,

    //是否为自定义
    hasCustomRenderer: false,

    lockedHeader: false,

    rowspan: undefined,

    menuDisabled: false,

    //`'left'`, `'center'`, and `'right'`.
    align: 'left',

    isHeader: true,

    sortAsc: false,
    sortDesc: false,

    //排序开关
    sortable: true,

    /**
     * 样式规则集合
     * Array 对象.
     */
    styleRules: null,

    //排序的字段
    //sortExpression


    //direction: 'ASC',

    //水印
    //placeholder:false,

    tdCls: '',
    innerCls: '',

    /**
    * 设置字段只读模式
    */
    setReadOnly:function(value){

        var me = this;

        me.readOnly = !!value;

        console.debug('设置只读: ', me);
        console.debug('设置只读    : ', me.readOnly);

        return me;
    },


    renderTpl: [
        '<td role="gridcell" class="mi-grid-cell mi-grid-td ">',
            '<div class="mi-grid-cell-inner">',
            '</div>',
        '</td>'
    ],


    initComponent: function () {
        "use strict";
        var me = this,
            renderer,
            listeners;

        renderer = me.renderer;

        if (renderer) {

            if (typeof renderer == 'string') {
                //me.renderer = Ext.util.Format[renderer];
            }
            me.hasCustomRenderer = true;
        }
        else if (me.defaultRenderer) {
            me.scope = me;
            me.renderer = me.defaultRenderer;
        }

        if (me.clientId) {
            window[me.clientId] = me;
        }

        me.initStyleRule();

        try {
            var sec = Mini2.ui.SecManager;
            sec.reg(me.secFunCode, me,'visible');
            sec.reg(me.secReadonly, me,'readonly');
        }
        catch (ex) {
            console.error('注册权限错误', ex);
        }
    },

    /**
    * 设置组件可视状态
    * @param {bool} value 
    */
    setVisible: function (value) {
        "use strict";
        var me = this;
        value = !!value;

        if (value !== me.visible) {

            me.visible = value;

            if (value) {
                me.show();
            }
            else {
                me.hide();
            }
        }

        return me;
    },


    /**
     * 缓冲 Style action 对象
     */
    bufferStyleAction: null,


    /**
     * 初始化样式规则
     */
    initStyleRule: function () {
        "use strict";
        var me = this,
            i,
            rule,
            rules = me.styleRules;

        if (!rules || rules.length == 0) {
            return;
        }

        console.debug("动态编译样式规则...");

        for (i = 0; i < rules.length; i++) {

            rule = rules[i];

            if (rule.exec) {
                continue;
            }

            if ('script' == rule.role) {
                rule.exec = eval('(function(T){ ' + rule.script + '})');

                console.debug('动态编译为脚本函数: ', rule.exec);
            }



        }

    },

    /**
     * 执行样式规则
     *
     */
    execStyleRule: function (actT) {
        "use strict";
        var me = this,
            i,
            rule,
            rules = me.styleRules;

        if (!rules || rules.length == 0) {

            return actT.text || actT.value;
        }

        //动作对象

        var styleAction = me.bufferStyleAction;

        if (!styleAction) {
            me.bufferStyleAction = styleAction = Mini2.create('Mini2.ui.grid.column.StyleAction');
        }

        styleAction.reset(actT.value);




        for (i = 0; i < rules.length; i++) {

            rule = rules[i];

            if ('script' == rule.role) {

                rule.exec(styleAction);

            }
        }



        var htmlValue = styleAction.getHtml(actT);


        return htmlValue;
    },




    hasLockedHeader: function () {
        return this.lockedHeader;
    },

    defaultRenderer: function (value) {

        return value;
    },


    /*
    * 缓冲数据
    */
    //buffer:{
    //    cellEl: null
    //},


    getBufferCellEl: function () {
        "use strict";
        var me = this,
            cellEl,
            buffer = me.buffer;

        if (!buffer) {
            me.buffer = buffer = {};
        }

        cellEl = buffer.cellEl;

        return cellEl;
    },

    setBufferCellEl: function (cellEl) {
        "use strict";
        var me = this,
            cellEl,
            buffer = me.buffer;

        if (!buffer) {
            me.buffer = buffer = {};
        }

        buffer.cellEl = cellEl;

        return me;
    },


    /**
    * 触发点击事件
    *
    * 
    */
    triggerClick: function () {
        var me = this,
            el = me.el,
            innerEl = el.children('.mi-column-header-inner'),
            triggerEl = innerEl.children('.mi-column-header-trigger'),

            menu = me.menu,
            menuInst = me.menuInst;


        //console.log("triggerEl = ", triggerEl[0]);

        var offset = $(triggerEl).offset();

        var x = offset.left;
        var y = offset.top + triggerEl.height();

        //如果菜单不存在, 创建默认菜单
        if (!menu) {

            //menu = {};

            //menu.items = [{

            //    text: '全选',

            //    click: function () {
            //        var me = this,
            //            owner = me.owner;

            //        //console.log("cccc ", owner);
            //    }

            //},{
            //    text :'反选'  
            //},{
            //    text:'-'
            //}, {
            //    text: '设置...'
            //}];

        }

        if (menu) {

            if (!menuInst) {

                //delete me.menu;

                me.menuInst = menuInst = Mini2.create('Mini2.ui.menu.Menu', {
                    left: x,
                    top: y,

                    owner: me,
                    items: menu
                });

                menuInst.bind('showed', function () {
                    innerEl.addClass('mi-column-header-open');
                });

                menuInst.bind('hidded', function () {
                    innerEl.removeClass('mi-column-header-open');
                });

                menuInst.render();

            }
            else {
                menuInst.setLocal(x, y).show();
            }
        }

    },


    renderCell: function () {
        "use strict";
        var me = this,
            cellEl;

        cellEl = me.getBufferCellEl();


        if (!cellEl) {

            cellEl = Mini2.$joinStr(me.renderTpl);

            cellEl.children('.mi-grid-cell-inner').css('text-align', me.align);

            me.setBufferCellEl(cellEl);

        }

        cellEl = cellEl.clone();

        return cellEl;
    },

    getStore: function () {
        var me = this,
            displayStore = me.displayStore;

        return displayStore;
    },

    renderer: function (value, fieldValue, cellValues, record, recordIndex, columnIndex, store, table) {
        "use strict";
        var me = this,
            colRecord,
            text,
            editor = me.editor,
            editorMode = me.editorMode,
            colStore = me.displayStore,
            displayField = me.displayField,
            itemValueField = me.itemValueField || 'value',
            itemDisplayField = me.itemDisplayField || 'text';

        //log.debug(columnIndex + ' = ' + value);


        if (displayField) {

            try {
                text = record.get(displayField);
            }
            catch (ex) {
                throw new Error('获取字段“' + displayField + '”的值错误。');
            }


            // 执行样式规则
            var actT = {
                value: value,
                text: text,
                record: record,
                dataIndex: me.dataIndex,
                formatFun: null,
                format: null,
                isAct: false
            };


            text = me.execStyleRule(actT);

            if (!Mini2.isBlank(text)) {
                return text;
            }
        }


        //log.debug('     最后  【' + itemDisplayField + '】' + ' me.editorMode = ' + me.editorMode);

        // 注: colStore 一般情况下,是下拉框的'项目集合'
        if (colStore && ('none' == editorMode || (editor && 'none' == editor.mode))) {

            //record = store.getById(value);

            //alert('me.valueField = ' + me.valueField);

            colRecord = colStore.filterFirstBy(itemValueField, value);

            //            alert(record);

            if (colRecord) {
                text = colRecord.get(displayField || itemDisplayField);

                // 执行样式规则
                var actT = {
                    value: value,
                    text: text,
                    record: record,
                    dataIndex: me.dataIndex,
                    formatFun: null,
                    format: null,
                    isAct: false
                };


                text = me.execStyleRule(actT);

                return text;
            }
        }

        // 执行样式规则
        var actT = {
            value: value,
            record: record,
            dataIndex: me.dataIndex,
            formatFun: null,
            format: null,
            isAct: false
        };


        value = me.execStyleRule(actT);


        //增加水印效果
        if (me.placeholder && Mini2.isBlank(value)) {
            value = '<span style="color:#c0c0c0;">' + me.placeholder + '</span>';
        }

        return value;
    },



    //清理异常提示
    //record = 记录
    //cellEl = 单元格
    //dataIndex = 字段名
    clearInvalid: function (record, cellEl, dataIndex) {
        "use strict";
        var me = this;

        if ($(cellEl).hasClass('mi-grid-cell-invalid')) {
            //构造错误提示信息
            var errorEl = $(cellEl).children('.mi-grid-cell-invalid-icon');

            if (errorEl.length) {
                $(errorEl).remove();
            }

            $(cellEl).removeClass('mi-grid-cell-invalid');
        }

    },


    //创建异常提示
    //record = 记录
    //cellEl = 单元格
    //dataIndex = 字段名
    markInvalid: function (record, cellEl, dataIndex, invalidMessage) {
        "use strict";
        var me = this,
            errors = record.errors;

        if (invalidMessage) {

            errors = invalidMessage;

            if (errors) {
                error = errors[0];   //暂时只取第一个
            }

            //构造错误提示信息
            var errorEl = $(cellEl).children('.mi-grid-cell-invalid-icon');
            if (errorEl.length) {
                $(errorEl).remove();
            }

            var errorType = error.type.toLowerCase();

            errorEl = Mini2.$join([
                    '<div role="presentation" class="mi-form-',
                        errorType,
                        '-msg mi-form-invalid-icon mi-grid-cell-invalid-icon" >',
                    '</div>']);


            errorEl.attr('title', error.message);
            errorEl.attr('data-errorqtip', '');

            $(cellEl).addClass('mi-grid-cell-invalid');
            $(cellEl).append(errorEl);

        }
        else if (errors && errors.length) {

            var error = record.getErrors(dataIndex);

            if (error) {
                error = error[0];   //暂时只取第一个
            }

            if (error) {

                //构造错误提示信息
                var errorEl = $(cellEl).children('.mi-grid-cell-invalid-icon');
                if (errorEl.length) {
                    $(errorEl).remove();
                }

                var errorType = error.type.toLowerCase();

                errorEl = Mini2.$join([
                    '<div role="presentation" class="mi-form-',
                        errorType,
                        '-msg mi-form-invalid-icon mi-grid-cell-invalid-icon" >',
                    '</div>']);


                errorEl.attr('title', error.message);
                errorEl.attr('data-errorqtip', '');

                $(cellEl).addClass('mi-grid-cell-invalid');
                $(cellEl).append(errorEl);
            }
        }

        //return errorEl;
    },

    getSortParam: function () {
        return this.dataIndex;
    },



    doSort: function (state) {
        "use strict";
        var me = this,
            ORDER_ASC = 'ASC',
            ORDER_DESC = 'DESC',
            sortText = '',
            direction = me.direction,
            sortAsc = me.sortAsc,
            sortDesc = me.sortDesc,
            sortExpression = me.sortExpression,
            store = me.grid.getStore();


        if (!state) {
            state = me.direction = (ORDER_ASC == direction ? ORDER_DESC : ORDER_ASC);
        }
        else {
            state = me.direction = state.toUpperCase();
        }


        if (ORDER_ASC == state && sortAsc) {
            sortText = sortAsc;
        }
        else if (ORDER_DESC == state && sortDesc) {
            sortText = sortDesc;
        }
        else if (sortExpression) {
            sortText = sortExpression + " " + state;
        }
        else {
            sortText = me.dataIndex + " " + state;
        }

        store.sort(sortText);
    }

});



/************************************************************************/
/*                                           */
/*    ui/grid/column/Action.js                                             */
/*                                           */
/************************************************************************/

/// <reference path="../../Mini2.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.Action', {

    extend: 'Mini2.ui.grid.column.Colunm',

    sortable: false,

    menuDisabled: true,

    innerCls: function () {
        "use strict";
        var me = this,
            cls = 'mi-grid-cell-inner-action-col';

        if (me.autoHide) {
            cls += ' mi-grid-cell-autohide';
        }

        return cls;
    },

    tdCls: 'mi-action-col-cell',

    //自动隐藏按钮
    //    autoHide: false,

    renderItem_ForIcon: function (i, item) {
        "use strict";
        var itemObj = $('<img role="button" alt="" src="" class="mi-action-col-icon" data-qtip="" style="margin-left:3px;margin-right:3px; " click="alert(\'dddddddddd\')" />');

        itemObj.addClass('mi-action-col-' + i)
                    .attr('src', item.icon)
                    .attr('data-qtip', item.tooltip)
                    .attr('itemId', i)
                    .attr('title', item.text);

        return itemObj;
    },


    renderItem_ForText: function (i, item) {
        var itemObj = $('<a role="button" alt="" href="#" class="mi-action-col-icon" data-qtip="" style="margin-left:3px;margin-right:3px;"></a>');
        itemObj.attr('itemId', i)
                    .html(item.text);

        return itemObj;
    },

    renderItem_ForIconText: function (i, item) {
        "use strict";
        var itemObj = Mini2.$joinStr([
                    '<a role="button" alt="" href="#" class="mi-action-col" data-qtip="" ',
                        'style="margin-left:3px;margin-right:3px; ">',
                        '<img src="" class="mi-action-col-icon" data-qtip="" />',
                        '<span class="mi-action-col-text" style="margin-left: 4px;">',
                            item.text,
                        '</span>',
                    '</a>']);

        itemObj.cFirst('.mi-action-col-icon')
                    .attr('src', item.icon);

        itemObj.attr('itemId', i);

        return itemObj;
    },

    renderer: function (value, metaData, cellValues, record, rowIdx, colIdx, store) {
        "use strict";
        var me = this,
            i,
            displayMode,
            item,
            itemObj,
            items = me.items,
            len = items.length,
            ret;

        ret = '<table border="0" cellpadding="0" cellspacing="0" align="center" style="height:16px;"><tr>';

        for (i = 0; i < len; i++) {

            item = items[i];

            displayMode = item.displayMode = (item.displayMode || 'auto');

            if ('auto' == displayMode) {

                var hasIcon = !Mini2.isBlank(item.icon);
                var hasText = !Mini2.isBlank(item.text);

                if (hasIcon && hasText) {
                    displayMode = 'icontext';
                }
                else if (hasIcon && !hasText) {
                    displayMode = 'icon';
                }
                else if (!hasIcon && hasText) {
                    displayMode = 'text';
                }

            }


            switch (displayMode) {
                case 'icontext': itemObj = me.renderItem_ForIconText(i, item); break;
                case 'icon': itemObj = me.renderItem_ForIcon(i, item); break;
                case 'text': itemObj = me.renderItem_ForText(i, item); break;
            }

            var tmpDiv = $('<div></div>').append(itemObj);

            ret += '<td>' + tmpDiv.html() + '</td>';
        }

        ret += '</tr></table>';

        return ret;
    },


    bindEvent: function (view, cell, recordIndex, cellIndex, e, record, row) {
        "use strict";
        var me = this,
            btns = cell.find("[role='button']");

        $(btns).muBind('mousedown', Mini2.emptyFn)
        .muBind('mouseup', function (e2) {

            me.processEvent("mouseup", view, cell, recordIndex, cellIndex, e2, record, row);

            Mini2.EventManager.stopEvent(e2);

        }).on('click', function (e2) { return false; });
    },

    processEvent: function (type, view, cell, recordIndex, cellIndex, e, record, row) {
        "use strict";
        var me = e.currentTarget,
            item,
            handler,
            clickHandler,
            result = null,
            items = this.items,
            itemId = parseInt($(me).attr("itemId"));

        item = items[itemId];

        clickHandler = item.clickHandler;
        handler = item.handler;

        if (clickHandler && Mini2.isFunction(clickHandler)) {

            result = clickHandler.call(me, {
                record: record,
                view: view,
                cell: cell,
                recordIndex: recordIndex,
                cellIndex: cellIndex,
                event: e,
                row: row
            });

            if (result === false) {
                return;
            }
        }
        else if (handler && Mini2.isFunction(handler)) {

            result = handler.call(me, view, cell, recordIndex, cellIndex, e, record, row);

            if (result === false) {
                return;
            }
        }


        if (!Mini2.isBlank(item.href)) {

            console.debug("item ---- ", item);

            var rendererHref = this.rendererHref_art;

            var href;

            try {
                href = rendererHref.call(this, item, record);
            }
            catch (ex) {
                console.error('地址模板解析处理失败,', item);
                return;
            }

            var target = item.target.toLowerCase();

            if (Mini2.isBlank(target)) {

                window.location.href = href;

            }
            else if ('ecview' == target) {

                EcView.show(href, item.targetText);
            }
            else if ('dialog' == target) {
                var frm = Mini2.createTop('widget.window', {
                    url: href,
                    text: item.targetText,
                    width: 400,
                    height: 300,
                    state:'max',
                    mode: true
                });

                frm.show();
            }
            else {

                console.debug('未知标识', target);

            }

            return;
        }
    },

    /**
    * jTemplate 模板引擎
    */
    rendererHref_j: function (item, record) {


    },

    /**
    * artTemplate 腾信模板引擎
    */
    rendererHref_art: function (item, record) {
        "use strict";
        var me = this,
            valueStr,
            artTemp = item.artTemplate;

        if (!artTemp) {
            item.artTemplate = artTemp = template.compile(item.href);
        }

        valueStr = artTemp({
            T: record
        });

        return valueStr;
    }

});


/************************************************************************/
/*                                           */
/*    ui/grid/column/Boolean.js                                            */
/*                                           */
/************************************************************************/


/// <reference path="../../define.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.Boolean', {

    extend: 'Mini2.ui.grid.column.Colunm',

    trueText: 'true',

    falseText: 'false',

    undefinedText: '&#160;',

    // private
    renderer: function (value, metaData,cellValues, record, rowIdx, colIdx, store) {
        var me = this;

        if (value === undefined) {
            return me.undefinedText;
        }

        if (!value || value === 'false') {
            return me.falseText;
        }

        return me.trueText;
    }

});



/************************************************************************/
/*                                           */
/*    ui/grid/column/Password.js                                           */
/*                                           */
/************************************************************************/


/// <reference path="../../Mini2.js" />
/// <reference path="../../lang/Number.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.Password', {

    extend: 'Mini2.ui.grid.column.Colunm',


    passwordChar: false,


    defaultRenderer: function (value) {

        "use strict";
        var me = this,
            pwChar = me.passwordChar,
            result = value,
            notDisplayValue = me.notDisplayValue;

        if (Mini2.isBlank(value) || (notDisplayValue && value == notDisplayValue)) {
            return '';
        }

        try {
            result = Mini2.String.rightPad('', value.length, pwChar || '*');
        }
        catch (ex) {
            console.error('格式化错误:  ' + value,ex );
        }

        return result;

    },



    // private
    renderer: function (value, metaData, cellValues, record, rowIdx, colIdx, store) {
        return this.defaultRenderer(value);
    }


});



/************************************************************************/
/*                                           */
/*    ui/grid/column/Date.js                                               */
/*                                           */
/************************************************************************/


/// <reference path="../../define.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.Date', {

    extend: 'Mini2.ui.grid.column.Colunm',

    format: 'Y-m-d',



    defaultRenderer: function (value) {
        "use strict";
        //return Mini2.util.Format.number(value, this.format);

        var me = this,
            valueStr;


        if (value && !Mini2.isDate(value)) {
            value = Mini2.Date.parse(value, me.format);

        }


        valueStr = Mini2.Date.format(value, me.format);

        return valueStr; ;
    },

    // private
    renderer: function (value, metaData,cellValues, record, rowIdx, colIdx, store) {
        "use strict";
        var me = this,
            valueStr,
            srcValue = value;

        

        if (value == null) { return value; }
        
        var isDate = Mini2.isDate(value);

        if (value && !isDate) {

            
            if (value.length <= 10) {
                value += " 0:0:0";
            }


            if (($.support && $.support.mozilla) || Mini2.support.msie || Mini2.support.mozilla) {

                //火狐浏览器特殊处理

                var sssIndex = value.lastIndexOf("."),
                    dtStr, sssStr, dt;

                if (sssIndex > 0) {
                    dtStr = value.substring(0, sssIndex);   //获取年月日时分秒
                    sssStr= value.substr(sssIndex + 1); //获取毫秒

                    dtStr = dtStr.replace(/-/g, "/");

                    dt = new Date(dtStr);

                    try {
                        dt.setMilliseconds(sssStr);
                    }
                    catch (ex) {
                        console.log("错误啦...." + ex.message);
                    }

                    value = dt;
                }
                else {
                    value = new Date(value);
                }

            }
            else {
                value = new Date(value);
            }
        }
                
        valueStr = Mini2.Date.format(value, me.format);
        
        return valueStr; ;
    }

});



/************************************************************************/
/*                                           */
/*    ui/grid/column/Time.js                                               */
/*                                           */
/************************************************************************/


/// <reference path="../../define.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.Time', {

    extend: 'Mini2.ui.grid.column.Colunm',

    format: 'H:m',



    defaultRenderer: function (value) {
        "use strict";
        //return Mini2.util.Format.number(value, this.format);

        var me = this,
            valueStr;


        if (value && !Mini2.isDate(value)) {
            value = Mini2.Date.parse(value, me.format);

        }


        valueStr = Mini2.Date.format(value, me.format);

        return valueStr;;
    },

    getTimeObj: function (value) {
        "use strict";
        var me = this;

        if (Mini2.isNumber(value)) {

            var m1 = value % 3600;

            var sec = m1 % 60;

            var hour = (value - m1) / 3600;
            var min = (m1 - sec) / 60;

            return {
                hour: hour,
                minute: min,
                sec: sec
            };
        }
        else {

        }

    },


    // private
    renderer: function (value, metaData, cellValues, record, rowIdx, colIdx, store) {
        "use strict";
        var me = this,
            valueStr,
            srcValue = value;

        var timeObj = me.getTimeObj(value);

        var valueStr = timeObj.hour + ":" + timeObj.minute


        return valueStr;;
    }

});



/************************************************************************/
/*                                           */
/*    ui/grid/column/CheckColumn.js                                        */
/*                                           */
/************************************************************************/


/// <reference path="../../define.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.CheckColumn', {

    extend: 'Mini2.ui.grid.column.Colunm',



    /**
    * true 值显示的文本内容
    */
    trueText: null,

    /**
    * false 值显示的文本内容
    */
    falseText : null,

    /*
    * 设置复选框的状态
    *
    * @parma {bool|'reverse'} checkMode 复选框模式
    */
    setCheckCell:function(col,checkMode){
        var me = this,
            //col = me.owner,
            store = col.store,
            dataIndex = col.dataIndex;

        store.each(function (record, i, len) {
            if ('reverse' == checkMode) {
                var srcValue = !!record.get(dataIndex);
                record.set(dataIndex, !srcValue);
            }
            else {
                record.set(dataIndex, checkMode);
            }
        });

        return me;
    },

    /**
    * 菜单
    */
    menu: [{
        text: '全选',

        click: function () {
            var me = this,
                col = me.owner;
            col.setCheckCell(col, true);
        }

    },{
        text: '反选',
        click: function () {
            var me = this,
                col = me.owner;
            col.setCheckCell(col, 'reverse');
        }
    }, {
        text: '全不选',

        click: function () {
            var me = this,
                col = me.owner;
            col.setCheckCell(col, false);
        }

    }],


    //`'left'`, `'center'`, and `'right'`
    align: 'center',


    renderTpl: [
        '<td role="gridcell" class="mi-grid-cell mi-grid-td mi-grid-cell-checkcolumn">' ,
            '<div class="mi-grid-cell-inner mi-grid-cell-inner-checkcolumn">',

            '</div>',
        '</td>'
    ],


    
    falseIconTpl: '<img class="mi-grid-checkcolumn" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" style=" vertical-align:middle;">',

    trueIconTpl: '<img class="mi-grid-checkcolumn mi-grid-checkcolumn-checked" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" style=" vertical-align:middle;" >',




    defaultRenderer: function (value) {
        return value;
    },


    renderer: function (value, meta) {
        var me = this,
            resultHtml;

        if (!value || value === 'false' ||
            (typeof value == 'string' && value.toLowerCase() == 'false')) {

            resultHtml = me.falseIconTpl;

            if (me.falseText) {
                resultHtml += '<span style="vertical-align:middle;margin-left: 4px;">'+ me.falseText +'</span>';
            }
        }
        else {
            resultHtml = me.trueIconTpl;

            if (me.trueText) {
                resultHtml += '<span style="vertical-align:middle;margin-left: 4px;">' + me.trueText + '</span>';
            }
        }

        return resultHtml;

    }

});






/************************************************************************/
/*                                           */
/*    ui/grid/column/RowNumberer.js                                        */
/*                                           */
/************************************************************************/


/// <reference path="../../define.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.RowNumberer', {

    extend: 'Mini2.ui.grid.column.Colunm',

    headerText: "&#160",


    sortable: false,


    align: 'center', //'right',

    width: 23,

    dataIndex: '',

    rowspan: undefined,

    menuDisabled: true,

    autoLock: true,

    resizable: false,

    renderTpl: [
        '<td role="gridcell" class="mi-grid-cell mi-grid-td mi-grid-cell-row-numberer ">',
            '<div class="mi-grid-cell-inner mi-unselectable mi-grid-cell-inner-row-numberer">',
            '</div>',
        '</td>'
    ],

    initComponent:function(){

        this.constructor.base.initComponent();  //调用上级函数
        
        var me = this,
            sysInfo = Mini2.SystemInfo,
            cfg = sysInfo.table.cols.rowNumberer;


        me.width = cfg.width || 23;

        
    }, 

    defaultRenderer: function (value) {
        return value;
    },

    renderCell: function () {
        "use strict";
        var me = this,
            cellEl;

        cellEl = me.getBufferCellEl();

        if (!cellEl) {

            cellEl = Mini2.$join(me.renderTpl);

            if ('left' != me.align) {
                cellEl.css('text-align', me.align);
            }

            me.setBufferCellEl(cellEl);
        }

        cellEl = cellEl.clone();
        return cellEl;
    },

    // private
    renderer: function (value, metaData, cellValues, record, rowIdx, colIdx, store) {
        "use strict";
        var rowspan = this.rowspan,
            page = store.currentPage,
            result = record.index;

        return (page * store.pageSize + rowIdx + 1);
    }

});



/************************************************************************/
/*                                           */
/*    ui/grid/column/RowCheckColumn.js                                     */
/*                                           */
/************************************************************************/


/// <reference path="../../define.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.RowCheckColumn', {

    extend: 'Mini2.ui.grid.column.Colunm',


    //`'left'`, `'center'`, and `'right'`
    align: 'center',

    width: 40,

    renderTpl: [
        '<td role="gridcell" class="mi-grid-cell mi-grid-td mi-grid-cell-checkcolumn">',
            '<div class="mi-grid-cell-inner mi-unselectable mi-grid-cell-inner-checkcolumn">',
            '</div>',
        '</td>'
    ],

    initComponent: function () {
        "use strict";
        var me = this,
            renderer,
            listeners;

        renderer = me.renderer;

        if (renderer) {

            if (typeof renderer == 'string') {
                //me.renderer = Ext.util.Format[renderer];
            }
            me.hasCustomRenderer = true;
        }
        else if (me.defaultRenderer) {
            me.scope = me;
            me.renderer = me.defaultRenderer;
        }

        me.lockedHeader = true;
        me.headerWidth = 40;
    },


    getHeaderConfig: function () {
        "use strict";
        var me = this,
            showCheck = me.showHeaderCheckbox !== false;

        return {
            isCheckerHd: showCheck,
            text: '&#160;',
            clickTargetName: 'el',
            width: me.headerWidth,
            sortable: false,
            draggable: false,
            resizable: false,
            hideable: false,
            menuDisabled: true,
            dataIndex: '',
            cls: showCheck ? 'mi-column-header-checkbox ' : '',
            renderer: Mini2.Function.bind(me.renderer, me),
            editRenderer: me.editRenderer || me.renderEmpty,
            locked: me.hasLockedHeader()
        };
    },

    checkerOnCls: 'mi-grid-checkcolumn-checked',

    toggleUiHeader: function (isChecked) {

        this.grid.setHeaderCheck(isChecked);

    },

    defaultRenderer: function (value) {
        return value;
    },


    onHeaderClick: function (headerCt, header, isChecked) {
        "use strict";
        var me = this;

        if (header.isCheckerHd) {
            me.grid.setRowCheckAll(isChecked);

        }
    },

    renderEmpty: function () {
        return '&#160;';
    },

    renderer: function (value, meta) {
        "use strict";

        //console.debug('value = ', value);

        if (!value || value === false || value === 'false') {
            return '<img class="mi-grid-checkcolumn" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" >';
        }

        return '<img class="mi-grid-checkcolumn mi-grid-checkcolumn-checked" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="  >';

    },

    onSelectChange: function () {
        "use strict";
        //this.callParent(arguments);
        if (!this.suspendChange) {
            this.updateHeaderState();
        }
    },

    //更新标头的状态
    updateHeaderState: function () {
        "use strict";
        var me = this,
            isChecked = undefined,
            cellEl,
            imgEl,
            isCheck,
            grid = me.grid,
            col = grid.rowCheckColumn,
            rows,
            checkedCount = 0;

        rows = $(grid.tbodyEl).children();
                

        if (rows.length) {
            $(rows).each(function () {
                cellEl = $(this).children("td:eq(" + col.index + ")");
                imgEl = cellEl.find('img.mi-grid-checkcolumn');

                if (imgEl.length) {

                    isCheck = $(imgEl).hasClass("mi-grid-checkcolumn-checked");

                    if (isCheck) {
                        checkedCount++;
                    }

                }

                //if (!isCheck) {
                //    isChecked = false;
                //    return false;
                //}

            });


            if (checkedCount === rows.length) {
                isChecked = true;
            }
            else if (0 === checkedCount ) {
                isChecked = false;
            }
        }
        else {
            isChecked = false;
        }

        me.toggleUiHeader(isChecked);

        return me;
    }



});






/************************************************************************/
/*                                           */
/*    ui/grid/column/Number.js                                             */
/*                                           */
/************************************************************************/


/// <reference path="../../Mini2.js" />
/// <reference path="../../lang/Number.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.Number', {

    extend: 'Mini2.ui.grid.column.Colunm',

    format: '0',        //0,000.00

    align: 'right',

    defaultValue: 0,

    defaultRenderer: function (value) {
        return Mini2.util.Format.number(value, this.format);
    },

    // private
    //value, fieldValue, cellValues, record, recordIndex, columnIndex, store, table
    renderer: function (value, metaData, cellValues, record, rowIdx, colIdx, store) {
        "use strict";
        var me = this,
            result = value,
            format = me.format,
            notDisplayValue = me.notDisplayValue,
            numFormat = Mini2.util.Format.number;
        
        if (notDisplayValue && value == notDisplayValue) {
            return '';
        }

        // 执行样式规则
        var actT = {
            value: value,
            record: record,
            dataIndex: me.dataIndex,
            formatFun: numFormat,
            format: format,
            isAct : false
        };

        try{
            result = me.execStyleRule(actT);
        }
        catch (ex) {
            console.error('渲染"样式规则"错误',ex);
        }

        if (!actT.isAct) {

            try {
                result = numFormat(value, format);
            }
            catch (ex) {
                alert('格式化错误:Mini2.util.Format.number = ' + value + ', format=' + format);
            }
        }

        return result;
    }


});



/************************************************************************/
/*                                           */
/*    ui/grid/column/Template.js                                           */
/*                                           */
/************************************************************************/


/// <reference path="../../define.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.Template', {

    extend: 'Mini2.ui.grid.column.Colunm',

    content: '',

    artTemplate: null, //var render = template.compile(source);

    vurTemplate: null, //

    /**
    * 模板名称  art | vue
    */
    engineName: 'j',    //模板名称



    // private
    renderer: function (value, metaData, cellValues, record, rowIdx, colIdx, store, table, rowEl, cellEl) {
        "use strict";
        var me = this,
            tmpName = me.engineName,
            rendererFn,
            valueStr,
            srcValue = value;

        if ('j' == tmpName) {
            rendererFn = me.renderer_j;;
        }
        else if ('vue' == tmpName) {
            rendererFn = me.renderer_vue;
        }
        else if ('art' == tmpName) {
            rendererFn = me.renderer_art;
        }

        try{
            valueStr = rendererFn.call(me, value, metaData, cellValues, record, rowIdx, colIdx, store, table, rowEl, cellEl);

        }
        catch (ex) {
            console.error("输出错误 ", ex);
        }

        return valueStr;;
    },


    renderer_j:function(value, metaData, cellValues, record, rowIdx, colIdx, store, table, rowEl, cellEl){
        "use strict";
        var me = this,
            valueStr,
            jTemp = me.jTemplate,
            srcValue = value;

        if (!jTemp) {
            jTemp = $.createTemplate(me.content);

            me.jTemplate = jTemp;
        }


        return jTemp.get(record, {
            value: value,
            row_index: rowIdx,
            col_index : colIdx
        });

    },



    curVueTemlateId: null,

    /**
    * 注册 VUE 组件
    *
    */
    regVue: function (cellEl, record) {
        "use strict";
        var me = this,
            vueTemp = me.vueTemplate,
            cptName = 'coltemplate';

        //<mi-progressbar :ex_cls="ex_cls"  :value="value"></mi-progressbar>

        if (!vueTemp) {

            var id = 'templatecolumn';// Mini2.Guid.newGuid('N');

            vueTemp = Vue.extend({
                template: me.content,
                props: ["t"]
            });

            me.vueTemplate = vueTemp;

            // 注册
            Vue.component(id, vueTemp);

            Mini2.vue = Mini2.vue || {};
            Mini2.vue.component = Mini2.vue.component || {};
            Mini2.vue.component[id] = true;

            me.curVueTemlateId = id;
        }


        setTimeout(function () {


            // 创建根实例
            me.vue = new Vue({
                el: cellEl[0], // '<div><templatecolumn :t="t" ></templatecolumn></div>',
                data: {
                    t: record
                }
            });
        }, 1000);

    },

    /**
    * vue.js 渲染
    *
    */
    renderer_vue: function (value, metaData, cellValues, record, rowIdx, colIdx, store, table, rowEl, cellEl) {
        "use strict";
        var me = this,
            valueStr,
            srcValue = value;

        me.regVue(cellEl, record);

        return '<templatecolumn :t="t" ></templatecolumn>';

        //return vueTemp.render();

    },

    renderer_art: function (value, metaData, cellValues, record, rowIdx, colIdx, store, table, rowEl, cellEl) {
        "use strict";
        var me = this,
            valueStr,
            artTemp = me.artTemplate,
            srcValue = value;


        if (!artTemp) {
            me.artTemplate = artTemp = template.compile(me.content);
        }
        
        valueStr = artTemp({
            data:record
        });

        return valueStr;
    }

});



/************************************************************************/
/*                                           */
/*    ui/grid/column/TextArea.js                                           */
/*                                           */
/************************************************************************/



/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../../Mini.js" />


Mini2.define('Mini2.ui.grid.column.TextArea', {

    extend: 'Mini2.ui.grid.column.Colunm',


    renderTpl: [
        '<td role="gridcell" class="mi-grid-cell mi-grid-td ">',
        '<div class="mi-grid-cell-inner" style="white-space:pre-line;">',
        '</div>',
        '</td>'
    ],


    renderer: function (value, fieldValue, cellValues, record, recordIndex, columnIndex, store, table) {
        "use strict";
        var me = this;


        if (!Mini2.isBlank(value)) {
            
            value = value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/ /g, '&nbsp;')
                .replace(/\n/g, '<br />');

        }
        else {
            value = '&nbsp;';
        }

        return value;
    }

});


/************************************************************************/
/*                                           */
/*    ui/grid/column/MoreFileColumn.js                                     */
/*                                           */
/************************************************************************/


/// <reference path="../../Mini2.js" />
/// <reference path="../../lang/Number.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

/**
* 多文件展示
*/
Mini2.define('Mini2.ui.grid.column.MoreFileColumn', {

    extend: 'Mini2.ui.grid.column.Colunm',

    thumbWidth: 72,

    thumbHeight: 72,

    //扩展字段
    innerCls: 'mi-file-panel',

    //内部不隐藏
    innerAutoHide: false,

    dataType: 'text',


    /**
    * 视图类型
    * list=列表模式, large=大图展示
    */
    view: 'large',

    IMAGE_TYPES: ['.jpg', '.jpeg', '.gif', '.png', '.bmp'],

    /**
     * 判断是否为图片类型
     */
    isImgType: function (fileEx) {
        var me = this;

        return Mini2.Array.contains(me.IMAGE_TYPES, fileEx, true);
    },

    createFileEl: function (cfg) {
        "use strict";
        var me = this,
            tW = me.thumbWidth || 16,
            tH = me.thumbHeight || 16;

        var arrUrl = cfg.url.split("/");
        var strPage = arrUrl[arrUrl.length - 1];



        var ldot = cfg.url.lastIndexOf(".");
        var type = cfg.url.substring(ldot).toLowerCase();

        var fileEl;

        console.debug("cfg ==== ", cfg);
        console.debug("type ==== ", type);


        if ('list' == me.view) {

            fileEl = Mini2.$join([
                '<a class="" style="display:block;margin-bottom:6px;" target="_blank" href="', cfg.url, '" title="', cfg.title, '">',
                    '<img class="mi-file-image" src="', cfg.thumb_url || cfg.url, '" data-original=', cfg.url, ' style="height:16px;height:16px; margin-right:4px;">',
                    '<span>', cfg.title, '</span>',
                '</a>'
            ]);

        }
        else if ('large' == me.view) {
            if (!me.isImgType(type)) {
                fileEl = Mini2.$join([
                    '<a class="mi-file thumb " style="width:', me.thumbWidth + 10, 'px;height:', me.thumbHeight + 10, 'px;" target="_blank"  href="', cfg.url, '">',
                        '<div class="mi-file-inner thumb-inner" style="width:', me.thumbWidth, 'px;height:', me.thumbHeight, 'px;">',
                            '<img class="mi-file-image thumb-img" src="', cfg.thumb_url || cfg.url, '"  style="height:100%;">',
                        '</div>',
                    '</a>'
                ]);
            }
            else {
                fileEl = Mini2.$join([
                    '<div class="mi-file thumb " style="width:', me.thumbWidth + 10, 'px;height:', me.thumbHeight + 10, 'px;" target="_blank"  href="', cfg.url, '">',
                        '<div class="mi-file-inner thumb-inner" style="width:', me.thumbWidth, 'px;height:', me.thumbHeight, 'px;">',
                            '<img class="mi-file-image thumb-img" src="', cfg.thumb_url || cfg.url, '" data-original=', cfg.url, ' style="height:100%;">',
                        '</div>',
                    '</div>'
                ]);
            }
        }


        fileEl.attr('title', cfg.title);

        fileEl.attr('data-file-id', cfg.file_id);



        if (me.isImgType(type)) {
            fileEl.addClass('image');
        }
        else {
            var typeName = type.substring(1);

            $(fileEl).find('.mi-file-image').attr('src', '/res/file_icon_256/' + typeName + '.png');
        }

        //$(fileEl).muBind('click', function () {

        //    if ($(this).hasClass('mi-file-check')) {
        //        $(this).removeClass('mi-file-check');
        //    }
        //    else {
        //        $(this).addClass('mi-file-check');
        //    }
        //});

        return fileEl;
    },


    getFieldEl: function () {
        "use strict";
        var me = this,
            slicer = me.slicer,
            inputEl;

        //list=列表模式, large=大图展示

        if ('large' == me.view) {
            inputEl = Mini2.$join([
                '<div>',
                    '<div class="file-inner"  style=" padding:0px; height: ', me.thumbHeight + 10, 'px; overflow: hidden;">',

                    '</div>',
                '</div>'
            ]);
        }
        else if ('list' == me.view) {
            inputEl = Mini2.$join([
                '<div>',
                    '<div class="file-inner"  style=" padding:0px; height: auto; ">',

                    '</div>',
                '</div>'
            ]);
        }


        var fileInnerEl = $(inputEl).children('.file-inner');
        //if (me.name) {
        //    inputEl.attr('name', me.name);
        //}

        inputEl.css({
            'width': me.width,
            'height': me.height
        });


        if (me.readOnly) {
            inputEl.attr('readonly', 'readonly');
        }

        return inputEl;

    },


    addForText: function (fileInnerEl, cfg) {
        "use strict";
        var me = this;

        if (Mini2.isString(cfg)) {

            var ps = cfg.split('||');

            cfg = {
                thumb_url: ps[1] || ps[0],
                url: ps[0],
                title: ps[2],
                code: ps[3] || ''
            };
        }

        try {
            var fileEl = me.createFileEl(cfg);

            fileInnerEl.append(fileEl);

        }
        catch (ex) {
            console.error("text", cfg);
            console.error('添加对象失败', ex);
        }
    },


    renderer: function (value, fieldValue, cellValues, record, recordIndex, columnIndex, store, table) {
        "use strict";
        var me = this,
            fieldEl;

        fieldEl = me.getFieldEl();


        try {
            var fileInnerEl = $(fieldEl).find('.file-inner');

            var count = 0;

            if ('text' == me.dataType) {

                if (!Mini2.isBlank(value)) {
                    var lines = value.split('\n');

                    for (var i = 0; i < lines.length; i++) {

                        var text = lines[i];

                        if (Mini2.isBlank(text)) {
                            continue;
                        }

                        try {
                            me.addForText(fileInnerEl, text);

                            count++;
                        }
                        catch (ex) {
                            console.error("text", text);
                            console.error('添加对象失败', ex);
                        }
                    }

                    if (count == 0) {
                        return '';
                    }
                }
                else {
                    return '';
                }

            }

            var newGroupId = 'boxer' + Mini2.newId();

            var aImgs = fileInnerEl.children('.image');

            aImgs.attr('rel', newGroupId);

            if ('large' == me.view) {
                fileInnerEl.css('width', count * (me.thumbWidth + 10 + 12));
            }
            else if ('view' == me.view) {
                fileInnerEl.css('height', count * (16));
            }
        }
        catch (ex2) {

            console.error("eeeeeeeeeeee", ex2);

        }


        return fileInnerEl;
    },


    bindEvent: function (view, cell, recordIndex, cellIndex, e, record, row) {
        "use strict";
        var me = this,
            innerEl = cell.find('.file-inner:first');

        cell.children('.mi-grid-cell-inner').css('max-height', me.thumbHeight + 36);

        var imgBoxEl = innerEl.children();


        if (window.Viewer) {

            if (0 !== imgBoxEl.length) {
                me.initPreviewEl(cell, innerEl);
            }
        }
        else {
            imgBoxEl.boxer({

            });
        }


        //$(btns).muBind('mousedown', Mini2.emptyFn)
        //.muBind('mouseup', function (e2) {

        //    me.processEvent("mouseup", view, cell, recordIndex, cellIndex, e2, record, row);

        //    Mini2.EventManager.stopEvent(e2);

        //}).on('click', function (e2) { return false; });
    },



    /**
     * 初始化预览元素
     */
    initPreviewEl: function (cellEl, imgBoxEl) {
        var me = this,
            time = cellEl.data('preview_time'),
            el = cellEl.data('preview_el');


        if (time) {
            time.resetStart();
            return;
        }


        time = Mini2.setTimer(function () {

            if (el) {
                el.update();
            }
            else {
                el = new Viewer(cellEl[0], {
                    url: 'data-original'
                });

                cellEl.data('preview_el', el);
            }

        }, [1000, 1])

        cellEl.data('preview_time', time);
    }

});





/************************************************************************/
/*                                           */
/*    ui/grid/column/PropertyColumn.js                                     */
/*                                           */
/************************************************************************/


/// <reference path="../../../Mini.js" />
/// <reference path="../../../lang/Number.js" />
/// <reference path="../../../lang/Date.js" />

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.PropertyColumn', {

    extend: 'Mini2.ui.grid.column.Colunm',

    isPropertyColumn: true,

    dateFormat: 'Y-m-d',

    trueText: 'true',

    falseText:'false',

    propEditor: {},

    defaultRenderer: function (value) {
        return value;
    },

    // private
    renderer: function (value, metaData, cellValues, record, rowIdx, colIdx, store) {
        "use strict";
        var me = this,
            vType = record.data['Type'] || 'string';


        if ('bool' == vType && Mini2.isBoolean(value)) {
            return me.renderBool(value);
        }
        else if ('date' == vType && Mini2.isDate(value)) {
            return Mini2.Date.format(value, me.dateFormat);
        }

        return value;
    },

    renderBool : function(bVal) {
        return this[bVal ? 'trueText' : 'falseText'];
    },

});



/************************************************************************/
/*                                           */
/*    ui/grid/feature/Summary.js                                           */
/*                                           */
/************************************************************************/


/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../../Mini.js" />

//摘要
Mini2.define('Mini2.ui.grid.feature.Summary', {


    renderTo: Mini2.getBody(),

    grid: null,

    el: null,

    columns: null,

    height: 30,

    width: 1024,

    //索引
    //items: false,

    panelTpl: [
        '<div class="mi-component mi-docked-summary mi-docked-summary-bottom  mi-component-default mi-docked-bottom mi-component-docked-bottom mi-component-default-docked-bottom mi-noborder-rbl" ',
            'style="overflow: hidden; width: 489px; right: auto; left: 0px; top: 352px; height:30px;">',
            '<div data-ref="innerCt" class="innerCt" role="presentation" style="width: 506px; position: absolute; ">',

            '</div>',
        '</div>'
    ],

    tableTpl: [
        '<table data-ref="item" cellpadding="0" cellspacing="0" class="mi-grid-item mi-grid-with-col-lines" ',
            '>',
            '<tbody>',
                '<tr class="mi-grid-row-summary " tabindex="-1">',

                '</tr>',
            '</tbody>',
        '</table>'
    ],

    cellTpl: [
        '<td class="mi-grid-cell mi-grid-td mi-grid-cell-first mi-unselectable" ',
            'style="width: 125px;" >',
            '<div unselectable="on" class="mi-grid-cell-inner " style="text-align: left;">',
                '&nbsp;',
            '</div>',
        '</td>'
    ],



    //初始化组件
    initComponent: function () {

        var me = this,
            store = me.store;

        me.items = {};
    },


    bindStore: function () {
        var me = this,
            store = me.store;


        $(store).muBind('summarychnaged', me, me.store_summaryChnaged);
    },


    store_summaryChnaged: function (event, summary) {
        "use strict";
        var me = event.data;

        if (summary) {
            me.setSummary.call(me, summary);
        }
    },

    setSummary: function (field, value) {
        "use strict";
        var me = this,
            cols = me.columns,
            items = me.items,
            cellInnerEl,

            fields;

        if (Mini2.isString(field)) {
            fields = {};
            fields[field] = value;
        }
        else {
            fields = field;
        }

        for (field in fields) {

            cellInnerEl = items[field];

            
            if (cellInnerEl) {
                value = fields[field];

                var col = me.findColumnByField(field);

                if (!Mini2.isBlank(col.summaryFormat)) {


                    if (Mini2.isNumber(value) && !Mini2.String.isBlank(col.format)) {

                        try {
                            value = Mini2.util.Format.number(value, col.format);
                        }
                        catch (ex) {
                            console.error('格式化数字错误.', ex);
                        }
                    }


                    var valueStr = $.format(col.summaryFormat, value);
                    cellInnerEl.html(valueStr);

                }
                else {
                    cellInnerEl.html(value);
                }

            }
        }

    },

    findColumnByField: function (field) {
        "use strict";
        var me = this,
            cols = me.columns,
            col;

        for (var i = 0; i < cols.length; i++) {

            col = cols[i];

            if (col.dataIndex == field) {
                
                return col;
            }
        }

        return null;
    },

    createCell: function (col) {
        "use strict";
        var me = this,
            cellEl,
            cellInnerEl;

        cellEl = Mini2.$joinStr(me.cellTpl);

        cellInnerEl = cellEl.children('.mi-grid-cell-inner');

        if (col.summaryType) {
            cellInnerEl.data('me', col);
            me.items[col.dataIndex] = cellInnerEl;

            cellInnerEl.css({
                'font-size': '14px',
                'font-weight': 'bold'
            });

            cellInnerEl.css({
                'text-align': col.align
            });
        }

        return cellEl;
    },


    createCellGroups: function () {
        "use strict";
        var me = this,
            i=0,
            col,
            cols = me.columns,
            tableEl,
            rowSummaryEl,
            cellEl,
            tabWidth = 0;

        tableEl = Mini2.$joinStr(me.tableTpl);
        rowSummaryEl = tableEl.find('.mi-grid-row-summary');



        for (; i < cols.length; i++) {
            col = cols[i];

            if (!col) {
                continue;
            }

            cellEl = me.createCell(col);

            cellEl.css({
                width: (col.width - 1) + "px"
            });

            cellEl.children('.mi-grid-cell-inner').width(col.width - 1);

            tabWidth += col.width;

            rowSummaryEl.append(cellEl);
        }

        //tableEl.css('width', tabWidth);


        return tableEl;
    },

    setWidth: function (value) {
        "use strict";
        var me = this,
            el = me.el,
            innerCtEl = me.innerCtEl,
            tableEl = me.tableEl;

        me.width = value;

        el.css("width", value - 20);

        innerCtEl.css("width", value);
        //tableEl.css("width", value);

        return me;
    },


    scrollLeft: function (x) {
        var me = this,
            el = me.el,
            innerCtEl = me.innerCtEl;

        innerCtEl.css('left', -x);

        return me;
    },


    resizeCellWidth: function () {
        "use strict";
        var me = this,
            i,
            col,
            cols = me.columns,
            tableEl = me.tableEl,
            rowSummaryEl,
            cellEl,
            tabWidth = 0;


        rowSummaryEl = tableEl.find('.mi-grid-row-summary');

        var cellEls = $(rowSummaryEl).children('.mi-grid-cell');

        for (i = 0; i < cols.length; i++) {
            col = cols[i];

            if (col.visible) {
                cellEl = $(cellEls[i]);

                cellEl.css({
                    width: (col.width - 1) + "px"
                });

                cellEl.children('.mi-grid-cell-inner').width(col.width - 9);

                tabWidth += col.width;

                cellEl.show();
            }
            else {

                cellEl.hide();
            }

        }

        //tableEl.css('width', tabWidth);
    },

    reset: function () {
        "use strict";
        var me = this,
            el = me.el,
            tableEl,
            innerCtEl;

        $(me.tableEl).remove();

        me.innerCtEl = innerCtEl = el.children('.innerCt');

        me.tableEl = tableEl = me.createCellGroups();

        innerCtEl.append(tableEl);

        var w = me.grid.getWidth();

        me.setWidth(w);
    },

    render: function () {
        "use strict";
        var me = this,
            store = me.store,
            grid = me.grid,
            el,
            innerCtEl,
            tableEl;

        me.el = el = Mini2.$joinStr(me.panelTpl);

        if (me.applyTo) {
            $(me.applyTo).append(el);
        }
        else {
            $(me.renderTo).append(el);
        }


        me.innerCtEl = innerCtEl = el.children('.innerCt');

        me.tableEl = tableEl = me.createCellGroups();

        innerCtEl.append(tableEl);


        if (store && store.summary) {
            me.setSummary(store.summary);
        }

        me.bindStore();


        var w = me.grid.getWidth();

        me.setWidth(w);
    }

}, function (args) {
    var me = this;

    Mini2.apply(me, args);
    me.initComponent();

});


/************************************************************************/
/*                                           */
/*    ui/grid/column/TreeColumn.js                                         */
/*                                           */
/************************************************************************/


/// <reference path="../../Mini2.js" />
/// <reference path="../../lang/Number.js" />
/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define('Mini2.ui.grid.column.TreeColumn', {

    extend: 'Mini2.ui.grid.column.Colunm',

    format: '0',        //0,000.00

    align: 'right',

    defaultValue: 0,


    renderTpl: [
    '<td role="gridcell" class="mi-grid-cell mi-grid-td mi-grid-cell-treecolumn">',
        '<div class="mi-grid-cell-inner mi-grid-cell-inner-treecolumn tree-node" style="padding-top:0px;padding-bottom:0px;" >',
        '</div>',
    '</td>'
    ],

    defaultRenderer: function (value) {
        return value;
    },


    renderCell: function () {
        var me = this,
            cellEl,
            innerEl;

        cellEl = me.getBufferCellEl();

        if (!cellEl) {
            cellEl = Mini2.$joinStr(me.renderTpl);

            innerEl = cellEl.children('.mi-grid-cell-inner');
            innerEl.css('text-align', me.align);

            me.setBufferCellEl(cellEl);
        }

        cellEl = cellEl.clone();

        return cellEl;
    },

    // private
    //metaData :原字段值
    //cellValues : 字段值集合
    //record : 实体
    renderer: function (value, metaData, cellValues, record, rowIdx, colIdx, store,view,rowEl,cellEl) {
        var me = this,
            result,
            rootId = store.rootId,
            valueField = store.valueField,
            textField = store.textField,
            parField = store.parField;


        try{


            result = '<i class="tree-icon tree-ocl" ></i>' +
                     '<a class="tree-anchor"><i class="tree-icon tree-themeicon"></i> ' + value + '</a>';


        }
        catch (ex) {
            alert(ex.message);
        }

        return result;
    },


    bindEvent: function (view, cell, recordIndex, cellIndex, e, record, row) {

        var me = this,
            btns = cell.find("i.tree-icon");

        $(btns).muBind('mousedown', Mini2.emptyFn)
        .muBind('mouseup', function (e2) {

            me.processEvent("mouseup", view, cell, recordIndex, cellIndex, e2, record, row);

            Mini2.EventManager.stopEvent(e2);
        });
    },


    processEvent: function (type, view, cell, recordIndex, cellIndex, e, record, row) {

        var column = this,
            me = e.currentTarget,
            item,
            items = this.items,
            node = $(row).data('tree-node');


        view.toggleNode(node,row,cell);

    }


});



/************************************************************************/
/*                                           */
/*    ui/grid/CellContext.js                                               */
/*                                           */
/************************************************************************/



Mini2.define('Mini2.ui.grid.CellContext', {


    isCellContext: true,

    constructor: function (view) {
        this.view = view;
    },

    setPosition: function (row, col) {
        "use strict";
        var me = this;

        // We were passed {row: 1, column: 2, view: myView}
        if (arguments.length === 1) {
            if (row.view) {
                me.view = row.view;
            }
            col = row.column;
            row = row.row;
        }

        me.setRow(row);
        me.setColumn(col);

        return me;
    },


    setRow: function (row) {
        "use strict";
        var me = this;

        if (row !== undefined) {
            // Row index passed
            if (typeof row === 'number') {
                me.row = Math.max(Math.min(row, me.view.dataSource.getCount() - 1), 0);
                me.record = me.view.dataSource.getAt(row);
            }
            // row is a Record
            else if (row.isModel) {
                me.record = row;
                me.row = me.view.indexOf(row);
            }
            // row is a grid row
            else if (row.tagName) {
                me.record = me.view.getRecord(row);
                me.row = me.view.indexOf(me.record);
            }
        }
    },


    setColumn: function (col) {
        "use strict";
        var me = this,
            columnManager = me.view.ownerCt.columnManager;

        if (col !== undefined) {
            // column index passed
            if (typeof col === 'number') {
                me.column = col;
                me.columnHeader = columnManager.getHeaderAtIndex(col);
            }
            // column Header passed
            else if (col.isHeader) {
                me.columnHeader = col;
                me.column = columnManager.getHeaderIndex(col);
            }
        }

    }


});


/************************************************************************/
/*                                           */
/*    ui/grid/CellEditor.js                                                */
/*                                           */
/************************************************************************/

/// <reference path="../Mini2.js" />
/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />


Mini2.define('Mini2.ui.grid.CellEditor', {


    extend: 'Mini2.ui.Editor',

    log: Mini2.Logger.getLogger('Mini2.ui.grid.CellEditor'),  //日志管理器

    grid: null,

    el: null,
    inputObj: null,

    renderTo: Mini2.getBody(),

    rowEl: null,
    cellEl: null,

    record: null,
    columnHeader: null,

    xtype: 'TextColumn',

    readOnly: false,

    isInput: true,



    //初始化组件
    initComponent: function () {

        var me = this;





    },




    focus: function () {
        "use strict";
        var me = this,
            log = me.log;

        //log.begin("CellEditor.focus()");

        //log.debug("cellEl = " + me.cellEl);

        me.inputObj.focus();

        //Mini2.ui.FocusMgr.setControl(me, me.cellEl, me.el);

        //me.on('foncusin');

        //log.end();

        return me;
    },


    getBox: function () {
        "use strict";
        var boxHtml = Mini2.$joinStr(['<div class="',
            'mi-editor ',
            'mi-small-editor ',
            'mi-grid-editor ',
            'mi-grid-cell-editor ',
            'mi-layer ',
            'mi-editor-default ',
            '" ',
            'style="right: auto;left: 0px;top: -91px;z-index: 19000;position: relative;" ',
        '>',

        '</div>']);

        //'mi-border-box ',


        return boxHtml;
    },

    css: function (name, value) {
        "use strict";
        var me = this,
            el = me.el;

        return el.css(name, value);
    },

    setSize: function (w, h) {
        "use strict";
        var me = this,
            args = arguments,
            sz = args[0],
            inputObj = me.inputObj;

        if (args.length && typeof sz == 'object') {
            inputObj.setWidth(sz.width);
            inputObj.setHeight(sz.height);
        }
        else {
            inputObj.setWidth(w);
            inputObj.setHeight(h);
        }

        return me;
    },

    setWidth: function (value) {

        var me = this;

        me.inputObj.setWidth(value);

        return me.el.css("width", value);
    },

    setHeight: function (value) {

        var me = this;

        me.inputObj.setHeight(value);

        return me.el.css("height", value);
    },


    show: function () {

        var me = this;

        //me.el.addClass("mi-form-trigger-wrap-focus");
        
        me.visible = true;
        me.el.show();

        return me;
    },

    setRowCell: function (rowEl, cellEl) {
        var me = this;

        me.rowEl = rowEl;
        me.cellEl = cellEl;

        return me;
    },

    setRow: function (rowEl) {
        var me = this;

        me.rowEl = rowEl;
        return me;
    },

    setCell: function (cellEl) {

        var me = this;

        me.cellEl = cellEl;
        return me;
    },

    setCellValue: function (value) {

        var me = this,
            log = me.log;

        //var div = $(me.cellEl).children("div.mi-grid-cell-inner:first");
        //var text = $(div).text();

        //log.debug('setCellValue(...) ', value);
        

        me.inputObj.setValue(value);

        return me;
    },

    setValue: function (value) {
        var me = this;

        me.setCellValue(value);

        return me;
    },
    
    isVisible:function(){
        var me = this,
            el = me.el;

        return $(el).is(":visible");
    },

    isHidden: function () {
        var me = this,
            el = me.el;

        return $(el).is(":hidden");
    },

    hide: function () {
        "use strict";
        var me = this,
            cellEl = me.cellEl;

        if (!me.visible) {
            return;
        }

        me.visible = false;
        me.el.hide();


        if (me.editing && me.lastKeyCode != '27') {
            //log.debug("保存单元格数据。hide()");

            me.inputSave(cellEl);

            me.endEdit();
        }

        $(cellEl).cFirst("div.mi-grid-cell-inner").show();

        me.cellEl = null;

        return me;
    },

    layoutReset: function () {
        var me = this;

        me.inputObj.layoutReset();
    },

    inputSave: function (cell, evt) {
        "use strict";
        /// <summary>保存数据</summary>

        var me = this,
            log = me.log,
            inputObj = me.inputObj;

                //log.begin("inputSave() " + me.grid.clientId);

        //        log.debug("me.editing = " + me.editing);

        //        log.debug("inputObj.isValueChanged() = " + inputObj.isValueChanged());

        if (me.editing ) {

            //log.debug("inputObj.isValueChanged = " + "准备");


            if (me.autoTrim) {
                var srcValue = inputObj.getValue();

                if (srcValue && Mini2.isString(srcValue)) {
                    var curValue = Mini2.String.trim(srcValue);

                    if (curValue != srcValue) {
                        inputObj.setValue(curValue);
                    }
                }
            }

            var isValueChanged = (inputObj.isValueChanged ? inputObj.isValueChanged() : true);

            //log.debug("inputObj.isValueChanged = " + isValueChanged);

            if (isValueChanged) {

                var value = me.inputObj.getValue();
                
                var dataIndex = me.columnHeader.dataIndex;

//                if (me.inputObj.cellDisplayField) {
//                    var text = me.inputObj.text;
//                    me.record.set(me.inputObj.cellDisplayField, text);
//                }

                //注释掉，采用其他地方【2015-5-7 11：37】
                var newValues = me.getNewValuesForMap(me.record, inputObj.curRecord);

                if (newValues) {
                    newValues[dataIndex] = newValues[dataIndex] || value;
                }
                else {

                    if (evt && me.mapItems && evt.keydown && 13 === evt.keyCode) {
                        //回车 + 映射 = 不处理
                    }
                    else {
                        newValues = {};
                        newValues[dataIndex] = value;
                    }
                }
                

                if (newValues) {
                    me.record.set(newValues);
                }


                //log.debug("保存数据: " + dataIndex + " = " + value);
            }
        }

        //        log.debug("---------------");
        //        log.end();
    },


    //设置映射值
    getNewValuesForMap: function (record, srcRecrod) {
        "use strict";

        var me = this,
            log = me.log,
            i,
            item,
            mapItems = me.mapItems,
            newValues = null,
            srcValue,
            srcField;

        if (srcRecrod && mapItems) {
            
            for (i = 0; i < mapItems.length; i++) {

                item = mapItems[i];

                srcField = item.srcField;

                if ('' == srcField || '' == item.targetField) {
                    continue;
                }

                if (srcRecrod) {
                    if (srcRecrod.get) {
                        srcValue = srcRecrod.get(srcField);
                    }
                    else {
                        srcValue = srcRecrod[srcField];
                    }
                }
                else {
                    srcValue = null;
                }
                
                newValues = newValues || {};
                
                newValues[item.targetField] = srcValue;
            }

        }

        return newValues
    },



    isFirstCursorPos: function () {
        "use strict";
        var me = this,
            inputObj = me.inputObj;

        if(inputObj.isFirstCursorPos){
            
            return inputObj.isFirstCursorPos();
        }

        return false;
    },


    isLastCursorPos: function () {
        "use strict";
        var me = this,
            inputObj = me.inputObj;

        if (inputObj.isLastCursorPos) {
            return inputObj.isLastCursorPos();
        }

        return false;

    },

    proKeyEvent: function (e) {
        "use strict";
        var me = this,
            inputObj = me.inputObj;

        //log.debug("---------------------");
        //console.log(inputObj);

        
         me.onKeydown(e);
        

        return false;
    },

    proKeyEvent2: function (e) {
        "use strict";
        var me = this,
            inputObj = me.inputObj;

        //log.debug("---------------------");
        //console.log(inputObj);

        if (inputObj && inputObj.proKeyEvent) {

            return inputObj.proKeyEvent(e);
        }

        return false;
    },


    lastKeyCode: 0,


    onKeydown: function (e) {
        "use strict";
        var me = this,
            log = me.log,
            inputObj = me.inputObj,
            cellEl = me.cellEl;

        var keyCode =  e.keyCode;

        // 13 = 回车
        // 9  = Tab 键
        // 27 = Esc

        me.lastKeyCode = keyCode;
        
        //log.debug('keyCode = ' + keyCode);

        //console.log(e);

        //log.debug("========================== " + keyCode);

        if (13 == keyCode) {    //13 = 回车
            

            me.proKeyEvent2({
                keyCode:keyCode
            });


            if (e.stoped) { return; }


            me.inputSave(me.cellEl, {

                keydown: true,

                keyCode: keyCode
                
            });

            me.endEdit();



            Mini2.ui.FocusMgr.setControl(me.cellEl);


            me.visible = false;
            me.el.hide();
            $(cellEl).cFirst("div.mi-grid-cell-inner").show();
            me.cellEl = null;

            //Mini2.EventManager.stopEvent(e);

        }
        else if (9 == keyCode) {    // 9  = Tab 键

            me.inputSave(me.cellEl);
            me.endEdit();


            var nextCellEl = $(me.cellEl).next();

            if (nextCellEl.length ) {
                me.grid.autoFocusScroll(nextCellEl);

                Mini2.EventManager.stopEvent(e);
            }

            me.visible = false;
            me.el.hide();
            $(cellEl).cFirst("div.mi-grid-cell-inner").show();
            me.cellEl = null;
        }
        else if (27 == keyCode) {   // 27 = Esc
            me.record.cancelEdit();


            Mini2.ui.FocusMgr.setControl(me.cellEl);

            me.visible = false;
            me.el.hide();
            $(cellEl).cFirst("div.mi-grid-cell-inner").show();
            me.cellEl = null;

            Mini2.EventManager.stopEvent(e);
        }
        else {

        }

    },


    gotoNextCell: function (nCellEl,e) {
        "use strict";
        var me = this,
            log = me.log,
            grid = me.grid;

        var n = me.columnHeader.index + 1;
        var colHead = grid.m_Cols[n];

        if (colHead.miType == 'checkcolumn') {

            me.hide();
            Mini2.ui.FocusMgr.setControl(nCellEl, grid, null);

            return;
        }
        else if (colHead.miType == 'rowcheckcolumn') {
            return;
        }
        else if (colHead.miType == 'actioncolumn') {
            return;
        }

        //如果没有编辑器模式，就退出
        if (!colHead.editor || colHead.editorMode == 'none') {
            //log.debug("没有编辑模式.退出");

            Mini2.ui.FocusMgr.setControl(nCellEl, grid, null);

        }
        else {
            var editor = grid.getEditor(colHead, me.record);
            grid.showEditor(nCellEl, nCellEl, me.rowEl, colHead, me.record, editor);

            Mini2.EventManager.stopEvent(e);
        }
    },

    onKeyup: function (e) {
        "use strict";
        var me = this,
            keyCode = e.keyCode;


        if (9 == keyCode) {
            var nCellEl = $(me.cellEl).next();

            if (nCellEl.length) {
                me.gotoNextCell(nCellEl,e);
            }
        }
        else if (13 == keyCode) {

            console.debug("休息休息");
            
            Mini2.EventManager.stopEvent(e);
        }
        else {
            me.on('keyup', e);
        }
    },


    bind_key: function (inputObj) {
        "use strict";
        var me = this;

        inputObj.bind('keydown', function (e) {
            me.onKeydown(e);
        })
        .bind('keyup', function (e) {
            me.onKeyup(e);
        });

    },

    bind_mouse: function (inputObj) {
        "use strict";
        var me = this;

        $(me.inputObj)
        .muBind('mousedown', function (e) {


            me.on('mousedown', e);

        })
        .muBind('mouseup', function (e) {


            me.on('mouseup', e);

        })
        .muBind('mousemove', function (e) {

            //me.on('mousemove', e);

        });

    },



    render: function (boxType) {
        "use strict";
        /// <summary>创建容器</summary>

        var me = this,
            log = me.log,
            conBasePath = 'Mini2.ui.form.field',
            conFullname,
            el,
            subControlConfig,
            inputObj;


        me.el = el = $(me.getBox());
        me.visible = false;

        el.data('me', me);

        switch (me.xtype.toLowerCase()) {
            case 'combobox': conFullname = conBasePath + '.ComboBox'; break;
            case 'comboboxbase': conFullname = conBasePath + '.ComboBoxBase'; break;
            case 'datefield': conFullname = conBasePath + '.Date'; break;
            case 'numberfield': conFullname = conBasePath + '.Number'; break;
            case 'trigger': conFullname = conBasePath + '.Trigger'; break;
            case 'textarea': conFullname = conBasePath + '.TextArea'; break;
            case 'timefield': conFullname = conBasePath + '.Time'; break;
            case 'more_file': conFullname = conBasePath + '.MoreFileEditor'; break;
            case 'password': conFullname = conBasePath + '.Password'; break;

            default: conFullname = conBasePath + '.Text'; break;
        }


        subControlConfig = Mini2.applyIf({
            renderTo: el,
            scope: me,
            grid: me.grid,
            autoTrim : me.autoTrim,
            labelable: {
                hideLabel: true
            },
            placeholder: me.placeholder
        }, me.config);

        

        //if (colHead && colHead.placeholder) {

        //    subControlConfig.placeholder = colHead.placeholder;
        //}
        

        me.inputObj = inputObj = Mini2.create(conFullname, subControlConfig);

        inputObj.render();

        $(me.renderTo).append(el);

        me.bind_key(inputObj);
        me.bind_mouse(inputObj);


        $(me).muBind('focusin', function (e) {

            var me = this;

            me.inputObj.focus();


        })
        .muBind('focusout', function (e, muObj) {
            var me = this;

            if (muObj.data != me.cellEl) {

                if (27 != me.lastKeyCode) {

                    me.inputSave(muObj.data);

                    me.endEdit();
                }
            }

            //console.log('muObj.target = ', muObj.target);



            if (muObj.target != me) {

                me.hide();

                me.inputObj.on('focusout', muObj);

            }

        });

    },



    hideDropDownPanel: function () {
        "use strict";
        var me = this,
            inputObj = me.inputObj;

        if (inputObj && inputObj.hideDropDownPanel) {

            me.inputSave(me.cellEl);
            inputObj.hideDropDownPanel();

        }

        return me;
    },


    init: function (grid) {
        this.grid = grid;


    },

    onInit: function () {

        this.init();
    },

    isCellEditable: function (record, columnHeader) {


    },


    input_mapping: function (data) {
        "use strict";
        var me = this,
            values = {},
            inputObj = me.inputObj,
            mapItems = me.mapItems,
            record = me.record;


        if (mapItems) {
            $(mapItems).each(function () {

                var src = this.srcField;
                var target = this.targetField;

                values[target] = data[src];
            });
        }

        record.set(values);


    },

    startEdit: function (record, columnHeader, /* private */context) {
        "use strict";
        var me = this,
            inputObj = me.inputObj,
            colHead = columnHeader;

        //log.begin("CellEditor.startEdit(...)");

        record.beginEdit(); //.editing = true;

        me.record = record;
        me.columnHeader = colHead;

        context.originalValue = context.value = record.get(colHead.dataIndex);

        if (inputObj.setOldValue) {
            inputObj.setOldValue(context.value);
        }
        else {
            inputObj.oldValue = context.value;
        }
        inputObj.record = record;
        inputObj.dataIndex = colHead.dataIndex;
        inputObj.mapItems = me.mapItems;

        inputObj.cellDisplayField = colHead.displayField;   //警告：不能用 'displayField' 当做属性赋值。跟下拉控件的 'displayField' 属性冲突

        inputObj.map = me.input_mapping;

        me.setCellValue(context.value);

        me.show();

        //inputObj.focus();

        me.editing = true;

        //log.end();

        return me;
    },


    showEditor: function (ed, context, value) {


    },

    getEditor: function (record, column) {



    },

    getCell: function (record, column) {
        var me = this;

        return me.cell;
    },



    cancelEdit: function () {

        var me = this,
            record = me.record;

        //log.begin("CellEditor.cancelEdit(...)");

        record.cancelEdit();

        me.editing = false;

        //log.end();
    },

    endEdit: function () {
        var me = this,
            record = me.record;

        //log.begin("CellEditor.endEdit(...)");

        record.endEdit();

        me.editing = false;
        //log.end();
    },


    onShow: function () {

    },

    onHide: function () {



    },

    afterRender: function () {

    },

    onEditorTab: function () {


    },


    startEditByPosition: function (position) {
        "use strict";
        var me = this,
            inputObj = me.inputObj;

        me.css({
            left: position.left,
            top: position.top + 2
        });

        if (inputObj && inputObj.onPositionChanged) {
            inputObj.onPositionChanged();
        }
        return me;
    },

    /**
    * 删除自身编辑器
    */
    remove: function () {
        var me = this;

        me.el.remove();

        return me;
    }


});


/************************************************************************/
/*                                           */
/*    ui/tree/Panel.js                                                     */
/*                                           */
/************************************************************************/

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini.js" />
/// <reference path="../../../../jstree/3.0.2/jstree.js" />

//焦点管理
Mini2.define('Mini2.ui.tree.Panel', {

    extend: 'Mini2.ui.Component',


    log: Mini2.Logger.getLogger('Mini2.ui.tree.Panel', console),

    treeCls: Mini2.baseCSSPrefix + 'tree-panel',


    rootId: '0',

    store: false,

    rowLines: false,

    lines: true,

    rootVisible: true,

    displayField: 'text',

    //显示复选框
    checkbox: false,

    /**
     * 节点渲染加工器
     *
     */
    nodeRenderer: null,

    el: null,

    data: false,

    showMenu: true,
    showMenuDelete: true,
    showMenuNew: true,
    showMenuRename: true,


    valueField: 'value',

    textField: 'text',

    //父节点字段名
    parField: 'par_id',


    typeField: 'type',

    iconField: 'icon',

    autoExpand: true,


    /**
    * 节点类型名称
    */
    nodeTypeText: '分类',

    rootText: '分类目录',

    /**
    * 动态加载
    */
    dymLoad: true,

    /**
    * 显示根节点
    */
    showRoot: true,


    //移动节点的 Json 数据
    //moveNodeJson : {},


    //允许拖拉
    //allowDragDrop :false,

    /*自定义菜单*/
    contextMenu: [],


    //焦点节点
    focusNode: null,


    //触发创建事件
    triggerEvent_create: false,

    //触发重命名事件
    triggerEvent_rename: false,

    //触发删除事件
    triggerEvent_remove: false,


    //触发服务器事件
    triggerEvent_selected: false,


    //节点选择事件
    nodeSelected: function (fun) {
        this.bind('nodeSelected', fun);
    },

    //节点打开
    nodeExpand: function (fun) {
        this.bind('nodeExpand', fun);
    },


    //节点选择事件
    nodeRename: function (fun) {
        this.bind('nodeRename', fun);
    },


    /**
    * @cfg {Mini2.data.Model/Ext.data.NodeInterface/Object} root
    * Allows you to not specify a store on this TreePanel. This is useful for creating a simple tree with preloaded
    * data without having to specify a TreeStore and Model. A store and model will be created and root will be passed
    * to that store. For example:
    *
    *     Mini2.create('Mini2.ui.tree.Panel', {
    *         title: 'Simple Tree',
    *         root: {
    *             text: "Root node",
    *             expanded: true,
    *             children: [
    *                 { text: "Child 1", leaf: true },
    *                 { text: "Child 2", leaf: true }
    *             ]
    *         },
    *         renderTo: Mini2.getBody()
    *     });
    */
    root: null,

    isTree: true,

    initComponent: function () {
        "use strict";
        var me = this;

        console.debug("初始化 TreePanel.initComponent()");

        if (me.id && undefined == me.clientId) {
            me.clientId = me.id;
        }

        if (me.selected) {
            me.nodeSelected(me.selected);

            delete me.selected;
        }

        if (me.expand) {
            me.nodeExpand(me.expand);

            delete me.expand;
        }

        if (me.rename) {
            me.nodeRename(me.rename);
            delete me.rename;
        }


        var nodeRenderer = me.nodeRenderer;
        if (nodeRenderer) {

            if (Mini2.isString(nodeRenderer)) {

                try {
                    var funStr = '(function(e, node){' + nodeRenderer + '})';
                    var fun = eval(funStr);

                    console.debug('fun = ', fun);

                    delete me.nodeRenderer;
                    me.nodeRenderer = fun;
                }
                catch (ex) {
                    console.error('编译动态脚本 nodeRenderer 函数错误:' + funStr);
                }
            }

        }

    },


    setSize: function (w, h) {
        var me = this,
            el = me.el;

        if (undefined != w) {
            el.css('width', w);
        }

        if (undefined != h) {
            el.css('height', h);
        }

    },


    css: function (styleName, styleValue) {
        var me = this,
            el = me.el;

        return el.css(styleName, styleValue);
    },


    isVisible: function () {
        var me = this,
            el = me.el;

        return el.is(':visible');
    },


    getStore: function () {

        var me = this;

        if (!me.store) {
            var newStore = Mini2.create('Mini2.data.Store', {
                storeId: "MiniStore_" + Mini2.getIdentity()
            });

            me.bindStore(newStore);

        }

        return me.store;
    },


    initStore: function () {
        "use strict";
        var me = this,
            store;


        if (me.store) {

            console.info('开始初始化数据仓库 TreePanel.initStore().');

            store = Mini2.data.StoreManager.lookup(me.store);

            //console.debug("store", store);

            delete me.store;

            me.store = store;

            me.bindStore(store);

            me.proLineData(store.data);

        }


    },




    /** region Store **/

    bindStore: function (store) {

        var me = this;

        $(store)
            .muBind('update', me, me.store_update)
            .muBind('add', me, me.store_add)
            .muBind('remove', me, me.store_remove)
        //            .muBind('datachanged', me, me.store_dataChanged)
        //            .muBind('refresh', me, me.store_refresh)
            .muBind('load', me, me.store_load)
        //            .muBind('bulkremove', me, me.store_bulkremove)
            .muBind('clear', me, me.store_clear);
        //            .muBind('currentchanged', me, me.store_currentchanged);



    },

    store_remove: function (event, record) {

        var me = event.data,
            log = me.log,
            delFun = me['delete'];

        for (var i = 0; i < record.length; i++) {

            var id = record[i];

            var nodeId = me.id + '_NODE_' + id;
                        
            delFun.call(me, nodeId);

        }



    },

    store_update: function (event, record, operation, modifiedFieldNames) {

        var me = event.data,
            log = me.log;

        log.debug('TreeStore 触发 Update 事件');

    },


    store_clear: function (event) {
        var me = event.data,
            log = me.log;


        log.debug('TreeStore 触发 Clear 事件');

        me.clear();
    },

    /**
     * 处理行数据
     * @param records {Array} 记录集合
     */
    proLineData: function (records) {
        "use strict";
        var me = this,
            el = me.el,
            i,
            record,
            len = records.length,
            pField = me.parField,
            pValue,
            node,
            rootNode,
            newNodes = [],
            checkNodes = me.checkNodes;

        var list = records;

        var groups = me.toGroup(records);


        var pId = me.rootId + '';
        var list = groups[pId] || [];

        var srcEventSelected = me.event_selected;

        me.event_selected = false;


        if (me.showRoot && me.store) {
            var store = me.store;
            var rootRect = store.getById(pId);


            if (rootRect) {
                rootRect.expand = true;

                node = me.record_2_node.call(me, rootRect);
            }
            else {
                rootRect = {};
                rootRect[me.idField || me.valueField] = me.rootId;
                rootRect[me.textField] = me.rootText;
                rootRect.expand = true;


                node = me.record_2_node.call(me, rootRect);

            }

            node.li_attr.child_loaded = true;

            me.add(node);
            me.proGroupsToTree.call(me, groups, rootRect, node, newNodes);

            if ($(el).jstree('is_closed', node)) {
                $(el).jstree("toggle_node", node);
            }

            rootNode = node;
        }
        else {

            if (list && list.length) {
                for (i = 0; i < list.length; i++) {
                    record = list[i];

                    node = me.record_2_node.call(me, record);

                    //console.debug("node = ", node);

                    me.add(node);

                    me.proGroupsToTree.call(me, groups, record, node, newNodes);
                }
            }
        }


        if (me.checkbox && checkNodes) {

            i = checkNodes.length;

            while (i--) {
                checkNodes[i] = me.id + '_NODE_' + checkNodes[i];
            }

            me.checkNode(checkNodes);
            delete me.checkNodes;

            // 关闭第二层节点
            setTimeout(function () {

                var o = $(el).jstree('get_node', rootNode, true).children('.jstree-children');

                var openEls = $(o).children('.jstree-open');

                $(openEls).each(function () {
                    $(el).jstree('close_node', this, false);
                });

            }, 10);

        }

        me.event_selected = srcEventSelected;

        //特殊处理, 把叶节点设置为
        if (newNodes) {

            for (var i = 0; i < newNodes.length; i++) {

                var node = newNodes[i];

                //console.debug("node = ", node);

                if (node.has_child) {
                    var nodeEl = $('#' + node.id);
                    nodeEl.removeClass('jstree-leaf').addClass('jstree-closed');
                }
            }

        }

    },

    store_add: function (event, index, out) {
        "use strict";
        var me = event.data,
            i,
            record,
            records = out,
            len = records.length,
            pField = me.parField,
            pValue,
            node;

        var list = records;

        if (list && list.length) {
            for (i = 0; i < list.length; i++) {
                record = list[i];

                if (record.get) {
                    pValue = record.get(pField);
                } else {
                    pValue = record[pField];
                }

                node = me.record_2_node.call(me, record);


                if (pValue + '' == me.rootId + '') {
                    me.add(node.parent, node);
                }
                else {
                    me.add(node.parent, node);
                }


            }


        }

    },

    store_load: function (event, store) {
        "use strict";
        var me = event.data,
            log = me.log,
            el = me.el,
            tree = $(el).jstree('true'),
            i,
            record,
            newNodes = [],
            records = store.data;

        log.debug('TreeStore 触发 load 事件. ' + '共有 ' + records.length + '记录.');

        me.add_ForRecord(records, newNodes);


        if (me.focusNode) {

            $(el).jstree("toggle_node", me.focusNode.node);


            //特殊处理, 把叶节点设置为
            if (newNodes) {

                console.debug('特殊处理...', newNodes);

                for (var i = 0; i < newNodes.length; i++) {

                    var node = newNodes[i];


                    if (node.has_child) {

                        var nodeEl = $('#' + node.id);

                        nodeEl.removeClass('jstree-leaf').addClass('jstree-closed');
                    }
                }
            }

        }


    },

    /**
    *
    *
    * param {newNodeIds} 新节点 ID
    */
    proGroupsToTree: function (groups, parRecord, parNode, newNodes) {
        "use strict";
        var me = this,
            i,
            node,
            record,
            vField = me.idField || me.valueField,
            pValue,
            newId,
            list;


        var checkNodes = me.checkNodes;

        pValue = parRecord[vField] + '';

        list = groups[pValue];

        if (list && list.length) {

            for (i = 0; i < list.length; i++) {
                record = list[i];

                var id = record[vField].toString();


                node = me.record_2_node.call(me, record);

                newId = me.add(node.parent, node);

                if (newNodes) {
                    newNodes.push(node);

                    if (record.has_child) {
                        node.has_child = true;
                    }
                }

                me.proGroupsToTree(groups, record, node, newNodes);
            }
        }
    },


    //按父键值分组
    toGroup: function (records) {
        "use strict";
        var me = this,
            i,
            treeModel,
            record,
            len = records.length,
            pField = me.parField,
            pValue,
            group = {},
            list;

        console.debug("records", records);

        for (i = 0; i < len; i++) {

            if (records.isArray || records.get) {
                record = records.get(i);
            }
            else {
                record = records[i];
            }

            //console.debug("xxxxxxxxxxxxxxxxx", record);

            //console.debug("pField = ", pField);
            //console.debug("record = ", record);


            if ('tree-model' == record.role) {
                treeModel = record;
                record = record.data;
            }
            else {
                treeModel = record;
            }

            pValue = record[pField];

            //console.debug("pValue = ", pValue);

            if (undefined === pValue) {
                console.error('tree-model 的主键(' + pField + ')　,值不能为空.', record);
                continue;
            }

            pValue += '';

            list = group[pValue];

            if (undefined == list) {
                list = [];
                group[pValue] = list;
            }

            list.push(treeModel);

        }

        return group;
    },

    /**
     * 'record' 记录转换为 'node' 节点
     * @param record {Object} 记录数据
     * @param checked {bool} 选中状态.. 
     */
    record_2_node: function (record, checked) {
        "use strict";
        var me = this,
            vField = me.idField || me.valueField,
            tField = me.textField,
            pField = me.parField,
            typeField = me.typeField,
            v, t, p, type, icon, expand, tag,
            parId, id,
            node,
            treeModel,
            hasChild = true;

        if ('tree-model' == record.role) {
            hasChild = record.has_child;

            treeModel = record;
            record = treeModel;// record.data;
        }
        else {
            hasChild = record.has_child;

            if (!hasChild && undefined == record['child_loaded']) {
                hasChild = true;    //让其去执行脚本
            }


            treeModel = record;
        }

        if (record.isModel) {
            v = record.get(vField);
            t = record.get(tField);
            p = record.get(pField) || 'ROOT';

            expand = record.get('expand');

            type = record.get(typeField);
            icon = record.get(me.iconField);

            checked = checked || record.get('checked');

            tag = record.get('tag') || '';
        }
        else {
            v = record[vField];
            t = record[tField];
            p = record[pField] || 'ROOT';

            expand = record['expand'];

            type = record[typeField];
            icon = record[me.iconField];

            checked = checked || record['checked'];

            tag = record['tag'] || '';
        }

        checked = !!checked;


        parId = me.id + '_NODE_' + p;

        id = me.id + '_NODE_' + v;

        node = {
            id: id,
            text: t,

            //leaf: !hasChild,

            a_attr: {
                nodeId: v,
                parNodeId: p,
                tag: tag
            },
            parent: parId,
            li_attr: { 'child_loaded': !hasChild },
            state: {
                opened: false
            },


            data: record,

            raw: record //原数据
        };


        if (icon) {
            node.icon = icon;
        }

        if (expand) {
            node.state.opened = true;
        }

        if (me.checkbox && checked) {
            //node.state.selected = true;
        }


        return node;
    },


    //选中节点
    checkNode: function (node) {
        var me = this,
            el = me.el,
            tree = $(el).jstree('true');

        if (Mini2.isArray(node)) {
            tree.jstree('select_node', node, true, false);
        }
        else if (Mini2.isString(node)) {
            tree.jstree('select_node', node, true, false);
        }
        else {
            tree.check_node(node);
        }

    },


    //设置节点加载的状态
    setNodeLoaded: function (node, value) {
        var me = this,
            el = me.el,
            tree = $(el).jstree(true);


        var treeNode = tree.get_node(node);


        treeNode.li_attr.child_loaded = value;

        //        Mini2.alertProps(treeNode);

        var nodeEl = $('#' + node);

        nodeEl.attr('child_loaded', value);

        //Mini2.alertProps(node);
    },


    setTag: function (node, value) {
        var me = this,
            el = me.el,
            tree = $(el).jstree(true);


        var treeNode = tree.get_node(node);

        treeNode.a_attr.tag = value;

        console.log("属性: ", treeNode.a_attr);

    },


    /** End region **/

    getContainer: function () {
        var me = this,
            el = me.el;

        return el.children('.jstree-container-ul:first');
    },


    open_node: function (node) {
        var me = this,
            el = me.el;

        el.jstree('open_node', node);

        //$(el).jstree(true).open_node(node);

    },

    //清理所有节点
    clear: function () {
        var me = this,
            el = me.el;

        var cont = me.getContainer();

        var childs = $(cont).children('li');

        $(childs).each(function () {
            $(el).jstree(true).delete_node(this);
        });
    },

    cancelRename: false,

    setNodeText: function (node, text, cancel) {
        var me = this,
            el = me.el,
            tree = $(tree).jstree(true);

        //tree.rename_node(node, text);

        me.cancelRename = !!cancel;

        el.jstree('rename_node', node, text);

        me.cancelRename = !me.cancelRename;
    },


    add_ForRecord: function (record, newNodes) {
        "use strict";
        var me = this,
            log = me.log,
            el = me.el,
            tree = $(el).jstree(true),
            sel, pValue, node, i, records, rect;

        if (record) {

            log.debug('批量添加 Tree.Panel.add_ForRecord(...), 上级=' + me.parField);


            records = Mini2.isArray(record) ? record : [record];

            if (records.isArray) {
                records = records.items;
            }

            //log.debug('批量添加 records', records);

            for (i = 0; i < records.length; i++) {


                rect = records[i];



                pValue = rect[me.parField];
                node = me.record_2_node(rect);

                //log.debug('pValue=%s, text=%s', pValue, node.text);
                //log.debug('rect=', rect);
                //log.debug('node=', node);



                if (pValue + '' == me.rootId + '') {
                    me.add(null, node);
                }
                else {
                    me.add(node.parent, node);
                }

                if (newNodes) {

                    //log.debug('pValue=%s, text=%s', pValue, node.text);
                    //log.debug('rect=', rect);
                    //log.debug('node=', node);

                    node.has_child = rect.has_child;
                    newNodes.push(node);
                }
            }
        }
        else {
            log.debug('Tree.Panel.add_ForRecord(...) 没有记录需要添加');
        }

        //sel = tree.create_node(node.parent, node);
    },

    ///添加节点
    add: function (parId, node, callback) {
        var me = this,
            el = me.el,
            nodeRenderer = me.nodeRenderer,
            tree = $(el).jstree(true),
            sel;

        if (arguments.length == 1) {
            node = arguments[0];

            if (nodeRenderer) {
                nodeRenderer.call(me, {
                    node: node,
                    raw: node.raw || node.data
                }, node);
            }

            sel = tree.create_node(me.focusNode, node, undefined, callback);
        }
        else {

            if (nodeRenderer) {
                nodeRenderer.call(me, {
                    node: node,
                    raw: node.raw || node.data
                }, node);
            }

            sel = tree.create_node(parId, node, undefined, callback);
        }

        return sel;
    },


    removeChilds: function (node) {
        var me = this,
            el = me.el,
            tree = $(el).jstree(true);


        var curNode = tree.get_node(node);

        var ids = Mini2.clone(curNode.children);

        for (var i = 0; i < ids.length; i++) {

            var cId = ids[i];
            console.debug("删除: ", cId);

            tree.delete_node(cId);
        }

    },


    'delete': function (node) {
        var me = this,
            el = me.el,
            tree = $(el).jstree(true);;

        tree.delete_node(node);
    },


    edit: function (node) {
        var me = this,
            el = me.el,
            tree = $(el).jstree(true),
            sel;


        tree.edit(node);
    },



    //设置复选框选中的节点
    setCheckedNode: function (ids) {
        var me = this,
            el = me.el,
            t = [],
            str;

        if (ids) {

            if (Mini2.isArray(ids)) {
                str = ids;
            }
            else if (Mini2.isString(ids)) {
                str = ids.split(',');
            }


            $(str).each(function (i, item) {
                t.push(me.id + '_NODE_' + item);
            })


            el.jstree('check_node', t.join(','));


        }



    },

    //获取树状态的信息
    getJson: function () {
        var me = this,
            el = me.el,
            obj = {},
            node;

        if (me.focusNode && me.focusNode.node) {
            node = me.focusNode.node;

            var attr = node.a_attr;
            var liAttr = node.li_attr;

            obj.select = {
                value: attr.nodeId,
                par_id: attr.parNodeId,
                text: node.text,
                child_loaded: liAttr.child_loaded,
                children: node.children,
                tag: attr.tag
            };


        }





        if (me.renameParam) {

            var rp = me.renameParam;

            //Mini2.alertProps(rp.node.a_attr);

            var childLoaded = false;

            if (rp.li_attr) {
                childLoaded = !!(rp.li_attr.child_loaded);
            }

            obj.rename = {
                text: rp.text,
                old: rp.old,
                value: rp.node.a_attr.nodeId,
                par_id: rp.node.a_attr.parNodeId,
                child_loaded: childLoaded,
                children: node.children,
                tag: rp.node.a_attr.tag
            }

        }

        if (me.moveNodeJson) {
            obj.move = me.moveNodeJson;
        }

        if (me.checkbox) {

            var checkedIds = me.getCheckedIds();

            var undeIds = me.getUndeterminedIds();

            obj.checked_ids = checkedIds;
            obj.unde_ids = undeIds;

        }


        var json = Mini2.Json.toJson(obj);

        return json;
    },


    /**
    * 取得所有选中的节点，返回节点对象的集合  
    */
    getCheckedIds: function () {

        var me = this,
            el = me.el,
            tree = $(el).jstree('true'),
            nodeList,
            i,
            ids = '',
            nodeId, id,
            qzLen = (me.id + '_NODE_').length;

        nodeList = tree.jstree('get_selected');

        for (i = 0; i < nodeList.length; i++) {
            nodeId = nodeList[i];
            id = nodeId.substring(qzLen);

            if (i > 0) { ids += ","; }
            ids += id;
        }

        return ids;
    },

    /**
    * 取得所有选中的节点，返回节点对象的集合  
    */
    getUndeterminedIds: function () {

        var me = this,
            el = me.el,
            tree = $(el).jstree('true'),
            nodeList,
            i,
            ids = '',
            nodeId, id,
            qzLen = (me.id + '_NODE_').length;

        //nodeList = tree.jstree('get_selected',true);

        //alert(nodeList.length);

        //for (i = 0; i < nodeList.length; i++) {
        //    nodeId = nodeList[i];
        //    id = nodeId.substring(qzLen);

        //    if (i > 0) { ids += ","; }
        //    ids += id;
        //}


        return '';

        ////取得所有选中的节点，返回节点对象的集合  
        //var checkeds = $('#' + me.clientId).find(".jstree-undetermined");

        ////得到节点的id，拼接成字符串   
        //var ids = "";

        //for (var i = 0; i < checkeds.length; i++) {
        //    ids += $(checkeds[i]).parent().attr("nodeid") + ',';
        //}

        //return ids;
    },


    /**
    * 获取菜单配置
    */
    getMenu: function () {
        var me = this,
            nodeTypeText = me.nodeTypeText,
            items,
            menuList = [];

        if (!me.showMenu) {
            return null;
        }

        items = {
            ccp: false,

        }

        if (me.showMenuNew) {
            menuList.push({
                id: Mini2.newId(),
                label: "创建" + nodeTypeText,
                action: function (obj) {

                    //this.create(obj);                
                    var widget = window.widget1;

                    if (me.triggerEvent_create && widget) {
                        widget.subMethod($('form:first'), { subName: me.id, subMethod: 'OnCreating' });
                    }

                    var store = me.store;

                    if (store) {

                        //var newNodeData = me.getFocusNodeConfig();  //获取焦点节点的配置信息

                        var sd = {
                            subName: store.id,
                            subMethod: 'Insert',
                        };

                        try {
                            widget1.subMethod('form:first', sd);
                        }
                        catch (ex) {
                            console.error('调用服务器 PreCommand 错误', ex);
                        }
                    }

                },
                "_disabled": function (obj) {
                    //alert("obj=" + obj); return "default" != obj.attr('rel'); 
                }
            });
        }

        if (me.showMenuRename) {
            menuList.push({
                id: Mini2.newId(),
                label: "重命名",
                action: function (obj) {

                    //this.create(obj); 

                    //var widget = window.widget1;

                    //if (me.triggerEvent_rename && widget) {
                    //    widget.subMethod($('form:first'), { subName: me.id, subMethod: 'OnEditing' });
                    //}


                    //Mini2.alertProps(me.focusNode.node);



                    me.edit(me.focusNode.node);

                },
                "_disabled": function (obj) {
                    //alert("obj=" + obj); return "default" != obj.attr('rel'); 
                }
            });
        }


        if (me.showMenuDelete) {
            menuList.push({
                id: Mini2.newId(),
                label: "删除",
                action: function (obj) {

                    //this.create(obj); 

                    var widget = window.widget1;

                    if (widget) {

                        var focusNode = me.focusNode.node;

                        Mini2.Msg.confirm('询问', '确定删除 "' + focusNode.text + '" ?', function () {

                            if (me.triggerEvent_remove) {
                                widget.subMethod($('form:first'), { subName: me.id, subMethod: 'OnRemoveing' });
                            }

                            var store = me.store;

                            if (store) {

                                try {
                                    widget1.subMethod('form:first', {
                                        subName: store.id,
                                        subMethod: 'Delete',
                                    });
                                }
                                catch (ex) {
                                    console.error('调用服务器 PreCommand 错误', ex);
                                }
                            }


                        });
                    }



                },
                "_disabled": function (obj) {
                    //alert("obj=" + obj); return "default" != obj.attr('rel'); 
                }
            });

        }

        var contextMenu = me.contextMenu;

        for (var i = 0; i < contextMenu.length; i++) {

            var menuItem = contextMenu[i];


            var menu = {
                id: Mini2.newId(),
                label: menuItem.text,
                command: menuItem.command,
                command_params: menuItem.command_params,

                click: menuItem.click,

                action: function (obj) {
                    me.menu_action.call(me, obj, obj.item);

                }
            };

            menuList.push(menu);
        }

        for (var i = 0; i < menuList.length; i++) {

            var mItem = menuList[i];

            items[mItem.id] = mItem;

        }


        return items;
    },

    /**
    * 获取焦点节点的配置信息
    */
    getFocusNodeConfig: function () {
        var me = this,
            focusNode = me.focusNode,
            cfg = null;


        if (focusNode && focusNode.node) {
            node = focusNode.node;

            var attr = node.a_attr;
            var liAttr = node.li_attr;

            cfg = {
                value: attr.nodeId,
                par_id: attr.parNodeId,
                text: node.text,
                child_loaded: liAttr.child_loaded,
                children: node.children,
                tag: attr.tag
            };
        }

        return cfg;
    },

    //菜单项动作
    menu_action: function (obj, item) {

        var me = this;
        //this.create(obj); 

        var widget = window.widget1;

        if (item.click) {

            var isContinue = item.click.call(me, obj, item);

            if (false === isContinue) {
                return;
            }

        }


        if (widget && !Mini2.isBlank(item.command)) {

            var newNodeData = me.getFocusNodeConfig();  //获取焦点节点的配置信息

            var newNodeId = 'node-' + Mini2.newId();


            var sd = {
                subName: me.id,
                subMethod: 'PreCommand',
                actionPs: {
                    cmdName: item.command,
                    cmdParam: item.commandParam || '',
                    node: 'ref ' + newNodeId,
                    record: 'ref xxxx'
                }
            };

            sd.data = {};
            sd.data[newNodeId] = window.JSON.stringify(newNodeData);

            console.debug('sd = ', sd);

            try {
                widget1.subMethod('form:first', sd);
            }
            catch (ex) {
                console.error('调用服务器 PreCommand 错误', ex);
            }

        }

    },

    /**
    * 创建配置信息
    */
    createConfig: function () {
        var me = this,
            plugins = ['html_data', 'themes', 'ui', 'crrm', 'contextmenu'],
            menus,
            cfg;

        menus = me.getMenu();


        cfg = {

            core: {
                check_callback: true,
                strings: true,
                //'data': function (obj, callback) {

                //    //console.debug("+++++++++++++", obj);

                //    if (me.store) {

                //        console.info('开始初始化数据仓库 TreePanel.initStore().');

                //        me.proLineData(me.store.data);

                //    }


                //}
            },
            plugins: plugins,

            lang: {
                loading: "加载中..."
            },
            contextmenu: {
                items: menus
            }
        };

        if (me.allowDragDrop) {
            plugins.push('dnd');
        }

        if (me.checkbox) {
            cfg.checkbox = {
                keep_selected_style: false
            };

            plugins.push('checkbox');
        }

        //plugins.push('wholerow');   //焦点行...整行

        if (me.types) {
            cfg.types = me.types;
            plugins.push('types');

            delete me.types;
        }

        return cfg;
    },

    /**
     * 焦点节点
     */
    focusNode: null,

    baseRender: function () {
        var me = this,
            el,
            cfg = me.createConfig();


        me.bind('nodeRename', function (e) {

            if (e.text == e.old) {
                return;
            }

            me.renameParam = e;

            var widget = window.widget1;

            if (me.triggerEvent_rename && widget) {
                widget.subMethod($('form:first'), { subName: me.id, subMethod: 'OnRenaming' });
            }


            var store = me.store;

            if (store) {


                try {
                    widget1.subMethod('form:first', {
                        subName: store.id,
                        subMethod: 'Rename',
                        actionPs: {
                            oldText: e.old,
                            text: e.text
                        }
                    });
                }
                catch (ex) {
                    console.error('调用服务器 PreCommand 错误', ex);
                }
            }

        });


        if (me.data) {

            if (Mini2.isArray(me.data)) {

            }
            else {
                cfg.core.data = me.data;
                delete me.data;
            }

        }



        if (me.applyTo) {
            el = $(me.applyTo).jstree(cfg);
        }
        else {
            el = $(me.renderTo).jstree(cfg);
        }

        me.el = el;

        el.css('background-color', '#FFFFFF');

        me.setSize(me.width, me.height);


        //复选框做了特殊处理.
        if (me.checkbox) {
            el.bind('changed.jstree', function (event, data) {

                if ('select-hwq' == data.action) {

                    if (me.autoExpand && $(el).jstree('is_closed', data.node)) {
                        $(el).jstree("toggle_node", data.node);
                    }

                    me.trigger_selected(event, data);
                }
            });
        }
        else {
            el.bind('select_node.jstree', function (event, data) {

                if (me.autoExpand && $(el).jstree('is_closed', data.node)) {
                    $(el).jstree("toggle_node", data.node);
                }


                me.trigger_selected(event, data);

            });
        }


        el.bind('open_node.jstree', function (event, data) {

            me.trigger('nodeOpened', data);
        });

        el.bind("loaded.jstree", function (e, data) { data.inst.open_all(-1); });

        el.bind('rename_node.jstree', function (event, data) {

            if (!me.cancelRename) {
                me.trigger('nodeRename', data);
            }
        });



        if (me.allowDragDrop) {
            me.bind_DragDrop();
        }

        if (me.data && Mini2.isArray(me.data)) {
            me.proLineData(me.data);
        }

        me.initStore();

        return el;
    },


    //绑定拖放
    bind_DragDrop: function () {
        var me = this,
            el = me.el;

        el.bind('move_node.jstree', function (event, data) {

            //data.node.id = 当前节点 ID
            //alert(data.node.id);
            //alert(data.parent);
            //alert(data.position);


            try {

                var pId = data.parent.substring(me.id.length + "_NODE_".length);

                //console.log(me.clientId);


                me.moveNodeJson = {
                    node_id: data.node.a_attr.nodeId,
                    parent_id: pId,
                    pos: data.position
                };

                me.onNodeMoved();

            }
            catch (ex) {
                alert("ui.tree.Panel.bind_DragDrop() 提交数据错误");
            }

        });

    },


    onNodeMoved: function () {
        var me = this;

        if (me.event_move) {
            var widget = window.widget1;

            if (widget) {
                widget.subMethod($('form:first'), { subName: me.id, subMethod: 'OnNodeMoved' });
            }
        }
    },

    trigger_selected: function (event, data) {
        var me = this,
            log = me.log,
            store = me.store;

        if (me.focusNode) {
            $(me.focusNode.node).removeClass('jstree-focus-item');
        }

        $(data.node).addClass('jstree-focus-item');


        me.focusNode = data;    // ref.get_selected();


        if (store && store.dymHasChild) {

            var node = data.node;
            var attr = node.a_attr;

            console.debug('节点 data', node.data);

            store.setCurrent(node.data);

            log.debug('问:需要加载远程节点?', node);

            if (!node.li_attr.child_loaded) {

                log.debug('开始加载远程节点. ');

                if (me.remoteEnabled) {

                    var store = me.store,
                        data = node.data,
                        parentId;

                    if (data.get) {
                        parentId = data.get(me.idField);
                    }
                    else {
                        parentId = data[me.idField];
                    }

                    console.debug('开始加载远程数据...', me.remoteUrl);
                    console.debug('上级节点...', node);


                    var remotePs = {
                        parent_id: parentId
                    };

                    Mini2.post(me.remoteUrl, remotePs, function (data) {

                        console.debug('数据回来了...', data);

                        store.add(data);

                        node.li_attr.child_loaded = true;
                    });


                }
                else {
                    var widget = window.widget1;

                    if (widget) {

                        widget.subMethod($('form:first'), {
                            subName: store.id,
                            subMethod: 'LoadChilds'
                        });

                        node.li_attr.child_loaded = true;
                    }
                }

            }
            else {
                log.debug('无需加载远程节点. node.li_attr.child_loaded=', node.li_attr.child_loaded)
            }
        }

        //Mini2.alertProps(data.node);



        if (me.event_selected) {
            var widget = window.widget1;

            if (widget) {

                widget.subMethod($('form:first'), {
                    subName: me.id,
                    subMethod: 'OnSelected'
                });
            }
        }

        me.trigger('nodeSelected', data);
    },

    render: function () {
        var me = this,
            el;

        el = me.baseRender();

        $(el).data('me', me);
    }

});


/************************************************************************/
/*                                           */
/*    ui/tab/Tab.js                                                        */
/*                                           */
/************************************************************************/


/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini.js" />
/// <reference path="../../../../jstree/3.0.2/jstree.js" />


Mini2.define('Mini2.ui.tab.Tab', {

    extend: 'Mini2.ui.Component',

    tabPanel: null,

    padding: '10px 10px 10px 10px',

    /**
    * 显示关闭按钮
    */
    closable: false,

    //x-tab x-unselectable x-box-item x-tab-default x-noicon x-tab-noicon x-tab-default-noicon x-top x-tab-top x-tab-default-top
    //            'mi-tab-after-title" ',
    reandeTpl: [
        '<a class="mi-tab ',
            'mi-unselectable ',
            'mi-box-item ',
            'mi-tab-default ',
            //'mi-noicon ',
            //'mi-tab-noicon ',
            //'mi-tab-default-noicon ',
            'mi-top ',
            'mi-tab-top ',
            'mi-tab-default-top" ',
            'style="" ',
            'role="button" hidefocus="on" unselectable="on" tabindex="0" >',

            '<span class="mi-tab-wrap" unselectable="on">',
                '<span class="mi-tab-button">',
                    '<span class="mi-tab-inner mi-tab-inner-center" unselectable="on">',
                    'Tab',
                    '</span>',
                    //'<span role="img" class="mi-tab-icon-el" unselectable="on" ></span>',
                '</span>',
            '</span>',
        '</a>'
    ],

    /**
    * 图标样式
    */
    iconCls: null,

    

    //关闭按钮的图标
    closeBtnTpl: ['<span class="mi-tab-close-btn" title="" tabindex="0"></span>'],

    closeOverCls: 'mi-tab-close-btn-over',

    getText: function () {
        var me = this,
            btnInnerEl = me.btnInnerEl;

        var html = $(btnInnerEl).html();

        return html;
    },

    setText: function (value) {
        var me = this,
            btnInnerEl = me.btnInnerEl;

        $(btnInnerEl).html(value);
    },


    /**
    * 隐藏组件
    */
    hide: function () {
        var me = this,
            el = me.el;

        if (me.visible != false) {
            me.visible = false;

            el.hide();

            me.callParent();
        }

        return me;
    },

    /**
    * 显示组件
    */
    show: function () {
        var me = this,
            el = me.el;

        if (me.visible != true) {
            me.visible = true;

            el.show();

            me.callParent();
        }

        return me;
    },


    /**
     * 设置版面的 url
     */
    setUrl: function (url) {
        var me = this,
            contentEl = me.contentEl;

        if (!me.iframe) {
            console.error('当前 tab 不是 iframe 对象.');

            return me;
        }

        me.url = url;

        $(contentEl).attr('url', url);

        return me;
    },

    /**
     * 获取 iframe 框架的 win 对象
     */
    getIFrameWindow: function () {
        var me = this,
            iframeWin = null,
            contentEl = me.contentEl,
            con0;

        if (!me.iframe) {
            console.warn('当前 tab 不是 iframe 对象.', me);

            return me;
        }

        if (!contentEl || 0 == contentEl.length) {

            console.warn('当前 tab 不是 contentEl 对象.', contentEl);

            return me;
        }

        con0 = contentEl[0];

        if (con0) {
            iframeWin = con0.contentWindow;// || con0.contentDocument.parentWindow;
        }

        return iframeWin;
    },

    setActive: function () {
        "use strict";
        var me = this,
            ui = me.ui,
            baseCls = 'mi-tab-' + ui,
            el = me.el;


        var activeCls = [
            'mi-active',
            'mi-tab-active',
            baseCls + '-active',
            'mi-top-active',
            'mi-tab-top-active',
            baseCls + '-top-active'];

        var tabPanel = me.tabPanel;
        var lastTab = tabPanel.curActiveTab;

        if (tabPanel.curActiveTab === me) {
            return;
        }

        tabPanel.lastActveTab = tabPanel.curActiveTab;
        tabPanel.curActiveTab = me;
        Mini2.ui.FocusMgr.setControl(me.scope || me);


        $(el).addCls(activeCls);

        me.contentEl && $(me.contentEl).removeClass('mi-hide-display');


        me.panel.show();
        me.panel.updateLayout();

        /*** 临时解决,以后作废 **************/
        setTimeout(function () {
            me.panel.updateLayout();
        }, 50);
        /***********************************/

        me.resetPaint();

        if (lastTab) {
            $(lastTab.el).removeCls(activeCls);

            if (lastTab.panel) {
                lastTab.panel.hide();
            }
        }

        me.trigger('action', { tab: me });

        return me;

    },


    /**
    * 重置层次
    */
    resetPaint: function () {
        var me = this;

        me.panel.resetPaint();

        return me;
    },


    //关闭
    close: function () {
        "use strict";
        var me = this;

        me.tabPanel.remove(me)

        return me;
    },

    //创建关闭按钮
    createCloseBtn: function () {
        "use strict";
        var me = this,
            el = me.el,
            ui = me.ui,
            closeEl,
            closable = me.closable;

        if (closable) {
            closeEl = Mini2.$joinStr(me.closeBtnTpl);

            el.append(closeEl);

            el.addCls('mi-closable',
                'mi-tab-closable',
                'mi-tab-' + ui + '-closable',
                'mi-closable-top',
                'mi-tab-closable-top',
                'mi-tab-' + ui + '-closable-top');

            me.closeEl = closeEl;


            closeEl.mouseenter(function () {
                $(this).addClass(me.closeOverCls);
            }).mouseleave(function () {
                $(this).removeClass(me.closeOverCls);
            });


            closeEl.muBind('mousedown', function () {

            }).muBind('mouseup', function () {
                
                me.close();

            });

        }
    },

    //isDelayRender:false,

    //延迟显示
    delayRender: function () {
        "use strict";
        var me = this,
            el = $(me.applyTo);

        me.isDelayRender = true;

        el.attr('mi-delay-render', 'true');
        el.data('me', me);

        return me;
    },

    render: function () {
        "use strict";
        var me = this,
            ui = me.ui,
            baseCls = 'mi-tab-' + ui,
            el,btnEl;

        if (me.isDelayRender) {
            //me.isDelayRender = false;
        }

        me.el = el = Mini2.$join(me.reandeTpl);

        el.addCls([baseCls, baseCls + '-top']);

        me.btnEl = btnEl = el.find('.mi-tab-button');

        me.btnInnerEl = btnEl.children('.mi-tab-inner');

        if (me.iconCls || me.icon) {
            el.addClass('mi-icon-text-left mi-btn-icon-text-left mi-tab-default-icon-text-left mi-btn-default-small-icon-text-left');
        }

        if (me.iconCls) {
            var iconEl = Mini2.$join(['<i class="mi-tab-icon-el fa ', me.iconCls, '"></i>']);
            btnEl.append(iconEl);
        }
        else if (me.icon) {
            var iconEl = $('<span role="img" class="mi-tab-icon-el" unselectable="on" ></span>');
            btnEl.append(iconEl);
        }



        me.setText(me.text || '按钮');

        me.createCloseBtn();

        el.css('left', me.left || 0);

        el.mouseenter(function () {

            $(this).addClass('mi-tab-' + me.ui + '-over');


        }).mouseleave(function () {

            $(this).removeClass('mi-tab-' + me.ui + '-over');
        });


        el.muBind('mousedown', function () {
            //Mini2.ui.FocusMgr.setControl(me.scope || me);

        }).muBind('mouseup', function () {
            //me.setActive();
            me.tabPanel.setActiveTab(me);
        });

        if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else if (me.renderTo) {
            $(me.renderTo).append(el);
        }

        $(el).data('me', me);


    }

});



/************************************************************************/
/*                                           */
/*    ui/tab/Panel.js                                                      */
/*                                           */
/************************************************************************/


/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini.js" />
/// <reference path="../../../../jstree/3.0.2/jstree.js" />



//Tab 版面
Mini2.define('Mini2.ui.tab.Panel', {

    extend: 'Mini2.ui.Component',

    log: Mini2.Logger.getLogger('Mini2.ui.tab.Panel',true),  //日志管理器

    tabCls: Mini2.baseCSSPrefix + 'tab-panel',

    
    //当前激活的 Tab 
    curActiveTab: null,

    //
    plain: false,

    tabHeight: 32,


    //left | right | buttom | top
    dock: 'top',

    region: 'north',

    //显示按钮
    buttonVisible: true,

    //状态: normal-普通,min-最小化, max-最大化
    state: 'normal',

    //tab 标签默认起始位置
    tabLeft:0,

    renderTpl_body: [
        '<div class="mi-panel-body ',
            'mi-panel-body-default ',
            'mi-layout-fit ',
            'mi-noborder-trbl" ',
            'style="width: 450px; left: 0px; top: 36px; height: 160px;" >',

        '</div>'
    ],


    renderTpl_bar: [
        '<div role="Tab-bar" class="mi-tab-bar ',
            'mi-header ',
            'mi-header-horizontal ',
            'mi-docked ',
            'mi-unselectable ',
            //'mi-tab-bar-default ',
            'mi-horizontal ',
            'mi-tab-bar-horizontal ',
            //'mi-tab-bar-default-horizontal ',
            'mi-top ',
            'mi-tab-bar-top ',
            //'mi-tab-bar-default-top ',
            'mi-horizontal-noborder ',
            'mi-tab-bar-horizontal-noborder ',
            //'mi-tab-bar-default-horizontal-noborder ',
            'mi-docked-top ',
            'mi-tab-bar-docked-top ',
            //'mi-tab-bar-default-docked-top ',
            'mi-noborder-trl" >',

            '<div class="mi-tab-bar-body ',
                //'mi-tab-bar-body-default ',
                'mi-tab-bar-body-horizontal ',
                //'mi-tab-bar-body-default-horizontal ',
                'mi-tab-bar-body-top ',
                //'mi-tab-bar-body-default-top ',
                'mi-tab-bar-body-horizontal-noborder ',
                //'mi-tab-bar-body-default-horizontal-noborder ',
                //'mi-tab-bar-body-docked-top ',
                //'mi-tab-bar-body-default-docked-top ',
                'mi-box-layout-ct ',
                //'mi-tab-bar-body-default ',
                //'mi-tab-bar-body-default-horizontal ',
                //'mi-tab-bar-body-default-top ',
                //'mi-tab-bar-body-default-horizontal-noborder ',
                //'mi-tab-bar-body-default-docked-top" ',
                '" style="width: 450px;position: static;" >',

    //左移按钮，默认隐藏
                '<div class="mi-box-inner mi-box-scroller-left ">',
                    '<div class="mi-box-scroller mi-tabbar-scroll-left" style="display:none;"></div>',
                '</div>',

                '<div class="mi-box-inner mi-horizontal-box-overflow-body" role="presentation" style="width:450px;height:31px;" >',
                    '<div class="mi-box-target" style="width: 450px;">',

                    '</div>',
                '</div>',

    //右移按钮，默认隐藏
                '<div class="mi-tab-bar-buttons mi-box-scroller-right " style="text-align:right;top:0;right:10px;position: absolute;">',
                    '<a class="mi-tab-bar-close mi-box-inner mi-box-scroller-right" style="top:9px;margin-right:10px;" href="#">隐藏</a>',
                    '<a class="mi-tab-bar-max mi-box-inner mi-box-scroller-right" style="top:9px;margin-right:10px;" href="#">放大</a>',
                '</div>',
                '<div class="mi-box-inner mi-box-scroller-right ">',
                    '<div class="mi-box-scroller mi-tabbar-scroll-right" style="display:none;"></div>',
                '</div>',
            '</div>',

        '</div>'
    ],

    renderTpl_bar_strip:[
        '<div class="mi-tab-bar-strip ">',
        '</div>',
    ],


    initComponent: function () {
        var me = this;



    },


    //激活标签
    //tab 可以是数值,也可以是对象
    setActiveTab: function (tab) {
        "use strict";
        var me = this,
            log = me.log,
            items = me.items;

        if (Mini2.isNumber(tab)) {

            if (tab < items.length) {
                tab = items[tab];
            }
        }

        if (tab) {

            if (tab.isDelayRender) {

                var panel = tab.panel;

                panel.render();



                var html = tab.contentEl;   //.html();
               
                var htmlItems = $(html);
                
                $(panel.boxTarget).append(html);


                $(htmlItems).each(function () {

                    var itemId = $(this).attr('id');

                    if (itemId && Mini2.delayRS) {

                        itemId = '#' + itemId;

                        var dd = Mini2.delayRS[itemId];

                        if (dd) {

                            dd.render();

                            delete Mini2.delayRS[itemId];

                            log.debug("加载:" + itemId);

                        }
                    }

                });

                

                panel.boxTarget.css({
                    display: 'table-cell',
                    height: '100%',
                    width: me.width || '100%',
                    'vertical-align': 'top'
                });

                //  'padding': '10px 10px 10px 10px'

                delete tab.isDelayRender;
                delete tab.contentEl;


                tab.bind('action', me, me.tab_action);
            }

            tab.setActive();
        }
    },

    /**
     * tab 标签事件
     */
    tab_action: function (e) {
        var me = this;


        me.trigger('tabAction', {

            tab: e.tab,

            lastTab: me.lastActveTab

        });

    },


    setSize: function (width, height) {
        "use strict";
        var me = this,
            log = me.log,
            el = me.el,
            barEl = me.barEl,
            boxTargetEl = me.boxTargetEl,
            bodyEl = me.bodyEl,
            i,
            items = me.items,
            item,
            itemPanel;

        //log.debugFormat('width={0}, height={1}', [width, height]);

        if (undefined != width) {

            me.width = width;

            $(el).children('.mi-panel:first').css('width', width);


            barEl.css('width', width);

            var barBody = $(barEl).children('.mi-tab-bar-body');
            var boxInner = barBody.children('.mi-box-inner');

            var boxTarget = boxInner.children('.mi-box-target');

            barBody.css('width', width);
            boxInner.css({
                width: width - 60
            });
            boxTarget.css({
                width: width
            });

            bodyEl.css('width', width);
        }


        if (undefined != height) {

            me.height = height;


            $(el).css('height', height);

            $(el).children('.mi-panel:first').css('height', height);

            //bodyEl.css('height', height - 32 );

            if ('pills' == me.ui) {
                bodyEl.css('height', height - me.tabHeight);
            }
            else {
                bodyEl.css('height', height - me.tabHeight - 6);
            }

        }


        me.refresh_tabPage();




    },

    //添加标签
    // tabsReload = 强制刷新版面 
    add: function (tab, tabsReload) {
        
        "use strict";
        var me = this,
            log = me.log,        
            boxTargetEl = me.boxTargetEl,
            bodyEl = me.bodyEl,
            contentEl,
            x = 0,
            cfg,
            btn;

        var index = me.items.length;

        console.debug("tab.parentPage=", tab.parentPage);

        cfg = Mini2.applyIf(tab, {
            ui: me.ui,
            left: x,
            tabPanel: me,
            ownerParent : me,
            tabIndex: index ,
            renderTo: boxTargetEl
        });

        btn = Mini2.create('Mini2.ui.tab.Tab', cfg);

        btn.render();
        

        if (btn.contentEl) {
            var cEl = $(btn.contentEl);
            btn.contentEl = cEl.html();
        }
        else if (btn.iframe) {


            btn.contentEl = contentEl = $('<iframe src="" frameborder="0" dock="full">框架窗体</iframe>');

            btn.contentEl.attr('src', btn.url);

            if (cfg.parentPage) {

                contentEl.bind('load', {
                    'owner': me,
                    'tab': btn,
                    'parentPager': contentEl[0].contentWindow
                }, me.iframe_load);

                me.iFrameReady.call(me, contentEl[0], function () {

                    //console.log("xxxxxxxxxx" + new Date().getTime());

                    var win = contentEl[0].contentWindow;

                    win.ownerWindow = btn;

                    if (win.Mini2) {
                        win.Mini2.parentPage = cfg.parentPage;

                    }
                    else {
                        win.parentPage = cfg.parentPage;
                    }
                });

            }
        }



        var w = me.width;   // $(bodyEl).outerWidth();
        var h = $(bodyEl).outerHeight();

        var panel = Mini2.create('Mini2.ui.panel.Panel', {
            dock: 'full',
            width: w,
            height: h,
            scroll: btn.scroll,
            layout: {
                itemCls: 'mi-box-item'
            },
            renderTo: bodyEl
        });


        btn.panel = panel;


        //newItems[i] = btn;

        Mini2.Array.add(me.items, btn);


        if (cfg.isDelayRender) {
            panel.delayRender();
        }
        else {
            panel.render();

            panel.hide();


            $(panel.boxTarget).append(btn.contentEl);

            panel.boxTarget.css({
                'display': 'table-cell',
                'height': '100%',
                'width': w,
                'vertical-align': 'top'
            });

            //  'padding': '10px 10px 10px 10px'

            // 注意: 不要删除啊, 其它地方需要使用...
            //delete btn.contentEl;

            btn.bind('action', me, me.tab_action);
        }

        if (undefined == tabsReload || false === tabsReload) {
            me.refresh_btn();
        }

        return btn;
    },


    iframe_load: function (e) {
        "use strict";
        var me = this,
            iframeId = $(me).attr('muid'),
            win = me.contentWindow,
            curMi,
            doc = win.document,
            body = doc.body;

        console.log("iframe 加载完成" + new Date().getTime(), win);

        if (!win.ownerWindow) {

            console.log("iframe 加载完成 2");

            win.ownerWindow = e.data['tab'];

            var parentPage = e.data['parentPage'];

            curMi = win.Mini2;

            if (curMi && curMi.onwerPage) {
                curMi.onwerPage.parentPage = e.data['parentPage'];
            }
            else {
                win.parentPage = parentPage;
            }
        }
    },


    // This function ONLY works for iFrames of the same origin as their parent
    iFrameReady: function (iFrame, fn) {
        var timer;
        var fired = false;

        function ready() {
            if (!fired) {
                fired = true;
                clearTimeout(timer);
                fn.call(this);
            }
        }

        function readyState() {
            if (this.readyState === "complete") {
                ready.call(this);
            }
        }

        // cross platform event handler for compatibility with older IE versions
        function addEvent(elem, event, fn) {
            if (elem.addEventListener) {
                return elem.addEventListener(event, fn);
            } else {
                return elem.attachEvent("on" + event, function () {
                    return fn.call(elem, window.event);
                });
            }
        }

        // use iFrame load as a backup - though the other events should occur first
        addEvent(iFrame, "load", function () {
            ready.call(iFrame.contentDocument || iFrame.contentWindow.document);
        });

        function checkLoaded() {

            var doc;

            if (iFrame.contentDocument) {
                doc = iFrame.contentDocument;
            }

            if (!doc && iFrame.contentWindow) {
                doc = iFrame.contentWindow.document;
            }



            // We can tell if there is a dummy document installed because the dummy document
            // will have an URL that starts with "about:".  The real document will not have that URL
            if (doc && doc.URL.indexOf("about:") !== 0) {
                if (doc.readyState === "complete") {
                    ready.call(doc);
                } else {
                    // set event listener for DOMContentLoaded on the new document
                    addEvent(doc, "DOMContentLoaded", ready);
                    addEvent(doc, "readystatechange", readyState);
                }
            } else {
                // still same old original document, so keep looking for content or new document
                timer = setTimeout(checkLoaded, 1);
            }
        }

        checkLoaded();
    },

    /**
     * 更新布局...改写
     *
     */
    updateLayout:function(){

        var me = this;

        /**
         * 只运行一次
         */
        Mini2.awaitRun(me.muid, 100, me, function () {
            
            me.refresh_btn();

            var nextTab = me.getNextActiveTab();
            
            if (nextTab) {
                nextTab.setActive();
            }

        });

    },


    /**
     * 获取下一个焦点的 tab 
     */
    getNextActiveTab:function(){
        "use strict";
        var me = this,
            i,
            item,
            items = me.items,
            newTab = null,
            lastTab = me.lastActveTab;

        if (lastTab && lastTab.visible) {
            
            return lastTab;
        }

        if (!lastTab) {

            for (i = 0; i < items.length; i++) {
                item = items[i];

                if (item.visible) {
                    newTab = item;
                    break;
                }
            }

        }
        else {

            var lastIndex = Mini2.Array.indexOf(items, lastTab);

            var n1 = lastIndex;

            //先往前查找
            while (--n1 >= 0) {
                item = items[n1];

                if (item.visible) {
                    newTab = item;
                    break;
                }
            }

            //找不到就再, 往后查找
            if (!newTab) {

                for (i = lastIndex + 1; i < items.length; i++) {
                    item = items[i];

                    if (item.visible) {
                        newTab = item;
                        break;
                    }
                }

            }


        }

        return newTab;
    },

    


    /**
     * 实例化按钮
     * 
     */
    render_btn: function (boxTargetEl, bodyEl) {
        "use strict";
        var me = this,
            i,
            items = me.items,
            cfg ,
            newItems;

        if (items) {

            delete me.items;
            me.items = [];

            newItems = [items.length];

            for (i = 0; i < items.length; i++) {
                cfg = items[i];
                me.add(cfg,false);
            }


            //me.items = newItems;
        }
    },

    /**
     * 查找标签
     */
    find: function(tabId){
        "use strict";
        var me = this,
            i,
            findTab = null,
            item,
            items = me.items || [];

        for (i = 0; i < items.length; i++) {

            item = items[i];

            if (item.id == tabId) {
                findTab = item;
                break;
            }

        }

        return findTab;

    },


    isVisible: function () {
        var me = this,
            el = me.el;

        return el.is(':visible');
    },

    
    //删除 Tab 标签
    remove: function (tab) {
        "use strict";
        var me = this,
            curTab = me.curActiveTab,
            actTab,
            index,
            log = me.log;


        $(tab.el).fadeOut(300, function () {                      

            tab.el.remove();

            tab.panel.el.remove();

            me.refresh_btn();

            index = Mini2.Array.remove(me.items, tab);

            if (tab === curTab) {
                if (index > 0) {
                    actTab = me.items[index - 1];
                    me.setActiveTab(actTab);
                }
                else if (index == 0) {
                    actTab = me.items[index];
                    me.setActiveTab(actTab);
                }
            }

        });

        return me;
    },

    //刷新按钮坐标
    refresh_btn: function () {
        "use strict";
        var me = this,
            log = me.log,
            x = me.tabLeft;


        $(me.items).each(function () {

            var tab = this;
                        
            if (tab.visible && tab.setLeft) {
                tab.setLeft(x);

                x += tab.getWidth() + 1;
            }
            else {
            }
            
        });

        //下面代码作为补救用
        setTimeout(function () {

            x = me.tabLeft;

            $(me.items).each(function () {

                var tab = this;

                if (tab.visible && tab.setLeft) {
                    tab.setLeft(x);

                    x += tab.getWidth() + 1;
                }
                else {
                }

            });
        },1000);

    },

    //刷新 Tab 板块
    refresh_tabPage: function () {
        "use strict";
        var me = this,
            bodyEl = me.bodyEl,
            w, h,
            i,
            item,
            items = me.items,
            len = items.length,
            itemPanel;


        w = bodyEl.outerWidth();
        h = bodyEl.outerHeight();

        for (i = 0; i < len; i++) {
            item = items[i];
            itemPanel = item.panel;

            if (itemPanel && itemPanel.visible) {
                itemPanel.setSize(w, h);
            }
        }

    },


    baseRender: function (tabHeight) {
        "use strict";
        var me = this,
            log = me.log,
            ui = me.ui,
            barStripCls = 'mi-tab-bar-strip-' + ui,
            el,
            sysInfo = Mini2.SystemInfo,
            cfg = sysInfo.tabPanel;

        if (tabHeight) {
            me.tabHeight = tabHeight;
        }
        else {
            if (me.tabHeight != cfg.tabHeight) {
                me.tabHeight = cfg.tabHeight;
            }
        }

        


        me.el = el = $('<div role="TabPanel"></div>');

        var panelEl = Mini2.$join([
            '<div role="Tab-Body" class="mi-panel mi-border-box mi-panel-', me.ui ,' mi-tab-bar-' , me.ui ,'" style="width: 450px; height: 196px;" >',

            '</div>'
        ]);

        panelEl.css('width', me.width);

        var barEl = Mini2.$join(me.renderTpl_bar);
        var barStripEl = Mini2.$join(me.renderTpl_bar_strip);

        var boxTargetEl = barEl.find('.mi-box-target:first');


        var barBodyEl = barEl.children('.mi-tab-bar-body');
        var boxInner = barBodyEl.children('.mi-horizontal-box-overflow-body');



        boxInner.css({
            height: me.tabHeight
        });


        barStripEl.addCls([
            'mi-tab-bar-strip-top', 
            barStripCls,
            barStripCls + '-horizontal',
            barStripCls + '-top',
            barStripCls + '-horizontal-noborder',
            barStripCls + '-docked-top'
        ]);

        barStripEl.css({
            top: me.tabHeight - 1
        });

        barEl.append(barStripEl);

        barEl.css('height', me.tabHeight);
        boxTargetEl.css('height', me.tabHeight);

        var bodyEl = Mini2.$join(me.renderTpl_body);

        bodyEl.addClass("mi-renderTpl_body")

        if ('pills' == me.ui) {

            bodyEl.css('top', me.tabHeight );

        }
        else {
            if ('touch' == sysInfo.mode) {
                bodyEl.css('top', me.tabHeight + 8);
            }
            else {

                bodyEl.css('top', me.tabHeight - 6);
            }
        }

        var barButtons = barEl.find('.mi-tab-bar-buttons');

        ///拿到要显示和隐藏子表格的按钮
        var closeEl = barButtons.children('.mi-tab-bar-close');

        var maxEl = barButtons.children('.mi-tab-bar-max');

        if (me.buttonVisible) {
            barButtons.show();
        }
        else {
            barButtons.hide();
        }

        maxEl.click(function () {


            var height = $(window).height() - 40;

            var parentEl = $(this).parent();

            if (me.state == 'max') {
                $(this).text('放大');
                

                Mini2.ui.Page.resetMaxControl(me);

                parentEl.children('.mi-tab-bar-close').show();
                me.state = 'normal';
            }
            else {
                $(this).text('还原');

                Mini2.ui.Page.maxControl(me);

                parentEl.children('.mi-tab-bar-close').hide();
                me.state = 'max';
            }
            
            bodyEl.show();

            Mini2.LoaderManager.preResize();

            return false;

        })

        closeEl.click(function () {

            var height = el.css("height");

            var parentEl = $(this).parent();


            if (me.state == 'min') {
                $(this).text('隐藏');

                el.removeCls('mi-state-max', 'mi-state-min');

                el.css('height', me.height);
                panelEl.css('height', me.height);


                parentEl.children('.mi-tab-bar-max').show();
                me.state = 'normal';
            }
            else {
                $(this).text('还原');

                el.addClass('mi-state-min');

                el.css("height", 36);
                panelEl.css('height', 36);

                me.state = 'min';

                parentEl.children('.mi-tab-bar-max').hide();
            }


            bodyEl.toggle(me.state != 'min');

            Mini2.LoaderManager.preResize();

            return false;
        });



        

        barEl.css('width', me.width);
        boxTargetEl.css('width', me.width);
        bodyEl.css('width', me.width);

        me.barEl = barEl;
        me.boxTargetEl = boxTargetEl;
        me.bodyEl = bodyEl;


        if (me.plain) {
            barEl.addClass('mi-tab-bar-plain');

            var barBodyEl = barEl.children('.mi-tab-bar-body');

            barBodyEl.children('.mi-box-scroller-left').addClass('mi-box-scroller-plain');
            barBodyEl.children('.mi-box-scroller-right').addClass('mi-box-scroller-plain');
        }


        me.render_btn(boxTargetEl, bodyEl);


        panelEl.append(barEl);
        panelEl.append(bodyEl);


        el.append(panelEl);



        if (me.contentEl) {

            var contentEl = $(me.contentEl);
            var items = contentEl.children();

            contentEl.after(el);


            el.attr('id', contentEl.attr('id'));

            contentEl.remove();
        }
        else if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else if (me.renderTo) {
            $(me.renderTo).append(el);
        }

        if (me.visible == false) {
            el.hide();
            delete me.visible;
        }

        el.css('height', me.height);


        bodyEl.css('height', me.height - 31 - 2);

        $(el).children('.mi-panel').css('height', me.height);

        el.data('me', me);

        me.refresh_tabPage();
        me.refresh_btn();

        setTimeout(function () {
            me.setActiveTab.call(me, 0);

        }, 200);

    },

    render: function () {
        var me = this;

        //特殊配置
        if ('pills' == me.ui) {

            me.baseRender(40);            
        }
        else {
            me.baseRender();           
        }



    }


});


/************************************************************************/
/*                                           */
/*    ui/layout/container/Border.js                                        */
/*                                           */
/************************************************************************/



/// <reference path="../Mini.js" />
/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />



Mini2.define("Mini2.ui.layout.container.Border", {


    targetCls: Mini2.baseCSSPrefix + 'border-layout-ct',

    itemCls: [Mini2.baseCSSPrefix + 'border-item', Mini2.baseCSSPrefix + 'box-item'],

    type: 'border',

    isBorderLayout: true,

    beginLayout: function (ownerContext) {


    },


    getLayoutItems: function () {


    }

});


/************************************************************************/
/*                                           */
/*    ui/layout/container/Form.js                                          */
/*                                           */
/************************************************************************/



/// <reference path="../Mini.js" />
/// <reference path="../../../jquery/jquery-1.4.1-vsdoc.js" />



Mini2.define("Mini2.ui.layout.container.Form", {


    targetCls: Mini2.baseCSSPrefix + 'form-layout-ct',

    itemCls: [Mini2.baseCSSPrefix + 'form-item', Mini2.baseCSSPrefix + 'box-item'],

    type: 'form',

    isFormLayout: true,


    //初始化组件
    initComponent: function () {
        var me = this;

        me.length = 0;


    },

    configureItem: function (item) {
        "use strict";
        var me = this,
            itemCls = me.itemCls,
            ownerItemCls = me.owner.itemCls,
            addClasses;

        item.ownerLayout = me;

        if (addClasses) {
            item.addCls(addClasses);
        }
    },

    updateLayout: function (owner) {
        var me = this;

        //console.log(me.owner.flowDirection);

    },

    beginLayout: function (ownerContext) {

        console.log(me.owner.flowDirection);

    },


    getLayoutItems: function () {


    }

});


/************************************************************************/
/*                                           */
/*    ui/layout/container/HBox.js                                          */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini.js" />

//水平排列
Mini2.define("Mini2.ui.layout.container.HBox", {

    itemCls: [
        Mini2.baseCSSPrefix + 'form-item',
        Mini2.baseCSSPrefix + 'box-item'
    ],

    //初始化组件
    initComponent: function () {
        var me = this;

        me.length = 0;


    },


    configureItem: function (item) {
        "use strict";
        var me = this,
            itemCls = me.itemCls,
            ownerItemCls = me.owner.itemCls,
            addClasses;

        item.ownerLayout = me;

        if (addClasses) {
            item.addCls(addClasses);
        }
    },

    afterHeight: 0,


    getItemObj: function (obj) {
        var itemObj;
        if (obj.muid) {
            itemObj = obj;
        }
        else {
            itemObj = $(obj).data('me');
        }
        return itemObj;
    },


    //获取各个项目的总宽度
    getItemWidth2: function (items) {
        "use strict";
        var me = this,
            item,
            w = 0;

        $(items).each(function () {
            item = this;
            item = me.getItemObj(item);

            if (item) {
                w += item.getWidth(true);
            }
            else if (Mini2.isDom(item) && $(item).is(':visible')) {
                w += $(item).outerWidth(true);
            }
        });

        return w;
    },


    updateLayout: function (owner) {
        "use strict";

        var me = this,
            boxTarget = owner.boxTarget,
            el = owner.el,
            oWidth,
            items,
            itemsW, //全部宽度
            len,
            x0 = 0, y0 = 0,
            index = 0,
            y2 = 0,
            align = me.align,
            padding = owner.padding,
            sysInfo = Mini2.SystemInfo.form,
            itemMarginBottom = sysInfo.itemMarginBottom || 0;

        //var oWidth = owner.getWidth();

        oWidth = owner.targetWidth; //目标宽度

        items = $(boxTarget).children(':visible');


        itemsW = 0;


        len = items.length;


        if (align == 'center') {
            itemsW = me.getItemWidth2(items);
            x0 = (oWidth - itemsW) / 2;
        }
        else if (align == 'right') {
            itemsW = me.getItemWidth2(items);
            x0 = oWidth - itemsW;
        }


        var lineHegith = 0, //当前行的高度
            i,
            item,
            itemEl,
            w, h,
            obj;

        for (i = 0; i < len; i++) {

            item = items[i];

            itemEl = $(item);

            w = itemEl.outerWidth(true);
            h = itemEl.outerHeight(true);

            lineHegith = Math.max(lineHegith, h);

            obj = me.getItemObj(item);



            if (undefined === obj) {

                if (itemEl && itemEl.hasClass('mi-newline')) {

                    //换行
                    y0 += lineHegith + itemMarginBottom;
                    x0 = 0;

                    lineHegith = 0;

                    index = 0;

                }

                continue;
            }

            if (index > 0 && x0 + w > oWidth) {

                //换行
                y0 += lineHegith + itemMarginBottom;
                x0 = 0;


                index = 0;


                console.debug("换行2");
            }


            obj.setLeft(x0);
            obj.setTop(y0);


            y2 = y0 + lineHegith;
            index++;

            if (x0 + w < oWidth) {
                x0 += w;
            }
            else {

                //换行
                y0 += lineHegith + itemMarginBottom;

                x0 = 0;

                lineHegith = 0;

                index = 0;

            }

        }


        y2 += padding.bottom + padding.top;

        me.afterHeight = y2;
        owner.targetHeight = y2;

    },

    beginLayout: function (ownerContext) {


    },


    getLayoutItems: function () {


    }

});


/************************************************************************/
/*                                           */
/*    ui/layout/container/VBox.js                                          */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />


//垂直排列
Mini2.define("Mini2.ui.layout.container.VBox", {

    itemCls: [Mini2.baseCSSPrefix + 'form-item', Mini2.baseCSSPrefix + 'box-item'],

    //初始化组件
    initComponent: function () {
        var me = this;

        me.length = 0;


    },

    configureItem: function (item) {
        "use strict";
        var me = this,
            itemCls = me.itemCls,
            ownerItemCls = me.owner.itemCls,
            addClasses;

        item.ownerLayout = me;

        if (addClasses) {
            item.addCls(addClasses);
        }
    },

    getItemObj: function (obj) {
        "use strict";
        var itemObj;
        if (obj.muid) {
            itemObj = obj;
        }
        else {
            itemObj = $(obj).data('me');
        }
        return itemObj;
    },


    //获取各个项目的总宽度
    getItemWidth2: function (items) {
        "use strict";
        var me = this,
            w = 0;

        $(items).each(function () {

            var itemObj = me.getItemObj(this);

            if (itemObj) {

                w += itemObj.getWidth();

            }
            else if (Mini2.isDom(this) && $(this).is(':visible')) {
                w += $(this).outerWidth();
            }
        });

        return w;
    },


    updateLayout: function (owner) {
        "use strict";
        var me = this,
            y = 0,
            h = 0,
            i,
            w = owner.width,
            boxTarget = owner.boxTarget,
            items;

        items = boxTarget.children();

        var itemsW = me.getItemWidth2(items);



        $(items).each(function () {

            var itemObj = me.getItemObj(this);

            if (itemObj) {

                itemObj.setTop(y);
                itemObj.setWidth(w);

                h = itemObj.getHeight();
                y += h;
            }
            else if (Mini2.isDom(this) && $(this).is(':visible')) {


                $(this).css({
                    'top': y,
                    'width': w
                });

                h = $(this).outerHeight();
                y += h;
            }
        });


    },


    beginLayout: function (ownerContext) {


    },


    getLayoutItems: function () {


    }

});


/************************************************************************/
/*                                           */
/*    ui/panel/Panel.js                                                    */
/*                                           */
/************************************************************************/

/// <reference path="../../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini.js" />

Mini2.define("Mini2.ui.panel.Panel", {

    extend: 'Mini2.ui.Component',

    log: Mini2.Logger.getLogger('Mini2.ui.panel.Panel', false),  //日志管理器

    baseCls: Mini2.baseCSSPrefix + "panel",

    //显示的模板代码
    renderTpl: [
        '<div role="Panel" style="right: auto; left: 0px; top: 0px;">',
            '<div class="mi-box-inner " role="presentation" style="">',
                '<div class="mi-box-target" style="width: 100%; "></div>',
            '</div>',
        '</div>'
    ],


    // auto=自动绑定模式， filter=过滤模式，配合服务器组件使用
    // auto | filter 
    formMode : 'auto', 

    //显示边框
    border: true,

    isPanel: true,

    width: '100%',
    //height: 100,


    //    minWidth: 0,
    //    minHeight:0,


    // top: 0,
    // left: 0,
    // bottom
    // right

    //auot, none = 没有滚动条, vertical = 垂直滚动条,Horizontal = 水平滚动条
    //scroll: 'auto',

    /**
    * 边缘空白
    */
    //margin: 0,
    //marginLeft: 0,
    //marginRight: 0,
    //marginTop: 0,
    //marginBottom: 0,


    //left | right | buttom | top
    dock: 'top',

    region: 'north',

    //head | body | footer
    ui: 'default',

    uiCls: [],

    userCls: null,

    lockable: false,

    flowDirection: 'lefttoright',

    wrapContents: true,

    itemWidth: 0,

    fixed: false,

    //自动调整尺寸
    autoSize: false,

    ownerParent: null,



    callParent: function () {
        var me = this,
            ownerParent = me.ownerParent;

        ownerParent && ownerParent.updateLayout();

    },


    //updateLayout: Mini2.emptyFn,

    //初始化组件
    initComponent: function () {
        "use strict";
        var me = this,
            layout = me.layout;

        if (Mini2.isString(layout)) {
            me.layout = {
                type: layout
            };
        }
        else if (!layout) {
            me.layout = {
                type: 'auto'
            };
        }

        //第一次显示
        me.oneShow = !!me.visible;

        me.itemMargin = Mini2.apply({ left: 0, top: 0, right: 0, bottom: 0 }, me.itemMargin);
        me.padding = Mini2.apply({ left: 0, top: 0, right: 0, bottom: 0 }, me.padding);

        if (me.layout.type == "toolbar") {
            me.baseCls = Mini2.baseCSSPrefix + "toolbar";
        }
    },


    scrollTop: function (value) {
        var me = this,
            boxTarget = me.boxTarget;

        boxTarget.scrollTop(value);

        return me;
    },


    //调整下方子项的尺寸
    resizeChilds: function () {
        var me = this;


    },


    toggle: function () {
        var me = this,
            el = me.el;

        if (me.isVisible()) {
            me.hide();
        }
        else {
            me.show();
        }

        return me;
    },



    resize: function (fn) {
        var me = this,
            i,
            fns = me.resizeFns || [],
            len ,
            fn;

        if (arguments.length == 0) {

            me.updateLayout(me);

            for (i = 0,len = fns.length; i < len; i++) {
                fn = fns[i];
                fn.call(me);
            }
        }
        else {
            if (!me.resizeFns) {
                me.resizeFns = fns;
            }

            fns.push(fn);
        }



    },

    prepareItems_ForFlow: function (items) {
        var me = this,
            preItems = [];


        return items;
    },

    prepareItems_ForTable: function (items) {
        var me = this,
            preItems = [];



        return items;
    },

    getItemObj: function (obj) {
        var itemObj;
        if (obj.muid) {
            itemObj = obj;
        }
        else {
            itemObj = $(obj).data('me');
        }
        return itemObj;
    },

    prepareItems: function (items) {
        "use strict";

        var me = this,
            i,
            item,
            itemMi,
            itemEl,
            flowDirection = me.flowDirection,
            layout = me.layout,
            itemLabel,
            preItems = [];


         
        $(items).each(function () {
            item = this;
            itemMi = me.getItemObj(item);

            if (itemMi) {

                itemMi.ownerParent = me;

                itemEl = itemMi.el;

                if (itemMi.isVisible && !itemMi.isVisible()) {
                    return;
                }

                preItems.push(itemMi);


                if ('lefttoright' == flowDirection) {

                    itemEl.addClass('mi-form-item-float-left');
                }
                
                itemEl.addClass('mi-anchor-form-item'); //增加表单底部锚点

                //对子项注入新的样式
                if (layout && layout.itemCls) {
                    itemEl.addClass(layout.itemCls);
                }

                if (me.itemWidth && itemMi.setWidth) {

                    if (itemMi.width == '100%') {

                        if (itemMi.colspan) {
                            itemMi.setWidth(me.itemWidth * itemMi.colspan);
                        }
                        else {
                            itemMi.setWidth(me.itemWidth);
                        }
                    }
                }

                itemLabel = itemMi.labelable;

                if (itemLabel) {

                    if (me.itemLabelWidth) {
                        itemLabel.setWidth(me.itemLabelWidth);
                    }

                    if (me.itemLabelAlign) {
                        itemLabel.setLabelAlign(me.itemLabelAlign);
                    }

                    if (me.itemLabelPad) {
                        itemLabel.setLabelPad(me.itemLabelPad);
                    }

                }


            }
            else if (Mini2.isDom(item) && $(item).is(':visible')) {

                preItems.push(item);

                var itemEl = $(item);

                //换行的样式
                if (itemEl.hasClass('mi-newline')) {

                }
                else {

                    if ('lefttoright' == flowDirection) {
                        
                        itemEl.addClass('mi-form-item-float-left');
                    }

                    //对子项注入新的样式
                    if (layout && layout.itemCls) {
                        itemEl.addClass(layout.itemCls);
                    }

                    if (me.itemWidth) {
                        itemEl.css('width', me.itemWidth);
                    }
                }
            }

        });

        return preItems;
    },

    //排版引擎
    layoutEngine: null,



    offsetParent: function (elem) {
        "use strict";
        var el = $(elem),
            borderBoxCls = 'mi-border-box',
            i = 0;

        if (el.hasClass(borderBoxCls)) {
            return elem;
        }

        for (i; i < 99; i++) {

            el = el.parent();

            if (el.hasClass(borderBoxCls)) {

                break;
            }
        }

        return el;
    },


    //获取拥有 TabStop=true 的项目
    getTabItems: function () {
        "use strict";
        var me = this,
            log = me.log,
            item, itemObj,
            items,
            layout = me.layout,
            layoutType ,
            boxTarget = me.boxTarget,
            preItems =[];


        items = boxTarget.children();

        if (layout) {
            layoutType = layout.type;
        }

        $(items).each(function () {
            item = this;
            itemObj = me.getItemObj(item);

            if (itemObj && itemObj.tabStop ) {             
                preItems.push(itemObj);
            }
        });

        return preItems;
    },


    /**
    * items 集合缓冲
    */
    itemsBuffer : null,


    updateLayout: function (owner) {
        "use strict";

        var me = this,
            log = me.log,
            items,
            pBox,
            engine = me.layoutEngine,
            layout = me.layout,
            layoutType = layout.type,
            boxTarget = me.boxTarget;

        if (!me.isVisible()) {
            return;
        }

        pBox = me.offsetParent(me.el);


        //items = me.itemsBuffer;

        if (!items) {

            items = boxTarget.children();

            if ('table' == layoutType) {
                items = me.prepareItems_ForTable(items);
            }
            else {
                items = me.prepareItems(items);
            }

            me.itemsBuffer = items;
        }


        if (items && items.length == 0) {
            return;
        }
        

        if ('form' == layoutType) {

            engine = engine || Mini2.create('Mini2.ui.layout.container.Form', {
                owner: me
            });
        }
        else if ('hbox' == layoutType) {    //水平排列.宽度固定，高度自动。

            engine = engine || Mini2.create('Mini2.ui.layout.container.HBox', {
                owner: me,
                align: layout.align
            });
        }
        else if ('vbox' == layoutType) {    //垂直排列.高度固定，宽度自动
            engine = engine || Mini2.create('Mini2.ui.layout.container.VBox', {
                owner: me,
                align: layout.align
            });
        }
        else {

            engine = engine || Mini2.create('Mini2.ui.container.DockingContainer', {
                owner: me,
                itemMargin: me.itemMargin,
                padding: me.padding
            });


            engine.clearItems();

            if (items.length) {
                engine.addDocked(items);
            }
        }

        engine.updateLayout(me);

        me.layoutEngine = engine;
    },


    getWidth: function () {
        return this.el.outerWidth();
    },

    getHeight: function () {
        return this.el.outerHeight();
    },

    getSize: function () {
        var me = this;
        return { 'width': me.getWidth(), 'height': me.getHeight() };
    },

    setLeft: function (value) {
        var me = this,
            el = me.el;

        el.css('left', value);

        return me;
    },
    getLeft: function () {
        var me = this,
            el = me.el;

        return el.css('left');
    },

    getTop: function () {
        var me = this,
            el = me.el;

        return el.css('top');
    },
    setTop: function (value) {
        var me = this,
            el = me.el;

        el.css('top', value);

        return me;
    },

    
    setSize: function (w, h, callEvent) {
        "use strict";

        var me = this,
            log = me.log,
            el = me.el,
            minHeight = me.minHeight,
            boxInner = me.boxInner,
            boxTarget = me.boxTarget,
            padding = me.padding,
            allValue = 0;



        if (minHeight && h && h < minHeight) {
            h = minHeight;
        }

        me.targetWidth = w || me.width;     //预计达到宽度
        me.targetHeight = h || me.height;   //预计达到高度


        me.updateLayout(me);

        me.width = me.targetWidth || me.width;
        me.height = me.targetHeight || me.height;


        if (el) {

            if (me.autoSize) {

                if ('vertical' == me.scroll) {
                    //只有垂直滚动条

                    var boxW = me.width - (padding.right + padding.left);

                    el.css({ 'width': me.width});
                    boxInner.css({ 'width': '100%' });
                    boxTarget.css({ 'width': boxW });
                }


            }
            else {
                var boxW = me.width - (padding.right + padding.left);
                var boxH = me.height - (padding.bottom + padding.top);
                                    
                el.css({ 'width': me.width, 'height': me.height });
                boxInner.css({ 'width': '100%', 'height': boxH });
                boxTarget.css({ 'width': boxW, 'height': boxH });
            }
        }

        me.resize();


        return me;
    },




    animate: function (styles, speed, easing, callback) {
        var me = this,
            el = me.el;

        el.animate(styles, speed, easing, callback)

        return me;
    },

    hide: function () {
        var me = this,
            el = me.el;

        if (el) {
            el.hide();

            me.callParent();
        }

        return me;
    },

    show: function () {
        var me = this,
            el = me.el;
        
        if (el) {
            el.show();

            me.callParent();
            me.callParent();    //注: 调用了两次，临时解决方法，以后改进。(2014-11-02 20:32)
        }

        return me;
    },

    css: function (styleName, styleValue) {
        var me = this,
            el = me.el;

        return el.css(styleName, styleValue);
    },


    isVisible: function () {
        var me = this,
            el = me.el;

        return el && el.is(':visible');
    },

    /**
    * 重置层次
    */
    resetPaint: function(){
        var me = this,
            items = me.itemsBuffer || [],
            item,
            i,
            len = items.length;

        for (i = 0; i < len; i++) {
            item = items[i];

            if (item && item.resetPaint) {
                item.resetPaint.call(item);
            }
        }
    },

    baseRender: function () {
        "use strict";
        var me = this,
            log = me.log,
            el,
            padding = me.padding,
            boxInner,
            boxTarget,
            w = me.width,
            h = me.height;


        me.el = el = Mini2.$join(me.renderTpl);
        me.boxInner = boxInner = el.cFirst('.mi-box-inner');
        me.boxTarget = boxTarget = boxInner.cFirst('.mi-box-target');




        //因为事件机制的不完善，加了两个事件，防止点击到底下 Window，触发了其他事件。

        //el.muBind('mousedown', function () {
        //    //Mini2.ui.FocusMgr.setControl(this);
        //});
        //el.muBind('mouseup', function () {
        //    Mini2.ui.FocusMgr.setControl(me);
        //});

        

        //el.css({
        //    'margin': me.margin,
        //    'margin-left': me.marginLeft,
        //    'margin-right': me.marginRight,
        //    'margin-top': me.marginTop,
        //    'margin-bottom': me.marginBottom
        //});



        el.mouseup(function () {
            Mini2.ui.FocusMgr.setControl(me);
        });
        

        if (me.visible == false) {
            el.hide();
            delete me.visible;
        }

        if (me.onResize) {
            me.resize(me.onResize);
        }

        el.data('me', me);

        el.addCls(me.baseCls, 'mi-box-layout-ct');

        if (me.ui) {
            el.addCls(me.baseCls + '-' + me.ui);
        }

        if (me.anchorFixedType) {

            if (me.anchorFixedType == 'topbottom') {

                el.addClass('mi-panel-anchorfixed-topbotom');

            }

        }


        if ('default' != me.dock) {

            if ('none' != me.dock) {
                el.addCls('mi-docked',
                    'mi-docked-' + me.dock,
                    me.baseCls + '-docked',
                    me.baseCls + '-docked-' + me.dock);

                if (me.ui) {
                    el.addCls(me.baseCls + '-' + me.ui + '-docked-' + me.dock);
                }
            }
        }


        if (me.fixed) {
            el.addClass('mi-fixed-layer');
            el.css('z-index', 1009);
        }

        //auot, none = 没有滚动条, vertical = 垂直滚动条,Horizontal = 水平滚动条
        switch (me.scroll) {
            case 'none': boxTarget.css({ 'overflow': 'hide' }); break;
            case 'vertical': boxTarget.css({ 'overflow-x': 'hidden', 'overflow-y': 'auto' }); break;
            case 'horizontal': boxTarget.css({ 'overflow-x': 'auto', 'overflow-y': 'hidden' }); break;
            default: boxTarget.css({ 'overflow': 'auto' }); break;
        }



        var attrList = [
            'left', 'top', 'right', 'bottom',
            'width', 'height', 'position'];

        var cssPs = {};

       

        for (var i = 0; i < attrList.length; i++) {
            var attrName = attrList[i];

            //log.debug('attr=' + attrName + ", value=" + me[attrName]);

            if (me[attrName]) {
                cssPs[attrName] = me[attrName];
            }
        }


        for (var i in padding) {
            var attrName = 'padding-' + i;

            cssPs[attrName] = padding[i];
        }

        if (me.maxWidth) {
            el.css({ 'max-width': me.maxWidth });
            boxTarget.css({ 'max-width': me.maxWidth });
        }

        if (me.minWidth) {
            el.css({ 'min-width': me.minWidth });
            boxTarget.css({ 'min-width': me.minWidth });
        }

        if (me.maxHeight) {
            el.css({ 'max-height': me.maxHeight });
            boxTarget.css({ 'max-height': me.maxHeight });
        }

        if (me.minHeight) {
            el.css({ 'max-height': me.minHeight });
            boxTarget.css({ 'max-height': me.minHeight });
        }


        if (me.margin) {
            el.css({ 'margin': me.margin });
        }

        if (me.marginLeft) {
            el.css({ 'margin-left': me.marginLeft });
        }

        if (me.marginRight) {
            el.css({ 'margin-right': me.marginRight });
        }
                
        if (me.marginTop) {
            el.css({ 'margin-top': me.marginTop });
        }

        if (me.marginBottom) {
            el.css({ 'margin-bottom': me.marginBottom });
        }

        el.css(cssPs);


        if (me.right) {
            
        }

        if (me.autoSize) {
            boxTarget.css({
                position: 'static',
                height: 'auto'
            });
        }
        else {

            el.css({ width: w });

            boxInner.css({ width: w, height: h });

            boxTarget.css({ width: w, height: h });
        }


        if (me.userCls) {
            el.addClass(me.userCls);
        }



        if (me.contentEl) {

            var contentEl = $(me.contentEl);
            var items = contentEl.children();
            
            contentEl.after(el);

            boxTarget.append(items);

            el.attr('id', contentEl.attr('id'));

            contentEl.remove();
        }
        else if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else if (me.renderTo) {
            $(me.renderTo).append(el);
        }



        //setTimeout(function () {
        //    me.updateLayout();
        //}, 100);


    },

    focus:function(){
        var me = this;

        Mini2.ui.FocusMgr.setControl(me);

        return me;
    },


    afterRender: function () {
        var me = this;

        me.updateLayout();
    },


    //显示延迟
    delayRender: function () {
        var me = this,
            el = $(me.applyTo);

        me.isDelayRender = true;

        Mini2.delayRS = Mini2.delayRS || {};

        Mini2.delayRS[me.clientId] = me;

        el.attr('mi-delay-render', 'true');
        el.data('me', me);
    },


    //延迟加载定时器
    delayRenderTimer:function(){
        var me = this,
            log = me.log;

        setTimeout(function () {
            var htmlItems = me.boxTarget.children();


            $(htmlItems).each(function () {

                var itemId = $(this).attr('id');

                //log.debug('itemId = ' + itemId);

                if (itemId && Mini2.delayRS) {

                    var dd = Mini2.delayRS[itemId];

                    if (!dd) {
                        itemId = '#' + itemId;
                        dd = Mini2.delayRS[itemId]
                    }

                    if (dd) {

                        dd.render();

                        delete Mini2.delayRS[itemId];

                        //log.debug("加载:" + itemId);

                    }
                }

            });

            me.updateLayout();

        }, 100);

        delete me.isDelayRender;
    },

    render: function () {
        var me = this,
            log = me.log,
            padding = me.padding,
            itemMargin = me.itemMargin,
            allValue = 0;


        if (padding.all && 'auto' != padding.all) {
            allValue = parseInt(padding.all);
        }

        Mini2.applyIf(padding, {
            left: allValue,
            right: allValue,
            top: allValue,
            bottom: allValue
        });



        if (itemMargin.all && 'auto' != itemMargin.all) {
            allValue = parseInt(padding.all);
        }

        Mini2.applyIf(itemMargin, {
            left: allValue,
            right: allValue,
            top: allValue,
            bottom: allValue
        });


        me.baseRender();


        if (me.isDelayRender) {
            me.delayRenderTimer();
        }

        try {
            Mini2.ui.SecManager.reg(me.secFunCode, me);
        }
        catch (ex) {
            console.error('注册权限错误', ex);
        }
    }


}, function () {
    var me = this;

    Mini2.apply(this, arguments[0]);

    me.initComponent();


    Mini2.LoaderManager.afterRender(me);
});


/************************************************************************/
/*                                           */
/*    ui/panel/FormPanel.js                                                */
/*                                           */
/************************************************************************/


Mini2.define("Mini2.ui.panel.FormPanel", {

    extend: 'Mini2.ui.panel.Panel',

    log: Mini2.Logger.getLogger('Mini2.ui.panel.FormPanel', false),  //日志管理器


    flowDirection: 'topdown',

    /**
     * 查找所有 Mini2 控件
     * @param {domEl} parentEl 上级html节点
     * @param {Array} list 搜索到的集合 
     */
    findItems: function (parentEl, list) {
        var me = this;

        if (!list) {
            list = [];
        }

        var childItems = $(parentEl).children();

        $(childItems).each(function () {
            var childEl = this;

            var data = $(childEl).data('me');

            if (data) {
                list.push(childEl);
                return false;
            }
            else {
                me.findItems(childEl, list);
            }

        });

        return list;
    },

    /**
     * 获取需要绑定的项目
     */
    getBindItems: function () {
        var me = this,
            store = me.store,
            boxTarget = me.boxTarget,
            items = boxTarget.children(),
            len = items.length,
            i = 0,
            dbItems = [];


        items = me.prepareItems(items);

        var childItems = [];

        for (i = 0; i < len; i++) {

            var item = items[i];

            item = me.getItemObj(item);

            if (!item) {
                me.findItems(items[i], childItems);
            }
        }

        items = items.concat(childItems);

        len = items.length;


        for (i = 0; i < len; i++) {
            var item = items[i];

            item = me.getItemObj(item);

            if (!item) {
                continue;
            }


            if (item.isRangeControl) {

                if (item.startDataField || item.endDataField) {
                    dbItems.push(item);
                }

            }
            else if (item.dataField) {
                dbItems.push(item);;
            }


        }

        return dbItems;
    },


    //绑定项目焦点放开触发的事件
    //bindItemFocusout: function () {
    //    var me = this,
    //        log = me.log,
    //        item,
    //        items, len;


    //    items = me.getBindItems();
    //    len = items.length;

    //    for (i = 0; i < len; i++) {
    //        item = items[i];

    //        $(item).muBind('focusout', function () {
    //            me.item_focusout.call(me, this);
    //        });

    //        if (item.isCheckbox) {
    //            console.trace();
    //        }

    //        //如果是复选框, 就特殊处理,一旦值发生变化,直接触发事件
    //        if (item.isCheckbox) {
    //            item.bind('changed', function () {
    //                log.debug("触发事件 changed");
    //                me.setStoreRecrod.call(me, this);
    //            });

    //        }
    //    }
    //},

    // item 焦点离开触发的事件
    item_focusout: function (sender) {
        var me = this


        me.setStoreRecrod(sender)
    },


    /**
    * 设置当前焦点行,某个字段的值
    */
    setCurRectValue: function (control, dataField, value) {
        var me = this,
            curRect,
            store = me.store;


        if (store && store.isStore) {

            curRect = store.getCurrent();

            if (curRect) {

                curRect.set(dataField, value);


                control.setDirty(true);


            }
        }

        return me;
    },


    /**
     * 设置记录
     */
    setRecord: function (record) {

        var me = this;

        if (record) {

            if (record.isModel) {

                console.error('还没支持这种格式...可以加的...', record);

            }
            else {
                me.setObjectRecord(record);
            }
        }

    },

    /**
     * 普通对象
     */
    setObjectRecord: function (record) {
        var me = this,
            conList,
            conValue;

        for (var itemName in record) {

            conList = me.findByDataField(itemName);

            conValue = record[itemName];

            me.setValueToControl(conList, conValue);

        }


    },

    /**
     * 对控件进行赋值
     */
    setValueToControl: function (conList, value) {

        var me = this;

        $(conList).each(function () {
            this.setValue(value);
        });

        return me;
    },


    setStoreRecrod: function (sender) {
        var me = this,
            item = sender;

        if (item.readOnly || !item.isValueChanged()) {

            return me;
        }


        if (item.isRangeControl) {

            if (item.startDataField && item.isValueChanged('start')) {

                var value = item.getStartValue();

                me.setCurRectValue(item, item.startDataField, value);
            }

            if (item.endDataField && item.isValueChanged('end')) {

                var value = item.getEndValue();

                me.setCurRectValue(item, item.endDataField, value);

            }

        }
        else {
            var value = item.getValue();
            me.setCurRectValue(item, item.dataField, value);
        }


    },

    getItemObj: function (obj) {

        var itemObj = null;

        if (obj) {
            if (obj.muid) {
                itemObj = obj;
            }
            else {
                itemObj = $(obj).data('me');
            }
        }

        return itemObj;
    },



    bindStore: function (store) {
        "use strict";
        var me = this,
            log = me.log;

        me.store = store;

        $(store)
            .muBind('update', me, me.store_update)              //监听记录更新事件
            //.muBind('add', me, me.store_add)                    //监听记录添加事件
            //.muBind('datachanged', me, me.store_dataChanged)    //监听数据更改
            //.muBind('refresh', me, me.store_refresh)            //监听刷新事件
            .muBind('locked', me, me.store_locked)
            .muBind('load', me, me.store_load)                  //加载事件

            .muBind('bulkremove', me, me.store_bulkRemove)      //左上角标记移除事件
            .muBind('invalid', me, me.store_invalid)            //出现异常的单元格
            .muBind('clear', me, me.store_clear)                //删除全部记录事件

            .muBind('currentchanged', me, me.store_currentChanged);  //焦点行发生改变的事件


        me.store.onCurrentChanged();

    },

    store_bulkRemove: function (event, ex) {
        "use strict";
        var me = event.data;

        //console.log("store_bulkremove ", ex);
    },

    //出现异常信息
    store_invalid: function (event, ex) {
        "use strict";
        var me = event.data;

        var errs = ex.errors;

        if (errs.length > 0) {
            var items = errs.items;

            for (var itemName in items) {

                var item = items[itemName];

                var errStr = "";

                for (var i = 0; i < item.length; i++) {
                    if (item[i].type == "error") {
                        errStr += item[i].message;
                    }
                }

                //console.error("字段 " + itemName, errStr);

                var conList = me.findByDataField(itemName);


                //console.log("conList = ", conList.length);

                if (conList && conList.length) {
                    var conLen = conList.length;

                    for (var j = 0; j < conLen; j++) {

                        var con = conList[j];


                        con.markInvalid(errStr);
                    }
                }


            }
        }


    },


    //出现异常信息
    store_clear: function (event, ex) {
        "use strict";
        var me = event.data;

        //console.log("store_clear ", ex);
    },

    store_locked: function (event, ex) {
        "use strict";
        var me = event.data;

        //console.log("锁事件")
    },


    store_dataChanged: function (event, ex) {
        "use strict";
        var me = event.data;


        //console.log(ex);
    },



    store_update: function (event, record, operation, modifiedFieldNames) {
        "use strict";
        var me = event.data,
            i, j,
            modifiedField,
            items,
            len,
            isUpdateStyleField = false;


        //log.debug(operation + '  record["ROW_STYLE_JSON"] = ', record.get("ROW_STYLE_JSON"));
        

        if ('COMMIT' == operation) {


            for (i = 0; i < modifiedFieldNames.length; i++) {

                modifiedField = modifiedFieldNames[i];

                if ('ROW_STYLE_JSON' == modifiedField) {

                    var jsonStr = record.get('ROW_STYLE_JSON');

                    if ('' == jsonStr) {
                        continue;
                    }

                    var json = null;

                    try {
                        json = eval('(' + jsonStr + ')');
                    }
                    catch (ex) {
                        log.debug("json 解析数据错误" + jsonStr);
                        continue;
                    }

                    for (var k = 0; k < json.cols.length; k++) {

                        var fieldSX = json.cols[k];

                        //console.log("field = ", fieldSX);

                        items = me.findByDataField(fieldSX.name);

                        var len = items.length;

                        for (j = 0; j < len; j++) {

                            var item = items[j];

                            var msg = "";

                            for (var l = 0; l < fieldSX.msgs.length; l++) {
                                if (l > 0) { msg += "\n"; }

                                msg += fieldSX.msgs[l].message;
                            }

                            item.markInvalid(msg);
                        }


                    }


                }
                else {
                    items = me.findByDataField(modifiedField);

                    len = items.length;

                    for (j = 0; j < len; j++) {

                        var item = items[j];
                        var value = record.get(item.dataField);

                        item.setDirty(false);

                        if (item.oldValue != value) {
                            item.oldValue = item.getValue();

                            item.setValue(value);
                        }

                    }
                }
            }

        }
        else if ('EDIT' == operation) {

            for (i = 0; i < modifiedFieldNames.length; i++) {

                modifiedField = modifiedFieldNames[i];

                items = me.findByDataField(modifiedField);

                len = items.length;

                for (j = 0; j < len; j++) {

                    var item = items[j];
                    var value = record.get(item.dataField);

                    item.setDirty(false);

                    if (item.oldValue != value) {
                        item.oldValue = item.getValue();

                        item.setValue(value);
                    }


                }

            }
        }
        else {
            console.log('operation=', operation);

        }


        var isLocked = record.isLocked();

        me.record_locked(record, isLocked);


        return isUpdateStyleField;
    },


    //根据 dataField 字段进行查找
    findByDataField: function (dataField) {
        "use strict";
        var me = this,
            boxTarget = me.boxTarget,
            items = boxTarget.children(),
            len = items.length,
            newItems = [],
            item, i;

        items = me.prepareItems(items);


        var childItems = [];

        for (i = 0; i < len; i++) {

            var item = items[i];

            item = me.getItemObj(item);

            if (!item) {
                me.findItems(items[i], childItems);
            }
        }

        items = items.concat(childItems);

        len = items.length;

        if (items && items.length == 0) {
            return newItems;
        }


        for (i = 0; i < len; i++) {

            item = items[i];

            item = me.getItemObj(item);

            if (!item || !item.dataField) {
                continue;
            }

            if (dataField != item.dataField) {
                continue;
            }



            newItems.push(item);
        }

        return newItems;
    },

    store_load: function (event, store) {
        "use strict";
        var me = event.data,
            log = me.log,
            i,
            record,
            records = store.data,
            len;
        

    },


    //lockeState : undefined,

    //记录锁状态
    record_locked: function (record, lockeState) {
        var me = this,
            log = me.log,
            store = me.store,
            boxTarget = me.boxTarget,
            items = boxTarget.children(),
            len = items.length,
            i = 0;

        if (me.lockeState === lockeState) {
            return;
        }

        me.lockeState = lockeState;;

        items = me.prepareItems(items);

        var childItems = [];

        for (i = 0; i < len; i++) {

            var item = items[i];

            item = me.getItemObj(item);

            if (!item) {
                me.findItems(items[i], childItems);
            }
        }

        items = items.concat(childItems);

        len = items.length;


        for (i = 0; i < len; i++) {
            var item = items[i];

            item = me.getItemObj(item);

            if (!item) {
                continue;
            }

            if (!item.dataField) {
                //console.error('字段名为空，跳出. fieldLabel=' + item.fieldLabel, item);
                continue;
            }

            if (false === item.allowChangeReadonly) {
                continue;
            }

            if (record.isLockedExclusionField(item.dataField)) {
                item.setReadOnly(false);
            }
            else {
                item.setReadOnly(lockeState);
            }

        }

    },

    store_currentChanged: function (event, index, record) {
        "use strict";
        var me = event.data,
            log = me.log;


        if (index > -1) {


            var boxTarget = me.boxTarget;

            var items = boxTarget.children();

            items = me.prepareItems(items);


            //log.debug('rect', record);
            //log.debug('items', items.length);

            if (items && items.length == 0) {
                return;
            }

            if (!record) {
                return;
            }

            for (var i = 0; i < items.length; i++) {
                var item = items[i];

                item = me.getItemObj(item);

                if (!item) { continue; }

                if (item.isRangeControl) {

                    if (item.startDataField) {
                        var rectValue = record.get(item.startDataField);

                        if (item.setOldValue) {
                            item.setOldValue('start', rectValue);
                        }
                        else {
                            item.startOldValue = rectValue;
                        }

                        item.setValue('start', rectValue);
                    }

                    if (item.endDataField) {

                        var rectValue = record.get(item.endDataField);

                        if (item.setOldValue) {
                            item.setOldValue('end', rectValue);
                        }
                        else {
                            item.endOldValue = rectValue;
                        }

                        item.setValue('end', rectValue);

                    }

                }
                else {
                    if (!item.dataField || !item.setValue) {
                        continue;
                    }


                    var rectValue = record.get(item.dataField);

                    if (item.setOldValue) {
                        item.setOldValue(rectValue);
                    }
                    else {
                        item.oldValue = rectValue;
                    }

                    //console.debug("[          " + item.dataField + "=", rectValue);

                    item.setValue(rectValue);
                }
            }

        }


        if (record) {
            var isLocked = record.isLocked();

            me.record_locked(record, isLocked);
        }


    },

    afterRender: function () {
        var me = this,
            item,
            items,
            len,
            i;

        items = me.getBindItems();
        len = items.length;

        for (i = 0; i < len; i++) {
            item = items[i];


            $(item).muBind('focusout', function () {

                me.item_focusout.call(me, this);
            });


            //如果是复选框, 就特殊处理,一旦值发生变化,直接触发事件
            if (item.isCheckbox || item.isCheckGroup) {

                $(item).muBind('changed', function () {

                    me.setStoreRecrod.call(me, this);
                });

            }

            //先记录一下控件的原始状态
            if (item.getReadOnly()) {
                item.allowChangeReadonly = false;
            }

        }

    },

    render: function () {
        var me = this,
            log = me.log;

        //注入全局加载器, 在脚本执行结束后, 执行 afterRender 函数

        me.baseRender();


        if ('auto' == me.formMode) {

            if (me.store) {
                
                var store = Mini2.data.StoreManager.lookup(me.store);

                me.store = store;

                me.bindStore(store);

            }
        }
        else {

        }

        if (me.isDelayRender) {
            me.delayRenderTimer();
        }

        try {
            Mini2.ui.SecManager.reg(me.secFunCode, me);
        }
        catch (ex) {
            console.error('注册权限错误', ex);
        }
    }
});


/************************************************************************/
/*                                           */
/*    ui/panel/AbstractTable.js                                            */
/*                                           */
/************************************************************************/


/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define("Mini2.ui.panel.AbstractTable", {

    log: Mini2.Logger,  //日志管理器

    StrJoin: function (array) {
        "use strict";
        var str = "";
        for (var i = 0; i < array.length; i++) {
            str += array[i];
        }

        return str;
    },

    renderTo: Mini2.getBody(),



    getStore: function () {
        "use strict";
        var me = this,
            newStore;

        if (!me.store) {
            newStore = Mini2.create('Mini2.data.Store', {
                storeId: "MiniStore_" + Mini2.newId(),
                model: 'Mini2.data.FreeModel'
            });

            me.bindStore(newStore);
        }

        return me.store;

    },

    bindStore: function (store) {
        "use strict";
        var me = this;

        me.store = store;

        $(store)
            .muBind('update', me, me.store_update)              //监听记录更新事件
            .muBind('add', me, me.store_add)                    //监听记录添加事件
            .muBind('datachanged', me, me.store_dataChanged)    //监听数据更改
            .muBind('refresh', me, me.store_refresh)            //监听刷新事件
            .muBind('load', me, me.store_load)                  //加载事件
            .muBind('bulkremove', me, me.store_bulkRemove)      //左上角标记移除事件
            .muBind('invalid', me, me.store_invalid)            //出现异常的单元格
            .muBind('clear', me, me.store_clear)                //删除全部记录事件
            .muBind('currentchanged', me, me.store_currentChanged);  //焦点行发生改变的事件

    },


    store_invalid: function (event, record, fieldNames) {
        "use strict";
        var me = event.data,
            rowEl,
            rowIndex,
            i,
            col;

        rowEl = me.getRowForRecord(record);
        rowIndex = $(rowEl).index();


        for (i = 0; i < fieldNames.length; i++) {

            col = me.getColumnForDataIndex(fieldNames[i]);

            me.afterCellUpdate(col, rowEl, record, rowIndex, fieldNames);
        }


    },


    getColumnForDataIndex: function (dataIndex) {
        "use strict";
        var me = this,
            col,
            cols = me.m_Cols,
            i = cols.length,
            list = [];

        while (i--) {
            col = cols[i];

            if (col.dataIndex == dataIndex) {
                list.push(col);
            }
        }

        return list;
    },


    //根据记录获取行TR
    getRowForRecord: function (record, onlyFirst) {
        "use strict";
        var me = this,
            rows = [],
            tbodyEl = me.tbodyEl,
            rowRecord,
            rowEl,
            rowsEls = tbodyEl.children("tr");

        $(rowsEls).each(function () {
            rowEl = this;
            rowRecord = $(rowEl).data("record")

            if (rowRecord === record) {
                rows.push(rowEl);

                if (onlyFirst) { return false; }
            }

        });

        return rows;
    },




    //更新记录的显示内容
    afterCellUpdate: function (column, rowEl, record, rowIndex, modifiedFieldNames) {
        "use strict";
        var me = this,
            cellValues,
            columnIndex = column.dataIndex,
            recordIndex = record.index,
            columnRenderer = column.renderer,
            cellEl,
            isModified,
            fieldValue,
            cellInnerEl,
            value;

        cellEl = $(rowEl).children(':eq(' + column.index + ')');

        fieldValue = record.get(columnIndex);



        if (columnRenderer && columnRenderer.call) {
            try {
                value = columnRenderer.call(column, fieldValue, cellValues, cellValues, record, rowIndex, columnIndex, me.store, me);
            }
            catch (ex) {
                //throw new Error('更新记录内容错误。'+ ex.message);
            }
        }
        else {
            value = fieldValue;
        }

        value = Mini2.isBlank(value) ? '&#160;' : value;


        cellInnerEl = $(cellEl).children(".mi-grid-cell-inner");

        if (record.isDisabledForField(columnIndex)) {
            cellInnerEl.html('<hr style="border:none;border-top:1px dashed #b0b0b0;width:90%" />');
        }
        else {
            cellInnerEl.html(value);
        }
        

        isModified = record.isModified(columnIndex);

        $(cellEl).toggleClass('mi-grid-dirty-cell', isModified);





        ////创建错误标记
        //if (record && record.errors && column.dataIndex && column.dataIndex != '') {

        //    if (record.errors) {
        //        column.markInvalid(record, cellEl, column.dataIndex);
        //    }
        //    else {
        //        column.clearInvalid(record, cellEl, column.dataIndex);
        //    }
        //}



        if (column.bindEvent) {
            column.bindEvent.call(column, me, cellEl, recordIndex, columnIndex, null, record, rowEl);
        }

        //创建错误标记
        me.preColumnInvalid(column, cellEl, record);
    },



    store_currentChanged: function (event, index, record) {
        "use strict";
        var me = event.data,
            focusedCls = 'mi-grid-row-focused',
            row,
            rowRecord,
            rows = $(me.tbodyEl).children(),
            lastRow = me.lastRowFocused,
            curRow = null;

        if (index > -1) {
            $(rows).each(function () {
                row = this;
                rowRecord = $(row).data('record');

                if (rowRecord === record) {
                    curRow = row;
                    return false;
                }
            });

            $(curRow).addClass(focusedCls);
        }

        $(lastRow).removeClass(focusedCls);

        me.lastRowFocused = curRow;

    },

    store_clear: function (event) {
        "use strict";
        var me = event.data;

        me.itemRemoteAll();

        if (me.rowCheckColumn) {
            me.rowCheckColumn.updateHeaderState();
        }
        //var rows = $(me.tbodyEl).children();

        //$(rows).remove();
    },

    //删除记录
    store_bulkRemove: function (event, allRecords, indexes, isMove) {
        "use strict";
        var me = event.data,
            Array = Mini2.Array,
            exist,
            record,
            row,
            checkedRecords = me.checkedRecords,
            rows = me.tbodyEl.children('tr');


        $(rows).each(function () {
            row = this;
            record = $(row).data("record");

            exist = Array.contains(allRecords, record);

            if (exist) {
                $(row).remove();
                Array.remove(checkedRecords, record);
                return false;
            }

        });

        me.itemsReset();

    },


    store_update_forRow: function (rowEl, rowIndex, record, modifiedFieldNames) {
        "use strict";
        var me = this,
            i, j, col, cols,
            modifiedField,
            rowStyleType = me.rowStyleType,
            rowStyleField = me.rowStyleField,
            isUpdateStyleField = false;


        for (i = 0; i < modifiedFieldNames.length; i++) {

            modifiedField = modifiedFieldNames[i];


            if (rowStyleType && modifiedField == rowStyleField) {
                isUpdateStyleField = true;
                continue;
            }

            cols = me.getColumnForDataIndex(modifiedField);
            j = cols.length;

            while (j--) {
                col = cols[j];

                me.afterCellUpdate(col, rowEl, record, rowIndex, modifiedFieldNames);
            }
        }

        return isUpdateStyleField;
    },


    store_update_setInvalid: function (rowEl, record) {
        "use strict";
        var me = this,
            log = me.log,
            i, j,
            rowStyleType = me.rowStyleType,
            rowStyleField = me.rowStyleField,
            jsonStr = record.get(rowStyleField),
            json,
            cellEl,
            colStyle, colMsgs,
            colName,
            col, cols;

        if (!jsonStr) {
            return;
        }

        if ('' == jsonStr) {
            return;
        }


        try {
            json = eval('(' + jsonStr + ')');
        }
        catch (ex) {
            log.debug("json 解析数据错误" + jsonStr);
            return;
        }

        var invalidCols = {};

        record.clearInvalidAll();

        me.clearRowInvalid(rowEl, record);

        for (i = 0; i < json.cols.length; i++) {

            colStyle = json.cols[i];
            colMsgs = colStyle.msgs;

            colName = colStyle.name;


            cols = me.getColumnForDataIndex(colName);
            j = cols.length;

            while (j--) {
                col = cols[j];

                cellEl = $(rowEl).children(':eq(' + col.index + ')');

                if (colMsgs && colMsgs.length) {
                    col.markInvalid.call(col, record, cellEl, col.dataIndex, colMsgs);

                    invalidCols[colName] = true;
                }
                else {
                    col.clearInvalid.call(col, record, cellEl, col.dataIndex);
                }
            }
        }



    },


    //清理行异常提示信息
    clearRowInvalid: function (rowEl, record) {
        "use strict";
        var me = this,
            i,
            cellEl,
            col,
            cols = me.m_Cols


        for (i = 0; i < cols.length; i++) {

            col = cols[i];

            cellEl = $(rowEl).children(':eq(' + col.index + ')');

            col.clearInvalid.call(col, record, cellEl, col.dataIndex);
        }



    },


    store_update: function (event, record, operation, modifiedFieldNames) {
        "use strict";
        //alert(record.isModel + "   " + operation + " " + modifiedFieldNames);

        var me = event.data,
            dirtyCellCls = 'mi-grid-dirty-cell',
            cellValues,
            rowIndex,
            rowEl,
            cells,
            modifiedField,
            isUpdateStyleField,
            rows = me.getRowForRecord(record);

        $(rows).each(function () {
            rowEl = this;
            rowIndex = $(rowEl).index();

            if (modifiedFieldNames) {

                isUpdateStyleField = me.store_update_forRow(rowEl, rowIndex, record, modifiedFieldNames);


                if (isUpdateStyleField) {
                    try {
                        me.store_update_setInvalid(rowEl, record);
                    }
                    catch (ex) {
                        console.error('出现特殊错误', ex);
                        alert("处理单元格提示信息失败。\n\n" + ex.message);
                    }
                }
            }
            else {

                console.debug("-------------------------------    ", modifiedFieldNames);

                cells = $(rows).children('.' + dirtyCellCls);

                $(cells).removeClass(dirtyCellCls);
            }
        });




        if (me.rowCheckColumn) {
            me.rowCheckColumn.updateHeaderState();
        }
    },



    store_refresh: function (event, store) {
        "use strict";
        var me = event.data,
            i,
            len,
            rowCheckColumn = me.rowCheckColumn,
            records;

        me.itemRemoteAll();

        records = me.store.data;
        len = records.length;
        for (i = 0; i < len; i++) {
            me.itemAdd(records.get(i));
        }

        me.itemsReset();

        if (rowCheckColumn) {
            rowCheckColumn.updateHeaderState();
        }
    },


    //延迟显示的数据
    delayData: {

    },



    
    //循环加载
    loopLoadItem: function () {
        "use strict";
        var me = this,
            i, n,
            record,
            delayData = me.delayData,

            initCount = delayData.initCount || 20; //初始时候默认加载20条;

        if (delayData.i >= delayData.len) {
            return;
        }



        i = delayData.i;

        if (i < initCount) {
            n = delayData.len;

            if (n > initCount) { n = initCount; }

            for (i = 0; i < n; i++) {
                delayData.i++;

                record = delayData.items.get(i);

                me.itemInsert(i, record);
            }
        }
        else {
            delayData.i++;

            record = delayData.items.get(i);

            me.itemInsert(i, record);
        }

        setTimeout(function () {
            me.loopLoadItem();
        }, 1);

    },


    /**
     * 延迟加载
     *
     */
    delayLoad: true,

    store_load: function (event, store) {
        "use strict";
        var me = event.data,
            i,
            record,
            records = store.data,
            len,
            rowCheckColumn = me.rowCheckColumn;


        me.itemRemoteAll();

        len = records.length;


        //延迟加载
        if (me.delayLoad) {

            me.delayData = {
                i: 0,
                len: len,
                initCount: 20,
                items: records
            };

            me.loopLoadItem();
        }
        else {

            if (records.items) {
                me.itemInsert(0, records.items);
            }
            else {
                me.itemInsert(0, records);
            }
            
        }

        if (rowCheckColumn) {
            rowCheckColumn.updateHeaderState();
        }

    },

    store_dataChanged: function (event, ex) {
        "use strict";
        var me = event.data,
            editor = me.editor;

        if (editor) {
            editor.hide();
        }
    },

    store_add: function (event, index, out) {
        "use strict";
        var me = event.data,
            i,
            rowCheckColumn = me.rowCheckColumn;

        for (i = 0; i < out.length; i++) {
            me.itemInsert(index + i, out[i]);
        }

        if (rowCheckColumn) {
            rowCheckColumn.updateHeaderState();
        }
    },


    //事件类集合
    //private 
    //eventSet:{},


    //绑定事件
    bind: function (eventName, fun, data, owner) {
        "use strict";

        var me = this,
            evtSet = me.eventSet,
            evts;

        if (!fun) {
            throw new Error('[' + eventName + '] 必须指定绑定函数.');
        }

        if (!evtSet) {
            me.eventSet = evtSet = {};
        }

        evts = evtSet[eventName];

        if (!evts) {
            evts = evtSet[eventName] = [];
        }


        evts.push({
            fun: fun,
            owner: owner,
            data: data
        });

        return me;
    },

    //移除对应的事件
    off: function (eventName) {
        "use strict";
        var me = this,
            eventSet = me.eventSet,
            evts;

        if (eventSet) {

            evts = eventSet[eventName];

            if (evts) {
                delete eventSet[eventName];
            }
        }

        return me;
    },


    //触发事件
    on: function (eventName, data) {
        "use strict";

        if (this.eventSet) {

            var me = this,
                i,
                evt,
                fun,
                evtData,
                evtSet = me.eventSet,
                evts = evtSet[eventName] || []

            for (i = 0; i < evts.length; i++) {

                evt = evts[i];

                fun = evt.fun;

                if (!fun || !fun.call) {
                    console.log('函数不存在...');
                    console.log(fun);
                    continue;
                }

                if (evt.data) {
                    evtData = Mini2.clone(evt.data);
                }
                else {
                    evtData = {};
                }


                evtData = Mini2.applyIf(evtData, data)

                fun.call(evt.owner || me, me, evtData);

            }

        }


        return this;
    }


});


/************************************************************************/
/*                                           */
/*    ui/panel/Table.js                                                    */
/*                                           */
/************************************************************************/

/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />

/// <reference path="../../Mini.js" />

/// <reference path="../Mini-more.js" />
/// <reference path="../lang/Array.js" />

/// <reference path="template.min.js" />
/// <reference path="EventManager.js" />
/// <reference path="FocusManager.js" />

/// <reference path="grid/column/Column.js" />

/***
 
 var grid = new Mini2.ui.GridBase({
    renderTo : "grid1",
    store : "store1",
    columns: [
    {
        miType: "col",
        width:"120px",
        dbField :"NAME"
    },{
        miType: "col",
        width:"120px",
        dbField :"AGE"
    },{
        miType: "col",
        width:"120px",
        dbField :"LOGIN_NAME"
    }]
 });

 grid.render(); 

 */



Mini2.define('Mini2.ui.panel.Table', {

    extend: 'Mini2.ui.panel.AbstractTable',

    log: Mini2.Logger.getLogger('Mini2.ui.panel.Table',console),  //日志管理器
        

    //范围
    scope:null,


    focusMgr: Mini2.ui.FocusMgr,    //焦点管理器


    scroll:'auto',

    visible: true,

    defaultEditorMode: 'auto',

    //重新设置 div 的宽度。。以后可以取消
    isResetCellWidth: true,

    readOnly: false,

    //行的线
    rowLines: true,

    //列的线
    columnLines: true,

    //显示焦点边框
    focusBorders: true,

    isInit: false,

    columns: [],

    m_Cols: [],    //列集合

    m_ColGroups: null,

    //none, top, full,bottom,left,right
    dock: 'top',


    m_Table: null,
    tbodyEl: null,


    store: false,


    bodyEl: null,

    el: null,

    cellValues: {},

    //选择单元格，自动行打钩
    autoRowCheck: false,


    //新行的索引
    m_NewRowIndex: 0,

    //焦点行
    lastRowFocused: null,
    curRowFocused: null,


    //当前获取焦点的单元格
    m_FocusCell: null,

    //最后获取焦点的单元格
    m_LastCell: null,

    m_LastEditor: null,

    width: '100%',

    height: '600px',

    //标题容器
    headerContainer: null,

    //被选中的记录
    checkedRecords: [],

    //被选中的行元素
    checkedRowEls: [],

    /**
    * 复选框模式。默认多选。
    * @cfg {"SINGLE"/"SIMPLE"/"MULTI"} mode
    */
    checkedMode: 'MULTI',


    /**
    * 行选中的列。全选，反选。。。的列
    */
    rowCheckColumn: null,

    //页面参数配置
    pager: {},


    editor: null,


    //排序开关
    sortable: true,

    //分页控件显示
    pagerVisible: true,

    //分页控件的行数选择框
    hidePagerRowCountSelect: false,


    cellTpl: ['<td role="gridcell" class="mi-grid-cell mi-grid-td ">',
                '<div class="mi-grid-cell-inner">',
    //'<%= value %>',
                '</div>',
             '</td>'],

    //样式模式 'json' | 'css'
    rowStyleType: 'json',

    //样式字段
    rowStyleField: 'ROW_STYLE_JSON',

    //样式激活
    rowStyleEnabled: true,

    //隔行样式.激活
    rowAltEnabled: true,



    //最小高度
    //minHeight: 0,

    //最小宽度
    //minWidth:0,

    //最大高度
    //maxHeight:0,

    //最大宽度
    //maxWidth:0

    //提交的 json 数据模式。 simpe = 简单数据, full=全部数据
    jsonMode: 'simple',

    //单元格双击事件
    cellDbclickEvents: false,


    


    //单元格双击事件
    _cellDbclick: function (fn) {
        "use strict";
        var me = this,
            evts = me.cellDbclickEvents;
                    
        if (Mini2.isFunction(fn)) {

            if (evts == false) {
                me.cellDbclickEvents = evts = [];
            }

            evts.push(fn);
        }        
    },
    

    // 触发单元格双击事件
    onCellDbclick: function (rowEl, cellEl, record) {
        "use strict";
        var me = this,
            i,
            fn,
            evts = me.cellDbclickEvents;

        if (evts) {

            for (i = 0; i < evts.length; i++) {
                fn = evts[i];

                fn.call(me, {
                    rowEl: rowEl,
                    cellEl: cellEl,
                    record: record
                });

            }

        }
    },

    updateLayout: function (owner) {
        var me = this,
            headerContainer = me.headerContainer,
            w,
            h;

        //if (owner.muid) {
        //    w = owner.getWidth();
        //    h = owner.getHeight();
        //}


        headerContainer.resetWidth();

        me.resetBodyWidth();

    },

    createColGroup: function () {
        "use strict";
        /// <summary>创建列组</summary>

        var me = this,
            i = 0,
            col,
            cols = me.m_Cols,
            colHtml = '';

        for (; i < cols.length; i++) {

            col = cols[i];

            colHtml += Mini2.join([
                '<colgroup>',
                    '<col style="width:', col["width"], 'px;"  data-muid="', col.muid, '" />',
                '</colgroup>'
            ]);

        }

        return colHtml;
    },

    renderCell: function (renderEl, column, record, recordIndex, columnIndex, out, rowEl) {
        "use strict";
        var me = this,
            selModel = me.selModel,
            cellValues = me.cellValues,
            value, cellEl, innerEl,
            fieldValue, cellInnerEl,
            dataIndex = column.dataIndex,
            colRenderer = column.renderer,
            colInnerCls = column.innerCls;
        
        fieldValue = record.get(dataIndex);

        cellEl = column.renderCell();

        $(renderEl).append(cellEl);

        innerEl = cellEl.children(":first");

        if (me.isResetCellWidth) {
            innerEl.css('width', (column.width - 2) + 'px');
        }

        if (colRenderer && colRenderer.call) {
            
            try{
                value = colRenderer.call(column,
                    fieldValue,
                    cellValues,
                    cellValues,
                    record,
                    recordIndex,
                    columnIndex,
                    me.store,
                    me,
                    rowEl,
                    cellEl);
            }
            catch (ex) {
                console.error("渲染对象 colRenderer ", colRenderer);
                throw new Error("渲染单元格的值错误, 字段名=" + dataIndex);
            }
        }
        else {
            value = fieldValue;
        }


        cellValues.value = Mini2.isBlank(value)? '&#160;' : value;


        //innerEl.html(cellValues.value + '===========');

        cellEl.addClass(column.tdCls);

        if (Mini2.isFunction(colInnerCls)) {
            $(innerEl).addClass(colInnerCls.call(column));
        }
        else {
            $(innerEl).addClass(colInnerCls);
        }


        //如果数据发生修改，就标记小红点
        if (record.isModified(dataIndex)) {
            cellEl.addClass('mi-grid-dirty-cell');
        }


        if (column.groupRoot) {
            var gIndex = column.groupRoot.groupIndex;
            if (undefined != gIndex && gIndex % 2 == 0) {
                cellEl.addClass('mi-grid-td-group-back');
            }
        }


        if (column.isFirst && columnIndex > 0) {

            var prvCol = me.m_Cols[columnIndex - 1];

            if (prvCol && !prvCol.isLast) {
                cellEl.prev().addClass('mi-grid-td-group-last');
            }
            //cellEl.addClass('mi-grid-td-group-first');
        }

        if (column.isLast) {
            cellEl.addClass('mi-grid-td-group-last');
        }


        cellInnerEl = cellEl.children(".mi-grid-cell-inner");

        if (record.isDisabledForField(dataIndex)) {
            cellInnerEl.html('<hr style="border:none;border-top:1px dashed #b0b0b0;width:90%" />');
        }
        else {
            cellInnerEl.html(value);
        }

        if (column.bindEvent) {
            column.bindEvent.call(column, me, cellEl, recordIndex, columnIndex, null, record, rowEl);
        }

        //创建错误标记
        me.preColumnInvalid(column,cellEl, record);

        return cellEl;
    },

    //创建错误标记
    preColumnInvalid: function (column, cellEl, record) {
        "use strict";
        var me = this,
            log = me.log,
            dataIndex = column.dataIndex;


        try {
            //创建错误标记
            if (record && dataIndex && dataIndex != '') {

                if (record.errors) {
                    column.markInvalid.call(column, record, cellEl, dataIndex);
                }
                else {
                    column.clearInvalid.call(column, record, cellEl, dataIndex);
                }
            }
        }
        catch (ex) {
            log.error("创建错误标记失败. column.markInvalid（....) ");
        }

    },


    renderRow: function (renderEl, record, rowIdx, out) {
        "use strict";
        var me = this,
            log = me.log,
            i = 0,
            rowEl,
            col,
            cellEl,
            cols = me.m_Cols;

        rowEl = $('<tr role="row" class="mi-grid-row  mi-grid-data-row" tabindex="-1" ></tr>');

        $(renderEl).append(rowEl);

        rowEl.data('record', record);
        
        for (; i < cols.length; i++) {
            col = cols[i];

            try {
                cellEl = me.renderCell(rowEl, col, record, rowIdx,i, out, rowEl);
            }
            catch (ex) {
                throw new Error('初始化单元格错误.' + 'miType=' + col.miType + '\r\n' + ex.message);
            }

        }


        if (me.rowStyleEnabled) {
            try {
                me.store_update_setInvalid(rowEl, record);
            }
            catch (ex) {
                log.debug("设置异常提示信息失败.");
            }
        }

        return rowEl;
    },


    renderRows: function (rows, viewStartIndex, out) {

    },




    render_GridBody: function () {
        "use strict";
        var me = this,

            colGroups,
            gridViewEl,
            tableEl,
            tableBodyEl;

        colGroups = me.createColGroup();

        tableBodyEl = Mini2.$join([
            '<div class="mi-panel-body ',
                'mi-grid-body ',
                'mi-panel-body-default ',
                'mi-layout-fit ',
                'mi-panel-body-default ',
                'mi-noborder-rbl" ',
                'style="width:', me.width, '; height: 284px; left: 0px; top: 0px; ">',

                '<div class="mi-grid-view mi-fit-item mi-grid-view-default" ',
                    'style="overflow: auto; margin: 0px; width: ', me.width, '; height: 283px; " tabindex="-1" >',

                '</div>',
            '</div>']);

        tableEl = Mini2.$join([
            '<table class="mi-grid-table" border="0" cellspacing="0" cellpadding="0" >',
                colGroups,
                '<tbody>',
                '</tbldy>',
            '</table>']);

        me.bodyEl = tableBodyEl;
        me.gridViewEl = gridViewEl = tableBodyEl.children(".mi-grid-view:first");


        if (me.rowLines) {
            me.el.addClass("mi-grid-with-row-lines")
        }

        if (me.columnLines) {
            me.el.addClass("mi-grid-with-col-lines");
        }

        if ('auto' != me.scroll) {


            if ('none' == me.scroll) {
                gridViewEl.css('overflow', 'none');
            }

            
        }

        $(me.el).append(me.bodyEl);
        $(gridViewEl).append(tableEl);


        me.m_ColGroups = tableEl.children("colgroup");

        me.m_Table = tableEl;
        me.tbodyEl = tableEl.children("tbody:first");


        $(me.tbodyEl).muBind('contextmenu', function (evt) {
            
            me.showCheckMenu(evt);

            return false;
        });

    },

    



    setSize: function (w, h) {
        "use strict";
        var me = this,
            log = me.log,
            el = me.el,
            bodyEl = me.bodyEl,
            gridViewEl = me.gridViewEl,
            pagerHeight = 0,
            pagerInnerHeight,
            summaryHeight = 0,
            summary = me.summary,
            headerHeight = me.headerContainer.height;

        if (undefined != w) {

            //log.debug('width', w);

            me.width = w;


            var borderLeftWidth = $(el).css('border-left-width');
            var borderRightWidth = $(el).css('border-right-width');
            
            borderLeftWidth = parseInt(borderLeftWidth);
            borderRightWidth = parseInt(borderRightWidth);

            w -= (borderLeftWidth + borderRightWidth);


            el.width(w);
            bodyEl.width(w);
            gridViewEl.width(w);

            //me.headerContainer.setWidth(w);

            if (summary) {
                summary.setWidth(w);
            }

            //log.debug('width=' +  el.width=' + $(el).width() );
        }


        if (undefined != h) {

            h = parseInt(h);

            if (me.minHeight && h < me.minHeight) {
                h = me.minHeight;
            }

            me.height = h;

            var borderTopWidth = $(el).css('border-top-width');
            var borderBottomWidth = $(el).css('border-bottom-width');

            borderTopWidth = parseInt(borderTopWidth);
            borderBottomWidth = parseInt(borderBottomWidth);

            h -= (borderTopWidth + borderBottomWidth);


            pagerHeight = me.getPagetHeight();

            summaryHeight = me.getSummaryHeight();

            pagerInnerHeight = h - headerHeight - 2 - pagerHeight - summaryHeight;

            el.css('height', h);


            bodyEl.css('height', pagerInnerHeight);
            gridViewEl.css('height', pagerInnerHeight);

        }


        return me;
    },

    render_Panel: function () {
        "use strict";
        var me = this,
            el;

        me.el = el = Mini2.$join([
            '<div class="mi-panel mi-panel-default-framed mi-grid" ',
                'style="width: 100%; height: 350px; right: auto; left: 0px; top: 0px;      overflow: hidden;" >',
            '</div>'
        ]);

        el.css({
            width: me.width,
            height: me.height
        });

        if (!me.visible) {  el.hide();  }

        if (me.minHeight) {
            el.css({'min-height': me.minHeight + 'px'});
        }
        

        if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else {
            $(me.renderTo).append(el);
        }

        return el;
    },


    //页点击事件
    pager_click: function (page, store) {
        var me = this;

        store.loadPage(page);

    },


    //创建显示分页控件
    render_Pager: function () {
        "use strict";
        var me = this,
            cfg,
            pager = me.pager,
            pagerVisible = !!me.pagerVisible;

        if ((pager && pager.visible == false) ||
            me.pagerVisible == false) {
            return;
        }


        me.pagerVisible = pagerVisible;

        cfg = Mini2.apply(me.pager, {
            renderTo: me.el,
            store: me.getStore(),
            visible: pagerVisible,
            hideRowCountSelect: me.hidePagerRowCountSelect || false,
            click: me.pager_click
        });

        pager = Mini2.create('Mini2.ui.Pagination', cfg);
        pager.render();

        me.pager = pager;
    },

    //创建概要版面
    render_Summary: function () {
        "use strict";
        var me = this,
            summary;

        if (me.summaryVisible) {
            summary = Mini2.create('Mini2.ui.grid.feature.Summary', {
                renderTo: me.el,
                grid: me,
                store: me.getStore(),
                columns: me.m_Cols
            });

            summary.render();

            me.summary = summary;
        }
    },

    //获取概要面板高度
    getSummaryHeight: function () {
        "use strict";
        var me = this,
            summary = me.summary;

        if (summary && summary.muid) {
            return summary.height;
        }

        return 0;
    },


    //获取页面高度
    getPagetHeight: function () {
        "use strict";
        var me = this,
            pager = me.pager;

        if (!me.pagerVisible) {
            return 0;
        }

        if (pager && pager.muid) {
            return Mini2.SystemInfo.pagination.height || 24;
        }

        return 0;
    },


    //延迟显示
    //private isDelayRender:false,

    //显示延迟
    delayRender: function () {
        "use strict";
        var me = this,
            el = $(me.applyTo);


        Mini2.delayRS = Mini2.delayRS || {};

        Mini2.delayRS[me.applyTo] = me;

        me.isDelayRender = true;

        el.attr('mi-delay-render', 'true');
        el.data('me', me);

        return me;
    },

    //设置表格焦点
    setFocus: function () {
        "use strict";
        var me = this,
             tbodyEl = me.tbodyEl;

        var rowEl = $(tbodyEl).children('.mi-grid-row:first');

        //console.log("row size = " + rowEl.length);
       
        var cellEl = $(rowEl).children(':eq(2)');

        //console.log("cellEl size = " + cellEl.length);


        me.cell_focus(cellEl);
    },


    




    render: function (obj) {
        "use strict";
        var me = this,
            el = null,
            headerContainer,
            width = me.maxWidth || me.width,
            height = me.maxHeight || me.height,
            store = me.store,
            tableCfg = Mini2.SystemInfo.table;

        me.onInit();

        el = me.render_Panel();      //创建主框 div

        me.headerContainer = headerContainer = Mini2.create('Mini2.ui.grid.header.Container', {
            renderTo: el,
            columns: me.columns,
            width: width,
            height: tableCfg.headerHeight,
            rowHeight: tableCfg.rowHeight,
            grid: me
        });



        headerContainer.render();

        headerContainer.columnWidthResize(function (curCol) {
            me.resetBodyWidth(curCol);

            var fr = me.focusedRegion;

            if (fr) {
                me.setFocusRegion(fr.itemA, fr.itemB, true);
            }
            else {
                me.setFocusRegion();
            }
        });

        headerContainer.columnMoved = function (e) {
                        
            //console.log("moved from=%d, to=%d", e.fromIndex, e.toIndex);

            var cols = me.srcColumns;

            Mini2.Array.move(cols, e.fromIndex, e.toIndex);

            me.clearColumnAll();

            me.addColumn(cols);
        };

        me.render_GridBody();   //创建表内容

        me.render_Summary();    //创建底部概要

        me.render_Pager(); //创建分页栏


        me.setSize(width, height);

        me.syncScrollLeft();    //表格头和数据区区域同步滚动

        me.resetBodyWidth();

        if (store && store.isStore) {
            me.bindStore(store);
        }
        else {
            store = me.getStore();
        }

        store.load();


        var parentEl = $(el).parent();
        var parentIsTarget = $(parentEl).hasClass('mi-box-target');

        if (!parentIsTarget) {
            
            $(window).resize(function () {
                var ww = $(parentEl).width();

                //var hh = $(parentEl).height();

                me.setSize(ww,null);
            });
        }

        el.data('me', me);

        try {
            var sec = Mini2.ui.SecManager;
            sec.reg(me.secFunCode, me, 'visible');
            sec.reg(me.secReadonly, me, 'readonly');
        }
        catch (ex) {
            console.error('注册权限错误', ex);
        }

        return me;
    },


    keydownEvent: [],

    setKeydownEvent:function(fun){
        var me = this,
            keydownEvent = me.keydownEvent;

        keydownEvent.push(fun);
    },


    onKeydownEvent: function (e) {
        "use strict";
        var me = this,
            fun,
            keydownEvent = me.keydownEvent || [];

        for (var i = 0; i < keydownEvent.length; i++) {
            fun = keydownEvent[i];
            fun.call(this,e);

        }
    },


    //
    // 处理键盘事件
    // 
    proKeyEvent: function (e) {
        "use strict";
        var me = this,
            log = Mini2.Logger,
            keyCode = e.keyCode,
            rowEl = me.curRowFocused,
            cellEl = me.m_FocusCell,
            editor = me.editor;

        //log.debug("------表格事件 keyCode = " + keyCode + ", me.editor.visible = " + (editor ? editor.visible : 'null') + ", shift=" + e.shiftKey);


        me.onKeydownEvent(e);

        if (e.stoped) {
            return;
        }

        // keyCode: 37-左, 38-上, 39-右, 40-下 , 13-回车

        if (editor && editor.isVisible()) {

            editor.proKeyEvent2(e);
            
            if (e.stoped) {
                return;
            }

            if (Mini2.onwerPage.typeahead.length) {
                return;
            }


            if (9 == keyCode) {    //Tab 键
                editor.hide();
            }
            else if (38 == keyCode || 40 == keyCode) {
                var nextRowEl,
                    nextCellEl;


                if (40 == keyCode) {
                    nextRowEl = $(rowEl).next();
                }
                else if (38 == keyCode) {

                    nextRowEl = $(rowEl).prev();
                }


                if ($(nextRowEl).length > 0) {
                    editor.hide();
                }
                
            }
            else if (37 == keyCode && editor.isFirstCursorPos()) {  //左
                editor.hide();
            }
            else if (39 == keyCode && editor.isLastCursorPos()) {   //右
                editor.hide();
            }
            else {
                editor.onKeydown(e);

                return;
            }
        }


        if (13 == keyCode) {


            var tdIndex = $(cellEl).index();

            var record = $(rowEl).data('record');

            var columnHeader = me.m_Cols[tdIndex];
            var miType = columnHeader.miType;



            if ('rowcheckcolumn' == miType) {
                me.cell_click_rowCheckColumn(cellEl, cellEl, rowEl, record);
                return;
            }
            else if ('actioncolumn' == miType) {
                return;
            }

            //if (me.autoRowCheck && 'SINGLE' == me.checkedMode) {
            //    me.setRowCheck(rowEl, true);
            //}
                        
            if (me.autoRowCheck) {
                me.setRowCheck(rowEl, true);
            }



            //只读状态，不执行后面代码
            if (me.readOnly || (me.store && me.store.readOnly)) {
                return;
            }

            if (record.isLocked && record.isLocked()) {
                return;
            }

            if ('checkcolumn' == miType) {
                me.cell_click_checkColumn(cellEl, cellEl, columnHeader, record);
                return;
            }


            //如果有点击事件，就执行
            if (Mini2.isFunction(columnHeader.click)) {

                var fieldValue = record.get(columnHeader.dataIndex);
                var rowIndex = $(rowEl).index();

                columnHeader.click.call(columnHeader, fieldValue, record, columnHeader,
                    cellEl, rowEl, rowIndex, tdIndex, me.store, me);
            }

            console.debug('column header = ', columnHeader);

            if (columnHeader.readOnly) {

                return;
            }

            //如果没有编辑器模式，就退出
            if (true !== columnHeader.readOnly && columnHeader.editor && 'none' != columnHeader.editorMode) {

                var xtype = columnHeader.editor.xtype;


                if (columnHeader.isPropertyColumn) {
                    //属性的，特殊处理

                    me.cell_click_propertyColumn(cellEl, cellEl, columnHeader, record);


                }

                if (Mini2.ui.grid.CellEditor) {

                    //log.debug('键盘触发，显示编辑框。');

                    var editor = me.getEditor(columnHeader, record);
                    me.showEditor(cellEl, cellEl, rowEl, columnHeader, record, editor);

                    Mini2.EventManager.stopEvent(e);
                }


            }



        }


        if (40 == keyCode || 38 == keyCode) {


            //log.debug("rowEl = " + rowEl);

            var nextRowEl,
                nextCellEl;

            if (40 == keyCode) {
                nextRowEl = $(rowEl).next();
            }
            else if (38 == keyCode) {

                nextRowEl = $(rowEl).prev();
            }


            if ($(nextRowEl).length) {

                $(cellEl).removeClass("mi-grid-cell-selected");

                var index = $(cellEl).index();

                nextCellEl = $(nextRowEl).children(':eq(' + index + ')');

                //log.debug("nextRowEl.len = " + $(nextRowEl).length);
                //log.debug("nextCellEl.len = " + $(nextCellEl).length);

                record = $(nextRowEl).data('record');

                me.store.setCurrent(record);

                me.cell_focus(nextCellEl);


                Mini2.EventManager.stopEvent(e);
            }


            if ($(nextRowEl).length && nextCellEl) {

                var rowEl = nextRowEl,
                    cellEl = nextCellEl;

                var tdIndex = $(cellEl).index();

                var record = $(rowEl).data('record');

                var columnHeader = me.m_Cols[tdIndex];
                var miType = columnHeader.miType;


                if ('rowcheckcolumn' == miType) {
                    me.cell_focus(nextCellEl);
                    Mini2.EventManager.stopEvent(e);
                    return;
                }
                else if ('actioncolumn' == miType) {
                    me.cell_focus(nextCellEl);
                    Mini2.EventManager.stopEvent(e);
                    return;
                }

                //if (me.autoRowCheck && 'SINGLE' == me.checkedMode) {
                //    me.cell_focus(nextCellEl);
                //    Mini2.EventManager.stopEvent(e);
                //}

                // 改为支持多选
                if (me.autoRowCheck ) {
                    me.cell_focus(nextCellEl);
                    Mini2.EventManager.stopEvent(e);
                }

                //只读状态，不执行后面代码
                if (me.readOnly || (me.store && me.store.readOnly)) {
                    me.cell_focus(nextCellEl);
                    Mini2.EventManager.stopEvent(e);
                    return;
                }

                if (record.isLocked && record.isLocked()) {
                    me.cell_focus(nextCellEl);
                    Mini2.EventManager.stopEvent(e);
                    return;
                }

                if ('checkcolumn' == miType) {
                    me.cell_focus(nextCellEl);
                    Mini2.EventManager.stopEvent(e);
                    return;
                }


                    //如果没有编辑器模式，就退出
                if (true !== columnHeader.readOnly && columnHeader.editor && 'none' != columnHeader.editorMode) {

                    var xtype = columnHeader.editor.xtype;

                   

                    if ('text' != xtype && 'numberfield' != xtype) {

                    }
                    else {
                        if (columnHeader.isPropertyColumn) {
                            //属性的，特殊处理

                            me.cell_click_propertyColumn(cellEl, cellEl, columnHeader, record);

                            return;
                        }

                        if (Mini2.ui.grid.CellEditor) {

                            var editor = me.getEditor(columnHeader, record);
                            me.showEditor(cellEl, cellEl, rowEl, columnHeader, record, editor);

                            Mini2.EventManager.stopEvent(e);

                            return;
                        }
                    }

                }
                
                me.cell_focus(nextCellEl);
                Mini2.EventManager.stopEvent(e);
                
            }
        }
        else if (37 == keyCode || 39 == keyCode || 9 == keyCode) {

            var nextCellEl;

            if (37 == keyCode || (9==keyCode && e.shiftKey) ) {
                nextCellEl = $(cellEl).prev();
            }
            else if (39 == keyCode || 9 == keyCode) {
                nextCellEl = $(cellEl).next();
            }


            if ($(nextCellEl).length) {

                $(cellEl).removeClass("mi-grid-cell-selected");

                me.cell_focus(nextCellEl);

                Mini2.EventManager.stopEvent(e);
            }
            else if (39 == keyCode || 9 == keyCode ) { //已经到最后的单元格...自动跳到下一行

                nextRowEl = $(rowEl).next();

                if ($(nextRowEl).length) {

                    $(cellEl).removeClass("mi-grid-cell-selected");

                    var nextCellEl = $(nextRowEl).children(':eq(0)');


                    record = $(nextRowEl).data('record');

                    me.store.setCurrent(record);

                    me.cell_focus(nextCellEl);


                    Mini2.EventManager.stopEvent(e);
                }
            }

        }
        else if ((keyCode >= 65 && keyCode <= 90) || ( keyCode >= 96 && keyCode <= 105 ) ) {

            //var tdIndex = $(cellEl).index();

            //var record = $(rowEl).data('record');

            //var columnHeader = me.m_Cols[tdIndex];
            //var miType = columnHeader.miType;



            ////如果没有编辑器模式，就退出
            //if (columnHeader.editor && 'none' != columnHeader.editorMode) {

            //    var xtype = columnHeader.editor.xtype;

            //    if (columnHeader.isPropertyColumn) {
            //        //属性的，特殊处理

            //        me.cell_click_propertyColumn(cellEl, cellEl, columnHeader, record);

            //    }

            //    if (Mini2.ui.grid.CellEditor) {

            //        var editor = me.getEditor(columnHeader, record);
            //        me.showEditor(cellEl, cellEl, rowEl, columnHeader, record, editor);

            //        Mini2.EventManager.stopEvent(e);

            //        var keycode = e.keyCode;
            //        var realkey = String.fromCharCode(e.keyCode);
                                        
            //        editor.setValue(realkey);
                                       
            //    }


            //}
        }


    },




    setTop: function (t) {
        var me = this,
            el = me.el;

        el.css('top', t);
        return me;
    },

    setLeft: function (l) {
        var me = this,
            el = me.el;

        el.css('left', l);
        return me;
    },

    getTop: function () {
        var me = this,
            el = me.el;

        return el.css('top');
    },

    getLeft: function () {
        var me = this,
            el = me.el;

        return el.css('left');
    },

    setWidth: function (w) {
        var me = this;
        me.setSize(w, undefined);
        return me;
    },

    setHeight: function (h) {
        var me = this;

        me.setSize(undefined, h);
        return me;
    },

    getWidth: function () {
        var me = this,
            el = me.el;

        return el.width();
    },

    getHeight: function () {
        var me = this,
            el = me.el;

        return el.height();
    },

    getSize: function () {
        var me = this,
            el = me.el,
            w = el.width(),
            h = el.height();

        return { width: w, height: h };
    },


    isVisible: function () {
        var me = this,
            el = me.el;

        return el && el.is(':visible');
    },


    syncScrollLeft: function () {
        "use strict";
        /// <summary>同步滚动</summary>

        var me = this,
            gridViewEl = me.gridViewEl;

        $(gridViewEl).mousedown(function (e) {
            //            log.begin('Table.gridViewEl.mouosedown(...)');

            me.focusMgr.setControl(me);

            Mini2.EventManager.clear();

            //log.end();

        });

        gridViewEl.scroll(function (e) {

            var sLeft = $(this).scrollLeft();

            me.headerContainer.scrollLeft(sLeft);

            //me.headerContainer.css('left', -sLeft);

            if (me.summary) {
                me.summary.scrollLeft(sLeft);
            }



        });




        return me;
    },


    //设置每个 td -> div 里面的宽度
    resizeCellWidth: function (curCol) {
        "use strict";
        var me = this,
            i, j,
            cols = me.m_Cols,
            col,
            tdEls,
            tbodyEl = me.tbodyEl,
            rowEls = tbodyEl.children('tr.mi-grid-row'),
            rowEl,
            tdEl, divEl,
            curColIndex = -1;
        
        if (curCol) {
            curColIndex = curCol.index;
        }

        for (i = 0; i < rowEls.length; i++) {

            rowEl = rowEls[i];


            if (curColIndex > -1) {
                col = cols[curColIndex];

                tdEl = $(rowEl).children('td.mi-grid-cell:eq(' + curColIndex + ')');

                divEl = $(tdEl).children('.mi-grid-cell-inner:first');
                $(divEl).css('width', (col.width - 2) + 'px');

                //if (col.visible) {
                //    $(tdEl).show();
                //}
                //else {
                //    $(tdEl).hide();
                //}

            }
            else {
                tdEls = $(rowEl).children('td.mi-grid-cell');

                for (j = 0; j < cols.length; j++) {

                    col = cols[j];
                    tdEl = tdEls[j];

                    divEl = $(tdEl).children('.mi-grid-cell-inner:first');
                    $(divEl).css('width', (col.width - 2) + 'px');


                    //if (col.visible) {
                    //    $(tdEl).show();
                    //}
                    //else {
                    //    $(tdEl).hide();
                    //}
                    
                }
            }
        }

        if (me.summary) {
            me.summary.resizeCellWidth.call(me.summary);
        }

        return me;
    },


    resetBodyWidth: function (curCol) {
        "use strict";
        /// <summary>重新设置单元格宽度</summary>
        var me = this,
            i,
            cols = me.m_Cols,
            col,
            colEl,
            widthAll = 0,
            table, colGroups;

        table = $(me.bodyEl).find(".mi-grid-table:first");

        colGroups = $(table).children("colgroup");

        for (i = 0; i < cols.length; i++) {

            colEl = $(colGroups[i]).children("col");
            col = cols[i];

            if (col.visible) {
                widthAll += col.width;

                colEl.css('width', col.width);

                colEl.show();
            }
            else {
                colEl.hide();
            }


        }


        me.m_Table.css('width', widthAll);

        me.headerContainer.setWidth(widthAll);

        if (me.editor) {

            me.editor.hide();

        }

        //以后可以取消
        if (me.isResetCellWidth) {
            me.resizeCellWidth(curCol);
        }

        return me;
    },


    itemRemoteAll: function () {
        "use strict";
        var me = this,
            rows = $(me.tbodyEl).children();

        $(rows).remove();

        me.m_NewRowIndex = 0;

        me.checkedRecords = [];
        me.checkedRowEls = [];
    },


    itemInsert: function (index, data, outData) {
        "use strict";
        /// <summary>插入记录</summary>
        /// <param name="index" type="int">索引</param>

        var me = this,
            tbodyEl = me.tbodyEl,
            i,
            count,
            record,
            records,
            rowEl,
            rowEls = [],
            rows,
            rowPrv;


        if (outData) {
            outData.rowEls = rowEls;
        }

        rows = $(tbodyEl).children();


        count = rows.length;


        if (index > count) {
            index = count;
        }



        if (Mini2.isArray(data)) {
            records = data;
        }
        else {
            records = [data];
        }


        for (i = 0; i < records.length; i++) {
            record = records[i];
            rowEl = me.renderRow(me.tbodyEl, record, me.m_NewRowIndex);
            rowEls.push(rowEl);
        }



        //$(me.tbodyEl).append(rowEls);

        if (count) {
            if (index == 0) {
                rowPrv = $(rows).eq(0);
                $(rowPrv).before(rowEls);
            }
            else {
                rowPrv = $(rows).eq(index - 1);
                $(rowPrv).after(rowEls);
            }
        }

        me.itemsReset();

        for (i = 0; i < rowEls.length; i++) {
            rowEl = rowEls[i];
            record = records[i];

            me.bindEvent_ForRow(record, rowEl);

            me.bindEvent_ForCell(record, rowEl);
        }


        return me;
    },



    getCellPosition: function (cell) {
        "use strict";
        /// <summary>获取单元格的坐标</summary>
        var me = this,
            officeX = 0,
            officeY = 0,
            left, top,
            row,
            tdIndex,
            pCells,
            pRows;

        tdIndex = cell.index();

        row = cell.parent();

        pCells = $(cell).prevUntil();

        pCells.each(function () {
            if ($(this).is(':visible')) {
                officeX += $(this).outerWidth();
            }
        });

        pRows = row.prevUntil();
        pRows.each(function () {
            if ($(this).is(':visible')) {
                officeY += $(this).outerHeight();
            }
        });


        officeY += me.headerContainer.height;


        left = officeX - me.gridViewEl.scrollLeft();
        top = officeY - me.gridViewEl.scrollTop();


        return { left: left, top: top };
    },

    getCellSize: function (cell) {
        "use strict";
        var w, h;

        w = cell.outerWidth() + 1;
        h = cell.outerHeight();

        return { width: w, height: h };
    },

    setHeaderCheck: function (isChecked) {
        "use strict";
        var me = this;

        me.headerContainer.setHeaderCheck(isChecked);

        return me;
    },


    //设置选中的记录
    setRecordCheck: function (recordId, isCheck) {
        "use strict";
        var me = this,
            rowEl,
            rows,
            record;
        
        rows = $(me.tbodyEl).children();
        
        $(rows).each(function () {

            rowEl = $(this);

            record = rowEl.data('record');

            if (record.getId() == recordId) {
                me.setRowCheck(rowEl, isCheck);

                return false;
            }
        });

        return me;
    },

    //单选
    setRowCheck_ForSingle: function (rowEl, record, col, selectedCls, checkColumnCls, isForceSingle) {
        "use strict";
        var me = this,
            bodyEl,
            rowEls,
            checkedRecord,
            cellEl,
            imgEl;

        if (isForceSingle || 'SINGLE' == me.checkedMode) {

            bodyEl = $(rowEl).parent();

            rowEls = $(bodyEl).children('.' + selectedCls);


            $(rowEls).each(function () {

                rowEl = $(this);

                checkedRecord = rowEl.data('record');

                if (checkedRecord === record) {
                    return;
                }

                cellEl = rowEl.children(":eq(" + col.index + ")");
                imgEl = cellEl.find('img:first');

                rowEl.removeClass(selectedCls);

                $(imgEl).removeClass(checkColumnCls);
            });

            me.checkedRecords.length = 0;
            me.checkedRowEls.length = 0;
        }

        return me;
    },

    /**
     * 设置行选中状态
     * @param isForceSingle = 强制单选..默认=false
     *
     */
    setRowCheck: function (rowEl, isCheck, isForceSingle) {
        "use strict";
        var me = this,
            Array = Mini2.Array,
            col = me.rowCheckColumn,
            cell, imgEl,
            $rowEl = $(rowEl),
            record = $rowEl.data('record'),
            rowCls = 'mi-grid-row',
            selectedCls = rowCls + "-selected",
            checkColumnCls = "mi-grid-checkcolumn-checked";

        if (col != null) {
            
            cell = $rowEl.children(":eq(" + col.index + ")");

            imgEl = cell.find('img:first');

            //单选
            me.setRowCheck_ForSingle(rowEl, record, col, selectedCls, checkColumnCls, isForceSingle);


            $rowEl.toggleClass(selectedCls, isCheck);
            $(imgEl).toggleClass(checkColumnCls, isCheck);

            
            if (isCheck) {
                Array.include(me.checkedRowEls, $rowEl[0]);
                Array.include(me.checkedRecords, record);
            }
            else {
                Array.remove(me.checkedRowEls, $rowEl[0]);
                Array.remove(me.checkedRecords, record);
            }

            col.onSelectChange();

            me.on('rowsChecked', {
                rowEls: me.checkedRowEls,
                records: me.checkedRecords
            });
        }

        return me;
    },



    //全选,全不选
    setRowCheckAll: function (isCheck) {
        "use strict";
        var me = this,
            rowEl,
            rowEls,
            imgEl,
            cell,
            record,
            col = me.rowCheckColumn,

            rowCls = 'mi-grid',
            selectedCls = rowCls + '-row-selected',
            checkedCls = rowCls + '-checkcolumn-checked';

        //console.log('isCheck = ', isCheck);

        // mi-grid-checkcolumn-undefined

        me.setHeaderCheck(isCheck);

        rowEls = $(me.tbodyEl).children();

        me.checkedRecords.length = 0;

        me.checkedRowEls.length = 0;

        $(rowEls).each(function () {
            rowEl = $(this);
            cell = rowEl.children('td:eq(' + col.index + ')');
            record = rowEl.data('record');

            imgEl = cell.find('img.mi-grid-checkcolumn');

            //imgEl.add('mi-grid-checkcolumn-undefined');
            //imgEl.addClass('mi-xxxxxxxxxxxx');

            rowEl.toggleClass(selectedCls, isCheck);
            imgEl.toggleClass(checkedCls, isCheck);

            if (isCheck) {
                me.checkedRecords.push(record);
                me.checkedRowEls.push(this);
            }

        });

        //console.log('长度 = ' ,me.checkedRowEls.length)

        me.on('rowsChecked', {
            rowEls : me.checkedRowEls,
            records: me.checkedRecords
        });

        return me;
    },



    cell_click_rowCheckColumn: function (cell, cellEl, rowEl, record) {
        "use strict";
        var me = this,
            imgEl,
            isChecked;


        me.focusMgr.setControl(cellEl, me, null);

        imgEl = cell.find('img:first');
        isChecked = imgEl.hasClass('mi-grid-checkcolumn-checked');

        me.setRowCheck(rowEl, !isChecked);

        return me;
    },


    cell_click_checkColumn: function (cell, cellEl, columnHeader, record) {
        "use strict";
        var me = this,
            imgEl,
            isChecked,
            checkedCls = 'mi-grid-checkcolumn-checked';

        if (true === columnHeader.readOnly || 'none' == columnHeader.editorMode) {
            return;
        }

        //只读状态下，复选框无效。
        if (!me.readOnly ) {


            me.focusMgr.setControl(cellEl, me, null);

            imgEl = cell.find('img:first');
            imgEl.toggleClass(checkedCls);

            isChecked = $(imgEl).hasClass(checkedCls);
            record.set(columnHeader.dataIndex, isChecked);

        }

        return me;
    },


    //配合"属性控件"的函数
    cell_click_propertyColumn: function (cell, cellEl, columnHeader, record) {
        "use strict";
        var me = this,
            log = me.log,
            type = record.get('Type'), 
            pName = record.get('Name'),
            editXType,
            editorId,
            propEditor;


        switch (type) {
            case 'int': editXType = 'numberfield'; break;
            case 'date': editXType = 'datefield'; break;
            case 'bool': editXType = 'combobox'; break;
            case 'enum': editXType = 'combobox'; break;
            
            default: editXType = 'textfield'; break;
        }


        columnHeader.xtype = editXType;
        
        editorId = ('enum' == type) ? (pName + '_' + editXType) : editXType;

        propEditor = columnHeader.propEditor[editorId];

        if (!propEditor) {
            propEditor = {
                xtype: editXType
            };
            columnHeader.propEditor[editorId] = propEditor;
        }

        if (!propEditor.isInit) {

            switch (type) {
                case 'bool':
                    Mini2.apply(propEditor, {
                        fields: ['value', 'text'],
                        store: [{
                            value: 'true', text: 'true'
                        }, {
                            value: 'false', text: 'false'
                        }]
                    });

                    break;

                case 'enum':

                    var enumStore = [],
                        enumObj = record.get('Extend');
                    

                    if (Mini2.isArray(enumObj)) {
                        for (var i = 0; i < enumObj.length; i++) {
                            var enumValue = enumObj[i];

                            if (Mini2.isString(enumValue)) {
                                enumStore.push({
                                    value: enumValue,
                                    text: enumValue
                                });
                            }
                        }

                    }
                    else {
                        for (var enumName in enumObj) {
                            var enumValue = enumObj[enumName];
                            enumStore.push({
                                value: enumName,
                                text: enumValue
                            });
                        }
                    }

                    Mini2.apply(propEditor, {
                        fields: ['value', 'text'],
                        store: enumStore
                    });

                    break;
            }



        }


        return me;
    },

    //单元格获取焦点
    cell_focus: function( cellEl){
        "use strict";

        var me = this,
            cell,
            rowEl,
            tdIndex,
            record,
            columnHeader,
            miType;

        if (!cellEl) {
            return;
        }

        cell = $(cellEl);

        if (0 == cell.length) {
            return;
        }





        me.curRowFocused = rowEl = cell.parent();
        tdIndex = cell.index();

        record = $(rowEl).data('record');
        columnHeader = me.m_Cols[tdIndex];
        miType = columnHeader.miType;

        me.m_LastCell = me.m_FocusCell;

        if (me.m_LastCell != null) {
            var lastInnerEl = $(me.m_LastCell).children(".mi-grid-cell-inner");
            lastInnerEl.show();
        }

        me.m_FocusCell = cell;


        if ('rowcheckcolumn' == miType) {
            //me.cell_click_rowCheckColumn(cell, cellEl, rowEl, record);

            me.focusMgr.setControl(cellEl, me, null);

            me.autoFocusScroll_2(cellEl);

            return;
        }
        else if ('actioncolumn' == miType) {
            me.focusMgr.setControl(cellEl, me, null);

            me.autoFocusScroll_2(cellEl);

            return;
        }

        //if (me.autoRowCheck && 'SINGLE' == me.checkedMode) {
        //    //me.setRowCheck(rowEl, true);
        //}

        //只读状态，不执行后面代码
        //if (me.readOnly) {
        //    return;
        //}

        //if (record.isLocked && record.isLocked()) {
        //    return;
        //}

        if ('checkcolumn' == miType) {
            //me.cell_click_checkColumn(cell, cellEl, columnHeader, record);

            me.focusMgr.setControl(cellEl, me, null);

            me.autoFocusScroll_2(cellEl);
            return;
        }


        ////如果有点击事件，就执行
        //if (Mini2.isFunction(columnHeader.click)) {

        //    var fieldValue = record.get(columnHeader.dataIndex);
        //    var rowIndex = $(rowEl).index();

        //    //columnHeader.click.call(columnHeader, fieldValue, record, columnHeader,
        //    //    cellEl, rowEl, rowIndex, tdIndex, me.store, me);

        //    me.focusMgr.setControl(cellEl, me, null);
        //}


        //如果没有编辑器模式，就退出
        if (true  === columnHeader.readOnly || !columnHeader.editor || 'none' == columnHeader.editorMode) {
            //log.debug("没有编辑模式.退出");

            me.focusMgr.setControl(cellEl, me, null);

            me.autoFocusScroll_2(cellEl);
            return;
        }


        me.focusMgr.setControl(cellEl, me, null);

        var xtype = columnHeader.editor.xtype;

        if (columnHeader.isPropertyColumn) {
            //属性的，特殊处理

            //me.cell_click_propertyColumn(cell, cellEl, columnHeader, record);

            me.focusMgr.setControl(cellEl, me, null);
            //log.debug("columnHeader.propEditor[" + editXType + "] = " + columnHeader.propEditor[editXType]);

            me.autoFocusScroll_2(cellEl);
        }

        if (Mini2.ui.grid.CellEditor) {

            //var editor = me.getEditor(columnHeader, record);
            //me.showEditor(cell, cellEl, rowEl, columnHeader, record, editor);

            me.focusMgr.setControl(cellEl, me, null);

            me.autoFocusScroll_2(cellEl);
        }
        else {
            //log.debug("异步加载: Mini2.ui.grid.CellEditor ");

            //In('Mini2.ui.grid.CellEditor', function () {
            //    var editor = me.getEditor(columnHeader, record);
            //    me.showEditor(cell, cellEl, rowEl, columnHeader, record, editor);
            //});
        }


        //log.end();

    },

    //单元格双击事件
    cell_dblclick:function(cellEl){

        "use strict";

        var me = this,
            cell,
            rowEl,
            tdIndex,
            record,
            columnHeader,
            miType;

        if (!cellEl) {
            return;
        }

        cell = $(cellEl);

        if (0 == cell.length) {
            return;
        }

        me.curRowFocused = rowEl = cell.parent();
        tdIndex = cell.index();

        record = $(rowEl).data('record');
        columnHeader = me.m_Cols[tdIndex];
        miType = columnHeader.miType;

        me.m_LastCell = me.m_FocusCell;

        if (me.m_LastCell != null) {
            var lastInnerEl = $(me.m_LastCell).children(".mi-grid-cell-inner");
            lastInnerEl.show();
        }

        me.m_FocusCell = cell;


        if ('rowcheckcolumn' == miType) {
            me.cell_click_rowCheckColumn(cell, cellEl, rowEl, record);
            return;
        }
        else if ('actioncolumn' == miType) {
            return;
        }

        //log.debug("zzzzzzzzzzzzzzzz双击事件.");

        
        me.setRowCheck(rowEl, true, true);  //强制单选

        
        me.onCellDbclick();   //触发单元格双击事件

    },

    cell_Click: function (cellEl) {
        "use strict";
        /// <summary>显示单元格</summary>
        /// <param name="cellEl" type="HtmlElement">单元格对象 td</param>

        var me = this,
            cell,
            rowEl,
            tdIndex,
            record,
            columnHeader,
            miType;

        if (!cellEl) {
            return;
        }

        cell = $(cellEl);

        if (0 == cell.length) {
            return;
        }

        me.curRowFocused = rowEl = cell.parent();
        tdIndex = cell.index();

        record = $(rowEl).data('record');
        columnHeader = me.m_Cols[tdIndex];
        miType = columnHeader.miType;

        me.m_LastCell = me.m_FocusCell;

        if (me.m_LastCell != null) {
            var lastInnerEl = $(me.m_LastCell).children(".mi-grid-cell-inner");
            lastInnerEl.show();
        }

        me.m_FocusCell = cell;


        if ('rowcheckcolumn' == miType) {
            me.cell_click_rowCheckColumn(cell, cellEl, rowEl, record);
            return;
        }
        else if ('actioncolumn' == miType) {
            return;
        }

        if (me.autoRowCheck) {
            
            me.setRowCheck(rowEl, true, true);

            //if ('SINGLE' == me.checkedMode) {
            //    me.setRowCheck(rowEl, true);
            //}
            //else {  //鼠标双击事件
            //    //log.debug("准备触发鼠标双击事件.");
            //    //me.setRowCheck(rowEl, true);
            //}
        }



        //只读状态，不执行后面代码
        if (me.readOnly) {
            return;
        }

        var isLockedEx = false;

        //判断整行锁住
        if (record.isLocked && record.isLocked()) {

            if (record.isLockedExclusionField(columnHeader.dataIndex)) {
                isLockedEx = true;
            }
            else {
                return;
            }
        }

        if (!isLockedEx) {

            //数据字段锁住
            if (record.isLockedForField(columnHeader.dataIndex)) {
                return;
            }

            //数据字段锁住
            if (record.isDisabledForField(columnHeader.dataIndex)) {
                return;
            }
        }


        if ('checkcolumn' == miType) {
            me.cell_click_checkColumn(cell, cellEl, columnHeader, record);
            return;
        }


        //如果有点击事件，就执行
        if (Mini2.isFunction(columnHeader.click)) {

            var fieldValue = record.get(columnHeader.dataIndex);
            var rowIndex = $(rowEl).index();

            columnHeader.click.call(columnHeader, fieldValue, record, columnHeader,
                cellEl, rowEl, rowIndex, tdIndex, me.store, me);
        }


        //如果没有编辑器模式，就退出
        if (true === columnHeader.readOnly || !columnHeader.editor || 'none' == columnHeader.editorMode) {
            //log.debug("没有编辑模式.退出");

            me.focusMgr.setControl(cellEl, me, null);

            return;
        }


        var xtype = columnHeader.editor.xtype;

        if (columnHeader.isPropertyColumn) {
            //属性的，特殊处理

            me.cell_click_propertyColumn(cell, cellEl, columnHeader, record);

            //log.debug("columnHeader.propEditor[" + editXType + "] = " + columnHeader.propEditor[editXType]);

        }

        if (Mini2.ui.grid.CellEditor) {

            var editor = me.getEditor(columnHeader, record);
            me.showEditor(cell, cellEl, rowEl, columnHeader, record, editor);

        }
        else {
            //log.debug("异步加载: Mini2.ui.grid.CellEditor ");

            In('Mini2.ui.grid.CellEditor', function () {
                var editor = me.getEditor(columnHeader, record);
                me.showEditor(cell, cellEl, rowEl, columnHeader, record, editor);
            });
        }


        //log.end();
    },



    showEditor: function (cell, cellEl, rowEl, columnHeader, record, editor) {
        "use strict";
        var me = this,
            log = me.log,
            divEl = cell.children(".mi-grid-cell-inner"),
            sz,
            office //偏移量;

        if (!editor) { throw new Error("编辑控件不存在"); }

        //log.debug('显示编辑框');

        if (!editor.isSaveed) {
            editor.isSaveed = true;
        }

        if (columnHeader.innerAutoHide == false) {

        }
        else {
            divEl.hide();
        }

        sz = me.getCellSize(cell);
        office = me.getCellPosition(cell);

        office.left -= 1;
        office.top -= 1;

        sz.height += 2;
        
        
        editor.startEditByPosition(office)
            .setSize(sz)
            .focus()
            .setRowCell(rowEl, cellEl)
            .startEdit(record, columnHeader, {});

        me.editor = editor;

        //log.end();
    },

    /**
     * 隐藏编辑框
     */
    hideEditor:function(){
        var me = this,
            editor = me.editor;

        if (editor) {
            editor.hide();
        }

        return me;
    },

    getEditor: function (col, record) {
        "use strict";
        var me = this,
            xtype,
            config,
            editorObj,
            editor;


        //属性列
        if (col.isPropertyColumn) {

            var propEditor = col.propEditor,

                pName = record.get('Name'),
                pType = record.get('Type'),
                editorId = col.xtype;

            if ('enum' == pType) {
                editorId = pName + '_' + col.xtype;
            }

            editor = propEditor[editorId];

            //log.debug("editorId = " + editorId);

            //如果未初始化，就初始化一下
            if (!editor.isInit) {

                xtype = col.xtype || 'textcolumn';

                config = Mini2.applyIf({
                    grid: me,
                    renderTo: me.el,
                    isInit: true,
                    visible: false,
                    xtype: xtype,
                    placeholder: col.placeholder
                }, editor);


                editorObj = Mini2.create('Mini2.ui.grid.CellEditor', config);
                editorObj.config = editor;

                editorObj.render();

                propEditor[editorId] = editorObj;


            }

            return propEditor[editorId];
        }
        else {

            editor = col.editor;

            //如果未初始化，就初始化一下
            if (editor.isInit == false) {

                xtype = editor.xtype || 'textcolumn';

                //console.debug("col.autoTrim", col.autoTrim);

                config = Mini2.applyIf({
                    grid: me,
                    renderTo: me.el,
                    isInit: true,
                    visible: false,
                    placeholder: col.placeholder,
                    autoTrim: col.autoTrim,
                    column : col
                }, editor);

                //console.log("初始化配置: ", config);

                editorObj = Mini2.create('Mini2.ui.grid.CellEditor', config);
                editorObj.config = editor;

                editorObj.render();

                col.editor = editorObj;


            }

            return col.editor;
        }

    },


    clearSelectAndFocus: function () {
        "use strict";
        var me = this,
            rowCls = "mi-grid-row",
            selectedCls = rowCls + "-selected",
            rows = me.tbodyEl.children("." + selectedCls);

        $(rows).removeClass(selectedCls);
        return me;
    },

    autoFocusScroll_2:function(cellEl){
        "use strict";
        var me = this,
            bodyView = me.gridViewEl,
            cell = $(cellEl);

        if (cell.length) {

            var scrollX = 0,
                scrollY = 0,
                rowEl = cell.parent(),
                tdIndex = cell.index(),
                sz, office, bodyViewWidth, bodyViewHeight, cellR, cellB, sLeft, sTop;

            sz = me.getCellSize(cell);
            office = me.getCellPosition(cell);

            bodyViewWidth = bodyView.width();
            bodyViewHeight = bodyView.height();

            cellR = office.left + sz.width;
            cellB = office.top + sz.height;

            sLeft = bodyView.scrollLeft();
            sTop = bodyView.scrollTop();

            if (cellR > bodyViewWidth - 15) {
                scrollX = cellR - bodyViewWidth + 15;
            }
            else if (office.left < 0) {
                scrollX = office.left - 2;
            }

            if (cellB > (bodyViewHeight + 16 - 2)) {
                scrollY = (cellB - bodyViewHeight - 16 + 2);
            }
            else if (office.top < me.headerContainer.height) {
                scrollY = -(me.headerContainer.height - office.top);
            }


            bodyView.scrollLeft(sLeft + scrollX);
            bodyView.scrollTop(sTop + scrollY);

        }
    },

    //单元格焦点自动滚动
    autoFocusScroll: function (cellEl) {
        "use strict";
        var me = this,
            bodyView = me.gridViewEl,
            cell = $(cellEl);

        if (cell.length) {

            var scrollX = 0,
                scrollY = 0,
                rowEl = cell.parent(),
                tdIndex = cell.index(),
                sz, office, bodyViewWidth, bodyViewHeight, cellR, cellB, sLeft, sTop;

            sz = me.getCellSize(cell);
            office = me.getCellPosition(cell);

            bodyViewWidth = bodyView.width();
            bodyViewHeight = bodyView.height();

            cellR = office.left + sz.width;
            cellB = office.top + sz.height;

            sLeft = bodyView.scrollLeft();
            sTop = bodyView.scrollTop();

            if (cellR > bodyViewWidth - 15) {
                scrollX = cellR - bodyViewWidth + 15;
            }
            else if (office.left < 0) {
                scrollX = office.left - 2;
            }

            if (cellB > (bodyViewHeight + 16 - 2)) {
                scrollY = (cellB - bodyViewHeight - 16 + 2);
            }
            else if (office.top < me.headerContainer.height) {
                scrollY = -(me.headerContainer.height - office.top);
            }


            //        me.bodyEl.scrollLeft(sLeft + scrollX);
            //        me.bodyEl.scrollTop(sTop + scrollY);

            bodyView.scrollLeft(sLeft + scrollX);
            bodyView.scrollTop(sTop + scrollY);

            //$(this).trigger('focusin');


            Mini2.EventManager.setMouseDown(cellEl);


            //        log.begin("autoFocusScroll()");

            Mini2.ui.FocusManager.setControl(cellEl);

            //        if (me.editor && me.editor.visible) {
            //            me.editor.hide();
            //        }

            //        log.end();
        }
    },


    getSelectRange:function(){
        var me = this,
            fr = me.focusedRegion;


        var itemA = fr.itemA || fr.itemB;
        var itemB = fr.itemB || fr.itemA;

        var rowAEl = $(itemA).parent();
        var rowBEl = $(itemB).parent();

        var colAIndex = $(itemA).index();
        var colBIndex = $(itemB).index();

        var rowAIndex = $(rowAEl).index();
        var rowBIndex = $(rowBEl).index();


        var colA = Math.min(colAIndex, colBIndex);
        var colB = Math.max(colAIndex, colBIndex);

        var rowA = Math.min(rowAIndex, rowBIndex);
        var rowB = Math.max(rowAIndex, rowBIndex);

        return {
            colA: colA,
            colB: colB,
            rowA: rowA,
            rowB: rowB
        };
    },


    /**
    * 显示复选框的菜单项目
    *
    */
    showCheckMenu:function(evt){
        var me = this,
            menu = me.menu;
        

        if (!menu) {

            function setCheckCol(checkMode) {
                var fr = me.focusedRegion,
                    store = me.store;

                if (fr && (fr.itemA || fr.itemB)) {

                    var sr = me.getSelectRange();

                    for (var row = sr.rowA; row <= sr.rowB; row++) {

                        var rowEl = me.tbodyEl.children(':eq(' + row + ')');
                        var record = $(rowEl).data('record');

                        for (var col = sr.colA; col <= sr.colB; col++) {

                            var cc = me.m_Cols[col];

                            if ('checkcolumn' != cc.miType) {
                                continue;
                            }

                            if ('reverse' == checkMode) {
                                var srcValue = !!record.get(cc.dataIndex);
                                record.set(cc.dataIndex, !srcValue);
                            }
                            else {
                                record.set(cc.dataIndex, checkMode);
                            }

                        }
                    }

                }


            }

            me.menu = menu = Mini2.create('Mini2.ui.menu.Menu', {

                left: evt.pageX,
                top: evt.pageY,

                items: [{
                    text: '全选',

                    click: function () {
                        setCheckCol(true);
                    }

                }, {
                    text: '反选',
                    click: function () {
                        setCheckCol('reverse');
                    }
                }, {
                    text: '全不选',

                    click: function () {
                        setCheckCol(false);
                    }
                }]

            });

            menu.render();

        }
        else {
            menu.setLocal(evt.pageX, evt.pageY).show();
        }

    },
    
                
    getSeelctCellText:function() {

        var me = this,
            fr = me.focusedRegion,
            store = me.store,
            txt = '';

        if (fr && (fr.itemA || fr.itemB)) {

            var sr = me.getSelectRange();

            var rowIndex = 0;

            for (var row = sr.rowA; row <= sr.rowB; row++) {

                if (rowIndex++ > 0) {
                    txt += '\n';
                }

                var rowEl = me.tbodyEl.children(':eq(' + row + ')');
                var record = $(rowEl).data('record');

                var colIndex = 0;

                for (var col = sr.colA; col <= sr.colB; col++) {

                    var cc = me.m_Cols[col];

                    var srcValue = record.get(cc.dataIndex);

                    if (colIndex++ > 0) {
                        txt += '\t';
                    }

                    txt += srcValue;

                }

            }

        }

        return txt;
    },





    //显示焦点边界
    showFocusBorder:function(cellEl){
        var me = this,
            el = me.el,
            $focusEl = me.$focusEl;

        if (me.focusBorders) {

            if (!$focusEl) {

                $focusEl = Mini2.$joinStr([
                    '<div class="mi-grid-cell-focused" >',
                        '<div class="mi-focused-backdrop"></div>',

                        '<div class="mi-focused-border mi-focused-border-left"></div>',
                        '<div class="mi-focused-border mi-focused-border-top"></div>',
                        '<div class="mi-focused-border mi-focused-border-right"></div>',
                        '<div class="mi-focused-border mi-focused-border-bottom"></div>',

                        '<div class="mi-focused-handle"></div>',
                    '</div>']);  //焦点面板

               
                me.gridViewEl.append($focusEl);

                me.$focusEl = $focusEl;

                var $focusHandleEl = $focusEl.children('.mi-focused-handle');
                var $focusBorderEls = $focusEl.children('.mi-focused-border');

                $focusHandleEl.muBind('mousedown', function () {

                }).muBind('mouseup', function () {

                });

                $focusBorderEls.muBind('mousedown', function () {

                }).muBind('mouseup', function () {

                }).muBind('contextmenu', function (evt) {

                    me.showCheckMenu(evt);

                    return false;
                });
            }

            me.setFocusRegion(cellEl);

        }

        return me;
    },

    //隐藏焦点边界框
    hideFocusBorder:function(cellEl){
        var me = this,
            el = me.el,
            $focusEl = me.$focusEl;
        
        if (me.focusBorders) {
            var cellEl = $focusEl.data('cellEl');

            if (cellEl === this) {
                $focusEl.hide();
            }
        }

        return me;
    },


    cell_mouse_button : null,


    /**
    * 焦点区域
    * @private focusedRegion
    */
    //focusedRegion:{
    //    itemA: null,
    //    itemB:null
    //},

    /**
    * 设置焦点区域框
    * @param {Object} startCellEl 起始单元格 Dom
    * @param {Object} endCellEl 结束单元格 Dom
    */
    setFocusRegion: function (startCellEl, endCellEl, force) {
        "use strict";

        var me = this,
            log = me.log,
            $focusEl = me.$focusEl,
            viewEl = me.gridViewEl,
            itemA = startCellEl,
            itemB = endCellEl,
            lastRegion = me.focusedRegion,
            aLocal,bLocal,
            x0, y0, x1, y1;

        if (true != force) {
            //如果全没有参数, 就隐藏
            if (!startCellEl && !endCellEl) {

                if ($focusEl) {
                    $focusEl.hide();
                }

                return;
            }

            if (lastRegion && lastRegion.itemA == itemA && lastRegion.itemB == itemB) {
                return;
            }
        }
        
        if ($focusEl) {
            me.focusedRegion = {
                itemA: itemA,
                itemB: itemB
            };



            var pOffset = viewEl.offset();

            var scrollTop = viewEl.scrollTop();
            var scrollLeft = viewEl.scrollLeft();

            //console.log("scrollTop = %d, scrollLeft = %d", scrollTop, scrollLeft);

            aLocal = $(itemA).offset();


            pOffset.left -= scrollLeft;
            pOffset.top -= scrollTop;

            if (itemA && itemB && itemA != itemB) {

                bLocal = $(itemB).offset();

                x0 = Math.min(aLocal.left, bLocal.left);
                y0 = Math.min(aLocal.top, bLocal.top);

                x1 = Math.max(aLocal.left + $(itemA).width(), bLocal.left + $(itemB).width());
                y1 = Math.max(aLocal.top + $(itemA).height(), bLocal.top + $(itemB).height());

            }
            else {
                x0 = aLocal.left;
                y0 = aLocal.top;

                x1 = aLocal.left + $(itemA).width();
                y1 = aLocal.top + $(itemA).height();
            }

            x0 -= pOffset.left;
            y0 -= pOffset.top;

            x1 -= pOffset.left;
            y1 -= pOffset.top;



            $focusEl.css({
                left: x0 - 2,
                top: y0 - 2,
                width: x1 - x0 + 4,
                height: y1 - y0 + 4
            }).show();
        }

        // 如果自动选中启动
        if (me.autoRowCheck && itemB) {

            var rowEl_A = $(itemA).parent();
            var rowEl_B = $(itemB).parent();

            var aIndex = $(rowEl_A).index();
            var bIndex = $(rowEl_B).index();


            var tmp1 = Math.min(aIndex, bIndex);
            var tmp2 = Math.max(aIndex, bIndex);

            var tbodyEl = me.tbodyEl;

            
            var i = 0;

            var checkCol = me.rowCheckColumn;

            tbodyEl.children().each(function () {

                var cell = $(this).children(":eq(" + checkCol.index + ")");

                var imgEl = cell.find('img:first');
                
                if (i >= tmp1 && i <= tmp2) {
                    if (imgEl.hasClass('mi-grid-checkcolumn-checked')) {

                    }
                    else {
                        me.setRowCheck(this, true);
                    }
                }
                else {
                    if (imgEl.hasClass('mi-grid-checkcolumn-checked')) {
                        me.setRowCheck(this, false);
                    }
                    else {
                        //me.setRowCheck(rowEl, true);
                    }
                }

                i++;

            });

            
        }

        return me;
    },

    /**
    * 扩展事件
    **/
    extendCellEvent: function (cellEl) {
        "use strict";
        /// <summary>扩展事件</summary>

        var me = this,
            log = me.log;



        $(cellEl).on('focusin',function () {
            $(this).addClass("mi-grid-cell-selected");

            me.showFocusBorder(this);
        })
        .on('focusout',function () {
            $(this).removeClass("mi-grid-cell-selected");

            me.hideFocusBorder(this);
        });

        $(cellEl).muBind('mousedown', function (evt,srcEvt) {
            //log.begin("cell.MouseDown()");

            me.cell_mouse_button = evt.button;

            //log.debug("鼠标单击下啊....", evt);
            
            if (me.cell_mouse_button == 0) {
                me.autoFocusScroll(this);
            }

            //log.end();

        }).muBind('mousemove',function(evt,srcEvt){
            
            if (me.cell_mouse_button == 0) {

                var hoverEl = srcEvt.target;    //鼠标所在的元素上方
                
                if (!$(hoverEl).hasClass('mi-grid-cell')) {
                    var cellEl = $(hoverEl).parents('.mi-grid-cell');
                    hoverEl = cellEl[0];
                }

                if (hoverEl != null && this !== hoverEl) {

                    if ($(hoverEl).hasClass('mi-grid-cell-row-numberer') ) {
                        return;
                    }

                    me.setFocusRegion(this, hoverEl);
                }

               // console.debug("hoverObject = ", hoverObject);

            }


        }).muBind('mouseup', function (evt,srcEvt) {

            //log.begin("cell.MouseUp()");

            //console.log("mouserup = ", this);

            var cellEl;
            
            if ($(srcEvt.target).hasClass('mi-grid-cell')) {
                cellEl = srcEvt.target;
            }
            else {
                cellEl = $(srcEvt.target).parents('.mi-grid-cell');

                cellEl = cellEl[0];
            }



            if (me.cell_mouse_button == 0 && this === cellEl) {



                var rowEl, record;

                rowEl = $(this).parent();
                record = $(rowEl).data('record');

                me.store.setCurrent(record);

                me.cell_Click(this);

            }

            me.cell_mouse_button = null;

            //log.end();
        }).on('dblclick',function(e) {

            //log.debug("双击啊.....");

            //me.store.setCurrent(record);
            
            me.cell_dblclick(this);
        });


        //$(cellEl).muBind('keydown', function (e, exData) {

        //    var keyCode = event.keyCode;


        //    if (keyCode == 9) {

        //        var grid = exData.data,
        //            nextCellEl = $(this).next();


        //        if (nextCellEl.length >= 1) {

        //            grid.autoFocusScroll(nextCellEl);

        //            grid.cell_Click(nextCellEl);

        //            grid.m_FocusCell = nextCellEl;

        //            Mini2.EventManager.stopEvent(e);
        //        }
        //    }

        //});


        return me;
    },

    bindEvent_ForCell: function (record, rowEl) {
        "use strict";
        /// <summary>绑定事件到单元格</summary>

        var me = this,
            tdList = $(rowEl).children('td');

        $(tdList).each(function () {
            me.extendCellEvent(this);
        });
    },


    bindEvent_ForRow: function (record, rowEl) {
        "use strict";
        /// <summary>记录绑定事件</summary>
        var me = this,
            rowCls = 'mi-grid-row',
            overCls = rowCls + '-over';

        $(rowEl).mouseenter(function (e) {
            $(this).addClass(overCls);
        })
        .mouseleave(function (e) {
            $(this).removeClass(overCls);
        });

    },

    //按类型获取列集合
    getColumnByType: function (miType) {
        "use strict";
        var me = this,
            col,
            i = 0,
            colArray = [],
            cols = me.m_Cols,
            len = cols.length;

        for (; i < len; i++) {
            col = cols[i];

            if (col.miType.toLowerCase() == miType) {
                colArray.push(col);
            }
        }

        return colArray;
    },


    //刷新纪录后，触发的事件
    //itemReseted: false,



    //刷新纪录
    itemsReset: function () {
        "use strict";
        /// <summary>刷新记录</summary>
        var me = this,
            log = me.log,
            rowNumbererColumn = null,
            rows,
            rowNumbererCols,
            rowIndex = 0,
            itemReseted = me.itemReseted,   //刷新纪录后，触发的事件
            rowAltEnabled = me.rowAltEnabled,
            altCls = 'mi-grid-row-alt',
            locledCls = 'mi-grid-locked-row';

        rows = $(me.tbodyEl).children('.mi-grid-row');

        rowNumbererCols = me.getColumnByType('rownumberer');

        $(rows).each(function () {
            var rowEl = $(this),
                record,
                isLocked,
                i = rowNumbererCols.length;

            if (rowAltEnabled) {
                rowEl.toggleClass(altCls, !(rowIndex % 2));
            }

            if (i) {
                record = rowEl.data('record');
                isLocked = record.isLocked();

                rowEl.toggleClass(locledCls, isLocked);

                while (i--) {
                    me.afterCellUpdate(rowNumbererCols[i], this, record, rowIndex);
                }
            }

            if (itemReseted) {
                try {
                    itemReseted.call(me, {
                        rowEl: rowEl,
                        rowIndex: rowIndex,
                        record: record
                    });
                }
                catch (ex) {
                    log.debug('调用刷新记录错误.');
                }
            }

            rowIndex++;
        });

        me.m_NewRowIndex = rowIndex;
    },


    //填充明细列的信息,也就是最底层的列
    fullDetailCols: function (detailCols, parentCol, cols, dept) {
        "use strict";
        var me = this,
            i,j,
            col,
            colLen = (cols?cols.length:0) ,
            config;

        dept = dept || 1;

        if (colLen) {
            
            //计算标题行数
            for (i = 0; i < colLen; i++) {
                config = cols[i];
                col = me.getColumnForConfig(config);

                col.groupRoot = col.groupRoot || parentCol; //根组
                col.parent = parentCol; //上级


                cols[i] = col;

                if (config.columns ) {
                    me.fullDetailCols(detailCols,col, col.columns, dept + 1);
                }
                else {
                    detailCols.push(col);
                }


                if (dept > 1) {
                    col.isSub = true;
                }
            }

            if (dept > 1) {
                cols[0].isFirst = true;

                cols[colLen - 1].isLast = true;
            }

            if (dept == 1) {

                j = 0;

                for (i = 0; i < colLen; i++) {
                    col = cols[i];
                    if (col.columns) {
                        col.groupIndex = j++;
                    }
                    else {
                        j = 0;
                    }
                }
            }
        }

        return detailCols.length;
    },

    onInit: function () {
        "use strict";
        var me = this,
            index = 0,
            i,
            store = me.store,
            col,
            cols;


        if (me.isInit) {
            return;
        }

        me.isInit = true;

        me.checkedRecords = [];

        //被选中的行元素
        me.checkedRowEls = [];

        if (me.cellDbclick) {
            
            me._cellDbclick(me.cellDbclick);
            
            delete me.cellDbclick;
        }

        me.cellDbclick = me._cellDbclick;
        
        delete me._cellDbclick;


        if (Mini2.isString(store)) {

            store = Mini2.data.StoreManager.lookup(store);

            me.bindStore(store);
        }

        me.srcColumns = Mini2.clone(me.columns);   //用户添加进来的列对象

        delete me.m_Cols;
        me.m_Cols = cols = [];

        me.fullDetailCols(cols, null, me.columns);

        for (i = 0; i < cols.length; i++) {
            col = cols[i];
            col.index = i;
        }

        me.cellTpl = me.StrJoin(me.cellTpl);


        //重新绑定到事件集上面
        if (me.rowsChecked) {

            var fun = me.rowsChecked;
            
            me.bind('rowsChecked', fun);

            delete me.rowsChecked;
        }
    },

    //根据列标签，获取列对象的命名空间
    getColumnNameForMiType: function (miType) {
        "use strict";
        var colName = 'Mini2.ui.grid.column.';

        switch (miType) {
            case 'booleancolumn':
            case 'boolcolumn': colName += 'Boolean'; break;
            case 'checkcolumn': colName += 'CheckColumn'; break;
            case 'rownumberer': colName += 'RowNumberer'; break;
            case 'rowcheckcolumn': colName += 'RowCheckColumn'; break;
            case 'numbercolumn': colName += 'Number'; break;
            case 'datecolumn': colName += 'Date'; break;
            case 'actioncolumn': colName += 'Action'; break;
            case 'propertycolumn': colName += 'PropertyColumn'; break;
            case 'treecolumn': colName += 'TreeColumn'; break;
            case 'template': colName += 'Template'; break;
            case 'textareacolumn': colName += 'TextArea'; break;
            case 'morefilecolumn': colName += 'MoreFileColumn'; break;
            case 'timecolumn': colName += 'Time'; break;
            case 'passwordcolumn': colName += 'Password'; break;
            default: colName += 'Colunm'; break;
        }

        return colName;
    },

    getColumnForConfig: function (colConfig) {
        "use strict";
        var me = this,
            sysInfoTab = Mini2.SystemInfo.table,
            miType,
            col,
            cols = me.m_Cols,
            colEditor,
            colName;

        //var col = this;
        
        Mini2.applyIf(colConfig, {
            miType:'col',
            width: 120,
            headerAlign: sysInfoTab.headerAlign
        });
;
        colConfig.width = colConfig.width * sysInfoTab.headerWidthRaed;


        miType = colConfig.miType = colConfig.miType.toLowerCase();
        colName = me.getColumnNameForMiType(miType);


        col = Mini2.create(colName, colConfig);

        switch (miType) {
            case 'rowcheckcolumn': me.rowCheckColumn = col; break;
        }

        col.grid = me;
        col.store = me.getStore();

        colEditor = col.editor;

        if (colEditor) {
            colEditor.isInit = false;
        }

        //如果存在数据仓库
        if (colEditor.store) {
            var newData, newStore;

            newData = Mini2.clone(col.editor.store);

            newStore = Mini2.create('Mini2.data.Store', {
                storeId: 'MiniStore_' + Mini2.newId(),
                idField: 'value',
                fields: ['value', 'text'],
                data: newData
            });

            col.displayStore = newStore;

            colEditor.store = newStore;
        }

        if (!col.renderer) {

        }

        //col.index = index;

        //cols.push(col);

        return col;
    },

    //设置只读状态
    setReadOnly: function (value) {
        var me = this;

        me.readOnly = value;

        return me;
    },


    clearColumnEditor: function (col) {
        var me = this,
            editor = col.editor;

        if (editor) {
            if (editor.remove) {
                editor.remove();

                delete col.editor;
            }
        }
    },


    //清理掉全部列
    clearColumnAll: function () {
        "use strict";
        var me = this,
            col,
            cols = me.m_Cols,
            len = cols.length,
            i,
            delayData = me.delayData,
            header = me.headerContainer;

        delayData.i = Number.MAX_VALUE;

        me.setFocusRegion();

        me.itemRemoteAll();

        me.m_LastEditor = null;
        for (i = 0; i < len; i++) {
            col = cols[i];           
            me.clearColumnEditor(col);
        }

        header.clear();

        return me;
    },

    //添加列
    addColumn: function (columns) {
        "use strict";
        var me = this,
            i,
            colGroupEl,
            cg,
            delayData = me.delayData,
            header = me.headerContainer,
            col,
            cols ;



        delete me.m_Cols;
        me.m_Cols = cols = [];

        me.srcColumns = Mini2.clone(columns);   //用户添加进来的列对象

        //console.debug("me.srcColumns", me.srcColumns);

        me.columns = columns;

        me.fullDetailCols(cols, null, me.columns);

        for (i = 0; i < cols.length; i++) {
            col = cols[i];
            col.index = i;
        }


        header.add(columns);


        $(me.m_ColGroups).remove();

        cg = me.createColGroup();

        me.m_ColGroups = $(cg);

        me.tbodyEl.before(me.m_ColGroups);

        me.setHeight(me.height);


        //处理加载数据
        delayData.i = 0;

        me.loopLoadItem();


        if (me.summaryVisible) {

            me.summary.columns = cols;

            try {
                me.summary.reset();
            }
            catch (ex) {
                console.error("重置合计 html 错误", ex);
            }
        }


        return me;
    },

    getJsonForRecord: function (record) {
        "use strict";
        var me = this,
            i;

        var recObj = {
            action: "none",
            id: record.getId(),
            clientId: record.muid,
            index: 0,
            values: {}
        };


        if (record.dirty) {
            recObj.action = 'modified';
        }

        recObj.values = Mini2.clone(record.data);

        return recObj;
    },


    //触发命令提交函数
    onCommand: function (cmdName, cmdParam, record) {
        "use strict";
        var me = this,
            recordObj,
            recordJson;
        
        if ( 'full' == me.jsonMode) {
            recordObj = me.getJsonForRecord(record);  //整个实体提交命令太大,无法一次性提交
        }
        else {
            recordObj = {
                action: "none",
                id: record.getId(),
                clientId: record.muid,
                index: 0,
                values: {}
            };
        }

        recordJson = Mini2.Json.toJson(recordObj);

        var refKey = 'record-' + Mini2.Guid.newGuid();
        var refData = {};

        refData[refKey] = recordJson;


        widget1.subMethod('form:first', {
            subName: me.id,
            subMethod: 'PreCommand',
            actionPs: {
                cmdName: cmdName,
                cmdParam: cmdParam,
                record: 'ref ' + refKey
            },
            data: refData
        });


    },

    /**
     * 获取选中的记录.加工过的
     */
    getCheckeds: function (fields) {
        "use strict";

        var me = this,
            col = me.rowCheckColumn,
            records = [];


        if (!col) {
            return records;
        }


        var rowEl, record, cell, imgEl, isCheck,
            rows = $(me.tbodyEl).children();


        $(rows).each(function () {
            rowEl = $(this);

            record = rowEl.data('record');
            cell = rowEl.children("td:eq(" + col.index + ")");
            imgEl = cell.find('img:first');

            isCheck = $(imgEl).hasClass("mi-grid-checkcolumn-checked");

            if (isCheck) {

                if (fields) {

                    var cloneRect = {};

                    $(fields).each(function () {
                        cloneRect[this] = record.get(this);
                    });

                    records.push(cloneRect);

                }
                else {
                    records.push(Mini2.clone(record.data));
                }


            }
        });

        return records;

    },


    /**
    * 获取选中都记录
    */
    getCheckRecords:function(jsonMode){
        "use strict";

        var me = this,
            col = me.rowCheckColumn,
            checkObj = {
                records: []
            };


        if (!col) {
            return checkObj;
        }

        jsonMode = jsonMode || me.jsonMode;

        var rowEl, record, cell, imgEl, isCheck,
            rows = $(me.tbodyEl).children();


        $(rows).each(function () {
            rowEl = $(this);

            record = rowEl.data('record');
            cell = rowEl.children("td:eq(" + col.index + ")");
            imgEl = cell.find('img:first');

            isCheck = $(imgEl).hasClass("mi-grid-checkcolumn-checked");

            if (isCheck) {

                var recObj = {
                    action: 'none',
                    id: record.getId(),
                    clientId: record.muid,
                    index: rowEl.index()
                };

                if (record.dirty) {
                    recObj.action = 'modified';
                }

                if (!recObj.id) {
                    recObj.action = 'added';
                    recObj.values = Mini2.clone(record.data);
                }
                else if ('full' == jsonMode) {
                    recObj.values = Mini2.clone(record.data);
                }


                checkObj.records.push(recObj);
            }
        });

        return checkObj;
    },


    //
    // jsonMode = sipmle-简单类型 | full-全部类型;
    getJson: function (jsonMode) {
        "use strict";
        var me = this,
            json,
            checkObj;

        checkObj = me.getCheckRecords(jsonMode);

        json = Mini2.Json.toJson(checkObj);

        return json;
    }
}, function () {

    var me = this,
        cfg = Mini2.SystemInfo.table,
        ps = arguments[0];

    Mini2.apply(this, {
        columnLines: cfg.columnLines,
        focusBorders: cfg.focusBorders
    });

    Mini2.apply(this, ps);

});


/************************************************************************/
/*                                           */
/*    ui/panel/AbstractDataView.js                                         */
/*                                           */
/************************************************************************/


/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />

Mini2.define("Mini2.ui.panel.AbstractDataView", {

    log: Mini2.Logger,  //日志管理器


    extend: 'Mini2.ui.Component',


    renderTo: Mini2.getBody(),

    getStore: function () {
        "use strict";
        var me = this,
            newStore;

        if (!me.store) {
            newStore = Mini2.create('Mini2.data.Store', {
                storeId: "MiniStore_" + Mini2.newId(),
                model: 'Mini2.data.FreeModel',
                data : me.data
            });

            me.bindStore(newStore);
        }

        return me.store;

    },

    bindStore: function (store) {
        "use strict";
        var me = this;


        me.store = store;

        $(store)
            .muBind('update', me, me.store_update)              //监听记录更新事件
            .muBind('add', me, me.store_add)                    //监听记录添加事件
            .muBind('datachanged', me, me.store_dataChanged)    //监听数据更改
            .muBind('refresh', me, me.store_refresh)            //监听刷新事件
            .muBind('load', me, me.store_load)                  //加载事件
            .muBind('bulkremove', me, me.store_bulkRemove)      //左上角标记移除事件
            .muBind('invalid', me, me.store_invalid)            //出现异常的单元格
            .muBind('clear', me, me.store_clear)                //删除全部记录事件
            .muBind('currentchanged', me, me.store_currentChanged)  //焦点行发生改变的事件
            .muBind('beginloaded',me, me.store_beginloaded)
            .muBind('endloaded', me,me.store_endloaded); //数据加载完后, 触发的事件

        me.resetEmptyMsg();
    },


    /**
     * 根据记录获取行TR
     * @param {object} record 记录
     * @param {string} findTag .查找标记  first=只找第一个
     */
    getItemBoxForRecord: function (record, findTag) {
        "use strict";
        var me = this,
            boxList = [],
            itemlistEl = me.itemlistEl,
            rowRecord,
            onlyFirst = ('first' === findTag),
            rowEl,
            rowsEls = itemlistEl.children(".mi-dataview-item");

        $(rowsEls).each(function () {
            rowEl = this;
            rowRecord = $(rowEl).data("record")

            if (rowRecord === record) {
                boxList.push(rowEl);

                if (onlyFirst) { return false; }
            }

        });

        return boxList;
    },



    store_invalid: function (event, record, fieldNames) {
        "use strict";

        console.debug("store_invalid");
    },


    /**
     * 第一次焦点行
     */
    firstStoreCurrentChanged: true,

    store_currentChanged: function (event, index, record) {
        "use strict";
        var me = event.data,
            itemBox ;

        if (!record) {
            
            if (!me.readonly) {
                me.setFocusItem(null);
            }

            return;
        }

        itemBox = me.getItemBoxForRecord(record);

        if (me.firstStoreCurrentChanged && 'none' != me.checkedMode && itemBox.length) {
            
            me.firstStoreCurrentChanged = false;
            me.itemSelect(itemBox[0]);
        }

        if (!me.readonly) {

            me.setFocusItem(itemBox);
        }

    },

    store_clear: function (event) {
        "use strict";
        var me = event.data;

        me.firstStoreCurrentChanged = true;

        me.itemRemoteAll();

        me.resetEmptyMsg();
    },



    //删除记录
    store_bulkRemove: function (event, allRecords, indexes, isMove) {
        "use strict";

        console.debug("store_bulkRemove");

        var me = event.data,
            boxTarget = me.boxTarget,
            Array = Mini2.Array,
            exist,
            record,
            row,
            //checkedRecords = me.checkedRecords,
            rows = boxTarget.children(".mi-dataview-item");


        $(rows).each(function () {
            row = this;
            record = $(row).data("record");

            exist = Array.contains(allRecords, record);

            if (exist) {
                $(row).remove();
                //Array.remove(checkedRecords, record);
                //return false;
            }

        });

        me.resetItmesIndex();

        me.resetEmptyMsg();
    },




    

    store_update: function (event, record, operation, modifiedFieldNames) {
        "use strict";
        var me = event.data;


        //alert(record.isModel + "   " + operation + " " + modifiedFieldNames);


        if ('EDIT' == operation) {

            var fields = modifiedFieldNames;
            var len = fields.length;

            var newId;

            var boxEl = me.getItemBoxForRecord(record, 'first');

            boxEl = $(boxEl);

            var items = me.getBindItems(boxEl);

            $(items).each(function () {

                var item = this;

                if (Mini2.Array.contains(fields, item.dataField, true)) {

                    var value = record.get(item.dataField);


                    item.setDirty(false);

                    if (item.oldValue != value) {
                        item.oldValue = item.getValue();

                        item.setValue(value);
                    }


                }


            });



            //boxEl.html('');
            
            //var itemInnerStr = me.renderItemInner(0, record);
            
            //boxEl.append(itemInnerStr);

            //var cmdEls = boxEl.find('*[command],a[target]');

            //if (cmdEls.length) {
            //    cmdEls.muBind('click', function () {
            //        return me.item_command(this, boxEl);
            //    });
            //}
        }

    },



    store_refresh: function (event, store) {
       

        console.debug("store_refresh");
    },


    //延迟显示的数据
    delayData: {

    },

    
    //循环加载
    loopLoadItem: function () {
        "use strict";
        var me = this,
            i, n,
            initCount = 20, //初始时候默认加载20条
            record,

            delayData = me.delayData;


        if (delayData.i >= delayData.len) {
            return;
        }
        
        i = delayData.i;

        if (i < initCount) {
            n = delayData.len;

            if (n > initCount) { n = initCount; }

            for (i = 0; i < n; i++) {
                delayData.i++;

                record = delayData.items.get(i);

                me.itemInsert(i, record);
            }
        }
        else {
            delayData.i++;

            record = delayData.items.get(i);

            me.itemInsert(i, record);
        }

        setTimeout(function () {
            me.loopLoadItem();
        }, 1);

    },

    store_load: function (event, store) {
        var me = event.data,
            store = this,
            i,
            record,
            records = store.data,
            len;

        
        if (store.isIncr) {

            var recrods = store.curLoadData;

            me.itemInsert(i, recrods);

        }
        else {

            me.itemRemoteAll();

            len = records.length;

            me.delayData = {
                i: 0,
                len: len,
                items: records
            };

            me.loopLoadItem();
        }

        me.resetEmptyMsg();
    },


    /**
    * 特殊标记
    */
    __lastTimeStamp: null,

    store_dataChanged: function (event, ex) {
        "use strict";        
        var me = event.data,
            store = this;
        
        if (me.__lastTimeStamp === event.timeStamp) {
            return;
        }

        me.__lastTimeStamp = event.timeStamp;

        console.debug("发生变哈流....");

        me.resetEmptyMsg();
    },

    store_add: function (event, index, out) {
        "use strict";
       
        var me = event.data,
            i;


        console.debug("添加记录.....", out[i]);

        for (i = 0; i < out.length; i++) {
            me.itemInsert(index + i, out[i]);
        }

        me.resetEmptyMsg();
    },

    store_beginloaded:function(event,ex){
        var me = event.data;


        me.isLoading = true;

    },

    store_endloaded: function (event, ex) {

        var me = event.data;

        me.isLoading = false;
        
        console.debug(" $(itemlistEl).length = ", $(me.itemlistEl).children().length);

        me.resetEmptyMsg();
    }

});


/************************************************************************/
/*                                           */
/*    ui/panel/DataView.js                                                 */
/*                                           */
/************************************************************************/


/**
* 数据列, 作为卡片的方式显示
*/
Mini2.define('Mini2.ui.panel.DataView', {

    extend: 'Mini2.ui.panel.AbstractDataView',

    baseCls: 'mi-dataview',

    readonly: false,

    /**
     * 项目集合容器
     */
    itemlistEl: null,

    /**
     * 空记录显示的元素
     */
    emptyEl: null,

    /**
     * 加载更多按钮
     */
    laoderBtnEl: null,

    /**
     * 加载更多的容器
     */
    laoderEl: null,

    visible: true,

    /**
    * 模板引擎名称
    */
    engineName: 'j',

    //none, top, full,bottom,left,right
    dock: 'top',

    userCls:null,

    region: 'north',

    selectCls: 'mi-dataview-item-selected',
    focusCls: 'mi-dataview-item-focused',

    itemDefaultCls: 'mi-dataview-item-default',

    itemNotBorderCls: 'mi-dataview-item-notborder',

    /**
     * 隐藏 item 的边框
     */
    itemBorderHide: false,

    jsonMode: 'simple',

    /**
    * 新项目的索引
    */
    newItemIndex: 0,

    /**
    * 显示的模板代码
    */
    renderTpl: [
        '<div role="Panel" class="mi-dataview " style="">',
            '<div class="mi-box-inner " role="presentation" style="">',
                '<div class="mi-box-target" style="width: 100%;padding-right: 0px; position:static; ">',

                    '<div class="mi-dataview-itemlist" style="; width:100%; position:static;display: inline-block;" >',

                    '</div>',

                    '<div class="mi-dataview-empty" >',
                        '没有相关记录!',
                    '</div>',


                    '<div class="mi-box-loader" style="width:100%;height:100px;padding:6px;text-align: center; position:static;">',
                        '<a class="mi-btn mi-btn-loaders" style="width:90%;display:none;">加载更多...</a>',
                    '</div>',
                    
                '</div>',

            '</div>',



        '</div>'
    ],

    padding: {
        left: 0,
        top: 0,
        right: 0,
        bottom: 0
    },

    ui: 'default',

    /**
    * 子项目框模板
    */
    itemBoxTpl: ['<div role="dataview-item" class="mi-dataview-item " style=" "></div>'],



    //范围
    scope: null,

    scroll: 'auto',


    visible: true,


    isInit: false,



    store: false,


    /**
    * 复选框模式。默认多选。
    * @cfg { "single" | "multi"} mode
    */
    checkedMode: 'multi',


    /**
    * 项目模板
    */
    itemTemplate: false,

    /**
    * 编辑的模板
    */
    editItemTemplate: false,


    //页面参数配置
    pager: {},

    //分页控件显示
    pagerVisible: true,

    //分页控件的行数选择框
    hidePagerRowCountSelect: false,

    /**
    * 概要版面
    */
    summaryVisible: false,

    /**
    * 被选中的项目集合
    */
    selectedItems: null,

    /**
    * 焦点项目 
    */
    focusItem: null,


    onInit: function () {
        var me = this,
            store = me.store,
            isFun = Mini2.isFunction;


        if (isFun(me.itemAdded)) {
            me.bind('itemAdded', me.itemAdded);
        }

        if (isFun(me.itemRender)) {
            me.bind('itemRender', me.itemRender);
        }

        if (isFun(me.itemRendering)) {
            me.bind('itemRendering', me.itemRendering);
        }

        if (isFun(me.itemRendered)) {
            me.bind('itemRendered', me.itemRendered);
        }

        if (isFun(me.itemRenderScript)) {
            me.bind('itemRenderScript', me.itemRenderScript);
        }


    },

    isVisible: function () {
        return this.visible;
    },




    getWidth: function () {
        return this.el.outerWidth();
    },

    getHeight: function () {
        return this.el.outerHeight();
    },

    getSize: function () {
        var me = this;
        return { 'width': me.getWidth(), 'height': me.getHeight() };
    },

    setLeft: function (value) {
        var me = this,
            el = me.el;

        el.css('left', value);

        return me;
    },
    getLeft: function () {
        var me = this,
            el = me.el;

        return el.css('left');
    },

    getTop: function () {
        var me = this,
            el = me.el;

        return el.css('top');
    },
    setTop: function (value) {
        var me = this,
            el = me.el;

        el.css('top', value);

        return me;
    },

    setHeight: function (value) {
        var me = this;

        me.setSize(undefined, value);

        return me;
    },

    setWidth: function (value) {
        var me = this;

        me.setSize(value);

        return me;

    },

    setSize: function (w, h, callEvent) {
        "use strict";

        var me = this,
            log = me.log,
            el = me.el,
            minHeight = me.minHeight,
            boxInner = me.boxInner,
            boxTarget = me.boxTarget,
            padding = me.padding,
            allValue = 0;

        if (minHeight && h && h < minHeight) {
            h = minHeight;
        }

        me.targetWidth = w || me.width;     //预计达到宽度
        me.targetHeight = h || me.height;   //预计达到高度


        me.width = me.targetWidth || me.width;
        me.height = me.targetHeight || me.height;


        if (el) {

            if (me.autoSize) {

            }
            else {
                var boxW = me.width - (padding.right + padding.left);
                var boxH = me.height - (padding.bottom + padding.top) - me.getPagetHeight();

                el.css({ 'width': me.width, 'height': me.height });
                boxInner.css({ 'width': '100%', 'height': boxH });
                boxTarget.css({ 'width': boxW, 'height': boxH });
            }
        }

        me.resize();


        return me;
    },


    resize: function () {

    },


    dymResult: null,



    /**
     * 监控加载
     */
    targetEl_scroll: function (targetEl) {
        var me = this,
            laoderBtnEl = me.laoderBtnEl,
            itemlistEl = me.itemlistEl;



        var tarTop = $(targetEl).scrollTop();
        var tarHeight = $(targetEl).height();

        var itemlistBoxHeight = $(itemlistEl).outerHeight();


        console.debug('tarTop=%d, tarHeight=%d, itemlistBoxHeight=%d ', tarTop, tarHeight, itemlistBoxHeight);


        if (tarHeight + tarTop > itemlistBoxHeight) {

            if (me.store.isLastPage()) {

            }
            else {
                if (!laoderBtnEl.is(':visible')) {

                    laoderBtnEl.show();

                    setTimeout(function () {

                        me.loadNextData();

                    }, 500);

                }
            }
        }


    },

    /**
     * 加载状态, 加载中...
     */ 
    isLoading: false,

    //加载下一页数据
    loadNextData: function () {
        var me = this,
            laoderBtnEl = me.laoderBtnEl;


        laoderBtnEl.hide();

        if (!me.dymResult) {
            me.dymResult = {};
        }


        var result = me.dymResult;

        me.store.nextPage(result);


    },



    scrollTime: null,

    baseRender: function () {
        "use strict";
        var me = this,
            log = me.log,
            el,
            padding = me.padding,
            boxInner,
            boxTarget,
            w = me.width,
            h = me.height;


        me.el = el = Mini2.$join(me.renderTpl);
        me.boxInner = boxInner = el.cFirst('.mi-box-inner');
        me.boxTarget = boxTarget = boxInner.cFirst('.mi-box-target');

        me.itemlistEl = boxTarget.children('.mi-dataview-itemlist');

        me.emptyEl = boxTarget.children('.mi-dataview-empty');

        me.laoderEl = boxTarget.children('.mi-box-loader');


        me.laoderBtnEl = me.laoderEl.children('.mi-btn-loaders');


        if ('none' == me.scroll) {
            me.laoderEl.hide();
        }
        else {
            me.laoderBtnEl.on('click', function () {

                me.loadNextData();

            });



            $(boxTarget).scroll(function (e) {

                var scrollTime = me.scrollTime;

                if (scrollTime) {
                    scrollTime.resetStart();
                }
                else {
                    me.scrollTime = Mini2.setTimer(function () {

                        me.log.debug('DataView isLoading = ', me.isLoading);

                        if (me.isLoading) {

                            Mini2.EventManager.stopEvent(e);
                            return false;
                        }

                        me.targetEl_scroll(boxTarget);

                    }, [100, 1])
                }
            });
        }

        me.render_Summary();

        me.render_Pager();

        el.mouseup(function () {
            Mini2.ui.FocusMgr.setControl(me);
        });


        if (me.itemBorderHide) {
            boxTarget.addClass(me.itemNotBorderCls);
        }

        if (me.visible == false) {
            el.hide();
            delete me.visible;
        }

        if (me.onResize) {
            me.resize(me.onResize);
        }

        el.data('me', me);

        el.addCls(me.baseCls, 'mi-box-layout-ct');

        if (me.ui) {
            el.addCls(me.baseCls + '-' + me.ui);
        }


        if ('default' != me.dock) {

            if ('none' != me.dock) {
                el.addCls('mi-docked',
                    'mi-docked-' + me.dock,
                    me.baseCls + '-docked',
                    me.baseCls + '-docked-' + me.dock);

                if (me.ui) {
                    el.addCls(me.baseCls + '-' + me.ui + '-docked-' + me.dock);
                }
            }
        }




        if (me.fixed) {
            el.addClass('mi-fixed-layer');
            el.css('z-index', 1009);
        }

        //auot, none = 没有滚动条, vertical = 垂直滚动条,Horizontal = 水平滚动条
        switch (me.scroll) {
            case 'none': boxTarget.css({ 'overflow': 'hide' }); break;
            case 'vertical': boxTarget.css({ 'overflow-x': 'hidden', 'overflow-y': 'auto' }); break;
            case 'horizontal': boxTarget.css({ 'overflow-x': 'auto', 'overflow-y': 'hidden' }); break;
            default: boxTarget.css({ 'overflow': 'auto' }); break;
        }



        var attrList = [
            'left', 'top', 'right', 'bottom',
            'width', 'height', 'position'
        ];

        var cssPs = {};



        for (var i = 0; i < attrList.length; i++) {
            var attrName = attrList[i];

            if (me[attrName]) {
                cssPs[attrName] = me[attrName];
            }
        }


        for (var i in padding) {
            var attrName = 'padding-' + i;

            cssPs[attrName] = padding[i];
        }

        if (me.maxWidth) {
            el.css({ 'max-width': me.maxWidth });
            boxTarget.css({ 'max-width': me.maxWidth });
        }

        if (me.minWidth) {
            el.css({ 'min-width': me.minWidth });
            boxTarget.css({ 'min-width': me.minWidth });
        }

        if (me.maxHeight) {
            el.css({ 'max-height': me.maxHeight });
            boxTarget.css({ 'max-height': me.maxHeight });
        }

        if (me.minHeight) {
            el.css({ 'max-height': me.minHeight });
            boxTarget.css({ 'max-height': me.minHeight });
        }


        if (me.margin) {
            el.css({ 'margin': me.margin });
        }

        if (me.marginLeft) {
            el.css({ 'margin-left': me.marginLeft });
        }

        if (me.marginRight) {
            el.css({ 'margin-right': me.marginRight });
        }

        if (me.marginTop) {
            el.css({ 'margin-top': me.marginTop });
        }

        if (me.marginBottom) {
            el.css({ 'margin-bottom': me.marginBottom });
        }

        el.css(cssPs);


        if (me.right) {

        }

        if (me.autoSize) {
            boxTarget.css({
                position: 'static',
                height: 'auto'
            });
        }
        else {

            //el.css({ width: w });

            //boxInner.css({ width: w, height: h });

            //boxTarget.css({ width: w, height: h });

            var boxW = me.width - (padding.right + padding.left);
            var boxH = me.height - (padding.bottom + padding.top) - me.getPagetHeight();

            el.css({ 'width': me.width, 'height': me.height });
            boxInner.css({ 'width': '100%', 'height': boxH });
            boxTarget.css({ 'width': boxW, 'height': boxH });
        }


        if (me.userCls) {
            el.addClass(me.userCls);
        }



        if (me.contentEl) {

            var contentEl = $(me.contentEl);
            var items = contentEl.children();

            contentEl.after(el);

            boxTarget.append(items);

            el.attr('id', contentEl.attr('id'));

            contentEl.remove();
        }
        else if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else if (me.renderTo) {
            $(me.renderTo).append(el);
        }

    },




    //创建显示分页控件
    render_Pager: function () {
        "use strict";
        var me = this,
            cfg,
            pager = me.pager,
            pagerVisible = !!me.pagerVisible;

        if ((pager && pager.visible == false) ||
            me.pagerVisible == false) {
            return;
        }


        console.debug("table.hidePagerRowCountSelect = ", me.hidePagerRowCountSelect);

        me.pagerVisible = pagerVisible;

        cfg = Mini2.apply(me.pager, {
            renderTo: me.el,
            store: me.getStore(),
            visible: pagerVisible,
            hideRowCountSelect: me.hidePagerRowCountSelect || false,
            click: me.pager_click
        });

        pager = Mini2.create('Mini2.ui.Pagination', cfg);
        pager.render();

        me.pager = pager;
    },

    //页点击事件
    pager_click: function (page, store) {
        var me = this;

        store.loadPage(page);

    },


    //创建概要版面
    render_Summary: function () {
        "use strict";
        var me = this,
            summary;

        if (me.summaryVisible) {

        }
    },

    //获取概要面板高度
    getSummaryHeight: function () {
        "use strict";
        var me = this,
            summary = me.summary;

        if (summary && summary.muid) {
            return summary.height;
        }

        return 0;
    },


    //获取页面高度
    getPagetHeight: function () {
        "use strict";
        var me = this,
            pager = me.pager;

        if (!me.pagerVisible) {
            return 0;
        }

        if (pager && pager.muid) {
            return Mini2.SystemInfo.pagination.height || 24;
        }

        return 0;
    },





    /**
    * 渲染 Item
    */
    renderItemInner: function (index, dataItem) {
        "use strict";
        var me = this,
            valueStr,
            rendererFn;


        rendererFn = me.renderer_j;


        try {
            valueStr = rendererFn.call(me, index, dataItem);

        }
        catch (ex) {
            console.error("输出错误 ", ex);

            return '';
        }

        return valueStr;
    },

    renderItemList: function () {
        "use strict";
        var me = this,
            len,
            store = me.getStore(),
            records;


        if (store) {
            records = store.data;

            if (!records) {
                return;
            }

            me.itemRemoteAll();

            len = records.length;

            me.delayData = {
                i: 0,
                len: len,
                items: records
            };

            me.loopLoadItem();

        }
        else {
            records = me.data;

            me.itemInsert(0, records);
        }
        
    },

    /**
    * 单选项
    */
    itemSelect_single: function (dataviewItem, check) {
        var me = this,
            selectCls = me.selectCls,
            itemEl = $(dataviewItem);
        
        $(me.selectedItems).removeClass(selectCls);
        
        if (check) {
            $(dataviewItem).toggleClass(selectCls, true);

            if (Mini2.isArray(dataviewItem)) {
                me.selectedItems = dataviewItem;
            }
            else {
                me.selectedItems = [dataviewItem];
            }
        }
        else {
            me.selectedItems = [];
        }
   },

    /**
    * 多选
    */
    itemSelect_multi: function (dataviewItem, check) {
        var me = this,
            itemEl = $(dataviewItem);


        if (check) {
            Mini2.Array.include(me.selectedItems, dataviewItem);
        }
        else {
            Mini2.Array.remove(me.selectedItems, dataviewItem);
        }
    },


    /**
    * 设置焦点项目
    */
    setFocusItem: function (dataviewItem) {
        "use strict";
        var me = this,
            lastItemEl,
            cancel = false,
            focusCls = me.focusCls,
            isFocus,
            focusItem = me.focusItem,
            itemEl = $(dataviewItem);

        lastItemEl = me.focusItem;
        

        isFocus = itemEl.hasClass(focusCls);

        if (focusItem && dataviewItem !== focusItem) {
            $(focusItem).removeClass(focusCls);
        }

        me.focusItem = dataviewItem;
        itemEl.addClass(focusCls);

        me.trigger('itemFocused', {
            'old': lastItemEl ,
            'item' : dataviewItem
        });

    },

    itemSelect: function (dataviewItem) {
        var me = this,
            itemEl = $(dataviewItem),
            check = false,
            selectCls = me.selectCls,
            focusCls = me.focusCls,
            checkedMode = me.checkedMode;

        check = itemEl.hasClass(selectCls);

        check = !check;


        $(itemEl).toggleClass(selectCls, check);

        console.debug("itemSelect = ", itemEl);

        console.debug("checkedMode = ", checkedMode);

        if ('single' == checkedMode) {
            me.itemSelect_single(dataviewItem, check);
        }
        else if ('multi' == checkedMode) {
            me.itemSelect_multi(dataviewItem, check);
        }
    },


    renderer_j: function (index, record) {
        "use strict";
        var me = this,
            jTemp = me.jTemplate;

        if (!jTemp) {

            jTemp = me.jTemplate = $.createTemplate(me.itemTemplate);
        }

        if ('free' == record.fieldModeId) {
            record = record.raw;
        }

        return jTemp.get(record, {
            index: index,
        });

    },


    /**
    * 删除全部项目
    */
    itemRemoteAll: function () {
        "use strict";
        var me = this,
            itemlistEl = me.itemlistEl,
            //targetEl = me.boxTarget,
            rows = $(itemlistEl).children('.mi-dataview-item');

        $(rows).remove();

        me.selectedItems = [];
        me.focusItem = null;

    },

    /**
     * 重置所有项目 的 索引号
     */
    resetItmesIndex: function () {

    },


    /**
    * 渲染 item box
    */
    renderItemBox: function (newId, record) {
        var me = this,
            boxEl = $(me.itemBoxTpl);

        boxEl.attr('data-muid', newId);

        boxEl.css({
            width: me.itemWidth,
            height: me.itemHeight
        });

        boxEl.data('record', record);

        boxEl.addClass(me.itemDefaultCls);


        if (me.itemCls) {
            boxEl.addClass(me.itemCls);
        }

        return boxEl;
    },



    /**
    * artTemplate 腾信模板引擎
    */
    rendererHref_art: function (item, record) {
        "use strict";
        var me = this,
            valueStr,
            artTemp = item.data('artTemplate');

        if (!artTemp) {
            artTemp = template.compile(item.attr('href'));
            item.data('artTemplate', artTemp);
        }

        valueStr = artTemp({
            T: record
        });

        return valueStr;
    },

    item_command: function (sender, boxEl) {
        "use strict";
        var me = this,
            itemEl = $(sender),

            record,
            cmd,
            cmdParam;

        record = boxEl.data('record');



        cmd = itemEl.attr('command');

        if (!Mini2.isBlank(cmd)) {
            cmdParam = itemEl.attr('commandParam');


            me.onCommand(cmd, cmdParam, record);
        }
        else {

            var target = itemEl.attr('target');
            var href = itemEl.attr('href')

            var rendererHref = this.rendererHref_art;


            try {
                href = rendererHref.call(this, itemEl, record);
            }
            catch (ex) {
                console.error('地址模板解析处理失败,', itemEl);
                return;
            }

            target = target.toLowerCase();

            if (Mini2.isBlank(target)) {

                window.location.href = href;

            }
            else if ('ecview' == target) {

                EcView.show(href, itemEl.attr('targetText'));

                return false;
            }
            else if ('dialog' == target) {

                var frm = Mini2.createTop('widget.window', {
                    url: href,
                    text: itemEl.attr('targetText'),
                    width: 400,
                    height: 300,
                    mode: true,
                    state: 'max'
                });

                frm.show();

                return false;
            }
            else {

                console.debug('未知标识', target);

            }

        }
    },


    /**
     * 重置空消息
     */
    resetEmptyMsg: function () {
        var me = this,
            store = me.store,
            emptyEl = me.emptyEl;

        if (store.data.length) {
            emptyEl.hide();
        }
        else {
            emptyEl.show();
        }

    },


    /**
    * 插入记录
    */
    itemInsert: function (index, data, outData) {
        "use strict";
        var me = this,
            itemlistEl = me.itemlistEl,
            //targetEl = me.boxTarget,
            i,
            newId,
            itemInnerStr,
            count,
            record,
            records,
            cmdEls,
            rowEls = [],
            rows;


        if (outData) {
            outData.rowEls = rowEls;
        }

        rows = $(itemlistEl).children();

        count = rows.length;


        if (index > count) {
            index = count;
        }

        if (Mini2.isArray(data)) {
            records = data;
        }
        else {
            records = [data];
        }

        if (0 === records.length) {
            return;
        }

        for (i = 0; i < records.length; i++) {
            record = records[i];
            //rowEl = me.renderRow(me.tbodyEl, record, me.newItemIndex);


            newId = Mini2.newId();

            itemInnerStr = me.renderItemInner(i, record);

            var boxEl = me.renderItemBox(newId, record);

            boxEl.append(itemInnerStr);


            //
            rowEls.push(boxEl);


            cmdEls = boxEl.find('*[command],a[target]');

            if (cmdEls.length) {
                cmdEls.muBind('click', function () {
                    return me.item_command(this, boxEl);
                });
            }

        }

        itemlistEl.append(rowEls);

        $(rowEls).each(function () {

            var itemEl = this,
                cancel,
                record = $(itemEl).data('record');

            cancel = me.trigger('itemRendering', {
                cancel : false,
                itemEl: this,
                record : record
            });

            if (true === cancel) { return; }

            //触发 itemRender 事件
            cancel = me.trigger('itemRender', {
                itemEl: itemEl,
                record : record
            });

            if (true === cancel) { return; }

            cancel = me.trigger('itemRenderScript', {

                itemEl: itemEl,
                record: record

            });

            cancel = me.trigger('itemRendered', {
                itemEl: itemEl,
                record : record
            });

            //触发 itemAdded 添加成功事件
            cancel = me.trigger('itemAdded', {
                itemEl: itemEl,
                record: record
            });

            me.itemAfterRender(itemEl, record);

        });

        me.resetItmesIndex();



        if (!me.readonly) {
            $(rowEls).each(function () {

                $(this).muBind('click', function () {
                    var dvItem = this,
                        store = me.store;


                    if ('none' != me.checkedMode) {
                        me.itemSelect(dvItem);
                    }

                    if (store) {

                        var record = $(dvItem).data('record');

                        if (record) {
                            store.setCurrent(record);
                        }
                    }
                    else {
                        me.setFocusItem(dvItem);
                    }

                });

            });
        }



        //for (i = 0; i < rowEls.length; i++) {
        //    rowEl = rowEls[i];
        //    record = records[i];

        //    me.bindEvent_ForRow(record, rowEl);

        //    me.bindEvent_ForCell(record, rowEl);
        //}


        return me;
    },


    getJsonForRecord: function (record) {
        "use strict";
        var me = this,
            i;

        var recObj = {
            action: "none",
            id: record.getId(),
            clientId: record.muid,
            index: 0,
            values: {}
        };


        if (record.dirty) {
            recObj.action = 'modified';
        }

        recObj.values = Mini2.clone(record.data);

        return recObj;
    },

    //触发命令提交函数
    onCommand: function (cmdName, cmdParam, record) {
        "use strict";
        var me = this,
            recordObj,
            recordJson;

        if ('full' == me.jsonMode) {
            recordObj = me.getJsonForRecord(record);  //整个实体提交命令太大,无法一次性提交
        }
        else {
            recordObj = {
                action: "none",
                id: record.getId(),
                clientId: record.muid,
                index: 0,
                values: {}
            };
        }

        recordJson = Mini2.Json.toJson(recordObj);


        var dataName = this.id + "-" + Mini2.Guid.newGuid('N');

        var actionPs = {
            cmdName: cmdName,
            cmdParam: cmdParam,
            record: 'ref ' + dataName
        };

        var data = {};

        data[dataName] = recordJson;

        widget1.subMethod('form:first', {
            subName: me.id,
            subMethod: 'PreCommand',
            actionPs: actionPs,
            data: data
        });

    },



    //
    // jsonMode = sapmle-简单类型 | full-全部类型;
    getJson: function (jsonMode) {
        "use strict";
        var me = this,
            itemlistEl = me.itemlistEl,
            json,
            checkObj = {
                records: []
            };


        jsonMode = jsonMode || me.jsonMode;

        var rowEl, record, cell, imgEl, isCheck,
            rows = $(itemlistEl).children('.' + me.selectCls);


        $(rows).each(function () {
            rowEl = $(this);

            record = rowEl.data('record');

            var recObj = {
                action: 'none',
                id: record.getId(),
                clientId: record.muid,
                index: rowEl.index()
            };

            if (record.dirty) {
                recObj.action = 'modified';
            }

            if (!recObj.id) {
                recObj.action = 'added';
                recObj.values = Mini2.clone(record.data);
            }
            else if ('full' == jsonMode) {
                recObj.values = Mini2.clone(record.data);
            }


            checkObj.records.push(recObj);

        });

        json = JSON.stringify(checkObj);


        return json;
    },

    render: function () {
        var me = this,
            store = me.store;

        if (Mini2.isArray(me.itemTemplate)) {
            me.itemTemplate = Mini2.join(me.itemTemplate);
        }


        me.onInit();


        me.selectedItems = [];

        me.baseRender();



        me.itemBoxTpl = Mini2.join(me.itemBoxTpl);


        if (Mini2.isString(store)) {

            store = Mini2.data.StoreManager.lookup(store);

            me.store = store;
        }


        if (store && store.isStore) {
            me.bindStore(store);
        }
        else {
            store = me.getStore();
        }

        me.renderItemList();


        $(me.el).data('me', me);

        try {
            Mini2.ui.SecManager.reg(me.secFunCode, me);
        }
        catch (ex) {
            console.error('注册权限错误', ex);
        }

        return me;

    },



    itemAfterRender: function (parentEl,record) {
        var me = this,
            item,
            items,
            len,
            i;

        items = me.getBindItems(parentEl);
        len = items.length;



        for (i = 0; i < len; i++) {
            item = items[i];

            //item.store = me.store;
            //item.record = record;


            if (item.setRecord) {
                item.setRecord(record);
            }
            else {
                item.record = record;
            }

            //item.oldValue = record[item.dataField];

            $(item).muBind('focusout', function () {

                me.itemWidget_focusout.call(me, this);
            });


            //如果是复选框, 就特殊处理,一旦值发生变化,直接触发事件
            if (item.isCheckbox || item.isCheckGroup) {

                $(item).muBind('changed', function () {

                    me.itemWidget_changed.call(me, this);
                });

            }

            //先记录一下控件的原始状态
            if (item.getReadOnly()) {
                item.allowChangeReadonly = false;
            }

        }

    },

    itemWidget_focusout:function(sender){
        var me = this,
            item = sender,
            value,
            field = item.dataField,
            record = item.record;

        if (item.readOnly || !item.isValueChanged()) {

            return me;
        }


        if (item.isRangeControl) {

            if (item.startDataField && item.isValueChanged('start')) {

                var value = item.getStartValue();

                item.setDirty(true);
                record.set(item.startDataField, value);
            }

            if (item.endDataField && item.isValueChanged('end')) {

                var value = item.getEndValue();

                item.setDirty(true);
                record.set(item.endDataField, value);
            }

        }
        else {

            if (item.isValueChanged()) {
                var value = item.getValue();

                item.setDirty(true);
                record.set(field, value);
            }
        }


    },

    itemWidget_changed:function(sender){
        var me = this,
            item = sender,
            value,
            field = item.dataField,
            record = item.record;

        value = item.getValue();
            
        item.setDirty(true);
        record.set(field, value);

    },


    /**
     * 查找所有 Mini2 控件
     * @param {domEl} parentEl 上级html节点
     * @param {Array} list 搜索到的集合 
     */
    findItems: function (parentEl, list) {
        var me = this;

        if (!list) {
            list = [];
        }

        var childItems = $(parentEl).children();

        $(childItems).each(function () {
            var childEl = this;

            var data = $(childEl).data('me');

            if (data) {
                list.push(childEl);
                //return false;
            }
            else {
                me.findItems(childEl, list);
            }

        });

        return list;
    },

    /**
     * 获取需要绑定的项目
     */
    getBindItems: function (parentEl) {
        var me = this,
            store = me.store,
            items,
            len,
            i = 0,
            dbItems = [];


        //items = me.prepareItems(items);

        items = me.findItems(parentEl);


        len = items.length;


        for (i = 0; i < len; i++) {
            var item = items[i];

            item = me.getItemObj(item);

            if (!item) {
                continue;
            }


            if (item.isRangeControl) {

                if (item.startDataField || item.endDataField) {
                    dbItems.push(item);
                }

            }
            else if (item.dataField) {
                dbItems.push(item);;
            }


        }

        return dbItems;
    },


    prepareItems_ForFlow: function (items) {
        var me = this,
            preItems = [];


        return items;
    },

    prepareItems_ForTable: function (items) {
        var me = this,
            preItems = [];



        return items;
    },

    getItemObj: function (obj) {
        var itemObj;
        if (obj.muid) {
            itemObj = obj;
        }
        else {
            itemObj = $(obj).data('me');
        }
        return itemObj;
    },

    prepareItems: function (items) {
        "use strict";

        var me = this,
            i,
            item,
            itemMi,
            itemEl,
            flowDirection = me.flowDirection,
            layout = me.layout,
            preItems = [];



        $(items).each(function () {
            item = this;
            itemMi = me.getItemObj(item);

            if (itemMi) {

                itemMi.ownerParent = me;

                itemEl = itemMi.el;

                if (itemMi.isVisible && !itemMi.isVisible()) {
                    return;
                }

                preItems.push(itemMi);


                if ('lefttoright' == flowDirection) {

                    itemEl.addClass('mi-form-item-float-left');
                }

                itemEl.addClass('mi-anchor-form-item'); //增加表单底部锚点

                //对子项注入新的样式
                if (layout && layout.itemCls) {
                    itemEl.addClass(layout.itemCls);
                }

                if (me.itemWidth && itemMi.setWidth) {

                    if (itemMi.width == '100%') {

                        if (itemMi.colspan) {
                            itemMi.setWidth(me.itemWidth * itemMi.colspan);
                        }
                        else {
                            itemMi.setWidth(me.itemWidth);
                        }
                    }
                }

                if (itemMi.labelable) {

                    if (me.itemLabelWidth) {
                        itemMi.labelable.setWidth(me.itemLabelWidth);
                    }

                    if (me.itemLabelAlign) {
                        itemMi.labelable.setLabelAlign(me.itemLabelAlign);
                    }

                }


            }
            else if (Mini2.isDom(item) && $(item).is(':visible')) {

                preItems.push(item);

                var itemEl = $(item);

                //换行的样式
                if (itemEl.hasClass('mi-newline')) {

                }
                else {

                    if ('lefttoright' == flowDirection) {

                        itemEl.addClass('mi-form-item-float-left');
                    }

                    //对子项注入新的样式
                    if (layout && layout.itemCls) {
                        itemEl.addClass(layout.itemCls);
                    }

                    if (me.itemWidth) {
                        itemEl.css('width', me.itemWidth);
                    }
                }
            }

        });

        return preItems;
    }


});


/************************************************************************/
/*                                           */
/*    ui/panel/TreeTable.js                                                */
/*                                           */
/************************************************************************/


/// <reference path="/Core/Scripts/jquery/jquery-1.4.1-vsdoc.js" />

/// <reference path="../../Mini.js" />

/// <reference path="../Mini-more.js" />
/// <reference path="../lang/Array.js" />

/// <reference path="template.min.js" />
/// <reference path="EventManager.js" />
/// <reference path="FocusManager.js" />

/// <reference path="grid/column/Column.js" />



Mini2.define('Mini2.ui.panel.TreeTable', {

    extend: 'Mini2.ui.panel.Table',

    rootId : '0',

    valueField: 'ID',
    textField: 'TEXT',
    parField: 'P_ID',

    pagerVisible:false,

    store_refresh: function (event, store) {

        var me = event.data,
            i,
            record,
            records;

        me.itemRemoteAll();

        records = me.store.data;


        for (i = 0; i < records.length; i++) {
            record = records.get(i);
            me.itemAdd(record);
        }

        me.itemsReset();

        if (me.rowCheckColumn) {
            me.rowCheckColumn.updateHeaderState();
        }
    },

    rootNode:{
     
        childs :[]
    },

    store_load: function (event, store) {

        var me = event.data,
            i,
            record,
            rootId = me.rootId,
            parField = me.parField,
            treeModels = store.getByGroup(rootId),
            treeModel,
            len,
            rowCheckColumn = me.rowCheckColumn;

        
        me.itemRemoteAll();

        len = treeModels.length;

        var outData = {};//返回的参数

        for (var i = 0; i < len; i++) {
            treeModel = treeModels[i];

            record = treeModel.data;

            me.itemInsert(i, record, outData);
            
            me.proRowEls(null, outData.rowEls, me.rootNode, 0, store, treeModel);
        }
        

        if (rowCheckColumn) {
            rowCheckColumn.updateHeaderState();
        }

    },


    proRowEls: function (parentRowEl,rowEls, parentNode, dept, store, parentTreeModel) {
        var me = this,
            pNode = parentNode,
            paddingLeft = dept * 24;

        if (!pNode.childs) {
            pNode.childs = [];
        }


        $(rowEls).each(function () {
            var rowEl = $(this);

            pNode.childs.push(rowEl);


            //深度
            var cellInnerEl = me.findCellInnerEl(rowEl);

            cellInnerEl.css('padding-left', paddingLeft + 'px');

            //叶设置
            var record = rowEl.data('record');

            var pk = record.getId();

            if (!store.hasChilds(pk)) {
                cellInnerEl.addClass('tree-leaf');
            }

            

            rowEl.attr('tree-dept', dept)
                .attr('tree-node-id', pk)
                .data('tree-node', {
                    parentRowEl: parentRowEl
                });

            //显示的节点缓冲
            me.displayRowsBuffer[pk] = rowEl;

        });
    },

    //显示的节点缓冲
    displayRowsBuffer : {},

    //查找树控件的内部容器
    findCellInnerEl: function (rowEl) {
        var me = this,
            cellEl = rowEl.children('.mi-grid-cell-treecolumn:first'),
            cellInnerEl = cellEl.children('.mi-grid-cell-inner:first');

        return cellInnerEl;
    },



    //删除记录
    store_bulkRemove: function (event, allRecords, indexes, isMove) {

        var me = event.data,
            exist,
            record,
            rowEl,
            pk,
            treeModel,
            rowEls = me.tbodyEl.children('tr');


        $(rowEls).each(function () {
            rowEl = $(this);
            record = rowEl.data("record");

            exist = Mini2.Array.contains(allRecords, record);

            if (exist) {
                pk = record.getId();

                treeModel = record._ownerTreeNode;

                var treeNode = rowEl.data('tree-node');

                rowEl.remove();
                Mini2.Array.remove(me.checkedRecords, record);

                delete me.displayRowsBuffer[pk];

                me._deleteTreeNode(treeNode.parentRowEl, record)

                return false;
            }

        });

        me.itemsReset();

    },

    _deleteTreeNode:function(parentRowEl, record){
        var me = this,
            pNode,
            childRowEl,
            i,
            pk,
            nodeId;

        if (parentRowEl) {

            pk = record.getId();

            pNode = $(parentRowEl).data('tree-node');

            for (i = 0; i < pNode.childs.length; i++) {

                childRowEl = pNode.childs[i];

                nodeId = $(childRowEl).attr('tree-node-id');

                if (nodeId == pk) {

                    pNode.childs.splice(i, 1);

                    break;
                }
            }
        }
    },


    store_add: function (event, index, out) {

        var me = event.data,
            store = this,
            i,
            record,
            treeModel,
            parField = me.parField,
            pValue,
            rowCheckColumn = me.rowCheckColumn;

        for (i = 0; i < out.length; i++) {

            record = out[i];

            treeModel = record._ownerTreeNode;

            pValue = record.get(parField);
            
            //获取上级已经显示的行。
            var pRowEl = me.displayRowsBuffer[pValue];

            if (pRowEl) {

                var pNode = $(pRowEl).data('tree-node');

                var n = $(pRowEl).index() + 1;

                if (pNode.childs) {
                    n += pNode.childs.length;
                }


                var depth = $(pRowEl).attr('tree-dept');

                depth = parseInt(depth) + 1;

                var outData = {}; //插入数据后，返回的对象

                me.itemInsert(n, record, outData);

                me.proRowEls(pRowEl,outData.rowEls, pNode, depth, store, treeModel);
            }
            
        }

        if (rowCheckColumn) {
            rowCheckColumn.updateHeaderState();
        }
    },



    deleteRows: function (pRows) {
        var me = this;

        $(pRows).each(function () {

            var treeNode = $(this).data('tree-node');


            me.deleteRows(treeNode.childs);
            

            $(this).remove();
        });
    },


    //展开节点
    expandNode: function (treeNode, rowEl,cellEl) {
        var me = this,
            store = me.store,
            dept = $(rowEl).attr('tree-dept'),
            cellInnerEl = $(cellEl).children('.mi-grid-cell-inner');;

        dept = parseInt(dept);

        var record = $(rowEl).data('record');

        var id = record.getId();

        var rootId = store.rootId;

        var treeModels = store.getByGroup(id);

        if (treeModels) {
            //var rowElTreeNode = $(rowEl).data('tree-node');

            cellInnerEl.addClass('tree-open');

            treeNode.expanded = true;

            var rowIndex = $(rowEl).index() + 1;

            var len = treeModels.length;

            var outData = {};

            dept += 1;

            for (var i = 0; i < len; i++) {
                var treeModel = treeModels[i];

                var record = treeModel.data;

                me.itemInsert(rowIndex + i, record, outData);

                me.proRowEls(rowEl, outData.rowEls, treeNode, dept, store);
            }



        }

    },

    //折叠节点
    collapseNode: function (treeNode,rowEl, cellEl) {
        var me = this,
            cellInnerEl = $(cellEl).children('.mi-grid-cell-inner');

        cellInnerEl.removeClass('tree-open');

        if (treeNode) {

            //var node = $(rowEl).data('tree-node');

            treeNode.expanded = false;

            me.deleteRows(treeNode.childs);

            delete treeNode.childs;
        }

    },

    //展开折叠，进行切换
    toggleNode: function (treeNode,rowEl,cellEl) {
        var me = this;

        if (treeNode.expanded) {
            me.collapseNode(treeNode, rowEl, cellEl);
        }
        else {
            me.expandNode(treeNode, rowEl, cellEl);
        }

    }

});


/************************************************************************/
/*                                           */
/*    ui/grid/property/Grid.js                                             */
/*                                           */
/************************************************************************/




Mini2.define("Mini2.ui.grid.property.Grid", {

    extend: 'Mini2.ui.panel.Table',

    checkedMode: 'SINGLE',



    onInit: function () {

        var me = this;


        if (me.isInit) {
            return;
        }

        me.isInit = true;

        me.pager = {
            visible : false
        };

        me.columns = [{
            miType: 'col',
            dataIndex: 'Display',
            headerText: '名称',
            width: 115
        }, {
            miType: 'propertyColumn',
            dataIndex: 'Value',
            headerText: '值',
            editor: { xtype: 'property' },
            width: 120
        }];


        var newStore = Mini2.create('Mini2.data.Store', {
            storeId: 'MiniStore_' + Mini2.getIdentity(),
            idField: 'Name',
            fields: ['Name', 'Value','Display', 'Type','Extend']
        });

        me.bindStore(newStore);


        delete me.m_Cols;
        me.m_Cols = [];


        var index = 0;

        $(me.columns).each(function () {
            me.getColumnForConfig(index, this);
            index++;
        });

        me.cellTpl = me.StrJoin(me.cellTpl);

    }


}, function () {
    var me = this;

    Mini2.apply(this, arguments[0]);
    me.onInit(arguments[0]);

    me.muid = Mini2.getIdentity();
});


/************************************************************************/
/*                                           */
/*    ui/toolbar/Button.js                                                 */
/*                                           */
/************************************************************************/

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../Mini.js" />


Mini2.define('Mini2.ui.toolbar.Button', {

    extend: 'Mini2.ui.Component',

    btnInner: undefined,

    baseCls: Mini2.baseCSSPrefix + 'btn',

    /*
    * 图标样式
    */
    iconCls: null,

    scale: 'small',
    allowedScales: ['small', 'medium', 'large'],

    //    dock: 'none',

    //text: '按钮',

    //icon: false,

    //href




    renderTpl: [
        '<a class="mi-btn ',
            'mi-unselectable ',
            'mi-btn-toolbar ',
            'mi-box-item ',
            'mi-toolbar-item ',

            'mi-btn-default-toolbar-small ',

            '" ',
            'role="button" hidefocus="on" unselectable="on" tabindex="0" ',
            'style="right: auto; left: 229px; top: 0px; margin: 0px;">',
            '<span class="mi-btn-wrap" unselectable="on">',
                '<span class="mi-btn-button">',
                    '<span class="mi-btn-inner mi-btn-inner-center" unselectable="on">',

                    '</span>',

                '</span>',
            '</span>',
        '</a>'
    ],



    setText: function (value) {
        "use strict";
        var me = this,
            btnInner = me.btnInner;

        me.text = value;

        if (btnInner) {
            btnInner.html(value);
        }

        return me;
    },

    getText: function () {
        "use strict";
        var me = this,
            btnInner = me.btnInner;

        return btnInner.html();
    },

    /**
    * 鼠标进入里面
    * 
    */
    isMouseEnter: false,

    tooltipEl: null,

    preMouseEnter: function () {
        var me = this,
            el = me.el,
            tplContentEl = me.tooltipContentEl,
            tipEl = me.tooltipEl;

        // 提示框
        if (tplContentEl) {
            if (!tipEl) {

                me.tooltipEl = tipEl = Mini2.create('Mini2.ui.menu.MenuPanel', {
                    contentEl: tplContentEl
                });

                tipEl.render();
                tipEl.bind('showing', function () {

                    me.trigger('tooltipShowing');

                });
            }

            var offset = el.offset();
            var height = el.height();

            tipEl.setLocal(offset.left, offset.top + height + 10);

            tipEl.show();
        }
    },

    preMouseLeave: function () {
        var me = this,
            el = me.el;

    },

    getInputEl: function () {
        "use strict";
        var me = this,
            command = me.command,
            imgEl,
            inputEl,
            overCls = ['mi-over', 'mi-btn-over', 'mi-btn-default-toolbar-small-over'],
            pressedCls = ['mi-pressed', 'mi-btn-pressed', 'mi-btn-default-toolbar-small-pressed'];

        inputEl = Mini2.$joinStr(me.renderTpl);
        inputEl.css({
            width: me.width,
            height: me.height,
            left: me.left
        });

        if (me.id) {
            inputEl.attr('id', me.id);
        }

        if (!me.visible) {
            inputEl.css('display', 'none');
        }

        if (me.href) {
            inputEl.attr('href', me.href);
        }

        if (command && command != '') {
            inputEl.attr('command', command);
        }


        if (Mini2.isBlank(me.text) && (me.icon || me.iconCls)) {

            inputEl.addCls('mi-btn-default-toolbar-small-icon');

        }
        else if (me.text != '' && (me.icon || me.iconCls)) {
            inputEl.addCls('mi-icon-text-left',
                'mi-btn-icon-text-left',
                'mi-btn-default-toolbar-small-icon-text-left');
        }

        if (me.icon) {
            me.imgEl = imgEl = $('<img src="" class="mi-btn-icon-el  mi-btn-glyph"  />');
            imgEl.attr('src', me.icon);

            inputEl.find('.mi-btn-button').append(imgEl);
        }
        else if (me.iconCls) {
            me.imgEl = imgEl = Mini2.$join(['<i class="mi-btn-icon-el  mi-btn-glyph fa  ', me.iconCls, '"></i>']);
            inputEl.find('.mi-btn-button').append(imgEl);
        }

        if (me.tooltip) {
            inputEl.attr('title', me.tooltip);

            if (inputEl.tooltip) {
                inputEl.tooltip({
                    placement: 'auto',
                    delay: 300,
                    container: Mini2.getBody()
                });
            }
        }

        if (me.userCls) {
            inputEl.addClass(me.userCls);
        }

        if (me.disabled) {
            inputEl.addCls(['mi-item-disabled', 'mi-disabled', 'mi-btn-disabled', 'mi-btn-default-small-disabled']);
        }


        me.btnInner = inputEl.find('.mi-btn-inner:first');
        me.btnInner.html(me.text);


        inputEl.on('mouseenter', function () {
            $(this).addCls(overCls);

            me.isMouseEnter = true;

            me.preMouseEnter();

        })
        .on('mouseleave', function () {
            $(this).removeCls(overCls);

            me.isMouseEnter = false;

            me.preMouseLeave();
        });

        inputEl.muBind('mousedown', function () {
            $(this).addCls(pressedCls);

            Mini2.ui.FocusMgr.setControl(this);

        })
        .muBind('mouseup', function (evt, srcEvt) {

            $(this).removeCls(pressedCls);

            if (0 == srcEvt.button) {
                if (me.beforeClick) {

                    var result = me.beforeClick.call(me, evt);

                    if (false === result) {
                        return;
                    }

                }
                else if (!Mini2.isBlank(me.beforeAskText)) {

                    return me.showAskMsg(me);

                }

                me.callback_click.call(me);
            }



        });

        return inputEl;
    },


    //显示询问弹出窗口
    showAskMsg: function (owner) {
        "use strict";
        var me = owner;

        Mini2.Msg.confirm("询问", me.beforeAskText, function () {
            me.click();
        });

        return false;
    },


    //提交到服务器
    serverForSubmit: function () {
        "use strict";
        var me = this,
            widget = me.widget || window.widget1;



        if (widget) {
            widget.submit(me.el, {
                command: me.command,
                commandParam: me.commandParams
            });
        }
    },

    getWidth: function () {
        "use strict";
        var me = this,
            el = me.el,
            width = 0;

        width = $(el).outerWidth();

        if (width <= 4) {
            width = 4;
        }

        return width;
    },

    render: function () {
        "use strict";
        var me = this,
            el;

        var icoPlg = Mini2.ui.icon.Manager.getPlugin('btnConfig');

        var cfg;

        if (icoPlg) {
            cfg = icoPlg.getItemConfig(me.text);

            if (cfg && Mini2.isBlank(me.icon) && Mini2.isBlank(me.iconCls)) {
                me.icon = cfg.icon;
                me.iconCls = cfg.iconCls;
            }
        }

        me.el = el = me.getInputEl();

        if (cfg) {
            el.addClass(cfg.cls);
        }


        if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else {
            $(me.renderTo).append(el);
        }

        if (me.click) {
            me.userClick = me.click;

            delete me.click;
        }

        me.click = me.callback_click;

        try {
            Mini2.ui.SecManager.reg(me.secFunCode, me);
        }
        catch (ex) {
            console.error('注册权限错误',ex);
        }

        return me;
    },

    callback_click: function () {
        "use strict";
        var me = this;

        if (me.userClick) {
            me.userClick.call(me);
        }
        else if (me.command) {
            me.serverForSubmit.call(me);
        }

    }

});





/************************************************************************/
/*                                           */
/*    ui/toolbar/Title.js                                                  */
/*                                           */
/************************************************************************/

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../Mini.js" />

Mini2.define('Mini2.ui.toolbar.Hr', {

    extend: 'Mini2.ui.Component',

    renderTpl: [
        '<div class="mi-toolbar-separator  mi-toolbar-separator-horizontal mi-box-item mi-toolbar-item" ',
            'style="right: auto; top: 5px; margin: 0px;">',
        '</div>'
    ],

    getInputEl: function () {
        "use strict";
        var me = this,
            el;

        el = Mini2.$joinStr(me.renderTpl);

        if (!me.visible) {
            el.css('display', 'none');
        }

        return el;
    },


    getWidth: function () {
        var me = this,
            el = me.el;

        return $(el).outerWidth();
    },

    render: function () {
        "use strict";
        var me = this,
            el;

        me.el = el = me.getInputEl();

        if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else {
            $(me.renderTo).append(el);
        }

        try {
            Mini2.ui.SecManager.reg(me.secFunCode, me);
        }
        catch (ex) {
            console.error(ex);
        }
    }

});


Mini2.define('Mini2.ui.toolbar.Title', {

    extend: 'Mini2.ui.Component',

    btnInner: undefined,

    baseCls: Mini2.baseCSSPrefix + 'btn',

    scale: 'small',
    allowedScales: ['small', 'medium', 'large'],

    //    dock: 'none',

    text: '标题',

    icon: false,


    renderTpl: [
        '<div class="',
            'mi-unselectable ',
            'mi-box-item ',
            'mi-toolbar-item ',
            'mi-toolbar-title " ',
            'role="button" hidefocus="on" unselectable="on" tabindex="0" ',
            'style="">',
            '<span class="mi-btn-wrap" unselectable="on">',
                '<span class="mi-btn-button">',
                    '<span class="mi-btn-inner mi-btn-inner-center" unselectable="on" style="">',

                    '</span>',
                '</span>',
            '</span>',
        '</div>'
    ],



    getInputEl: function () {
        "use strict";
        var me = this,
            command = me.command,
            imgEl,
            inputEl,
            overCls = ['mi-over', 'mi-btn-over', 'mi-btn-default-toolbar-small-over'],
            pressedCls = ['mi-pressed', 'mi-btn-pressed', 'mi-btn-default-toolbar-small-pressed'];

        inputEl = Mini2.$joinStr(me.renderTpl);
        inputEl.css({
            width: me.width,
            height: me.height,
            left: me.left
        });

        if (command && command != '') {
            inputEl.attr('command', command);
        }

        if (me.icon) {
            inputEl.addCls('mi-icon-text-left',
                'mi-btn-icon-text-left',
                'mi-btn-default-toolbar-small-icon-text-left');

            me.imgEl = imgEl = $('<img src="" class="mi-btn-icon-el  mi-btn-glyph"  />');
            imgEl.attr('src', me.icon);

            inputEl.find('.mi-btn-button').append(imgEl);
        }


        me.btnInner = inputEl.find('.mi-btn-inner:first');
        me.btnInner.html(me.text);


//        inputEl.bind('mouseenter', function () {
//            $(this).addCls(overCls);
//        })
//        .bind('mouseleave', function () {
//            $(this).removeCls(overCls);
//        });

        inputEl.muBind('mousedown', function () {
            //$(this).addCls(pressedCls);

            Mini2.ui.FocusMgr.setControl(this);

        })
        .muBind('mouseup', function () {

            //$(this).removeCls(pressedCls);

            if (me.click) {
                me.click.call(this);
            }
            else if (me.command) {
                me.serverForSubmit();
            }

        });

        return inputEl;
    },


    //提交到服务器
    serverForSubmit: function () {
        "use strict";
        var me = this,
            widget = me.widget || window.widget1;

        if (widget) {
            widget.submit(me.el, {
                command: me.command,
                commandParams: me.commandParams
            });
        }
    },

    getWidth: function () {
        "use strict";
        var me = this,
            el = me.el;

        return $(el).outerWidth();
    },

    render: function () {
        "use strict";
        var me = this,
            el;

        me.el = el = me.getInputEl();

        if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else {
            $(me.renderTo).append(el);
        }

        try {
            Mini2.ui.SecManager.reg(me.secFunCode, me);
        }
        catch (ex) {
            console.error(ex);
        }
    }

});





/************************************************************************/
/*                                           */
/*    ui/toolbar/Template.js                                               */
/*                                           */
/************************************************************************/



/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../Mini.js" />

/**
* 工具栏模板项目
* 
*/
Mini2.define('Mini2.ui.toolbar.Template', {

    extend: 'Mini2.ui.Component',

    renderTpl: [
        '<div class="mi-box-item mi-toolbar-item mi-toolbar-template" ',
            'style="right: auto; top: 5px; margin: 0px;">',



        '</div>'
    ],


    /**
    * 模板内容
    *
    */
    content: null,

    getInputEl: function () {
        "use strict";
        var me = this,
            el;

        el = Mini2.$joinStr(me.renderTpl);

        el.html(me.content);

        if (me.id) {
            $(el).attr('id', me.id);
        }

        if (!me.visible) {
            el.css('display', 'none');
        }

        return el;
    },


    getWidth: function () {
        var me = this,
            el = me.el;

        return $(el).outerWidth();
    },

    render: function () {
        "use strict";
        var me = this,
            el;

        me.el = el = me.getInputEl();

        if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else {
            $(me.renderTo).append(el);
        }

        $(el).data('me', me);

        try {
            Mini2.ui.SecManager.reg(me.secFunCode, me);
        }
        catch (ex) {
            console.error('注册权限错误', ex);
        }

        return me;
    }

});



/************************************************************************/
/*                                           */
/*    ui/toolbar/Toolbar.js                                                */
/*                                           */
/************************************************************************/

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../Mini.js" />


Mini2.define('Mini2.ui.toolbar.Toolbar', {
    extend: 'Mini2.ui.panel.Panel',

    baseCls: Mini2.baseCSSPrefix + 'toolbar',


    defaultType: 'button',

    items: [],

    height: 24,

    region: 'north',

    scroll: 'none',

    userCls: null,

    /**
     * ui 类型, 有 large_flat=大扁平, button_group=小按钮组
     */ 
    uiType : 'default',

    item_span: 4,  //按钮之间的间隔距离

    padding:{
        all:'4px'
    },

    initComponent: function () {
        "use strict";
        var me = this;

    },


    
    //删除
    remove: function(item){
        'use strict';

        var me = this,
            items = me.items,
            i, index,
            del_items;

        if (Mini2.isArray(item)) {
            del_items = item;
        }
        else {
            del_items = [item];
        }

        for (i = 0; i < del_items.length; i++) {
            item = del_items[i];
            item.el.remove();

            index = Mini2.Array.remove(items,item);
        }

        return me;
    },

    createItem: function (cfg) {
        "use strict";
        var me = this,
            item,
            cType ,
            ns = 'Mini2.ui.toolbar',
            fullname;

        cfg = Mini2.apply(cfg, {

            ownerParent: me,
            toolbar: me,
            renderTo: me.boxTarget
        });


        cType = cfg.type;

        if ('title' == cType) {
            fullname = ns + '.Title';
        }
        else if ('hr' == cType) {
            fullname = ns + '.Hr';
        }
        else if ('template' == cType) {
            fullname = ns + '.Template';
        }
        else if ('group' == cType) {
            fullname = ns + '.Group';
        }
        else {
            fullname = ns + '.Button';
        }

        item = Mini2.create(fullname, cfg);
        item.render();

        if (item.el && item.el.width) {
            item.width = item.el.width() + 6;
        }
        else {
            item.width = item.getWidth() + 6;
        }


        return item;
    },

    //添加
    add: function (item) {
        var me = this,
            items = me.items;

        if (!item) {
            throw new Error('item 对象不能为 ' + item);
        }

        if ('-' == item) {
            var hr = Mini2.create('Mini2.ui.toolbar.Hr', {});

            item = hr;
        }

        item.toolbar = me,
        item.renderTo = me.boxTarget

        items.push(item);

        item.render();

        return item;
    },

    renderItems: function () {
        "use strict";
        var me = this,
            i,
            item,
            items = me.items,
            len = items.length,
            newItems = [];

        delete me.items;

        for (i = 0; i < len; i++) {
            item = me.createItem(items[i]);
            newItems[i] = item;

            if (item.id) {
                Mini2.onwerPage.controls[item.id] = item;
                window[item.id] = item;
            }
        }

        me.items = newItems;
    },


    getBtnWidth: function (w, btns) {
        "use strict";
        var me = this,
            i = btns.length,
            item_span = me.item_span ;

        while (i--) {
            w += btns[i].getWidth() + item_span;
        }

        return w;
    },

    setItemsLayout: function (x, items) {
        "use strict";
        var me = this,
            i,
            item,
            item_span = me.item_span ,
            len = items.length;

        for (i = 0; i < len; i++) {
            item = items[i];

            if (item.visible) {
                item.setLeft(x);

                if (item.updateLayout) {
                    item.updateLayout();
                }

                x += item.getWidth() + item_span;
            }
            else {
                //console.warn('未知的工具栏项', item);
            }
        }

    },



    /**
    * 更新布局
    */
    updateLayout: function () {
        "use strict";
        var me = this;

        Mini2.awaitRun(me.muid, 50, me, function () {

            me.baseUpdateLayout();

        });

        return me;
    },


    /**
    * (基础函数)更新布局
    */
    baseUpdateLayout: function () {
        "use strict";
        var me = this,
            item,
            w, i, itemAllW,
            item_span = me.item_span ,
            items = me.items;


        if (items) {
            i = items.length;

            var lItems = [],
                rItems = [],
                cItems = [];

            while (i--) {
                item = items[i];

                switch (item.dock) {
                    case 'right': rItems.push(item); break;
                    case 'center': cItems.push(item); break;
                    default: lItems.push(item); break;
                }

                if (item.updateLayout) {
                    item.updateLayout();
                }
            }



            lItems.reverse();
            me.setItemsLayout(0, lItems);

            if (cItems.length) {
                w = me.getBtnWidth(0, cItems);
                itemAllW = me.width - w - i * item_span - 20;

                cItems.reverse();
                me.setItemsLayout(w / 2, cItems);
            }

            if (rItems.length) {

                w = me.getBtnWidth(0, rItems);
                itemAllW = me.width - w - i * item_span - 20;

                rItems.reverse();
                me.setItemsLayout(itemAllW, rItems);
            }
        }

    },


    //延迟显示
    //isDelayRender:false,

    //显示延迟
    delayRender: function () {
        "use strict";
        var me = this,
            el = $(me.applyTo);


        Mini2.delayRS = Mini2.delayRS || {};

        Mini2.delayRS[me.applyTo] = me;

        me.isDelayRender = true;

        el.attr('mi-delay-render', 'true');
        el.data('me', me);
    },

    render: function () {
        "use strict";
        var me = this;

        me.baseRender();

        me.renderItems();

        me.setSize();

        try{
            Mini2.ui.SecManager.reg(me.secFunCode, me);
        }
        catch (ex) {
            console.error(ex);
        }
    }

}, function () {

    var me = this,
        cfg = Mini2.SystemInfo.toolbar,
        args = arguments[0];

    
    Mini2.apply(me, {
        item_span: cfg.item_span,
        height: cfg.height
    });

    Mini2.apply(me, args);

    if ('large_flat' == me.uiType) {
        //大扁平按钮
        Mini2.apply(me, {
            item_span: cfg.uiType_largeFlat.item_span,
            height: cfg.uiType_largeFlat.height
        });

        if (!me.userCls) {
            me.userCls = '';
        }

        me.userCls += ' mi-toolbar-largeflat';
        
        
    }
    else if ('button_group' == me.uiType) {
        //按钮组
        Mini2.apply(me, {
            item_span: cfg.uiType_buttonGroup.item_span,
            height: cfg.uiType_buttonGroup.height
        });


        if (!me.userCls) {
            me.userCls = '';
        }

        me.userCls += ' mi-toolbar-btns';
    }


});


/************************************************************************/
/*                                           */
/*    ui/toolbar/Group.js                                                  */
/*                                           */
/************************************************************************/

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../Mini.js" />

Mini2.define('Mini2.ui.toolbar.Group', {

    extend: 'Mini2.ui.Component',


    baseCls: Mini2.baseCSSPrefix + 'toolbar-group',

    renderTpl: [
        '<div class="mi-toolbar-group  mi-box-item" data-x="33">',
            
        '</div>'
    ],



    /**
     * 清除项目集合
     */
    clear: function () {
        "use strict";
        var me = this,
            el = me.el,
            items = me.items,
            itemEls = el.children();

        console.debug('清除子项目:', itemEls.length);

        $(items).each(function () {

            var item = this;

            if (item.clear) {
                item.clear();
            }
        });

        me.items = [];

        itemEls.remove();

        return me;
    },


    /**
     * 添加项目
     */
    add: function (cfg) {

        var me = this,
            item,
            items = me.items || [];


        item = me.createItem(cfg);

        if (item.id) {
            Mini2.onwerPage.controls[item.id] = item;
            window[item.id] = item;
        }

        items.push(item);

    },

    createItem: function (cfg) {
        "use strict";
        var me = this,
            el = me.el,
            item,
            cType,
            namespace = 'Mini2.ui.toolbar',
            fullname;

        cfg = Mini2.apply(cfg, {

            ownerParent: me,
            toolbar: me,
            renderTo: el
        });

        cType = cfg.type;

        if ('title' == cType) {
            fullname = namespace + '.Title';
        }
        else if ('hr' == cType) {
            fullname = namespace + '.Hr';
        }
        else if ('template' == cType) {
            fullname = namespace + '.Template';
        }
        else if ('group' == cType) {
            fullname = namespace + '.Group';
        }
        else {
            fullname = namespace + '.Button';
        }

        item = Mini2.create(fullname, cfg);
        item.render();

        if (item.getWidth) {
            item.width = item.getWidth();
        }
        else if (item.el && item.el.width) {
            item.width = $(item.el).outerWidth();
        }


        return item;
    },

    getInputEl: function () {
        "use strict";
        var me = this,            
            el;
     
        el = Mini2.$join(me.renderTpl);

        if (me.applyTo) {
            $(me.applyTo).replaceWith(el);
        }
        else {
            $(me.renderTo).append(el);
        }


        if (me.id) {
            el.attr('id', me.id);
        }

        if (!me.visible) {
            el.css('display', 'none');
        }

        
        if (me.disabled) {
            el.addCls(['mi-item-disabled', 'mi-disabled', 'mi-btn-disabled', 'mi-btn-default-small-disabled']);
        }

        return el;
    },

    getWidth:function(){

        var me = this,
            i,
            item,
            items = me.items,
            len = items.length,
            w = 0;
        
        for (i = 0; i < len; i++) {
            item = items[i];
            w += item.getWidth();
        }

        w = w - len + 1

        return w;
    },


    /**
     * 刷新布局
     */
    updateLayout:function(){
        "use strict";
        var me = this,
            items = me.items;

        me.setItemsLayout(0, items);

        return me;
    },

    setItemsLayout: function (x, items) {
        "use strict";
        var me = this,
            i,
            item,
            items = items || me.items,
            len = items.length;

        x = x || 0;


        for (i = 0; i < len; i++) {
            item = items[i];

            if (item.visible) {
                item.setLeft(x);


                if (item.updateLayout) {
                    item.updateLayout();
                }

                x += item.getWidth() - 1;
            }
        }

        return me;
    },


    renderItems:function(){
        var me = this,
            items = me.items,
            len = items.length,
            i;

        for (i = 0; i < len; i++) {

            var item = me.createItem(items[i]);


            if (item.id) {
                Mini2.onwerPage.controls[item.id] = item;
                window[item.id] = item;
            }

            me.items[i] = item;
        }

    },

    render: function () {
        "use strict";
        var me = this,
            w,
            el;

        me.el = el = me.getInputEl();

        me.renderItems();

        me.setItemsLayout(0, me.items);

        w = me.getWidth();

        try {
            Mini2.ui.SecManager.reg(me.secFunCode, me);
        }
        catch (ex) {
            console.error('注册权限错误', ex);
        }

        return me;
    }

});


/************************************************************************/
/*                                           */
/*    ui/menu/Menu.js                                                      */
/*                                           */
/************************************************************************/

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini.js" />



//菜单
Mini2.define('Mini2.ui.menu.Menu', {

    
    extend: 'Mini2.ui.Component',



    //初始化组件
    initComponent: function () {

        //        log.debug("Mini2.ui.Component.initComponent()");

    },


    

    tpl:[
        '<div class="mi-panel mi-layer mi-panel-default mi-menu mi-border-box" tabindex="-1" style="width: 146px; height: 79px; right: auto; left: 10px; top:0px; z-index: 19001;">',
            '<div class="mi-panel-body mi-menu-body mi-unselectable mi-panel-body-default mi-box-layout-ct mi-panel-body-default mi-noborder-trbl" style="width: 144px; height: 77px; left: 0px; top: 0px;">',

                '<div class="mi-box-inner mi-box-scroller-top">',
                    '<div id="menu-1075-before-scroller" class="mi-box-scroller mi-menu-scroll-top" style="display:none"></div>',
                '</div>',

                '<div class="mi-box-inner mi-vertical-box-overflow-body" role="presentation" style="height: 77px; width: 144px;">',
                    '<div class="mi-box-target" style="width: 144px;">',
                    '</div>',
                '</div>',

                '<div class="mi-box-inner mi-box-scroller-bottom">',
                    '<div id="menu-1075-after-scroller" class="mi-box-scroller mi-menu-scroll-bottom" style="display:none"></div>',
                '</div>',

            '</div>',
        '</div>'
    ],

    
    //显示子控件
    renderItems: function (boxTargetEl) {
        var me = this,
            items = me.items,
            item,
            cfg,
            newItems = [],
            i,
            y = 0;

        for (i = 0; i < items.length; i++) {

            cfg = Mini2.clone( items[i]);
            
            if ('-' == cfg.text ) {
                item = Mini2.create('Mini2.ui.menu.Separator', {
                    owner: me.owner,
                    renderTo: boxTargetEl,
                    top: y + 2
                });

                item.render();

                y += item.getHeight();
            }
            else {

                cfg = Mini2.apply(cfg, {
                    owner: me.owner,
                    renderTo: boxTargetEl,
                    top: y,
                    text: cfg.text,
                    click: cfg.click
                });


                item = Mini2.create('Mini2.ui.menu.Item', cfg);

                item.bind('click', function () {

                    me.item_click.call(me, this);
                })

                item.render();

                y += item.getHeight();
            }

            newItems.push(item);
        }

        delete me.items;

        me.items = newItems;

    },

    item_click:function(menuItem){
        var me = this;

        me.hide();
    },

    //获取总高度
    getItemsHeight:function(){
        var me = this,
            items = me.items,
            len = items.length,
            i,
            height = 0;

        for (i = 0; i < len; i++) {
            height += items[i].getHeight();
        }

        return height;
    },



    //获取总高度
    getItemsWidth: function () {
        var me = this,
            items = me.items,
            len = items.length,
            i,
            width = 0;

        for (i = 0; i < len; i++) {
            if (!items[i].isSeparator) {
                width = Math.max(width, items[i].getWidth());
            }
        }


        return width;
    },

    /**
    * 设置项目的宽度
    * @parma {Number} width 宽度
    */
    setItemsWidth:function(width){
        var me = this,
            items = me.items,
            len = items.length,
            i;

        for (i = 0; i < len; i++) {
            if (!items[i].isSeparator) {
                items[i].setWidth(width);
            }
        }


        return me;
    },


    callShow:function(){
        var me = this,
            el = me.el;

        me.trigger('showing');
        el.show();
        me.trigger('showed');

        return me;
    },

    
    callHide: function () {
        var me = this,
            el = me.el;

        if (me.visible) {
            el.hide();

            me.trigger('hidded');
        }

        return me;
    },


    /**
    * 延迟显示
    *
    */
    delayShow:function(){
        var me = this;
        Mini2.ui.menu.Manager.show(me);

        return me;
    },

    show: function () {
        var me = this;
                
        me.callShow();
        
        return me;
    },


    hide:function(){
        var me = this,
            el = me.el;
        
        if (me.visible) {
            el.hide();

            me.trigger('hidded');
        }

        return me;
    },
    
    


    baseRender: function () {
        var me = this,
            el ,
            sysInfo = Mini2.SystemInfo.menu;

        me.el = el = Mini2.$joinStr(me.tpl);
        
        $(document.body).append(el);

        me.panelBodyEl = el.find('.mi-panel-body:first');
        me.boxInnerEl = me.panelBodyEl.children('.mi-vertical-box-overflow-body');
        me.boxTargetEl = me.boxInnerEl.children('.mi-box-target');


        // 显示子项目
        me.renderItems(me.boxTargetEl);

        var itemsHeigth = me.getItemsHeight() + 2;
        var itemsWidth = me.getItemsWidth();

        el.css({
            'top': me.top,
            'left': me.left
        });



        var sz = {
            width: itemsWidth,
            height: itemsHeigth
        };

        var sz2 = {
            width: itemsWidth,
            height: itemsHeigth + sysInfo.paddingTop + sysInfo.paddingBottom
        };

        me.boxInnerEl.css({ 'top': sysInfo.paddingTop });
        

        el.css(sz2);

        me.panelBodyEl.css(sz2);
        me.boxInnerEl.css(sz);
        me.boxTargetEl.css(sz);

        me.setItemsWidth(itemsWidth);


        $(el).mousedown(function (e) {

            //log.debug("form.field.Trigger.mousedown() ");

            //Mini2.EventManager.setScope(this, [me.el, me.dropDownPanel]);
        })
        .mousemove(function (e) {

        })
        .mouseup(function (e) {
            //console.log("form.field.Trigger.mouseup() ");

            Mini2.EventManager.stopEvent(e);
            Mini2.EventManager.clear(me.scope || me.el);

        });


        Mini2.ui.menu.Manager.register(me);

        return me;
    },


    render: function () {
        var me = this;

        me.baseRender();

        me.show();

        return me;
    }


});


/************************************************************************/
/*                                           */
/*    ui/menu/MenuPanel.js                                                 */
/*                                           */
/************************************************************************/

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />
/// <reference path="../../Mini.js" />



//菜单
Mini2.define('Mini2.ui.menu.MenuPanel', {


    extend: 'Mini2.ui.Component',



    //初始化组件
    initComponent: function () {

        //        log.debug("Mini2.ui.Component.initComponent()");

    },

    contentEl:null,


    item_click: function (menuItem) {
        var me = this;

        me.hide();
    },


    callShow: function () {
        var me = this,
            el = me.el;

        me.trigger('showing');
        el.show();
        me.trigger('showed');

        return me;
    },


    callHide: function () {
        var me = this,
            el = me.el;

        if (me.visible) {
            el.hide();

            me.trigger('hidded');
        }

        return me;
    },


    /**
    * 延迟显示
    *
    */
    delayShow: function () {
        var me = this;
        Mini2.ui.menu.Manager.show(me);

        return me;
    },

    show: function () {
        var me = this;

        me.callShow();

        return me;
    },


    hide: function () {
        var me = this,
            el = me.el;

        if (me.visible) {
            el.hide();

            me.trigger('hidded');
        }

        return me;
    },




    baseRender: function () {
        var me = this,
            el;

        me.el = el = $(me.contentEl);
        

        el.css({
            'top': me.top,
            'left': me.left
        });
                

        $(el).mousedown(function (e) {

            //log.debug("form.field.Trigger.mousedown() ");

            //Mini2.EventManager.setScope(this, [me.el, me.dropDownPanel]);
        })
        .mousemove(function (e) {

        })
        .mouseup(function (e) {
            //console.log("form.field.Trigger.mouseup() ");

            Mini2.EventManager.stopEvent(e);
            Mini2.EventManager.clear(me.scope || me.el);

        });


        Mini2.ui.menu.Manager.register(me);

        return me;
    },


    render: function () {
        var me = this;

        me.baseRender();

        me.show();

        return me;
    }


});


/************************************************************************/
/*                                           */
/*    ui/menu/Item.js                                                      */
/*                                           */
/************************************************************************/

/// <reference path="../../../../jquery/jquery-1.4.1-vsdoc.js" />



//菜单分隔符
Mini2.define('Mini2.ui.menu.Item', {

    extend: 'Mini2.ui.Component',

    //菜单主容器
    menu : null,

    //初始化组件
    initComponent: function () {

        //        log.debug("Mini2.ui.Component.initComponent()");

    },

    isMouseOver: false,

    /**
    * 图标样式
    */
    iconCls: null,

    /**
    * 图标路径
    */
    icon : null,

    text : '菜单项目',

    tpl :[
        '<div class="mi-component mi-hmenu-sort-asc mi-box-item mi-component-default mi-menu-item" style="right: auto; left: 0px; top: 0px; margin: 0px; ">',
            '<a class="mi-menu-item-link" href="#" hidefocus="true" unselectable="on">',
                '<div role="img" class="mi-menu-item-icon  " style=""></div>',
                '<span class="mi-menu-item-text" unselectable="on"></span>',
                '<img src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">',
            '</a>',
        '</div>'
    ],

    setText: function(value){
        var me = this,
            itemTextEl = me.itemTextEl;

        me.text = value;
        itemTextEl.html(value);


        return me;
    },

    getText:function(){
        var me = this;

        return me.text;
    },

    getHeight: function () {
        var me = this,
            el = me.el;
        return $(el).outerHeight();
    },


    getWidth: function () {
        var me = this,
            el = me.el;

        return $(el).width();
    },

    setWidth :function(value){
        var me = this,
            el = me.el;

        el.css('min-width', value);

        return me;
    },

    baseRender: function () {
        var me = this,
            el,
            itemLinkEl,
            iconEl,
            itemTextEl;

        me.el = el = Mini2.$joinStr(me.tpl);
                
        me.itemLinkEl = itemLinkEl = el.children('.mi-menu-item-link');

        me.itemTextEl = itemTextEl = itemLinkEl.children('.mi-menu-item-text');

        itemTextEl.html(me.text);

        el.css('top', me.top);

        $(me.renderTo).append(el);
        

        if (me.icon || me.iconCls) {
                      

            if (me.iconCls) {

                me.iconEl = iconEl = $('<i role="img" class="fa " style="margin-right:4px;"></i>'); 

                iconEl.addClass(me.iconCls);

                itemTextEl.prepend(iconEl);
            }
            else if (me.icon) {


            }
        }





        $(el).muBind('mousemove',function () {
            if (!me.isMouseOver) {
                me.isMouseOver = true;
                $(el).addClass('mi-menu-item-active');
            }
        }).muBind('mouseout',function () {
            if (me.isMouseOver) {
                me.isMouseOver = false;
                $(el).removeClass('mi-menu-item-active');
            }
        });
    

        $(el).muBind('mousedown',function (e) {

            //log.debug("form.field.Trigger.mousedown() ");

            //Mini2.EventManager.setScope(this, [me.el, me.dropDownPanel]);


        })
        .muBind('mousemove',function (e) {

        })
        .muBind('mouseup',function (e) {
            //console.log("form.field.Trigger.mouseup() ");

            if (me.click) {

                console.log("xxxxxxxxxxxxxxxxx");

                me.click.call(me);
            }

            me.trigger('click', me);

            Mini2.EventManager.stopEvent(e);
            Mini2.EventManager.clear(me.scope || me.el);

        });


    },


    render: function () {

        var me = this;

        me.baseRender();

    }


});


/************************************************************************/
/*                                           */
/*    ui/menu/Manager.js                                                   */
/*                                           */
/************************************************************************/


//菜单管理类
Mini2.define('Mini2.ui.menu.Manager', {

    singleton: true,


    items: null,

    /*
    * 延时显示, 默认 200毫秒.
    */
    delay: 300,

    /*
    * 当前显示的菜单
    */
    curMenu: null,

    timer: null,

    onInit:function(){
        var me = this;

        me.items = {};
    },

    show:function(menu){
        var me = this,
            cur = me.curMenu,
            timer = me.timer;

        if (cur === menu) {
            return;
        }

        if (me.curMenu) {
            me.curMenu.callHide();
        }

        me.curMenu = menu;

        if (!timer) {
            me.timer = timer = Mini2.setTimer(function () {
                if (me.curMenu) {
                    me.curMenu.callShow();
                }
            }, {
                interval: me.delay,
                limit:1
            });
        }
        else {
            timer.reset().start();
        }
                       

    },

    //注册
    register: function (menu) {
        var me = this,
            items = me.items;

        //menu.bind('showed',function(){

        //    me.hideAll(this);

        //});

        menu.bind('showing', function () {

            me.hideAll(this);

        });
        
        items[menu.muid] = menu;
    },

    //撤销注册
    unregister: function (menu) {
        var me = this,
            items = me.items;

        delete items[menu.muid];
    },


    //隐藏全部
    hideAll: function (self) {

        var me = this,
            items = me.items;

        for (var i in items) {
            var item = items[i];
            
            if (item == self) {
                continue;
            }

            if (item === me.curMenu) {
                me.curMenu = null;
            }

            item.hide();
        }

    }

}, function () {

    var me = this;

    me.onInit();

});


/************************************************************************/
/*                                           */
/*    ui/menu/Separator.js                                                 */
/*                                           */
/************************************************************************/


//菜单分隔符
Mini2.define('Mini2.ui.menu.Separator', {

    renderTpl: [
        '<div class="mi-component mi-box-item mi-component-default mi-menu-item-separator mi-menu-item mi-menu-item-plain" ',
            'style="border-width: 1px; right: auto; left: 0px; top: 50px; margin: 0px; width:100%;" >&nbsp;</div>'
    ],

    isSeparator :true,

    getHeight: function () {
        var me = this,
            el = me.el;

        return 5;
    },

    getWidth:function(){
        var me = this,
            el = me.el;

        return el.width();
    },

    baseRender: function () {
        var me = this,
            el;

        me.el = el = Mini2.$joinStr(me.renderTpl);

        el.css('top', me.top);

        $(me.renderTo).append(el);
    },


    render: function () {

        var me = this;

        me.baseRender();

    }

});
